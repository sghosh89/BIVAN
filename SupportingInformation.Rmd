---
title: "Supporting Information"
author: "Shyamolina Ghosh and Daniel Reuman"
date: "February 12, 2018"
output: pdf_document
---

<!--A function needed for caching-->
```{r echo=F}
mtime <- function(files)
{
  lapply(Sys.glob(files),function(x) X =   
          file.info(x)$mtime)
}
```

# Descriptions of data
<!--Each data contributor writes one to a few paragraphs about their data.-->

## Soil C and N data

## Aphid data
<!--Shya to add some facts, make sure to name the species-->
We threw out all locations that had fewer than 30 years data (Shya to make more precise, also add any other cleaning info you did, in summary/bullet form)

## North Sea plankton data
Make sure to name the species used

# Question 1 analyses for each dataset

## Soil C and N data
<!--Shya to add model selection analysis of Terry data here. You just have to move it over from All_analysis.Rmd and edit the code. in a few ways:
1) make the code get displayed at each step
2) you have added some columns to the InfCritRes table so that will come out differently
3) you can also report your result for tail dependence based on model averaging
4) stop after that (e.g., don't put in the stuff about the outcome function, etc.-->

## Aphid data, count
<!--Shya to add model selection analysis here for aphid data, first the species for which you are using count data, then the one for ff data, just the model selection stuff, we'll do the other stuff with the tail dependence asymmetry statistics later-->

## Aphid data, first flight
<!--Shya also add as above-->

## North sea plankton data
<!--Shya also add as above-->



# Question 2 analyses for each dataset

# Question 3 analyses for each dataset

# Testing 

## Testing the ranking and bivariate copula display function

This is for testing the `getcopula` function.

<!--Source in function and a package--->
```{r}
source("getcopula.R")
require(copula)
require(mvtnorm)
```

Plot data from a Clayton copula, which has lower tail dependence:
```{r}
copC<-claytonCopula(8,2)
dC<-rCopula(1000,copC)
vC<-getcopula(d=dC,rankon=F,ploton=T)
```

Plot data from a Joe copula, which has upper tail dependence:
```{r}
copJ<-joeCopula(8,2)
dJ<-rCopula(1000,copJ)
vJ<-getcopula(d=dJ,rankon=F,ploton=T)
```

Get data from a bivariate normal distribution and take ranks and
then plot:
```{r}
sigma<-matrix(c(1,.7,.7,1),2,2)
dN<-rmvnorm(1000,mean=c(0,0),sigma=sigma)
vN<-getcopula(d=dN,rankon=T,ploton=T)
```

## Testing the bivariate model selection and goodness-of-fit pipeline

This is for testing the `OurBiCopSelect` function. We test that
it runs and gives reasonable results by simulating data and seeing if 
you recover what kind of copula was used.

<!--Source in the function and a package, changeable constants-->
```{r}
source("OurBiCopSelect.R")
require(copula)
nbsmall<-100
pthresh<-0.2
nblarge<-1000 #for bootstrapping, see below
numdat<-500 #amount of artificial data
seed<-101
```

If real data come from a Clayton copula, independence should
be rejected, Clayton should be the AIC best, it should pass the
goodness of fit test, the normal copula should fail the
goodness of fit test, and model-averaged tail dependence should
indicate left-tail dependence:
<!--Test for real data from a clayton-->
```{r cache=T, cache.extra=list(nbsmall,nblarge,pthresh,numdat,seed,mtime("OurBiCopSelect.R"))}
set.seed(seed)

families<-c(1,3:6,13,14,16)

#data are really from a clayton
cop<-claytonCopula(5,2)
dat<-rCopula(numdat,cop)

#do the analysis
allresC<-OurBiCopSelect(dat[,1],dat[,2],families,numBSsmall=nbsmall,
                        numBSlarge=nblarge,pthresh=0.2)
allresC

#calculate model-averaged left- and right-tail dependence
#DAN: ad this later
```


Same test, but data now come from a Gumbel copula:
<!--Test for real data from a gumbel-->
```{r cache=T, cache.extra=list(nbsmall,nblarge,pthresh,numdat,seed,mtime("OurBiCopSelect.R"))}
set.seed(seed)

#data are really from a gumbel
cop<-gumbelCopula(6,2)
dat<-rCopula(numdat,cop)

#do the analysis
allresG<-OurBiCopSelect(dat[,1],dat[,2],families,numBSsmall=nbsmall,
                        numBSlarge=nblarge,pthresh=0.2)
allresG

#calculate model-averaged left- and right-tail dependence
#DAN: ad this later
```

Same test, but data now come from a Frank copula:
<!--Test for real data from a frank-->
```{r cache=T, cache.extra=list(nbsmall,nblarge,pthresh,numdat,seed,mtime("OurBiCopSelect.R"))}
set.seed(seed)

#data are really from a frank
cop<-frankCopula(5,2)
dat<-rCopula(numdat,cop)

#do the analysis
allresF<-OurBiCopSelect(dat[,1],dat[,2],families,numBSsmall=nbsmall,
                        numBSlarge=nblarge,pthresh=0.2)
allresF

#calculate model-averaged left- and right-tail dependence
#DAN: ad this later
```

Same test, but data now come from a Joe copula:
<!--Test for real data from a joe-->
```{r cache=T, cache.extra=list(nbsmall,nblarge,pthresh,numdat,seed,mtime("OurBiCopSelect.R"))}
set.seed(seed)

#data are really from a joe
cop<-joeCopula(6,2)
dat<-rCopula(numdat,cop)

#do the analysis
allresJ<-OurBiCopSelect(dat[,1],dat[,2],families,numBSsmall=nbsmall,
                        numBSlarge=nblarge,pthresh=0.2)
allresJ

#calculate model-averaged left- and right-tail dependence
#DAN: ad this later
```

The goodness of fit test is quite slow when testing the fit of a
normal copula, and the results are not great: often the normal copula
cannot be rejected even when it is not the true copula, even though
a comparison of A/BICs strongly supports the true copula over the normal.
So proceed using `gofnormal=FALSE` when analyzing real data.

# Testing the pipeline for examining tail dependence in bivariate data using `copsurrog2d`



