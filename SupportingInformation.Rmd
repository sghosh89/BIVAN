---
title: "Supporting Information"
author: "Shyamolina Ghosh and Daniel Reuman"
date: "February 12, 2018"
output: 
  pdf_document:
    number_sections: yes
    keep_tex: yes
---
updated on `r Sys.Date()`

<!--A function needed for caching-->
```{r echo=F}
mtime <- function(files)
{
  lapply(Sys.glob(files),function(x) X =   
          file.info(x)$mtime)
}
```

<!--Setup-->
```{r setup, echo=F}
knitr::opts_chunk$set(echo = TRUE)
seed<-101
families<-c(1,3:10,13,14,16:20)
source("getcopula.R")
source("OurBiCopSelect.R")
source("FittingCopula_selective_loc.R")
```

# Descriptions of data
<!--Each data contributor writes one to a few paragraphs about their data.-->

## Soil C and N data
Carbon and nitrogen in soil at many locations across CONUS (Terry to augment this description).

Plot the raw data:
```{r load_data_Loecke, echo=F}
#Load your data - should be a data frame with 2 columns. Can contain NAs.
d<-readRDS("Data/RaCA_soilorganicC_soiltotalN_stocks100cm.RDS")
d<-d[,c("SOCstock100","TSNstock100")]
plot(d[,1],d[,2],type="p",col="red",xlab="Soil C",ylab="Soil N",cex.lab=1)
rect(0,0,1,1)
```

Copula plot of the data:
```{r rankandplot_Loecke, echo=F}
#convert to a copula and plot
v<-getcopula(d=d,rankon=T,ploton=T) #with real data, rankon should be T
```

## Aphid data
   * Aphid data contains 3 measurements [count, firstflight, flight-duration] at 11 locations for 20 species and for 35 years.
   * We threw out all locations that had fewer than 30 years data 
   * We use species=10 [Name : "Green spruce aphid"] for aphid-count data 
   * We use species=11 [Name : "Leaf-curling plum aphid"] for aphid-firstflight data   
   
## North Sea plankton data
   * Plankton North sea dataset collects data at 26 locations for 22 species and for 56 years.
   * We threw out all locations that had fewer than 45 years data
   * We use species=16 [Name : "Ceratium_furca"] for Plankton_North_Sea data
   
# Question 1 analyses for each dataset

Recall that question 1 is: Do datasets in ecology and related fields have non-Gausian copula srtructure? Do they show tail dependence distinct from that of a Gaussian copula? In particular do they show asymmetric tail dependence?

## Details of methods

### Model selection approach


### Non-paramtric analysis of tail dependence

## Soil C and N data

### Model selection approach

```{r bivmodselect_Loecke, echo=F, cache=T, cache.extra=list(seed,v)}
set.seed(seed)
families_Loecke<-c(1,3:10,13:14,16:20)
BivMS_res_Loecke<-OurBiCopSelect(u1=v[,1],u2=v[,2],families=families_Loecke,level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,gofnormal=F,status=F)
```

The test of indepedence gave $p=$`r BivMS_res_Loecke$IndepTestRes`. We fitted several copulas
and got AIC values and upper- and lower-tail dependency estimates based on the fitted copulas:

```{r echo=F}
h<-BivMS_res_Loecke$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
rownames(h)<-NULL
h
```

This shows that several copulas are much better supported than the Gaussian copula, answering the first part of question 1 for these data.

The model-averaged (using AIC) lower-tail dependence statistic was `r BivMS_res_Loecke$relLTdep_AICw` and the model-averaged (again, AIC) upper-tail dependence statistic was `r BivMS_res_Loecke$relUTdep_AICw`, and these values are distinct from what a Gaussian copula would give (i.e., 0), answering the second part of question 1 for these data. Furthermore, the difference of these two quantities (lower minus upper), `r BivMS_res_Loecke$relLTdep_AICw-BivMS_res_Loecke$relUTdep_AICw`, was different from 0, answering the third part of question 1. 

Although these results do convincingly show non-Gaussian copula structure, we should take the tail dependence results with a grain of salt because even the lowest-AIC copula was a poor fit, giving $p$-value `r BivMS_res_Loecke$GofRes_CvM` in the Cramer-von Mises-based test of the goodness of its fit, and $p$-value `r BivMS_res_Loecke$GofRes_KS` in the Kolmogorov-Smirnov-based test of the goodness of fit. The next section looks at tail dependence in a non-parametric way.

### Non-paramtric analysis of tail dependence

<!--Shya could work on this. Select 1-2 statistics, maybe more, but try to cut some of them (looks like there will be 4). Apply to C/N data, get results, display in the same kind of way.-->

## Aphid data
<!--Shya to edit the prentation below to make it more parallel to the presentation of the model selection results for C/N data above-->

### Model selection approach

```{r vivj_matrix, echo=F}
# Select any two location pair [i,j] for a copula of species sp
# This function gives you a matrix with vi and vj as two columns
vivj_matrix<-function(d_allsp,sp,i,j){
  
  ds1<-d_allsp[[sp]][[i]]
  ds2<-d_allsp[[sp]][[j]]
  #----------------------------
  a1<-ds1$Year[1]
  a2<-ds2$Year[1]
  a3<-ds1$Year[dim(ds1)[1]]
  a4<-ds2$Year[dim(ds2)[1]]
  year_s<-max(a1,a2)
  year_e<-min(a3,a4)
  ind_s1<-which(ds1$Year==year_s)
  ind_s2<-which(ds2$Year==year_s)
  ind_e1<-which(ds1$Year==year_e)
  ind_e2<-which(ds2$Year==year_e)
  ds1<-ds1[ind_s1:ind_e1,]
  ds2<-ds2[ind_s2:ind_e2,]
  # Omitting the years and data containing NA in either d1 or d2 
  #from both d1 and d2
  if(anyNA(ds1$Dat)==T | anyNA(ds2$Dat)==T){
    ind_na1<-which(is.na(ds1$Dat))
    ind_na2<-c(ind_na1,which(is.na(ds2$Dat)))
    ind_na<-unique(ind_na2)
    
    d1Dat<-ds1$Dat[-ind_na]
    d2Dat<-ds2$Dat[-ind_na]
    Years<-ds1$Year[-ind_na]
    d1<-data.frame(Year=Years,Dat=d1Dat)
    d2<-data.frame(Year=Years,Dat=d2Dat)
  } else {
    d1<-ds1
    d2<-ds2
  }
  #get ranks modified now
  vi<-pobs(d1$Dat)
  vj<-pobs(d2$Dat)
  Years<-d1$Year
  #-------------------------
  #n_datapt<-length(vi)
  #--------------------
  #plot(vi,vj,type="p")
  #-------------------------
  mat<-as.matrix(cbind(vi,vj))
  return(mat)  
}
```

```{r d_allsp_data_aphid, echo=F}
d_allsp_data<-function(d0){
  
  name.aphid<-c("Apple-grass aphid","Bird cherry-oat aphid","Black bean aphid", "Blackberry-cereal aphid","Blackcurrant-sowthistle aphid",
                "Corn leaf aphid","Currant-lettuce aphid","Damson-hop aphid","Grain aphid","Green spruce aphid",
                "Leaf-curling plum aphid","Mealy cabbage aphid","Mealy plum aphid","Pea aphid","Peach-potato aphid",
                "Potato aphid","Rose-grain aphid","Shallot aphid","Sycamore aphid","Willow-carrot aphid")
  longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
  lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)
  loc_name<-c("Ayr","Broom's Barn","Dundee","Edinburgh","Hereford","Newcastle","Preston","Rothamsted",
              "Starcross","Writtle","Wye")
  d0[d0==-999]<-NA
  Years<-1976:2010
  d_allsp<-list() #this is a list with 20 elements, all the species
  for (sp_c in 1:20)
  {
    d_thissp<-list() #a list with 11 locations for the current species
    for (st_c in 1:11)
    {
      d_thissp[[st_c]]<-data.frame(Year=Years,Dat=d0[st_c,((sp_c-1)*35+1):(sp_c*35)])
    }
    d_allsp[[sp_c]]<-d_thissp
  }
  names(d_allsp)<-name.aphid
  
  return(d_allsp=d_allsp)
  
}

# Aphid raw data for count
d0_count<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtscount141117.csv",header=F))

# Aphid raw data for first flight
d0_firstflight<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsfirstflight141117.csv",header=F))

## Aphid raw data for flight duration
#d0_flightduration<-as.matrix(read.csv("Data/Aphid_data/APHID_DATA_RAW/aphidtsflightdu#ration141117.csv",header=F))

```

Count results

```{r aphid_count, echo=F, cache=T, cache.extra=list(seed,d0_count)}
set.seed(seed)
cat(paste("start-time: ",Sys.time(),"\n"))
RES_aphid_count<-RES_single_sp(d_allsp=d_allsp_data(d0_count),sp=10,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30)
cat(paste("stop-time: ",Sys.time(),"\n"))
resloc<-"Results/"
saveRDS(RES_aphid_count,paste(resloc,file="AphidCopulaFit_selecloc_count_species_10.RDS",sep=""))
```

```{r}
RES_aphid_count
#no of locations showing greater lower tail dependence
sum((RES_aphid_count$LTdep_AICw-RES_aphid_count$UTdep_AICw)>0,na.rm=T)

#no of locations showing greater upper tail dependence
sum((RES_aphid_count$LTdep_AICw-RES_aphid_count$UTdep_AICw)<0,na.rm=T)

```

First flight results

```{r aphid_firstflight, echo=F, cache=T, cache.extra=list(seed,d0_firstflight)}
set.seed(seed)
cat(paste("start-time: ",Sys.time(),"\n"))
RES_aphid_firstflight<-RES_single_sp(d_allsp=d_allsp_data(d0_firstflight),sp=11,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30)
cat(paste("stop-time: ",Sys.time(),"\n"))
resloc<-"Results/"
saveRDS(RES_aphid_firstflight,paste(resloc,file="AphidCopulaFit_selecloc_firstflight_species_11.RDS",sep=""))
```


```{r}
RES_aphid_firstflight
#no of locations showing greater lower tail dependence
sum((RES_aphid_firstflight$LTdep_AICw-RES_aphid_firstflight$UTdep_AICw)>0,na.rm=T)

#no of locations showing greater upper tail dependence
sum((RES_aphid_firstflight$LTdep_AICw-RES_aphid_firstflight$UTdep_AICw)<0,na.rm=T)

```

### Non-paramtric analysis of tail dependence

Cout results


First flight results

## North sea plankton data

<!--Shya to edit the prentation below to make it more parallel to the presentation of the model selection results for C/N data above-->

### Model selection approach

```{r d_allsp_data_plankton_north_sea, echo=F}
d_allsp_data_plankton_north_sea<-function(d0){
  
  name.plankton<-c('Calanus_I-IV','Para-Pseudocalanus_spp','Temora_longicornis','Acartia_spp_(unidentified)','Centropages_typicus',
                   'Oithona_spp','Echinoderm_larvae','Calanus_finmarchicus','Calanus_helgolandicus','Metridia_lucens','Decapoda_larvae_(Total)',
                   'Euphausiacea_Total','Thalassiosira_spp','Rhizosolenia_styliformis','Ceratium_fusus','Ceratium_furca','Ceratium_tripos',
                   'Ceratium_macroceros','Rhizosolenia_alata_alata','Pseudocalanus_elongatus_Adult','Nitzschia_delicatissima','Nitzschia_seriata')
  
  longs<-read.csv("Data/Plankton_North_Sea_data/boxcornerlongs201117.csv",header=F)
  lats<-read.csv("Data/Plankton_North_Sea_data/boxcornerlats201117.csv",header=F)
  longs<-longs[[1]]
  lats<-lats[[1]]
  d0[d0==-999]<-NA
  Years<-1958:2013
  
  d_allsp<-list() #this is a list with 20 elements, all the species
  for (sp_c in 1:22)
  {
    d_thissp<-list() #a list with 11 locations for the current species
    d1<-d0[((sp_c-1)*26+1):(sp_c*26),]
    for (st_c in 1:26)
    {
      d_thissp[[st_c]]<-data.frame(Year=Years,Dat=d1[st_c,])
    }
    d_allsp[[sp_c]]<-d_thissp
  }
  names(d_allsp)<-name.plankton
  
  
  return(d_allsp=d_allsp)
  
}

d0_plankton_north_sea<-as.matrix(read.csv("./Data/Plankton_North_Sea_data/planktontimeseries201117_4.csv",header=F))

```

```{r plankton_north_sea, echo=F, cache=T, cache.extra=list(seed,d0_plankton_north_sea)}
set.seed(seed)
cat(paste("start-time: ",Sys.time(),"\n"))
RES_plankton_north_sea<-RES_single_sp(d_allsp=d_allsp_data_plankton_north_sea(d0_plankton_north_sea),sp=16,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=45)
cat(paste("stop-time: ",Sys.time(),"\n"))
resloc<-"Results/"
saveRDS(RES_plankton_north_sea,paste(resloc,file="Plankton_North_Sea_CopulaFit_selecloc_species_16.RDS",sep=""))
```

```{r}
RES_plankton_north_sea
#no of locations showing greater lower tail dependence
sum((RES_plankton_north_sea$LTdep_AICw-RES_plankton_north_sea$UTdep_AICw)>0,na.rm=T)

#no of locations showing greater upper tail dependence
sum((RES_plankton_north_sea$LTdep_AICw-RES_plankton_north_sea$UTdep_AICw)<0,na.rm=T)

```

### Non-paramtric analysis of tail dependence

# Question 2 analyses for each dataset

# Question 3 analyses for each dataset










