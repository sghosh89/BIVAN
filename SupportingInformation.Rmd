---
title: "Supporting Information"
author: "Shyamolina Ghosh and Daniel Reuman"
date: "February 12, 2018"
geometry: "left=1cm,right=1cm,top=2.5cm,bottom=2.8cm"

output: 
  pdf_document:
    number_sections: yes
    keep_tex: yes
    fig_caption: yes
---

updated on `r Sys.Date()`

<!--Basic setup-->
```{r setup, echo=F}
knitr::opts_chunk$set(echo = TRUE, fig.pos = "H")

library(captioner)
table_nums <- captioner(prefix = "Table")
fig_nums <- captioner(prefix="Figure")

seed<-101
families<-c(1,3:10,13,14,16:20)

#A function needed for caching
mtime <- function(files)
{
  lapply(Sys.glob(files),function(x) X =   
          file.info(x)$mtime)
}

source("getcopula.R")
source("OurBiCopSelect.R")
source("FittingCopula_selective_loc.R")
source("aphid_data_calling.R")
source("plankton_north_sea_data_calling.R")
source("NonParamStat.R")
source("copsurrog2d.R")
```

# Descriptions of data
<!--Each data contributor writes one to a few paragraphs about their data.-->

## Soil C and N data

<!--The raw data look like this:-->
```{r load_data_Loecke, echo=F, fig.cap="plot of the raw soil C and N data.", fig.height=5, fig.width=5}
d<-readRDS("Data/RaCA_soilorganicC_soiltotalN_stocks100cm.RDS")
d<-d[,c("SOCstock100","TSNstock100")]
fig_nums("soilCNraw",display=F)
plot(d[,1],d[,2],type="p",col="red",xlab="Soil C",ylab="Soil N",cex.lab=1)
```

<!--The copula looks like this:-->
```{r rankandplot_Loecke, echo=F, fig.cap="Copula plot of soil C and N data",  fig.height=5, fig.width=5}
#convert to a copula and plot
fig_nums("soilCNcop",display=F)
v_CN<-getcopula(d=d,rankon=T,ploton=T) #with real data, rankon should be T
```

Carbon and nitrogen in soil at many locations across CONUS (Terry to augment this description). The raw data are shown in `r fig_nums("soilCNraw",display="c")`. The copula is shown in `r fig_nums("soilCNcop",display="c")`.

<!--Shyamolina, let's not put in newpages and other spacing modifications until possibly at the end, once all the content is essentially settled-->

## Aphid data
   * Aphid data contains 3 measurements [count, firstflight, flight-duration] at 11 locations for 20 species and for 35 years.
   * We threw out all locations that had fewer than 30 years data 
   * We use species=10 [Name : "Green spruce aphid"] for aphid-count data 
   * We use species=11 [Name : "Leaf-curling plum aphid"] for aphid-firstflight data   
   
## North Sea plankton data
   * Plankton North sea dataset collects data at 26 locations for 22 species and for 56 years.
   * We threw out all locations that had fewer than 45 years data
   * We use species=16 [Name : "Ceratium_furca"] for Plankton_North_Sea data
   
# Question 1 analyses for each dataset
Recall that question 1 is: Do datasets in ecology and related fields have non-Gausian copula structure? Do they show tail dependence distinct from that of a Gaussian copula? In particular do they show asymmetric tail dependence?

## Details of methods

### Model selection approach


### Non-parametric analysis of tail dependence

<!--Shya to edit this description of the stats. Don't need subsections for each stat.-->
<!--Eventually we will need to add methods on how we use these stats, which is different for multivariate and bivariate data-->
<!--Eventually, for the multivariate data, we will need to demonstrate using a similar analysis to what is in mbsyn, that you can detect asymmetry of tail dependence using these stats - we have done this, but it needs to be adapted-->

#### stat_CorlCoru
```{r stat_CorlCoru_D2lD2u, echo=F}
fig_nums("stat_CorlCoru_D2lD2u",display=F)
```
![schematic diagram for stat_CorlCoru and stat_D2lD2u](./CorlCoru_D2lD2u.jpg){ width=30%, height=30% }

If we draw a ranking based copula plot of a dataset within a unit square box then the points are scattered within the box according to their joint-marginal distribution. Say, there are total $n$ number of datapoints and $vi$ and $vj$ are the ranks of the dataset taken at [i,j] location pair or for [i,j] observables. To measure their tail dependence, i. e., the points are concentrated in the left corner or right corner of the box, we will calculate our statistics on left and right side of $vi+vj=1$ line [see solid blue line in `r fig_nums("stat_CorlCoru_D2lD2u",display="c")`]. Now, we define the total covariance of $(vi,vj)$ as;

\begin{equation}\label{eq.CorlCoru}
   C = \frac{1}{n-1}\sum_{k=1}^{n}\left [ vi(k)-\left<vi\right> \right ] \left[ vj(k)-\left<vi\right> \right ]
\end{equation}

where, $\left<vi\right>$ and $\left<vj\right>$ are the mean of $vi$ and $vj$ of the points within the box respectively. If we think the total covariance $C$ as sum of covariance of the points lie within $vi+vj<1$ region, namely, $Corl$ and for $vi+vj>1$ region, namely, $Coru$; then $C = Corl + Coru$. So, $Corl$ and $Coru$ can be defined by;

\begin{equation}\label{eq.Corl}
   Corl = \frac{1}{n-1}\sum_{k \epsilon (vi+vj<1)}\left [ vi(k)-\left<vi\right> \right ] \left[ vj(k)-\left<vj\right> \right ]
\end{equation}

and

\begin{equation}\label{eq.Coru}
   Coru = \frac{1}{n-1}\sum_{k \epsilon (vi+vj>1)}\left [ vi(k)-\left<vi\right> \right ] \left[ vj(k)-\left<vj\right> \right ]
\end{equation}

If we take their difference then that will tetll us which end of the copula is with stronger correlation. A copula with $(Corl-Coru)>0$ should have more lower tail dependence whereas $(Corl-Coru)<0$ indicates more upper tail dependence. Symmetric copula has $Corl = Coru$.

#### stat_PlPu

```{r stat_PlPu, echo=F}
fig_nums("stat_PlPu",display=F)
```
![schematic diagram for stat_PlPu](./PlPu.jpg){ width=35%, height=35% } 

To start with, we consider the lower triangular region of  `r fig_nums("stat_PlPu",display="c")` for which $vi+vj<1$. First, we take $Sl_{p}$, the ratio of number of points within the shaded pentagon and number of points lie on the left side of $vi+vj=1$ line. This $Sl_{p}$ is a function of distance-parameter $h$ which has range from $0$ to $\sqrt2/2$ (= half of the length of the box-diagonal). Similarly, we calculate $Su_{p}(h)$ for region $vi+vj>1$. Then we considered the independent case as if the points within the box scattered uniformly. $Si_{p}$ represents the ratio of the pentagon and the area of right angled isosceles triangle of unit side. Now, we want to measure that how much $Sl_{p}$ and $Su_{p}$ deviate from the standard $Si_{p}$ line when they are plotted against $h$. Their deviations $Pl$ and $Pu$, representing our statistics to measure lower and upper tail dependence, are given by;

\begin{equation}\label{eq.Pl}
   Pl = \int_0^{\sqrt2/2} \left[ Sl_{p}(h) - Si_{p}(h) \right] \,dh
\end{equation}

\begin{equation}\label{eq.Pu}
   Pu = \int_0^{\sqrt2/2} \left[ Su_{p}(h) - Si_{p}(h) \right] \,dh
\end{equation}

A copula having $(Pl-Pu)>0$ represents more lower tail dependence whereas a copula with negative $(Pl-Pu)$ represents more upper tail dependence. A copula with equal $Pl$ and $Pu$ value is considered as symmetric with no tail-dependence.

#### stat_TlTu

```{r stat_TlTu, echo=F}
fig_nums("stat_TlTu",display=F)
```
![schematic diagram for stat_TlTu](./TlTu.jpg){ width=30%, height=30% }

This statistic is an alternative kind of the previous statistics. Here, to measure tail dependence between two marginal distributions, we will calculate our statistics on left and right side of $vi+vj=1$ line [see `r fig_nums("stat_TlTu",display="c")`] of the unit square box. First, we take $Il$, the ratio of number of points within the shaded lower triangle and the number of points lie on the left side of $vi+vj=1$ line. This $Il$ is a function of 
box-corner to the box-diagonal distance $h$ which has range from $0$ to $\sqrt2/2$ (= half of the length of the box-diagonal). Thus $Il$ also lies in between the same range [$0,1$]. Similarly, we calculate $Iu(h)$ for region $vi+vj>1$. Usual independent standard $Ii(h)$ represents the ratio of one shaded triange and the area of right angled isosceles triangle of unit side. Now, we want to measure that how much $Il(h)$ and $Iu(h)$ deviate from the standard $Ii(h)$ line when they are plotted against $h$. Their deviations $Tl$ and $Tu$, representing our statistics to measure lower and upper tail dependence, are given by;

\begin{equation}\label{eq.Tl}
   Tl = \int_0^{\sqrt2/2} \left[ Il(h) - Ii(h) \right] \,dh
\end{equation}

\begin{equation}\label{eq.Tu}
   Tu = \int_0^{\sqrt2/2} \left[Iu(h) - Ii(h) \right] \,dh
\end{equation}

According to this statistic a copula with more lower tail dependence should have positive $(Tl-Tu)$ value whereas a copula with negative $(Tl-Tu)$ represents more upper tail dependence. A copula with equal $Tl$ and $Tu$ value is considered as a member of symmetric copula family with no tail-dependence.

#### stat_D2lD2u

In this statistic as usual we divide the unit square box into two region based on either side of $vi+vj=1$ line. For the lower triangular region, we calculate squared distance of each scattered point from $vi-vj=0$ [the dotted line in `r fig_nums("stat_CorlCoru_D2lD2u",display="c")`] and then take their average. This quantity (say, $D2l$) represents how much the points in the lower tail of a copula are condensed to the identity line. Similarly, we calculate $D2u$ for the upper triangular region. If for a given copula $(D2u-D2l)>0$, then it is with more lower tail dependence as the upper-end points are distantly spaced from the long axis of the copula. Conversely, $(D2u-D2l)<0$ means a copula with more upper tail dependence. If $D2l$ and $D2u$ are equal, then the data come from a symmetric copula.


## Soil C and N data

### Model selection approach
```{r bivmodselect_Loecke, echo=F, cache=T, cache.extra=list(seed,v_CN,mtime("OurBiCopSelect.R"))}
set.seed(seed)
families_Loecke<-c(1,3:10,13:14,16:20) 
BivMS_res_Loecke<-OurBiCopSelect(u1=v_CN[,1],u2=v_CN[,2],families=families_Loecke,level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,gofnormal=F,status=F)
```
The test of indepedence gave $p=$ `r BivMS_res_Loecke$IndepTestRes`. 

We fitted several copulas
and got AIC values and upper- and lower-tail dependency estimates based on the fitted copulas:
```{r soilCNfit,echo=F}
h<-BivMS_res_Loecke$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
table_nums("soilCNfit",display=F)
knitr::kable(h, caption = "Fitting info for soil C and N dataset. Here and henceforth copula names are abbreviated as: N=normal (Gaussian); C=Clayton; G=Gumbel; F=Frank; J=Joe; SC=Survival Clayton; SG=Survival Gumbel; SJ=Survival Joe. An S in front of one of the copulas BB1, BB6, BB7, BB8 indicates the survival version of that copula (rotation by 180 degrees).")
```

`r table_nums("soilCNfit",display="c")` shows that several copulas are much better supported (higher AIC and BIC weights) than the Gaussian copula, answering the first part of question 1 for these data.

The model-averaged (using AIC) lower-tail dependence statistic was `r BivMS_res_Loecke$relLTdep_AICw` and the model-averaged (again, AIC) upper-tail dependence statistic was `r BivMS_res_Loecke$relUTdep_AICw`, and these values are distinct from what a Gaussian copula would give (i.e., 0), answering the second part of question 1 for these data. Furthermore, the difference of these two quantities (lower minus upper), `r BivMS_res_Loecke$relLTdep_AICw-BivMS_res_Loecke$relUTdep_AICw`, was different from 0, answering the third part of question 1. 

Although these results do convincingly show non-Gaussian copula structure, we should take the tail dependence results with a grain of salt because even the lowest-AIC copula was a poor fit, giving $p$-value `r BivMS_res_Loecke$GofRes_CvM` in the Cramer-von Mises-based test of the goodness of its fit, and $p$-value `r BivMS_res_Loecke$GofRes_KS` in the Kolmogorov-Smirnov-based test of the goodness of fit. The next section looks at tail dependence in a non-parametric way.

### Non-parametric analysis of tail dependence
<!--Do the intensive part of the analysis, calculating stats on the data and surrogates-->
```{r stat_soilCN_graphic_approach, echo=F, cache=T, cache.extra=list(seed,v_CN,mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
set.seed(seed) 

#utility function for calculating all the stats we want
calcstats<-function(v,f,nm)
{
  #calculate the stats
  res<-c()
  #f(v[,1],v[,2],0,.5),
  #        f(v[,1],v[,2],0.5,1),
  #        f(v[,1],v[,2],0,.25),
  #        f(v[,1],v[,2],0.25,.5),
  #        f(v[,1],v[,2],.5,.75),
  #        f(v[,1],v[,2],.75,1))
  for (lbd in seq(from=0,to=0.9,by=0.1))
  {
    res<-c(res,f(v[,1],v[,2],lbd,lbd+.1))
  }
  
  #name the result vector
#  h<-paste(nm,c(0,0.5,0,0.25,0.5,0.75,seq(from=0,to=0.9,by=0.1)),"to",
#                    c(0.5,1,0.25,0.5,0.75,1,seq(from=0,to=0.9,by=0.1)+.1),sep='')
  h<-paste(nm,c(seq(from=0,to=0.9,by=0.1)),"to",
                    c(seq(from=0,to=0.9,by=0.1)+.1),sep='')
  h<-gsub(".","p",h,fixed=T)
  names(res)<-h
    
  return(res)
}

#Do the kendall surrogates
cop<-normalCopula(.5,2)
numsurrog<-1000
surv_K<-copsurrog2d(v_CN,cop,"kendall",numsurrog)

#Do the spearman surrogates
surv_S<-copsurrog2d(v_CN,cop,"spearman",numsurrog)

#utility function for calculating fractions of surrogates 
#with a stat smaller than that of data, i.e., fraction of 
#surrogates for which the stat value on the data is bigger
fracwork<-function(dvals,surrvals)
{
  frac<-NA*numeric(length(dvals))
  names(frac)<-names(dvals)
  for (counter in 1:length(frac))
  {
    frac[counter]<-sum(surrvals[counter,]<dvals[counter])
  }
  return(frac)
}

#now work with the correlation stats
corstats_d<-calcstats(v_CN,Corbds,"Cor")
corstats_K<-apply(FUN=calcstats,X=surv_K,MARGIN=3,f=Corbds,nm="Cor")
corstats_frac_K<-fracwork(corstats_d,corstats_K)

corlmcoru_d<-unname(corstats_d[1]-corstats_d[length(corstats_d)])
corlmcoru_K<-corstats_K[1,]-corstats_K[length(corstats_d),]
corlmcoru_frac_K<-sum(corlmcoru_K<corlmcoru_d)
corstats_K<-apply(FUN=quantile,X=corstats_K,MARGIN=1,prob=c(.005,0.25,.975,.995))

corstats_S<-apply(FUN=calcstats,X=surv_S,MARGIN=3,f=Corbds,nm="Cor")
corstats_frac_S<-fracwork(corstats_d,corstats_S)

corlmcoru_S<-corstats_S[1,]-corstats_S[length(corlmcoru_d),]
corlmcoru_frac_S<-sum(corlmcoru_S<corlmcoru_d)
corstats_S<-apply(FUN=quantile,X=corstats_S,MARGIN=1,prob=c(.005,0.25,.975,.995))

#now work with the P stats
Pbds_wrap<-function(vi,vj,lb,ub)
{
  return(Pbds(vi,vj,lb,ub)$abs_res)
}

Pstats_d<-calcstats(v_CN,Pbds_wrap,"P")
Pstats_K<-apply(FUN=calcstats,X=surv_K,MARGIN=3,f=Pbds_wrap,nm="P")
Pstats_frac_K<-fracwork(Pstats_d,Pstats_K)

PlmPu_d<-unname(Pstats_d[1]-Pstats_d[length(Pstats_d)])
PlmPu_K<-Pstats_K[1,]-Pstats_K[length(Pstats_d),]
PlmPu_frac_K<-sum(PlmPu_K<PlmPu_d)
Pstats_K<-apply(FUN=quantile,X=Pstats_K,MARGIN=1,prob=c(.005,0.25,.975,.995))

Pstats_S<-apply(FUN=calcstats,X=surv_S,MARGIN=3,f=Pbds_wrap,nm="P")
Pstats_frac_S<-fracwork(Pstats_d,Pstats_S)

PlmPu_S<-Pstats_S[1,]-Pstats_S[length(Pstats_d),]
PlmPu_frac_S<-sum(PlmPu_S<PlmPu_d)
Pstats_S<-apply(FUN=quantile,X=Pstats_S,MARGIN=1,prob=c(.005,0.25,.975,.995))

#now work with the D2 stats
D2stats_d<-calcstats(v_CN,D2bds,"Dtwo")
D2stats_K<-apply(FUN=calcstats,X=surv_K,MARGIN=3,f=D2bds,nm="Dtwo")
D2stats_frac_K<-fracwork(D2stats_d,D2stats_K)

D2umD2l_d<-D2stats_d[length(D2stats_d)]-D2stats_d[1]
D2umD2l_K<-D2stats_K[length(D2stats_d),]-D2stats_K[1,]
D2umD2l_frac_K<-sum(D2umD2l_K<D2umD2l_d)
D2stats_K<-apply(FUN=quantile,X=D2stats_K,MARGIN=1,prob=c(.005,0.25,.975,.995))

D2stats_S<-apply(FUN=calcstats,X=surv_S,MARGIN=3,f=D2bds,nm="Dtwo")
D2stats_frac_S<-fracwork(D2stats_d,D2stats_S)

D2umD2l_S<-D2stats_S[length(D2stats_d),]-D2stats_S[1,]
D2umD2l_frac_S<-sum(D2umD2l_S<D2umD2l_d)
D2stats_S<-apply(FUN=quantile,X=D2stats_S,MARGIN=1,prob=c(.005,0.25,.975,.995))
```

<!--Now save the plot to the results folder-->
```{r plot_soilCN_graphic_approach, echo=F}
x<-seq(from=0.05,to=0.95,by=0.1)
xlimits<-c(0,1)

#plotting layout, units inches
xht<-0.5
ywd<-0.5
titleht<-.25
panht<-1.5
panwd<-3
gap<-.05
totwd<-ywd+2*panwd+2*gap
totht<-xht+3*panht+3*gap+titleht
pdf(file="./Results/stat_results/stat_soilCN//CNdata_NonparamTailDep.pdf",width=totwd,height=totht)
  
#plot kendall results on the left panels, spearman on right,
#cor in top panels, then P, then D2 on bottom panels

#kendall, cor
par(fig=c(ywd/totwd,
          (ywd+panwd)/totwd,
          (xht+2*panht+2*gap)/totht,
          (xht+3*panht+2*gap)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25)
ylimits_cor<-range(corstats_d,corstats_K,corstats_K)
ylimits_cor[2]<-ylimits_cor[2]+.3*diff(ylimits_cor)
plot(x,corstats_d,type='l',col="red",xlim=xlimits,ylim=ylimits_cor,
     xaxt='n')
mtext(side=3,line=0,text="Kendall-preserving surrogates")
mtext(side=2,line=1,text="Partial correlation")
axis(side=1,labels=F)
lines(x,corstats_K[1,],type='l',lty='dotted')
lines(x,corstats_K[2,],type='l',lty='dashed')
lines(x,corstats_K[3,],type='l',lty='dashed')
lines(x,corstats_K[4,],type='l',lty='dotted')
text(xlimits[1],ylimits_cor[1],labels='A',cex=1.5,adj=c(.5,0))
fracplot<-function(fracs,ylims)
{
  for (counter in 1:length(fracs))
  {
    ptxt<-''
    if (fracs[counter]>.975*numsurrog)
    {
      ptxt<-paste(">",fracs[counter],sep='')
    } 
    if (fracs[counter]<.025*numsurrog)
    {
      ptxt<-paste("<",numsurrog-fracs[counter],sep='')
    }
    yht<-ylims[2]-.1*diff(ylims)
    text(x[counter],yht,ptxt,adj=c(0.5,.5),cex=0.5,srt=90)
  }
}
fracplot(corstats_frac_K,ylimits_cor)
vlineplot<-function(x,ylims)
{
  for (counter in 1:length(x))
  {
    lines(rep(x[counter]-(x[2]-x[1])/2,2),ylims,type='l',lty='dotted')
  }
  lines(rep(x[length(x)]+(x[2]-x[1])/2,2),ylims,type='l',lty='dotted')
}
vlineplot(x,ylimits_cor)

#spearman, cor
par(fig=c((ywd+panwd+gap)/totwd,
          (ywd+2*panwd+gap)/totwd,
          (xht+2*panht+2*gap)/totht,
          (xht+3*panht+2*gap)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25,new=T)
plot(x,corstats_d,type='l',col="red",xlim=xlimits,ylim=ylimits_cor,
     xaxt='n',yaxt='n')
mtext(side=3,line=0,text="Spearman-preserving surrogates")
axis(side=1,labels=F)
axis(side=2,labels=F)
lines(x,corstats_S[1,],type='l',lty='dotted')
lines(x,corstats_S[2,],type='l',lty='dashed')
lines(x,corstats_S[3,],type='l',lty='dashed')
lines(x,corstats_S[4,],type='l',lty='dotted')
text(xlimits[1],ylimits_cor[1],labels='B',cex=1.5,adj=c(.5,0))
fracplot(corstats_frac_S,ylimits_cor)
vlineplot(x,ylimits_cor)

#kendall, P
par(fig=c(ywd/totwd,
          (ywd+panwd)/totwd,
          (xht+panht+gap)/totht,
          (xht+2*panht+gap)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25,new=T)
ylimits_D2<-range(D2stats_d,D2stats_K,D2stats_K)
ylimits_D2[2]<-ylimits_D2[2]+.3*diff(ylimits_D2)
ylimits_P<-range(Pstats_d,Pstats_K,Pstats_K)
ylimits_P[2]<-ylimits_P[2]+.3*diff(ylimits_P)
plot(x,Pstats_d,type='l',col="red",xlim=xlimits,ylim=ylimits_P,xaxt='n')
axis(side=1,labels=F)
mtext(side=2,line=1,text="P")
lines(x,Pstats_K[1,],type='l',lty='dotted')
lines(x,Pstats_K[2,],type='l',lty='dashed')
lines(x,Pstats_K[3,],type='l',lty='dashed')
lines(x,Pstats_K[4,],type='l',lty='dotted')
text(xlimits[1],ylimits_P[1],labels='C',cex=1.5,adj=c(.5,0))
fracplot(Pstats_frac_K,ylimits_P)
vlineplot(x,ylimits_P)

#spearman, p
par(fig=c((ywd+panwd+gap)/totwd,
          (ywd+2*panwd+gap)/totwd,
          (xht+panht+gap)/totht,
          (xht+2*panht+gap)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25,new=T)
plot(x,Pstats_d,type='l',col="red",xlim=xlimits,ylim=ylimits_P,
     xaxt='n',yaxt='n')
axis(side=1,labels=F)
axis(side=2,labels=F)
lines(x,Pstats_S[1,],type='l',lty='dotted')
lines(x,Pstats_S[2,],type='l',lty='dashed')
lines(x,Pstats_S[3,],type='l',lty='dashed')
lines(x,Pstats_S[4,],type='l',lty='dotted')
text(xlimits[1],ylimits_P[1],labels='D',cex=1.5,adj=c(.5,0))
fracplot(Pstats_frac_S,ylimits_P)
vlineplot(x,ylimits_P)

#kendall, D2
par(fig=c(ywd/totwd,
          (ywd+panwd)/totwd,
          (xht)/totht,
          (xht+panht)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25,new=T)
plot(x,D2stats_d,type='l',col="red",xlim=xlimits,ylim=ylimits_D2)
mtext(side=1,line=1,text="Diagonal slice")
mtext(side=2,line=1,text=expression(D[2]))
axis(side=1,labels=F)
lines(x,D2stats_K[1,],type='l',lty='dotted')
lines(x,D2stats_K[2,],type='l',lty='dashed')
lines(x,D2stats_K[3,],type='l',lty='dashed')
lines(x,D2stats_K[4,],type='l',lty='dotted')
text(xlimits[1],ylimits_D2[1],labels='E',cex=1.5,adj=c(.5,0))
fracplot(D2stats_frac_K,ylimits_D2)
vlineplot(x,ylimits_D2)

#spearman, P
par(fig=c((ywd+panwd+gap)/totwd,
          (ywd+2*panwd+gap)/totwd,
          (xht)/totht,
          (xht+panht)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25,new=T)
plot(x,D2stats_d,type='l',col="red",xlim=xlimits,ylim=ylimits_D2,
     yaxt='n')
mtext(side=1,line=1,text="Diagonal slice")
axis(side=1,labels=F)
axis(side=2,labels=F)
lines(x,D2stats_S[1,],type='l',lty='dotted')
lines(x,D2stats_S[2,],type='l',lty='dashed')
lines(x,D2stats_S[3,],type='l',lty='dashed')
lines(x,D2stats_S[4,],type='l',lty='dotted')
text(xlimits[1],ylimits_D2[1],labels='F',cex=1.5,adj=c(.5,0))
fracplot(D2stats_frac_S,ylimits_D2)
vlineplot(x,ylimits_D2)

dev.off()
```

<!--Now include the plot in the Rmd output-->
```{r show_plot_soildCN,echo=F}
fig_nums("soilCN_nonparam",display=F)
```
![Nonparametric tests for tail dependence and other deviations from a normal copula for soil C and N data. As described in Methods, each statistic was computed on the data using the ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (red lines), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (dashed lines show 0.025 and 0.975 quantiles of these results and dotted lines show 0.005 and 0.995 quantiles).  When red lines were outside dashed lines, text at the top of plots indicates how many surrogate values the data value was less than or greater than.](./Results/stat_results/stat_soilCN//CNdata_NonparamTailDep.pdf)

<!--Now make a table, this one about asymmetry of tail dependence-->
```{r plot_soilCN_asymmtry_taildep, echo=F}
atdres<-data.frame(Statistic=c("Corl-Coru","Pl-Pu","D2u-D2l"),
                   Kendall=rep("",3),
                   Spearman=rep("",3),stringsAsFactors = F)
fractxt<-function(fracval)
{
  ptxt<-''
  if (fracval>.975*numsurrog)
  {
    ptxt<-paste(">",fracval,sep='')
  } 
  if (fracval<.025*numsurrog)
  {
    ptxt<-paste("<",numsurrog-fracval,sep='')
  }
  return(ptxt)
}
atdres[1,2]<-fractxt(corlmcoru_frac_K)
atdres[1,3]<-fractxt(corlmcoru_frac_S)
atdres[2,2]<-fractxt(PlmPu_frac_K)
atdres[2,3]<-fractxt(PlmPu_frac_S)
atdres[3,2]<-fractxt(D2umD2l_frac_K)
atdres[3,3]<-fractxt(D2umD2l_frac_S)
atdres
```

## Aphid abundance data 
<!--Add common and species name to header-->

### Model selection approach

```{r read_aphid_data, echo=F}
# Aphid raw data for count
d0_count<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtscount141117.csv",header=F))
data_aphid_count<-d_allsp_data(d0_count)     
 
# Aphid raw data for first flight
d0_firstflight<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsfirstflight141117.csv",header=F))
data_aphid_ff<-d_allsp_data(d0_firstflight) 

# Aphid raw data for flight duration   
#d0_flightduration<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsflightduration141117.csv",header=F))

```

```{r RES_aphid_count, echo=F, cache=T, cache.extra=list(seed,data_aphid_count)}
set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_aphid_count<-RES_single_sp(d_allsp=data_aphid_count,sp=10,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30)
#cat(paste("stop-time: ",Sys.time(),"\n"))
resloc<-"./Results/fitting_results/"
saveRDS(RES_aphid_count,paste(resloc,file="AphidCopulaFit_selecloc_count_species_10.RDS",sep=""))
```

```{r read_RES_aphid_count, echo=F}
RES_aphid_count<-readRDS("./Results/fitting_results/AphidCopulaFit_selecloc_count_species_10.RDS")
```

\newpage

```{r count_bestcop,echo=F,results="asis"}
#library(pander)
#pander(best_cop_LTdep, caption = "Hello caption!")
#knitr::kable(RES_aphid_count$info_ord_copname[,,1],format="latex",longtable=F,caption = "Aphid_count : Best fit copula family for each selective location pair")

table_nums("count_bestcop",display=F)
knitr::kable(RES_aphid_count$info_ord_copname[,,1],caption = "Aphid_count : Best fit copula family for each selective location pair")
```

```{r count_AICw,echo=F,results="asis"}
table_nums("count_AICw",display=F)
knitr::kable(RES_aphid_count$info_ord_AICw[,,1], caption = "Aphid_count : AICw for best fit copula family for each selective location pair")
```

```{r count_LTdep,echo=F,results="asis"}
table_nums("count_LTdep",display=F)
knitr::kable(RES_aphid_count$info_ord_LTdep[,,1], caption = "Aphid_count : Lower Tail dependence for best fit copula family for each selective location pair")
```

```{r count_UTdep,echo=F,results="asis"}
table_nums("count_UTdep",display=F)
knitr::kable(RES_aphid_count$info_ord_UTdep[,,1], caption = "Aphid_count : Upper Tail dependence for best fit copula family for each selective location pair")
```

```{r count_LTdep_AICw,echo=F,results="asis"}
table_nums("count_LTdep_AICw",display=F)
knitr::kable(RES_aphid_count$LTdep_AICw,caption = "Aphid_count : Lower Tail dependence statistic for best fit copula family for each selective location pair")
```

```{r count_UTdep_AICw,echo=F,results="asis"}
table_nums("count_UTdep_AICw",display=F)
knitr::kable(RES_aphid_count$UTdep_AICw,caption = "Aphid_count : Upper Tail dependence statistic for best fit copula family for each selective location pair")

```

```{r count_LTmUT,echo=F,results="asis"}
table_nums("count_LTmUT",display=F)
knitr::kable(round(RES_aphid_count$LTdep_AICw-RES_aphid_count$UTdep_AICw,5),caption = "Aphid_count : Lower Tail - Upper Tail dependence statistic for best fit copula family for each of the selective location pair")
```

```{r count_p_CvM,echo=F,results="asis"}
table_nums("count_p_CvM",display=F)
knitr::kable(RES_aphid_count$gfc_p_CvM, caption = "Aphid_count : p-values (Cramer-von Mises-based test) for lowest AIC based best fit copula")
```

```{r count_p_KS,echo=F,results="asis"}
table_nums("count_p_KS",display=F)
knitr::kable(RES_aphid_count$gfc_p_KS,caption = "Aphid_count : p-values (Kolmogorov-Smirnov-based test) for lowest AIC based best fit copula")
```

`r table_nums("count_bestcop",display="c")` shows that several copulas are much better supported than the Gaussian copula, answering the first part of question 1 for these data.
The model-averaged (using AIC) lower-tail dependence statistic and the model-averaged (again, AIC based) upper-tail dependence statistic are presented in `r table_nums("count_LTdep_AICw",display="c")` and `r table_nums("count_UTdep_AICw",display="c")` respectively, and these values are distinct from what a Gaussian copula would give (i.e., 0), answering the second part of question 1 for these data. Furthermore, the difference of these two quantities (lower minus upper) in `r table_nums("count_LTmUT",display="c")` indicates it is different from 0 for most of the locations, answering the third part of question 1. 

These results do convincingly show non-Gaussian copula structure, having **`r sum((RES_aphid_count$LTdep_AICw-RES_aphid_count$UTdep_AICw)>0,na.rm=T)`** out of **`r (dim(RES_aphid_count$gfc_p_CvM)[1]^2-dim(RES_aphid_count$gfc_p_CvM)[1])-RES_aphid_count$num_indep_loc_pair`** location pair with greater lower tail dependence. Our fitting results are supported by the lowest-AIC copula *p*-value in the Cramer-von Mises-based test [`r table_nums("count_p_CvM",display="c")`] of the goodness of its fit, and in the Kolmogorov-Smirnov-based test [`r table_nums("count_p_KS",display="c")`] of the goodness of fit.

The next section looks at tail dependence in a non-parametric way.

### Non-paramtric analysis of tail dependence

```{r stat_aphid_count, echo=F, cache=T, cache.extra=list(seed,data_aphid_count)}
set.seed(seed) 
resloc<-"./Results/stat_results/stat_aphid_count/"

sp<-10
good_loc <- good_loclist(d_allsp=data_aphid_count,sp=sp,data_pt_thrs=30)
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_count<-multcall(d_allsp=data_aphid_count,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc)
saveRDS(stat_aphid_count,paste(resloc,file="stat_aphid_count_sp_10.RDS",sep='')) 
```

```{r read_stat_aphid_count,echo=F}
stat_aphid_count<-readRDS("./Results/stat_results/stat_aphid_count/stat_aphid_count_sp_10.RDS")
```

```{r count_resamp,echo=F,results="asis"}
table_nums("count_resamp",display=F)
knitr::kable(stat_aphid_count$numericdf, caption = "Aphid_count : resampling result for stat indicating lower tail dependence")
```

```{r count_allcop,echo=F}
fig_nums("count_allcop",display=F)
```
![copula plot for aphid-count](./Results/stat_results/stat_aphid_count/Sp_10_AllCops.pdf)

```{r count_spear,echo=F}
fig_nums("count_spear",display=F)
```
![Plot for aphid-count : Spearman vs. Distance](./Results/stat_results/stat_aphid_count/Sp_10_Spearman_vs_D.pdf){ width=50%, height=50% }

```{r count_kend,echo=F}
fig_nums("count_kend",display=F)
```
![Plot for aphid-count : Kendall vs. Distance](./Results/stat_results/stat_aphid_count/Sp_10_Kendall_vs_D.pdf){ width=50%, height=50% }

```{r count_Corl-Coru,echo=F}
fig_nums("count_Corl-Coru",display=F)
```
![Corl-Coru vs. Distance plot for aphid-count showing lower tail dependence](./Results/stat_results/stat_aphid_count/Sp_10_Corl-Coru_vs_D.pdf){ width=50%, height=50% }

```{r count_Pl-Pu,echo=F}
fig_nums("count_Pl-Pu",display=F)
```
![Pl-Pu vs. Distance plot for aphid-count showing lower tail dependence](./Results/stat_results/stat_aphid_count/Sp_10_Pl-Pu_vs_D.pdf){ width=50%, height=50% }

```{r count_Tl-Tu,echo=F}
fig_nums("count_Tl-Tu",display=F)
```
![Tl-Tu vs. Distance plot for aphid-count showing lower tail dependence](./Results/stat_results/stat_aphid_count/Sp_10_Tl-Tu_vs_D.pdf){ width=50%, height=50% }

```{r count_D2u-D2l,echo=F}
fig_nums("count_D2u-D2l",display=F)
```
![D2u-D2l vs. Distance plot for aphid-count showing lower tail dependence](./Results/stat_results/stat_aphid_count/Sp_10_D2u-D2l_vs_D.pdf){ width=50%, height=50% }

```{r count_D2u/D2l,echo=F}
fig_nums("count_D2u/D2l",display=F)
```
![D2u/D2l vs. Distance plot for aphid-count showing lower tail dependence](./Results/stat_results/stat_aphid_count/Sp_10_D2u_by_D2l_vs_D.pdf){ width=50%, height=50% }

<!--
```{r, echo=F,out.width = "8cm", out.height= "8cm", out.caption="adhjk"}
knitr::include_graphics("./Results/stat_results/stat_aphid_count/Sp_10_Spearman_vs_D.pdf")
knitr::include_graphics("./Results/stat_results/stat_aphid_count/Sp_10_Kendall_vs_D.pdf")
```
-->

## Aphid first flight data
<!--Add species common name and scientific name to header-->

### Model selection approach

```{r RES_aphid_ff, echo=F, cache=T, cache.extra=list(seed,data_aphid_ff)} 
set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n"))
RES_aphid_ff<-RES_single_sp(d_allsp=data_aphid_ff,sp=11,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30)
#cat(paste("stop-time: ",Sys.time(),"\n")) 
resloc<-"./Results/fitting_results/"
saveRDS(RES_aphid_ff,paste(resloc,file="AphidCopulaFit_selecloc_firstflight_species_11.RDS",sep=""))
```

```{r read_RES_aphid_ff,echo=F}
RES_aphid_ff<-readRDS("./Results/fitting_results/AphidCopulaFit_selecloc_firstflight_species_11.RDS")
```

\newpage

```{r ff_bestcop,echo=F,results="asis"}
table_nums("ff_bestcop",display=F)
knitr::kable(RES_aphid_ff$info_ord_copname[,,1], caption = "Aphid_firstflight : Best fit copula family for each selective location pair")
```

```{r ff_AICw,echo=F,results="asis"}
table_nums("ff_AICw",display=F)
knitr::kable(RES_aphid_ff$info_ord_AICw[,,1], caption = "Aphid_firstflight : AICw for best fit copula family for each selective location pair")
```

```{r ff_LTdep,echo=F,results="asis"}
table_nums("ff_LTdep",display=F)
knitr::kable(RES_aphid_ff$info_ord_LTdep[,,1], caption = "Aphid_firstflight : Lower Tail dependence for best fit copula family for each selective location pair")
```

```{r ff_UTdep,echo=F,results="asis"}
table_nums("ff_UTdep",display=F)
knitr::kable(RES_aphid_ff$info_ord_UTdep[,,1], caption = "Aphid_firstflight : Upper Tail dependence for best fit copula family for each selective location pair")
```

```{r ff_LTdep_AICw,echo=F,results="asis"}
table_nums("ff_LTdep_AICw",display=F)
knitr::kable(RES_aphid_ff$LTdep_AICw, caption = "Aphid_firstflight : Lower Tail dependence statistic for best fit copula family for each selective location pair")
```

```{r ff_UTdep_AICw,echo=F,results="asis"}
table_nums("ff_UTdep_AICw",display=F)
knitr::kable(RES_aphid_ff$UTdep_AICw, caption = "Aphid_firstflight : Upper Tail dependence statistic for best fit copula family for each selective location pair")
```

```{r ff_LTmUT,echo=F,results="asis"}
table_nums("ff_LTmUT",display=F)
knitr::kable(round(RES_aphid_ff$LTdep_AICw-RES_aphid_ff$UTdep_AICw,5), caption = "Aphid_firstflight : Lower Tail - Upper Tail dependence statistic for best fit copula family for each of the selective location pair")
```

```{r ff_p_CvM,echo=F,results="asis"}
table_nums("ff_p_CvM",display=F)
knitr::kable(RES_aphid_ff$gfc_p_CvM, caption = "Aphid_firstflight : p-values (Cramer-von Mises-based test) for lowest AIC based best fit copula")
```

```{r ff_p_KS,echo=F,results="asis"}
table_nums("ff_p_KS",display=F)
knitr::kable(RES_aphid_ff$gfc_p_KS, caption = "Aphid_firstflight : p-values (Kolmogorov-Smirnov-based test) for lowest AIC based best fit copula")
```

`r table_nums("ff_bestcop",display="c")`  shows that several copulas are much better supported than the Gaussian copula, answering the first part of question 1 for these data.
The model-averaged (using AIC) lower-tail dependence statistic and the model-averaged (again, AIC based) upper-tail dependence statistic are presented in `r table_nums("ff_LTdep_AICw",display="c")` and `r table_nums("ff_UTdep_AICw",display="c")` respectively, and these values are distinct from what a Gaussian copula would give (i.e., 0), answering the second part of question 1 for these data. Furthermore, the difference of these two quantities (lower minus upper) in `r table_nums("ff_LTmUT",display="c")` indicates it is different from 0 for most of the locations, answering the third part of question 1. 

These results do convincingly show non-Gaussian copula structure, having **`r sum((RES_aphid_ff$LTdep_AICw-RES_aphid_ff$UTdep_AICw)<0,na.rm=T)`** out of **`r (dim(RES_aphid_ff$gfc_p_CvM)[1]^2-dim(RES_aphid_ff$gfc_p_CvM)[1])-RES_aphid_ff$num_indep_loc_pair`** location pair more upper tail dependence. Our fitting results are supported by the lowest-AIC copula *p*-value in the Cramer-von Mises-based test [`r table_nums("ff_p_CvM",display="c")`] of the goodness of its fit, and in the Kolmogorov-Smirnov-based test [`r table_nums("ff_p_KS",display="c")`] of the goodness of fit.

### Non-parametric analysis of tail dependence

```{r stat_aphid_ff, echo=F, cache=T, cache.extra=list(seed,data_aphid_ff)}
set.seed(seed)
resloc<-"./Results/stat_results/stat_aphid_ff/"

sp<-11
good_loc<-good_loclist(d_allsp=data_aphid_ff,sp=sp,data_pt_thrs=30)
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_ff<-multcall(d_allsp=data_aphid_ff,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc) 
saveRDS(stat_aphid_ff,paste(resloc,file="stat_aphid_ff_sp_11.RDS",sep='')) 
```

```{r read_stat_aphid_ff,echo=F}
stat_aphid_ff<-readRDS("./Results/stat_results/stat_aphid_ff/stat_aphid_ff_sp_11.RDS")
```

```{r ff_resamp,echo=F,results="asis"}
table_nums("ff_resamp",display=F)
knitr::kable(stat_aphid_ff$numericdf, caption = "Aphid_firstflight : resampling result for stat indicating upper tail dependence")
```

```{r ff_allcop,echo=F}
fig_nums("ff_allcop",display=F)
```
![copula plot for aphid-firstflight](./Results/stat_results/stat_aphid_ff/Sp_11_AllCops.pdf)

```{r ff_spear,echo=F}
fig_nums("ff_spear",display=F)
```
![Plot for aphid-firstflight : Spearman vs. Distance](./Results/stat_results/stat_aphid_ff/Sp_11_Spearman_vs_D.pdf){ width=50%, height=50% }

```{r ff_kend,echo=F}
fig_nums("ff_kend",display=F)
```
![Plot for aphid-firstflight : Kendall vs. Distance](./Results/stat_results/stat_aphid_ff/Sp_11_Kendall_vs_D.pdf){ width=50%, height=50% }

```{r ff_Corl-Coru,echo=F}
fig_nums("ff_Corl-Coru",display=F)
```
![Corl-Coru vs. Distance plot for aphid-firstflight showing upper tail dependence](./Results/stat_results/stat_aphid_ff/Sp_11_Corl-Coru_vs_D.pdf){ width=50%, height=50% }

```{r ff_Pl-Pu,echo=F}
fig_nums("ff_Pl-Pu",display=F)
```
![Pl-Pu vs. Distance plot for aphid-firstflight showing upper tail dependence](./Results/stat_results/stat_aphid_ff/Sp_11_Pl-Pu_vs_D.pdf){ width=50%, height=50% }

```{r ff_Tl-Tu,echo=F}
fig_nums("ff_Tl-Tu",display=F)
```
![Tl-Tu vs. Distance plot for aphid-firstflight showing upper tail dependence](./Results/stat_results/stat_aphid_ff/Sp_11_Tl-Tu_vs_D.pdf){ width=50%, height=50% }

```{r ff_D2u-D2l,echo=F}
fig_nums("ff_D2u-D2l",display=F)
```
![D2u-D2l vs. Distance plot for aphid-firstflight showing upper tail dependence](./Results/stat_results/stat_aphid_ff/Sp_11_D2u-D2l_vs_D.pdf){ width=50%, height=50% }

```{r ff_D2u/D2l,echo=F}
fig_nums("ff_D2u/D2l",display=F)
```
![D2u/D2l vs. Distance plot for aphid-firstflight showing upper tail dependence](./Results/stat_results/stat_aphid_ff/Sp_11_D2u_by_D2l_vs_D.pdf){ width=50%, height=50% }

## North sea plankton data

<!--Shya to edit the prentation below to make it more parallel to the presentation of the model selection results for C/N data above-->

### Model selection approach

```{r read_plankton_north_sea_data, echo=F}
d0_plankton_north_sea<-as.matrix(read.csv("./Data/Plankton_North_Sea_data/planktontimeseries201117_4.csv",header=F))
data_plankton_north_sea<-d_allsp_data_plankton_north_sea(d0_plankton_north_sea)
``` 

```{r RES_plankton_north_sea, echo=F, cache=T, cache.extra=list(seed,data_plankton_north_sea)}
set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_plankton_north_sea<-RES_single_sp(d_allsp=data_plankton_north_sea,sp=16,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=45)
#cat(paste("stop-time: ",Sys.time(),"\n"))    
resloc<-"./Results/fitting_results/"
saveRDS(RES_plankton_north_sea,paste(resloc,file="Plankton_North_Sea_CopulaFit_selecloc_species_16.RDS",sep=""))
```

```{r read_RES_plankton_north_sea,echo=F}
RES_plankton_north_sea<-readRDS("./Results/fitting_results/Plankton_North_Sea_CopulaFit_selecloc_species_16.RDS")
```

\newpage

```{r pns_bestcop,echo=F,results="asis"}
#library(pander)
#pander(best_cop_LTdep, caption = "Hello caption!")
# alternatively,
#pandoc.table(RES_plankton_north_sea$info_ord_AICw[,,1], caption="Plankton_north_sea : AICw for best fit copula family for each selective location pair")
#cat("\n\n\\pagebreak\n")

table_nums("pns_bestcop",display=F)
knitr::kable(RES_plankton_north_sea$info_ord_copname[,,1], caption = "Plankton_north_sea : Best fit copula family for each selective location pair")
```

```{r pns_AICw,echo=F,results="asis"}
table_nums("pns_AICw",display=F)
knitr::kable(round(RES_plankton_north_sea$info_ord_AICw[,,1],3), caption = "Plankton_north_sea : AICw for best fit copula family for each selective location pair")
```

\newpage

```{r pns_LTdep,echo=F,results="asis"}
#cat("\n\n\\pagebreak\n")

table_nums("pns_LTdep",display=F)
knitr::kable(round(RES_plankton_north_sea$info_ord_LTdep[,,1],3), caption = "Plankton_north_sea : Lower Tail dependence for best fit copula family for each selective location pair")
```

```{r pns_UTdep,echo=F,results="asis"}
table_nums("pns_UTdep",display=F)
knitr::kable(round(RES_plankton_north_sea$info_ord_UTdep[,,1],3), caption = "Plankton_north_sea : Upper Tail dependence for best fit copula family for each selective location pair")
```

\newpage

```{r pns_LTdep_AICw,echo=F,results="asis"}
#cat("\n\n\\pagebreak\n")

table_nums("pns_LTdep_AICw",display=F)
knitr::kable(round(RES_plankton_north_sea$LTdep_AICw,3), caption = "Plankton_north_sea : Lower Tail dependence statistic for best fit copula family for each selective location pair")
```

```{r pns_UTdep_AICw,echo=F,results="asis"}
table_nums("pns_UTdep_AICw",display=F)
knitr::kable(round(RES_plankton_north_sea$UTdep_AICw,3), caption = "Plankton_north_sea : Upper Tail dependence statistic for best fit copula family for each selective location pair")
```

\newpage

```{r pns_LTmUT,echo=F,results="asis"}
#cat("\n\n\\pagebreak\n")

table_nums("pns_LTmUT",display=F)
knitr::kable(round(RES_plankton_north_sea$LTdep_AICw-RES_plankton_north_sea$UTdep_AICw,3), caption = "Plankton_north_sea : Lower Tail - Upper Tail dependence statistic for best fit copula family for each of the selective location pair")
```

```{r pns_p_CvM,echo=F,results="asis"}
table_nums("pns_p_CvM",display=F)
knitr::kable(round(RES_plankton_north_sea$gfc_p_CvM,3), caption = "Plankton_north_sea : p-values (Cramer-von Mises-based test) for lowest AIC based best fit copula")
```

\newpage

```{r pns_p_KS,echo=F,results="asis"}
#cat("\n\n\\pagebreak\n")

table_nums("pns_p_KS",display=F)
knitr::kable(round(RES_plankton_north_sea$gfc_p_KS,3), caption = "Plankton_north_sea : p-values (Kolmogorov-Smirnov-based test) for lowest AIC based best fit copula")
```

`r table_nums("pns_bestcop",display="c")` shows that several copulas are much better supported than the Gaussian copula, answering the first part of question 1 for these data.
The model-averaged (using AIC) lower-tail dependence statistic and the model-averaged (again, AIC based) upper-tail dependence statistic are presented in   `r table_nums("pns_LTdep_AICw",display="c")` and `r table_nums("pns_UTdep_AICw",display="c")` respectively, and these values are distinct from what a Gaussian copula would give (i.e., 0), answering the second part of question 1 for these data. Furthermore, the difference of these two quantities (lower minus upper) in `r table_nums("pns_LTmUT",display="c")` indicates it is different from 0 for most of the locations, answering the third part of question 1. 

These results do convincingly show non-Gaussian copula structure, having `r sum((RES_plankton_north_sea$LTdep_AICw-RES_plankton_north_sea$UTdep_AICw)>0,na.rm=T)` out of `r (dim(RES_plankton_north_sea$gfc_p_CvM)[1]^2-dim(RES_plankton_north_sea$gfc_p_CvM)[1])-RES_plankton_north_sea$num_indep_loc_pair` location pair more lower tail dependence. Our fitting results are supported by the lowest-AIC copula *p*-value in the Cramer-von Mises-based test [`r table_nums("pns_p_CvM",display="c")`] of the goodness of its fit, and in the Kolmogorov-Smirnov-based test [`r table_nums("pns_p_KS",display="c")`] of the goodness of fit.

### Non-paramtric analysis of tail dependence
```{r stat_plankton_north_sea, echo=F, cache=T, cache.extra=list(seed,data_plankton_north_sea)}
set.seed(seed)
resloc<-"./Results/stat_results/stat_plankton_north_sea/"

sp<-16
good_loc<-good_loclist(d_allsp=data_plankton_north_sea,sp=sp,data_pt_thrs=45)
longs<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlongs201117.csv",header=F)
lats<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlats201117.csv",header=F)
longs<-longs[[1]] 
lats<-lats[[1]]

stat_plankton_north_sea<-multcall(d_allsp=data_plankton_north_sea,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc) 
saveRDS(stat_plankton_north_sea,paste(resloc,file="stat_plankton_north_sea_sp_16.RDS",sep=''))
```

```{r read_stat_plankton_north_sea,echo=F}
stat_plankton_north_sea<-readRDS("./Results/stat_results/stat_plankton_north_sea/stat_plankton_north_sea_sp_16.RDS")
```

```{r pns_resamp,echo=F,results="asis"}
table_nums("count_resamp",display=F)
knitr::kable(stat_plankton_north_sea$numericdf, caption = "Plankton_north_sea : resampling result for stat indicating lower tail dependence")
```

```{r pns_allcop,echo=F}
fig_nums("pns_allcop",display=F)
```
![copula plot for Plankton_north_sea](./Results/stat_results/stat_plankton_north_sea/Sp_16_AllCops.pdf)

```{r pns_spear,echo=F}
fig_nums("pns_spear",display=F)
```
![Plot for Plankton_north_sea : Spearman vs. Distance](./Results/stat_results/stat_plankton_north_sea/Sp_16_Spearman_vs_D.pdf){ width=50%, height=50% }

```{r pns_kend,echo=F}
fig_nums("pns_kend",display=F)
```
![Plot for Plankton_north_sea : Kendall vs. Distance](./Results/stat_results/stat_plankton_north_sea/Sp_16_Kendall_vs_D.pdf){ width=50%, height=50% }

```{r pns_Corl-Coru,echo=F}
fig_nums("pns_Corl-Coru",display=F)
```
![Corl-Coru vs. Distance plot for Plankton_north_sea showing lower tail dependence](./Results/stat_results/stat_plankton_north_sea/Sp_16_Corl-Coru_vs_D.pdf){ width=50%, height=50% }

```{r pns_Pl-Pu,echo=F}
fig_nums("pns_Pl-Pu",display=F)
```
![Pl-Pu vs. Distance plot for Plankton_north_sea showing lower tail dependence](./Results/stat_results/stat_plankton_north_sea/Sp_16_Pl-Pu_vs_D.pdf){ width=50%, height=50% }

```{r pns_Tl-Tu,echo=F}
fig_nums("pns_Tl-Tu",display=F)
```
![Tl-Tu vs. Distance plot for Plankton_north_sea showing lower tail dependence](./Results/stat_results/stat_plankton_north_sea/Sp_16_Tl-Tu_vs_D.pdf){ width=50%, height=50% }

```{r pns_D2u-D2l,echo=F}
fig_nums("pns_D2u-D2l",display=F)
```
![D2u-D2l vs. Distance plot for Plankton_north_sea showing lower tail dependence](./Results/stat_results/stat_plankton_north_sea/Sp_16_D2u-D2l_vs_D.pdf){ width=50%, height=50% }

```{r pns_D2u/D2l,echo=F}
fig_nums("pns_D2u/D2l",display=F)
```
![D2u/D2l vs. Distance plot for Plankton_north_sea showing lower tail dependence](./Results/stat_results/stat_plankton_north_sea/Sp_16_D2u_by_D2l_vs_D.pdf){ width=50%, height=50% }

# Question 2 analyses for each dataset

# Question 3 analyses for each dataset

Recall question 3 is: What are the consequences of non-Gaussian copula structure and tail dependence for our understanding of biology and for applications?

## Aphid count

<!--Shya to add results about skewness of spatial means-->

## Aphid first flight

<!--Shya to add results about skewness of spatial means-->

## North Sea plankton

<!--Shya to add results about skewness of spatial means-->

