---
title: "Exploring the importance of a complete statistical description of dependence in ecology and evolution"
author: "Shyamolina Ghosh and Daniel Reuman"
date: "February 8, 2018"
output: 
  html_document:
    fig_caption: yes
    fig_width: 5
    highlight: tango
    keep_tex: yes
    number_sections: yes
    df_print: kable # data frame printing option
fontsize: 11pt
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
seed<-101
families<-c(1,3:6,14)
source("getcopula.R")
source("OurBiCopSelect.R")
source("copsurrog2d.R")
source("SkewnessAnd3CentMom.R")
source("empcdfcloud.R")
```

<!--A function needed for caching-->
```{r echo=F}
mtime <- function(files)
{
  lapply(Sys.glob(files),function(x) X =   
          file.info(x)$mtime)
}
```

Updated on `r Sys.Date()`

# Template analysis

**About the dataset :**  
These data were simulated from a Clayton copula with parameter 8.

**Load and plot the raw data:**  
```{r load_data_test, echo=F}
#Load your data - should be a data frame with 2 columns. Can contain NAs.
d<-readRDS("Data/givendata.RDS")
plot(d[,1],d[,2],type="p",col="red",xlab=expression(d[1]),ylab=expression(d[2]),cex.lab=1,
     xlim=c(0,1),ylim=c(0,1),asp=1)
rect(0,0,1,1)
```

**Copula plot of the data:**  
```{r rankandplot_test, echo=F}
#convert to a copula and plot
v<-getcopula(d=d,rankon=F,ploton=T) #with real data, rankon should be T
```

**Bivariate copula model selection and goodness of fit pipeline:**  
```{r bivmodselect_test, echo=F, cache=T, cache.extra=list(seed,v,families,mtime("OurBiCopSelect.R"))}
set.seed(seed)
BivMS_res_test<-OurBiCopSelect(v[,1],v[,2],families=families,gofnormal=FALSE,status=TRUE)
```

```{r}
BivMS_res_test
```

**Surrogate datasets and tail dependence pipeline:**
<!--Use normal-copula surrogates, calculate upper and lower tail dependence stats for
real data and for the surrogates, and compare in the usual way. Also for the difference
of the two stats (to measure asymmetry of tail dependence). Have to decide what tail 
dependence stat to use.-->

**Surrogate datasets and an "outcome" function:**
You first choose an "outcome function" that takes as input the two variables of your 
data and gives as output some third thing of interest. For instance, if the two columns
are soil C and N, the outcome function might be expected soil respiration. Obviously
you have to have a context and know some science about that context to write a function
that makes sense. For testing the workflow, we just use the sum:

```{r}
ocf_test<-function(d)
{
  return(d[,1]+d[,2])
}
```

Once you have such a function, you can compare the distribution of values of this
function for your real data to what it would be if copula were the normal copula
instead, but other statistical aspects are the same. We compare empirical cdfs in
two ways:

```{r outcomefunc_test, echo=F, cache=T, cache.extra=list(seed,d,mtime("copsurrog2d.R"),mtime("empcdfcloud.R"))}
#get rid of NAs
inds<-which(is.finite(d[,1]) & is.finite(d[,2]))
d<-d[inds,]

#normalize the data - won't do this with real data
d<-qnorm(d)

#get surrogate data
cop<-normalCopula(.5,2)
dsur<-copsurrog2d(m=d,targetcop=cop,numsurrog=1000)

#compute the outcome function on d and dsur
ocfd<-ocf_test(d)
ocfsur<-apply(FUN=ocf_test,MARGIN=3,X=dsur)
ecdfc_test<-empcdfcloud(ocfd,ocfsur,prob=c(0.005,.5,.995))
```

We can compare skewness of the outcome function to what you 
would get if the copula were normal:

```{r echo=F}
realskew<-myskns(ocfd)
surskew<-apply(FUN=myskns,MARGIN=2,X=ocfsur)
sum(surskew>realskew)/length(surskew)
hist(surskew,50)
points(realskew,0,col='red')
realskew
```

# Results from dataset1 : T. Loecke

**About the dataset :**  
Carbon and nitrogen in soil at many locations across CONUS (Terry to augment this description).

**Plot the raw data:**  
```{r load_data_Loecke, echo=F}
#Load your data - should be a data frame with 2 columns. Can contain NAs.
d<-readRDS("Data/RaCA_soilorganicC_soiltotalN_stocks100cm.RDS")
d<-d[,c("SOCstock100","TSNstock100")]
plot(d[,1],d[,2],type="p",col="red",xlab="Soil C",ylab="Soil N",cex.lab=1)
rect(0,0,1,1)
```

**Copula plot of the data:**  
```{r rankandplot_Loecke, echo=F}
#convert to a copula and plot
v<-getcopula(d=d,rankon=T,ploton=T) #with real data, rankon should be T
```

**Bivariate copula model selection and goodness of fit pipeline:**  
```{r bivmodselect_Loecke, echo=F, cache=T, cache.extra=list(seed,v)}
set.seed(seed)
families_Loecke<-c(1,3:10,13:14,16:20,104,114,204,214)
BivMS_res_Loecke<-OurBiCopSelect(v[,1],v[,2],families=families_Loecke,
                                 gofnormal=FALSE,status=TRUE)
```

```{r}
BivMS_res_Loecke
```

None of the copulas we tried here was a good fit, but some are much 
better than others, and the normal copula is not close to the best. 
So that shows there is non-trivial (i.e., non-normal) copula structure, which is an interesting conclusion. It is more interesting than it would have been to specifically identify a copula that fits, so I am not too concered about our failure to do that.

It looks like the data might be asymmetric about the y=x line, which
might require a special copula to model. What is the significance of this,
biologically?

**Surrogate datasets and tail dependence pipeline:**
<!--Use normal-copula surrogates, calculate upper and lower tail dependence stats for
real data and for the surrogates, and compare in the usual way. Also for the difference
of the two stats (to measure asymmetry of tail dependence). Have to decide what tail 
dependence stat to use.-->

Strong dependence in the extreme right tails is evident. We should
quantify this, and (probably) show it is significantly more than what one would expect from a null hypothesis of a normal copula with the same kendall as the data. What is the significance, biologically? We could (probably) also show there is much more asymmetry of tail dependence (upper v. lower) than would be expected from a normal-copula null hypothesis. First do the parallel analysis for the test data, indicated but not completed above.

**Surrogate datasets and an "outcome" function:**

You first choose an "outcome function" that takes as input the two variables of your 
data and gives as output some third thing of interest. This is a place holder now, 
have asked for a real function from Terry and Amy. May be more than one for different
ecosystem processes.
```{r}
ocf_Loecke<-function(d)
{
  C<-d[,1]
  N<-d[,2]
  return(C+N)
}
```

Once you have such a function, you can compare the distribution of values of this
function for your real data to what it would be if copula were the normal copula
instead, but other statistical aspects are the same. We compare empirical cdfs in two ways:

```{r outcomefunc_Loecke, echo=F, cache=T, cache.extra=list(seed,d,mtime("copsurrog2d.R"),mtime("empcdfcloud.R"))}
#get rid of NAs
inds<-which(is.finite(d[,1]) & is.finite(d[,2]))
d<-d[inds,]

#get surrogate data
cop<-normalCopula(.5,2)
dsur<-copsurrog2d(m=d,targetcop=cop,numsurrog=1000)

#compute the outcome function on d and dsur
ocfd<-ocf_Loecke(d)
ocfsur<-apply(FUN=ocf_Loecke,MARGIN=3,X=dsur)
ecdfc_Loecke<-empcdfcloud(ocfd,ocfsur,prob=c(.005,.5,.995))
```

We can compare skewness of the outcome function to what you 
would get if the copula were normal:

```{r echo=F}
realskew<-myskns(ocfd)
surskew<-apply(FUN=myskns,MARGIN=2,X=ocfsur)
sum(surskew>realskew)/length(surskew)
hist(surskew,50)
points(realskew,0,col='red')
realskew
```

We can compare skewness of the outcome function to what you 
would get if the copula were Clayton:

```{r echo=F}
#get surrogate data
cop<-claytonCopula(5,2)
dsur<-copsurrog2d(m=d,targetcop=cop,numsurrog=1000)

#compute the outcome function on d and dsur
ocfd<-ocf_Loecke(d)
ocfsur<-apply(FUN=ocf_Loecke,MARGIN=3,X=dsur)

realskew<-myskns(ocfd)
surskew<-apply(FUN=myskns,MARGIN=2,X=ocfsur)
sum(surskew>realskew)/length(surskew)
hist(surskew,50)
points(realskew,0,col='red')
realskew
```

We can compare skewness of the outcome function to what you 
would get if the copula were Joe:

```{r echo=F}
#get surrogate data
cop<-joeCopula(5,2)
dsur<-copsurrog2d(m=d,targetcop=cop,numsurrog=1000)

#compute the outcome function on d and dsur
ocfd<-ocf_Loecke(d)
ocfsur<-apply(FUN=ocf_Loecke,MARGIN=3,X=dsur)

realskew<-myskns(ocfd)
surskew<-apply(FUN=myskns,MARGIN=2,X=ocfsur)
sum(surskew>realskew)/length(surskew)
hist(surskew,50)
points(realskew,0,col='red')
realskew
```