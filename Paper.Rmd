---
title: "The importance of a complete statistical description of dependence between variables for ecology and related fields"
author: "Shyamolina Ghosh, Mark T. Holder, Terrance E. Loecke, Daniel C. Reuman"
date: "February 18, 2018"
geometry: "left=1cm,right=1cm,top=2.5cm,bottom=2.8cm"

output: 
  pdf_document:
    number_sections: no
    keep_tex: yes
    fig_caption: yes
    includes:
      in_header: head_maintext.sty
      
tables: True
link-citations: True
urlcolor : blue

csl: ecology-letters.csl
bibliography: REF_ALL.bib
---

<!--**DAN: right now we sometimes use the terminology "normal copula" and sometimes 
"Gaussin copula". Let's choose one and be consistent across the whole ms, including 
main text and supp mat. I am leaning toward "Gaussin copula" but could be convinced 
otherwise, it is just the consistency that I want to be sure we get to.-->

<!--**SG: I think normal copula would be better as "N" is the abbreviation for that but for "G" means gumbel not gaussian.
I made all "Gaussian" as "Normal" copula in both main and supmat.-->

updated on `r Sys.Date()`

```{r setup_Paper, echo=F}
knitr::opts_chunk$set(echo = TRUE, fig.pos = "H")
options(scipen = 1, digits = 5) #This option round all numbers appeared in the inline r code upto 5th digit
#seed<-101
#source("mtime.R") #A function needed for caching
```

# Front matter

*Affiliations:*

Ghosh: Department of Ecology and Evolutionary Biology and Kansas Biological Survey, University of Kansas, Lawrence, KS, 66045, USA

Holder: Department of Ecology and Evolutionary Biology and Biodiversity Institute, University of Kansas, Lawrence, KS, 66045, USA

Loecke: Environmental Studies Program and Kansas Biological Survey, University of Kansas, Lawrence, KS, 66047, USA

Reuman: Department of Ecology and Evolutionary Biology and Kansas Biological Survey, University of Kansas, Lawrence, KS, 66047, USA; Laboratory of Populations, Rockefeller University, 1230 York Ave, New York, NY, 10065, USA. 

*Possible alternative titles:*

- A complete statistical description of dependence between variables for ecology and related fields

*Keywords:*

*Type of Article*

- Ideas and Perspectives

*The number of words in the abstract*

*The number of words in the main text (excluding abstract, acknowledgements, references, table and figure legends)* 

*The number of words in each text box*

*The number of references*

*The number of figures, tables, and text boxes*

*The name and complete mailing address (including telephone and fax numbers and e-mail address) of the person to whom correspondence should be sent* 

\newpage
# Abstract

\newpage
# Introduction

Identifying and quantifying dependencies is the core of modelling in many applications, frequently found in the
finance and risk management. For many years, measuring and modeling dependencies has focused on the
Pearson correlation because of its ease in use. But correlation can provide little information about the underlying dependence structure in the case of asymmetric dependence because it is a measure of linear association between two random variables. Therefore, it is better to use rank-based correlation measures such as Kendall’s tau and Spearman’s rho instead of Pearson correlation. However, using copula-based approach as a dependence measure reflects more knowledge about the dependence structure instead of summarizing in just a single number. The flexibility of copulas allows us to model more complex dependence structures by isolating its marginal from its joint distribution structures, with the capability in modeling a rich variety of tail behavior, such as tail dependence versus tail independence, and reflection symmetry versus reflection asymmetry. Tail dependence occurs when the correlation between two variables increases as we get "further" in the tail (either or both) of the distribution. For example, in the upper panel of Fig. \ref{fig_cop_pedag}, different dependence structures, with same Kendall correlation $\tau = 0.5$, were shown which became dominantly lower tail dependent (lower tail - upper tail dependence being positive) from dominantly upper tail dependent (lower tail - upper tail dependence being negative) as we moved along the row. Lower panel represents the similar scenario but with stronger correlation (Kendall's $\tau = 0.8$). To implement this, we need to select candidate bivariate copulas from many existing parametric copula families. A very flexible bivariate copula can itself become a welcome candidate in the pool of bivariate copulas to be selected from. Here, throughout our studies for different datasets we used a universal pool of 16 bivariate copula families (having exclusively lower, exclusively upper, both or neither tail dependence), mentioned in the \nameref{Methods}. 

Though a few examples have been found which shows copula approach to model dependencies in bioinformatics [@Kim2008], medical research [@Emura2016] or a short period study of intersite dependence of rainfall data [@Serinaldi2008], the multivariate copula approach still, we believe, remains unexplored in ecology or related field and thus have potential scope to better capture the evolution of ecological time series data. So, in ecological perspective, when we find a dominantly lower (upper) tail dependence structure, it means both variable are rare synchronously. If any one of them be environmental variable and the other is an observable (like abundance of a species) then it can also explain the causal relationship between them. Here, we analyzed the dependence structure for several bivariate and multivariate ecological, community and biogeochemical datasets. In addition to a copula based \nameref{Model_selection}, we also carried out a \nameref{NPA} with three different statistics to verify our model selection based results. 

Basically, we want to address the following questions. 1) Do datasets in ecology and related fields have non-Normal copula srtructure? Do they show tail dependence distinct from that of a Normal copula, and in particular do they show asymmetric tail dependence? 2) If so, what are some possible causes of non-Normal copula structure? And 3) what are the consequences of non-Normal copula structure and tail dependence for our understanding of biology and for applications? 
In \nameref{Material&Methods}, we described briefly about each datasets we used to answer these questions and provided a detailed descriptions of implemented methods. In the \nameref{Results} section, we summarized our finidings for each datasets. Next two sections are focused on possible causes and consequences of our analysis. Finally, we concluded in the \nameref{Discussion} section. 

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm,height=8 cm]{./Results/copula_pedagog_fig_BB1.pdf}
\caption{Pedagogical figure showing BB1 copula with varying tail-dep difference but of same Kendall's tau along each row and with same tail-dep difference but of different Kendall's tau along each column.\label{fig_cop_pedag}}
\end{center}
\end{figure}

# Material and methods \label{Material&Methods}

## Datasets
<!-- each dataset's description is in suppmat file-->

## Statistical methods for detecting copula structure \label{Methods}

Question 1 from the Introduction was answered via statistical analysis of the
data described above, using both model selection and nonparametric approaches.

### Model selection approach \label{Model_selection}

A model-selection approach based on likelihood and the Akaike Information Criterion (AIC) 
and Bayesian Information Criterion (BIC) was used to
help answer question 1 from the Introduction. 

For bivariate datasets 
$(x_i,y_i)$ for $i=1,...,n$ such as the soil C and N data, model selection involved several steps, 
most implemented using tools from the `VineCopula` package. Code combining these tools is in the
[`OurBiCopSelect`](https://github.com/sghosh89/BIVAN/blob/master/OurBiCopSelect.R) function and its dependencies in the [`BIVAN`](https://github.com/sghosh89/BIVAN) repository. 

First, we produced ranks 
$(\tilde{u}_i,\tilde{v}_i)$ where $\tilde{u}_i$ is the rank of $x_i$ in the set 
$\{x_i:i=1,...,n\}$ and $\tilde{v}_i$ is the rank of $y_i$ in the set $\{y_i:i=1,...,n\}$ and 
we set $u_i=\tilde{u}_i/(n+1)$ and $v_i=\tilde{v}_i/(n+1)$; further work was with the $u_i$ 
and $v_i$. Ranks $\tilde{u}_i$ and $\tilde{v}_i$ were $1$, for the 
smallest element, up to $n$, for the largest. 

Second, we did a test of the independence of the $u_i$ and $v_i$. Subsequent model 
selection algorithms are ineffective if data could not be distinguished from independent data 
since most or all bivariate copula families considered include the independent copula in the 
family or as a boundary case. The independence test was as implemented in the `BiCopIndTest`
function in `VineCopula`, the documentation of which reports the test uses the asymptotic normality of the statistic $|\tau|\sqrt{\frac{9n(n-1)}{2(2n+5)}}$, where $\tau$ is Kendall's tau statistic. If independence could be rejected ($0.05$ significance level), model selection proceeded.

The third step of model selection was to fit multiple bivariate copula families to the ranked data $(u_i,v_i)$ via maximum likelihood, using the `BiCopEst` function in `VineCopula`. Families considered (with abbreviations and numeric codes here indicated) included the **N**ormal/Gaussian {1}, **C**layton {3}, **G**umbel {4}, **F**rank {5}, **J**oe {6}, **BB1** {7}, **BB6** {8}, **BB7** {9}, **BB8** {10}, **S**urvival **C**layton {13}, **S**urvival **G**umbel {14}, **S**urvival **J**oe {16}, **S**urvival **BB1** {17}, **S**urvival **BB6** {18}, **S**urvival **BB7** {19} and **S**urvival **BB8** {20} copulas.
AIC and BIC values and accompanying model weights ($\text{AIC}_{\text{w}}$, $\text{BIC}_{\text{w}}$) were generated using standard formulas [@burnham2003_modelselection]. 
Descriptions of these copula families can be found in introductory texts on copulas [@nelsen2007_copula ; @joe2014_dependence]  and in `VineCopula` documentation. 
The lower- and upper-tail dependence of the 
best-fitting member of each family was also provided by `BiCopEst`.

Model selection methods will give the *relative* support of several models, but will not,
on their own, indicate whether any of the models selected is an objectively good fit (all 
models considered might poorly describe the data). To test this, and as the fourth step of
our procedure, we tested the goodness of fit of our best-AIC copula family using a 
bootstrapping procedure implemented in `BiCopGofTest` of `VineCopula`. The method performed 
two tests, one based on a Cramer-von Mises statistic, and one based on a 
Kolmogorov-Smirnov statistic. For computational efficiency, 
an initial run using $100$ bootstraps was performed, and if
the $p$-value resulting from either test was less than $0.2$, tests were re-run with 
$1000$ boostraps.

Finally, $\text{AIC}_{\text{w}}$ values for all fitted models were used to get
model-averaged lower- and upper-tail dependence values using standard model averaging 
formulas [@burnham2003_modelselection]; likewise for BIC.

The first part or question 1 from the Introduction was answered for a bivariate dataset 
$(x_i,y_i)$ for $i=1,...,n$ by comparing the AIC weights of the non-Normal copula
families with that of the Normal family. The same was also done using BIC.
The second part of question 1 was answered by comparing 
the model-averaged lower- and upper-tail dependence
values to the lower- and upper-tail dependence values of a Normal copula, both of which 
are 0. The third part of question 1
was answered by comparing the difference of the model-averaged lower- and upper-tail 
dependence values to the analogous difference for a Normal copula, again 0.

For multivariate datasets, e.g., the aphid abundance or first flight data, 
each of which consists of time series from 10 locations, we carried out the same bivariate analysis
for all possible pairwise combinations of those locations and compared AIC-weights and tail-dependence of best-fit(minimum AIC) copula with that of the Normal copula. We also counted for how many location pairs model -averaged lower tail dependence is greater than model-averaged upper-tail dependence or vice-versa. For example, for green-spruce aphid abundance data we found major lower tail dependence whereas leaf-curling plum aphid's first flight data had significant upper tail dependence at all location pairs (for details see Table \ref{tab_multivar_summary}).
<!--***DAN: need to fill this in, prrobably enough to be brief, since these were just done 
pairwise-->
<!--**SG: done-->

### Nonparametric analysis of tail dependence \label{NPA}

In addition to the model selection approach described above, nonparametric 
approaches were also used to answer question 1 from the introduction.
Using two distinct methods, when results are consistent, provides greater confidence 
that results are robust. 

Left- and right-tail dependence quantify the extent to which two ranked
variables $u_i$, $v_i$ for $i=1,...,n$ 
(see \nameref{Model_selection} for defintions of $u_i$ and $v_i$)
are related to each other in the left and right tails, respectively, of their 
distributions [@nelsen2007_copula, @joe2014_dependence]. 
Our nonparametric study of tail dependence uses three
statistics which can quantify the extent to which $u_i$ and $v_i$ are 
related in any part of their distributions. We here describe the 
statistics. The statistics were formulated with positively associated
variables in mind. All the variables we study are positively associated
when they are significantly associated. So definitions and associated 
diagrams will assume positive associations, though generalizations are 
possible. Given two bounds 
$0 \leq l_b < u_b \leq 1$, we define the parallel lines $u+v=2l_b$ and 
$u+v=2u_b$ which intersect the unit square in which the $u_i$ and $v_i$ 
fall (these are the blue and red lines, respectively, in 
Fig. \ref{fig_stat_image}). Our statistics quantify the dependence
between $u_i$ and $v_i$ in the region bounded by these lines.
Using $l_b=0$ and some value $u_b\leq 0.5$ can give information about 
dependence in the left parts of the distributions of $u$ and $v$, and 
using $u_b=1$ and $l_b \geq 0.5$ can give information about dependence in 
the right parts of the distributions. 

\begin{figure}[!h]
\begin{center}
\includegraphics[width=6 cm,height=6 cm]{./stat_image.jpg} \hspace{0.6 cm}
\caption{Schematic diagram supporting defintions of nonparametric tail dependence statistics \label{fig_stat_image}}
\end{center}
\end{figure}

<!--
\begin{figure}[!h]
\textbf{ \hspace{6 cm} (A) \hspace{5.6 cm} (B)} \\
\vspace{-0.6 cm}
\begin{center}
\hspace{0.5 cm}
\includegraphics[width=5 cm,height=4.3 cm]{./stat_image.jpg} \hspace{0.6 cm}
\includegraphics[width=6 cm]{./Results/stat_results/stat_testing/CorlmCoru_C.pdf}
\end{center}
\textbf{ \hspace{6 cm} (C) \hspace{5.7 cm} (D)} \\
\vspace{-0.6 cm}
\begin{center}
\hspace{0.2 cm}
\includegraphics[width=6 cm]{./Results/stat_results/stat_testing/PlmPu_C.pdf} \hspace{0.3 cm}
\includegraphics[width=6 cm]{./Results/stat_results/stat_testing/D2umD2l_C.pdf}
\caption{(A) Schematic diagram supporting defintions of nonparametric tail dependence statistics; (B) Results of tests of $\cor_l-\cor_u$, (C) $\Ps_l-\Ps_u$, and (D) $\Dsq_u-\Dsq_l$ reveal the known asymmetry (more lower tail than upper) of tail dependence of the Clayton copula with $n=35$ data points. \label{fig_stat_image}}
\end{center}
\end{figure}
-->

The first quantity, $\cor_{l_b,u_b}(u,v)$, is the portion of the Spearman 
correlation of $u_i$ and $v_i$ that is attributable to the points 
lying in the region given by the bounds $u+v=2l_b$ and $u+v=2u_b$, i.e.,
\begin{equation}\label{eq.Cor}
   \cor_{l_b,u_b}(u,v) = \frac{1}{(n-1)\sqrt{\var(u)\var(v)}}\sum 
   (u_i-\mean(u)) (v_i-\mean(v)),
\end{equation}
where means and variances are computed using all $n$ data 
points, but the
sum is over only the indices $i$ for which $u_i+v_i > 2l_b$ and 
$u_i+v_i < 2u_b$. 
Larger values of $\cor_{l_b,u_b}$ indicate stronger positive association
between $u$ and $v$ in the region given by the bounds.

We also defined a statistic $\Ps_{l_b,u_b}$, using the same bounds
$u+v=2l_b$ and $u+v=2u_b$, as follows. For a distance $h$, we defined
$S(h)$ to be the number of points $(u_i,v_i)$ within the bounds 
and a distance less than $h$ from the line $v=u$, divided by the 
total number of points within the bounds. This function is
defined for $h$ going from $0$ to a distance $h_{\text{max}}$ which
is half the longer of the two segments obtained by intersecting the
bounds with the unit square. It is easy to see $S(0)=0$ and 
$S(h_{\text{max}})=1$. We defined $S_i(h)$, for the same range 
of $h$, to be the area within the bounds and the unit square
and within distance $h$ of the line $v=u$, divided by the area
within the bounds and the unit square. This is the expected value of
$S(h)$ for independent data. We then defined
\begin{equation}\label{eq.P}
   P_{l_b,u_b} = \int_0^{h_{max}} ( S(h) - S_i(h) ) dh.
\end{equation}
As for $\cor_{l_b,u_b}$, larger values of $\Ps_{l_b,u_b}$ 
indicate stronger positive association
between $u$ and $v$ in the region given by the bounds.

The third statistic, $\Dsq_{l_b,u_b}(u,v)$, is the average squared 
distance between points satisfying $u_i+v_i>2l_b$ and 
$u_i+v_i<2u_b$ and the line $v=u$. Unlike $\cor_{l_b,u_b}$ and 
$\Ps_{l_b,u_b}$, which are large when points satisfying $u_i+v_i>2l_b$ and 
$u_i+v_i<2u_b$ cluster close to the line $v=u$, $\Dsq_{l_b,u_b}$ is 
then small. 
Thus large values of $\cor_{l_b,u_b}$ and $\Ps_{l_b,u_b}$ indicate strong 
dependence in the portions of the distributions of $u$ and $v$ given by 
the bounds $u_i+v_i>2l_b$ and $u_i+v_i<2u_b$, whereas small values of 
$\Dsq_{l_b,u_b}$ indicate strong dependence. 

For large datasets (i.e., datasets with large $n$),
we can consider $l_b$ and $u_b$ close together without incurring undue
sampling variation in our statistics, and we can consider 
several different bands $(l_b,u_b)$ to understand how dependence
varies in different parts of the distributions. But for datasets with 
smaller $n$ we considered only $l_b=0$, $u_b=0.5$ and $l_b=0.5$, $u_b=1$.
We use the shorthand $\cor_l=\cor_{0,0.5}$ ($l$ is for "lower") 
and $\cor_u=\cor_{0.5,1}$ ($u$ is for "upper"); likewise $\Ps_l=\Ps_{0,.5}$,
$\Ps_u=\Ps_{0.5,1}$, $\Dsq_l=\Dsq_{0,0.5}$, and $\Dsq_u=\Dsq_{0.5,1}$.

The difference $\cor_l-\cor_u$ is expected to be positive if 
dependence in the left halves of the distributions is stronger 
than dependence in their right halves; likewise for $\Ps_l-\Ps_u$.
This holds, for instance, for the Clayton copula [@nelsen2007_copula].
The difference $\Dsq_u-\Dsq_l$, in which the "upper" and
"lower" statistics occur in opposite order, is also expected to be 
positive under the same conditions. We use these three differences
to detect asymmetry of tail dependence. Likewise, for large datasets,
we consider $\cor_{l_b,u_b}-\cor_{1-u_b,1-l_b}$, 
$\Ps_{l_b,u_b}-\Ps_{1-u_b,1-l_b}$ and
$\Dsq_{1-u_b,1-l_b}-\Dsq_{l_b,u_b}$ with $l_b=0$ and $u_b$ close to $0$.

<!--I deleted the phrase about unit testing because unit testing should be mentioned in the supp mat-->
We tested our statistics by testing whether $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$ revealed the asymmetry of tail dependence known to be present in data simulated from various copulas (for details see Appendix \ref{SM-Test_npa_stat}). 
<!--***DAN: There is either too little or too much here in this 
paragraph. The reader cannot get the main
idea, really, of what was done for these tests, from this paragraph alone - they will have to
look at the appendix. They need to be able to get the main idea. So you could either add detail,
or else take away detail and just say something like "We tested our statistics by testing whether 
$\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$ revealed asymmetry of tail dependence 
known to be present in data simulated from various copulas (Appendix X)" and then stop there.
Then you would remove panels B-D from Fig. 1. At the moment I prefer this second option, but 
my preference is not strong, so if you prefer to keep the material and add detail that would be 
fine.-->
<!--**SG: Agreed with 2nd option and did things as necessary-->

For bivariate datasets, we compared values 
of the statistics $\cor_{l_b,u_b}$,
$\Ps_{l_b,u_b}$, $\Dsq_{l_b,u_b}$, $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$ to 
distributions of values of the same statistics computed on surrogate datasets that were produced from 
the empirical data by randomizing it in a special way. The surrogate/randomized datasets had exactly 
the same marginal distributions as the empirical data and had very similar Kendall or Spearman 
correlation (the algorithm had two versions, one for preserving each correlation coefficient), 
but had Normal copula structure. Thus our comparisons tested the null hypothesis 
that our statistics took values on the empirical data no different from what would have been expected 
if the copula structure of the data were Normal, but the data were otherwise 
statistically unchanged.
Details of how surrogates were prroduced are in Appendix \ref{SM-surrog_test}, and code is in [`copsurrog2d`](https://github.com/sghosh89/BIVAN/blob/master/copsurrog2d.R).
<!--***DAN: I think the below material belongs in supp mat, because the reader can get the
main idea via the above text, and only some readers will be interested in the detailed 
algorithm. Please move it there, and then make the above links XYZ and ABC into live links
to the appropriate locations in the sup mat.

For bivariate datasets, surrogates were produced as follows.   

- Given data $(x_i,y_i)$ for $i=1,\ldots,n$ and a 
one-parameter target copula family $\mathcal{B}(\theta)$ (here $\theta$ denotes the parameter), let $\tau$ be the
Kendall correlation of the $x_i$ with the $y_i$ and find the parameter value $\theta_\tau$ for which 
$\mathcal{B}(\theta_\tau)$ has Kendall correlation $\tau$ (this is possible for the one-parameter copula families of this 
study using the `iTau` function of the `VineCopula` package). 
- Generate data $(a_i,b_i)$, $i=1,\ldots,n$ from 
$\mathcal{B}(\theta_\tau)$. 
- Permute the ordered set $(x_1,\ldots,x_n)$ such that the permutation
$(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$ has $\rank(x_{\sigma_x(i)})$ equal to $\rank(a_i)$ for all $i$, where 
$\rank(x_{\sigma_x(i)})$ is the rank of $x_{\sigma_x(i)}$ in the set $(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$, and
$\rank(a_i)$ is the rank of $a_i$ in the set $(a_1,\ldots,a_n)$ (here $\sigma_x$ is a permutation of the 
indices $1,\ldots,n$). 
- Likewise permute $(y_1,\ldots,y_n)$
such that the permutation
$(y_{\sigma_y(1)},\ldots,y_{\sigma_y(n)})$ has $\rank(y_{\sigma_y(i)})$ equal to $\rank(b_i)$ for all $i$ ($\sigma_y$ is 
another permutation of $1,\ldots,n$).
- The surrogate dataset is $(x_{\sigma_x(i)},y_{\sigma_y(i)})$ for $i=1,\ldots,n$. 

Our code for this algorithm is [`copsurrog2d`](https://github.com/sghosh89/BIVAN/blob/master/copsurrog2d.R) in the 
[`BIVAN`](https://github.com/sghosh89/BIVAN) repository. 

Because $(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$ 
is a permutation of $(x_1,\ldots,x_n)$ and $(y_{\sigma_y(1)},\ldots,y_{\sigma_y(n)})$ is a 
permutation 
of $(y_1,\ldots,y_n)$, the marginal distributions of the surrogate data are exactly the same as 
those of the original data. 
Because ranks of the surrogate data are matched to ranks of the $a_i$ and $b_i$, the
Kendall correlation of the surrogate dataset will be the same as that of the $a_i$ and $b_i$, and therefore 
will be close to $\tau$ (differences arising only through sampling variation). If instead of $\theta_\tau$
a parameter value $\theta_\rho$ is used such that the Spearman correlation of $\mathcal{B}(\theta_\rho)$ is the same
as that of the $x_i$ with the $y_i$, then Spearman correlations of surrogates will very nearly equal (except for 
sampling variation) the Spearman correlation of the empirical data.  
-->
<!--**SG: Done-->

The comparison of one of the
statistics $\cor_{l_b,u_b}$, $\Ps_{l_b,u_b}$, $\Dsq_{l_b,u_b}$, as computed on the 
empirical data, to the distribution
of its values computed on many surrogate datasets 
provides a test of whether dependence in the part of the distribution specified 
by $l_b$ and $u_b$ is different from
what would be expected from a null hypothesis of normal copula structure but 
unchanged marginals and unchanged 
Kendall (or Spearman)
correlation. Thus the comparison helps answer the first two parts of question 1 
from the Introduction for bivariate datasets. 
Significant deviations correspond to deviations from normal 
copula structure. In particular, deviations 
using $l_b=0$ and $u_b$ small (say, $0.1$) correspond to lower tail dependence 
different from that of a normal copula;
likewise, using $l_b=0.9$ and $u_b=1$ tests for upper tail dependence different 
from that of a normal copula.  

The comparison of one of the statistics $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, $\Dsq_u-\Dsq_l$, 
as computed on the 
empirical data, to the distribution
of its values on many surrogate datasets 
provides a test of asymmetry of tail dependence. Thus this comparison helps answer the
third part of question 1 from the Introduction for bivariate datasets.

For multivariate datasets, a spatial resampling scheme was used instead of the surrogate 
approach described above.
The scheme is identical to that proposed by @bjornstadfalck2001 for application in their now 
widely used spline correlogram method; the same scheme was also used by @walteretal2017 
as part of a method for 
performing model selection among matrix regression models. For each pair of 
locations $i \neq j$, the statistic
of interest, here denoted $s_{ij}$ ($\cor_{l_b,u_b}$, $\Ps_{l_b,u_b}$, 
$\Dsq_{l_b,u_b}$, $\cor_l-\cor_u$, 
$\Ps_l-\Ps_u$, or $\Dsq_u-\Dsq_l$) was computed for those locations. The 
values $s_{ij}$ were then arranged in
a matrix, $S$, with diagonal entries NA. The mean of the non-NA entries of $S$ was computed. For 
$\cor_{l_b,u_b}$, $\Ps_{l_b,u_b}$, or $\Dsq_{l_b,u_b}$ this mean characterized the 
average strength of 
dependence, across all pairs of distinct locations, for data in the portion of the distributions 
given by $l_b$ and $u_b$. For $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, or $\Dsq_u-\Dsq_l$, the mean characterized average
asymmetry of tail dependence across all pairs of locations. 
Confidence intervals for the values of $\mean(S)$ were then computed as quantiles of a 
distribution of bootstrapped values. If $\mean(S)$ was significantly different from 0, as
revealed by these confidence intervals, for the statistics $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, 
or $\Dsq_u-\Dsq_l$, then tail dependence was significantly asymmetric, in contrast to a 
Normal null hypothesis, and answering question 1 from the Introduction.
Bootstrapping was performed by resampling the locations of measurement, with replacement. 
This corresponds to 
resampling, with replacement, the rows and columns of $S$, and is described in detail elsewhere 
[@bjornstadfalck2001 ; @walteretal2017]. 

<!--Theoretical models
Question 2 from the Introduction was explored using simple population models.-->

\begin{figure}[!h]
\textbf{ \hspace{3.2 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.2 cm} (D) } \\
\vspace{-0.35 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/SoilCNraw.pdf}
\includegraphics[width=4 cm]{./Results/BMR_results/rawdataplot_lnBMR_vs_lnmass.pdf}
\includegraphics[width=4 cm]{./Results/Anolis_results/contrasts_csv_results/rawdataplot_AVG_ltoe_humerus.pdf}
\includegraphics[width=4 cm]{./Results/Ceder_creek_results/raw_HB_2000.pdf}\\
\end{center}
\textbf{ \hspace{3.2 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.2 cm} (H) } \\
\vspace{-0.35 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/SoilCNcop.pdf}
\includegraphics[width=4 cm]{./Results/BMR_results/copula_lnBMR_vs_lnmass.pdf}
\includegraphics[width=4 cm]{./Results/Anolis_results/contrasts_csv_results/copula_AVG_ltoe_humerus.pdf}
\includegraphics[width=4 cm]{./Results/Ceder_creek_results/cop_HB_2000.pdf}
\caption{Upper panel shows raw data plots for \textbf{(A)} soil C and N data, \textbf{(B)} ln(BMR) of contrasts vs. ln(mass) of contrasts, \textbf{(C)} contrasts for AVG.ltoe.IV vs. contrasts for AVG.humerus phylogenetic traits. \textbf{(D)} above-ground plant biomass data vs. Shannon's index (H) averaged over 9m by 9m plots for year 2000 of Ceder-creek experiment.
Lower panel \textbf{(E - H)} shows copula plots for the corresponding datasets of the upper panel. These copula plots are obtained by applying ranks separately to each variable, and then dividing the ranks by $n+1$ where $n$ is the number of sampling locations for soil C and N data and number of contrasts for next two datasets and number of plots for the last one (see \nameref{Model_selection} of manuscript). \label{fig_biv_raw_cop}}
\end{center}
\end{figure}


\begin{figure}[!h]
\textbf{ \hspace{6 cm} (A) \hspace{6 cm} (B)} \\
\vspace{-0.4 cm}
\begin{center}
\includegraphics[width=7 cm]{./Results/Aphid_count_raw_loc_4_11.pdf}
\includegraphics[width=7 cm]{./Results/Aphid_ff_raw_loc_2_5.pdf}\\
\end{center}
\textbf{ \hspace{6 cm} (C) \hspace{6 cm} (D)} \\
\vspace{-0.4 cm}
\begin{center}
\includegraphics[width=7 cm]{./Results/Aphid_count_cop_loc_4_11.pdf}
\includegraphics[width=7 cm]{./Results/Aphid_ff_cop_loc_2_5.pdf}
\caption{Upper panel shows raw data plots for \textbf{(A)} green spruce aphid-abundance data from location pair(4,11) and \textbf{(B)} leaf-curling plum aphid-firstflight data from location pair(2,5). Lower panel \textbf{(C - D)} shows copula plots for the corresponding datasets of the upper panel. These copula plots are obtained by applying ranks separately to each variable, and then dividing the ranks by $n+1$ where $n$ is the number of data-points available for both location at same year (see \nameref{Model_selection} of manuscript). \label{fig_aphid_raw_cop}}
\end{center}
\end{figure}

# Results \label{Results}

## question 1

- Do datasets in ecology and related fields have non-Normal copula structure?
- Do they show tail dependence distinct from that of a Normal copula?
- In particular do they show asymmetric tail dependence?

To answer Q1, we choose one representative datasets for each category : with a bivariate (soil C and N data) and
a multivariate (green spruce aphid-abundance data) dataset, we summarized our findings as follows.

### soil C and N data \label{Ex_SoilCN}

```{r read_BivMS_soilCN_data,echo=F}
d<-readRDS("Data/RaCA_soilorganicC_soiltotalN_stocks100cm.RDS")
d<-d[,c("SOCstock100","TSNstock100")] #raw soilCN data
BivMS_res_Loecke<-readRDS("./Results/fitting_results/BivMS_soilCN.RDS")
```

As described in the \ref{SM-SoilCN_data}, raw data plot for soil organic C and soil N stocks to 1m of soil depth from the central
pedon of the `r nrow(d)` sites and their corresponding copula plot were presented in Fig. \ref{fig_biv_raw_cop}(A) and (D),respectively.
We carried out model selection analysis and non-parametric statistics to measure tail-dependence (if any) on this copula plot.

#### Model selection approach \label{Ex_SoilCN_Model_selection}

The test of indepedence gave $p=$ `r BivMS_res_Loecke$IndepTestRes` (to within the precision available 
from `BiCopIndTest` in the `VineCopula` package) that showed a significant correlation (Kendall's coefficient = `r round(BivMS_res_Loecke$TauVal,2)`). We then fitted several copulas (all $16$ families as mentioned in \nameref{Model_selection})
and got AIC values and upper- and lower-tail dependency estimates based on the fitted copulas (Table \ref{SM-tab_soilCNfit}). 
Based on AIC weights, `r BivMS_res_Loecke$InfCritRes$copname[which.max(BivMS_res_Loecke$InfCritRes$AICw)]` was the best fit. The table shows that several copulas are much better supported (higher AIC and BIC weights) than the Normal copula, answering the first part of question 1 for these data. 

The model-averaged (AIC weights used for model averaging) lower-tail dependence statistic was `r BivMS_res_Loecke$relLTdep_AICw` and the model-averaged upper-tail dependence statistic was `r BivMS_res_Loecke$relUTdep_AICw`. These values are distinct from what a Normal copula would give (i.e., 0), answering the second part of question 1 for these data. Furthermore, the difference of these two quantities (lower minus upper), `r BivMS_res_Loecke$relLTdep_AICw-BivMS_res_Loecke$relUTdep_AICw`, was different from 0, answering the third part of question 1. To be precise, this difference being negative, indicated stronger upper-tail dependence than lower.

Although these results do convincingly show non-Normal copula structure, we should take the tail dependence results with a grain of salt because even the lowest-AIC copula was a poor fit, giving $p$-value `r BivMS_res_Loecke$GofRes_CvM` (to within the precision available from `BiCopGofTest` in the `VineCopula` package) in the Cramer-von Mises-based test of the goodness of its fit, and $p$-value `r BivMS_res_Loecke$GofRes_KS` in the Kolmogorov-Smirnov-based test of the goodness of fit. The next section looks at tail dependence in a non-parametric way.

#### Non-parametric analysis of tail dependence \label{Ex_SoilCN_NPA}

As described in \nameref{NPA}, each of our statistics, as computed for the 
ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (with $10$ number of bins), was compared to the distributions 
of values of the same statistic with the same ranges computed on 1000 Normal-copula 
surrogate datasets with similar Kendall or Spearman correlations, in different 
runs for Kendall and Spearman (Fig. \ref{SM-fig_soilCN_nonparam}). Each bin in each subplot of Fig. \ref{SM-fig_soilCN_nonparam}
contains a number which indicates how many surrogates out of 1000, are significantly different ($95\%$ confidence interval) from Normal-copula statistics.

Results indicate that tail dependence of data is stronger in both the lower and upper tails than would be expected under a 
null hypothesis of a normal copula, answering the second part of question 1. The dependence between C and N is also 
weaker in the middle of the distributions
than would be expected based on a normal-copula null model.

We also tested statistically for asymmetry of tail dependence, which seems visible in Fig. \ref{SM-fig_raw_cop_soilCN}(B). 
Results (Table \ref{SM-tab_soilCN_asym}) show that upper-tail dependence was, indeed, significantly stronger than lower-tail dependence in these data, answering the third part of question 1.

We summarized our results columnwise in Table \ref{tab_bivar_summary} for all bivariate datasets plotted in Fig. \ref{fig_biv_raw_cop}. 

The first $9$ rows of Table \ref{tab_bivar_summary} summarized model selection results [namely, (1) p-value from `BiCopIndTest`, (2) best copula based on minimum AIC, (3) AIC-weight of that best copula, (4) AIC-weight of Normal copula, (5) p-value from `BiCopGofTest` for Cramer-von Mises method, (6) p-value from `BiCopGofTest` for Kolmogorov-Smirnov method, (7) AIC-weights model averaged lower tail dependence, (8) AIC-weights model averaged upper tail dependence, (9)  AIC-weights model averaged (lower-upper) tail dependence].
Last $3$ rows ($10^{th}$ to $12^{th}$) of Table \ref{tab_bivar_summary} summarized non-parametric statistics results for $P$ statistics calculated on two extreme bins ($\Ps_l$ for first bin, $\Ps_u$ for last bin) for each copula data. 
We computed $\Ps_l$, $\Ps_u$, $\Ps_l - \Ps_u$ for the actual copula data and for Kendall-correlation 
preserving $1000$ Normal surrogates and calculated the rank for actual data as the position if all these $1001$ values were 
arranged in ascending order. So, whenever those ranks are $>975$ or $<25$, that indicate a significantly ($95\%$ CI) different 
tail-dependence measures based on Normal-null hypothesis. 

For all $4$ bivariate-datasets indicated by each column name (SoilCN, BMR, Anolis, Ceder-creek) 
in Table \ref{tab_bivar_summary}, Normal copula were always a poor fit compared to 
highest AIC-weight based asymmetric copulas - which answers the first part of Q1. 
Among four datasets presented there, first three have significant upper tail dependence whereas the last one has significant lower tail dependence compared to Normal. It was indicated by negative AIC-weights model averaged 
(lower-upper) tail dependence and very low ranks of actual copula 
data for $\Ps_l - \Ps_u$ statistics for first three datasets and positive AIC-weights model averaged 
(lower-upper) tail dependence and very high ranks of actual copula 
data for $\Ps_l - \Ps_u$ statistics for the last one, which answers the second and third part of Q1
(For detailed results of each dataset see Tables \ref{SM-tab_soilCNfit} - \ref{SM-tab_cc_asym_2000} and 
Figs. \ref{SM-fig_soilCN_nonparam} - \ref{SM-fig_cc2000_nonparam}). 

```{r tab_bivar_summary, echo=F, results='markup'}

tab_bivar_summary<-readRDS("./Results/tab_bivar_summary.RDS")
knitr::kable(tab_bivar_summary, 
             format='pandoc',
             caption = "Summary of results for bivariate data-sets.\\label{tab_bivar_summary}",
             booktabs=TRUE)
```

### Abundance data for the green spruce aphid, *Elatobium abietinum* \label{Ex_count}

```{r read_RES_aphid_count, echo=F}
RES_aphid_count<-readRDS("./Results/fitting_results/AphidCopulaFit_selecloc_count_species_10.RDS")
```

#### Model selection approach \label{Ex_count_Model_selection}

As described in \nameref{Model_selection}, for multivariable dataset like green-spruce aphid abundance data, model selection among copulas was done separately for each pair of the 10 sampling locations, thus results are presented in $10 \times 10$ matrix format with rows and columns corresponding to locations. Table \ref{SM-tab_count_bestcop} shows that, for the large majority of location pairs, some non-Normal copula was a better fit, according to maximum AIC-weights, than was the Normal copula, answering the first part of question 1 for these data. Comparing the 
AIC weight of the best-fitting (lowest AIC) copula family for each pair of sampling locations (Table \ref{SM-tab_count_AICw}) to the AIC weight of the Normal copula family for the same pair (Table \ref{SM-tab_count_AICw_normal}) confirms that the degree of support for Normal copulas was usually not
comparable to the degree of support for other families.
Goodness of fit tests based on a Cramer-von Mises statistic (Table \ref{SM-tab_count_p_CvM}) in every case 
failed to reject the hypothesis that the AIC-best copula family was also an objectively adequate description of 
the data, and likewise for goodness of fit tests based on a Kolmogorov-Smirnov statistic (Table \ref{SM-tab_count_p_KS}), demonstrating that the collection of copula families we used was sufficiently broad that the copulas of all pairs of locations could be characterized by at least one of them. In all cases at least `r min((RES_aphid_count$gfc_numBS_success/RES_aphid_count$gfc_numBS),na.rm=T)*100` percent of bootstrap randomizations used for goodness of fit tests successfully lead to values of the statistic for comparison with its value on the real data.

The model-averaged (averaging performed using AIC weights) lower-tail dependence statistic and the model-averaged (again, AIC based) upper-tail dependence statistic are in Tables \ref{SM-tab_count_LTdep_AICw} and \ref{SM-tab_count_UTdep_AICw} respectively. These values were exclusively positive, thereby differing from what a normal copula would give (i.e., 0), and answering the second part of question 1 for these data. Apparently these aphid data have greater tail dependence (both lower and upper) than would be expected from a normal-copula null hypothesis. 

The difference between the model-averaged lower-tail dependence statistic and the model-averaged upper-tail dependence statistic (lower minus upper), shown in Table \ref{SM-tab_count_LTmUT}, is positive for all but a few locations pairs (`r sum((RES_aphid_count$LTdep_AICw-RES_aphid_count$UTdep_AICw)>0,na.rm=T)` out of `r (dim(RES_aphid_count$gfc_p_CvM)[1]^2-dim(RES_aphid_count$gfc_p_CvM)[1])-2*RES_aphid_count$num_indep_loc_pair`), answering the third part of question 1. Fig. \ref{fig_aphid_raw_cop}(A) and (C) represnt exemplary plots for aphid abundance (green spruce aphid) raw data and its copula form at $(4,11)$ location pair which shows stronger lower tail dependence.

#### Non-parametric analysis of tail dependence \label{Ex_count_NPA}

Mean values of our statistics ($\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_l$, $\Dsq_u$, 
$\cor_l-\cor_u$, $\Ps_l-\Ps_u$, $\Dsq_u-\Dsq_l$), as well as mean Kendall and Spearman correlations, were 
computed across all pairs of sampling locations, and confidence intervals of these means were computed via a spatial
resampling scheme, as described in \nameref{NPA} (Table \ref{SM-tab_count_resamp}). Confidence intervals of
$\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_l$, and $\Dsq_u$ always excluded zero and mean values were positive,
indicating tail dependence. Confidence intervals of $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, $\Dsq_u-\Dsq_l$ also always 
exluded $0$ and were positive, indicating asymmetry of tail dependence (stronger lower tail dependence than upper), a feature that data with Normal copula structure do not have, providing further evidence answering the third part of question 1. 

Plotting Spearman or Kendall correlation between aphid abundance time series for pairs of locations as a function of great circle distance between the locations (Fig. \ref{SM-fig_aphid_count} A,B) showed the typical decline of correlation with distance between sampling locations that has been seen for numerous other datasets in earlier work. Plotting $\cor_l$, $\cor_u$, $\Ps_l$, and $\Ps_u$  against distance between pairs of locations shows these quantities also decline with distance (Fig. \ref{SM-fig_aphid_count} C-F). Plotting $\Dsq_u$ and  $\Dsq_l$ against distance between pairs of locations shows these quantities increase with distance (as expected, given the opposite interpretation these two statistics have compared to $\cor_u$, $\Ps_u$ and $\cor_l$, $\Ps_l$, respectively). Plotting $\cor_l - \cor_u$, $\Ps_l - \Ps_u$, and $\Dsq_u - \Dsq_l$ versus distance (Fig. \ref{SM-fig_aphid_count} I-K) did not show a decline with distance, but did illustrate visually the statistical result of Table \ref{SM-tab_count_resamp} that averages of these quantities across all pairs of sampling locations were significantly greater than zero, demonstrating asymmetry of tail dependence, as also seen from model selection approach. Code for these analyses is in [`NonParamStat.R`](https://github.com/sghosh89/BIVAN/blob/master/NonParamStat.R) in the [`BIVAN`](https://github.com/sghosh89/BIVAN) repository. 


```{r tab_multivar_summary, echo=F, results='markup'}

tab_multivar_summary<-readRDS("./Results/tab_multivar_summary.RDS")
knitr::kable(tab_multivar_summary, 
             format='pandoc',
             caption = "Summary of results for multivariate data-sets.\\label{tab_multivar_summary}",
             booktabs=TRUE)
```

We summarized our results columnwise in Table \ref{tab_multivar_summary} for all multivariable datasets 
(i.e., abundance data for green spruce aphid from `r nrow(RES_aphid_count$gfc_numBS)` sampling locations, 
firstflight date data for leaf-curling plum aphid from `r nrow(RES_aphid_count$gfc_numBS)` sampling locations, 
abundance data for plankton from UK seas from $14$ sampling locations, 
methane flux data from $13$ sampling locations). First $11$ rows in Table \ref{tab_multivar_summary} represent
model selection results :
(1) total number of location pairs (excluding self-comparison) considered, 
(2) how many location pair copula are non-independent among them, 
(3) number of non-Normal copula as best fit (based on highest AIC-weight),
(4) average AIC-weights of best fit copula from all location pair,
(5) average AIC-weights of Normal copula from all location pair,
(6) number of location pair for which best fit copula have p-values > 0.01 
(both Cramer-von Mises and Kolmogorov-Smirnov method)
(7) lower and (8) upper quantile ($95\%$CI) of model averaged (AIC-weight based) lower tail dependence from all location pair,
(9) lower and (10) upper quantile ($95\%$CI) of model averaged (AIC-weight based) upper tail dependence from all location pair,
(11) number of location pair which showed stronger lower tail dependence than upper.

Last $6$ rows of Table \ref{tab_multivar_summary} summarized the non-parametric analysis results 
for $\Ps$ statistics : lower and upper quantile ($95\%$CI) of $\Ps_l$, $\Ps_u$, $\Ps_l-\Ps_u$ based on resampling
location pair.

Likewise, green-spruce aphid abundance data ($1^{st}$ column in Table \ref{tab_multivar_summary}), 
plankton data from UK seas also showed major lower tail dependent spatial synchrony 
($3^{rd}$ column in Table \ref{tab_multivar_summary}), whereas firstflight data for leaf-curling plum aphid 
showed stronger upper tail dependence at every location pair ($2^{nd}$ column in Table \ref{tab_multivar_summary}).
Methane flux data (last column of Table \ref{tab_multivar_summary}) did show that there were non-Normal copula as best fit for most of the location pair but its model-averaged lower tail dependence was not significantly stronger in non-parametric analysis results.


<!--Question 2 analyses-->
## Some possible causes of non-Normal copula structure 

Q1/2: How are copula structure of ecologically influential climate variables changing as part of climate change? We now know the copula structure of environmental variables can induce (sometimes similar but not the same) copula structure in the pops, but we don’t really know how a change in the environment cop structure would make what kind of change in the pop cop structure. How?

### The Moran effect and copula structure in populations 

We show here that if a non-normal copula structure describes the dependence of an environmental
variable between two locations, then there can be a non-normal copula structure for the
dependence of populations in the locations that are influenced by the environmental variables.

To begin with, we chose a two habitat patch ($i = 1, 2$) with AR(1) model [Eq. \ref{eq.AR1}] where population $P_{i}$ at time $(t+1)$ depends upon its past value at $(t)$ and the iid noise (assumed to be caused by environmental fluctuations) $\epsilon_{i} (t)$.  

\begin{equation}\label{eq.AR1}
P_{i}(t+1)=\beta P_{i}(t)+\alpha \epsilon_{i}(t)
\end{equation}

To keep $Var(P_{i}(t+1))$ equal to unity, we set noise coefficient $\alpha$ in terms of AR coefficient $\beta$ as $\alpha = \sqrt(1-\beta^2)$. We were interested to explore the basic idea of Moran's theorem that if noise $\epsilon_{1}(t)$ and $\epsilon_{2}(t)$ at two different habitat patches had some specific assymetric tail dependence and then what will be the outcome dependence in the populations at those habitat patches. Should their dependence be exactly the same as of the noises or not ? 

To test that our approach is of two way : first, we calculated the parameters of the noise-copula (for example, we chose Clayton with lower tail dependence and Survival Clayton with upper tail dependence here) using `iRho` or `iTau` function from `copula` package for Spearman's Rho or Kendall's Tau, respectively. Then we simulated our model (\ref{eq.AR1}) and estimated parameters of the outcome which was a bivariate population-copula, with last $500$ simulated points for each habitat patch (see Fig. \ref{SM-fig_Cause4copula_params_GOF_500}). We also tested the goodness of fit of the estimated parameters for population-copula and its standard error due to sample size and reported p-values for both statistics (Cramer-von Mises and Kolmogorov-Smirnov). p-values greater or equal to $0.05$ (above the dashed line in Fig. \ref{SM-fig_Cause4copula_params_GOF_500}) were considered as a good fit of estimated parameters. Fig. \ref{SM-fig_Cause4copula_params_GOF_2500} represents similar figure as of Fig. \ref{SM-fig_Cause4copula_params_GOF_500} but here we considered last $2500$ simulated population data points for our parameters-estimation, thus making our comparison more sensitive on basis of p-value threshold at $0.05$. (For code see [`Plotter_Cause4copula_GOF`](https://github.com/sghosh89/BIVAN/blob/master/Cause4copula.R) function). 

Secondly, we measured 3 types of correlations (Spearman, Kendall, Pearson) and different types of non-parametric statistics (see \nameref{NPA}) for both bivariate noise copula and resultant population copula for $50$ simulations. Then we plotted mean of each measured quantity with standard error against Spearman's Rho (or Kendall's Tau) of the noise copula family. Fig. \ref{SM-fig_Cause4copula_C_spear} and Fig. \ref{SM-fig_Cause4copula_C_kend} represent this picture for noise generating from a lower tail dependent Clayton copula whereas for Fig. \ref{SM-fig_Cause4copula_SC_spear} and Fig. \ref{SM-fig_Cause4copula_SC_kend} noise came from a upper tail dependent Survival Clayton family. We also carried out a paired t-test to compute the p-values of each statistic for noise and population data and found that like our first approach, here also the nature of tail dependence in noise and populations remained similar but they were not exactly the same except in Pearson correlation coefficient which ensured the Moran effect on the population data caused by environmental noise. (For code see [`Plotter_Cause4copula_stat`](https://github.com/sghosh89/BIVAN/blob/master/Cause4copula.R) function). 

### Asymmetric sensitivity and copula structure in populations
<!--Another model, distinct from the above, Dan and Shya to discuss-->
Here we intend to see if any specific (lower or upper) tail dependence emerges from a copula of two meta-populations, due to some global environmental factors (like temperature or snowfall) beyond a certain expectation threshold. To test this assymetric sensitivity, we constructed a two habitat patch model for population $P_{i} (i=1,2)$ as follows;

\begin{equation}\label{eq.AS}
P_{i}(t+1) = b P_{i}(t) + g(\epsilon_{i}(t)) + h(\delta_{i}(t))
\end{equation}

$b$ was the linear growth rate. Global environmental fluctuation function $g(\epsilon)$ can take up any one form between $g_{1}$ and $g_{2}$ (Eq. \ref{eq.AS_g}) where $\epsilon=(\epsilon_{1}, \epsilon_{2})$ was an iid through time with mean zero and covariance matrix $\Sigma_{\epsilon}$.

\begin{align}
g(\epsilon) = \begin{cases} 
g_{1} = \begin{cases}
\epsilon & \text{if $\epsilon< 0$}; \\
0 & \text{otherwise}.
\end{cases}\\ \\
g_{2} = \begin{cases}
\epsilon & \text{if $\epsilon> 0$}; \\
0 & \text{otherwise}\label{eq.AS_g}.
\end{cases}
\end{cases} \text{where } \epsilon = N(\textbf{0},\Sigma_{\epsilon})\;\ \text{with} \;\ \Sigma_{\epsilon} = \begin{bmatrix} 1 & r \\ r & 1 \end{bmatrix}
\end{align}

Local environmental fluctuation function $h(\delta)$ varied according to Eq. \ref{eq.AS_h} where $a$ was the scaling parameter between $0$ to $1$. $\delta=(\delta_{1}, \delta_{2})$ was an iid across $i=(1,2)$ and time with mean zero and covariance matrix $\Sigma_{\delta}$.

\begin{equation}\label{eq.AS_h}
h(\delta) = a \delta = aN(\textbf{0},\Sigma_{\delta})\;\ \text{with} \;\ \Sigma_{\delta} = \begin{bmatrix} 1 & 0 \\ 0 & 1 \end{bmatrix}
\end{equation}

We simulated our model (\ref{eq.AS}) for different values of $b$ with $a=0.2$, $r=0.8$. $10000$ points were generated from each local and global fluctuations to apply on the initial populations and then after simulation we kept only last $1000$ time step of simulation to plot the population-copula for a specific $b$ and a specific functional form of $g$  (For code see [`Simulator_asym_sens`](https://github.com/sghosh89/BIVAN/blob/master/asym_sensitivity.R) function). Fig. \ref{SM-fig_ms_asym_b_0.1} and Fig. \ref{SM-fig_ms_asym_b_0.9} show these results for $b=\pm0.1$ and $b=\pm0.9$, respectively. We also carried out model selection and non-parametric statistical analysis with each copula of those figures and summarized our results in Tables \ref{SM-tab_summary_stat_asym_sens} - \ref{SM-tab_stat_npa_asym_8}. Table \ref{SM-tab_summary_stat_asym_sens} represent the model selection results with AIC weights for best fitted copula and normal copula, model averaged lower and upper tail dependence, p-values (both Cramer-von Mises statistic and Kolmogorov-Smirnov statistic) for goodness of fit test. In each case, successful bootstrap was $100\%$. According to our model selection approach, for $b=\pm0.1$, non-normal copula (with higher AIC weights) were always best-fit with some asymetric tail dependence whereas for $b\pm0.9$, most of the time normal was best. It is probably because the populations get long-time exposure to environmental changes for slower growth(or decay) rate and so global fluctuation can affect them more efficiently. Our non-parametric analysis results (Tables \ref{SM-tab_stat_npa_asym_1} -\ref{SM-tab_stat_npa_asym_8}) are consistent with this model selection approach. 


### Need to think about mechanisms for biogeochemical, evolutionary, and community data

<!--Question 3 analyses-->
## Consequences of non-Normal copula structure and tail dependence for our understanding of biology and for applications?

### Effect on skewness of the spatial mean

Here, we claim that because of significant tail dependence of the multivariate copula structure, the skewness of the time-series data averaged over all selective locations changed significantly from the individual skewness of time-series data taken at each pairwise location. Spatial mean of the time series data extracts that tail dependence of the multivariate data set, if any, and reflected in the averaged skewness. We tested this with null hypothesis $H_{0}$. If $H_{0}$ is true that means our multivariate copula actually came from normal copula structure with no tail dependence and thus should have the same skewness as of normal copula. So, first we generated $10000$ number of surrogate normal copula from our given multivariate copula keeping the marginal distribution and the correlation (spearman or kendall) same. Then we plotted the distribution of spatial mean of each surrogate time series data set and the given multivariate data. If $p$-value is less than $0.05$, then we reject the null hypothesis in support of significant tail dependence.

To verify that we used aphid-count data, aphid-firstflight data, plankton data and methane-flux data. For aphid data we choose only those locations for which atleast $30$ number of data points present in each time series when taken as pairwise locations. For plankton-UK-sea data and methane-flux data that threshold on number of data points are $45$ and $50$, respectively. 

- Aphid count \label{skewness_count}

Figure \ref{SM-fig_skewness_count} shows that averaged skewness is much lower than expected if the aphid count data came from a normal copula. Here, $p$ value indicates the fraction of surrogate-skewness which are lower than the averaged skewness of the given data (red line in Figure \ref{SM-fig_skewness_count}). As $p<0.05$, we reject $H_{0}$. This result is consistent with the non-parametric analysis and model fitting results which indicated lower tail dependence. 

- Aphid first flight \label{skewness_ff}

Figure \ref{SM-fig_skewness_ff} shows that averaged skewness is much higher than expected if the aphid first flight data came from a normal copula. Here, $p$ value indicates the fraction of surrogate-skewness which are greater than the averaged skewness of the given data (red line in Figure \ref{SM-fig_skewness_ff}). As $p<0.05$, we reject $H_{0}$ in support for upper tail dependence. 


- UK Sea plankton \label{skewness_pns}

Figure \ref{SM-fig_skewness_pns} shows that averaged skewness is lower than expected if the plankton data came from a normal copula. Our previous results on non-parametric analysis and model fitting showed lower tail dependence. Here, as $p>0.05$, we cannot reject $H_{0}$, .......???

- Methane-flux data \label{skewness_methane}

Figure \ref{SM-fig_skewness_methane} shows that averaged skewness is lower than expected if the plankton north sea data came from a normal copula. Our previous results on non-parametric analysis and model fitting showed lower tail dependence. As $p<0.05$, we reject $H_{0}$. This result is consistent with the non-parametric analysis and model fitting results which indicated lower tail dependence. 

### Effect on extinction risk

In order to study the effects of non-Normal copula structure on extinction risk for population of a species at different locations with different dispersal rules, we examined the following generalized multiple patch model where local population dynamics at each patch were governed by the Lewton-Cohen model ($r=0$) or Ricker model ($r \neq 0$) as the case may be;
<!--did I write correct spelling for lewton model?-->

\begin{equation}\label{eq.extrisk_model}
P(t+1) = \exp\left [  r\left ( 1-\frac{P(t)}{K} \right ) + \epsilon(t) \right ] P(t)
\end{equation}

$r$ is the liner growth rate and $K$ is the carrying capacity of the environment. $\epsilon$ is the environmental noise which may take strong right tail (or left tail) dependence. We then considered each population $P(t+1)$ was updated depending upon $D$, the dispersal matrix. $D$ can take either forms; one case when each population patch on a linear chain interacted with its two nearest neighbors (we called it local dispersion) or when any patch can interact with the rest of all (we called it as global dispersion). We simulated Eq. \ref{eq.extrisk_model} for $10000$ simulations and calculated extinction risk after $25$ years with different possibilities (for code see [mydispersal.R](https://github.com/sghosh89/BIVAN/blob/master/mydispersal.R)) and summarized our findings as follows;


- LC model (r=0) :

    * For LC model, as expected, when extinction risk calculated after $25$ years, was plotted against each varying $d$ (=degree of dispersion), we found that extinction risk was higher for data came from left tail dependent environmental fluctuations than right tail dependent one. [see first plot of Fig. \ref{SM-fig_risk_local_disp} and Fig. \ref{SM-fig_risk_global_disp}]

- Ricker model (r $\neq$ 0):

    * For ricker model when extinction risk calculated after $25$ years, was plotted against each varying $d$ (=degree of dispersion), we found that extinction risk was higher for data came from left tail dependent environmental fluctuations than right tail dependent one upto $r=0.7$. For $r>0.7$, extinction risk is greater for data came from right tail dependent environmental fluctuations. [see Fig. \ref{SM-fig_risk_local_disp} - \ref{SM-fig_risk_global_disp}]
 
    * With increasing $K$ from $50$ to $200$, extinction risk in both case gets decreased as expected. [see Figure \ref{SM-fig_risk_K_effect}]
  
With increasing number of patches from $5$ to $25$, extinction risk decreased [for a fixed $d$] ; [see Fig. \ref{SM-fig_risk_numlocs_effect_local_disp} - Fig. \ref{SM-fig_risk_numlocs_effect_global_disp}] for both model. 

### Effects on Taylor's law

Spatial Taylor's law, which shows linear relationship between `log`(variance) and `log`(mean) of population densities of a species taken from different locations, is a well-known pattern found in ecology and related fields. Here, we want to examine the nature of the slope and how it changes if population time series (taken as $50$ years) from different locations (say, $numloc=25$) have some certain type of copula structure (namely, \textbf{C}, \textbf{F} and \textbf{SC}) other than the $\textbf{N}$ormal copula. First, we simulated (N $\times$ n $\times$ ns) dimensional normal copula with covariance $\rho =0.7$, where $(N=50,n=25,ns=10)$ are the length of timeseries, number of sampling locations and number of replica for that copula, respectively. Then we generated Kendall-correlation preserving \textbf{C}layton, \textbf{F}rank and $\textbf{S}$urvival \textbf{C}layton surrogates with same dimension of \textbf{N}ormal. With these four different types of copula we computed `log`(spatial variance) and `log`(mean) and plotted in Fig.\ref{fig_spTL}(A-D). We also tested statistically that whether linearity, homoskedasticity is maintained in each copula dataset or not and plotted our results alongwith root mean square error, intercept and slope in Fig.\ref{fig_spTL}(E-I) (For code see [`copsurrognd.R`](https://github.com/sghosh89/BIVAN/blob/master/copsurrognd.R) and [`TaylorsLawTools.R`](https://github.com/sghosh89/BIVAN/blob/master/TaylorsLawTools.R)).

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.1 cm} (D)} \\
\vspace{-0.5 cm} 
\begin{center}
\includegraphics[width=16 cm]{./Results/taylorslaw_results/SpatialTL_CNFSC.pdf}\\
\end{center}
\textbf{ \hspace{3.1 cm} (E) \hspace{2.4 cm} (F) \hspace{2.3 cm} (G) \hspace{2.3 cm} (H) \hspace{2.3 cm} (I)}\\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=16 cm]{./Results/taylorslaw_results/SpatialTL_5stats.pdf}
\caption[Spatial Taylor's Law results]{Spatial Taylor's Law results: log(spatial variance) vs. log(spatial mean) for $ns=10$ number of (A) Clayton, (B) Normal, (C) Frank, (D) Survival Clayton surrogates; (E) p-value for test of linearity, (F) p-value for test of hhomoskedasticity, (G) root mean square error, (H) intercept, (I) slope of the first panel plots. \label{fig_spTL}}
\end{center}
\end{figure}


# Discussion \label{Discussion}



\newpage
# References


