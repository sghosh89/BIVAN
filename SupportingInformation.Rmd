---
title: "Supporting Information"
author: "Shyamolina Ghosh and Daniel Reuman"
date: "February 12, 2018"
geometry: "left=1cm,right=1cm,top=2.5cm,bottom=2.8cm"

output: 
  pdf_document:
    number_sections: yes
    keep_tex: yes
    fig_caption: yes
tables: True
---

updated on `r Sys.Date()`

<!--New latex commands-->
\newcommand{\mean}{\operatorname{mean}}
\newcommand{\var}{\operatorname{var}}
\newcommand{\cor}{\operatorname{cor}}
\newcommand{\Ps}{\operatorname{P}}
\newcommand{\D2}{\operatorname{D}^2}

<!--Basic setup-->
```{r setup, echo=F}
knitr::opts_chunk$set(echo = TRUE, fig.pos = "H")
seed<-101
families<-c(1,3:10,13,14,16:20)

source("mtime.R") #A function needed for caching
source("getcopula.R")
source("OurBiCopSelect.R")
source("FittingCopula_selective_loc.R")
source("normal_cop_AICw.R")
source("aphid_data_calling.R")
source("plankton_north_sea_data_calling.R")
source("NonParamStat.R")
source("copsurrog2d.R")
source("TestStats_multivar_dataset.R")
source("skewness_multivar_dataset.R")
```

# Descriptions of data
<!--Each data contributor writes one to a few paragraphs about their data.-->

## Soil C and N data

<!--The raw data look like this:-->
```{r load_data_Loecke, echo=F, fig.cap="Plot of the raw soil C and N data.\\label{fig_soilCNraw}", fig.height=5, fig.width=5}
d<-readRDS("Data/RaCA_soilorganicC_soiltotalN_stocks100cm.RDS")
d<-d[,c("SOCstock100","TSNstock100")]
plot(d[,1],d[,2],type="p",col="red",xlab="Soil C",ylab="Soil N",cex.lab=1)
```

<!--The copula looks like this:-->
```{r rankandplot_Loecke, echo=F, fig.cap="Copula plot of soil C and N data. Obtained by applying ranks separately to the C and N data, and then dividing the ranks by $n+1$ where $n$ is the number of sampling locations (see YYY).\\label{fig_soilCNcop}",  fig.height=5, fig.width=5}
#convert to a copula and plot
v_CN<-getcopula(d=d,rankon=T,ploton=T) 
```
<!--Shya please insert an automatic reference to the methods section "Model selection approach" at the location YYY above. I could not easily find a way to do section references by number that was consistent with the figure and table reference system you already have, but perhaps I missed it. In the end I think we will need to be able to refer to sections as well as figures and tables by number. I can see there is a package called "bookdown" that may help but there may be something easier using similar tools to what you have already used for figures and tables.-->

Carbon and nitrogen in soil at many locations across CONUS (Terry to augment this description). The raw data are shown in Figure \ref{fig_soilCNraw}. The copula is shown in \ref{fig_soilCNcop}.

<!--Shyamolina, let's not put in newpages and other spacing modifications until possibly at the end, once all the content is essentially settled-->

## Aphid data
   * Aphid data contains 3 measurements [count, firstflight, flight-duration] at 11 locations for 20 species and for 35 years.
   * We threw out all locations that had fewer than 30 years data 
   * We use species=10 [Name : "Green spruce aphid"] for aphid-count data 
   * We use species=11 [Name : "Leaf-curling plum aphid"] for aphid-firstflight data   
   
## North Sea plankton data
   * Plankton North sea dataset collects data at 26 locations for 22 species and for 56 years.
   * We threw out all locations that had fewer than 45 years data
   * We use species=16 [Name : "Ceratium_furca"] for Plankton_North_Sea data
   
# Question 1 analyses for each dataset
Recall that question 1 is: Do datasets in ecology and related fields have non-Gausian copula structure? Do they show tail dependence distinct from that of a Gaussian copula? In particular do they show asymmetric tail dependence?

## Details of methods

### Model selection approach

For a bivariate dataset $(x_i,y_i)$ for $i=1,...,n$, model selection involved several steps, 
most implemented using tools from the `VineCopula` package. Code combining these tools is in the
[*OurBiCopSelect*](https://github.com/sghosh89/BIVAN/blob/master/OurBiCopSelect.R) function and its dependencies in the [*BIVAN*](https://github.com/sghosh89/BIVAN) repository. 
<!--Shya, links to code are a good idea! Thanks for figuring this out and adding, we should do something like this in other methods sections.-->

First, we produced ranks 
$(\tilde{u}_i,\tilde{v}_i)$ where $\tilde{u}_i$ is the rank of $x_i$ in the set 
$\{x_i:i=1,...,n\}$ and $\tilde{v}_i$ is the rank of $y_i$ in the set $\{y_i:i=1,...,n\}$ and 
we set $u_i=\tilde{u}_i/(n+1)$ and $v_i=\tilde{v}_i/(n+1)$; further work was with the $u_i$ 
and $v_i$. Ranks $\tilde{u}_i$ and $\tilde{v}_i$ were $1$, for the 
smallest element, up to $n$, for the largest. 

Second, we did a test of the independence of the $u_i$ and $v_i$. Subsequent model 
selection algorithms are ineffective if data could not be distinguished from independent data 
since most or all bivariate copula families considered include the independent copula in the 
family or as a boundary case. The independence test was as implemented in the `BiCopIndTest`
function in `VineCopula`, the documentation of which reports the test uses the asymptotic normality of the statistic $|\tau|\sqrt{\frac{9n(n-1)}{2(2n+5)}}$, where $\tau$ is Kendall's tau statistic. If independence could be rejected ($0.05$ significance level), model selection proceeded.

The third step of model selection was to fit multiple bivariate copula families to the ranked data $(u_i,v_i)$ via maximum likelihood, using the `BiCopEst` function in `VineCopula`. Families considered (with abbreviations and numeric codes here indicated) included the **N**ormal/Gaussian*{1}*, **C**layton*{3}*, **G**umbel*{4}*, **F**rank*{5}*, **J**oe*{6}*, **BB1***{7}*, **BB6***{8}*, **BB7***{9}*, **BB8***{10}*, **S**urvival **C**layton*{13}*, **S**urvival **G**umbel*{14}*, **S**urvival **J**oe*{16}*, **S**urvival **BB1***{17}*, **S**urvival **BB6***{18}*, **S**urvival **BB7***{19}* and **S**urvival **BB8***{20}* copulas.
Akaike Information Criterion (AIC), Bayesian Information Criterion (BIC) and accompanying model weights ($\text{AIC}_{\text{w}}$, $\text{BIC}_{\text{w}}$) were generated using standard formulas (REF). 
<!--Shya, we here need a reference to the Burnham and Anderson book-->
Descriptions of these copula families can be found in introductory texts on copulas
<!--Shya to please insert references for both the books on copulas we have-->
and in references cited in `VineCopula`. The lower- and upper-tail dependence of the 
best-fitting member of each family was also provided by `BiCopEst`.

Model selection methods will give the *relative* support of several models, but will not,
on their own, indicate whether any of the models selected is an objectively good fit (all 
models considered might poorly describe the data). To test this, and as the fourth step of
our procedure, we tested the goodness of fit of our best-AIC copula family using a 
bootstrapping procedure implemented in `BiCopGofTest` of `VineCopula`. The method performed 
two tests, one based on a Cramer-von Mises statistic, and one based on a 
Kolmogorov-Smirnov statistic. For computational efficiency, 
an initial run using $100$ bootstraps was performed, and if
the $p$-value resulting from either test was less than $0.2$, tests were re-run with 
$1000$ boostraps.

Finally, $\text{AIC}_{\text{w}}$ values for all fitted models were used to get
model-averaged lower- and upper-tail dependence values using standard model averaging 
formulas
<!--Shya to add reference to Burnham and Anderson, please-->
; likewise for BIC.

<!--Shya please insert some additional material for multivariate datasets - perhaps
you don't need much because basically you just ran the bivariate analysis on each pair
of locations, but you need to say that and then maybe a few sentences about how 
everything was tallied up after having done that-->

### Non-parametric analysis of tail dependence

![Schematic diagram supporting defintions of nonparametric tail dependence statistics.\label{fig_stat_image}](./stat_image.jpg){ width=30%, height=30% }
<!--Shya, can you please change this figure so it shows u (horizontal) and v (vertical) on the axis labels instead of vi and vj? Often times computer variables do not make good mathematical notation, so I have changed this, I also made changes for similar reasons to other notation elsewhere.-->

Left- and right-tail dependence quantify the extent to which two ranked
variables $u_i$, $v_i$ for $i=1,...,n$ 
(see section REF for defintions of $u_i$ and $v_i$)
<!--Shya pls insert ref to the section immediately above this one-->
are related in the left and right tails, respectively, of their 
distributions (REF). 
<!--Shya, pls cite the Nelson book-->
Our nonparametric study of tail dependence uses three
statistics which can quantify the extent to which $u_i$ and $v_i$ are 
related in any part of their distributions. We here describe the 
statistics. The statistics were formulated with positively associated
variables in mind. All the variables we study are positively associated
when they are significantly associated. So definitions and associated 
diagrams will assume positive associations, though generalizations are 
possible. Given two bounds 
$0 leq l_b < u_b \leq 1$, we define the parallel lines $u+v=2l_b$ and 
$u+v=2u_b$ which intersect the unit square in which the $u_i$ and $v_i$ 
fall (these are the blue and red lines, respectively, in 
Figure \ref{fig_stat_image}). Our statistics quantify the dependence
between $u_i$ and $v_i$ in the region bounded by these lines.
Using $l_b=0$ and some value $u_b\leq 0.5$ can give information about 
dependence in the left parts of the distributions of $u$ and $v$, and 
using $u_b=1$ and $l_b \geq 0.5$ can give information about dependence in 
the right parts of the distributions. 

The first quantity, $\cor_{l_b,u_b}(u,v)$, is the portion of the Spearman 
correlation of $u_i$ and $v_i$ that is attributable to the points 
lying in the region given by the bounds $u+v=2l_b$ and $u+v=2u_b$, i.e.,
\begin{equation}\label{eq.Cor}
   \cor_{l_b,u_b}(u,v) = \frac{1}{(n-1)\sqrt{\var(u)\var(v)}}\sum 
   (u_i-\mean(u)) (v_i-\mean(v)),
\end{equation}
where means and variances are computed using all $n$ data 
points, but the
sum is over only the indices $i$ for which $u_i+v_i > 2l_b$ and 
$u_i+v_i < 2u_b$. 
Larger values of $\cor_{l_b,u_b}$ indicate stronger positive association
between $u$ and $v$ in the region given by the bounds.

We also defined a statistic $\Ps_{l_b,u_b}$, using the same bounds
$u+v=2l_b$ and $u+v=2u_b$, as follows. For a distance $h$, we defined
$S(h)$ to be the  
number of points $(u_i,v_i)$ within the bounds 
and a distance less than $h$ from the line $v=u$, divided by the 
total number of points within the bounds. This function is
defined for $h$ going from $0$ to a distance $h_{\text{max}}$ which
is half the longer of the two segments obtained by intersecting the
bounds with the unit square. It is easy to see $S(0)=0$ and 
$S(h_{\text{max}})=1$. We defined $S_i(h)$, for the same range 
of $h$, to be the area within the bounds and the unit square
and within distance $h$ of the line $v=u$, divided by the area
within the bounds and the unit square. This is the expected value of
$S(h)$ for independent data. We then defined
\begin{equation}\label{eq.P}
   P_{l_b,u_b} = \int_0^{h_{max}} ( S(h) - S_i(h) ) dh.
\end{equation}
As for $\cor_{l_b,u_b}$, larger values of $P_{l_b,u_b}$ 
indicate stronger positive association
between $u$ and $v$ in the region given by the bounds.

The third statistic, $\D2_{l_b,u_b}(u,v)$, is the average squared 
distance between points satisfying $u_i+v_i>2l_b$ and 
$u_i+v_i<2u_b$ and the line $v=u$. Unlike $\cor_{l_b,u_b}$ and 
$\Ps_{l_b,u_b}$, which are large when points satisfying $u_i+v_i>2l_b$ and 
$u_i+v_i<2u_b$ cluster close to the line $v=u$, $\D2_{l_b,u_b}$ is 
then small. 
Thus large values of $\cor_{l_b,u_b}$ and $\Ps_{l_b,u_b}$ indicate strong 
dependence in the portions of the distributions of $u$ and $v$ given by 
the bounds $u_i+v_i>2l_b$ and $u_i+v_i<2u_b$, whereas small values of 
$\D2_{l_b,u_b}$ indicate strong dependence. 

For large datasets (i.e., datasets with large $n$),
we can consider $l_b$ and $u_b$ close together without incurring undue
sampling variation in our statistics, and we can consider 
several different bands $(l_b,u_b)$ to understand how dependence
varies in different parts of the distributions. But for datasets with 
smaller $n$ we considered only $l_b=0$, $u_b=0.5$ and $l_b=0.5$, $u_b=1$.
We use the shorthand $\cor_l=\cor_{0,0.5}$ ($l$ is for "lower") 
and $\cor_u=\cor_{0.5,1}$ ($u$ is for "upper"); likewise $\Ps_l=\Ps_{0,.5}$,
$\Ps_u=\Ps_{0.5,1}$, $\D2_l=\D2_{0,0.5}$, and $\D2_u=\D2_{0.5,1}$.

The difference $\cor_l-\cor_u$ is expected to be positive if 
dependence in the left halves of the distributions is stronger 
than dependence in their right halves; likewise for $\Ps_l-\Ps_u$.
This holds, for instance, for the Clayton copula (REF).
<!--Shya to cite the Nelson book-->
The difference $\D2_u-\D2_l$, in which the "upper" and
"lower" statistics occur in opposite order, is also expected to be 
positive under the same conditions. We use these three differences
to detect asymmetry of tail dependence. Likewise, for large datasets,
we consider $\cor_{l_b,u_b}-\cor_{1-u_b,1-l_b}$, 
$\Ps_{l_b,u_b}-\Ps_{1-u_b,1-l_b}$ and
$\D2_{1-u_b,1-l_b}-\D2_{l_b,u_b}$ with $l_b=0$ and $u_b$ close to $0$.

<!--Eventually we will need to add methods on how we use these stats, which is different for multivariate and bivariate data. For bivariate data, it involves surrogates, for multivariate data it involves resampling locations. So, in particular, Dan will have to insert descriptions of the resampling methods.-->

### Stat-testing of Non-parametric analysis (for limited number of datapoints)

Here, we want to test our $3$ types of nonparametric tail dependent statistics on both small $(35)$ and large $(1000)$ number of datapoints drawn from $4$ types of bivariate copula, namely, *Clayton* , *Normal*, *Frank* and *Survival Clayton*. Whereas *Normal* and *Frank* have symmetric tail dependence, *Clayton* and *Survival Clayton* have lower and upper tail dependence, respectively.
First we chose a set of parameters [using *iRho* from *Copula* package] for each type of copula for which spearman correlation will be $10$ equispaced number in between [$0,0.9$]. Then for each parameter (or spearman value) of each type of copula we carried out $100$ simulation and calculated $(Corl , Coru, Pl, Pu, D2l, D2u)$ stats. We took mean of our statistic $Corl-Coru$, $Pl-Pu$ and $D2u-D2l$ over $100$ simulations and In Figure \ref{fig_stat_testing35}, we plotted those statistic against spearman correlation. We put the standard error bar around each point in the plot and these errors got minimized with increasing numbe of data points [Figure \ref{fig_stat_testing1000}]. Statistic $Corl - Coru$, $Pl-Pu$ and $D2u-D2l$ should be $0$ for spearman=$0$ for *Clayton* and *Survival Clayton* and should remain $0$ for all values of spearman for symmetric copula like *Normal* and *Frank*. To verify this, we executed t-test and report the $p$-values for each case and most of the case shows $p>0.05$.

```{r stat_testing_save_result, message=F, warning=F, echo=F, cache=T, cache.extra=list(seed,mtime("TestStats_multivar_dataset.R"))}
set.seed(seed)

resultsloc<-"./Results/stat_results/stat_testing/"
callfn<-coplist_with_params(spearvals=seq(from=0,to=0.9,by=0.1))
coplist<-callfn$coplist
ncores<-3
res_pt35_rankF<-mclapply(X=coplist,FUN=worker,numpts=35,numsims=100,rank=F,mc.cores=ncores)
res_pt35_rankT<-mclapply(X=coplist,FUN=worker,numpts=35,numsims=100,rank=T,mc.cores=ncores)
res_pt1000_rankF<-mclapply(X=coplist,FUN=worker,numpts=1000,numsims=100,rank=F,mc.cores=ncores)
res_pt1000_rankT<-mclapply(X=coplist,FUN=worker,numpts=1000,numsims=100,rank=T,mc.cores=ncores)
save(res_pt35_rankF,res_pt35_rankT,res_pt1000_rankF,res_pt1000_rankT,file=paste(resultsloc,"StatTestNumericResults.RData",sep=''))
```

```{r stat_testing_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,callfn,mtime("StatTestNumericResults.RData"))}
set.seed(seed)
resultsloc<-"./Results/stat_results/stat_testing/"
b<-callfn$paramlist
plotter_stat_testing(res_pt35_rankF,"res_pt35_rankF",b)
plotter_stat_testing(res_pt35_rankT,"res_pt35_rankT",b)
plotter_stat_testing(res_pt1000_rankF,"res_pt1000_rankF",b)
plotter_stat_testing(res_pt1000_rankT,"res_pt1000_rankT",b)
```

![stat_testing_results_datapt_35\label{fig_stat_testing35}](./Results/stat_results/stat_testing/res_pt35_rankT.pdf)

![stat_testing_results_datapt_1000\label{fig_stat_testing1000}](./Results/stat_results/stat_testing/res_pt1000_rankT.pdf)

## Soil C and N data

### Model selection approach
<!--This does the computations for this section-->
```{r bivmodselect_Loecke, echo=F, cache=T, cache.extra=list(seed,v_CN,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"))}
set.seed(seed)
families_Loecke<-c(1,3:10,13:14,16:20) 
BivMS_res_Loecke<-OurBiCopSelect(u1=v_CN[,1],u2=v_CN[,2],families=families_Loecke,level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,gofnormal=F,status=F)
```

<!--Display model selection results in a table-->
```{r tab_soilCNfit,echo=F,results='markup'}
h<-BivMS_res_Loecke$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
knitr::kable(h,
             format='pandoc',
             caption = "Fitting info for soil C and N dataset. Here and henceforth copula names are abbreviated as: N=normal (Gaussian); C=Clayton; G=Gumbel; F=Frank; J=Joe; SC=Survival Clayton; SG=Survival Gumbel; SJ=Survival Joe. An S in front of one of the copulas BB1, BB6, BB7, BB8 indicates the survival version of that copula (rotation by 180 degrees).\\label{tab_soilCNfit}",
             booktabs=T)
```


The test of indepedence gave $p=$ `r BivMS_res_Loecke$IndepTestRes`. We fitted several copulas
and got AIC values and upper- and lower-tail dependency estimates based on the fitted copulas (Table \ref{tab_soilCNfit}). The table shows that several copulas are much better supported (higher AIC and BIC weights) than the Gaussian copula, answering the first part of question 1 for these data.

The model-averaged (AIC weights used for model averaging) lower-tail dependence statistic was `r BivMS_res_Loecke$relLTdep_AICw` and the model-averaged upper-tail dependence statistic was `r BivMS_res_Loecke$relUTdep_AICw`. These values are distinct from what a Gaussian copula would give (i.e., 0), answering the second part of question 1 for these data. Furthermore, the difference of these two quantities (lower minus upper), `r BivMS_res_Loecke$relLTdep_AICw-BivMS_res_Loecke$relUTdep_AICw`, was different from 0, answering the third part of question 1. 

Although these results do convincingly show non-Gaussian copula structure, we should take the tail dependence results with a grain of salt because even the lowest-AIC copula was a poor fit, giving $p$-value `r BivMS_res_Loecke$GofRes_CvM` in the Cramer-von Mises-based test of the goodness of its fit, and $p$-value `r BivMS_res_Loecke$GofRes_KS` in the Kolmogorov-Smirnov-based test of the goodness of fit. The next section looks at tail dependence in a non-parametric way.

### Non-parametric analysis of tail dependence
<!--Do the intensive part of the analysis, calculating stats on the data and surrogates-->
```{r stat_soilCN_graphic_approach, echo=F, cache=T, cache.extra=list(seed,v_CN,mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
set.seed(seed) 

#utility function for calculating all the stats we want
calcstats<-function(v,f,nm)
{
  #calculate the stats
  res<-c()
  for (lbd in seq(from=0,to=0.9,by=0.1))
  {
    res<-c(res,f(v[,1],v[,2],lbd,lbd+.1))
  }
  
  #name the result vector
  h<-paste(nm,c(seq(from=0,to=0.9,by=0.1)),"to",
                    c(seq(from=0,to=0.9,by=0.1)+.1),sep='')
  h<-gsub(".","p",h,fixed=T)
  names(res)<-h
    
  return(res)
}

#Do the kendall surrogates
cop<-normalCopula(.5,2)
numsurrog<-1000
surv_K<-copsurrog2d(v_CN,cop,"kendall",numsurrog)

#Do the spearman surrogates
surv_S<-copsurrog2d(v_CN,cop,"spearman",numsurrog)

#utility function for calculating fractions of surrogates 
#with a stat smaller than that of data, i.e., fraction of 
#surrogates for which the stat value on the data is bigger
fracwork<-function(dvals,surrvals)
{
  frac<-NA*numeric(length(dvals))
  names(frac)<-names(dvals)
  for (counter in 1:length(frac))
  {
    frac[counter]<-sum(surrvals[counter,]<dvals[counter])
  }
  return(frac)
}

#now work with the correlation stats
corstats_d<-calcstats(v_CN,Corbds,"Cor")
corstats_K<-apply(FUN=calcstats,X=surv_K,MARGIN=3,f=Corbds,nm="Cor")
corstats_frac_K<-fracwork(corstats_d,corstats_K)

corlmcoru_d<-unname(corstats_d[1]-corstats_d[length(corstats_d)])
corlmcoru_K<-corstats_K[1,]-corstats_K[length(corstats_d),]
corlmcoru_frac_K<-sum(corlmcoru_K<corlmcoru_d)
corstats_K<-apply(FUN=quantile,X=corstats_K,MARGIN=1,prob=c(.005,0.25,.975,.995))

corstats_S<-apply(FUN=calcstats,X=surv_S,MARGIN=3,f=Corbds,nm="Cor")
corstats_frac_S<-fracwork(corstats_d,corstats_S)

corlmcoru_S<-corstats_S[1,]-corstats_S[length(corlmcoru_d),]
corlmcoru_frac_S<-sum(corlmcoru_S<corlmcoru_d)
corstats_S<-apply(FUN=quantile,X=corstats_S,MARGIN=1,prob=c(.005,0.25,.975,.995))

#now work with the P stats
Pbds_wrap<-function(vi,vj,lb,ub)
{
  return(Pbds(vi,vj,lb,ub)$abs_res)
}

Pstats_d<-calcstats(v_CN,Pbds_wrap,"P")
Pstats_K<-apply(FUN=calcstats,X=surv_K,MARGIN=3,f=Pbds_wrap,nm="P")
Pstats_frac_K<-fracwork(Pstats_d,Pstats_K)

PlmPu_d<-unname(Pstats_d[1]-Pstats_d[length(Pstats_d)])
PlmPu_K<-Pstats_K[1,]-Pstats_K[length(Pstats_d),]
PlmPu_frac_K<-sum(PlmPu_K<PlmPu_d)
Pstats_K<-apply(FUN=quantile,X=Pstats_K,MARGIN=1,prob=c(.005,0.25,.975,.995))

Pstats_S<-apply(FUN=calcstats,X=surv_S,MARGIN=3,f=Pbds_wrap,nm="P")
Pstats_frac_S<-fracwork(Pstats_d,Pstats_S)

PlmPu_S<-Pstats_S[1,]-Pstats_S[length(Pstats_d),]
PlmPu_frac_S<-sum(PlmPu_S<PlmPu_d)
Pstats_S<-apply(FUN=quantile,X=Pstats_S,MARGIN=1,prob=c(.005,0.25,.975,.995))

#now work with the D2 stats
D2stats_d<-calcstats(v_CN,D2bds,"Dtwo")
D2stats_K<-apply(FUN=calcstats,X=surv_K,MARGIN=3,f=D2bds,nm="Dtwo")
D2stats_frac_K<-fracwork(D2stats_d,D2stats_K)

D2umD2l_d<-D2stats_d[length(D2stats_d)]-D2stats_d[1]
D2umD2l_K<-D2stats_K[length(D2stats_d),]-D2stats_K[1,]
D2umD2l_frac_K<-sum(D2umD2l_K<D2umD2l_d)
D2stats_K<-apply(FUN=quantile,X=D2stats_K,MARGIN=1,prob=c(.005,0.25,.975,.995))

D2stats_S<-apply(FUN=calcstats,X=surv_S,MARGIN=3,f=D2bds,nm="Dtwo")
D2stats_frac_S<-fracwork(D2stats_d,D2stats_S)

D2umD2l_S<-D2stats_S[length(D2stats_d),]-D2stats_S[1,]
D2umD2l_frac_S<-sum(D2umD2l_S<D2umD2l_d)
D2stats_S<-apply(FUN=quantile,X=D2stats_S,MARGIN=1,prob=c(.005,0.25,.975,.995))
```

<!--Now create the plot and save it to the results folder-->
```{r plot_soilCN_graphic_approach, results='hide', echo=F}
x<-seq(from=0.05,to=0.95,by=0.1)
xlimits<-c(0,1)

#plotting layout, units inches
xht<-0.5
ywd<-0.5
titleht<-.25
panht<-1.5
panwd<-3
gap<-.05
totwd<-ywd+2*panwd+2*gap
totht<-xht+3*panht+3*gap+titleht
pdf(file="./Results/stat_results/stat_soilCN/CNdata_NonparamTailDep.pdf",width=totwd,height=totht)
  
#plot kendall results on the left panels, spearman on right,
#cor in top panels, then P, then D2 on bottom panels

#kendall, cor
par(fig=c(ywd/totwd,
          (ywd+panwd)/totwd,
          (xht+2*panht+2*gap)/totht,
          (xht+3*panht+2*gap)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25)
ylimits_cor<-range(corstats_d,corstats_K,corstats_K)
ylimits_cor[2]<-ylimits_cor[2]+.3*diff(ylimits_cor)
plot(x,corstats_d,type='l',col="red",xlim=xlimits,ylim=ylimits_cor,
     xaxt='n')
mtext(side=3,line=0,text="Kendall-preserving surrogates")
mtext(side=2,line=1,text="Partial correlation")
axis(side=1,labels=F)
lines(x,corstats_K[1,],type='l',lty='dotted')
lines(x,corstats_K[2,],type='l',lty='dashed')
lines(x,corstats_K[3,],type='l',lty='dashed')
lines(x,corstats_K[4,],type='l',lty='dotted')
text(xlimits[1],ylimits_cor[1],labels='A',cex=1.5,adj=c(.5,0))
fracplot<-function(fracs,ylims)
{
  for (counter in 1:length(fracs))
  {
    ptxt<-''
    if (fracs[counter]>.975*numsurrog)
    {
      ptxt<-paste(">",fracs[counter],sep='')
    } 
    if (fracs[counter]<.025*numsurrog)
    {
      ptxt<-paste("<",numsurrog-fracs[counter],sep='')
    }
    yht<-ylims[2]-.1*diff(ylims)
    text(x[counter],yht,ptxt,adj=c(0.5,.5),cex=0.5,srt=90)
  }
}
fracplot(corstats_frac_K,ylimits_cor)
vlineplot<-function(x,ylims)
{
  for (counter in 1:length(x))
  {
    lines(rep(x[counter]-(x[2]-x[1])/2,2),ylims,type='l',lty='dotted')
  }
  lines(rep(x[length(x)]+(x[2]-x[1])/2,2),ylims,type='l',lty='dotted')
}
vlineplot(x,ylimits_cor)

#spearman, cor
par(fig=c((ywd+panwd+gap)/totwd,
          (ywd+2*panwd+gap)/totwd,
          (xht+2*panht+2*gap)/totht,
          (xht+3*panht+2*gap)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25,new=T)
plot(x,corstats_d,type='l',col="red",xlim=xlimits,ylim=ylimits_cor,
     xaxt='n',yaxt='n')
mtext(side=3,line=0,text="Spearman-preserving surrogates")
axis(side=1,labels=F)
axis(side=2,labels=F)
lines(x,corstats_S[1,],type='l',lty='dotted')
lines(x,corstats_S[2,],type='l',lty='dashed')
lines(x,corstats_S[3,],type='l',lty='dashed')
lines(x,corstats_S[4,],type='l',lty='dotted')
text(xlimits[1],ylimits_cor[1],labels='B',cex=1.5,adj=c(.5,0))
fracplot(corstats_frac_S,ylimits_cor)
vlineplot(x,ylimits_cor)

#kendall, P
par(fig=c(ywd/totwd,
          (ywd+panwd)/totwd,
          (xht+panht+gap)/totht,
          (xht+2*panht+gap)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25,new=T)
ylimits_D2<-range(D2stats_d,D2stats_K,D2stats_K)
ylimits_D2[2]<-ylimits_D2[2]+.3*diff(ylimits_D2)
ylimits_P<-range(Pstats_d,Pstats_K,Pstats_K)
ylimits_P[2]<-ylimits_P[2]+.3*diff(ylimits_P)
plot(x,Pstats_d,type='l',col="red",xlim=xlimits,ylim=ylimits_P,xaxt='n')
axis(side=1,labels=F)
mtext(side=2,line=1,text="P")
lines(x,Pstats_K[1,],type='l',lty='dotted')
lines(x,Pstats_K[2,],type='l',lty='dashed')
lines(x,Pstats_K[3,],type='l',lty='dashed')
lines(x,Pstats_K[4,],type='l',lty='dotted')
text(xlimits[1],ylimits_P[1],labels='C',cex=1.5,adj=c(.5,0))
fracplot(Pstats_frac_K,ylimits_P)
vlineplot(x,ylimits_P)

#spearman, p
par(fig=c((ywd+panwd+gap)/totwd,
          (ywd+2*panwd+gap)/totwd,
          (xht+panht+gap)/totht,
          (xht+2*panht+gap)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25,new=T)
plot(x,Pstats_d,type='l',col="red",xlim=xlimits,ylim=ylimits_P,
     xaxt='n',yaxt='n')
axis(side=1,labels=F)
axis(side=2,labels=F)
lines(x,Pstats_S[1,],type='l',lty='dotted')
lines(x,Pstats_S[2,],type='l',lty='dashed')
lines(x,Pstats_S[3,],type='l',lty='dashed')
lines(x,Pstats_S[4,],type='l',lty='dotted')
text(xlimits[1],ylimits_P[1],labels='D',cex=1.5,adj=c(.5,0))
fracplot(Pstats_frac_S,ylimits_P)
vlineplot(x,ylimits_P)

#kendall, D2
par(fig=c(ywd/totwd,
          (ywd+panwd)/totwd,
          (xht)/totht,
          (xht+panht)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25,new=T)
plot(x,D2stats_d,type='l',col="red",xlim=xlimits,ylim=ylimits_D2)
mtext(side=1,line=1,text="Diagonal slice")
mtext(side=2,line=1,text=expression(D[2]))
axis(side=1,labels=F)
lines(x,D2stats_K[1,],type='l',lty='dotted')
lines(x,D2stats_K[2,],type='l',lty='dashed')
lines(x,D2stats_K[3,],type='l',lty='dashed')
lines(x,D2stats_K[4,],type='l',lty='dotted')
text(xlimits[1],ylimits_D2[1],labels='E',cex=1.5,adj=c(.5,0))
fracplot(D2stats_frac_K,ylimits_D2)
vlineplot(x,ylimits_D2)

#spearman, P
par(fig=c((ywd+panwd+gap)/totwd,
          (ywd+2*panwd+gap)/totwd,
          (xht)/totht,
          (xht+panht)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25,new=T)
plot(x,D2stats_d,type='l',col="red",xlim=xlimits,ylim=ylimits_D2,
     yaxt='n')
mtext(side=1,line=1,text="Diagonal slice")
axis(side=1,labels=F)
axis(side=2,labels=F)
lines(x,D2stats_S[1,],type='l',lty='dotted')
lines(x,D2stats_S[2,],type='l',lty='dashed')
lines(x,D2stats_S[3,],type='l',lty='dashed')
lines(x,D2stats_S[4,],type='l',lty='dotted')
text(xlimits[1],ylimits_D2[1],labels='F',cex=1.5,adj=c(.5,0))
fracplot(D2stats_frac_S,ylimits_D2)
vlineplot(x,ylimits_D2)

dev.off()
```

![Nonparametric tests for tail dependence and other deviations from a normal copula for soil C and N data. As described in Methods, each statistic was computed on the data using the ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (red lines), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (dashed lines show 0.025 and 0.975 quantiles of these results and dotted lines show 0.005 and 0.995 quantiles).  When red lines were outside dashed lines, text at the top of plots indicates how many surrogate values the data value was less than or greater than.\label{fig_soilCN_nonparam}](./Results/stat_results/stat_soilCN/CNdata_NonparamTailDep.pdf)

<!--Now make and display a table, this one about asymmetry of tail dependence-->
```{r plot_soilCN_asymmtry_taildep, echo=F}
atdres<-data.frame(Statistic=c("Corl-Coru","Pl-Pu","D2u-D2l"),
                   Kendall=rep("",3),
                   Spearman=rep("",3),stringsAsFactors = F)
fractxt<-function(fracval)
{
  ptxt<-''
  if (fracval>.5*numsurrog)
  {
    ptxt<-paste(">",fracval,sep='')
  } 
  if (fracval<=.5*numsurrog)
  {
    ptxt<-paste("<",numsurrog-fracval,sep='')
  }
  return(ptxt)
}
atdres[1,2]<-fractxt(corlmcoru_frac_K)
atdres[1,3]<-fractxt(corlmcoru_frac_S)
atdres[2,2]<-fractxt(PlmPu_frac_K)
atdres[2,3]<-fractxt(PlmPu_frac_S)
atdres[3,2]<-fractxt(D2umD2l_frac_K)
atdres[3,3]<-fractxt(D2umD2l_frac_S)
```

```{r tab_soilCN_asym, echo=F, results="markup"}
knitr::kable(atdres,
             format="pandoc",
             caption = "Results for tests of whether asymmetry of tail dependence is significant compared to a normal-copula null hypothesis. Three statistics are listed in the left column that measured asymmetry of tail dependence by comparing the ranges $0-0.1$ and $0.9-1$ (Methods). One thousand Kendall-preserving and 1000 Spearman-preserving surrogates were created, and the same statistics were computed for the surrogates. A table entry $<N$ indicates the value of the given statistic on the data was less than its value on $N$ of the surrogates.\\label{tab_soilCN_asym}",
             booktabs=T)
```

As described in Methods, each of our statistics, as computed for the 
ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$, was compared to the distributions 
of values of the same statistic with the same ranges computed on 1000 normal-copula 
surrogate datasets with similar Kendall or Spearman correlations, in different 
runs (Figure \ref{fig_soilCN_nonparam}). Because the correlation 
used in the Cor statistic is the Spearman correlation, Spearman-preserving surrogates
should be used, so the top-left panel of Figure \ref{fig_soilCN_nonparam}
should be ignored (DAN: need to fix this later). Results indicate that tail dependence of 
data is stronger in both the lower and upper tails than would be expected under a 
null hypothesis of a normal copula. The dependence between C and N is also 
weaker in the middle of both marginal distributions
than would be expected based on a normal-copula null model.

We also tested statistically for asymmetry of tail dependence, which seems visible in Figure \ref{fig_soilCNcop}. 
Results (Table \ref{tab_soilCN_asym}) show that upper-tail dependence was, indeed, significantly stronger than lower-tail dependence in these data.

## Aphid abundance data for 'Green spruce aphid'
<!--Add common and species name to header-->

### Model selection approach


```{r read_aphid_data, echo=F}
# Aphid raw data for count
d0_count<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtscount141117.csv",header=F))
data_aphid_count<-d_allsp_data(d0_count)     
 
# Aphid raw data for first flight
d0_firstflight<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsfirstflight141117.csv",header=F))
data_aphid_ff<-d_allsp_data(d0_firstflight) 

# Aphid raw data for flight duration   
#d0_flightduration<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsflightduration141117.csv",header=F))

```

```{r RES_aphid_count, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("FittingCopula_selective_loc.R"))}
set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_aphid_count<-RES_single_sp(d_allsp=data_aphid_count,sp=10,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30)
#cat(paste("stop-time: ",Sys.time(),"\n"))
resloc<-"./Results/fitting_results/"
saveRDS(RES_aphid_count,paste(resloc,file="AphidCopulaFit_selecloc_count_species_10.RDS",sep=""))
```

```{r read_RES_aphid_count, echo=F}
RES_aphid_count<-readRDS("./Results/fitting_results/AphidCopulaFit_selecloc_count_species_10.RDS")
```

<!--\newpage-->

```{r tab_count_bestcop, echo=F, results='markup'}
knitr::kable(RES_aphid_count$info_ord_copname[,,1], 
             format='pandoc',
             caption = "Aphid_count : best fit copula family for each selective location pair\\label{tab_count_bestcop}",
             booktabs=TRUE
             )
```

```{r tab_count_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$info_ord_AICw[,,1], 
             format='pandoc',
             caption = "Aphid_count : AICw for best fit copula family for each selective location pair\\label{tab_count_AICw}",
             booktabs=TRUE
             )
```

```{r tab_count_p_CvM, echo=F, results='markup'}
knitr::kable(RES_aphid_count$gfc_p_CvM,
             format='pandoc',
             caption = "Aphid_count : p-values (Cramer-von Mises-based test) for lowest AIC based best fit copula\\label{tab_count_p_CvM}",
             booktabs=TRUE
             )
```

```{r tab_count_p_KS, echo=F, results='markup'}
knitr::kable(RES_aphid_count$gfc_p_KS,
             format='pandoc',
             caption = "Aphid_count : p-values (Kolmogorov-Smirnov-based test) for lowest AIC based best fit copula\\label{tab_count_p_KS}",
             booktabs=TRUE
             )
```

```{r tab_count_AICw_normal, echo=F, results='markup'}
knitr::kable(normal_cop_AICw_matrix(r=RES_aphid_count),
             format='pandoc',
             caption = "Aphid_count : AICw for 'Normal' copula family for each selective location pair\\label{tab_count_AICw_normal}",
             booktabs=TRUE
             )
```

```{r tab_count_LTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$LTdep_AICw,
             format='pandoc',
             caption = "Aphid_count : model averaged lower tail dependence statistic for best fit copula family for each selective location pair\\label{tab_count_LTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_count_UTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$UTdep_AICw,
             format='pandoc',
             caption = "Aphid_count : model averaged upper tail dependence statistic for best fit copula family for each selective location pair\\label{tab_count_UTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_count_LTmUT, echo=F, results='markup'}
knitr::kable(RES_aphid_count$LTdep_AICw-RES_aphid_count$UTdep_AICw,
             digits = 5,
             format='pandoc',
             caption = "Aphid_count : model averaged lower tail dependence statistic for best fit copula family for each selective location pair\\label{tab_count_LTmUT}",
             booktabs=TRUE
             )
```

Table \ref{tab_count_bestcop} shows that several copulas are much better supported than the Gaussian copula, answering the first part of question 1 for these data. Table \ref{tab_count_AICw} represents the Akaike weights of the best-fit copula for each location pair. Our fitting results are supported by the lowest-AIC copula *p*-value in the Cramer-von Mises-based test [Table \ref{tab_count_p_CvM}] of the goodness of its fit, and in the Kolmogorov-Smirnov-based test [Table \ref{tab_count_p_KS}] of the goodness of fit with atleast
`r min((RES_aphid_count$gfc_numBS_success/RES_aphid_count$gfc_numBS),na.rm=T)*100` % successful bootstrap. Table \ref{tab_count_AICw_normal} represents the Akaike weights of the normal copula for each location pair and by comparing with Table \ref{tab_count_AICw}, one can verify that for most of the locations a normal copula is not a good fit based on minimum AIC. The model-averaged (using AIC) lower-tail dependence statistic and the model-averaged (again, AIC based) upper-tail dependence statistic are presented in Table \ref{tab_count_LTdep_AICw} and Table \ref{tab_count_UTdep_AICw} respectively, and these values are distinct from what a Gaussian copula would give (i.e., 0), answering the second part of question 1 for these data. Furthermore, the difference of these two quantities (lower minus upper) in Table \ref{tab_count_LTmUT} indicates it is different from $0$ for most of the locations, answering the third part of question 1. These results do convincingly show non-Gaussian copula structure, having **`r sum((RES_aphid_count$LTdep_AICw-RES_aphid_count$UTdep_AICw)>0,na.rm=T)`** out of **`r (dim(RES_aphid_count$gfc_p_CvM)[1]^2-dim(RES_aphid_count$gfc_p_CvM)[1])-RES_aphid_count$num_indep_loc_pair`** location pair with greater lower tail dependence. 

The next section looks at tail dependence in a non-parametric way.

### Non-paramtric analysis of tail dependence

```{r stat_aphid_count, echo=F, cache=T, cache.extra=list(seed,data_aphid_count)}
set.seed(seed) 
resloc<-"./Results/stat_results/stat_aphid_count/"

sp<-10
good_loc <- good_loclist(d_allsp=data_aphid_count,sp=sp,data_pt_thrs=30)
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_count<-multcall(d_allsp=data_aphid_count,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc)
saveRDS(stat_aphid_count,paste(resloc,file="stat_aphid_count_sp_10.RDS",sep='')) 
```

```{r read_stat_aphid_count,echo=F}
stat_aphid_count<-readRDS("./Results/stat_results/stat_aphid_count/stat_aphid_count_sp_10.RDS")
```

```{r tab_count_resamp,echo=F,results="markup"}
knitr::kable(stat_aphid_count$numericdf,
             format = "pandoc",
             caption = "Aphid_count : resampling result for stat indicating lower tail dependence\\label{tab_count_resamp}",
             booktabs=TRUE)
```

![copula plot for aphid-count\label{fig_count_allcop}](./Results/stat_results/stat_aphid_count/Sp_10_AllCops.pdf)

![Plot for aphid-count : Spearman vs. Distance\label{fig_count_spear}](./Results/stat_results/stat_aphid_count/Sp_10_Spearman_vs_D.pdf){ width=50%, height=50% }

![Plot for aphid-count : Kendall vs. Distance\label{fig_count_kend}](./Results/stat_results/stat_aphid_count/Sp_10_Kendall_vs_D.pdf){ width=50%, height=50% }

![Corl-Coru vs. Distance plot for aphid-count showing lower tail dependence\label{fig_count_Corl-Coru}](./Results/stat_results/stat_aphid_count/Sp_10_Corl-Coru_vs_D.pdf){ width=50%, height=50% }

![Pl-Pu vs. Distance plot for aphid-count showing lower tail dependence\label{fig_count_Pl-Pu}](./Results/stat_results/stat_aphid_count/Sp_10_Pl-Pu_vs_D.pdf){ width=50%, height=50% }

![D2u-D2l vs. Distance plot for aphid-count showing lower tail dependence\label{fig_count_D2u-D2l}](./Results/stat_results/stat_aphid_count/Sp_10_D2u-D2l_vs_D.pdf){ width=50%, height=50% }

Table \ref{tab_count_resamp} shows the mean of each non-parametric statistic taken from all pairwise locations and then based on a resampling results how the resampled mean distributed from or around the real mean. Fourth column named $fracgt0$ in Table \ref{tab_count_resamp} indicates the fraction of resampled mean greater then zero. $Corl-Coru$, $Pl-Pu$ and $D2u-D2l$ statistic with positive mean and almost $100$% $fracgt0$ proves that *Green spruce aphid*-count data has significant lower tail dependence.

## Aphid first flight data for 'Leaf-curling plum aphid' 
<!--Add species common name and scientific name to header-->

### Model selection approach

```{r RES_aphid_ff, echo=F, cache=T, cache.extra=list(seed,data_aphid_ff,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("FittingCopula_selective_loc.R"))} 
set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n"))
RES_aphid_ff<-RES_single_sp(d_allsp=data_aphid_ff,sp=11,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30)
#cat(paste("stop-time: ",Sys.time(),"\n")) 
resloc<-"./Results/fitting_results/"
saveRDS(RES_aphid_ff,paste(resloc,file="AphidCopulaFit_selecloc_firstflight_species_11.RDS",sep=""))
```

```{r read_RES_aphid_ff,echo=F}
RES_aphid_ff<-readRDS("./Results/fitting_results/AphidCopulaFit_selecloc_firstflight_species_11.RDS")
```

<!--\newpage-->

```{r tab_ff_bestcop, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$info_ord_copname[,,1], 
             format='pandoc',
             caption = "Aphid_firstflight : best fit copula family for each selective location pair\\label{tab_ff_bestcop}",
             booktabs=TRUE
             )
```

\newpage
```{r tab_ff_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$info_ord_AICw[,,1], 
             format='pandoc',
             caption = "Aphid_firstflight : AICw for best fit copula family for each selective location pair\\label{tab_ff_AICw}",
             booktabs=TRUE
             )
```

```{r tab_ff_p_CvM, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$gfc_p_CvM,
             format='pandoc',
             caption = "Aphid_firstflight : p-values (Cramer-von Mises-based test) for lowest AIC based best fit copula\\label{tab_ff_p_CvM}",
             booktabs=TRUE
             )
```

```{r tab_ff_p_KS, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$gfc_p_KS,
             format='pandoc',
             caption = "Aphid_firstflight : p-values (Kolmogorov-Smirnov-based test) for lowest AIC based best fit copula\\label{tab_ff_p_KS}",
             booktabs=TRUE
             )
```

```{r tab_ff_AICw_normal, echo=F, results='markup'}
knitr::kable(normal_cop_AICw_matrix(r=RES_aphid_ff),
             format='pandoc',
             caption = "Aphid_firstflight : AICw for 'Normal' copula family for each selective location pair\\label{tab_ff_AICw_normal}",
             booktabs=TRUE
             )
```

```{r tab_ff_LTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$LTdep_AICw,
             format='pandoc',
             caption = "Aphid_firstflight : model averaged lower tail dependence statistic for best fit copula family for each selective location pair\\label{tab_ff_LTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_ff_UTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$UTdep_AICw,
             format='pandoc',
             caption = "Aphid_firstflight : model averaged upper tail dependence statistic for best fit copula family for each selective location pair\\label{tab_ff_UTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_ff_LTmUT, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$LTdep_AICw-RES_aphid_ff$UTdep_AICw,
             digits = 5,
             format='pandoc',
             caption = "Aphid_firstflight : model averaged lower tail dependence statistic for best fit copula family for each selective location pair\\label{tab_ff_LTmUT}",
             booktabs=TRUE
             )
```

Table \ref{tab_ff_bestcop} shows that several copulas are much better supported than the Gaussian copula, answering the first part of question 1 for these data. Table \ref{tab_ff_AICw} represents the Akaike weights of the best-fit copula for each location pair. Our fitting results are supported by the lowest-AIC copula *p*-value in the Cramer-von Mises-based test [Table \ref{tab_ff_p_CvM}] of the goodness of its fit, and in the Kolmogorov-Smirnov-based test [Table \ref{tab_ff_p_KS}] of the goodness of fit with atleast
`r min((RES_aphid_ff$gfc_numBS_success/RES_aphid_ff$gfc_numBS),na.rm=T)*100` % successful bootstrap. Table \ref{tab_ff_AICw_normal} represents the Akaike weights of the normal copula for each location pair and by comparing with Table \ref{tab_ff_AICw}, one can verify that for most of the locations a normal copula is not a good fit based on minimum AIC. The model-averaged (using AIC) lower-tail dependence statistic and the model-averaged (again, AIC based) upper-tail dependence statistic are presented in Table \ref{tab_ff_LTdep_AICw} and Table \ref{tab_ff_UTdep_AICw} respectively, and these values are distinct from what a Gaussian copula would give (i.e., 0), answering the second part of question 1 for these data. Furthermore, the difference of these two quantities (lower minus upper) in Table \ref{tab_ff_LTmUT} indicates it is different from $0$ for most of the locations, answering the third part of question 1. These results do convincingly show non-Gaussian copula structure, having **`r sum((RES_aphid_ff$LTdep_AICw-RES_aphid_ff$UTdep_AICw)<0,na.rm=T)`** out of **`r (dim(RES_aphid_ff$gfc_p_CvM)[1]^2-dim(RES_aphid_ff$gfc_p_CvM)[1])-RES_aphid_ff$num_indep_loc_pair`** location pair more upper tail dependence. 

### Non-parametric analysis of tail dependence

```{r stat_aphid_ff, echo=F, cache=T, cache.extra=list(seed,data_aphid_ff)}
set.seed(seed)
resloc<-"./Results/stat_results/stat_aphid_ff/"

sp<-11
good_loc<-good_loclist(d_allsp=data_aphid_ff,sp=sp,data_pt_thrs=30)
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_ff<-multcall(d_allsp=data_aphid_ff,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc) 
saveRDS(stat_aphid_ff,paste(resloc,file="stat_aphid_ff_sp_11.RDS",sep='')) 
```

```{r read_stat_aphid_ff,echo=F}
stat_aphid_ff<-readRDS("./Results/stat_results/stat_aphid_ff/stat_aphid_ff_sp_11.RDS")
```

```{r tab_ff_resamp,echo=F,results="markup"}
knitr::kable(stat_aphid_ff$numericdf,
             format = "pandoc",
             caption = "Aphid_firstflight : resampling result for stat indicating upper tail dependence\\label{tab_ff_resamp}",
             booktabs=TRUE)
```

![copula plot for aphid-firstflight\label{fig_ff_allcop}](./Results/stat_results/stat_aphid_ff/Sp_11_AllCops.pdf)

![Plot for aphid-firstflight : Spearman vs. Distance\label{fig_ff_spear}](./Results/stat_results/stat_aphid_ff/Sp_11_Spearman_vs_D.pdf){ width=50%, height=50% }

![Plot for aphid-firstflight : Kendall vs. Distance\label{fig_ff_kend}](./Results/stat_results/stat_aphid_ff/Sp_11_Kendall_vs_D.pdf){ width=50%, height=50% }

![Corl-Coru vs. Distance plot for aphid-firstflight showing upper tail dependence\label{fig_ff_Corl-Coru}](./Results/stat_results/stat_aphid_ff/Sp_11_Corl-Coru_vs_D.pdf){ width=50%, height=50% }

![Pl-Pu vs. Distance plot for aphid-firstflight showing upper tail dependence\label{fig_ff_Pl-Pu}](./Results/stat_results/stat_aphid_ff/Sp_11_Pl-Pu_vs_D.pdf){ width=50%, height=50% }

![D2u-D2l vs. Distance plot for aphid-firstflight showing upper tail dependence\label{fig_ff_D2u-D2l}](./Results/stat_results/stat_aphid_ff/Sp_11_D2u-D2l_vs_D.pdf){ width=50%, height=50% }

Table \ref{tab_ff_resamp} shows the mean of each non-parametric statistic taken from all pairwise locations and then based on a resampling results how the resampled mean distributed from or around the real mean. Fourth column named $fracgt0$ in Table \ref{tab_ff_resamp} indicates the fraction of resampled mean greater then zero. $Corl-Coru$, $Pl-Pu$ and $D2u-D2l$ statistic with negative mean has all resampled mean less than $0$ for *Leaf-curling plum aphid*-firstflight data. This proves that there is a significant upper tail dependence in *Leaf-curling plum aphid*-firstflight data.

## North sea plankton data for 'Ceratium furca'

<!--Shya to edit the prentation below to make it more parallel to the presentation of the model selection results for C/N data above-->

### Model selection approach

```{r read_plankton_north_sea_data, echo=F}
d0_plankton_north_sea<-as.matrix(read.csv("./Data/Plankton_North_Sea_data/planktontimeseries201117_4.csv",header=F))
data_plankton_north_sea<-d_allsp_data_plankton_north_sea(d0_plankton_north_sea)
``` 

```{r RES_plankton_north_sea, echo=F, cache=T, cache.extra=list(seed,data_plankton_north_sea,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"), mtime("FittingCopula_selective_loc.R"))}

set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_plankton_north_sea<-RES_single_sp(d_allsp=data_plankton_north_sea,sp=16,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=45)
#cat(paste("stop-time: ",Sys.time(),"\n"))    
resloc<-"./Results/fitting_results/"
saveRDS(RES_plankton_north_sea,paste(resloc,file="Plankton_North_Sea_CopulaFit_selecloc_species_16.RDS",sep=""))
```

```{r read_RES_plankton_north_sea,echo=F}
RES_plankton_north_sea<-readRDS("./Results/fitting_results/Plankton_North_Sea_CopulaFit_selecloc_species_16.RDS")
```

<!--\newpage-->
```{r tab_pns_bestcop, echo=F, results='markup'}
knitr::kable(RES_plankton_north_sea$info_ord_copname[,,1],
             format='pandoc',
             caption = "Plankton_north_sea : Best fit copula family for each selective location pair\\label{tab_pns_bestcop}",
             booktabs=TRUE
             )
```

\newpage
```{r tab_pns_AICw,echo=F,results="markup"}
knitr::kable(RES_plankton_north_sea$info_ord_AICw[,,1],
             format="pandoc",
             digits=3,
             caption = "Plankton_north_sea : AICw for best fit copula family for each selective location pair\\label{tab_pns_AICw}",
             booktabs=TRUE)
```

```{r tab_pns_p_CvM,echo=F,results="markup"}
knitr::kable(RES_plankton_north_sea$gfc_p_CvM,
             format="pandoc",
             digits=3,
             caption = "Plankton_north_sea : p-values (Cramer-von Mises-based test) for lowest AIC based best fit copula\\label{tab_pns_p_CvM}",
             booktabs=TRUE)
```

<!--\newpage-->
```{r tab_pns_p_KS,echo=F,results="markup"}
knitr::kable(RES_plankton_north_sea$gfc_p_KS,
             format="pandoc",
             digits=3,
             caption = "Plankton_north_sea : p-values (Kolmogorov-Smirnov-based test) for lowest AIC based best fit copula\\label{tab_pns_p_KS}",
             booktabs=TRUE)
```

```{r tab_pns_AICw_normal,echo=F,results="markup"}
knitr::kable(normal_cop_AICw_matrix(r=RES_plankton_north_sea),
             format="pandoc",
             digits=3,
             caption = "Plankton_north_sea : AICw for 'Normal' copula family for each selective location pair\\label{tab_pns_AICw_normal}",
             booktabs=TRUE)
```

```{r tab_pns_LTdep_AICw,echo=F,results="markup"}
knitr::kable(RES_plankton_north_sea$LTdep_AICw,
             format="pandoc",
             digits=3,
             caption = "Plankton_north_sea : model averaged lower tail dependence statistic for best fit copula family for each selective location pair\\label{tab_pns_LTdep_AICw}",
             booktabs=TRUE)
```

```{r tab_pns_UTdep_AICw,echo=F,results="markup"}
knitr::kable(RES_plankton_north_sea$UTdep_AICw,
             format="pandoc",
             digits=3,
             caption = "Plankton_north_sea : model averaged upper tail dependence statistic for best fit copula family for each selective location pair\\label{tab_pns_UTdep_AICw}",
             booktabs=TRUE)
```

<!--\newpage-->

```{r tab_pns_LTmUT,echo=F,results="markup"}
knitr::kable(RES_plankton_north_sea$LTdep_AICw-RES_plankton_north_sea$UTdep_AICw,
             format="pandoc",
             digits=3,
             caption = "Plankton_north_sea : model averaged lower tail - model averaged upper tail dependence statistic for best fit copula family for each of the selective location pair\\label{tab_pns_LTmUT}",
             booktabs=TRUE)
```

Table \ref{tab_pns_bestcop} shows that several copulas are much better supported than the Gaussian copula, answering the first part of question 1 for these data. Table \ref{tab_pns_AICw} represents the Akaike weights of the best-fit copula for each location pair. Our fitting results are supported by the lowest-AIC copula *p*-value in the Cramer-von Mises-based test [Table \ref{tab_pns_p_CvM}] of the goodness of its fit, and in the Kolmogorov-Smirnov-based test [Table \ref{tab_pns_p_KS}] of the goodness of fit with atleast
`r min((RES_plankton_north_sea$gfc_numBS_success/RES_plankton_north_sea$gfc_numBS),na.rm=T)*100` % successful bootstrap. Table \ref{tab_pns_AICw_normal} represents the Akaike weights of the normal copula for each location pair and by comparing with Table \ref{tab_pns_AICw}, one can verify that for most of the locations a normal copula is not a good fit based on minimum AIC. The model-averaged (using AIC) lower-tail dependence statistic and the model-averaged (again, AIC based) upper-tail dependence statistic are presented in Table \ref{tab_pns_LTdep_AICw} and Table \ref{tab_pns_UTdep_AICw} respectively, and these values are distinct from what a Gaussian copula would give (i.e., 0), answering the second part of question 1 for these data. Furthermore, the difference of these two quantities (lower minus upper) in Table \ref{tab_pns_LTmUT} indicates it is different from $0$ for most of the locations, answering the third part of question 1. These results do convincingly show non-Gaussian copula structure, having `r sum((RES_plankton_north_sea$LTdep_AICw-RES_plankton_north_sea$UTdep_AICw)>0,na.rm=T)` out of `r (dim(RES_plankton_north_sea$gfc_p_CvM)[1]^2-dim(RES_plankton_north_sea$gfc_p_CvM)[1])-RES_plankton_north_sea$num_indep_loc_pair` location pair more lower tail dependence. 


### Non-paramtric analysis of tail dependence
```{r stat_plankton_north_sea, echo=F, cache=T, cache.extra=list(seed,data_plankton_north_sea)}
set.seed(seed)
resloc<-"./Results/stat_results/stat_plankton_north_sea/"

sp<-16
good_loc<-good_loclist(d_allsp=data_plankton_north_sea,sp=sp,data_pt_thrs=45)
longs<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlongs201117.csv",header=F)
lats<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlats201117.csv",header=F)
longs<-longs[[1]] 
lats<-lats[[1]]

stat_plankton_north_sea<-multcall(d_allsp=data_plankton_north_sea,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc) 
saveRDS(stat_plankton_north_sea,paste(resloc,file="stat_plankton_north_sea_sp_16.RDS",sep=''))
```

```{r read_stat_plankton_north_sea,echo=F}
stat_plankton_north_sea<-readRDS("./Results/stat_results/stat_plankton_north_sea/stat_plankton_north_sea_sp_16.RDS")
```

```{r tab_pns_resamp,echo=F,results="markup"}
knitr::kable(stat_plankton_north_sea$numericdf,
             format = "pandoc",
             caption = "Plankton_north_sea : resampling result for stat indicating lower tail dependence\\label{tab_pns_resamp}",
             booktabs=TRUE)
```

![copula plot for Plankton_north_sea\label{fig_pns_allcop}](./Results/stat_results/stat_plankton_north_sea/Sp_16_AllCops.pdf)

![Plot for Plankton_north_sea : Spearman vs. Distance\label{fig_pns_spear}](./Results/stat_results/stat_plankton_north_sea/Sp_16_Spearman_vs_D.pdf){ width=50%, height=50% }

![Plot for Plankton_north_sea : Kendall vs. Distance\label{fig_pns_kend}](./Results/stat_results/stat_plankton_north_sea/Sp_16_Kendall_vs_D.pdf){ width=50%, height=50% }

![Corl-Coru vs. Distance plot for Plankton_north_sea showing lower tail dependence\label{fig_pns_Corl-Coru}](./Results/stat_results/stat_plankton_north_sea/Sp_16_Corl-Coru_vs_D.pdf){ width=50%, height=50% }

![Pl-Pu vs. Distance plot for Plankton_north_sea showing lower tail dependence\label{fig_pns_Pl-Pu}](./Results/stat_results/stat_plankton_north_sea/Sp_16_Pl-Pu_vs_D.pdf){ width=50%, height=50% }

![D2u-D2l vs. Distance plot for Plankton_north_sea showing lower tail dependence\label{fig_pns_D2u-D2l}](./Results/stat_results/stat_plankton_north_sea/Sp_16_D2u-D2l_vs_D.pdf){ width=50%, height=50% }

Table \ref{tab_pns_resamp} shows the mean of each non-parametric statistic taken from all pairwise locations and then based on a resampling results how the resampled mean distributed from or around the real mean. Fourth column named $fracgt0$ in Table \ref{tab_pns_resamp} indicates the fraction of resampled mean greater then zero. $Corl-Coru$, $Pl-Pu$ and $D2u-D2l$ statistic with positive mean and almost $100$% $fracgt0$ proves that plankton species data for *Ceratium furca* has significant lower tail dependence.

# Question 2 analyses for each dataset

# Question 3 analyses for each dataset

Recall question 3 is: What are the consequences of non-Gaussian copula structure and tail dependence for our understanding of biology and for applications?

**Change of skewness : ** Here, we claim that because of significant tail dependence of the multivariate copula structure, the skewness of the time-series data averaged over all selective locations changed significantly from the individual skewness of time-series data taken at each pairwise location. Spatial mean of the time series data extracts that tail dependence of the multivariate data set, if any, and reflected in the averaged skewness. We tested this with null hypothesis $H_{0}$. If $H_{0}$ is true that means our multivariate copula actually came from normal copula structure with no tail dependence and thus should have the same skewness as of normal copula. So, first we generated $10000$ number of surrogate normal copula from our given multivariate copula keeping the marginal distribution and the correlation (spearman or kendall) same. Then we plotted the distribution of spatial mean of each surrogate time series data set and the given multivariate data. If $p$-value is less than $0.05$, then we reject the null hypothesis in support of significant tail dependence.

To verify that we use aphid-count data, aphid-firstflight data and plankton-north-sea data. For aphid data we choose only those locations for which atleast $30$ number of data points present in each time series when taken as pairwise locations. For plankton-north-sea data that threshold on number of data points is $45$. 

## Aphid count

Figure \ref{fig_skewness_count} shows that averaged skewness is much lower than expected if the aphid count data came from a normal copula. Here, $p$ value indicates the fraction of surrogate-skewness which are lower than the averaged skewness of the given data (red line in Figure \ref{fig_skewness_count}). As $p<0.05$, we reject $H_{0}$. This result is consistent with the non-parametric analysis and model fitting results which indicated lower tail dependence. 

<!--Shya to add results about skewness of spatial means-->
```{r skewness_count_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,mtime("ncsurrog.R"),mtime("skewness_multivar_dataset.R"))}
set.seed(seed)
pdf("./Results/skewness_results/skewness_aphid_count/skewness_aphid_count_sp_10.pdf")
par(mfrow=c(2,1))
numsurrog<-10000
loclist<-good_loclist(d_allsp=data_aphid_count,sp=10,data_pt_thrs=30)
answer1k<-skewness_testing(ts_matrix=sp_data(sp=10,d_allsp=data_aphid_count),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="kendall") 

p_left<-sum(answer1k$surrogskw < answer1k$realskw)/numsurrog

mtext(paste0("(A) result based on kendall preserving normal surrogates, p = ",p_left),side=3,line=0.2,col="navyblue")

answer1s<-skewness_testing(ts_matrix=sp_data(sp=10,d_allsp=data_aphid_count),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="spearman") 

p_left<-sum(answer1s$surrogskw < answer1s$realskw)/numsurrog

mtext(paste0("(B) result based on spearman preserving normal surrogates , p = ",p_left),side=3,line=0.2,col="navyblue")


dev.off()
```

![Skewness_count for species : Green spruce aphid\label{fig_skewness_count}](./Results/skewness_results/skewness_aphid_count/skewness_aphid_count_sp_10.pdf){ width=50%, height=50% }


## Aphid first flight

Figure \ref{fig_skewness_ff} shows that averaged skewness is much higher than expected if the aphid first flight data came from a normal copula. Here, $p$ value indicates the fraction of surrogate-skewness which are greater than the averaged skewness of the given data (red line in Figure \ref{fig_skewness_ff}). As $p<0.05$, we reject $H_{0}$ in support for upper tail dependence. 

<!--Shya to add results about skewness of spatial means-->
```{r skewness_ff_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,mtime("ncsurrog.R"),mtime("skewness_multivar_dataset.R"))}
set.seed(seed)
pdf("./Results/skewness_results/skewness_aphid_ff/skewness_aphid_ff_sp_11.pdf")
par(mfrow=c(2,1))
numsurrog<-10000
loclist<-good_loclist(d_allsp=data_aphid_ff,sp=11,data_pt_thrs=30)

answer2k<-skewness_testing(ts_matrix=sp_data(sp=11,d_allsp=data_aphid_ff),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="kendall") 
p_right<-sum(answer2k$surrogskw > answer2k$realskw)/numsurrog
mtext(paste0("(A) result based on kendall preserving normal surrogates, p = ",p_right),side=3,line=0.2,col="navyblue")

answer2s<-skewness_testing(ts_matrix=sp_data(sp=11,d_allsp=data_aphid_ff),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="spearman") 
p_right<-sum(answer2s$surrogskw > answer2s$realskw)/numsurrog
mtext(paste0("(B) result based on spearman preserving normal surrogates , p = ",p_right),side=3,line=0.2,col="navyblue")

dev.off()
```

![Skewness_firstflight for species : Leaf-curling plum aphid\label{fig_skewness_ff}](./Results/skewness_results/skewness_aphid_ff/skewness_aphid_ff_sp_11.pdf){ width=50%, height=50% }

## North Sea plankton

Figure \ref{fig_skewness_pns} shows that averaged skewness is lower than expected if the plankton north sea data came from a normal copula. Our previous results on non-parametric analysis and model fitting showed lower tail dependence. Here, as $p>0.05$, we cannot reject $H_{0}$, .......???

```{r skewness_pns_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,mtime("ncsurrog.R"),mtime("skewness_multivar_dataset.R"))}
set.seed(seed)
pdf("./Results/skewness_results/skewness_plankton_north_sea/skewness_plankton_north_sea_sp_16.pdf")
par(mfrow=c(2,1))
numsurrog<-10000
loclist<-good_loclist(d_allsp=data_plankton_north_sea,sp=16,data_pt_thrs=45)
answer3k<-skewness_testing(ts_matrix=sp_data(sp=16,d_allsp=data_plankton_north_sea),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="kendall") 

p_left<-sum(answer3k$surrogskw < answer3k$realskw)/numsurrog

mtext(paste0("(A) result based on kendall preserving normal surrogates, p = ",p_left),side=3,line=0.2,col="navyblue")

answer3s<-skewness_testing(ts_matrix=sp_data(sp=16,d_allsp=data_plankton_north_sea),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="spearman") 

p_left<-sum(answer3s$surrogskw < answer3s$realskw)/numsurrog

mtext(paste0("(B) result based on spearman preserving normal surrogates , p = ",p_left),side=3,line=0.2,col="navyblue")

dev.off()
```

![Skewness_plankton_north_sea for species : Ceratium_furca\label{fig_skewness_pns}](./Results/skewness_results/skewness_plankton_north_sea/skewness_plankton_north_sea_sp_16.pdf){ width=50%, height=50% }
