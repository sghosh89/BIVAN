---
title: "Supporting Information : The importance of a complete statistical description of dependence between variables for ecology and related fields"
author: "S. Ghosh, T. Loecke, C.P. Reid, D.C. Reuman"
date: "February 12, 2018"
geometry: "left=1cm,right=1cm,top=2.5cm,bottom=2.8cm"

output: 
  pdf_document:
    number_sections: yes
    keep_tex: yes
    fig_caption: yes
    includes:
      in_header: head_supp.sty
      
tables: True
link-citations: True
urlcolor : blue

csl: ecology-letters.csl
bibliography: REF_ALL.bib
---

\tableofcontents
\listoftables
\listoffigures

updated on `r Sys.Date()`
\pagebreak

<!--Basic setup-->
```{r setup, echo=F}
knitr::opts_chunk$set(echo = TRUE, fig.pos = "H")
seed<-101
# families<-c(1,3:10,13,14,16:20)
source("mtime.R") #A function needed for caching
```

```{r cop_pedag_fig,echo=F,results="hide"}
set.seed(seed)
library(VineCopula)
f<-function(par,destau,desLTmUT,fam){
  cop<-BiCop(family=fam,par=par[1],par2=par[2])
  tau<-cop$tau 
  LT<-cop$taildep$lower
  UT<-cop$taildep$upper
  LTmUT<-LT-UT
  z<-(tau-destau)^2
  z<-z+(LTmUT-desLTmUT)^2
  return(z)
}

pdf("./Results/copula_pedagog_fig_BB1.pdf",height=8,width=20)
op<-par(mfrow=c(2,5),mar=c(3,3,3,3), mgp=c(1.5,0.5,0))

desLTmUT_vector<-c(-0.4,-0.2,0,0.2,0.4)
#parlist<-list(c(0.2,1.5),c(0.2,1.1),c(0.2,1.5),c(0.5,1.1),c(0.5,1.5))
#for(i in 1:length(desLTmUT_vector)){
#  print(i)
#  iLmU<-desLTmUT_vector[i]
#  call_optim<-optim(par=parlist[[i]],fn=f,destau=0.4,desLTmUT=iLmU,fam=7,method = "BFGS")
#  call_optim$par
#  c<-BiCopSim(N=500,family=7,par=call_optim$par[1],par2=call_optim$par[2])
#  plot(c[,1],c[,2],col="blue",xlab="u",ylab="v",cex.lab=2,cex.axis=1.5)
#  mtext(paste0("tau = 0.4", ", LTmUT = ",iLmU,sep=""),side=3)
#}

for(i in desLTmUT_vector){
  # print(i)
  destau<-0.5
  call_optim<-optim(par=c(0.2,1.5),fn=f,destau=destau,desLTmUT=i,fam=7,method = "BFGS")
  obj<-BiCop(family=7,par=call_optim$par[1],par2=call_optim$par[2])
  c<-BiCopSim(N=500,obj)
  plot(c[,1],c[,2],col="blue",xlab="u",ylab="v",cex.lab=2,cex.axis=1.5)
  mtext(paste0("tau = ",round(obj$tau,5),", ( LT - UT ) = ",round((obj$taildep$lower - obj$taildep$upper),5),sep=""),side=3)
  legend("topleft",paste0("UT=",round(obj$taildep$upper,5)),bty="n",cex=1.5,text.col="magenta")
  legend("bottomright",paste0("LT=",round(obj$taildep$lower,5)),bty="n",cex=1.5,text.col="magenta")
}

for(i in desLTmUT_vector){
 # print(i)
  destau<-0.8
 call_optim<-optim(par=c(0.2,1.5),fn=f,destau=destau,desLTmUT=i,fam=7,method = "BFGS")
 obj<-BiCop(family=7,par=call_optim$par[1],par2=call_optim$par[2])
 c<-BiCopSim(N=500,obj)
 plot(c[,1],c[,2],col="red",xlab="u",ylab="v",cex.lab=2,cex.axis=1.5)
 mtext(paste0("tau = ",round(obj$tau,5),", ( LT - UT ) = ",round((obj$taildep$lower - obj$taildep$upper),5),sep=""),side=3)
 legend("topleft",paste0("UT=",round(obj$taildep$upper,5)),bty="n",cex=1.5,text.col="magenta")
 legend("bottomright",paste0("LT=",round(obj$taildep$lower,5)),bty="n",cex=1.5,text.col="magenta")
}

par(op)
dev.off()
```

<!--The raw data look like this:-->
```{r load_data_Loecke, echo=F, results='hide'}
#fig.cap="Plot of the raw soil C and N data.\\label{fig_raw_cop_soilCN}(A)", fig.height=3, fig.width=3}
d<-readRDS("Data/RaCA_soilorganicC_soiltotalN_stocks100cm.RDS")
d<-d[,c("SOCstock100","TSNstock100")]
pdf("./Results/SoilCNraw.pdf")
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(d[,1],d[,2],type="p",col="red",xlab="Soil C",ylab="Soil N",cex.lab=1.5,cex.axis=1.5)
par(op)
dev.off()
```

<!--The copula looks like this:-->
```{r rankandplot_Loecke, echo=F, results='hide'}
source("getcopula.R")
#convert to a copula and plot
pdf("./Results/SoilCNcop.pdf")
v_CN<-getcopula(d=d,rankon=T,ploton=T) 
dev.off()
```

```{r read_BMR_data, echo=FALSE, results="markup"}
set.seed(seed)
#---------------------------------------------------------
BMR_dat<-read.csv("./Data/BMR/bmr-contrasts.csv",header = T)
#class(BMR_dat)
#knitr::kable(head(BMR_dat[,c(1,4,5)] ,3),format='pandoc',
#             caption = "First few rows of raw BMR data.\\label{tab_rawdata_BMR}",
#             booktabs=T) # display first few rows
```

```{r plot_BMR_data, echo=FALSE, results="hide"}
set.seed(seed)
source("phylo_dat_fn.R")

# Generating raw data plot btw ln(mass) and BMR from bmr-contrasts.csv
pdf("./Results/BMR_results/rawdataplot_lnBMR_vs_lnmass.pdf")
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(BMR_dat$ln.mass,BMR_dat$ln.BMR,type="p",col="red",xlab="ln(mass) of contrasts",ylab="ln(BMR) of contrasts",
     cex.lab=1.5,cex.axis=1.5)
par(op)
dev.off()
#--------------------------------------------------------------------------------------------
# Generating copula plot btw ln(mass) and ln(BMR) from bmr-contrasts.csv
pdf("./Results/BMR_results/copula_lnBMR_vs_lnmass.pdf")
v_BMR<-phylo_dat_fn(data=BMR_dat,i=4,j=3,ploton = T) 
#plot(v_BMR[,1],v_BMR[,2],type="p",col="red",xlab="ln(mass)",ylab="BMR",
#     cex.lab=1.5,cex.axis=1.5)
dev.off()
```

```{r read_phylo_data, echo=F, results="markup"}
set.seed(seed)
phylo_dat<-read.csv("./Data/Anolis/contrasts.csv",header = T)
#class(phylo_dat) #it's a data.frame : no NA/missing value in this dataset
#tab_phylo<-phylo_dat[,c(1,7,8)] 
#knitr::kable(head(tab_phylo,3),format='pandoc',
#             caption = "First few rows of raw phylo data.\\label{tab_rawdata_phylo}",
#             booktabs=T) # display first few rows
```

```{r plot_phylo_data, echo=F, results="hide"}
set.seed(seed)
source("phylo_dat_fn.R")
#----------------------------------------------------------------------------------------------------
# Generating all copula plots between different pathlength and traits 
pdf("./Results/Anolis_results/contrasts_csv_results/contrasts_csv_pathlength_traits_cop_plot.pdf",width=20, height = 20)
op<-par(mfrow=c(4,4))
i<-1
  for(j in c(1:13)){
    v_phylo<-phylo_dat_fn(data=phylo_dat,i=i,j=j,ploton = T)
    mtext(paste0(" [",i,",",j,"] ", ","," n=",dim(v_phylo)[1]),side = 3,col="blue")
  } 
par(op)
dev.off()
#------------------------------------------------------------------------------------------------------------
# Generating all 12 by 12 copula plots between different traits
pdf("./Results/Anolis_results/contrasts_csv_results/contrasts_csv_btw_traits_cop_plot.pdf",width=20, height = 20)
op<-par(mfrow=c(12,12))
for(i in c(2:13)){
  for(j in c(2:13)){
    v_phylo<-phylo_dat_fn(data=phylo_dat,i=i,j=j,ploton = T)
    mtext(paste0(" [",i,",",j,"] ", ","," n=",dim(v_phylo)[1]),side = 4,col="blue",line=0.01)
  } 
}
par(op)
dev.off()
#----------------------------------------------------------------------------------------
# Generating raw data plot btw AVG.ltoe.IV and AVG.humerus from contrasts.csv
pdf("./Results/Anolis_results/contrasts_csv_results/rawdataplot_AVG_ltoe_humerus.pdf")
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(phylo_dat$AVG.ltoe.IV,phylo_dat$AVG.humerus,type="p",col="red",xlab="contrasts for AVG.ltoe.IV",ylab="contrasts for AVG.humerus",
     cex.lab=1.5,cex.axis=1.5)
par(op)
dev.off()
#--------------------------------------------------------------------------------------------
# Generating copula plot btw AVG.ltoe.IV and AVG.humerus from contrasts.csv
pdf("./Results/Anolis_results/contrasts_csv_results/copula_AVG_ltoe_humerus.pdf")
v_contrasts_67<-phylo_dat_fn(data=phylo_dat,i=6,j=7,ploton = T)
dev.off()
```

```{r read_ceder_creek_data, echo=F, results="hide"}
set.seed(seed)
#-------------------------------------------------
# This function takes 
# Input :
#       db : a dataframe : smaller subset of ple_120 data to calculate avg. biomass for each plot
#       dp : a dataframe : smaller subset of pce_120 data to calculate avg. shannon's H for those plots
#       year : the year for which you want to calculate biomass and shannon's index data
#       rawplot : logical : T for rawdata plot, F for copula plot
#       ploton : logical for optional plotting

# Output :
#       a list of two data-frame:
#                   tab_dbp : a data-frame with 3 column : (plot no , avg.H, avg.Biomass(g/m2))
#                   cop_tab_dbp : a data-frame with 3 column : (plot no, pobs(avg.H), pobs(avg.Biomass(g/m2)))

cop_HB<-function(db,dp,year,rawplot,ploton){
  # db : biomass dataset for a specific year
  # dp : percent cover dataset for a specific year
  
  plots<-sort(intersect(db$Plot,dp$Plot)) # common plots for both datasets for a specific year
  db<-subset(db,Plot%in%plots)
  dp<-subset(dp,Plot%in%plots)
  
  
  tab_dbp<-data.frame(Plot=plots,avg.H=NA,avg.Biomass=NA)
  for(i in 1:length(plots)){
    # calculate biomass for each plot (averaged over all strips for that plot)
    x<-subset(db,Plot==plots[i])
    tab_dbp$avg.Biomass[i]<-mean(x$Biomass) 
    
    # calculate shannon's index H for each plot (averaged over all Quadrates for that plot)
    x<-subset(dp,Plot==plots[i])
    uniq_sp<-sort(as.character(unique(x$Species)))  # These are the species in a particular plot
    Q<-as.character(unique(x$Quadrat))
    
    tab_each_sp<-data.frame(sp=uniq_sp,avg_cov=0,rel_avg_cov=0)
    
    for(sp in 1:length(uniq_sp)){
      my_sp<-uniq_sp[sp]
      tab_temp<-data.frame(Q=Q,abs_cov=0)
      ind<-which(x$Species==my_sp)
      li<-length(ind)
      tab_temp$abs_cov[1:li]<-x$Abscover[ind]
      tab_each_sp$avg_cov[[sp]]<-mean(tab_temp$abs_cov) # avg. over 4Quadrates for a sp.
    }
    
    tab_each_sp$rel_avg_cov<-tab_each_sp$avg_cov/sum(tab_each_sp$avg_cov)
    tab_dbp$avg.H[i]<- -sum((tab_each_sp$rel_avg_cov)*log(tab_each_sp$rel_avg_cov))

  }
  
  tab_dbp<-na.omit(tab_dbp)
  
  cop_tab_dbp<-data.frame(Plot=tab_dbp$Plot,avg.H=NA,avg.Biomass=NA)
  cop_tab_dbp$avg.H<-VineCopula::pobs(tab_dbp$avg.H)
  cop_tab_dbp$avg.Biomass<-VineCopula::pobs(tab_dbp$avg.Biomass)
  
  
  if(ploton==T){
    if(rawplot==T){
      op<-par(mar=c(5.1, 4.1, 1.5, 2.1))
      plot(tab_dbp$avg.H,tab_dbp$avg.Biomass,xlab="avg.H",ylab="avg.Biomass",col="red",pch=1,cex.lab=1.6,cex.axis=1.5)
      mtext(paste0("Year=",year),cex=1.5)
      par(op)
    }else{
      op<-par(mar=c(5.1, 4.1, 1.5, 2.1))
      plot(cop_tab_dbp$avg.H,cop_tab_dbp$avg.Biomass,xlab="u",ylab="v",col="red",pch=1,cex.lab=2,cex.axis=1.5,
         xlim=c(0,1),ylim=c(0,1),asp=1)
      rect(0,0,1,1)
      lines(c(0,1),c(0,1),type='l')
      mtext(paste0("Year=",year),cex=1.5)
      par(op)
    }
  }
  
  return(list(tab_dbp=tab_dbp,
         cop_tab_dbp=cop_tab_dbp))
}
#-----------------------------
r_ple<-read.delim("./Data/Ceder_creek_e120/edited_ple120.txt")
names(r_ple)[36]<-"Biomass"

r_pce<-read.delim("./Data/Ceder_creek_e120/edited_pce120.txt")

y1<-unique(r_ple$Year)
y2<-unique(r_pce$Year)
yr<-sort(intersect(y1,y2))

a<-as.data.frame(table(sort(r_pce$Species)))
b<-as.character(a$Var1)
bad_sp<-c(b[51:53],b[156:158])

ind<-which(r_pce$Species%in%bad_sp)
r_pce_clean<-r_pce[-ind,]
#--------------------------------------------------------------------------------------------
pdf("./Results/Ceder_creek_results/raw_HB_all_yr.pdf",height = 6,width = 10)
op<-par(mfrow=c(2,3),mar=c(3,3,3,3), mgp=c(1.5,0.5,0))
for(i in 1:length(yr)){
  db<-subset(r_ple,Year==yr[i])
  dp<-subset(r_pce_clean,Year==yr[i])
  
  sr<-cop_HB(db=db,dp=dp,year=yr[i],rawplot=T,ploton = T)
}
par(op)
dev.off()
#-----------------------
#raw data plot for year2000
pdf("./Results/Ceder_creek_results/raw_HB_2000.pdf",height = 6,width = 6)
i<-5
db<-subset(r_ple,Year==yr[i])
dp<-subset(r_pce_clean,Year==yr[i])
sr<-cop_HB(db=db,dp=dp,year=yr[i],rawplot=T,ploton = T)
dev.off()
#----------------------------------------------------------------------------------------
cop_HB_all_yr<-vector("list",length(yr))
names(cop_HB_all_yr)<-yr

pdf("./Results/Ceder_creek_results/cop_HB_all_yr.pdf",height = 6,width = 10)
op<-par(mfrow=c(2,3),mar=c(3,3,3,3), mgp=c(1.5,0.5,0))
for(i in 1:length(yr)){
  db<-subset(r_ple,Year==yr[i])
  dp<-subset(r_pce_clean,Year==yr[i])
  
  s<-cop_HB(db=db,dp=dp,year=yr[i],rawplot=F,ploton = T)
  cop_HB_all_yr[[i]]<-s$cop_tab_dbp[,2:3]
}
par(op)
dev.off()
#-------------------------
#cop data plot for year2000
pdf("./Results/Ceder_creek_results/cop_HB_2000.pdf",height = 6,width = 6)
i<-5
db<-subset(r_ple,Year==yr[i])
dp<-subset(r_pce_clean,Year==yr[i])
s<-cop_HB(db=db,dp=dp,year=yr[i],rawplot=F,ploton = T)
cc_cop_2000<-s$cop_tab_dbp[,2:3]
dev.off()
#------------------

saveRDS(cop_HB_all_yr,"./Results/Ceder_creek_results/cop_HB_all_yr.RDS")
#---------------------------------------------------------------------------------------
cop_HB_all_yr<-readRDS("./Results/Ceder_creek_results/cop_HB_all_yr.RDS")
```

```{r map_plot_aphid_plankton,results="hide",echo=F}
source("aphid_data_calling.R")
source("good_loclist.R")
library(maps)

#----------------- Aphid map--------------------------------------------
d0_count<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtscount141117.csv",header=F))
data_aphid_count<-d_allsp_data(d0_count)

d0_firstflight<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsfirstflight141117.csv",header=F))
data_aphid_ff<-d_allsp_data(d0_firstflight)

selective_loc1<-good_loclist(d_allsp=data_aphid_count,sp=10,data_pt_thrs=30)
selective_loc2<-good_loclist(d_allsp=data_aphid_ff,sp=11,data_pt_thrs=30)
all(selective_loc1==selective_loc2)==T

longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

locno<-length(longs)
df_loc_info_org<-data.frame(loc_no=c(1:length(lats)),longs=longs,lats=lats)
df_loc_info<-df_loc_info_org[selective_loc1,]
xlim=c(-10,2)
ylim=c(50, 60)

pdf("./Results/aphid_map_plot.pdf")
map("world", fill=TRUE, col="grey84", bg="white",border=0, xlim=xlim, ylim=ylim)
map.axes(cex.axis=2.5)
points(x = df_loc_info_org$longs, y = df_loc_info_org$lats, col="red",pch=16)
points(x = df_loc_info$longs, y = df_loc_info$lats, col="blue", pch=0, cex=1.5)
text(df_loc_info_org$loc_no, x = df_loc_info_org$longs, y = df_loc_info_org$lats, col="red",  pos=1)
dev.off()

#--------------Plankton map----------------------------

source("plankton_north_sea_data_calling.R")
d0_plankton_north_sea<-as.matrix(read.csv("./Data/Plankton_North_Sea_data/planktontimeseries201117_4.csv",header=F))
data_plankton_north_sea<-d_allsp_data_plankton_north_sea(d0_plankton_north_sea)

longs<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlongs201117.csv",header=F)
lats<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlats201117.csv",header=F)
longs<-longs[[1]]
lats<-lats[[1]]

df_loc_info_org<-data.frame(loc_no=c(1:length(lats)),longs=longs,lats=lats)
selective_loc<-good_loclist(d_allsp=data_plankton_north_sea,sp=16,data_pt_thrs=45)
df_loc_info<-df_loc_info_org[selective_loc,]
xlim=c(-12,10)
ylim=c(48, 60)

pdf("./Results/plankton_map_plot.pdf")
map("world", fill=TRUE, col="grey84", bg="white",border=0, xlim=xlim, ylim=ylim)
map.axes(cex.axis=2.5)
abline(h=seq(from=ylim[1],to=ylim[2],by=2), v=seq(from=xlim[1],to=xlim[2],by=2), col="black", lty=2)
points(x = df_loc_info_org$longs+1, y = df_loc_info_org$lats+1, col="red",pch=16)
points(x = df_loc_info$longs+1, y = df_loc_info$lats+1, col="blue", pch=0, cex=1.5)
text(df_loc_info_org$loc_no, x = df_loc_info_org$longs+1, y = df_loc_info_org$lats+1, col="red",  pos=1)
dev.off()
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=8 cm,height=8 cm]{./Results/aphid_map_plot.pdf} 
\caption{Locations of Rothamsted Insect Survey suction-trap across UK are indicated by the red circles 
out of which only blue boxes are considered for our study based on having atleast 30 annual data points. \label{fig_aphid_map}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=8 cm,height=8 cm]{./Results/plankton_map_plot.pdf} 
\caption{CPR data collected from 26 locations ($2^{\circ}$ $\times$ $2^{\circ}$ on map) around UK sea (indicated by the red circles) but out of which only blue boxes are considered for our study based on having atleast 45 annual data points. \label{fig_plankton_map}}
\end{center}
\end{figure}

<!--
## Methane-flux data  \label{Methane_data}

Methane ($CH_{4}$) fluxes between the soil or water surface and the troposphere were measured at the
Great Miami Wetland Mitigation Bank ($36^{\circ}46^{'}51^{''}$ N, $84^{\circ}20^{'}26^{''}$ W) in Trotwood, Montgomery County, Ohio. Additional information on the history of the site and soil types is detailed in @Jarecke2016. Briefly, the closed static flux chamber method was used [@Holland1999] to measure $CH_{4}$ fluxes at 28 locations across a hydrologic gradient (upland to seasonal wetland) at
daily to weekly interval from September 2015 to September 2016. **See and Smyth et al, pending for
additional details???** on greenhouse gas flux methods for this site.

* We threw out all locations that had fewer than 50 dates data.-->

```{r read_methane_data, echo=F, results="markup"}
set.seed(seed)
methane_raw<-readRDS("./Data/Methane_data/methane_data_for_Shyamolina.rds")
#class(methane_raw) #it's a data.frame for multivariable data
#knitr::kable(head(methane_raw,3),format='pandoc',
#             caption = "First few rows of raw methane data.\\label{tab_rawdata_methane}",
#             booktabs=T) # display first few rows
```

# Description of Data \label{Data_detailed}

For bivariate analysis we used four datasets which are briefly described as follows;
First, to explore the dependence of **soil organic C** and total **soil N** across a wide geographic range (conterminous US), ecosystem type, and traceable methodology we used the RaCA (Rapid Carbon Assessment)
database [@Wills2014, **or Wills and Loecke pending???**]. Specifically, the soil organic C and total soil N
stocks (Mg C or N m$^{-2}$ ) to 1m of soil depth from the central pedon of the 5930 sites were included in this
study.

Next, the [**BMR data**](https://github.com/sghosh89/BIVAN/blob/master/Data/BMR/bmr-contrasts.csv) contains the trait contrasts from phylogenetically independent contrasts [@SukumaranH2010] of data reported by [@GenoudIM2017] on the basal metabolic rate (BMR) and mass of mammals species. Specifically, the "SELECT" BMR data in their database were used for those species for which data were available. A phylogeny in NEXUS [@NEXUS] format was extracted from the supplementary information of [@GenoudIM2017]. Version 4.4.0 of the DendroPy library [@SukumaranH2010] was used to calculate phylogenetic independent contrasts using Python 2.7. For each contrast, the path length spanned by the contrast (sum of the branch lengths) and the contrast for the mass, natural logarithm of the BMR and natural logarithm of the mass were written as a row in the [bmr-contrasts.csv](https://github.com/sghosh89/BIVAN/blob/master/Data/BMR/bmr-contrasts.csv) file. 

[**Third dataset**](https://github.com/sghosh89/BIVAN/blob/master/Data/Anolis/contrasts.csv) was a raw data on measurements of anatomical features of several species of *Anolis* lizards, which was downloaded
from the Dryad data package [@MahlerIRL2013Data] associated with [@MahlerIRL2013].
The [contrasts.csv file](https://github.com/sghosh89/BIVAN/blob/master/Data/Anolis/contrasts.csv) was produced by using version 4.4.0 of the DendroPy library [@SukumaranH2010]  to calculate phylogenetic independent contrasts on the the data in the GA_Anolis_traits.csv file of Mahler et at. using their maximum clade credibility tree (GA_Anolis_MCC.nex) as the phylogeny.

Absolute values of traits for each contrast are considered to construct corresponding copula for second and third datasets.

Fourth, we used **Ceder-creek data for e120** which resulted from a biodiversity experiment, carried out by Tilman and his co-warkers [@Tilman2001; @Tilman2006] over many years to collect [plant above ground biomass](https://www.cedarcreek.umn.edu/research/data/dataset?ple120) and [plant species percent cover](https://www.cedarcreek.umn.edu/research/data/dataset?pce120) data. These datasets were used to calculate plant-aboveground biomass and Shannon's diversity index (H), averaged over each plot (9m by 9m),
for year 2000. 

<!--The raw data and copula for each four datasets are shown along each column of Figure \ref{MT-fig_biv_raw_cop}.-->

Similarly, we applied multivariate analysis on four datasets; first two data sets [for aphid-count and aphid-firstflight date] were extracted from the Rothamsted Insect Survey suction-trap data [@Macaulay1988, @Harrington2014]. These two annual timesries (1976-2010) measurements are from 11 locations acroos UK for 20 aphid species. We used the same data format as used by @Sheppard2016 for their analysis on the impact of climate on aphids' spatial synchrony. In our case, we chose species=10 [Name : "Green spruce aphid"] for aphid-abundance data and species=11 [Name : "Leaf-curling plum aphid"] for aphid-firstflight data and considered only those locations which had atleast 30 years of data (see Figure \ref{fig_aphid_map}). 

<!--Figure \ref{MT-fig_aphid_raw_cop} represents raw and copula data plot for aphid count ("Green spruce aphid") and aphid-firstflight date ("Leaf-curling plum aphid") taken from two locations.-->

Our third dataset for multivariate analysis is a plankton-count data collected at 26 locations over the areas of the North Sea and British seas for 22 species and for 56 years (1958-2013). These data were obtained from the Continuous Plankton Recorder (CPR) data set and maintained by the Sir Alistair Hardy Foundation for Ocean Science (SAHFOS). The CPR is a device which is towed across the ocean behind a ship, filtering plankton from seawater with a continuously
unwinding silk ribbon. The ribbon was cut into 4 inch segments, each corresponding to a particular time and
location in the ocean. Organisms were identified and counted (possibly with sub-sampling) microscopically [@Colebrook1979]. All the samples available for a given variable in a given area in a given month of a given year were
averaged, producing a monthly time series for each year. Where data for a given month was unavailable the missing value was replaced with a median value for that month (drawn from all years in which data was available). Monthly values were converted to yearly values by averaging over all months. This approach was used by [@Sheppard2017] earlier. But here we only allowed maximum 4 months in a year with missing data which were replaced by those medians. If a year got 5 or more missing monthly data value then we set NA value for that particular year. We used data for species=16 [Name : "Ceratium furca"] which is a dicoflagellate commonly found in UK seas. Among 26 locations, only those having atleast 45 years time series data, were considered (see Figure \ref{fig_plankton_map}).

Finally, methane ($CH_{4}$) fluxes between the soil or water surface and the troposphere were measured at the
Great Miami Wetland Mitigation Bank ($36^{\circ}46^{'}51^{''}$ N, $84^{\circ}20^{'}26^{''}$ W) in Trotwood, Montgomery County, Ohio. Additional information on the history of the site and soil types is detailed in @Jarecke2016. Briefly, the closed static flux chamber method was used [@Holland1999] to measure $CH_{4}$ fluxes at 28 locations across a hydrologic gradient (upland to seasonal wetland) at
daily to weekly interval from September 2015 to September 2016. **See and Smyth et al, pending for
additional details???** on greenhouse gas flux methods for this site. We threw out all locations that had fewer than 50 dates data.

# Nonparametric analysis of tail dependence \label{NPA}

Left (or lower)- and right (or upper)-tail dependence quantify the extent to which two ranked
variables $u_i$, $v_i$ for $i=1,...,n$ 
(see \nameref{MT-Model_selection} for defintions of $u_i$ and $v_i$ in the manuscript)
are related to each other in the left and right tails, respectively, of their 
distributions [@nelsen2007_copula, @joe2014_dependence]. 
Our nonparametric study of tail dependence uses three
statistics which can quantify the extent to which $u_i$ and $v_i$ are 
related in any part of their distributions. We here describe the 
statistics. The statistics were formulated with positively associated
variables in mind. All the variables we study are positively associated
when they are significantly associated. So definitions and associated 
diagrams will assume positive associations, though generalizations are 
possible. Given two bounds 
$0 \leq l_b < u_b \leq 1$, we define the parallel lines $u+v=2l_b$ and 
$u+v=2u_b$ which intersect the unit square in which the $u_i$ and $v_i$ 
fall (these are the blue and red lines, respectively, in 
Fig. \ref{fig_stat_image}). Our statistics quantify the dependence
between $u_i$ and $v_i$ in the region bounded by these lines.
Using $l_b=0$ and some value $u_b\leq 0.5$ can give information about 
dependence in the left parts of the distributions of $u$ and $v$, and 
using $u_b=1$ and $l_b \geq 0.5$ can give information about dependence in 
the right parts of the distributions. 

\begin{figure}[!h]
\begin{center}
\includegraphics[width=6 cm,height=6 cm]{./stat_image.jpg} \hspace{0.6 cm}
\caption{Schematic diagram supporting defintions of nonparametric tail dependence statistics \label{fig_stat_image}}
\end{center}
\end{figure}


The first quantity, $\cor_{l_b,u_b}(u,v)$, is the portion of the Spearman 
correlation of $u_i$ and $v_i$ that is attributable to the points 
lying in the region given by the bounds $u+v=2l_b$ and $u+v=2u_b$, i.e.,
\begin{equation}\label{eq.Cor}
   \cor_{l_b,u_b}(u,v) = \frac{1}{(n-1)\sqrt{\var(u)\var(v)}}\sum 
   (u_i-\mean(u)) (v_i-\mean(v)),
\end{equation}
where means and variances are computed using all $n$ data 
points, but the
sum is over only the indices $i$ for which $u_i+v_i > 2l_b$ and 
$u_i+v_i < 2u_b$. 
Larger values of $\cor_{l_b,u_b}$ indicate stronger positive association
between $u$ and $v$ in the region given by the bounds.

We also defined a statistic $\Ps_{l_b,u_b}$, using the same bounds
$u+v=2l_b$ and $u+v=2u_b$, as follows. For a distance $h$, we defined
$S(h)$ to be the number of points $(u_i,v_i)$ within the bounds 
and a distance less than $h$ from the line $v=u$, divided by the 
total number of points within the bounds. This function is
defined for $h$ going from $0$ to a distance $h_{\text{max}}$ which
is half the longer of the two segments obtained by intersecting the
bounds with the unit square. It is easy to see $S(0)=0$ and 
$S(h_{\text{max}})=1$. We defined $S_i(h)$, for the same range 
of $h$, to be the area within the bounds and the unit square
and within distance $h$ of the line $v=u$, divided by the area
within the bounds and the unit square. This is the expected value of
$S(h)$ for independent data. We then defined
\begin{equation}\label{eq.P}
   P_{l_b,u_b} = \int_0^{h_{max}} ( S(h) - S_i(h) ) dh.
\end{equation}
As for $\cor_{l_b,u_b}$, larger values of $\Ps_{l_b,u_b}$ 
indicate stronger positive association
between $u$ and $v$ in the region given by the bounds.

The third statistic, $\Dsq_{l_b,u_b}(u,v)$, is the average squared 
distance between points satisfying $u_i+v_i>2l_b$ and 
$u_i+v_i<2u_b$ and the line $v=u$. Unlike $\cor_{l_b,u_b}$ and 
$\Ps_{l_b,u_b}$, which are large when points satisfying $u_i+v_i>2l_b$ and 
$u_i+v_i<2u_b$ cluster close to the line $v=u$, $\Dsq_{l_b,u_b}$ is 
then small. 
Thus large values of $\cor_{l_b,u_b}$ and $\Ps_{l_b,u_b}$ indicate strong 
dependence in the portions of the distributions of $u$ and $v$ given by 
the bounds $u_i+v_i>2l_b$ and $u_i+v_i<2u_b$, whereas small values of 
$\Dsq_{l_b,u_b}$ indicate strong dependence. 

For large datasets (i.e., datasets with large $n$),
we can consider $l_b$ and $u_b$ close together without incurring undue
sampling variation in our statistics, and we can consider 
several different bands $(l_b,u_b)$ to understand how dependence
varies in different parts of the distributions. But for datasets with 
smaller $n$ we considered only $l_b=0$, $u_b=0.5$ and $l_b=0.5$, $u_b=1$.
We use the shorthand $\cor_l=\cor_{0,0.5}$ ($l$ is for "lower") 
and $\cor_u=\cor_{0.5,1}$ ($u$ is for "upper"); likewise $\Ps_l=\Ps_{0,.5}$,
$\Ps_u=\Ps_{0.5,1}$, $\Dsq_l=\Dsq_{0,0.5}$, and $\Dsq_u=\Dsq_{0.5,1}$.

The difference $\cor_l-\cor_u$ is expected to be positive if 
dependence in the left halves of the distributions is stronger 
than dependence in their right halves; likewise for $\Ps_l-\Ps_u$.
This holds, for instance, for the Clayton copula [@nelsen2007_copula].
The difference $\Dsq_u-\Dsq_l$, in which the "upper" and
"lower" statistics occur in opposite order, is also expected to be 
positive under the same conditions. We use these three differences
to detect asymmetry of tail dependence. Likewise, for large datasets,
we consider $\cor_{l_b,u_b}-\cor_{1-u_b,1-l_b}$, 
$\Ps_{l_b,u_b}-\Ps_{1-u_b,1-l_b}$ and
$\Dsq_{1-u_b,1-l_b}-\Dsq_{l_b,u_b}$ with $l_b=0$ and $u_b$ close to $0$.

We tested our statistics by testing whether $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$ revealed the asymmetry of tail dependence known to be present in data simulated from various copulas (for details see Appendix \ref{Test_npa_stat}).

For bivariate datasets, we compared values 
of the statistics $\cor_{l_b,u_b}$,
$\Ps_{l_b,u_b}$, $\Dsq_{l_b,u_b}$, $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$ to 
distributions of values of the same statistics computed on surrogate datasets that were produced from 
the empirical data by randomizing it in a special way. The surrogate/randomized datasets had exactly 
the same marginal distributions as the empirical data and had very similar Kendall or Spearman 
correlation (the algorithm had two versions, one for preserving each correlation coefficient), 
but had Normal copula structure. Thus our comparisons tested the null hypothesis 
that our statistics took values on the empirical data no different from what would have been expected 
if the copula structure of the data were Normal, but the data were otherwise 
statistically unchanged.
Details of how surrogates were prroduced are in Appendix \ref{surrog_test}, and code is in [`copsurrog2d`](https://github.com/sghosh89/BIVAN/blob/master/copsurrog2d.R).

The comparison of one of the
statistics $\cor_{l_b,u_b}$, $\Ps_{l_b,u_b}$, $\Dsq_{l_b,u_b}$, as computed on the 
empirical data, to the distribution
of its values computed on many surrogate datasets 
provides a test of whether dependence in the part of the distribution specified 
by $l_b$ and $u_b$ is different from
what would be expected from a null hypothesis of normal copula structure but 
unchanged marginals and unchanged 
Kendall (or Spearman)
correlation. Thus the comparison helps answer the first two parts of question \hyperref[MT-Intro]{\textbf{(Q1)}} 
from the \nameref{MT-Intro} for bivariate datasets. 
Significant deviations correspond to deviations from normal 
copula structure. In particular, deviations 
using $l_b=0$ and $u_b$ small (say, $0.1$) correspond to lower tail dependence 
different from that of a normal copula;
likewise, using $l_b=0.9$ and $u_b=1$ tests for upper tail dependence different 
from that of a normal copula.  

The comparison of one of the statistics $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, $\Dsq_u-\Dsq_l$, 
as computed on the 
empirical data, to the distribution
of its values on many surrogate datasets 
provides a test of asymmetry of tail dependence. Thus this comparison helps answer the
third part of question \hyperref[MT-Intro]{\textbf{(Q1)}} from the \nameref{MT-Intro} for bivariate datasets.

For multivariate datasets, a spatial resampling scheme was used instead of the surrogate 
approach described above.
The scheme is identical to that proposed by @bjornstadfalck2001 for application in their now 
widely used spline correlogram method; the same scheme was also used by @walteretal2017 
as part of a method for 
performing model selection among matrix regression models. For each pair of 
locations $i \neq j$, the statistic
of interest, here denoted $s_{ij}$ ($\cor_{l_b,u_b}$, $\Ps_{l_b,u_b}$, 
$\Dsq_{l_b,u_b}$, $\cor_l-\cor_u$, 
$\Ps_l-\Ps_u$, or $\Dsq_u-\Dsq_l$) was computed for those locations. The 
values $s_{ij}$ were then arranged in
a matrix, $S$, with diagonal entries NA. The mean of the non-NA entries of $S$ was computed. For 
$\cor_{l_b,u_b}$, $\Ps_{l_b,u_b}$, or $\Dsq_{l_b,u_b}$ this mean characterized the 
average strength of 
dependence, across all pairs of distinct locations, for data in the portion of the distributions 
given by $l_b$ and $u_b$. For $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, or $\Dsq_u-\Dsq_l$, the mean characterized average
asymmetry of tail dependence across all pairs of locations. 
Confidence intervals for the values of $\mean(S)$ were then computed as quantiles of a 
distribution of bootstrapped values. If $\mean(S)$ was significantly different from 0, as
revealed by these confidence intervals, for the statistics $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, 
or $\Dsq_u-\Dsq_l$, then tail dependence was significantly asymmetric, in contrast to a 
Normal null hypothesis, and answering question \hyperref[MT-Intro]{\textbf{(Q1)}} from the \nameref{MT-Intro}.
Bootstrapping was performed by resampling the locations of measurement, with replacement. 
This corresponds to 
resampling, with replacement, the rows and columns of $S$, and is described in detail elsewhere 
[@bjornstadfalck2001 ; @walteretal2017]. 


# Testing non-parametric statistics for various symmetric and asymmetric copulas \label{Test_npa_stat}

Normal and Frank copula families 
are known to have symmetric tail dependence,
i.e., strengths of dependence in the lower and upper tails are the same, for all copulas
in these families [@nelsen2007_copula]. Clayton copulas are known to have stronger lower- than 
upper-tail dependence. And survival Clayton copulas, being rotations of Clayton copulas by 
$180^\circ$, have stronger upper- than lower tail dependence [@nelsen2007_copula].
Using the `iRho` function from the `copula` package, for each of the four families normal, 
Frank, Clayton, and survival Clayton, we obtained parameters for which the expected value of 
Spearman's $\rho$ was, separately, $0,0.1,0.2,...,0.9$. For each copula family and for each 
of the selected parameter values we generated  $n$ points, 100 times, and thereby computed 100 values of the 
statistics $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$. This exercise 
was repeated, separately, 
for $n=1000$ and for $n=35$, these cases being chosen, respectively, to reflect asymptotic behavior of the 
statistics and their behavior on the small datasets which are common in some fields
of ecology. The mean and standard error of the three difference statistics were computed for 
each copula family, parameter value, and value of $n$, and results were plotted against 
Spearman's rho (Figures \ref{fig_stat_testing35} and \ref{fig_stat_testing1000}), 
the expectation being that the difference statistics would be positive for 
Clayton copulas and negative for survival Clayton copulas (except for the case of $\rho=0$, a 
boundary case of these families corresponding to independence), and not significantly different 
from $0$ (we used a $t$-test with a significance threshold of $0.05$) for Frank and normal 
copulas. These expectations were fullfilled (Figures \ref{fig_stat_testing35} and 
\ref{fig_stat_testing1000}).

<!--The message=F and warning=F flags are to suppress warnings that come when you pass a parameter
of 0 to the Frank or Clayton copulas. These are technicallly boundary cases for these families.
They correspond to the independent copula. The packages we use provide the indepdent copula, but
issue a warning. Since anyway we want the independent copula, we can suppress the warning. We ran this
without the warning and it is OK to supress it.-->
<!-- The lines you are talking about appeared as message not as warning(actualy no warning appered for this chunk), so we have to set message=F here-->
```{r stat_testing_save_and_plot_result, message=F, results="hide", echo=F, cache=T, cache.extra=list(seed,mtime("TestStats_multivar_dataset.R"),mtime("CopulaFunctions.R"),mtime("CopulaFunctions_flexible.R"))}
source("TestStats_multivar_dataset.R")
set.seed(seed)

resultsloc<-"./Results/stat_results/stat_testing/"
spearvals<-seq(from=0,to=0.9,by=0.1)
callfn<-coplist_with_params(spearvals=spearvals)
coplist<-callfn$coplist
ncores<-3
res_pt35_rankF<-mclapply(X=coplist,FUN=worker,numpts=35,numsims=100,rank=F,mc.cores=ncores)
res_pt35_rankT<-mclapply(X=coplist,FUN=worker,numpts=35,numsims=100,rank=T,mc.cores=ncores)
res_pt1000_rankF<-mclapply(X=coplist,FUN=worker,numpts=1000,numsims=100,rank=F,mc.cores=ncores)
res_pt1000_rankT<-mclapply(X=coplist,FUN=worker,numpts=1000,numsims=100,rank=T,mc.cores=ncores)
save(res_pt35_rankF,res_pt35_rankT,res_pt1000_rankF,res_pt1000_rankT,file=paste(resultsloc,"StatTestNumericResults.RData",sep=''))

b<-callfn$paramlist
plotter_stat_testing(res_pt35_rankF,"res_pt35_rankF",b,resultsloc,spearvals)
plotter_stat_testing(res_pt35_rankT,"res_pt35_rankT",b,resultsloc,spearvals)
plotter_stat_testing(res_pt1000_rankF,"res_pt1000_rankF",b,resultsloc,spearvals)
plotter_stat_testing(res_pt1000_rankT,"res_pt1000_rankT",b,resultsloc,spearvals)
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/stat_results/stat_testing/res_pt35_rankT.pdf}
\caption[Testing non-parametric statistics with datapoints $n=35$]{Results of tests of whether $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$ reveal the known asymmetry of tail dependence of the Clayton and survival Clayton copulas, and the known symmetry of tail dependence for the normal and Frank copulas. See text for details. $n=35$. \label{fig_stat_testing35}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/stat_results/stat_testing/res_pt1000_rankT.pdf}
\caption[Testing non-parametric statistics with datapoints $n=1000$]{Results of tests of whether $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$ reveal the known asymmetry of tail dependence of the Clayton and survival Clayton copulas, and the known symmetry of tail dependence for the normal and Frank copulas. See text for details. $n=1000$.\label{fig_stat_testing1000}}
\end{center}
\end{figure}

<!--This r-chunk generates figure necessary for maintext Paper-->
```{r fig_stat_testing_for_maintext, message=F, results="hide", echo=F, cache=T, cache.extra=list(seed,mtime("TestStats_multivar_dataset.R"),mtime("CopulaFunctions.R"),mtime("CopulaFunctions_flexible.R"),mtime("StatTestNumericResults.RData"))}
set.seed(seed) 
source("fig_Paper_stat_testing.R")
#load("./Results/stat_results/stat_testing/StatTestNumericResults.RData")
resultsloc<-"./Results/stat_results/stat_testing/"

copname<-"C"
reslist<-res_pt35_rankT

statname<-"CorlmCoru"
call_fig_Paper_stat_testing(resultsloc=resultsloc,statname=statname,copname=copname,reslist=reslist, numsims=100)
statname<-"PlmPu"
call_fig_Paper_stat_testing(resultsloc=resultsloc,statname=statname,copname=copname,reslist=reslist, numsims=100)
statname<-"D2umD2l"
call_fig_Paper_stat_testing(resultsloc=resultsloc,statname=statname,copname=copname,reslist=reslist, numsims=100)
```

# Surrogate testing with bivariate datasets for non-parametric statistics \label{surrog_test}

For bivariate datasets, surrogates were produced as follows.   

- Given data $(x_i,y_i)$ for $i=1,\ldots,n$ and a 
one-parameter target copula family $\mathcal{B}(\theta)$ (here $\theta$ denotes the parameter), let $\tau$ be the
Kendall correlation of the $x_i$ with the $y_i$ and find the parameter value $\theta_\tau$ for which 
$\mathcal{B}(\theta_\tau)$ has Kendall correlation $\tau$ (this is possible for the one-parameter copula families of this 
study using the `iTau` function of the `VineCopula` package). 
- Generate data $(a_i,b_i)$, $i=1,\ldots,n$ from 
$\mathcal{B}(\theta_\tau)$. 
- Permute the ordered set $(x_1,\ldots,x_n)$ such that the permutation
$(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$ has $\rank(x_{\sigma_x(i)})$ equal to $\rank(a_i)$ for all $i$, where 
$\rank(x_{\sigma_x(i)})$ is the rank of $x_{\sigma_x(i)}$ in the set $(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$, and
$\rank(a_i)$ is the rank of $a_i$ in the set $(a_1,\ldots,a_n)$ (here $\sigma_x$ is a permutation of the 
indices $1,\ldots,n$). 
- Likewise permute $(y_1,\ldots,y_n)$
such that the permutation
$(y_{\sigma_y(1)},\ldots,y_{\sigma_y(n)})$ has $\rank(y_{\sigma_y(i)})$ equal to $\rank(b_i)$ for all $i$ ($\sigma_y$ is 
another permutation of $1,\ldots,n$).
- The surrogate dataset is $(x_{\sigma_x(i)},y_{\sigma_y(i)})$ for $i=1,\ldots,n$. 

Our code for this algorithm is [`copsurrog2d`](https://github.com/sghosh89/BIVAN/blob/master/copsurrog2d.R) in the 
[`BIVAN`](https://github.com/sghosh89/BIVAN) repository. 

Because $(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$ 
is a permutation of $(x_1,\ldots,x_n)$ and $(y_{\sigma_y(1)},\ldots,y_{\sigma_y(n)})$ is a 
permutation 
of $(y_1,\ldots,y_n)$, the marginal distributions of the surrogate data are exactly the same as 
those of the original data. 
Because ranks of the surrogate data are matched to ranks of the $a_i$ and $b_i$, the
Kendall correlation of the surrogate dataset will be the same as that of the $a_i$ and $b_i$, and therefore 
will be close to $\tau$ (differences arising only through sampling variation). If instead of $\theta_\tau$
a parameter value $\theta_\rho$ is used such that the Spearman correlation of $\mathcal{B}(\theta_\rho)$ is the same
as that of the $x_i$ with the $y_i$, then Spearman correlations of surrogates will very nearly equal (except for 
sampling variation) the Spearman correlation of the empirical data.  

<!--
# Question 1 analyses for each dataset
Recall that question 1 is: Do datasets in ecology and related fields have non-Gausian copula structure? Do they show tail dependence distinct from that of a Normal copula? In particular do they show asymmetric tail dependence?

## Details of methods \label{Method}
### Model selection approach \label{Model_selection}
### Non-parametric analysis of tail dependence \label{NPA}
moved to Paper.Rmd
-->

<!--
## Results: soil C and N data \label{Ex_SoilCN}
### Model selection approach \label{Ex_SoilCN_Model_selection} 
### Non-parametric analysis of tail dependence \label{Ex_SoilCN_NPA}
                    [[[[moved to Paper.Rmd]]]]
-->

<!--This chunk is for model selection results of soilCN dataset-->
```{r bivmodselect_Loecke, echo=F, cache=T, cache.extra=list(seed,v_CN,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("OurBiCopSelect.R")
set.seed(seed)
families_Loecke<-c(1,3:10,13:14,16:20) 
BivMS_res_Loecke<-OurBiCopSelect(u1=v_CN[,1],u2=v_CN[,2],families=families_Loecke,level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,gofnormal=F,status=F)
saveRDS(BivMS_res_Loecke,file="./Results/fitting_results/BivMS_soilCN.RDS")
```

<!--Display model selection results in a table-->
```{r tab_soilCNfit, echo=F, results="markup"}
#knitr::opts_knit$set(kable.force.latex = TRUE)
h<-BivMS_res_Loecke$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
knitr::kable(h, #longtable = T, 
             format = "pandoc",
      #caption.short = "Fitting info for soil C and N dataset",
      caption = "Fitting info for **soil C and N dataset**. Here and henceforth copula names are abbreviated as: N=normal (Gaussian); C=Clayton; G=Gumbel; F=Frank; J=Joe; SC=survival Clayton; SG=survival Gumbel; SJ=survival Joe. An S in front of one of the copulas BB1, BB6, BB7, BB8 indicates the survival version of that copula (rotation by $180^\\circ$).\\label{tab_soilCNfit}",
      booktabs = TRUE)
```

<!--This chunk is for npa testing results of soilCN dataset-->
```{r stat_soilCN_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,v_CN,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed) 
stat_soilCN_ga<-bivfunctionplot(v=v_CN,resloc="./Results/stat_results/stat_soilCN/",nametag="soilCN",numbin=10)
```
<!--****DAN: DAN suspects a bug in the code that generates this fig. because the red dot should appear outside the x's iff the text > 999 (or so,mething like that) appears in the bin, also check make_table_stat_fn r chunk-->

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/stat_results/stat_soilCN/soilCN_bivfunctionplot.pdf}
\caption[Testing non-parametric statistics for soilCN data]{Nonparametric tests for tail dependence and other deviations from a normal copula for \textbf{soil C and N data}. As described in \nameref{MT-Methods}, each statistic was computed on the data using the ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (red cross), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (blue and green cross show 0.025 and 0.975 quantiles of these results).  When red cross was above (or below) the blue and green cross, text at the top of plots indicates the actual statistics was greater than (or less than) by those number of surrogate values. When $\cor$ values (respectively, $\Ps$ or $\Dsq$ values) were greater than surrogates, it means dependence in that part of the distributions was stronger than (respectively, stronger than or weaker than for $\Ps$ or $\Dsq$) expected from a normal-copula null hypothesis. \label{fig_soilCN_nonparam}}
\end{center}
\end{figure}

<!--Now make and display a table, this one about asymmetry of tail dependence-->
```{r make_table_stat_fn, echo=F}

fractxt<-function(fracval,numsurrog){
  ptxt<-''
  if (fracval>.5*numsurrog){                        # ?DCR why 0.5 factor?
    ptxt<-paste(">",fracval,sep='')
  } 
  if (fracval<=.5*numsurrog){
    ptxt<-paste("<",numsurrog-fracval,sep='')
  }
  return(ptxt)
}

make_table_stat_fn<-function(data){
  
 #atdres<-data.frame(Statistic=c("$\\cor_{0,0.1}-\\cor_{0.9,1}$",
 #                               "$\\Ps_{0,0.1}-\\Ps_{0.9,1}$",
 #                               "$\\Dsq_{0.9,1}-\\Dsq_{0,0.1}$"),
 atdres<-data.frame(Statistic=c("$\\cor_\\text{first slice}-\\cor_\\text{last slice}$",
                               "$\\Ps_\\text{first slice}-\\Ps_\\text{last slice}$",
                                "$\\Dsq_\\text{last slice}-\\Dsq_\\text{first slice}$"),
                   Kendall=rep("",3),
                   Spearman=rep("",3),stringsAsFactors = F)
 
 atdres[1,2]<-fractxt(data$corlmcoru_frac_K,numsurrog = data$numsurrog_success_K)
 atdres[1,3]<-fractxt(data$corlmcoru_frac_S,numsurrog = data$numsurrog_success_S)
 atdres[2,2]<-fractxt(data$PlmPu_frac_K,numsurrog = data$numsurrog_success_K)
 atdres[2,3]<-fractxt(data$PlmPu_frac_S,numsurrog = data$numsurrog_success_S)
 atdres[3,2]<-fractxt(data$D2umD2l_frac_K,numsurrog = data$numsurrog_success_K)
 atdres[3,3]<-fractxt(data$D2umD2l_frac_S,numsurrog = data$numsurrog_success_S)

 return(atdres)
  
}
```


```{r tab_soilCN_asym,echo=F,results="markup"}
#knitr::opts_knit$set(kable.force.latex = TRUE)
tab_soilCN_asym<-make_table_stat_fn(data=stat_soilCN_ga)
knitr::kable(tab_soilCN_asym, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption = "**Soil CN data set results** for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis. Three statistics are listed in the left column that measured asymmetry of tail dependence by comparing the distribution ranges $0-0.1$ and $0.9-1$ (see \\ref{NPA}). One thousand Kendall-preserving and 1000 Spearman-preserving surrogates with normal copula structure were created, and the same statistics were computed for the surrogates. A table entry $<N$ indicates the value of the given statistic on the data was less than its value on $N$ of the surrogates, so entries of the form $<X$ for $X$ equal to $975$ or above indicate that upper-tail dependence was significantly stronger than lower-tail dependence.\\label{tab_soilCN_asym}")
#kable_styling(, position = "float_left")
```



<!--
\newpage
## Results: BMR data \label{Ex_BMR}
### Model selection approach \label{Ex_BMR_Model_selection}
### Non-parametric analysis of tail dependence \label{Ex_BMR_NPA}
                  ----moved to Paper.Rmd----
-->

<!--This chunk is for model selection results of BMR data-->
```{r bivMS_BMR, echo=F, cache=T, cache.extra=list(seed,v_BMR,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
set.seed(seed) 
source("OurBiCopSelect.R")
#families<-c(1,3:10,13:14,16:20) 
BivMS_BMR<-OurBiCopSelect(u1=v_BMR[,1],u2=v_BMR[,2],families=c(1,3:10,13:14,16:20),
                          level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,gofnormal=F,status=F)
saveRDS(BivMS_BMR,file="./Results/BMR_results/BivMS_lnBMR_vs_lnmass.RDS")
```


<!--Display model selection results for BMR data in a table-->
```{r tab_BMRfit, echo=F, results='markup'}
h<-BivMS_BMR$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
knitr::kable(h,
             format='pandoc',
             caption = "Fitting info for **BMR dataset**. \\label{tab_BMRfit}",
             booktabs=T)
```

<!--This chunk is for npa testing results of BMR dataset-->
```{r stat_BMR_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,v_BMR,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed) 
# Now do NPA for v_BMR
stat_BMR_ga<-bivfunctionplot(v=v_BMR,resloc="./Results/BMR_results/",nametag="BMR_numbin_10",numbin = 10)
stat_BMR_ga_numbin5<-bivfunctionplot(v=v_BMR,resloc="./Results/BMR_results/",nametag="BMR_numbin_5",numbin = 5)
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/BMR_results/BMR_numbin_10_bivfunctionplot.pdf}
\caption[Testing non-parametric statistics for BMR data with $numbin=10$]{Nonparametric tests for tail dependence and other deviations from a normal copula for \textbf{BMR data}. As described in \nameref{MT-Methods}, each statistic was computed on the data using the ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (red cross), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (blue and green cross show 0.025 and 0.975 quantiles of these results).  When red cross was outside blue and green cross, text at the top of plots indicates how many surrogate values the data value was less than or greater than. \label{fig_BMR_nonparam}}
\end{center}
\end{figure}

<!--
\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/BMR_results/BMR_numbin_5_bivfunctionplot.pdf}
\caption[Testing non-parametric statistics for BMR data with $numbin=5$]{Nonparametric tests for tail dependence and other deviations from a normal copula for BMR data. As described in \nameref{MT-Methods}, each statistic was computed on the data using the ranges $0-0.2$, $0.2-0.4$, ..., $0.8-1$ (red lines), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (dashed lines show 0.025 and 0.975 quantiles of these results and dotted lines show 0.005 and 0.995 quantiles). \label{fig_BMR_nonparam5}}
\end{center}
\end{figure}
-->

```{r tab_BMR_asym, echo=F, results="markup"}
tab_BMR_asym<-make_table_stat_fn(data=stat_BMR_ga)
tab_BMR_asym_numbin5<-make_table_stat_fn(data=stat_BMR_ga_numbin5)

knitr::kable(tab_BMR_asym,
             format="pandoc",
             caption = "**BMR data set results** for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis. \\label{tab_BMR_asym}",
             booktabs=T)

#knitr::kable(tab_BMR_asym_numbin5,
#             format="pandoc",
#             caption = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis (best fit is here Frank with symmetric tail dep)?, numbin=5 \\label{tab_BMR_asym_numbin5}",
#             booktabs=T)
```

<!--
\newpage
## Results: contrasts.csv data \label{Ex_contrasts}
### Model selection approach \label{Ex_contrasts_Model_selection}
### Non-parametric analysis of tail dependence \label{Ex_contrasts_67_NPA}
                 ----moved to Paper.Rmd----
-->

<!--This chunk is for model selection results of anolis data-->
```{r bivMS_contrasts_67, echo=F, cache=T, cache.extra=list(seed,v_contrasts_67,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
set.seed(seed)
# Now do Model Selection for [i,j]=[6,7]
# 6 : AVG. ltoe.IV
# 7 : AVG. humerus
source("OurBiCopSelect.R")
families<-c(1,3:10,13:14,16:20)
BivMS_contrasts_67<-OurBiCopSelect(u1=v_contrasts_67[,1],u2=v_contrasts_67[,2],families=families,
                          level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,
                          gofnormal=F,status=F)
saveRDS(BivMS_contrasts_67,file="./Results/Anolis_results/contrasts_csv_results/BivMS_contrasts_67.RDS")
```

\newpage
<!--Display model selection results for contrasts data in a table-->
```{r tab_contrasts_67fit, echo=F, results='markup'}
h<-BivMS_contrasts_67$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
knitr::kable(h,
             format='pandoc',
             caption = "Fitting info for **Anolis data set** with contrasts for AVG.ltoe.IV and AVG.humerus phylogenetic traits. \\label{tab_contrasts_67fit}",
             booktabs=T)
```

<!--This chunk is for npa testing results of anolis dataset-->
```{r stat_contrasts_67_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,v_contrasts_67,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}   
source("bivfunctionplot.R")  
set.seed(seed) 
# Now do NPA for v_contrasts_67 with numbin=4
stat_contrasts_67_ga<-bivfunctionplot(v=v_contrasts_67,resloc="./Results/Anolis_results/contrasts_csv_results/",
                                      nametag="contrasts_67",numbin = 4) 
``` 

```{r stat_contrasts_67_graphic_approach2, echo=F, results="hide", cache=T, cache.extra=list(seed,v_contrasts_67,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed) 
# Now do NPA for v_contrasts_67

stat_contrasts_67_ga_numbin2<-bivfunctionplot(v=v_contrasts_67,
                            resloc="./Results/Anolis_results/contrasts_csv_results/",
                            nametag="contrasts_67_numbin2",numbin = 2)

stat_contrasts_67_ga_numbin3<-bivfunctionplot(v=v_contrasts_67,
                            resloc="./Results/Anolis_results/contrasts_csv_results/",
                            nametag="contrasts_67_numbin3",numbin = 3)

stat_contrasts_67_ga_numbin5<-bivfunctionplot(v=v_contrasts_67,
                            resloc="./Results/Anolis_results/contrasts_csv_results/",
                            nametag="contrasts_67_numbin5",numbin = 5)

stat_contrasts_67_ga_numbin6<-bivfunctionplot(v=v_contrasts_67,
                            resloc="./Results/Anolis_results/contrasts_csv_results/",
                            nametag="contrasts_67_numbin6",numbin = 6)

stat_contrasts_67_ga_numbin7<-bivfunctionplot(v=v_contrasts_67,
                            resloc="./Results/Anolis_results/contrasts_csv_results/",
                            nametag="contrasts_67_numbin7",numbin = 7)

stat_contrasts_67_ga_numbin10<-bivfunctionplot(v=v_contrasts_67,
                            resloc="./Results/Anolis_results/contrasts_csv_results/",
                            nametag="contrasts_67_numbin10",numbin = 10)
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Anolis_results/contrasts_csv_results/contrasts_67_bivfunctionplot.pdf}
\caption[Testing non-parametric statistics for anolis data]{Nonparametric tests for tail dependence and other deviations from a normal copula for anolis data. As described in \nameref{MT-Methods}, each statistic was computed on the data using the ranges $0-0.25$, $0.25-0.5$, $0.5-0.75$, $0.75-1$ for $4$ number of bins (red cross), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (blue and green cross show 0.025 and 0.975 quantiles of these results). \label{fig_contrasts_67_nonparam}}
\end{center}
\end{figure}



```{r tab_contrasts_67_asym, echo=F, results="markup"}
tab_contrasts_67_asym<-make_table_stat_fn(data=stat_contrasts_67_ga)
knitr::kable(tab_contrasts_67_asym,
             format="pandoc",
             caption = "**Anolis data set results** for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis \\label{tab_contrasts_67_asym}",
             booktabs=T)
```


<!--
This chunks are just to see the tables for all numbin variation for anolis data set: It appears that numbin=4 is optimized, when numbin=2, >= 7, there is no significant asymetry in tail dep in all 3 types of stats.

```{r tab_contrasts_67_asym67_numbin2, echo=F, results="markup"}
#tab_contrasts_67_asym2<-make_table_stat_fn(data=stat_contrasts_67_ga_numbin2)
#knitr::kable(tab_contrasts_67_asym2,
#            format="pandoc",
#             caption = "numbin_2,anolis \\label{tab_contrasts_67_asym2}",
#             booktabs=T)
```

```{r tab_contrasts_67_asym67_numbin3, echo=F, results="markup"}
#tab_contrasts_67_asym3<-make_table_stat_fn(data=stat_contrasts_67_ga_numbin3)
#knitr::kable(tab_contrasts_67_asym3,
#             format="pandoc",
#             caption = "numbin_3,anolis \\label{tab_contrasts_67_asym3}",
#             booktabs=T)
```

```{r tab_contrasts_67_asym67_numbin5, echo=F, results="markup"}
#tab_contrasts_67_asym5<-make_table_stat_fn(data=stat_contrasts_67_ga_numbin5)
#knitr::kable(tab_contrasts_67_asym5,
#            format="pandoc",
#             caption = "numbin_5,anolis \\label{tab_contrasts_67_asym5}",
#             booktabs=T)
```


```{r tab_contrasts_67_asym67_numbin6, echo=F, results="markup"}
#tab_contrasts_67_asym6<-make_table_stat_fn(data=stat_contrasts_67_ga_numbin6)
#knitr::kable(tab_contrasts_67_asym6,
#             format="pandoc",
#             caption = "numbin_6,anolis \\label{tab_contrasts_67_asym6}",
#             booktabs=T)
```

```{r tab_contrasts_67_asym67_numbin7, echo=F, results="markup"}
#tab_contrasts_67_asym7<-make_table_stat_fn(data=stat_contrasts_67_ga_numbin7)
#knitr::kable(tab_contrasts_67_asym7,
#             format="pandoc",
#             caption = "numbin_7,anolis \\label{tab_contrasts_67_asym7}",
#             booktabs=T)
```

```{r tab_contrasts_67_asym67_numbin10, echo=F, results="markup"}
#tab_contrasts_67_asym10<-make_table_stat_fn(data=stat_contrasts_67_ga_numbin10)
#knitr::kable(tab_contrasts_67_asym10,
#             format="pandoc",
#             caption = "numbin_10,anolis \\label{tab_contrasts_67_asym10}",
#             booktabs=T)
```

-->

```{r bivmodselect_cc, echo=F, cache=T, cache.extra=list(seed,cop_HB_all_yr,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("OurBiCopSelect.R")
set.seed(seed)

BivMS_res_cc<-vector("list",length(cop_HB_all_yr))
names(BivMS_res_cc)<-names(cop_HB_all_yr)

for(i in 1:length(BivMS_res_cc)){
  BivMS_res_cc[[i]]<-OurBiCopSelect(u1=cop_HB_all_yr[[i]]$avg.H,u2=cop_HB_all_yr[[i]]$avg.Biomass,
                                    families=c(1,3:10,13:14,16:20),
                                    level=0.05,AICBIC="AIC",
                                    numBSsmall=100,pthresh=0.2,numBSlarge=1000,gofnormal=F,status=F)
}
saveRDS(BivMS_res_cc,file="./Results/Ceder_creek_results/BivMS_res_cc.RDS")
BivMS_res_cc<-readRDS("./Results/Ceder_creek_results/BivMS_res_cc.RDS")
```

<!--Display model selection results for Ceder-creek data for year 2000 in a table-->
```{r tab_cc2000fit, echo=F, results='markup'}
h<-BivMS_res_cc$`2000`$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
knitr::kable(h,
             format='pandoc',
             caption = "Fitting info for **Ceder-creek dataset** for year 2000. \\label{tab_cc2000fit}",
             booktabs=T)
```

```{r stat_cc_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,cop_HB_all_yr,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed)

stat_cc_ga<-vector("list",length(cop_HB_all_yr))
names(stat_cc_ga)<-names(cop_HB_all_yr)

for(i in 1:length(stat_cc_ga)){
  temp<-bivfunctionplot(v=cop_HB_all_yr[[i]],
                             resloc="./Results/Ceder_creek_results/",
                             nametag=paste0(names(cop_HB_all_yr)[i],"cc_numbin_10",sep=""),
                             numbin = 10)
  stat_cc_ga[[i]]<-temp
}

saveRDS(stat_cc_ga,"./Results/Ceder_creek_results/stat_cc_ga.RDS")
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Ceder_creek_results/2000cc_numbin_10_bivfunctionplot.pdf}
\caption[Testing non-parametric statistics for Ceder-creek data with $numbin=10$ for year 2000]{Nonparametric tests for tail dependence and other deviations from a normal copula for \textbf{Ceder-creek data}. As described in \nameref{MT-Methods}, each statistic was computed on the data using the ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (red cross), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (blue and green cross show 0.025 and 0.975 quantiles of these results).  When red cross was outside blue and green cross, text at the top of plots indicates how many surrogate values the data value was less than or greater than. \label{fig_cc2000_nonparam}}
\end{center}
\end{figure}

```{r tab_cc_asym_2000, echo=F, results="markup"}
tab_cc_asym_2000<-make_table_stat_fn(data=stat_cc_ga$`2000`)
knitr::kable(tab_cc_asym_2000,
             format="pandoc",
             caption = "**Ceder-creek data set results** for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis on year 2000 \\label{tab_cc_asym_2000}",
             booktabs=T)
```

<!--
\newpage
## Results: abundance data for the green spruce aphid, *Elatobium abietinum* \label{Ex_count}
### Model selection approach \label{Ex_count_Model_selection}
### Non-parametric analysis of tail dependence \label{Ex_count_NPA}
                  ----moved to Paper.Rmd----
-->

<!--Load the raw data-->
```{r read_aphid_data, echo=F}
source("aphid_data_calling.R")

# Aphid raw data for count
d0_count<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtscount141117.csv",header=F))
data_aphid_count<-d_allsp_data(d0_count)     
 
# Aphid raw data for first flight
d0_firstflight<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsfirstflight141117.csv",header=F))
data_aphid_ff<-d_allsp_data(d0_firstflight) 

# Aphid raw data for flight duration   
#d0_flightduration<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsflightduration141117.csv",header=F))
```

<!--Do the model selection for aphid count data and then showing results in Tables-->
```{r RES_aphid_count, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file
set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_aphid_count<-RES_single_sp(d_allsp=data_aphid_count,sp=10,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30)
#cat(paste("stop-time: ",Sys.time(),"\n"))
resloc<-"./Results/fitting_results/"
saveRDS(RES_aphid_count,paste(resloc,file="AphidCopulaFit_selecloc_count_species_10.RDS",sep=""))
```

```{r tab_count_bestcop, echo=F, results="markup"}
#library(dplyr)
#knitr::opts_knit$set(kable.force.latex = TRUE)
knitr::kable(RES_aphid_count$info_ord_copname[,,1], #longtable = T,
             format='pandoc',
             #caption.short = "Best-fitting copulas for each location pair from among those considered, according to AIC, for abundances of the green spruce aphid.",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for **abundances of the green spruce aphid**. Copulas 
considered were the normal, Clayton, Gumbel, Frank, Joe, BB1, BB6, BB7, BB8, survival Clayton, survival Gumbel, 
survival Joe, survival BB1, survival BB6, survival BB7, survival BB8 copulas. Abbreviations were given in \\nameref{MT-Methods}. NA occurs along the diagonal of the matrix because the diagonal represents a sampling location compared to itself.\\label{tab_count_bestcop}",
             booktabs=TRUE
             )#%>% # only with 'latex'/'html' format
 # kableExtra::kable_styling(latex_options = c("striped","HOLD_position"))
```

```{r tab_count_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$info_ord_AICw[,,1], 
             format='pandoc',
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for **abundances of the green spruce aphid**.\\label{tab_count_AICw}",
             booktabs=TRUE
             )
```

```{r tab_count_AICw_normal, echo=F, results='markup'}
source("normal_cop_AICw.R")
knitr::kable(normal_cop_AICw_matrix(r=RES_aphid_count),
             format='pandoc',
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for **abundances of the green spruce aphid**, for comparison with Table \\ref{tab_count_AICw}. \\label{tab_count_AICw_normal}",
             booktabs=TRUE
             )
```

```{r tab_count_p_CvM, echo=F, results='markup'}
knitr::kable(RES_aphid_count$gfc_p_CvM,
             format='pandoc',
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **abundances of the green spruce aphid**. Tests were based on bootstrapping as described in Methods.\\label{tab_count_p_CvM}",
             booktabs=TRUE
             )
```

```{r tab_count_p_KS, echo=F, results='markup'}
knitr::kable(RES_aphid_count$gfc_p_KS,
             format='pandoc',
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **abundances of the green spruce aphid**. Tests were based on bootstrapping as described in Methods.\\label{tab_count_p_KS}",
             booktabs=TRUE
             )
```

```{r tab_count_LTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$LTdep_AICw,
             format='pandoc',
             caption = "Model-averaged lower tail dependence statistic for each location pair for **abundances of the green spruce aphid**.\\label{tab_count_LTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_count_UTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$UTdep_AICw,
             format='pandoc',
             caption = "Model averaged upper tail dependence statistic for each location pair for **abundances of the green spruce aphid**.\\label{tab_count_UTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_count_LTmUT, echo=F, results='markup'}
knitr::kable(RES_aphid_count$LTdep_AICw-RES_aphid_count$UTdep_AICw,
             digits = 5,
             format='pandoc',
             caption = "Model averaged lower tail dependence minus model averaged upper tail dependence statistic for each location pair for **abundances of the green spruce aphid**.\\label{tab_count_LTmUT}",
             booktabs=TRUE
             )
```

<!--Do the main computations for non-parametric analysis of aphid count data-->
```{r stat_aphid_count, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed) 
resloc<-"./Results/stat_results/stat_aphid_count/"

sp<-10
good_loc <- good_loclist(d_allsp=data_aphid_count,sp=sp,data_pt_thrs=30)
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_count<-multcall(d_allsp=data_aphid_count,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc)
saveRDS(stat_aphid_count,paste(resloc,file="stat_aphid_count_sp_10.RDS",sep='')) 
```

<!--Show the statistical results in a table-->
```{r tab_count_resamp,echo=F,results="markup"}
s<-stat_aphid_count$numericdf[,c(3,2,4)]
colnames(s)<-c("Lower 95\\% CI", "Mean", "Upper 95\\% CI")
rownames(s)<-c("Spearman","Kendall","$\\cor_l$","$\\cor_u$","$\\Ps_l$","$\\Ps_u$","$\\Dsq_l$","$\\Dsq_u$","$\\cor_l - \\cor_u$","$\\Ps_l - \\Ps_u$","$\\Dsq_u - \\Dsq_l$")
knitr::kable(s,
             format = "pandoc",
             caption = "Spatially averaged values of statistics and confidence intervals based on resampling for **abundances of the green spruce aphid**.\\label{tab_count_resamp}",
             booktabs=TRUE)
```

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_D2u-D2l_vs_D.pdf}
\caption[Non-parametric tail statistics results for green spruce aphid abundance data]{Non-parametric tail statistics results for green spruce aphid abundance data plotted against geographical distance ($D$) between two sampling locations. (A) Spearman correlation vs. $D$; (B) Kendall correlation vs. $D$; (C) $\cor_l$ vs. $D$; (D) $\cor_u$ vs. $D$; (E) $\Ps_l$ vs. $D$; (F) $\Ps_u$ vs. $D$; (G) $\Dsq_u$ vs. $D$; 
(H) $\Dsq_l$ vs. $D$; 
(I) $\cor_l-\cor_u$ vs. $D$, (J) $\Ps_l-\Ps_u$ vs. $D$, (K) $\Dsq_u-\Dsq_l$ vs. $D$ plotted for all 
pairs of locations. \label{fig_aphid_count}}
\end{center}
\end{figure}

<!--
\newpage
## Results: first flight date data for the leaf-curling plum aphid, *Brachycaudus helichrysi* \label{Ex_ff}
### Model selection approach \label{Ex_ff_Model_selection}
### Non-parametric analysis of tail dependence  \label{Ex_ff_NPA}
                          ----moved to Paper.Rmd----
-->

<!--Do the model selection for aphid ff data and then showing results in Tables-->
```{r RES_aphid_ff, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file
set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n"))
RES_aphid_ff<-RES_single_sp(d_allsp=data_aphid_ff,sp=11,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30)
#cat(paste("stop-time: ",Sys.time(),"\n")) 
resloc<-"./Results/fitting_results/"
saveRDS(RES_aphid_ff,paste(resloc,file="AphidCopulaFit_selecloc_firstflight_species_11.RDS",sep=""))
```

```{r tab_ff_bestcop, echo=F, results="markup"}
knitr::kable(RES_aphid_ff$info_ord_copname[,,1], #longtable = T,
             format='pandoc',
             #caption.short = "Best-fitting copulas for each location pair from among those considered, according to AIC, for first flight data for the leaf-curling plum aphid.",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for **first flight data for the leaf-curling plum aphid**. Copulas considered were as in Table \\ref{tab_count_bestcop}, with abbreviations given in \\nameref{MT-Methods}. NA occurs along the diagonal of the matrix because the diagonal represents a sampling location compared to itself.  \\label{tab_ff_bestcop}",
             booktabs=TRUE
             )
```

```{r tab_ff_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$info_ord_AICw[,,1], 
             format='pandoc',
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_AICw}",
             booktabs=TRUE
             )
```

```{r tab_ff_AICw_normal, echo=F, results='markup'}
source("normal_cop_AICw.R")
knitr::kable(normal_cop_AICw_matrix(r=RES_aphid_ff),
             format='pandoc',
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for **first flight data for the leaf-curlung plum aphid**, for comparison with Table \\ref{tab_ff_AICw}.\\label{tab_ff_AICw_normal}",
             booktabs=TRUE
             )
```

\newpage
```{r tab_ff_p_CvM, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$gfc_p_CvM,
             format='pandoc',
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **first flight data for the leaf-curling plum aphid**. Tests were based on bootstrapping as described in Methods.\\label{tab_ff_p_CvM}",
             booktabs=TRUE
             )
```

```{r tab_ff_p_KS, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$gfc_p_KS,
             format='pandoc',
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **first flight data for the leaf-curling plum aphid**. Tests were based on bootstrapping as described in Methods.\\label{tab_ff_p_KS}",
             booktabs=TRUE
             )
```

```{r tab_ff_LTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$LTdep_AICw,
             format='pandoc',
             caption = "Model-averaged lower tail dependence statistic for each location pair for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_LTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_ff_UTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$UTdep_AICw,
             format='pandoc',
             caption = "Model-averaged upper tail dependence statistic for each location pair for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_UTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_ff_LTmUT, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$LTdep_AICw-RES_aphid_ff$UTdep_AICw,
             digits = 5,
             format='pandoc',
             caption = "Model averaged lower tail dependence minus model averaged upper tail dependence statistic for each location pair for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_LTmUT}",
             booktabs=TRUE
             )
```

<!--Do the main computations for non-parametric analysis of aphid ff data-->
```{r stat_aphid_ff, echo=F, cache=T,  cache.extra=list(seed,data_aphid_ff,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed)
resloc<-"./Results/stat_results/stat_aphid_ff/"

sp<-11
good_loc<-good_loclist(d_allsp=data_aphid_ff,sp=sp,data_pt_thrs=30)
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_ff<-multcall(d_allsp=data_aphid_ff,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc) 
saveRDS(stat_aphid_ff,paste(resloc,file="stat_aphid_ff_sp_11.RDS",sep='')) 
```

<!--display the main statistical results in a table-->
```{r tab_ff_resamp,echo=F,results="markup"}
s<-stat_aphid_ff$numericdf[,c(3,2,4)]
colnames(s)<-c("Lower 95\\% CI", "Mean", "Upper 95\\% CI")
rownames(s)<-c("Spearman","Kendall","$\\cor_l$","$\\cor_u$","$\\Ps_l$","$\\Ps_u$","$\\Dsq_l$","$\\Dsq_u$","$\\cor_l - \\cor_u$","$\\Ps_l - \\Ps_u$","$\\Dsq_u - \\Dsq_l$")
knitr::kable(s,
             format = "pandoc",
             caption = "Spatially averaged values of statistics and confidence intervals based on resampling for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_resamp}",
             booktabs=TRUE)
```

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_D2u-D2l_vs_D.pdf}
\caption[Non-parametric tail statistics results for leaf-curling plum aphid's first flight date data]{Non-parametric tail statistics results for leaf-curling plum aphid's first flight date data plotted against geographical distance $(D)$ between two sampling locations. (A) Spearman correlation vs. $D$, (B) Kendall correlation vs. $D$, (C) $\cor_l$ vs. $D$, (D) $\cor_u$ vs. $D$; (E) $\Ps_l$ vs. $D$; (F) $\Ps_u$ vs. $D$; (G) $\Dsq_u$ vs. $D$; (H) $\Dsq_l$ vs. $D$; (I) $\cor_l-\cor_u$ vs. $D$; (J) $\Ps_l-\Ps_u$ vs. $D$; (K) $\Dsq_u-\Dsq_l$ vs. $D$ plotted for all pairs of locations. \label{fig_aphid_ff}}
\end{center}
\end{figure}

<!--
\newpage
## Results: abundance data for *Ceratium furca* in UK seas \label{Ex_pns}
### Model selection approach \label{Ex_pns_Model_selection}
### Non-parametric analysis of tail dependence  \label{Ex_pns_NPA}
                          ----moved to Paper.Rmd----
-->

<!--Load the data-->
```{r read_plankton_north_sea_data, echo=F}
source("plankton_north_sea_data_calling.R")
d0_plankton_north_sea<-as.matrix(read.csv("./Data/Plankton_North_Sea_data/planktontimeseries201117_4.csv",header=F))
data_plankton_north_sea<-d_allsp_data_plankton_north_sea(d0_plankton_north_sea)
``` 

<!--Do the model selection for plankton data and then showing results in Tables-->
```{r RES_plankton_north_sea, echo=F, cache=T, results="hide", cache.extra=list(seed,data_plankton_north_sea,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file

set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_plankton_north_sea<-RES_single_sp(d_allsp=data_plankton_north_sea,sp=16,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=45)
#cat(paste("stop-time: ",Sys.time(),"\n"))    
resloc<-"./Results/fitting_results/"
saveRDS(RES_plankton_north_sea,paste(resloc,file="Plankton_North_Sea_CopulaFit_selecloc_species_16.RDS",sep=""))
```

```{r tab_pns_bestcop, echo=F, results="markup"}
knitr::kable(RES_plankton_north_sea$info_ord_copname[,,1], #longtable=T,
             format='pandoc', 
             #caption.short = "Best-fitting copulas for each location pair from among those considered, according to AIC, for abundance data for \\textit{Ceratium furca} in UK seas.",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for **abundance data for \\textit{Ceratium furca} in UK seas**. See \\nameref{MT-Methods} for copula abbreviations. NA occurs along the diagonal because diagonal entries represent a sampling location compared to itself.\\label{tab_pns_bestcop}",
             booktabs=TRUE
             )
```

```{r tab_pns_AICw,echo=F,results="markup"}
h<-RES_plankton_north_sea$info_ord_AICw[,,1]
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_AICw}",
             booktabs=TRUE)
```

```{r tab_pns_AICw_normal,echo=F,results="markup"}
source("normal_cop_AICw.R")
h<-normal_cop_AICw_matrix(r=RES_plankton_north_sea)
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_AICw_normal}",
             booktabs=TRUE)
```

```{r tab_pns_p_CvM,echo=F,results="markup"}
h<-RES_plankton_north_sea$gfc_p_CvM
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **abundance data for *Ceratium furca* in UK seas**. Tests were based on bootstrapping as described in Methods.\\label{tab_pns_p_CvM}",
             booktabs=TRUE)
```

```{r tab_pns_p_KS,echo=F,results="markup"}
h<-RES_plankton_north_sea$gfc_p_KS
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of
the goodness of fit of the lowest-AIC copula family for each pair of
locations for **abundance data for *Ceratium furca* in UK seas**. Tests
were based on bootstrapping as described in Methods.\\label{tab_pns_p_KS}",
             booktabs=TRUE)
```

```{r tab_pns_LTdep_AICw,echo=F,results="markup"}
h<-RES_plankton_north_sea$LTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "Model-averaged lower tail dependence statistic for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_LTdep_AICw}",
             booktabs=TRUE)
```

```{r tab_pns_UTdep_AICw,echo=F,results="markup"}
h<-RES_plankton_north_sea$UTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "Model-averaged upper tail dependence statistic for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_UTdep_AICw}",
             booktabs=TRUE)
```

```{r tab_pns_LTmUT,echo=F,results="markup"}
h<-RES_plankton_north_sea$LTdep_AICw-RES_plankton_north_sea$UTdep_AICw
h[is.nan(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "Model averaged lower tail dependence minus model
averaged upper tail dependence statistic for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_LTmUT}",
             booktabs=TRUE)
```

<!--Do the main computations for non-parametric analysis of plankton data-->
```{r stat_plankton_north_sea, echo=F, cache=T, cache=T,  cache.extra=list(seed,data_plankton_north_sea,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed)
resloc<-"./Results/stat_results/stat_plankton_north_sea/"

sp<-16
good_loc<-good_loclist(d_allsp=data_plankton_north_sea,sp=sp,data_pt_thrs=45)
longs<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlongs201117.csv",header=F)
lats<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlats201117.csv",header=F)
longs<-longs[[1]] 
lats<-lats[[1]]

stat_plankton_north_sea<-multcall(d_allsp=data_plankton_north_sea,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc) 
saveRDS(stat_plankton_north_sea,paste(resloc,file="stat_plankton_north_sea_sp_16.RDS",sep=''))
```

<!--display the main statistical results in a table-->
```{r tab_pns_resamp,echo=F,results="markup"}
s<-stat_plankton_north_sea$numericdf[,c(3,2,4)]
colnames(s)<-c("Lower 95\\% CI", "Mean", "Upper 95\\% CI")
rownames(s)<-c("Spearman","Kendall","$\\cor_l$","$\\cor_u$","$\\Ps_l$","$\\Ps_u$","$\\Dsq_l$","$\\Dsq_u$","$\\cor_l - \\cor_u$","$\\Ps_l - \\Ps_u$","$\\Dsq_u - \\Dsq_l$")
knitr::kable(s,
             format = "pandoc",
             caption = "Spatially averaged values of statistics and confidence intervals based on resampling for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_resamp}",
             booktabs=TRUE)
```

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_D2u-D2l_vs_D.pdf}
\caption[Non-parametric tail statistics results for \textit{Ceratium furca} abundance data]{Non-parametric tail statistics results for \textit{Ceratium furca} abundance data plotted against geographical distance $(D)$ between two sampling locations. (A) Spearman correlation vs. $D$, (B) Kendall correlation vs. $D$, (C) $\cor_l$ vs. $D$, (D) $\cor_u$ vs. $D$; (E) $\Ps_l$ vs. $D$; (F) $\Ps_u$ vs. $D$; (G) $\Dsq_u$ vs. $D$; (H) $\Dsq_l$ vs. $D$; (I) $\cor_l-\cor_u$ vs. $D$; (J) $\Ps_l-\Ps_u$ vs. $D$; (K) $\Dsq_u-\Dsq_l$ vs. $D$ plotted for all pairs of locations. \label{fig_pns}}
\end{center}
\end{figure}


<!--***DAN: stopped here 2018 04 07-->

<!--
\newpage
## Results: methane flux data \label{Ex_methane}
### Model selection approach \label{Ex_methane_Model_selection}
### Non-parametric analysis of tail dependence  \label{Ex_methane_NPA}
                 ----moved to Paper.Rmd----
-->

<!--Load and format the data-->
```{r read_format_methane_data, echo=F}

methane_raw<-readRDS("./Data/Methane_data/methane_data_for_Shyamolina.rds")

myls <- vector("list", length = dim(methane_raw)[2]-1)
for(i in 2:dim(methane_raw)[2]){
  temp<-methane_raw[,c(1,i)]
  colnames(temp)<-c("Year","Dat")
  myls[[i-1]]<-temp
}
methane_data<-list(myls=myls)
``` 

<!--Do the main analysis-->
```{r RES_methane, echo=F, cache=T, results="hide", cache.extra=list(seed,methane_data,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file

set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_methane<-RES_single_sp(d_allsp=methane_data,sp=1,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=50)
#cat(paste("stop-time: ",Sys.time(),"\n"))    
resloc<-"./Results/fitting_results/"
saveRDS(RES_methane,paste(resloc,file="MethaneFluxFit_selecloc_data_pt_thrs_50.RDS",sep=""))
```

```{r tab_methane_bestcop, echo=F, results="markup"}
knitr::kable(RES_methane$info_ord_copname[,,1], #longtable=T,
             format='pandoc',
             #caption.short = "Best-fitting copulas for each location pair from among those considered, according to AIC, for methane-flux data.",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for **methane-flux data**. See \\nameref{MT-Methods} for copula abbreviations. NA occurs along the diagonal because diagonal entries represent a sampling location compared to itself.\\label{tab_methane_bestcop}",
             booktabs=TRUE
             )
```

```{r tab_methane_AICw,echo=F,results="markup"}
h<-RES_methane$info_ord_AICw[,,1]
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for **methane-flux data**.\\label{tab_methane_AICw}",
             booktabs=TRUE)
```

```{r tab_methane_AICw_normal,echo=F,results="markup"}
source("normal_cop_AICw.R")
h<-normal_cop_AICw_matrix(r=RES_methane)
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for **methane-flux data**.\\label{tab_methane_AICw_normal}",
             booktabs=TRUE)
```

```{r tab_methane_p_CvM,echo=F,results="markup"}
h<-RES_methane$gfc_p_CvM
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **methane-flux data**. Tests were based on bootstrapping as described in Methods.\\label{tab_methane_p_CvM}",
             booktabs=TRUE)
```

```{r tab_methane_p_KS,echo=F,results="markup"}
h<-RES_methane$gfc_p_KS
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of
the goodness of fit of the lowest-AIC copula family for each pair of
locations for **methane-flux data**. Tests were based on bootstrapping as described in Methods.\\label{tab_methane_p_KS}",
             booktabs=TRUE)
```

```{r tab_methane_LTdep_AICw,echo=F,results="markup"}
h<-RES_methane$LTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "Model-averaged lower tail dependence statistic for each location pair for **methane-flux data**.\\label{tab_methane_LTdep_AICw}",
             booktabs=TRUE)
```

```{r tab_methane_UTdep_AICw,echo=F,results="markup"}
h<-RES_methane$UTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "Model-averaged upper tail dependence statistic for each location pair for **methane-flux data**.\\label{tab_methane_UTdep_AICw}",
             booktabs=TRUE)
```

```{r tab_methane_LTmUT,echo=F,results="markup"}
h<-RES_methane$LTdep_AICw-RES_methane$UTdep_AICw
h[is.nan(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "Model averaged lower tail dependence minus model
averaged upper tail dependence statistic for each location pair for **methane-flux data**.\\label{tab_methane_LTmUT}",
             booktabs=TRUE)
```

<!--Do the main computations for non-parametric analysis of methane-flux data-->
```{r stat_methane, echo=F, cache=T, cache=T,  cache.extra=list(seed,methane_data,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed)
resloc<-"./Results/stat_results/stat_methane/"

data_pt_thrs<-50
good_loc <- good_loclist(d_allsp=methane_data,sp=1,data_pt_thrs=data_pt_thrs)

latlon<-readRDS("./Data/Methane_data/chamberLocations.rds")
chamber_name<-colnames(methane_raw[,c(2:dim(methane_raw)[2])])
ndim<-length(chamber_name)

latlon_arranged<-data.frame(chamber_name=chamber_name,lat=NA*numeric(ndim),lon=NA*numeric(ndim))
for(i in 1:ndim){
  if (chamber_name[i] %in% latlon$chamber){
    ind<-which(latlon$chamber==chamber_name[i])
    latlon_arranged[i,2:3]<-unname(latlon[ind,2:3])
  }
}

stat_methane<-multcall(d_allsp=methane_data,sp=1,lats=latlon_arranged$lat,longs=latlon_arranged$lon,
                           pfname=paste(resloc,"data_pt_thrs",data_pt_thrs,sep=''),good_loc=good_loc)

saveRDS(stat_methane,paste(resloc,file="stat_methane.RDS",sep='')) 
```

```{r read_stat_methane,echo=F}
stat_methane<-readRDS("./Results/stat_results/stat_methane/stat_methane.RDS")
```

<!--display the main statistical results in a table-->
```{r tab_methane_resamp,echo=F,results="markup"}
s<-stat_methane$numericdf[,c(3,2,4)]
colnames(s)<-c("Lower 95\\% CI", "Mean", "Upper 95\\% CI")
rownames(s)<-c("Spearman","Kendall","$\\cor_l$","$\\cor_u$","$\\Ps_l$","$\\Ps_u$","$\\Dsq_l$","$\\Dsq_u$","$\\cor_l - \\cor_u$","$\\Ps_l - \\Ps_u$","$\\Dsq_u - \\Dsq_l$")
knitr::kable(s,
             format = "pandoc",
             caption = "Spatially averaged values of statistics and confidence intervals based on resampling for **methane-flux data**.\\label{tab_methane_resamp}",
             booktabs=TRUE)
```

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_D2u-D2l_vs_D.pdf}
\caption[Non-parametric tail statistics results for methane-flux data]{Non-parametric tail statistics results for methane-flux data plotted against geographical distance $(D)$ between two sampling locations. (A) Spearman correlation vs. $D$, (B) Kendall correlation vs. $D$, (C) $\cor_l$ vs. $D$, (D) $\cor_u$ vs. $D$; (E) $\Ps_l$ vs. $D$; (F) $\Ps_u$ vs. $D$; (G) $\Dsq_u$ vs. $D$; (H) $\Dsq_l$ vs. $D$; (I) $\cor_l-\cor_u$ vs. $D$; (J) $\Ps_l-\Ps_u$ vs. $D$; (K) $\Dsq_u-\Dsq_l$ vs. $D$ plotted for all pairs of locations. \label{fig_methane}}
\end{center}
\end{figure}

```{r bivar_tab_summary_fn,echo=F}
bivar_tab_summary_fn<-function(r,rs){
  
  m<-matrix(NA,1,12)
  colnames(m)<-c("Indep.p","AIC-best.copula","Highest.AICw",
                 "N.AICw","p.CvM","p.KS",
                 "LT_model.avg","UT_model.avg","(LT-UT)_model.avg",
                 "Rank_Pl_K","Rank_Pu_K","Rank_Pl-Pu_K")
  m<-as.data.frame(m)
  
  m$Indep.p<-round(r$IndepTestRes,3)
  m$`AIC-best.copula`<-r$InfCritRes$copname[which.min(r$InfCritRes$AIC)]
  m$Highest.AICw<-round(max(r$InfCritRes$AICw),3)
  m$N.AICw<-round(r$InfCritRes$AICw[1],3)
  m$p.CvM<-r$GofRes_CvM
  m$p.KS<-r$GofRes_KS
  m$LT_model.avg<-round(r$relLTdep_AICw,3)
  m$UT_model.avg<-round(r$relUTdep_AICw,3)
  m$`(LT-UT)_model.avg`<-m$LT_model.avg-m$UT_model.avg
  m$Rank_Pl_K<-rs$Rank_Pl_K
  m$Rank_Pu_K<-rs$Rank_Pu_K
  m$`Rank_Pl-Pu_K`<-rs$Rank_PlmPu_K
  mt<-as.data.frame(t(m))
  return(mt)
  
}
#----------------------------------
#calling the above function on 3 multivariable datasets
m1<-bivar_tab_summary_fn(r=BivMS_res_Loecke,rs=stat_soilCN_ga)
m2<-bivar_tab_summary_fn(r=BivMS_BMR,rs=stat_BMR_ga)
m3<-bivar_tab_summary_fn(r=BivMS_contrasts_67,rs=stat_contrasts_67_ga)
m4<-bivar_tab_summary_fn(r=BivMS_res_cc$`2000`,rs=stat_cc_ga$`2000`)
tab_bivar_summary<-cbind(m1,m2,m3,m4)
colnames(tab_bivar_summary)<-c("SoilCN","BMR","Anolis","Ceder-creek")
saveRDS(tab_bivar_summary,"./Results/tab_bivar_summary.RDS")
```

```{r multivar_tab_summary_fn,echo=F}
source("normal_cop_AICw.R")

multivar_tab_summary_fn<-function(r,rs){
  
  m<-matrix(NA,1,17)
  colnames(m)<-c("num_pairs","num_non-indep","num_non-N",
                 "Avg.best.AICw","Avg.N.AICw","num_good.fit",
                 "CI0.025_LT","CI0.975_LT","CI0.025_UT","CI0.975_UT",
                 "num_LT-UT>0",
                 "CI0.025_Pl","CI0.975_Pl","CI0.025_Pu","CI0.975_Pu","CI0.025_Pl-Pu","CI0.975_Pl-Pu")
  m<-as.data.frame(m)
  
  normal_AICw<-normal_cop_AICw_matrix(r=r)
  
  d<-dim(r$gfc_numBS)[1]
  m$num_pairs<-(d^2)-d 
  m$`num_non-indep`<- (d^2)-d-2*(r$num_indep_loc_pair+r$num_neg_cor_loc_pair)
  m$`num_non-N`<-sum(r$info_ord_copcode[,,1]!=1,na.rm = T)
  r$info_ord_AICw[r$info_ord_AICw==Inf] <- NaN
  m$Avg.best.AICw<-round(mean(r$info_ord_AICw[,,1],na.rm = T),3)
  normal_AICw[normal_AICw==Inf]<-NaN
  m$Avg.N.AICw<-round(mean(normal_AICw,na.rm=T),3)
  temp<-which((r$gfc_p_CvM>0.01) & (r$gfc_p_KS>0.01),arr.ind=T)
  m$num_good.fit<-dim(temp)[1]
  t<-r$LTdep_AICw[is.finite(r$LTdep_AICw)]
  CI_LT<-unname(quantile(t,probs=c(0.025,0.975),na.rm = T))
  m$CI0.025_LT<-round(CI_LT[1],3)
  m$CI0.975_LT<-round(CI_LT[2],3)
  t<-r$UTdep_AICw[is.finite(r$UTdep_AICw)]
  CI_UT<-unname(quantile(t,probs=c(0.025,0.975),na.rm = T))
  m$CI0.025_UT<-round(CI_UT[1],3)
  m$CI0.975_UT<-round(CI_UT[2],3)
  m$`num_LT-UT>0`<-sum(r$LTdep_AICw-r$UTdep_AICw>0,na.rm=T)
  m$CI0.025_Pl<-round(rs$numericdf[5,3],3)
  m$CI0.975_Pl<-round(rs$numericdf[5,4],3)
  m$CI0.025_Pu<-round(rs$numericdf[6,3],3)
  m$CI0.975_Pu<-round(rs$numericdf[6,4],3)
  m$`CI0.025_Pl-Pu`<-round(rs$numericdf[10,3],3)
  m$`CI0.975_Pl-Pu`<-list(round(rs$numericdf[10,4],3))
  #m$`CI0.975_Pl-Pu`<-round(rs$numericdf[10,4],3)
  #m$CI_Pl<-list(c(round(rs$numericdf[5,3],3),round(rs$numericdf[5,4],3)))
  #m$CI_Pu<-list(c(round(rs$numericdf[6,3],3),round(rs$numericdf[6,4],3)))
  #m$`CI_Pl-Pu`<-list(c(round(rs$numericdf[10,3],3),round(rs$numericdf[10,4],3)))
  
  mt<-as.data.frame(t(m))
  return(mt)
  
}
#----------------------------------
#calling the above function on 4 multivariable datasets
m1<-multivar_tab_summary_fn(r=RES_aphid_count,rs=stat_aphid_count)
m2<-multivar_tab_summary_fn(r=RES_aphid_ff,rs=stat_aphid_ff)
m3<-multivar_tab_summary_fn(r=RES_plankton_north_sea,rs=stat_plankton_north_sea)
m4<-multivar_tab_summary_fn(r=RES_methane,rs=stat_methane)
tab_multivar_summary<-cbind(m1,m2,m3,m4)
colnames(tab_multivar_summary)<-c("Aphid_abundance","Aphid_firstflight","Plankton","Methane-flux")
saveRDS(tab_multivar_summary,"./Results/tab_multivar_summary.RDS")
```

```{r sample_plot_aphid_count_ff,echo=F,results="hide"}
#-------------------------------------------------------------------------------
# code to plot raw data and copula plot for aphid count @location pair (4,11)
# bestfit cop : SJ

d1<-data_aphid_count$`Green spruce aphid`[[4]]
d2<-data_aphid_count$`Green spruce aphid`[[11]]
pdf("./Results/Aphid_count_raw_loc_4_11.pdf",height = 8,width=8)
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(d1$Dat,d2$Dat,type="p",col="red",xlab="Aphid abundance from location 4",ylab="Aphid abundance from location 11",cex.lab=1.5,cex.axis=1.5)
par(op)
dev.off()

source("./vivj_matrix.R")
m<-vivj_matrix(d_allsp = data_aphid_count,sp=10,i=4,j=11)
pdf("./Results/Aphid_count_cop_loc_4_11.pdf",height = 8,width=8)
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(m[,1],m[,2],type="p",col="red",xlab="u",ylab="v",
     cex.lab=2,cex.axis=1.5,
     xlim=c(0,1),ylim=c(0,1),asp=1)
rect(0,0,1,1)
lines(c(0,1),c(0,1),type='l')
par(op)
dev.off()

# code to plot raw data and copula plot for aphid ff @location pair (2,5)
# bestfit cop : J
d1<-data_aphid_ff$`Leaf-curling plum aphid`[[2]]
d2<-data_aphid_ff$`Leaf-curling plum aphid`[[5]]
pdf("./Results/Aphid_ff_raw_loc_2_5.pdf",height = 8,width=8)
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(d1$Dat,d2$Dat,type="p",col="red",xlab="Aphid first-flight from location 2",ylab="Aphid first-flight from location 5",cex.lab=1.5,cex.axis=1.5)
par(op)
dev.off()

m<-vivj_matrix(d_allsp = data_aphid_ff,sp=11,i=2,j=5)
pdf("./Results/Aphid_ff_cop_loc_2_5.pdf",height = 8,width=8)
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(m[,1],m[,2],type="p",col="red",xlab="u",ylab="v",
     cex.lab=2,cex.axis=1.5,
     xlim=c(0,1),ylim=c(0,1),asp=1)
rect(0,0,1,1)
lines(c(0,1),c(0,1),type='l')
par(op)
dev.off()
```

<!--
#Results section detailed description
### soil C and N data \label{Ex_SoilCN}

```{r read_BivMS_soilCN_data,echo=F}
BivMS_res_Loecke<-readRDS("./Results/fitting_results/BivMS_soilCN.RDS")
```

#### Model selection approach \label{Ex_SoilCN_Model_selection}

The test of indepedence gave $p=$ `r BivMS_res_Loecke$IndepTestRes` (to within the precision available 
from `BiCopIndTest` in the `VineCopula` package). We fitted several copulas
and got AIC values and upper- and lower-tail dependency estimates based on the fitted copulas (Table \ref{SM-tab_soilCNfit}). The table shows that several copulas are much better supported (higher AIC and BIC weights) than the Normal copula, answering the first part of question 1 for these data.

The model-averaged (AIC weights used for model averaging) lower-tail dependence statistic was `r BivMS_res_Loecke$relLTdep_AICw` and the model-averaged upper-tail dependence statistic was `r BivMS_res_Loecke$relUTdep_AICw`. These values are distinct from what a Normal copula would give (i.e., 0), answering the second part of question 1 for these data. Furthermore, the difference of these two quantities (lower minus upper), `r BivMS_res_Loecke$relLTdep_AICw-BivMS_res_Loecke$relUTdep_AICw`, was different from 0, answering the third part of question 1. 

Although these results do convincingly show non-Normal copula structure, we should take the tail dependence results with a grain of salt because even the lowest-AIC copula was a poor fit, giving $p$-value `r BivMS_res_Loecke$GofRes_CvM` (to within the precision available from `BiCopGofTest` in the `VineCopula` package) in the Cramer-von Mises-based test of the goodness of its fit, and $p$-value `r BivMS_res_Loecke$GofRes_KS` in the Kolmogorov-Smirnov-based test of the goodness of fit. The next section looks at tail dependence in a non-parametric way.

#### Non-parametric analysis of tail dependence \label{Ex_SoilCN_NPA}

As described in \nameref{Methods}, each of our statistics, as computed for the 
ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (with $10$ number of bins), was compared to the distributions 
of values of the same statistic with the same ranges computed on 1000 normal-copula 
surrogate datasets with similar Kendall or Spearman correlations, in different 
runs for Kendall and Spearman (Fig. \ref{SM-fig_soilCN_nonparam}). 

Results indicate that tail dependence of 
data is stronger in both the lower and upper tails than would be expected under a 
null hypothesis of a normal copula, answering the second part of question 1. The dependence between C and N is also 
weaker in the middle of the distributions
than would be expected based on a normal-copula null model.

We also tested statistically for asymmetry of tail dependence, which seems visible in Fig. \ref{SM-fig_raw_cop_soilCN}(B). 
Results (Table \ref{SM-tab_soilCN_asym}) show that upper-tail dependence was, indeed, significantly stronger than lower-tail dependence in these data, answering the third part of question 1.

### BMR data \label{Ex_BMR}

```{r read_BivMS_BMR_data,echo=F}
BivMS_BMR<-readRDS("./Results/BMR_results/BivMS_lnBMR_vs_lnmass.RDS")
```

#### Model selection approach \label{Ex_BMR_Model_selection}

The test of indepedence gave $p=$ `r BivMS_BMR$IndepTestRes` (to within the precision available from `BiCopIndTest` in the `VineCopula` package). We fitted several copulas
and got AIC values and upper- and lower-tail dependency estimates based on the fitted copulas (Table \ref{SM-tab_BMRfit}). The table shows that BB6 and BB8 are much better supported (higher AIC and BIC weights) than the Normal copula, answering the first part of question 1 for these data.

The model-averaged (AIC weights used for model averaging) lower-tail and upper-tail dependence statistic was `r BivMS_BMR$relLTdep_AICw - BivMS_BMR$relUTdep_AICw`, indicating more upper tail dependence. We also tested that lowest-AIC copula BB8 was a good-enough fit, giving $p$-value `r BivMS_BMR$GofRes_CvM` (to within the precision available from `BiCopGofTest` in the `VineCopula` package) in the Cramer-von Mises-based test of the goodness of its fit, and $p$-value `r BivMS_BMR$GofRes_KS` in the Kolmogorov-Smirnov-based test of the goodness of fit. The next section looks at tail dependence in a non-parametric way.

#### Non-parametric analysis of tail dependence \label{Ex_BMR_NPA}

As described in \nameref{Methods}, each of our statistics, as computed for the ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (with $10$ number of bins), was compared to the distributions of values of the same statistic with the same ranges computed on 1000 normal-copula surrogate datasets with similar Kendall or Spearman correlations, in different runs for Kendall and Spearman (Fig. \ref{SM-fig_BMR_nonparam}). 

Results indicate that dependence of data is different in some bins than would be expected under a 
null hypothesis of a normal copula, answering the second part of question 1. Table \ref{SM-tab_BMR_asym} indicates stronger upper tail dependence for the BMR data copula which is significantly (95% CI) different from that of the symmetric normal copula and thus consistent with model selection results.

### Anolis data \label{Ex_contrasts}

```{r read_BivMS_contrasts_67_data,echo=F}
BivMS_contrasts_67<-readRDS("./Results/Anolis_results/contrasts_csv_results/BivMS_contrasts_67.RDS")
```

#### Model selection approach \label{Ex_contrasts_Model_selection}

The test of indepedence gave $p=0$  (to within the precision available 
from `BiCopIndTest` in the `VineCopula` package). We fitted several copulas
and got AIC values and upper- and lower-tail dependency estimates based on the fitted copulas (Table \ref{SM-tab_contrasts_67fit}). The table shows that several copulas (mostly J and SC) are much better supported (higher AIC and BIC weights) than the Normal copula, answering the first part of question 1 for these data.

The model-averaged (AIC weights used for model averaging) lower-tail dependence statistic was `r BivMS_contrasts_67$relLTdep_AICw` and the model-averaged upper-tail dependence statistic was `r BivMS_contrasts_67$relUTdep_AICw`. These values are distinct from what a Normal copula would give (i.e., 0), answering the second part of question 1 for these data. Furthermore, the difference of these two quantities (lower minus upper), `r BivMS_contrasts_67$relLTdep_AICw-BivMS_contrasts_67$relUTdep_AICw`, was different from 0, answering the third part of question 1. 

These results do convincingly show non-Normal copula structure, giving $p$-value `r BivMS_contrasts_67$GofRes_CvM` (to within the precision available from `BiCopGofTest` in the `VineCopula` package) in the Cramer-von Mises-based test of the goodness of its fit, and $p$-value `r BivMS_contrasts_67$GofRes_KS` in the Kolmogorov-Smirnov-based test of the goodness of fit. The next section looks at tail dependence in a non-parametric way.

#### Non-parametric analysis of tail dependence \label{Ex_contrasts_67_NPA}

As described in \nameref{Methods}, each of our statistics, are computed for $(l_b,u_b)$ in the 
ranges $0-0.25$, $0.25-0.5$, $0.5-0.75$, $0.75-1$ (with $4$ number of bins). Anolis data set has lesser number of data compared to other two bivariate data set, so fewer number of bins were chosen to measure tail-dependence.
Those statistics were compared to the distributions of values of the same statistic with the same ranges computed on 1000 normal-copula surrogate datasets with similar Kendall or Spearman correlations, in different 
runs for Kendall and Spearman (Fig. \ref{SM-fig_contrasts_67_nonparam}). 

Results indicate that tail dependence of 
data is stronger in both the lower and upper tails than would be expected under a 
null hypothesis of a normal copula, answering the second part of question 1. 

We also tested statistically for asymmetry of tail dependence, which seems visible in Fig. \ref{SM-fig_raw_cop_AVG_humerus_ltoe}(B). Results (Table \ref{SM-tab_contrasts_67_asym}) show that upper-tail dependence was, indeed, significantly stronger than lower-tail dependence in these data, answering the third part of question 1.



### Abundance data for the green spruce aphid, *Elatobium abietinum* \label{Ex_count}

```{r read_RES_aphid_count, echo=F}
RES_aphid_count<-readRDS("./Results/fitting_results/AphidCopulaFit_selecloc_count_species_10.RDS")
```

#### Model selection approach \label{Ex_count_Model_selection}

As described in Methods, model selection among copulas was done separately for each pair of the 10 
sampling locations, thus results are presented in $10 \times 10$ matrix format with rows and columns 
corresponding to locations. Table \ref{SM-tab_count_bestcop} shows that, for the large majority of location 
pairs, some non-normal copula was a better fit, according to AIC, than was the normal copula, answering the first part of 
question 1 for these data. Comparing the 
AIC weight of the best-fitting (lowest AIC) copula family for each pair of sampling locations (Table \ref{SM-tab_count_AICw}) 
to the AIC weight 
of the normal copula family for the same pair (Table \ref{SM-tab_count_AICw_normal}) confirms that the degree of support for normal copulas was usually not
comparable to the degree of support for other families.
Goodness of fit tests based on a Cramer-von Mises statistic (Table \ref{SM-tab_count_p_CvM}) in every case 
failed to reject the hypothesis that the AIC-best copula family was also an objectively adequate description of 
the data, and likewise for goodness of fit tests based on a Kolmogorov-Smirnov statistic (Table \ref{SM-tab_count_p_KS}),
demonstrating that the collection of copula families we used was sufficiently broad that the copulas of 
all pairs of locations could be characterized by at least one of them. In all cases at least `r min((RES_aphid_count$gfc_numBS_success/RES_aphid_count$gfc_numBS),na.rm=T)*100` percent of bootstrap randomizations used for goodness of fit tests successfully lead to values of the statistic for comparison with its value on the real data.

The model-averaged (averaging performed using AIC weights) lower-tail dependence statistic and the model-averaged (again, AIC based) upper-tail dependence statistic are in Tables \ref{SM-tab_count_LTdep_AICw} and \ref{SM-tab_count_UTdep_AICw} respectively. These values were exclusively positive, thereby differing from what a normal copula would give (i.e., 0), and answering the second part of question 1 for these data. Apparently these aphid data have greater tail dependence (both lower and upper) than would be expected from a normal-copula null hypothesis. 

The difference between the model-averaged lower-tail dependence statistic and the model-averaged upper-tail dependence statistic (lower minus upper), shown in Table \ref{SM-tab_count_LTmUT}, is positive for all but a few locations pairs (`r sum((RES_aphid_count$LTdep_AICw-RES_aphid_count$UTdep_AICw)>0,na.rm=T)` out of `r (dim(RES_aphid_count$gfc_p_CvM)[1]^2-dim(RES_aphid_count$gfc_p_CvM)[1])-2*RES_aphid_count$num_indep_loc_pair`), answering the third part of question 1. 

#### Non-parametric analysis of tail dependence \label{Ex_count_NPA}

Mean values of our statistics ($\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_l$, $\Dsq_u$, 
$\cor_l-\cor_u$, $\Ps_l-\Ps_u$, $\Dsq_u-\Dsq_l$), as well as mean Kendall and Spearman correlations, were 
computed across all pairs of sampling locations, and confidence intervals of these means were computed via a spatial
resampling scheme, as described in Methods (Table \ref{SM-tab_count_resamp}). Confidence intervals of
$\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_l$, and $\Dsq_u$ always excluded zero and mean values were positive,
indicating tail dependence. Confidence intervals of $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, $\Dsq_u-\Dsq_l$ also always 
exluded $0$ and were positive, indicating asymmetry of tail dependence, a feature that data with normal copula 
structure do not have, providing further evidence answering the third part of question 1. 

Plotting Spearman or Kendall correlation between aphid abundance time series for pairs of locations as a function of great circle distance between the locations (Fig. \ref{SM-fig_aphid_count} A,B) showed the typical decline of correlation with 
distance between sampling locations that has been seen for numerous other datasets in earlier work. Plotting 
$\cor_l$, $\cor_u$, $\Ps_l$, and $\Ps_u$  against distance between pairs of locations shows these quantities also decline with distance (Fig. \ref{SM-fig_aphid_count} C-F). Plotting $\Dsq_u$ and  $\Dsq_l$ against distance between pairs of locations shows
these quantities increase with distance (as expected, given the opposite interpretation these two statistics have compared to $\cor_u$, $\Ps_u$ and $\cor_l$, $\Ps_l$, respectively). Plotting $\cor_l - \cor_u$, $\Ps_l - \Ps_u$, and $\Dsq_u - \Dsq_l$ versus distance (Fig. \ref{SM-fig_aphid_count} I-K) did not show a decline with distance, but did illustrate visually the statistical
result of Table \ref{SM-tab_count_resamp} that averages of these quantities across all pairs of sampling locations
were significantly greater than zero, demonstrating asymmetry of tail dependence. Code for these analyses is in [`NonParamStat.R`](https://github.com/sghosh89/BIVAN/blob/master/NonParamStat.R) in the [`BIVAN`](https://github.com/sghosh89/BIVAN) package. 

### First flight date data for the leaf-curling plum aphid, *Brachycaudus helichrysi* \label{Ex_ff}

```{r read_RES_aphid_ff,echo=F}
RES_aphid_ff<-readRDS("./Results/fitting_results/AphidCopulaFit_selecloc_firstflight_species_11.RDS")
```

#### Model selection approach \label{Ex_ff_Model_selection}

As in section \nameref{Ex_count_Model_selection}, results are presented in $10 \times 10$ matrix format with rows
and columns corresponding to locations. Table \ref{SM-tab_ff_bestcop} shows that, for the large majority of location pairs, some non-normal copula was a better fit, according to AIC, than was the normal copula, answering the first part of question 1 for these data. Comparing the AIC weight of the best-fitting (lowest AIC) copula family for each pair of sampling locations (Table \ref{SM-tab_ff_AICw}) to the AIC weight of the normal copula family for the same pair (Table \ref{SM-tab_ff_AICw_normal}) confirms that the degree of support for normal copulas was usually not comparable to the degree of support for other families. Goodness of fit tests based on a Cramer-von Mises statistic (Table \ref{SM-tab_ff_p_CvM}) usually failed to reject the 
hypothesis that the AIC-best copula family was also an objectively adequate description of the data, and likewise for 
goodness of fit tests based on a Kolmogorov-Smirnov statistic (Table \ref{SM-tab_ff_p_KS}). In all cases at least `r min((RES_aphid_ff$gfc_numBS_success/RES_aphid_ff$gfc_numBS),na.rm=T)*100` percent of bootstrap randomizations used for
goodness of fit tests successfully lead to values of the statistic for comparison with its value on the real data.

The model-averaged (averaging performed using AIC weights) lower-tail dependence statistic and 
the model-averaged (again, AIC based) upper-tail dependence statistic are in 
Tables \ref{SM-tab_ff_LTdep_AICw} and \ref{SM-tab_ff_UTdep_AICw}, respectively. These values were exclusively positive, thereby differing from what a normal copula would give (i.e., $0$), and answering the second part of question 1 for these data - these data have greater tail dependence (lower and upper) than would be expected from a normal-copula null hypothesis. 

The difference between the model-averaged lower-tail dependence statistic and the 
model-averaged upper-tail dependence statistic (lower minus upper), shown in 
Table \ref{SM-tab_ff_LTmUT}, was negative for `r sum((RES_aphid_ff$LTdep_AICw-RES_aphid_ff$UTdep_AICw)<0,na.rm=T)` 
out of `r (dim(RES_aphid_ff$gfc_p_CvM)[1]^2-dim(RES_aphid_ff$gfc_p_CvM)[1])-2*RES_aphid_ff$num_indep_loc_pair` location pairs, answering the third part of question 1. We note this result is opposite the analogous result for aphid abundance
data for the green spruce aphid, i.e., whereas those abundance data showed stronger lower tail dependendence than upper tail dependence, first flights for the leaf-curling plum aphid showed stronger upper tail dependence than lower tail dependence. 

#### Non-parametric analysis of tail dependence  \label{Ex_ff_NPA}

Mean values of our statistics ($\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_l$, $\Dsq_u$, 
$\cor_l-\cor_u$, $\Ps_l-\Ps_u$, $\Dsq_u-\Dsq_l$), as well as mean Kendall and Spearman 
correlations, were computed across all pairs of sampling locations, and confidence intervals of these means were 
computed via a spatial resampling scheme, as described in \nameref{Methods} (Table \ref{SM-tab_ff_resamp}).
Confidence intervals of $\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_l$, and $\Dsq_u$ always excluded 
zero and mean values were positive, indicating tail dependence. Confidence intervals of $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, $\Dsq_u-\Dsq_l$ also always exluded $0$ and were negative, indicating asymmetry of tail dependence, a feature 
that data with normal copula structure do not have, providing further evidence answering the third part of question 1.
The contrast here with the analogous results for abundances of the green spruce aphid is again illuminating. 

Plotting Spearman or Kendall correlations between first flight time series for pairs of locations as a function of great circle distance between the locations (Fig. \ref{SM-fig_aphid_ff} A, B) showed the typical (though slight, in this case) decline of correlation with increasing distance. Plotting $\cor_l$, $\cor_u$, $\Ps_l$, and $\Ps_u$ against distances between pairs of locations shows these quantities also appear in most cases to decline slightly with distance (Fig. \ref{SM-fig_aphid_ff} C-F).
$\Dsq_u$ and $\Dsq_l$ appear to slightly increase with distance, as expected given their
opposite meaning (Fig. \ref{SM-fig_aphid_ff} G-H). 
Plotting $\cor_l - \cor_u$, $\Ps_l - \Ps_u$, and $\Dsq_u - \Dsq_l$ against distance (Fig. \ref{SM-fig_aphid_ff} I-K) did not show a decline with distance, but did demonstrate visually the statistical result of Table \ref{SM-tab_ff_resamp} that averages of these quantities across all pairs of sampling locations were significantly less than zero, showing asymmetry of tail dependence. 

### Abundance data for *Ceratium furca* in UK seas \label{Ex_pns}

```{r read_RES_plankton_north_sea,echo=F}
RES_plankton_north_sea<-readRDS("./Results/fitting_results/Plankton_North_Sea_CopulaFit_selecloc_species_16.RDS")
```

#### Model selection approach \label{Ex_pns_Model_selection}

As described in Methods and as in previous sections, model selection among copulas was done separately for 
each pair of sampling locations. There were $14$ sampling locations, so results are presented in $14 \times 14$ matrix format, with rows and columns corresponding to locations. Table \ref{SM-tab_pns_bestcop} shows that, for the large majority of location pairs, some non-normal copula was a better fit, according to AIC, than was the normal copula, answering the first part of question 1 for these data. Comparing the AIC weight of the lowest-AIC copula family for each pair of sampling locations (Table \ref{SM-tab_pns_AICw}) to the AIC weight of the normal copula family for the same pair (Table \ref{SM-tab_pns_AICw_normal}) 
confirms that the degree of support for normal copulas was usually not comparable to the degree of support for other families.
Goodness of fit tests based on a Cramer-von Mises statistic (Table \ref{SM-tab_pns_p_CvM}) usually failed to reject the hypothesis that the AIC-best copula family was also an objectively adequate description of the data, and likewise for goodness of fit tests based on a Kolmogorov-Smirnov statistic (Table \ref{SM-tab_pns_p_KS}). In all cases at least
`r min((RES_plankton_north_sea$gfc_numBS_success/RES_plankton_north_sea$gfc_numBS),na.rm=T)*100` percent of bootstrap randomizations used for goodness of fit tests successfully lead to values of the statistic for comparison with its value on the real data.

The model-averaged (averaging performed using AIC) lower-tail dependence statistic and the model-averaged (again, AIC based) upper-tail dependence statistics are in Tables \ref{SM-tab_pns_LTdep_AICw} and \ref{SM-tab_pns_UTdep_AICw}, respectively. These values were exclusively positive, thereby
differing from what a normal copula would give (i.e., 0), and answering the second part of question 1 for these data - these data
have greater tail dependence (lower and upper) than would be expected from a normal-copula null hypothesis.

The difference between the model-averaged lower-tail dependence statistic and the model-averaged upper-tail dependence statistic
(lower minus upper), shown in Table \ref{SM-tab_pns_LTmUT}, was positive for some
location pairs and negative for others, but was positive for 
`r sum((RES_plankton_north_sea$LTdep_AICw-RES_plankton_north_sea$UTdep_AICw)>0,na.rm=T)` out of `r (dim(RES_plankton_north_sea$gfc_p_CvM)[1]^2-dim(RES_plankton_north_sea$gfc_p_CvM)[1])-2*RES_plankton_north_sea$num_indep_loc_pair`
locations pairs. Thus lower tail dependence tended to be stronger than upper tail dependence, answering the third part of question 1. 

#### Non-parametric analysis of tail dependence  \label{Ex_pns_NPA}

Mean values of our statistics, as well as mean Kendall and Spearman
correlations, were computed across all pairs of sampling locations, and confidence intervals of these means were computed via a
spatial resampling scheme, as described in Methods (Table \ref{SM-tab_pns_resamp}).
Confidence intervals of $\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_l$, $\Dsq_u$
always excluded $0$ and mean values were positive, indicating tail dependence.
Confidence intervals of $\cor_l-\cor_u$, $\Ps_l-\Ps_u$ and $\Dsq_u-\Dsq_l$
also all were strictly positive, indicating asymmetry of tail dependence, a feature that data with normal copula
structure do not have, providing further evidence answering the third part of question 1.

Plotting Spearman or Kendall correlations between time series for pairs of locations as a function of great circle distance
between the locations (Fig. \ref{SM-fig_pns} A, B) showed the typical decline of correlation with increasing
distance. Plotting $\cor_l$ , $\cor_u$ , $\Ps_l$, and $\Ps_u$ against distances between pairs of locations shows these quantities also appear to decline with distance (Fig. \ref{SM-fig_pns} C-F). $\Dsq_u$ and $\Dsq_l$ appear to increase with distance, as expected given their opposite meaning (Fig. \ref{SM-fig_pns} G-H). Plotting $\cor_l - \cor_u$, $\Ps_l - \Ps_u$, and $\Dsq_u - \Dsq_l$ against distance (Fig. \ref{SM-fig_pns} I-K) did not show a decline with distance, but did demonstrate visually the 
statistical result of Table \ref{SM-tab_pns_resamp} that averages of these 
quantities across all pairs of sampling locations were significantly greater 
than zero, showing asymmetry of tail dependence.

### Methane flux data \label{Ex_methane}

```{r read_RES_methane,echo=F}
RES_methane<-readRDS("./Results/fitting_results/MethaneFluxFit_selecloc_data_pt_thrs_50.RDS")
```

#### Model selection approach \label{Ex_methane_Model_selection}

As described in Methods and as in previous sections, model selection among copulas was done separately for 
each pair of sampling locations. There were $13$ sampling locations, so results are presented in 
$13 \times 13$ matrix format, with rows and columns corresponding to locations. 
Table \ref{SM-tab_methane_bestcop} shows that, for the large majority of location pairs, some 
non-normal copula was a better fit, according to AIC, than was the normal copula, answering the 
first part of question 1 for these data. Comparing the AIC weight of the lowest-AIC copula 
family for each pair of sampling locations (Table \ref{SM-tab_methane_AICw}) to the AIC weight of
the normal copula family for the same pair (Table \ref{SM-tab_methane_AICw_normal}) 
confirms that the degree of support for normal copulas was usually not comparable to the degree of support for other families.
Goodness of fit tests based on a Cramer-von Mises statistic (Table \ref{SM-tab_methane_p_CvM}) usually failed to reject the hypothesis that the AIC-best copula family was also an objectively adequate description of the data, and likewise for goodness of fit tests based on a Kolmogorov-Smirnov statistic (Table \ref{SM-tab_methane_p_KS}). In all cases at least
`r min((RES_methane$gfc_numBS_success/RES_methane$gfc_numBS),na.rm=T)*100` percent of bootstrap randomizations used for goodness of fit tests successfully lead to values of the statistic for comparison with its value on the real data.

The model-averaged (averaging performed using AIC) lower-tail dependence statistic and the model-averaged (again, AIC based) upper-tail dependence statistics are in Tables \ref{SM-tab_methane_LTdep_AICw} and \ref{SM-tab_methane_UTdep_AICw}, respectively. These values were exclusively positive, thereby
differing from what a normal copula would give (i.e., 0), and answering the second part of question 1 for these data - these data
have greater tail dependence (lower and upper) than would be expected from a normal-copula null hypothesis.

The difference between the model-averaged lower-tail dependence statistic and the model-averaged upper-tail dependence statistic
(lower minus upper), shown in Table \ref{SM-tab_methane_LTmUT}, was positive for some
location pairs and negative for others, but was positive for 
`r sum((RES_methane$LTdep_AICw-RES_methane$UTdep_AICw)>0,na.rm=T)` out of `r (dim(RES_methane$gfc_p_CvM)[1]^2-dim(RES_methane$gfc_p_CvM)[1])-2*RES_methane$num_indep_loc_pair`
locations pairs. Thus lower tail dependence tended to be stronger than upper tail dependence, answering the third part of question 1. 

#### Non-parametric analysis of tail dependence  \label{Ex_methane_NPA}

Mean values of our statistics, as well as mean Kendall and Spearman
correlations, were computed across all pairs of sampling locations, and confidence intervals of these means were computed via a
spatial resampling scheme, as described in Methods (Table \ref{SM-tab_methane_resamp}).
Confidence intervals of $\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_l$, $\Dsq_u$
always excluded $0$ and mean values were positive, indicating tail dependence. But the confidence intervals of $\cor_l-\cor_u$, $\Ps_l-\Ps_u$ and $\Dsq_u-\Dsq_l$ were marginal, indicating no significant asymmetry of tail dependence.

Plotting Spearman or Kendall correlations between time series for pairs of locations as a function of great circle distance
between the locations (Fig. \ref{SM-fig_methane} A, B) showed the typical decline of correlation with increasing
distance. Plotting $\cor_l$ , $\cor_u$ , $\Ps_l$, and $\Ps_u$ against distances between pairs of locations shows these quantities also appear to decline with distance (Fig. \ref{SM-fig_methane} C-F). $\Dsq_u$ and $\Dsq_l$ appear to increase with distance, as expected given
their opposite meaning (Fig. \ref{SM-fig_methane} G-H). Plotting $\cor_l - \cor_u$, $\Ps_l - \Ps_u$, and $\Dsq_u - \Dsq_l$ against distance (Fig. \ref{SM-fig_methane} I-K) did not show a decline with distance, but did demonstrate visually the 
statistical result of Table \ref{SM-tab_methane_resamp} that averages of these 
quantities across all pairs of sampling locations were more or less equally dispersed around the zero-line, showing no significant asymmetry of tail dependence.
-->

<!--
# Question 2 analyses 
## The Moran effect and copula structure in populations 
           ----moved to Paper.Rmd----
-->

```{r cause4copula_pGOF_500, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
pdf("./Results/Cause4copula_results/compare_params_pGOF_num_keep_last_500.pdf", width=8, height=6)
op<-par(mfrow=c(2,2))

Plotter_Cause4copula_GOF(N=5000,fcode=3,method = "spearman",num_keep_last=500,BS=1000)
Plotter_Cause4copula_GOF(N=5000,fcode=13,method="spearman",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=4,method = "spearman",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=14,method="spearman",num_keep_last=500,BS=1000)

Plotter_Cause4copula_GOF(N=5000,fcode=3,method = "kendall",num_keep_last=500,BS=1000)
Plotter_Cause4copula_GOF(N=5000,fcode=13,method="kendall",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=4,method = "kendall",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=14,method="kendall",num_keep_last=500,BS=1000)

#par(op)

op<-par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 1, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("top", c("noise", "population", "p_CvM", "p_KS"), col = c("red", "blue", "magenta", "green2"),
       cex = 1.5, pch = c(2, 6, 16, 16), xpd = TRUE, horiz = TRUE, inset = c(0,0), 
       bty = "n") 
par(op)
dev.off()
```

```{r cause4copula_pGOF_2500, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
# I need to fix that SG_kendall ylimit error : I think I fixed it
#----------------------------
pdf("./Results/Cause4copula_results/compare_params_pGOF_num_keep_last_2500.pdf", width=8, height=6)
op<-par(mfrow=c(2,2))

Plotter_Cause4copula_GOF(N=5000,fcode=3,method = "spearman",num_keep_last=2500,BS=1000)
Plotter_Cause4copula_GOF(N=5000,fcode=13,method="spearman",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=4,method = "spearman",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=14,method="spearman",num_keep_last=2500,BS=1000)

Plotter_Cause4copula_GOF(N=5000,fcode=3,method = "kendall",num_keep_last=2500,BS=1000)
Plotter_Cause4copula_GOF(N=5000,fcode=13,method="kendall",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=4,method = "kendall",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=14,method="kendall",num_keep_last=2500,BS=1000)

op<-par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("top", c("noise", "population", "p_CvM", "p_KS"), col = c("red", "blue", "magenta", "green2"),
       cex = 1.5, pch = c(2, 6, 16, 16), xpd = TRUE, horiz = TRUE, inset = c(0,0), 
       bty = "n") 
par(op)
dev.off()
```

```{r cause4copula_stat, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
pdf("./Results/Cause4copula_results/Clayton_spearman.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=3,method="spearman",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/Clayton_kendall.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=3,method="kendall",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/SClayton_spearman.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=13,method="spearman",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/SClayton_kendall.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=13,method="kendall",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/Gumbel_spearman.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=4,method="spearman",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/Gumbel_kendall.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=4,method="kendall",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/SGumbel_spearman.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=14,method="spearman",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/SGumbel_kendall.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=14,method="kendall",lb=0,ub=0.1,num_keep_last=500)
dev.off()
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Cause4copula_results/compare_params_pGOF_num_keep_last_500.pdf}
\caption[Testing GOF between noise-copula parameters and estimated population copula parameters with $500$ sampling points]{Results of comparison between the parameters of environmental noise generated from a specific family of copula and estimated sample parameter (with some standard error) of the affected populations (Initially 5000 points are generated but we kept last \textbf{500} points for both noise and population data for comparison) \label{fig_Cause4copula_params_GOF_500}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Cause4copula_results/compare_params_pGOF_num_keep_last_2500.pdf}
\caption[Testing GOF between noise-copula parameters and estimated population copula parameters with $2500$ sampling points]{Results of comparison between the parameters of environmental noise generated from a specific family of copula and estimated sample parameter (with some standard error) of the affected populations (Initially 5000 points are generated but we kept last \textbf{2500} points for both noise and population data for comparison) \label{fig_Cause4copula_params_GOF_2500}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Cause4copula_results/Clayton_spearman.pdf}
\caption[Comparing correlations and non-parametric statistic between noise-copula (\textbf{Clayton}) and population copula for different \textbf{Spearman's Rho}]{Results of comparison between 3 types of correlation (i.e. Spearman, Kendall, Pearson) and 6 non-parametric stats ($\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_u$ and $\Dsq_l$) of environmental noise generated from \textbf{Clayton} copula and of the affected populations for 9 equidistant \textbf{Spearman's Rho} values in a range (0.1 to 0.9) (Initially $5000$ points are generated but we kept last $500$ points for both noise and population data for comparison) \label{fig_Cause4copula_C_spear}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Cause4copula_results/Clayton_kendall.pdf}
\caption[Comparing correlations and non-parametric statistic between noise-copula (\textbf{Clayton}) and population copula for different \textbf{Kendall's Tau}]{Results of comparison between 3 types of correlation (i.e. Spearman, Kendall, Pearson) and 6 non-parametric stats ($\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_u$ and $\Dsq_l$) of environmental noise generated from \textbf{Clayton} copula and of the affected populations for 9 equidistant \textbf{Kendall's Tau} values in a range (0.1 to 0.9) (Initially $5000$ points are generated but we kept last $500$ points for both noise and population data for comparison) \label{fig_Cause4copula_C_kend}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Cause4copula_results/SClayton_spearman.pdf}
\caption[Comparing correlations and non-parametric statistic between noise-copula (\textbf{Survival Clayton}) and population copula for different \textbf{Spearman's Rho}]{Results of comparison between 3 types of correlation (i.e. Spearman, Kendall, Pearson) and 6 non-parametric stats ($\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_u$ and $\Dsq_l$) of environmental noise generated from \textbf{Survival Clayton} copula and of the affected populations for 9 equidistant \textbf{Spearman's Rho} values in a range (0.1 to 0.9) (Initially $5000$ points are generated but we kept last $500$ points for both noise and population data for comparison) \label{fig_Cause4copula_SC_spear}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Cause4copula_results/SClayton_kendall.pdf}
\caption[Comparing correlations and non-parametric statistic between noise-copula (\textbf{Survival Clayton}) and population copula for different \textbf{Kendall's Tau}]{Results of comparison between 3 types of correlation (i.e. Spearman, Kendall, Pearson) and 6 non-parametric stats ($\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_u$ and $\Dsq_l$) of environmental noise generated from \textbf{Survival Clayton} copula and of the affected populations for 9 equidistant \textbf{Kendall's Tau} values in a range (0.1 to 0.9) (Initially $5000$ points are generated but we kept last $500$ points for both noise and population data for comparison) \label{fig_Cause4copula_SC_kend}}
\end{center}
\end{figure}

# Cause of non-Normal copula structure : the Moran effect and copula structure in populations \label{Cause_Moran}

To begin with, we chose a two habitat patch ($i = 1, 2$) with AR(1) model [Eq. \ref{eq.AR1}] where population $P_{i}$ at time $(t+1)$ depends upon its past value at $(t)$ and the iid noise (assumed to be caused by environmental fluctuations) $\epsilon_{i} (t)$.  

\begin{equation}\label{eq.AR1}
P_{i}(t+1)=\beta P_{i}(t)+\alpha \epsilon_{i}(t)
\end{equation}

To keep $Var(P_{i}(t+1))$ equal to unity, we set noise coefficient $\alpha$ in terms of AR coefficient $\beta$ as $\alpha = \sqrt(1-\beta^2)$. We were interested to explore the basic idea of Moran's theorem that if noise $\epsilon_{1}(t)$ and $\epsilon_{2}(t)$ at two different habitat patches had some specific assymetric tail dependence and then what will be the outcome dependence in the populations at those habitat patches. Should their dependence be exactly the same as of the noises or not ? 

To test that our approach is of two way : first, we calculated the parameters of the noise-copula (for example, we chose Clayton with lower tail dependence and Survival Clayton with upper tail dependence here) using `iRho` or `iTau` function from `copula` package for Spearman's Rho or Kendall's Tau, respectively. Then we simulated our model (\ref{eq.AR1}) and estimated parameters of the outcome which was a bivariate population-copula, with last $500$ simulated points for each habitat patch (see Fig. \ref{fig_Cause4copula_params_GOF_500}). We also tested the goodness of fit of the estimated parameters for population-copula and its standard error due to sample size and reported p-values for both statistics (Cramer-von Mises and Kolmogorov-Smirnov). p-values greater or equal to $0.05$ (above the dashed line in Fig. \ref{fig_Cause4copula_params_GOF_500}) were considered as a good fit of estimated parameters. Fig. \ref{fig_Cause4copula_params_GOF_2500} represents similar feature as of Fig. \ref{fig_Cause4copula_params_GOF_500} but here we considered last $2500$ simulated population data points for our parameters-estimation, thus making our comparison more sensitive on basis of p-value threshold at $0.05$. (For code see [`Plotter_Cause4copula_GOF`](https://github.com/sghosh89/BIVAN/blob/master/Cause4copula.R) function). 

Secondly, we measured 3 types of correlations (Spearman, Kendall, Pearson) and different types of non-parametric statistics (see \ref{NPA}) for both bivariate noise copula and resultant population copula for $50$ simulations. Then we plotted mean of each measured quantity with standard error against Spearman's Rho (or Kendall's Tau) of the noise copula family. Fig. \ref{fig_Cause4copula_C_spear} and Fig. \ref{fig_Cause4copula_C_kend} represent this picture for noise generating from a lower tail dependent Clayton copula whereas for Fig. \ref{fig_Cause4copula_SC_spear} and Fig. \ref{fig_Cause4copula_SC_kend} noise came from a upper tail dependent Survival Clayton family. We also carried out a paired t-test to compute the p-values of each statistic for noise and population data and found that like our first approach, here also the nature of tail dependence in noise and populations remained similar but they were not exactly the same except in Pearson correlation coefficient which ensured the Moran effect on the population data caused by environmental noise. (For code see [`Plotter_Cause4copula_stat`](https://github.com/sghosh89/BIVAN/blob/master/Cause4copula.R) function). 

<!--
## Asymmetric sensitivity and copula structure in populations
           ----moved to Paper.Rmd----
-->

```{r asym_sens_b_variation, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"),mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
set.seed(seed)
#-----------------------------------------------------------------------------------
source("OurBiCopSelect.R")
source("bivfunctionplot.R")
source("asym_sensitivity.R")
#-----------------------------------------------------------------------------------
# This function takes 
# Input :
#       mg : global noise matrix (dim = N by 2)
#       ml : local noise matrix (dim = N by 2)
#       a : a number : local noise coeeficient
#       b : growth factor of pop
#       decrease : logical (controls the nature of global noise)
#       numkeep_last : number of points you want to keep for the pop matrix from the end
#       ploton : logical for optional plot

# Output :
#     a list of 4 pop matrices 
#                         1. (for b=+ve, decrease=F)
#                         2. (for b=+ve, decrease=T)
#                         3. (for b=-ve, decrease=F)
#                         4. (for b=-ve, decrease=T)

plotter_asym_sens_b_varn<-function(mg,ml,a,b,numkeep_last,ploton){
  
  pop<-Simulator_asym_sens(mg=mg,ml=ml,a=a,b=b,p0=c(0,0),decrease=F,numkeep_last=numkeep_last)
  pop_d<-Simulator_asym_sens(mg=mg,ml=ml,a=a,b=b,p0=c(0,0),decrease=T,numkeep_last=numkeep_last)
  
  neg_b<- -b
  pop_neg_b<-Simulator_asym_sens(mg=mg,ml=ml,a=a,b=neg_b,p0=c(0,0),decrease=F,numkeep_last=numkeep_last)
  pop_d_neg_b<-Simulator_asym_sens(mg=mg,ml=ml,a=a,b=neg_b,p0=c(0,0),decrease=T,numkeep_last=numkeep_last)
  
  if(ploton==T){
    op<-par(mfrow=c(2,2),mar=c(4,3,1.5,1),mgp=c(2,1,0))
    
    #plot(pop[,1],pop[,2],col="red",main = bquote(beta ==.(beta)))
    plot(pop[,1],pop[,2],col="red",xlab=expression(paste(P[1])), ylab=expression(paste(P[2])))
    title(expression(paste("(A) g = ",g[1]," , ")), adj=0.4)
    mtext(paste("b = ",b),side = 3, line=0.2, adj=0.72, col="black")
    plot(pop_d[,1],pop_d[,2],col="blue",xlab=expression(paste(P[1])), ylab=expression(paste(P[2])))
    title(expression(paste("(B) g = ",g[2]," , ")), adj=0.4)
    mtext(paste("b = ",b),side = 3, line=0.2, adj=0.72, col="black")
    plot(pop_neg_b[,1],pop_neg_b[,2],col="orange",xlab=expression(paste(P[1])), ylab=expression(paste(P[2])))
    title(expression(paste("(C) g = ",g[1]," , ")), adj=0.4)
    mtext(paste("b = ",neg_b),side = 3, line=0.2, adj=0.75, col="black")
    plot(pop_d_neg_b[,1],pop_d_neg_b[,2],col="skyblue",xlab=expression(paste(P[1])), ylab=expression(paste(P[2])))
    title(expression(paste("(D) g = ",g[2]," , ")), adj=0.4)
    mtext(paste("b = ",neg_b),side = 3, line=0.2, adj=0.75, col="black")
    
    par(op)
  }
  
  return(list(pop=pop,
              pop_d=pop_d,
              pop_neg_b=pop_neg_b,
              pop_d_neg_b=pop_d_neg_b))
  
}
#----------------------------------------------------------
N<-10000
r<-0.8
a<-0.2
numkeep_last<-1000
temp<-get_noise_glob_loc_mat(N=N,r=r)
mg<-temp$mg
ml<-temp$ml

pdf("./Results/asym_sens_results/a_0.2_b_0.1_r_0.8_asym_sens.pdf")
ans_b_0.1<-plotter_asym_sens_b_varn(mg=mg,ml=ml,a=a,b=0.1,numkeep_last=numkeep_last,ploton=T)
dev.off()

pdf("./Results/asym_sens_results/a_0.2_b_0.9_r_0.8_asym_sens.pdf")
ans_b_0.9<-plotter_asym_sens_b_varn(mg=mg,ml=ml,a=a,b=0.9,numkeep_last=numkeep_last,ploton=T)
dev.off()

vlist_b_0.1_b_0.9<-c(ans_b_0.1,ans_b_0.9) # a list of 8 matrices

summary_stat<-as.data.frame(matrix(NA,7,8),stringsAsFactors = F) # Table for model selection summary
rownames(summary_stat)<-c("bestcop_AICw","N_AICw","relLTdep_AICw","relUTdep_AICw","p_CvM","p_KS","BS_success%")
#bg <- intToUtf8(0x03B2) 
cnm<-c("b_0.1_g~1~","b_0.1_g~2~","b_-0.1_g~1~","b_-0.1_g~2~","b_0.9_g~1~","b_0.9_g~2~","b_-0.9_g~1~","b_-0.9_g~2~")
#cname<-paste0(bg,cnm)
colnames(summary_stat)<-cnm

ms_asym_b_0.1_b_0.9<-vector(mode = "list", length = 8) # initializing list to store model selection results for all possible b variation
names(ms_asym_b_0.1_b_0.9)<-cnm

stat_npa_asym_b_0.1_b_0.9<-vector(mode = "list", length = 8) # initializing list to store NPA results for all possible b variation
names(stat_npa_asym_b_0.1_b_0.9)<-cnm

for(ic in c(1:8)){
  v<-vlist_b_0.1_b_0.9[[ic]]
  res<-OurBiCopSelect(u1=v[,1],u2=v[,2],families=c(1,3:10,13:14,16:20),level=0.05,
                      AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,
                      gofnormal=F,status=F)
  
  ms_asym_b_0.1_b_0.9[[ic]]<-res
  
  summary_stat[1,ic]<-max(res$InfCritRes$AICw)
  summary_stat[2,ic]<-res$InfCritRes$AICw[1]
  summary_stat[3,ic]<-res$relLTdep_AICw
  summary_stat[4,ic]<-res$relUTdep_AICw
  summary_stat[5,ic]<-res$GofRes_CvM
  summary_stat[6,ic]<-res$GofRes_KS
  summary_stat[7,ic]<-(res$Numboot_success/res$Numboot)*100
  
  stat_npa_asym_b_0.1_b_0.9[[ic]]<-bivfunctionplot(v=v,resloc="./Results/asym_sens_results/",nametag=cnm[ic],numbin=10)
  
}

saveRDS(summary_stat,"./Results/asym_sens_results/b_variation_summary_stat.RDS")
saveRDS(ms_asym_b_0.1_b_0.9,"./Results/asym_sens_results/ms_asym_b_0.1_b_0.9.RDS")
saveRDS(stat_npa_asym_b_0.1_b_0.9,"./Results/asym_sens_results/stat_npa_asym_b_0.1_b_0.9.RDS")
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/asym_sens_results/a_0.2_b_0.1_r_0.8_asym_sens.pdf}
\caption[asym sensitivity results : copula plot]{asym sensitivity results : copula plot \label{fig_ms_asym_b_0.1}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/asym_sens_results/a_0.2_b_0.9_r_0.8_asym_sens.pdf}
\caption[asym sensitivity results : copula plot]{asym sensitivity results : copula plot \label{fig_ms_asym_b_0.9}}
\end{center}
\end{figure}

```{r tab_summary_stat_asym_sens,echo=F,results="markup"}
knitr::kable(summary_stat, booktabs = T, 
             format = "pandoc",
             digits=3,
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption="summary of model selection results for asym. sensitivity \\label{tab_summary_stat_asym_sens}")
```

```{r read_tab_stat_npa_asym,echo=F,results="asis"}
#knitr::opts_knit$set(kable.force.latex = TRUE)
tab_asym<-readRDS("./Results/asym_sens_results/stat_npa_asym_b_0.1_b_0.9.RDS")

#for(i in c(1:8)){
#  temp<-make_table_stat_fn(data=tab_asym[[i]])
#  temp2<-knitr::kable(temp, booktabs = T, 
#             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
#      caption =paste(cnm[i]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence."))
#  print(temp2)
#  cat("\\newpage")
#}
```

```{r tab_stat_npa_asym_1,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[1]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[1]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_1}"))
```


```{r tab_stat_npa_asym_2,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[2]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[2]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_2}"))
```


```{r tab_stat_npa_asym_3,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[3]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[3]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_3}"))
```


```{r tab_stat_npa_asym_4,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[4]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[4]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_4}"))
```

```{r tab_stat_npa_asym_5,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[5]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[5]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_5}"))
```

```{r tab_stat_npa_asym_6,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[6]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[6]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_6}"))
```

```{r tab_stat_npa_asym_7,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[7]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[7]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_7}"))
```

```{r tab_stat_npa_asym_8,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[8]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[8]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_8}"))
```

# Cause of non-Normal copula structure : Asymmetric sensitivity and copula structure in populations \label{Cause_asym_sens}

To test the assymetric sensitivity, we constructed a two habitat patch model for population $P_{i} (i=1,2)$ as follows;

\begin{equation}\label{eq.AS}
P_{i}(t+1) = b P_{i}(t) + g(\epsilon_{i}(t)) + h(\delta_{i}(t))
\end{equation}

$b$ was the linear growth rate. Global environmental fluctuation function $g(\epsilon)$ can take up any one form between $g_{1}$ and $g_{2}$ (Eq. \ref{eq.AS_g}) where $\epsilon=(\epsilon_{1}, \epsilon_{2})$ was an iid through time with mean zero and covariance matrix $\Sigma_{\epsilon}$.

\begin{align}
g(\epsilon) = \begin{cases} 
g_{1} = \begin{cases}
\epsilon & \text{if $\epsilon< 0$}; \\
0 & \text{otherwise}.
\end{cases}\\ \\
g_{2} = \begin{cases}
\epsilon & \text{if $\epsilon> 0$}; \\
0 & \text{otherwise}\label{eq.AS_g}.
\end{cases}
\end{cases} \text{where } \epsilon = N(\textbf{0},\Sigma_{\epsilon})\;\ \text{with} \;\ \Sigma_{\epsilon} = \begin{bmatrix} 1 & r \\ r & 1 \end{bmatrix}
\end{align}

Local environmental fluctuation function $h(\delta)$ varied according to Eq. \ref{eq.AS_h} where $a$ was the scaling parameter between $0$ to $1$. $\delta=(\delta_{1}, \delta_{2})$ was an iid across $i=(1,2)$ and time with mean zero and covariance matrix $\Sigma_{\delta}$.

\begin{equation}\label{eq.AS_h}
h(\delta) = a \delta = aN(\textbf{0},\Sigma_{\delta})\;\ \text{with} \;\ \Sigma_{\delta} = \begin{bmatrix} 1 & 0 \\ 0 & 1 \end{bmatrix}
\end{equation}

We simulated our model (\ref{eq.AS}) for different values of $b$ with $a=0.2$, $r=0.8$. $10000$ points were generated from each local and global fluctuations to apply on the initial populations and then after simulation we kept only last $1000$ time step of simulated points to plot the population-copula for a specific $b$ and a specific functional form of $g$  (For code see [`Simulator_asym_sens`](https://github.com/sghosh89/BIVAN/blob/master/asym_sensitivity.R) function). Fig. \ref{fig_ms_asym_b_0.1} and Fig. \ref{fig_ms_asym_b_0.9} show these results for $b=\pm0.1$ and $b=\pm0.9$, respectively. We also carried out model selection and non-parametric statistical analysis with each copula of those figures and summarized our results in Tables \ref{tab_summary_stat_asym_sens} - \ref{tab_stat_npa_asym_8}. Table \ref{tab_summary_stat_asym_sens} represent the model selection results with AIC weights for best fitted copula and normal copula, model averaged lower and upper tail dependence, p-values (both Cramer-von Mises statistic and Kolmogorov-Smirnov statistic) for goodness of fit test. In each case, successful bootstrap was $100\%$. According to our model selection approach, for $b=\pm0.1$, non-normal copula (with higher AIC weights) were always best-fit with some asymetric tail dependence whereas for $b\pm0.9$, most of the time normal was best. It is probably because the populations get long-time exposure to environmental changes for slower growth(or decay) rate and so global fluctuation can affect them more efficiently. Our non-parametric analysis results (Tables \ref{tab_stat_npa_asym_1} -\ref{tab_stat_npa_asym_8}) are consistent with this model selection approach. 


#  Need to think about mechanisms for biogeochemical, evolutionary, and community data

\newpage

<!--
# Question 3 analyses for each dataset and theoretical analyses
Recall that question 3 is: What are the consequences of non-Normal copula structure and tail dependence for our understanding of biology and for applications?
## Skewness of the spatial mean
### Aphid count \label{skewness_count}
### Aphid first flight \label{skewness_ff}
### UK Sea plankton \label{skewness_pns}
### Methane-flux data \label{skewness_methane}
                   ----moved to Paper.Rmd----
-->

```{r skewness_count_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

pdf("./Results/skewness_results/skewness_aphid_count/skewness_aphid_count_sp_10.pdf")
par(mfrow=c(2,1))
numsurrog<-10000
loclist<-good_loclist(d_allsp=data_aphid_count,sp=10,data_pt_thrs=30)
answer1k<-skewness_testing(ts_matrix=sp_data(sp=10,d_allsp=data_aphid_count),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="kendall") 

p_left<-sum(answer1k$surrogskw < answer1k$realskw)/numsurrog

mtext(paste0("(A) result based on kendall preserving normal surrogates, p = ",p_left),side=3,line=0.2,col="navyblue")

answer1s<-skewness_testing(ts_matrix=sp_data(sp=10,d_allsp=data_aphid_count),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="spearman") 

p_left<-sum(answer1s$surrogskw < answer1s$realskw)/numsurrog

mtext(paste0("(B) result based on spearman preserving normal surrogates , p = ",p_left),side=3,line=0.2,col="navyblue")


dev.off()
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=8 cm]{./Results/skewness_results/skewness_aphid_count/skewness_aphid_count_sp_10.pdf}
\caption[Skewness count for species Green spruce aphid]{Skewness count for species Green spruce aphid\label{fig_skewness_count}}
\end{center}
\end{figure}


```{r skewness_ff_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_aphid_ff,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

pdf("./Results/skewness_results/skewness_aphid_ff/skewness_aphid_ff_sp_11.pdf")
par(mfrow=c(2,1))
numsurrog<-10000
loclist<-good_loclist(d_allsp=data_aphid_ff,sp=11,data_pt_thrs=30)

answer2k<-skewness_testing(ts_matrix=sp_data(sp=11,d_allsp=data_aphid_ff),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="kendall") 
p_right<-sum(answer2k$surrogskw > answer2k$realskw)/numsurrog
mtext(paste0("(A) result based on kendall preserving normal surrogates, p = ",p_right),side=3,line=0.2,col="navyblue")

answer2s<-skewness_testing(ts_matrix=sp_data(sp=11,d_allsp=data_aphid_ff),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="spearman") 
p_right<-sum(answer2s$surrogskw > answer2s$realskw)/numsurrog
mtext(paste0("(B) result based on spearman preserving normal surrogates , p = ",p_right),side=3,line=0.2,col="navyblue")

dev.off()
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=8 cm]{./Results/skewness_results/skewness_aphid_ff/skewness_aphid_ff_sp_11.pdf}
\caption[Skewness firstflight for species Leaf-curling plum aphid]{Skewness firstflight for species Leaf-curling plum aphid\label{fig_skewness_ff}}
\end{center}
\end{figure}

```{r skewness_pns_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_plankton_north_sea,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

pdf("./Results/skewness_results/skewness_plankton_north_sea/skewness_plankton_north_sea_sp_16.pdf")
par(mfrow=c(2,1))
numsurrog<-10000
loclist<-good_loclist(d_allsp=data_plankton_north_sea,sp=16,data_pt_thrs=45)
answer3k<-skewness_testing(ts_matrix=sp_data(sp=16,d_allsp=data_plankton_north_sea),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="kendall") 

p_left<-sum(answer3k$surrogskw < answer3k$realskw)/numsurrog

mtext(paste0("(A) result based on kendall preserving normal surrogates, p = ",p_left),side=3,line=0.2,col="navyblue")

answer3s<-skewness_testing(ts_matrix=sp_data(sp=16,d_allsp=data_plankton_north_sea),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="spearman") 

p_left<-sum(answer3s$surrogskw < answer3s$realskw)/numsurrog

mtext(paste0("(B) result based on spearman preserving normal surrogates , p = ",p_left),side=3,line=0.2,col="navyblue")

dev.off()
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=8 cm]{./Results/skewness_results/skewness_plankton_north_sea/skewness_plankton_north_sea_sp_16.pdf}
\caption[Skewness-plankton for species Ceratium furca]{Skewness-plankton for species Ceratium furca\label{fig_skewness_pns}}
\end{center}
\end{figure}

```{r skewness_methane_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_plankton_north_sea,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

pdf("./Results/skewness_results/skewness_methane/skewness_methane.pdf")
par(mfrow=c(2,1))
numsurrog<-10000
loclist<-good_loclist(d_allsp=methane_data,sp=1,data_pt_thrs=50)

answer1k<-skewness_testing(ts_matrix=sp_data(sp=1,d_allsp=methane_data),loclist=loclist,numsurrog=numsurrog,ploton=T,
                           corpres="kendall") 
p_left<-sum(answer1k$surrogskw < answer1k$realskw)/numsurrog
mtext(paste0("(A) result based on kendall preserving normal surrogates, p = ",p_left),side=3,line=0.2,col="navyblue")

answer1s<-skewness_testing(ts_matrix=sp_data(sp=1,d_allsp=methane_data),loclist=loclist,numsurrog=numsurrog,ploton=T,
                           corpres="spearman") 
p_left<-sum(answer1s$surrogskw < answer1s$realskw)/numsurrog
mtext(paste0("(B) result based on spearman preserving normal surrogates , p = ",p_left),side=3,line=0.2,col="navyblue")

dev.off()
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=8 cm]{./Results/skewness_results/skewness_methane/skewness_methane.pdf}
\caption[Skewness-methane-flux data]{Skewness-methane-flux data\label{fig_skewness_methane}}
\end{center}
\end{figure}

<!-- Taylor's law section moved to Paper.Rmd -->

<!--make surrogate datasets for TL analysis to follow-->
```{r taylors_law_make_surrogs, echo=F, cache=T, cache.extra=list(seed,mtime("copsurrognd.R"))}
source("copsurrognd.R")
set.seed(seed)

#***constants
N<-50 #length of time series
n<-25 #number of sampling locations
numdat<-10 #the number of datasets to get from the normal copula
rho<-0.7 #normal-copula parameter for dependence between locations
          #this is a covariance, see below call to rmvnorm

#***generate the starting data, which has normal copula structure
#because it comes originally from a multivariate normal, before 
#transformation
sig<-matrix(rho,n,n)
diag(sig)<-1
m<-rmvnorm(N*numdat,mean=rep(0,n),sigma=sig) # each column of m has normal histogram
m<-array(m,c(N,numdat,n))
m<-aperm(m,c(1,3,2)) # 2nd dim is normally distributed e.g. hist(m[,1,])
gshape<-7.5
gscale<-1 #gamma parameters

cop_to_marg_trans<-function(x){
  return(qgamma(x,shape=gshape,scale=gscale)) #this is where we choose the marginals,
                                  #should be something skewed
}

marg_to_cop_trans<-function(x){ #transforms to copula space
  return(pgamma(x,shape=gshape,scale=gscale))
}

# pnorm(m) makes normal to uniform
# then qgamma(...) makes uniform to gamma distributed
m<-cop_to_marg_trans(pnorm(m))

#***surrogates using a Clayton copula, kendall preserving

#get the Clayton parameter to use
ncop<-normalCopula(rho,2)
ccop<-claytonCopula(2,2)
cparam<-iTau(ccop,tau(ncop))
ccop<-claytonCopula(cparam,n)

#generate the surrogates
csurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3]){
  csurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=ccop,numsurrog=1)
}

# #test to see whether kendalls are similar between m and csurrog - 
#only works at all as a test if N is large (I used 1000)
# cor(m[,1,1],m[,2,1],method='kendall')
# cor(csurrog[,1,1],csurrog[,2,1],method='kendall')
# cor(m[,3,1],m[,4,1],method='kendall')
# cor(csurrog[,3,1],csurrog[,4,1],method='kendall')
# cor(m[,5,1],m[,6,1],method='kendall')
# cor(csurrog[,5,1],csurrog[,6,1],method='kendall')
# 
# cor(m[,1,2],m[,2,2],method='kendall')
# cor(csurrog[,1,2],csurrog[,2,2],method='kendall')
# cor(m[,3,2],m[,4,2],method='kendall')
# cor(csurrog[,3,2],csurrog[,4,2],method='kendall')
# cor(m[,5,2],m[,6,2],method='kendall')
# cor(csurrog[,5,2],csurrog[,6,2],method='kendall')

#***surrogates using a Frank copula, kendall preserving
#get the Frank parameter to use
fcop<-frankCopula(4,2)
fparam<-iTau(fcop,tau(ncop))
fcop<-frankCopula(fparam,n)

#generate the surrogates
fsurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3]){
  fsurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=fcop,numsurrog=1)
}

#***surrogates using a survival Clayton, kendall preserving
#take the clayton surrogates and transform them to the 
#copula space, then flip, then transform back
scsurrog<-cop_to_marg_trans((1-marg_to_cop_trans(csurrog)))

# check : plot(csurrog[,1,1],csurrog[,2,1]) and plot(scsurrog[,1,1],scsurrog[,2,1])

# #test: should have identical taus as csurrog
# cor(csurrog[,1,1],csurrog[,2,1],meth='kendall')
# cor(scsurrog[,1,1],scsurrog[,2,1],meth='kendall')
# cor(csurrog[,1,2],csurrog[,2,2],meth='kendall')
# cor(scsurrog[,1,2],scsurrog[,2,2],meth='kendall')

kend.surrog<-list(cla=csurrog,nor=m,fra=fsurrog,scl=scsurrog)

#***surrogates using a Clayton copula, spearman preserving
#get the Clayton parameter to use
ccop<-claytonCopula(2,2)
cparam<-iRho(ccop,rho(ncop))
ccop<-claytonCopula(cparam,n)

#generate the surrogates
csurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3]){
  csurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=ccop,numsurrog=1)
}

#***surrogates using a Frank copula, spearman preserving
#get the Frank parameter to use
fcop<-frankCopula(4,2)
fparam<-iRho(fcop,rho(ncop))
fcop<-frankCopula(fparam,n)

#generate the surrogates
fsurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3]){
  fsurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=fcop,numsurrog=1)
}

#***surrogates using a survival Clayton, spearman preserving
#take the clayton surrogates and transform them to the 
#copula space, then flip, then transform back
scsurrog<-cop_to_marg_trans((1-marg_to_cop_trans(csurrog)))

spea.surrog<-list(cla=csurrog,nor=m,fra=fsurrog,scl=scsurrog)
```

<!--do a TL analysis on the data just created-->
```{r tl_analysis, echo=F, cache=T, cache.extra=list(kend.surrog,spea.surrog,mtime("TaylorsLawTools.R"),seed,mtime("copsurrognd.R"))}
source("copsurrognd.R")
source("TaylorsLawTools.R")
 
#We are only doing spatial taylor's law because we know a priori temporal
#won't give anything interesting for the surrogates we use

kend.stats.res<-list()
kend.points.res<-list()
spea.stats.res<-list()
spea.points.res<-list()
for (counter in 1:length(kend.surrog)){
 ks<-kend.surrog[[counter]]
 ss<-spea.surrog[[counter]]
 kend.stats.res[[counter]]<-matrix(NA,5,numdat) # to keep spatial TL stats
 spea.stats.res[[counter]]<-matrix(NA,5,numdat)
 kend.points.res[[counter]]<-array(NA,c(N,2,numdat)) # to keep log(mu), log(var) of spatial TL as a dataframe
 spea.points.res[[counter]]<-array(NA,c(N,2,numdat))
 for (sc in 1:numdat){
   khold<-tl_stats(ks[,,sc])
   kend.stats.res[[counter]][,sc]<-khold$s.stats #spatial TL only
   rownames(kend.stats.res[[counter]])<-names(khold$s.stats)
   kend.points.res[[counter]][,,sc]<-as.matrix(khold$s.points)
 
   shold<-tl_stats(ss[,,sc])
   spea.stats.res[[counter]][,sc]<-shold$s.stats #spatial TL only
   rownames(spea.stats.res[[counter]])<-names(shold$s.stats)
   spea.points.res[[counter]][,,sc]<-as.matrix(shold$s.points)
 }
}
names(kend.stats.res)<-names(kend.surrog)
names(kend.points.res)<-names(kend.surrog)
names(spea.stats.res)<-names(spea.surrog)
names(spea.points.res)<-names(spea.surrog)
```

<!--Now make some plots, these one for kendall surrogates-->
```{r taylor_plots, echo=F, results="hide"}
xlimits<-range(kend.points.res[[1]][,1,],kend.points.res[[2]][,1,],kend.points.res[[3]][,1,],kend.points.res[[4]][,1,])
ylimits<-range(kend.points.res[[1]][,2,],kend.points.res[[2]][,2,],kend.points.res[[3]][,2,],kend.points.res[[4]][,2,])

pdf("./Results/taylorslaw_results/SpatialTL_CNFSC.pdf",height=4,width=16)
op<-op<-par(mfrow=c(1,4),mar=c(4,5,1,1),mgp=c(3,1,0))
##plot TL for clayton
plot(kend.points.res[[1]][,1,],kend.points.res[[1]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(kend.points.res[[1]][,1,1],kend.points.res[[1]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[1]][,1,2],kend.points.res[[1]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Clayton"),side = 3, line=-2, adj=0.1, col="black")

##plot TL for normal copula
plot(kend.points.res[[2]][,1,],kend.points.res[[2]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(kend.points.res[[2]][,1,1],kend.points.res[[2]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[2]][,1,2],kend.points.res[[2]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Normal"),side = 3, line=-2, adj=0.1, col="black")

#plot TL for frank
plot(kend.points.res[[3]][,1,],kend.points.res[[3]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(kend.points.res[[3]][,1,1],kend.points.res[[3]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[3]][,1,2],kend.points.res[[3]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Frank"),side = 3, line=-2, adj=0.1, col="black")

#plot TL for survival clayton
plot(kend.points.res[[4]][,1,],kend.points.res[[4]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(kend.points.res[[4]][,1,1],kend.points.res[[4]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[4]][,1,2],kend.points.res[[4]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Survival Clayton"),side=3, line=-2, adj=0.1, col="black")

par(op)
dev.off()
#---------------------------------------------------
#prepare for plots coming below
s.lin<-cbind(kend.stats.res[[1]][1,],kend.stats.res[[2]][1,],kend.stats.res[[3]][1,],kend.stats.res[[4]][1,])
s.hom<-cbind(kend.stats.res[[1]][2,],kend.stats.res[[2]][2,],kend.stats.res[[3]][2,],kend.stats.res[[4]][2,])
s.rmse<-cbind(kend.stats.res[[1]][3,],kend.stats.res[[2]][3,],kend.stats.res[[3]][3,],kend.stats.res[[4]][3,])
s.int<-cbind(kend.stats.res[[1]][4,],kend.stats.res[[2]][4,],kend.stats.res[[3]][4,],kend.stats.res[[4]][4,])
s.slope<-cbind(kend.stats.res[[1]][5,],kend.stats.res[[2]][5,],kend.stats.res[[3]][5,],kend.stats.res[[4]][5,])

pdf("./Results/taylorslaw_results/SpatialTL_5stats.pdf",height=3,width=15)
op<-par(mfrow=c(1,5),mar=c(4.2,5,1,1),mgp=c(3,1,0))
#***DAN: x axis needs to be redone to show the copula names used in the surrogates

x<-1:4
x2<-c("C", "N", "F", "SC")
plot(x,s.lin[1,],type="l",col="grey",ylim=range(s.lin),xlab="Set of surrogates",ylab="Linearity test p-vals",
     cex.axis=1.5,cex.lab=1.5,xaxt="n")
points(x,s.lin[1,],col="red")
axis(1, at = c(1:4), x2, cex.axis=1.5)
for (counter in 2:dim(s.lin)[1]){
  lines(x,s.lin[counter,],col="grey")
  points(x,s.lin[counter,],col="red")
}

#plot s.hom distr for each set of surrogates
#***DAN: x axis needs to be redone to show the copula names used in the surrogates
x<-1:4
plot(x,s.hom[1,],type="l",col="grey",ylim=range(s.hom),xlab="Set of surrogates",
     ylab="Homoskedasticity test p-vals",
     cex.axis=1.5,cex.lab=1.5,xaxt="n")
points(x,s.hom[1,],col="red")
axis(1, at = c(1:4), x2, cex.axis=1.5)
for (counter in 2:dim(s.slope)[1]){
  lines(x,s.hom[counter,],col="grey")
  points(x,s.hom[counter,],col="red")
}

#plot s.rmse distr for each set of surrogates
x<-1:4
plot(x,s.rmse[1,],type="l",col="grey",ylim=range(s.rmse),xlab="Set of surrogates",ylab="Spatial TL rmse",
     cex.axis=1.5,cex.lab=1.5,xaxt="n")
points(x,s.rmse[1,],col="red")
axis(1, at = c(1:4), x2, cex.axis=1.5)
for (counter in 2:dim(s.rmse)[1]){
  lines(x,s.rmse[counter,],col="grey")
  points(x,s.rmse[counter,],col="red")
}

#plot s.int distr for each set of surrogates
#***DAN: x axis needs to be redone to show the copula names used in the surrogates
x<-1:4
plot(x,s.int[1,],type="l",col="grey",ylim=range(s.int),xlab="Set of surrogates",
     ylab="Spatial TL intercept",
     cex.axis=1.5,cex.lab=1.5,xaxt="n")
points(x,s.int[counter,],col="red")
axis(1, at = c(1:4), x2, cex.axis=1.5)
for (counter in 2:dim(s.int)[1]){
  lines(x,s.int[counter,],col="grey")
  points(x,s.int[counter,],col="red")
}

#plot s.slope distr for each set of surrogates
#***DAN: x axis needs to be redone to show the copula names used in the surrogates
x<-1:4
plot(x,s.slope[1,],type="l",col="grey",ylim=range(s.slope),xlab="Set of surrogates",
     ylab="Spatial TL slope",
     cex.axis=1.5,cex.lab=1.5,xaxt="n")
points(x,s.slope[counter,],col="red")
axis(1, at = c(1:4), x2, cex.axis=1.5)
for (counter in 2:dim(s.slope)[1]){
  lines(x,s.slope[counter,],col="grey")
  points(x,s.slope[counter,],col="red")
}
par(op)
dev.off()
```

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.1 cm} (D)} \\
\vspace{-0.5 cm} 
\begin{center}
\includegraphics[width=16 cm]{./Results/taylorslaw_results/SpatialTL_CNFSC.pdf}\\
\end{center}
\textbf{ \hspace{3.1 cm} (E) \hspace{2.4 cm} (F) \hspace{2.3 cm} (G) \hspace{2.3 cm} (H) \hspace{2.3 cm} (I)}\\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=16 cm]{./Results/taylorslaw_results/SpatialTL_5stats.pdf}
\caption[Spatial Taylor's Law results]{Spatial Taylor's Law results: log(spatial variance) vs. log(spatial mean) for $ns=10$ number of (A) Clayton, (B) Normal, (C) Frank, (D) Survival Clayton surrogates; (E) p-value for test of linearity, (F) p-value for test of hhomoskedasticity, (G) root mean square error, (H) intercept, (I) slope of the first panel plots. \label{fig_spTL}}
\end{center}
\end{figure}

<!--
## Extinction risk
        ----moved to Paper.Rmd----
-->

```{r fig_ext_risk, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}

source("mydispersal.R")
set.seed(seed)

rlist<-c(0,0.05,0.25,0.5,0.7,0.75,0.9,1.0,1.25,1.5,1.75,1.95)

# plot for local dispersal in D matrix ; r=0 for LC model, r!=0 for Ricker model
pdf("./Results/ext_risk_local_disp.pdf",heigh=6,width=10)
op<-par(mfrow=c(3,4),mar=c(5,4,1,1) + 0.2)
for(r in rlist){
    #cat("r=",r,"\n")
    s<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=r,K=50,disp_everywhere=F,ploton=F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend(x=-0.06,y=1.1, c("noise : left","noise : right"), fill=c('red', 'blue'), horiz=T, bty='n')
    mtext(paste0("r = ", r))
}
par(op)
dev.off()


# plot for global dispersal in D matrix ; r=0 for LC model, r!=0 for Ricker model
pdf("./Results/ext_risk_global_disp.pdf",heigh=6,width=10)
op<-par(mfrow=c(3,4),mar=c(5,4,1,1) + 0.2)
for(r in rlist){
  #cat("r=",r,"\n")
  s<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=r,K=50,disp_everywhere=T,ploton=F)
  plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d_seq,s$risk_right,type="b",col="blue")
  legend(x=-0.06,y=1.1, c("noise : left","noise : right"), fill=c('red', 'blue'), horiz=T, bty='n')
  mtext(paste0("r = ", r))
}
par(op)
dev.off()

# plot to show the effect of increasing numlocs for r=0 (LC model), r=0.25 (Ricker model)
pdf("./Results/ext_risk_numlocs_effect_local_disp.pdf",heigh=6,width=6)
op<-par(mfrow=c(2,2),mar=c(4,4,1,1) + 0.1)
for(r in c(0,0.25)){
  #cat("r=",r,"\n")
  s5<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=r,K=50,disp_everywhere=F,ploton=F)
  s25<-varying_d(numsims=10000,numsteps =25,numlocs=25,r=r,K=50,disp_everywhere=F,ploton=F)
  
  plot(s5$d_seq,s5$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
  lines(s25$d_seq,s25$risk_left,type="b",col="orange")
  legend("topleft", title=paste0("r=",r," , left tail dep. in noise"), c("numlocs=5","numlocs=25"), fill=c('red', 'orange'),  horiz=F, bty='n')
 
  
  plot(s5$d_seq,s5$risk_right,xlim=c(0,1),ylim=c(0,1),type="b",col="blue",
       panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
  lines(s25$d_seq,s25$risk_right,type="b",col="skyblue")
  legend("topleft",title=paste0("r=",r," , right tail dep. in noise"), c("numlocs=5","numlocs=25"), fill=c('blue', 'skyblue'),  horiz=F, bty='n')
  #mtext(paste0("B",1))
}
par(op)
dev.off()

# plot to show the effect of increasing numlocs for r=0 (LC model), r=0.25 (Ricker model)
pdf("./Results/ext_risk_numlocs_effect_global_disp.pdf",heigh=6,width=6)
op<-par(mfrow=c(2,2),mar=c(4,4,1,1) + 0.1)
for(r in c(0,0.25)){
  #cat("r=",r,"\n")
  s5<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=r,K=50,disp_everywhere=T,ploton=F)
  s25<-varying_d(numsims=10000,numsteps =25,numlocs=25,r=r,K=50,disp_everywhere=T,ploton=F)
  
  plot(s5$d_seq,s5$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
  lines(s25$d_seq,s25$risk_left,type="b",col="orange")
  legend("topleft", title=paste0("r=",r," , left tail dep. in noise"), c("numlocs=5","numlocs=25"), fill=c('red', 'orange'),  horiz=F, bty='n')
 
  
  plot(s5$d_seq,s5$risk_right,xlim=c(0,1),ylim=c(0,1),type="b",col="blue",
       panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
  lines(s25$d_seq,s25$risk_right,type="b",col="skyblue")
  legend("topleft",title=paste0("r=",r," , right tail dep. in noise"), c("numlocs=5","numlocs=25"), fill=c('blue', 'skyblue'),  horiz=F, bty='n')
  #mtext(paste0("B",1))
}
par(op)
dev.off()

# plot to see the effect of K for r=0.25 (Ricker model)
pdf("./Results/ext_risk_K_effect.pdf",heigh=6,width=6)
op<-par(mfrow=c(2,2),mar=c(4,4,1,1) + 0.1)

s1<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=0.25,K=50,disp_everywhere=F,ploton=F)
s2<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=0.25,K=200,disp_everywhere=F,ploton=F)
  
s3<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=0.25,K=50,disp_everywhere=T,ploton=F)
s4<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=0.25,K=200,disp_everywhere=T,ploton=F)
  
plot(s1$d_seq,s1$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
lines(s2$d_seq,s2$risk_left,type="b",col="orange")
legend("topleft",title=("Noise : left tail dep., local disp."), c("K=50","K=200"), fill=c('red', 'orange'),  horiz=F, bty='n')
  
plot(s1$d_seq,s1$risk_right,xlim=c(0,1),ylim=c(0,1),type="b",col="blue",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
lines(s2$d_seq,s2$risk_right,type="b",col="skyblue")
legend("topleft",title=("Noise : right tail dep., local disp."),c("K=50","K=200"), fill=c('blue', 'skyblue'),  horiz=F, bty='n')
 
plot(s3$d_seq,s3$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
lines(s4$d_seq,s4$risk_left,type="b",col="orange")
legend("topleft",title= ("Noise : left tail dep., global disp."),c("K=50","K=200"), fill=c('red', 'orange'),  horiz=F, bty='n')
  
plot(s3$d_seq,s3$risk_right,xlim=c(0,1),ylim=c(0,1),type="b",col="blue",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
lines(s4$d_seq,s4$risk_right,type="b",col="skyblue")
legend("topleft",title=("Noise : right tail dep., global disp."),c("K=50","K=200"), fill=c('blue', 'skyblue'),  horiz=F, bty='n')
 
par(op)
dev.off()
```

![Extinction_Risk_local_dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp}](./Results/ext_risk_local_disp.pdf){ width=40%, height=40% }

![Extinction_Risk_global_dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp}](./Results/ext_risk_global_disp.pdf){ width=40%, height=40% }

![Extinction_Risk_numlocs_effect_local_disp; numsteps=25, numsims=10000\label{fig_risk_numlocs_effect_local_disp}](./Results/ext_risk_numlocs_effect_local_disp.pdf){ width=40%, height=40% }

![Extinction_Risk_numlocs_effect_global_disp; numsteps=25, numsims=10000\label{fig_risk_numlocs_effect_global_disp}](./Results/ext_risk_numlocs_effect_global_disp.pdf){ width=40%, height=40% }

![Extinction_Risk_K_effect on Ricker model; r=0.25, numsteps=25, numsims=10000\label{fig_risk_K_effect}](./Results/ext_risk_K_effect.pdf){ width=40%, height=40% }


# Consequence of non-Normal copula structure : effect on skewness of the spatial mean \label{Consequence_skewness}

Because of overall distinct tail dependence of the multivariate copula structure, the skewness of the spatially-averaged time-series data, changed significantly from the individual skewness of time-series data. Spatial mean of the time series data extracted that tail dependence from the multivariate data set, if any, and reflected in the averaged skewness. We tested null hypothesis $H_{0}$ which presumed that multivariate copula actually came from normal copula structure with no tail dependence and thus should have the same skewness as of normal copula. So, first we generated $10000$ number of surrogate normal copula from a given multivariate copula keeping the marginal distribution and the correlation (spearman or kendall) same. Then we calculated the skewness of spatially averaged surrogate time series data, as we did with the actual multivariate data set (For code see [skewness_multivar_dataset.R](https://github.com/sghosh89/BIVAN/blob/master/skewness_multivar_dataset.R). We made a histogram of surragate skewness and found if actual skewness were within $95\%$ quantile or not. If $p$-value is less than $0.05$, then we reject the null hypothesis in support of significant tail dependence (and henceforth significantly different skewness).

To verify that we used our four multivariate datasets : aphid-count data, aphid-firstflight data, plankton data and methane-flux data. Figure \ref{fig_skewness_count} showed that averaged skewness was much lower than expected if the aphid count data came from a normal copula. In that example, $p$ value was denoted by the fraction of surrogate-skewness which were lower than the averaged skewness of the given data (red line in Figure \ref{fig_skewness_count}). As $p<0.05$, we rejected $H_{0}$ in support of significantly stronger lower tail dependence which was also consistent with the non-parametric analysis and model fitting results. On the other hand, Figure \ref{fig_skewness_ff} demonstrated that averaged skewness was much higher than expected if the aphid first flight data came from a normal copula. As $p$ value (the fraction of surrogate-skewness which were greater than the averaged skewness of the given data - red line in Figure \ref{fig_skewness_ff}) was less than $0.05$, we reject $H_{0}$ in support of upper tail dependence. Figure \ref{fig_skewness_pns} showed that averaged skewness was lower than expected if the plankton data came from a normal copula. Our previous results on non-parametric analysis and model fitting also supported lower tail dependence. But, as $p>0.05$, we could not reject $H_{0}$ in that case. Finally, for methane-flux data, the averaged skewness was lower than expected if the data came from a normal copula (Figure \ref{fig_skewness_methane}). As $p<0.05$, we rejected $H_{0}$ and that result was consistent with the non-parametric analysis and model selection results which also favored lower tail dependence. 

# Consequence of non-Normal copula structure : Effect on Taylor's law \label{Consequence_TL}

Spatial Taylor's law, which shows linear relationship between `log`(variance) and `log`(mean) of population densities of a species from different locations, is a well-known pattern found in ecology and related fields [@Taylor1961, @Taylor1988, @Cohen2013, @Doring2015, @Kuo2016, @Xu2016, @Reuman2017]. Here, we examined the nature of the slope and how it changed if population time series (taken as $50$ years) from different locations (say, $numloc=25$) had some certain type of copula structure (namely, \textbf{C}, \textbf{F} and \textbf{SC}) other than the $\textbf{N}$ormal copula. First, we simulated (N $\times$ n $\times$ nr) dimensional normal copula with covariance $\rho =0.7$, where $(N=50,n=25,nr=10)$ are the length of timeseries, number of sampling locations and number of replica for that copula, respectively. Then we generated Kendall-correlation preserving \textbf{C}layton, \textbf{F}rank and $\textbf{S}$urvival \textbf{C}layton surrogates with same dimension of \textbf{N}ormal. With these four different types of copula we computed `log`(spatial variance) and `log`(mean) and plotted in Fig.\ref{fig_spTL}(A-D). We also tested statistically that whether linearity, homoskedasticity is maintained in each copula dataset or not and plotted our results alongwith root mean square error, intercept and slope in Fig.\ref{fig_spTL}(E-I) (For code see [`copsurrognd.R`](https://github.com/sghosh89/BIVAN/blob/master/copsurrognd.R) and [`TaylorsLawTools.R`](https://github.com/sghosh89/BIVAN/blob/master/TaylorsLawTools.R)).


# Consequence of non-Normal copula structure : effect on extinction risk \label{Consequence_ext_risk}

In order to study the effects of non-Normal copula structure on extinction risk for metapopulations with different dispersal rules, we examined the following generalized multiple patch model where local population dynamics at each patch were governed by the Lewton-Cohen model ($r=0$) or Ricker model ($r \neq 0$) as the case may be;
<!--did I write correct spelling for lewton model?-->

\begin{equation}\label{eq.extrisk_model}
P(t+1) = \exp\left [  r\left ( 1-\frac{P(t)}{K} \right ) + \epsilon(t) \right ] P(t)
\end{equation}

$r$ is the liner growth rate and $K$ is the carrying capacity of the environment. $\epsilon$ is the environmental noise which might take stronger right tail (means stronger upper tail)  or stronger left tail (means stronger lower tail) dependence. We then considered each population $P(t+1)$ was updated depending upon $D$, the dispersal matrix, which could take either forms; one case when each population patch on a linear chain interacted with its two nearest neighbors (we called it local dispersion) or when any patch was allowed to interact with the rest of all (we called it as global dispersion). We simulated Eq. \ref{eq.extrisk_model} for $10000$ simulations and calculated extinction risk after $25$ years with different possibilities (for code see [mydispersal.R](https://github.com/sghosh89/BIVAN/blob/master/mydispersal.R)) and summarized our findings as follows;


- LC model (r=0) :

    * For LC model, as expected, when extinction risk calculated after $25$ years, was plotted against each varying $d$ (=degree of dispersion), we found that extinction risk was higher for data came from left tail dependent environmental fluctuations than right tail dependent one. [see first subplot of Fig. \ref{fig_risk_local_disp} and Fig. \ref{fig_risk_global_disp}]

- Ricker model (r $\neq$ 0):

    * For ricker model when extinction risk calculated after $25$ years, was plotted against each varying $d$ (=degree of dispersion), we found that extinction risk was higher for data came from left tail dependent environmental fluctuations than right tail dependent one upto $r=0.7$. For $r>0.7$, extinction risk is greater for data came from right tail dependent environmental fluctuations. [see Fig. \ref{fig_risk_local_disp} - \ref{fig_risk_global_disp}]
 
    * With increasing $K$ from $50$ to $200$, extinction risk in both case gets decreased as expected. [see Figure \ref{fig_risk_K_effect}]
  
With increasing number of patches from $5$ to $25$, extinction risk decreased [for a fixed $d$] ; [see Fig. \ref{fig_risk_numlocs_effect_local_disp} - Fig. \ref{fig_risk_numlocs_effect_global_disp}] for both model. 


\newpage

# References
<div id="refs"></div>




