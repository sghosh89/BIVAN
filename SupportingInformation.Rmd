---
title: "Supporting Information : The importance of a complete statistical description of dependence between variables for ecology and related fields"
author: "S. Ghosh, T. Loecke, C.P. Reid, D.C. Reuman"
geometry: "left=1cm,right=1cm,top=2.2cm,bottom=2.2cm"

output: 
  pdf_document:
    number_sections: yes
    keep_tex: yes
    fig_caption: yes
    includes:
      in_header: head_supp.sty
      
tables: True
link-citations: True
urlcolor : blue
indent : True

csl: ecology-letters.csl
bibliography: REF_ALL.bib
---

\pagenumbering{roman}
\tableofcontents
\listoffigures
\listoftables

\pagebreak
\pagenumbering{arabic}

<!--Basic setup-->
```{r setup, echo=F}
knitr::opts_chunk$set(echo = TRUE, fig.pos = "H")
seed<-101
# families<-c(1,3:10,13,14,16:20)
source("mtime.R") #A function needed for caching
```

```{r cop_fig_intro,echo=F,results="hide",cache=T, cache.extra=list(seed,mtime("copsurrognd.R"))}
library(copula)
library(VineCopula)
library(mvtnorm)
set.seed(seed)

source("copsurrognd.R")

#x <- read.table("./Data/dataset/x.txt")
#y <- read.table("./Data/dataset/y.txt")
#mat<-cbind(x,y)
#colnames(mat)<-c("x","y")

#***constants
N<-200 #length of time series
n<-2 #number of sampling locations
numdat<-1 #the number of datasets to get from the normal copula
rho<-0.8 #normal-copula parameter for dependence between locations
#this is a covariance, see below call to rmvnorm

#***generate the starting data, which has normal copula structure
#because it comes originally from a multivariate normal, before 
#transformation
sig<-matrix(rho,n,n)
diag(sig)<-1
m<-rmvnorm(N*numdat,mean=rep(0,n),sigma=sig)
m<-array(m,c(N,numdat,n))
m<-aperm(m,c(1,3,2)) # 2nd dim is normally distributed e.g. hist(m[,1,])
gshape<-7.5
gscale<-1 #gamma parameters

cop_to_marg_trans<-function(x){
  return(qgamma(x,shape=gshape,scale=gscale)) #this is where we choose the marginals,
  #should be something skewed
}
# pnorm(m) makes normal to uniform
# then qgamma(...) makes uniform to gamma distributed
m<-cop_to_marg_trans(pnorm(m))

ccop<-claytonCopula(2,2)
csurrog<-array(NA,dim(m))
csurrog[,,1]<-copsurrognd(m[,,1],targetcop=ccop,numsurrog=1)
mat<-csurrog[,,1]

pdf("./Results/rawdata.pdf",height = 4, width = 4)
scale<-2
xhist <- hist(mat[,1], breaks=30, plot=FALSE)
yhist <- hist(mat[,2], breaks=30, plot=FALSE) 
top <- max(c(xhist$counts, yhist$counts)) 
xrange <- range(mat[,1])
yrange <- range(mat[,2])
nf <- layout(matrix(c(2,0,1,3),2,2,byrow=TRUE), c(4,1), c(1,4), TRUE) 
op<-par(mar=c(3,3,1,1),mgp=c(2, 1, 0))  
plot(mat[,1], mat[,2], xlim=xrange, ylim=yrange, xlab="x", ylab="y", cex.lab=1.5)
legend("bottomright","raw data plot",bty="n",cex=1.5,text.col="magenta")
op<-par(mar=c(0,3,1,1)) 
barplot(xhist$counts/scale, axes=FALSE, ylim=c(0, top), space=0) 
op<-par(mar=c(3,0,1,1)) 
barplot(yhist$counts/scale, axes=FALSE, xlim=c(0, top), space=0, horiz=TRUE)
par(op)
dev.off()

pdf("./Results/copdata.pdf",height = 4, width = 4)
copmat<-pobs(mat)
xhist <- hist(copmat[,1], breaks=30, plot=FALSE)
yhist <- hist(copmat[,2], breaks=30, plot=FALSE) 
top <- max(c(xhist$counts, yhist$counts)) 
xrange <- c(0,1)
yrange <- c(0,1)
nf <- layout(matrix(c(2,0,1,3),2,2,byrow=TRUE), c(4,1), c(1,4), TRUE) 
op<-par(mar=c(3,3,1,1),mgp=c(2, 1, 0)) 
plot(copmat[,1], copmat[,2], xlim=xrange, ylim=yrange, xlab="u=rank(x)/(n+1)", ylab="v=rank(y)/(n+1)",cex.lab=1.5)
legend("bottomright","copula plot",bty="n",cex=1.5,text.col="magenta")
op<-par(mar=c(0,3,1,1)) 
barplot(xhist$counts/scale, axes=FALSE, ylim=c(0, top), space=0) 
op<-par(mar=c(3,0,1,1)) 
barplot(yhist$counts/scale, axes=FALSE, xlim=c(0, top), space=0, horiz=TRUE)
par(op)
dev.off()
```

```{r cop_pedagog_fig,echo=F,results="hide"}
set.seed(seed)
source("./FirstPedagogFig.R")
source("./SecondPedagogFig.R")
source("./ThirdPedagogFig.R")
source("./MakeCopulaPedagogFigs.R")
source("./MakeBivarDataPlot.R")
```

<!--The raw data look like this:-->
```{r load_data_Loecke, echo=F, results='hide'}
#fig.cap="Plot of the raw soil C and N data.\\label{fig_raw_cop_soilCN}(A)", fig.height=3, fig.width=3}
d<-readRDS("Data/dataForShymolinaCoord.rds")
d<-d[,c("SOCstock100","TSNstock100","lat","long")]
d<-na.omit(d)
pdf("./Results/SoilCNraw.pdf")
op<-par(mar=c(6, 6, 0.2, 2.1))
plot(d[,1],d[,2],type="p",col="black",xlab="Soil C",ylab="Soil N",cex.lab=2.5,cex.axis=2.5)
par(op)
dev.off()
```

<!--The copula looks like this:-->
```{r rankandplot_Loecke, echo=F, results='hide'}
source("getcopula.R")
#convert to a copula and plot
pdf("./Results/SoilCNcop.pdf")
v_CN<-getcopula(d=d[,c(1:2)],rankon=T,ploton=T) 
dev.off()
```

```{r plot_SoilCNmapUSA, echo=F, results='hide'}
#---------map of soilCN location on USA------------
library(maps)
pdf("./Results/SoilCNmapUSA.pdf",height=4,width=8)
map("usa")
points(x = d$long, y = d$lat, col="red",pch=16,cex=0.5)
dev.off()
```

```{r read_BMR_birds_and_copulaplot, echo=F, results='hide'}
set.seed(seed)
raw_b<-readxl::read_xls("./Data/BMR/BirdBodyMassesMetabolicRates/BirdMassesAndMetabolicRatesMcNab2008.xls")
raw_b<-raw_b[,1:3]
raw_b<-na.omit(raw_b)
raw_b<-raw_b[,2:3]
raw_b<-as.data.frame(raw_b)

saveRDS(raw_b,"./Data/BMR/BirdBodyMassesMetabolicRates/my_birdsBMR_data.RDS")

b<-log10(raw_b)
colnames(b)<-c("log10M(g)","log10BMR(KJ/h)")
pdf("./Results/BMR_results/birds/raw_birds_BMR.pdf")
op<-par(mar=c(6, 6, 0.2, 2.1))
plot(b[,1],b[,2],type="p",col="black",xlab="log(Mass)",ylab="log(BMR)",cex.lab=2.5,cex.axis=2.5)
par(op)
dev.off()

source("getcopula.R")
pdf("./Results/BMR_results/birds/copula_birds_BMR.pdf")
cop_b<-getcopula(d=b,rankon=T,ploton=T) #convert to a copula and plot
dev.off()
```

```{r read_BMR_mammals_and_copulaplot, echo=F, results='hide'}
set.seed(seed)
raw_m<-readxl::read_xls("./Data/BMR/MammalianBodyMassesMetabolicRates/MammalianMassesAndMetabolicRatesMcNab2008.xls")
raw_m<-raw_m[,1:3]
raw_m<-na.omit(raw_m)
raw_m<-raw_m[,2:3]

saveRDS(raw_m,"./Data/BMR/MammalianBodyMassesMetabolicRates/my_mammalsBMR_data.RDS")

m<-log10(raw_m)
colnames(m)<-c("log10M(g)","log10BMR(KJ/h)")
m<-as.data.frame(m)

pdf("./Results/BMR_results/mammals/raw_mammals_BMR.pdf")
op<-par(mar=c(6, 6, 0.2, 2.1))
plot(m[,1],m[,2],type="p",col="black",xlab="log(Mass)",ylab="log(BMR)",cex.lab=2.5,cex.axis=2.5)
par(op)
dev.off()

source("getcopula.R")
pdf("./Results/BMR_results/mammals/copula_mammals_BMR.pdf")
cop_m<-getcopula(d=m,rankon=T,ploton=T) #convert to a copula and plot
dev.off()
```

```{r read_ceder_creek_data, echo=F, results="hide"}
set.seed(seed)
#-------------------------------------------------
# This function takes 
# Input :
#       db : a dataframe : smaller subset of ple_120 data to calculate avg. biomass for each plot
#       dp : a dataframe : smaller subset of pce_120 data to calculate avg. shannon's H for those plots
#       year : the year for which you want to calculate biomass and shannon's index data
#       rawplot : logical : T for rawdata plot, F for copula plot
#       ploton : logical for optional plotting

# Output :
#       a list of two data-frame:
#                   tab_dbp : a data-frame with 3 column : (plot no , avg.H, avg.Biomass(g/m2))
#                   cop_tab_dbp : a data-frame with 3 column : (plot no, pobs(avg.H), pobs(avg.Biomass(g/m2)))

cop_HB<-function(db,dp,year,rawplot,ploton){
  # db : biomass dataset for a specific year
  # dp : percent cover dataset for a specific year
  
  plots<-sort(intersect(db$Plot,dp$Plot)) # common plots for both datasets for a specific year
  db<-subset(db,Plot%in%plots)
  dp<-subset(dp,Plot%in%plots)
  
  
  tab_dbp<-data.frame(Plot=plots,avg.H=NA,avg.Biomass=NA)
  for(i in 1:length(plots)){
    # calculate biomass for each plot (averaged over all strips for that plot)
    x<-subset(db,Plot==plots[i])
    tab_dbp$avg.Biomass[i]<-mean(x$Biomass) 
    
    # calculate shannon's index H for each plot (averaged over all Quadrates for that plot)
    x<-subset(dp,Plot==plots[i])
    uniq_sp<-sort(as.character(unique(x$Species)))  # These are the species in a particular plot
    Q<-as.character(unique(x$Quadrat))
    
    tab_each_sp<-data.frame(sp=uniq_sp,avg_cov=0,rel_avg_cov=0)
    
    for(sp in 1:length(uniq_sp)){
      my_sp<-uniq_sp[sp]
      tab_temp<-data.frame(Q=Q,abs_cov=0)
      ind<-which(x$Species==my_sp)
      li<-length(ind)
      tab_temp$abs_cov[1:li]<-x$Abscover[ind]
      tab_each_sp$avg_cov[[sp]]<-mean(tab_temp$abs_cov) # avg. over 4Quadrates for a sp.
    }
    
    tab_each_sp$rel_avg_cov<-tab_each_sp$avg_cov/sum(tab_each_sp$avg_cov)
    tab_dbp$avg.H[i]<- -sum((tab_each_sp$rel_avg_cov)*log(tab_each_sp$rel_avg_cov))

  }
  
  tab_dbp<-na.omit(tab_dbp)
  
  cop_tab_dbp<-data.frame(Plot=tab_dbp$Plot,avg.H=NA,avg.Biomass=NA)
  cop_tab_dbp$avg.H<-VineCopula::pobs(tab_dbp$avg.H)
  cop_tab_dbp$avg.Biomass<-VineCopula::pobs(tab_dbp$avg.Biomass)
  
  
  if(ploton==T){
    if(rawplot==T){
      op<-par(mar=c(6, 6, 0.2, 2.1))
      plot(tab_dbp$avg.H,tab_dbp$avg.Biomass,xlab="avg. H",ylab="avg. Biomass",pch=1,cex.lab=2.5,cex.axis=2)
      mtext(paste0("Year=",year),cex=1)
      par(op)
    }else{
      op<-par(mar=c(6, 6, 0.2, 2.1))
      plot(cop_tab_dbp$avg.H,cop_tab_dbp$avg.Biomass,xlab="u",ylab="v",pch=1,cex.lab=3,cex.axis=2,
         xlim=c(0,1),ylim=c(0,1),asp=1)
      rect(0,0,1,1)
      lines(c(0,1),c(0,1),type='l',col="grey")
      #mtext(paste0("Year=",year),cex=1)
      par(op)
    }
  }
  
  return(list(tab_dbp=tab_dbp,
         cop_tab_dbp=cop_tab_dbp))
}
#-----------------------------
r_ple<-read.delim("./Data/Ceder_creek_e120/edited_ple120.txt")
names(r_ple)[36]<-"Biomass"

r_pce<-read.delim("./Data/Ceder_creek_e120/edited_pce120.txt")

y1<-unique(r_ple$Year)
y2<-unique(r_pce$Year)
yr<-sort(intersect(y1,y2))

a<-as.data.frame(table(sort(r_pce$Species)))
b<-as.character(a$Var1)
bad_sp<-c(b[51:53],b[156:158])

ind<-which(r_pce$Species%in%bad_sp)
r_pce_clean<-r_pce[-ind,]
#--------------------------------------------------------------------------------------------
pdf("./Results/Ceder_creek_results/raw_HB_all_yr.pdf",height = 6,width = 10)
op<-par(mfrow=c(2,3),mar=c(3,3,3,3), mgp=c(1.5,0.5,0))
for(i in 1:length(yr)){
  db<-subset(r_ple,Year==yr[i])
  dp<-subset(r_pce_clean,Year==yr[i])
  
  sr<-cop_HB(db=db,dp=dp,year=yr[i],rawplot=T,ploton = T)
}
par(op)
dev.off()
#-----------------------
#raw data plot for year2000
pdf("./Results/Ceder_creek_results/raw_HB_2000.pdf",height = 6,width = 6)
i<-5
db<-subset(r_ple,Year==yr[i])
dp<-subset(r_pce_clean,Year==yr[i])
sr<-cop_HB(db=db,dp=dp,year=yr[i],rawplot=T,ploton = T)
saveRDS(sr,"./Results/Ceder_creek_results/raw_cop_cc_2000.RDS")
dev.off()
#----------------------------------------------------------------------------------------
cop_HB_all_yr<-vector("list",length(yr))
names(cop_HB_all_yr)<-yr

pdf("./Results/Ceder_creek_results/cop_HB_all_yr.pdf",height = 6,width = 10)
op<-par(mfrow=c(2,3),mar=c(3,3,3,3), mgp=c(1.5,0.5,0))
for(i in 1:length(yr)){
  db<-subset(r_ple,Year==yr[i])
  dp<-subset(r_pce_clean,Year==yr[i])
  
  s<-cop_HB(db=db,dp=dp,year=yr[i],rawplot=F,ploton = T)
  cop_HB_all_yr[[i]]<-s$cop_tab_dbp[,2:3]
}
par(op)
dev.off()
#-------------------------
#cop data plot for year2000
pdf("./Results/Ceder_creek_results/cop_HB_2000.pdf",height = 6,width = 6)
i<-5
db<-subset(r_ple,Year==yr[i])
dp<-subset(r_pce_clean,Year==yr[i])
s<-cop_HB(db=db,dp=dp,year=yr[i],rawplot=F,ploton = T)
cc_cop_2000<-s$cop_tab_dbp[,2:3]
dev.off()
#------------------

saveRDS(cop_HB_all_yr,"./Results/Ceder_creek_results/cop_HB_all_yr.RDS")
#---------------------------------------------------------------------------------------
cop_HB_all_yr<-readRDS("./Results/Ceder_creek_results/cop_HB_all_yr.RDS")
```

```{r map_plot_aphid_plankton,results="hide",echo=F}
source("aphid_data_calling.R")
source("good_loclist.R")
library(maps)

#----------------- Aphid map--------------------------------------------
d0_count<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtscount141117.csv",header=F))
data_aphid_count<-d_allsp_data(d0_count)

d0_firstflight<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsfirstflight141117.csv",header=F))
data_aphid_ff<-d_allsp_data(d0_firstflight)

selective_loc1<-good_loclist(d_allsp=data_aphid_count,sp=10,data_pt_thrs=30)
selective_loc2<-good_loclist(d_allsp=data_aphid_ff,sp=11,data_pt_thrs=30)
all(selective_loc1==selective_loc2)==T

longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

locno<-length(longs)
df_loc_info_org<-data.frame(loc_no=c(1:length(lats)),longs=longs,lats=lats)
df_loc_info<-df_loc_info_org[selective_loc1,]
xlim=c(-10,2)
ylim=c(50, 60)

pdf("./Results/aphid_map_plot.pdf")
map("world", fill=TRUE, col="grey84", bg="white",border=0, xlim=xlim, ylim=ylim)
map.axes(cex.axis=2.5)
points(x = df_loc_info_org$longs, y = df_loc_info_org$lats, col="red",pch=16)
points(x = df_loc_info$longs, y = df_loc_info$lats, col="blue", pch=0, cex=1.5)
text(df_loc_info_org$loc_no, x = df_loc_info_org$longs, y = df_loc_info_org$lats, col="red",  pos=1)
dev.off()

#--------------Plankton map----------------------------

source("plankton_north_sea_data_calling.R")
d0_plankton_north_sea<-as.matrix(read.csv("./Data/Plankton_North_Sea_data/planktontimeseries201117_4.csv",header=F))
data_plankton_north_sea<-d_allsp_data_plankton_north_sea(d0_plankton_north_sea)

longs<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlongs201117.csv",header=F)
lats<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlats201117.csv",header=F)
longs_pns<-longs[[1]]
lats_pns<-lats[[1]]

df_loc_info_org<-data.frame(loc_no=c(1:length(lats_pns)),longs=longs_pns,lats=lats_pns)
selective_loc<-good_loclist(d_allsp=data_plankton_north_sea,sp=16,data_pt_thrs=45)
df_loc_info<-df_loc_info_org[selective_loc,]
xlim=c(-12,10)
ylim=c(48, 60)

pdf("./Results/plankton_map_plot.pdf")
map("world", fill=TRUE, col="grey84", bg="white",border=0, xlim=xlim, ylim=ylim)
map.axes(cex.axis=2.5)
abline(h=seq(from=ylim[1],to=ylim[2],by=2), v=seq(from=xlim[1],to=xlim[2],by=2), col="black", lty=2)
points(x = df_loc_info_org$longs+1, y = df_loc_info_org$lats+1, col="red",pch=16)
points(x = df_loc_info$longs+1, y = df_loc_info$lats+1, col="blue", pch=0, cex=1.5)
text(df_loc_info_org$loc_no, x = df_loc_info_org$longs+1, y = df_loc_info_org$lats+1, col="red",  pos=1)
dev.off()
```

# Transformations and copulas used in Fig. \ref{MT-fig_cop_pedag1} \label{pedagog1_details}

<!--***DAN: fill in later-->

# Details of the data \label{Data_details}

<!--***DAN: This is a dumping ground at the moment, but needs to be organized into a section that gives all the necessary details about the data-->

<!--The CPR is a device which is towed across the ocean behind a ship, filtering plankton from seawater with a continuously
unwinding silk ribbon. The ribbon was cut into 4 inch segments, each corresponding to a particular time and
location in the ocean. Organisms were identified and counted (possibly with sub-sampling) microscopically [@Colebrook1979]. All the samples available for a given variable in a given area in a given month of a given year were
averaged, producing a monthly time series for each year. Where data for a given month was unavailable the missing value was replaced with a median value for that month (drawn from all years in which data was available).-->

 [@Sheppard2017] converted monthly values to yearly values by averaging over all months. But here we only allowed maximum 4 months in a year with missing data which were replaced by median value for that month (drawn from all years in which data was available). We used data from 14 locations which had atleast 45 years time series data (see Figure \ref{SM-fig_plankton_map}). 
 
 The Great Miami Wetland Mitigation Bank  was at $36^{\circ}46^{'}51^{''}$ N, $84^{\circ}20^{'}26^{''}$ W) in Trotwood, Montgomery County, Ohio. Additional information on the history of the site and soil types is detailed in @Jarecke2016. Briefly, the closed static flux chamber method was used [@Holland1999] to measure $CH_{4}$ fluxes at 28 locations across a hydrologic gradient (upland to seasonal wetland) at daily to weekly interval from September 2015 to September 2016. **See and Smyth et al, pending for
additional details???** on greenhouse gas flux methods for this site. We considered 13 locations that had atleast 50 dates data.

```{r tab_aphid_info, echo=F, results='asis',message=F}
library(tinytex)
library(tibble)
aphid_info <- tibble(c1=c("Apple grass aphid","Bird cherry oat aphid","Black bean aphid","Blackberry cereal aphid","Blackcurrant sowthistle aphid",
                       "Corn leaf aphid","Currant lettuce aphid","Damson hop aphid","Grain aphid","Green spruce aphid",
                       "Leaf-curling plum aphid","Mealy cabbage aphid","Mealy plum aphid","Pea aphid","Peach potato aphid",
                       "Potato aphid","Rose grain aphid","Shallot aphid","Sycamore aphid","Willow carrot aphid"),
                     c2=c("Rhopalosiphum insertum", "Rhopalosiphum padi", "Aphis fabae", "Sitobion fragariae", "Hyperomyzus lactucae",
                       "Rhopalosiphum maidis", "Nasonovia ribisnigri","Phorodon humuli","Sitobion avenae","Elatobium abietinum",
                       "Brachycaudus helichrysi","Brevicoryne brassicae","Hyalopterus pruni","Acyrthosiphon pisum","Myzus persicae",
                       "Macrosiphum euphorbiae","Metopolophium dirhodum","Myzus ascalonicus","Drepanosiphum platanoidis","Cavariella aegopodii")
)
knitr::kable(aphid_info, "latex", booktabs = T, linesep = "",
      caption = "Species names of 20 aphids for which data were available \\label{tab_aphid_info}",
      col.names = c("Common name", "Latin binomial"))
```

```{r tab_plankton_info, echo=F, results='asis',message=F}
library(tibble)
plankton_info <- tibble(c('Calanus I-IV','Para-Pseudocalanus spp','Temora longicornis','Acartia spp',
                          'Centropages typicus',
                          'Oithona spp','Echinoderm larvae','Calanus finmarchicus',
                          'Calanus helgolandicus','Metridia lucens','Decapoda larvae',
                   'Euphausiacea','Thalassiosira spp','Rhizosolenia styliformis',
                   'Ceratium fusus','Ceratium furca','Ceratium tripos','Ceratium macroceros',
                   'Rhizosolenia alata alata','Pseudocalanus elongatus Adult',
                   'Nitzschia delicatissima','Nitzschia seriata')
)
knitr::kable(plankton_info, "latex", booktabs = T, linesep = "",
      caption = "Species names of 22 plankton taxa for which data were available \\label{tab_plankton_info}",
      col.names = c("Plankton taxon name"))
```

```{r read_methane_data, echo=F, results="markup"}
set.seed(seed)
methane_raw<-readRDS("./Data/Methane_data/methane_data_for_Shyamolina.rds")
#class(methane_raw) #it's a data.frame for multivariable data
#knitr::kable(head(methane_raw,3),format='pandoc',
#             caption = "First few rows of raw methane data.\\label{tab_rawdata_methane}",
#             booktabs=T) # display first few rows
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm,height=16 cm]{./Results/SoilCNmapUSA.pdf} 
\caption[Sampling locations for C and N data]{Locations of central pedons sampled 
for soil organic carbon and total soil nitrogen (Mg C or N per hectare of soil 
surface) at 5907 sites across the coterminous United States. \label{fig_SoilCNmapUSA}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm,height=16 cm]{./Results/aphid_map_plot.pdf} 
\caption[Sampling locations for aphid data]{Locations of the 
Rothamsted Insect Survey 
suction traps from which data were available are indicated by the red circles, 
out of which only blue boxes had at least 30 years of data and were 
used for our study. \label{fig_aphid_map}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm,height=16 cm]{./Results/plankton_map_plot.pdf} 
\caption[Sampling regions for CPR plankton data]{CPR data were available from 
26 locations ($2^{\circ}$ $\times$ $2^{\circ}$ regions on the map) around UK 
seas (red circles), out of which only blue boxes had at least 45 years of data and
were used for our study. \label{fig_plankton_map}}
\end{center}
\end{figure}

# Background on the copulas we fitted with data \label{copula_details}

<!--Dumping ground at present, need to organize and fill in.

Notes about individual copula parameter ranges:
-->

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_Normal.pdf}
\caption[Example N copulas]{Log-transformed pdfs (A-E) and samples (F-J) from example N copulas. 
S is Spearman correlation; p is the value of the parameter for the N 
family (it is a 
one-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, respectively.\label{figped_N}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_Clayton.pdf}
\caption[Example C copulas]{Log-transformed pdfs (A-E) and samples (F-J) from example C copulas. S is Spearman correlation; p is the value of the parameter for the C family (it is a 
one-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively.\label{figped_C}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SurvClayton.pdf}
\caption[Example SC copulas]{Log-transformed pdfs (A-E) and samples (F-J) 
from example SC 
copulas. S is Spearman correlation; p is the value of the parameter for the SC 
family (it is a one-parameter family); and LT and UT are the measures of lower- and 
upper-tail dependence, respectively.\label{figped_SC}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_Gumbel.pdf}
\caption[Example G copulas]{Log-transformed pdfs (A-E) and samples (F-J) from example G copulas. S is 
Spearman correlation; p is the value of the parameter for the G family (it is a 
one-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively.\label{figped_G}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SurvGumbel.pdf}
\caption[Example SG copulas]{Log-transformed pdfs (A-E) and samples (F-J) from example SG 
copulas. S is Spearman correlation; p is the value of the parameter for the SG 
family (it is a one-parameter family); and LT and UT are the measures of lower- and 
upper-tail dependence, respectively.\label{figped_SG}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_Joe.pdf}
\caption[Example J copulas]{Log-transformed pdfs (A-E) and samples (F-J) from example J copulas. K is Kendall correlation; p is the value of the parameter for the J family (it is a 
one-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively.\label{figped_J}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SurvJoe.pdf}
\caption[Example SJ copulas]{Log-transformed pdfs (A-E) and samples (F-J) from example SJ 
copulas. K is Spearman correlation; p is the value of the parameter for the SJ 
family (it is a one-parameter family); and LT and UT are the measures of lower- and 
upper-tail dependence, respectively.\label{figped_SJ}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_Frank.pdf}
\caption[Example F copulas]{Log-transformed pdfs (A-E) and samples (F-J) from example F copulas. S is Kendall correlation; p is the value of the parameter for the F family (it is a 
one-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively.\label{figped_F}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_BB1.pdf}
\caption[Example BB1 copulas]{Log-transformed pdfs for example BB1 copulas. K is Kendall correlation; p1 and p2
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are our measures of lower- and upper-tail dependence, 
respectively.\label{figped_BB1}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SBB1.pdf}
\caption[Example SBB1 copulas]{Log-transformed pdfs for example SBB1 copulas. K is Kendall correlation; p1 ad p2 
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are our measures of lower- and upper-tail dependence, 
respectively.\label{figped_SBB1}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_BB6.pdf}
\caption[Example BB6 copulas]{Log-transformed pdfs for example BB6 copulas. K is Kendall correlation; p1 and p2
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are our measures of lower- and upper-tail dependence, 
respectively.\label{figped_BB6}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SBB6.pdf}
\caption[Example SBB6 copulas]{Log-transformed pdfs for example SBB6 copulas. K is Kendall correlation; p1 ad p2 
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are our measures of lower- and upper-tail dependence, 
respectively.\label{figped_SBB6}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_BB7.pdf}
\caption[Example BB7 copulas]{Log-transformed pdfs for example BB7 copulas. K is Kendall correlation; p1 and p2
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are our measures of lower- and upper-tail dependence, 
respectively.\label{figped_BB7}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SBB7.pdf}
\caption[Example SBB7 copulas]{Log-transformed pdfs for example SBB7 copulas. K is Kendall correlation; p1 ad p2 
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are our measures of lower- and upper-tail dependence, 
respectively.\label{figped_SBB7}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_BB8.pdf}
\caption[Example BB8 copulas]{Log-transformed pdfs for example BB8 copulas. K is Kendall correlation; p1 and p2
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are our measures of lower- and upper-tail dependence, 
respectively.\label{figped_BB8}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SBB8.pdf}
\caption[Example SBB8 copulas]{Log-transformed pdfs for example SBB8 copulas. K is Kendall correlation; p1 ad p2 
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are our measures of lower- and upper-tail dependence, 
respectively.\label{figped_SBB8}}
\end{center}
\end{figure}

# Nonparametric statistics \label{nonparam_stats}

<!--***DAN: Right now this is a dumping grounds for text taken from the main text.
The text is valuable, but needs to be organized to fit together in this supp mat
section-->

We also defined a statistic $\Ps_{l_b,u_b}$, using the same bounds
$u+v=2l_b$ and $u+v=2u_b$, as follows. For a distance $h$, we defined
$S(h)$ to be the number of points $(u_i,v_i)$ within the bounds 
and a distance less than $h$ from the line $v=u$, divided by the 
total number of points within the bounds. This function is
defined for $h$ going from $0$ to a distance $h_{\text{max}}$ which
is half the longer of the two segments obtained by intersecting the
bounds with the unit square. It is easy to see $S(0)=0$ and 
$S(h_{\text{max}})=1$. We defined $S_i(h)$, for the same range 
of $h$, to be the area within the bounds and the unit square
and within distance $h$ of the line $v=u$, divided by the area
within the bounds and the unit square. This is the expected value of
$S(h)$ for independent data. We then defined
\begin{equation}\label{eq.P}
   P_{l_b,u_b} = \int_0^{h_{max}} ( S(h) - S_i(h) ) dh.
\end{equation}
As for $\cor_{l_b,u_b}$, larger values of $\Ps_{l_b,u_b}$ 
indicate stronger positive association
between $u$ and $v$ in the region given by the bounds.



\begin{figure}[!h]
\begin{center}
\includegraphics[width=6 cm,height=6 cm]{./stat_image.jpg} \hspace{0.6 cm}
\caption[For definitions of nonparametric statistics]{Schematic diagram supporting definitions of nonparametric tail dependence statistics. The red and blue lines are, respectively, $u+v=2l_b$ and $u+v=2u_b$.\label{fig_stat_image}}
\end{center}
\end{figure}



# Testing nonparametric statistics for various symmetric and asymmetric copulas \label{Test_npa_stat}

Normal and Frank copula families 
are known to have symmetric tail dependence,
i.e., strengths of dependence in the lower and upper tails are the same, for all copulas
in these families [@nelsen2006_copula]. Clayton copulas are known to have stronger lower- than 
upper-tail dependence. And survival Clayton copulas, being rotations of Clayton copulas by 
$180^\circ$, have stronger upper- than lower tail dependence [@nelsen2006_copula].
Using the `iRho` function from the `copula` package, for each of the four families normal, 
Frank, Clayton, and survival Clayton, we obtained parameters for which the expected value of 
Spearman's $\rho$ was, separately, $0,0.1,0.2,...,0.9$. For each copula family and for each 
of the selected parameter values we generated  $n$ points, 100 times, and thereby computed 100 values of the 
statistics $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$. This exercise 
was repeated, separately, 
for $n=1000$ and for $n=35$, these cases being chosen, respectively, to reflect asymptotic behavior of the 
statistics and their behavior on the small datasets which are common in some fields
of ecology. The mean and standard error of the three difference statistics were computed for 
each copula family, parameter value, and value of $n$, and results were plotted against 
Spearman's rho (Figures \ref{fig_stat_testing35} and \ref{fig_stat_testing1000}), 
the expectation being that the difference statistics would be positive for 
Clayton copulas and negative for survival Clayton copulas (except for the case of $\rho=0$, a 
boundary case of these families corresponding to independence), and not significantly different 
from $0$ (we used a $t$-test with a significance threshold of $0.05$) for Frank and normal 
copulas. These expectations were fullfilled (Figures \ref{fig_stat_testing35} and 
\ref{fig_stat_testing1000}).

<!--The message=F and warning=F flags are to suppress warnings that come when you pass a parameter
of 0 to the Frank or Clayton copulas. These are technicallly boundary cases for these families.
They correspond to the independent copula. The packages we use provide the indepdent copula, but
issue a warning. Since anyway we want the independent copula, we can suppress the warning. We ran this
without the warning and it is OK to supress it.-->
<!-- The lines you are talking about appeared as message not as warning(actualy no warning appered for this chunk), so we have to set message=F here-->
```{r stat_testing_save_and_plot_result, message=F, results="hide", echo=F, cache=T, cache.extra=list(seed,mtime("TestStats_multivar_dataset.R"),mtime("CopulaFunctions.R"),mtime("CopulaFunctions_flexible.R"))}
source("TestStats_multivar_dataset.R")
set.seed(seed)

resultsloc<-"./Results/stat_results/stat_testing/"
spearvals<-seq(from=0,to=0.9,by=0.1)
callfn<-coplist_with_params(spearvals=spearvals)
coplist<-callfn$coplist
ncores<-3
res_pt35_rankF<-mclapply(X=coplist,FUN=worker,numpts=35,numsims=100,rank=F,mc.cores=ncores)
res_pt35_rankT<-mclapply(X=coplist,FUN=worker,numpts=35,numsims=100,rank=T,mc.cores=ncores)
res_pt1000_rankF<-mclapply(X=coplist,FUN=worker,numpts=1000,numsims=100,rank=F,mc.cores=ncores)
res_pt1000_rankT<-mclapply(X=coplist,FUN=worker,numpts=1000,numsims=100,rank=T,mc.cores=ncores)
save(res_pt35_rankF,res_pt35_rankT,res_pt1000_rankF,res_pt1000_rankT,file=paste(resultsloc,"StatTestNumericResults.RData",sep=''))

b<-callfn$paramlist
plotter_stat_testing(res_pt35_rankF,"res_pt35_rankF",b,resultsloc,spearvals)
plotter_stat_testing(res_pt35_rankT,"res_pt35_rankT",b,resultsloc,spearvals)
plotter_stat_testing(res_pt1000_rankF,"res_pt1000_rankF",b,resultsloc,spearvals)
plotter_stat_testing(res_pt1000_rankT,"res_pt1000_rankT",b,resultsloc,spearvals)
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/stat_results/stat_testing/res_pt35_rankT.pdf}
\caption[Testing non-parametric statistics with datapoints $n=35$]{Results of tests of whether $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$ reveal the known asymmetry of tail dependence of the Clayton and survival Clayton copulas, and the known symmetry of tail dependence for the normal and Frank copulas. See text for details. $n=35$. \label{fig_stat_testing35}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/stat_results/stat_testing/res_pt1000_rankT.pdf}
\caption[Testing non-parametric statistics with datapoints $n=1000$]{Results of tests of whether $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$ reveal the known asymmetry of tail dependence of the Clayton and survival Clayton copulas, and the known symmetry of tail dependence for the normal and Frank copulas. See text for details. $n=1000$.\label{fig_stat_testing1000}}
\end{center}
\end{figure}

<!--This r-chunk generates figure necessary for maintext Paper-->
```{r fig_stat_testing_for_maintext, message=F, results="hide", echo=F, cache=T, cache.extra=list(seed,mtime("TestStats_multivar_dataset.R"),mtime("CopulaFunctions.R"),mtime("CopulaFunctions_flexible.R"),mtime("StatTestNumericResults.RData"))}
set.seed(seed) 
source("fig_Paper_stat_testing.R")
#load("./Results/stat_results/stat_testing/StatTestNumericResults.RData")
resultsloc<-"./Results/stat_results/stat_testing/"

copname<-"C"
reslist<-res_pt35_rankT

statname<-"CorlmCoru"
call_fig_Paper_stat_testing(resultsloc=resultsloc,statname=statname,copname=copname,reslist=reslist, numsims=100)
statname<-"PlmPu"
call_fig_Paper_stat_testing(resultsloc=resultsloc,statname=statname,copname=copname,reslist=reslist, numsims=100)
statname<-"D2umD2l"
call_fig_Paper_stat_testing(resultsloc=resultsloc,statname=statname,copname=copname,reslist=reslist, numsims=100)
```

# Surrogate testing with bivariate datasets for non-parametric statistics \label{surrog_test}

For bivariate datasets, surrogates were produced as follows.   

- Given data $(x_i,y_i)$ for $i=1,\ldots,n$ and a 
one-parameter target copula family $\mathcal{B}(\theta)$ (here $\theta$ denotes the parameter), let $\tau$ be the
Kendall correlation of the $x_i$ with the $y_i$ and find the parameter value $\theta_\tau$ for which 
$\mathcal{B}(\theta_\tau)$ has Kendall correlation $\tau$ (this is possible for the one-parameter copula families of this 
study using the `iTau` function of the `VineCopula` package). 
- Generate data $(a_i,b_i)$, $i=1,\ldots,n$ from 
$\mathcal{B}(\theta_\tau)$. 
- Permute the ordered set $(x_1,\ldots,x_n)$ such that the permutation
$(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$ has $\rank(x_{\sigma_x(i)})$ equal to $\rank(a_i)$ for all $i$, where 
$\rank(x_{\sigma_x(i)})$ is the rank of $x_{\sigma_x(i)}$ in the set $(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$, and
$\rank(a_i)$ is the rank of $a_i$ in the set $(a_1,\ldots,a_n)$ (here $\sigma_x$ is a permutation of the 
indices $1,\ldots,n$). 
- Likewise permute $(y_1,\ldots,y_n)$
such that the permutation
$(y_{\sigma_y(1)},\ldots,y_{\sigma_y(n)})$ has $\rank(y_{\sigma_y(i)})$ equal to $\rank(b_i)$ for all $i$ ($\sigma_y$ is 
another permutation of $1,\ldots,n$).
- The surrogate dataset is $(x_{\sigma_x(i)},y_{\sigma_y(i)})$ for $i=1,\ldots,n$. 

Our code for this algorithm is [`copsurrog2d`](https://github.com/sghosh89/BIVAN/blob/master/copsurrog2d.R) in the 
[`BIVAN`](https://github.com/sghosh89/BIVAN) repository. 

Because $(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$ 
is a permutation of $(x_1,\ldots,x_n)$ and $(y_{\sigma_y(1)},\ldots,y_{\sigma_y(n)})$ is a 
permutation 
of $(y_1,\ldots,y_n)$, the marginal distributions of the surrogate data are exactly the same as 
those of the original data. 
Because ranks of the surrogate data are matched to ranks of the $a_i$ and $b_i$, the
Kendall correlation of the surrogate dataset will be the same as that of the $a_i$ and $b_i$, and therefore 
will be close to $\tau$ (differences arising only through sampling variation). If instead of $\theta_\tau$
a parameter value $\theta_\rho$ is used such that the Spearman correlation of $\mathcal{B}(\theta_\rho)$ is the same
as that of the $x_i$ with the $y_i$, then Spearman correlations of surrogates will very nearly equal (except for 
sampling variation) the Spearman correlation of the empirical data.  

# Spatial resampling with multivariate datasets for non-parametric statistics \label{spatial_resamp}

The scheme is identical to that proposed by @bjornstadfalck2001 for application in their now 
widely used spline correlogram method; the same scheme was also used by @walteretal2017 
as part of a method for 
performing model selection among matrix regression models. For each pair of 
locations $i \neq j$, the statistic
of interest, here denoted $s_{ij}$ ($\cor_{l_b,u_b}$, $\Ps_{l_b,u_b}$, 
$\Dsq_{l_b,u_b}$, $\cor_l-\cor_u$, 
$\Ps_l-\Ps_u$, or $\Dsq_u-\Dsq_l$) was computed for those locations. The 
values $s_{ij}$ were then arranged in
a matrix, $S$, with diagonal entries NA. The mean of the non-NA entries of $S$ was computed. For 
$\cor_{l_b,u_b}$, $\Ps_{l_b,u_b}$, or $\Dsq_{l_b,u_b}$ this mean characterized the 
average strength of 
dependence, across all pairs of distinct locations, for data in the portion of the distributions 
given by $l_b$ and $u_b$. For $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, or $\Dsq_u-\Dsq_l$, the mean characterized average
asymmetry of tail dependence across all pairs of locations. 
Confidence intervals for the values of $\mean(S)$ were then computed as quantiles of a 
distribution of bootstrapped values. If $\mean(S)$ was significantly different from 0, as
revealed by these confidence intervals, for the statistics $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, 
or $\Dsq_u-\Dsq_l$, then tail dependence was significantly asymmetric, in contrast to a 
Normal null hypothesis, and answering question \hyperref[MT-Intro]{\textbf{(Q1)}} from the \nameref{MT-Intro}.
Bootstrapping was performed by resampling the locations of measurement, with replacement. 
This corresponds to 
resampling, with replacement, the rows and columns of $S$, and is described in detail elsewhere 
[@bjornstadfalck2001 ; @walteretal2017]. 

# How to visualize non-parametric analysis results for multivariate spatial data? \label{visual_npa}

The principle remains same but for example we chose one of spatial data set (green spruce aphid's count) to illustrate results from Table \ref{tab_count_resamp}. Plotting Spearman or Kendall correlation between aphid abundance time series for pairs of locations as a function of great circle distance between the locations (Fig. \ref{fig_aphid_count} A,B) showed the typical decline of correlation with distance between sampling locations that has been seen for numerous other datasets in earlier work. Plotting $\cor_l$, $\cor_u$, $\Ps_l$, and $\Ps_u$  against distance between pairs of locations shows these quantities also decline with distance (Fig. \ref{fig_aphid_count} C-F). Plotting $\Dsq_u$ and  $\Dsq_l$ against distance between pairs of locations shows these quantities increase with distance (as expected, given the opposite interpretation these two statistics have compared to $\cor_u$, $\Ps_u$ and $\cor_l$, $\Ps_l$, respectively). Plotting $\cor_l - \cor_u$, $\Ps_l - \Ps_u$, and $\Dsq_u - \Dsq_l$ versus distance (Fig. \ref{fig_aphid_count} I-K) did not show a decline with distance, but did illustrate visually the statistical result of Table \ref{tab_count_resamp} that averages of these quantities across all pairs of sampling locations were significantly greater than zero, demonstrating asymmetry of tail dependence, as also seen from model selection approach. Code for these analyses is in [`NonParamStat.R`](https://github.com/sghosh89/BIVAN/blob/master/NonParamStat.R) in the [`BIVAN`](https://github.com/sghosh89/BIVAN) repository. 


<!--This chunk is for model selection results of soilCN dataset-->
```{r bivmodselect_Loecke, echo=F, cache=T, cache.extra=list(seed,v_CN,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("OurBiCopSelect.R")
set.seed(seed)
families_Loecke<-c(1,3:10,13:14,16:20) 
BivMS_res_Loecke<-OurBiCopSelect(u1=v_CN[,1],u2=v_CN[,2],families=families_Loecke,level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,gofnormal=F,status=F)
saveRDS(BivMS_res_Loecke,file="./Results/fitting_results/BivMS_soilCN.RDS")
```

<!--Display model selection results in a table-->
```{r tab_soilCNfit, echo=F, results="markup"}
#knitr::opts_knit$set(kable.force.latex = TRUE)
h<-BivMS_res_Loecke$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
colnames(h)<-c("copname","AICw","BICw","LT","UT")
knitr::kable(h, #longtable = T, 
             format = "latex",
      caption.short = "Model fitting results for soil C and N dataset",
      caption = "Results of fitting our 16 copulas to the soil C and N dataset. Copula name abbreviations are given in the main text. AICw = AIC weight; BICw = BIC weight; LT = the lower-tail dependence statistic for the copula family with the fitted parameters; UT = the same for upper-tail dependence.\\label{tab_soilCNfit}",
      booktabs = TRUE)
```

<!--This chunk is for npa testing results of soilCN dataset-->
```{r stat_soilCN_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,v_CN,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed) 
stat_soilCN_ga<-bivfunctionplot(v=v_CN,resloc="./Results/stat_results/stat_soilCN/",nametag="soilCN",numbin=10)
```
<!--****DAN: DAN suspects a bug in the code that generates this fig. because the red dot should appear outside the x's iff the text > 999 (or so,mething like that) appears in the bin, also check make_table_stat_fn r chunk-->

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/stat_results/stat_soilCN/soilCN_bivfunctionplot.pdf}
\caption[Testing non-parametric statistics for soilCN data]{Nonparametric tests for tail dependence and other deviations from a normal copula for \textbf{soil C and N data}. As described in \nameref{MT-Methods}, each statistic was computed on the data using the ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (red cross), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (blue and green cross show 0.025 and 0.975 quantiles of these results).  When red cross was above (or below) the blue and green cross, text at the top of plots indicates the actual statistics was greater than (or less than) by those number of surrogate values. When $\cor$ values (respectively, $\Ps$ or $\Dsq$ values) were greater than surrogates, it means dependence in that part of the distributions was stronger than (respectively, stronger than or weaker than for $\Ps$ or $\Dsq$) expected from a normal-copula null hypothesis. \label{fig_soilCN_nonparam}}
\end{center}
\end{figure}

<!--Now make and display a table, this one about asymmetry of tail dependence-->
```{r make_table_stat_fn, echo=F}

fractxt<-function(fracval,numsurrog){
  ptxt<-''
  if (fracval>.5*numsurrog){                        # ?DCR why 0.5 factor?
    ptxt<-paste(">",fracval,sep='')
  } 
  if (fracval<=.5*numsurrog){
    ptxt<-paste("<",numsurrog-fracval,sep='')
  }
  return(ptxt)
}

make_table_stat_fn<-function(data){
  
 #atdres<-data.frame(Statistic=c("$\\cor_{0,0.1}-\\cor_{0.9,1}$",
 #                               "$\\Ps_{0,0.1}-\\Ps_{0.9,1}$",
 #                               "$\\Dsq_{0.9,1}-\\Dsq_{0,0.1}$"),
 atdres<-data.frame(Statistic=c("$\\cor_\\text{first slice}-\\cor_\\text{last slice}$",
                               "$\\Ps_\\text{first slice}-\\Ps_\\text{last slice}$",
                                "$\\Dsq_\\text{last slice}-\\Dsq_\\text{first slice}$"),
                   Kendall=rep("",3),
                   Spearman=rep("",3),stringsAsFactors = F)
 
 atdres[1,2]<-fractxt(data$corlmcoru_frac_K,numsurrog = data$numsurrog_success_K)
 atdres[1,3]<-fractxt(data$corlmcoru_frac_S,numsurrog = data$numsurrog_success_S)
 atdres[2,2]<-fractxt(data$PlmPu_frac_K,numsurrog = data$numsurrog_success_K)
 atdres[2,3]<-fractxt(data$PlmPu_frac_S,numsurrog = data$numsurrog_success_S)
 atdres[3,2]<-fractxt(data$D2umD2l_frac_K,numsurrog = data$numsurrog_success_K)
 atdres[3,3]<-fractxt(data$D2umD2l_frac_S,numsurrog = data$numsurrog_success_S)

 return(atdres)
  
}
```


```{r tab_soilCN_asym,echo=F,results="markup"}
#knitr::opts_knit$set(kable.force.latex = TRUE)
tab_soilCN_asym<-make_table_stat_fn(data=stat_soilCN_ga)
knitr::kable(tab_soilCN_asym, booktabs = T, 
             format = "latex",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption = "**Soil CN data set results** for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis. Three statistics are listed in the left column that measured asymmetry of tail dependence by comparing the distribution ranges $0-0.1$ and $0.9-1$ (see \\nameref{MT-NPA}). One thousand Kendall-preserving and 1000 Spearman-preserving surrogates with normal copula structure were created, and the same statistics were computed for the surrogates. A table entry $<N$ indicates the value of the given statistic on the data was less than its value on $N$ of the surrogates, so entries of the form $<X$ for $X$ equal to $975$ or above indicate that upper-tail dependence was significantly stronger than lower-tail dependence.\\label{tab_soilCN_asym}")
#kable_styling(, position = "float_left")
```

```{r bivmodselect_birds_BMR, echo=F, cache=T, cache.extra=list(seed,cop_b,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("OurBiCopSelect.R")
set.seed(seed)
BivMS_birds<-OurBiCopSelect(u1=cop_b[,1],u2=cop_b[,2],families=c(1,3:10,13:14,16:20),
                              level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,
                              gofnormal=F,status=F)
saveRDS(BivMS_birds,file="./Results/BMR_results/birds/BivMS_birds.RDS")
```

<!--Display model selection results for BMR:birds data in a table-->
```{r tab_bmr_birds_fit, echo=F, results='markup'}
h<-BivMS_birds$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
knitr::kable(h,
             format='latex',
             caption = "Fitting info for **birds' BMR dataset** . \\label{tab_bmr_birds_fit}",
             booktabs=T)
```

```{r stat_bmr_birds_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,cop_b,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed)
stat_birds_ga<-bivfunctionplot(v=cop_b,resloc="./Results/BMR_results/birds/",nametag="birds_numbin_10",numbin = 10)
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/BMR_results/birds/birds_numbin_10_bivfunctionplot.pdf}
\caption[Testing non-parametric statistics for birds' BMR data with $numbin=10$]{Nonparametric tests for tail dependence and other deviations from a normal copula for \textbf{birds' BMR data}. As described in \nameref{MT-Methods}, each statistic was computed on the data using the ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (red cross), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (blue and green cross show 0.025 and 0.975 quantiles of these results).  When red cross was outside blue and green cross, text at the top of plots indicates how many surrogate values the data value was less than or greater than. \label{fig_bmr_birds_nonparam}}
\end{center}
\end{figure}

```{r tab_bmr_birds_asym, echo=F, results="markup"}
tab_bmr_birds_asym<-make_table_stat_fn(data=stat_birds_ga)
knitr::kable(tab_bmr_birds_asym,
             format="latex",
             caption = "**Birds' BMR data set results** for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis \\label{tab_bmr_birds_asym}",
             booktabs=T)
```

```{r bivmodselect_mammals_BMR, echo=F, cache=T, cache.extra=list(seed,cop_m,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("OurBiCopSelect.R")
set.seed(seed)
BivMS_mammals<-OurBiCopSelect(u1=cop_m[,1],u2=cop_m[,2],families=c(1,3:10,13:14,16:20),
                              level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,
                              gofnormal=F,status=F)
saveRDS(BivMS_mammals,file="./Results/BMR_results/mammals/BivMS_mammals.RDS")
```


<!--Display model selection results for BMR:birds data in a table-->
```{r tab_bmr_mammals_fit, echo=F, results='markup'}
h<-BivMS_mammals$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
knitr::kable(h,
             format='latex',
             caption = "Fitting info for **mammals' BMR dataset** . \\label{tab_bmr_mammals_fit}",
             booktabs=T)
```

```{r stat_bmr_mammals_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,cop_m,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed)
stat_mammals_ga<-bivfunctionplot(v=cop_m,resloc="./Results/BMR_results/mammals/",nametag="mammals_numbin_10",numbin = 10)
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/BMR_results/mammals/mammals_numbin_10_bivfunctionplot.pdf}
\caption[Testing non-parametric statistics for mammals' BMR data with $numbin=10$]{Nonparametric tests for tail dependence and other deviations from a normal copula for \textbf{mammals' BMR data}. As described in \nameref{MT-Methods}, each statistic was computed on the data using the ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (red cross), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (blue and green cross show 0.025 and 0.975 quantiles of these results).  When red cross was outside blue and green cross, text at the top of plots indicates how many surrogate values the data value was less than or greater than. \label{fig_bmr_mammals_nonparam}}
\end{center}
\end{figure}

```{r tab_bmr_mammals_asym, echo=F, results="markup"}
tab_bmr_mammals_asym<-make_table_stat_fn(data=stat_mammals_ga)
knitr::kable(tab_bmr_mammals_asym,
             format="latex",
             caption = "**Mammals' BMR data set results** for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis \\label{tab_bmr_mammals_asym}",
             booktabs=T)
```

```{r bivmodselect_cc, echo=F, cache=T, cache.extra=list(seed,cop_HB_all_yr,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("OurBiCopSelect.R")
set.seed(seed)

BivMS_res_cc<-vector("list",length(cop_HB_all_yr))
names(BivMS_res_cc)<-names(cop_HB_all_yr)

for(i in 1:length(BivMS_res_cc)){
  BivMS_res_cc[[i]]<-OurBiCopSelect(u1=cop_HB_all_yr[[i]]$avg.H,u2=cop_HB_all_yr[[i]]$avg.Biomass,
                                    families=c(1,3:10,13:14,16:20),
                                    level=0.05,AICBIC="AIC",
                                    numBSsmall=100,pthresh=0.2,numBSlarge=1000,gofnormal=F,status=F)
}
saveRDS(BivMS_res_cc,file="./Results/Ceder_creek_results/BivMS_res_cc.RDS")
BivMS_res_cc<-readRDS("./Results/Ceder_creek_results/BivMS_res_cc.RDS")
```

<!--Display model selection results for Ceder-creek data for year 2000 in a table-->
```{r tab_cc2000fit, echo=F, results='markup'}
h<-BivMS_res_cc$`2000`$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
knitr::kable(h,
             format='latex',
             caption = "Fitting info for **Ceder-creek dataset** for year 2000. \\label{tab_cc2000fit}",
             booktabs=T)
```

```{r stat_cc_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,cop_HB_all_yr,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed)

stat_cc_ga<-vector("list",length(cop_HB_all_yr))
names(stat_cc_ga)<-names(cop_HB_all_yr)

for(i in 1:length(stat_cc_ga)){
  temp<-bivfunctionplot(v=cop_HB_all_yr[[i]],
                             resloc="./Results/Ceder_creek_results/",
                             nametag=paste0(names(cop_HB_all_yr)[i],"cc_numbin_10",sep=""),
                             numbin = 10)
  stat_cc_ga[[i]]<-temp
}

saveRDS(stat_cc_ga,"./Results/Ceder_creek_results/stat_cc_ga.RDS")
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Ceder_creek_results/2000cc_numbin_10_bivfunctionplot.pdf}
\caption[Testing non-parametric statistics for Ceder-creek data with $numbin=10$ for year 2000]{Nonparametric tests for tail dependence and other deviations from a normal copula for \textbf{Ceder-creek data}. As described in \nameref{MT-Methods}, each statistic was computed on the data using the ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (red cross), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (blue and green cross show 0.025 and 0.975 quantiles of these results).  When red cross was outside blue and green cross, text at the top of plots indicates how many surrogate values the data value was less than or greater than. \label{fig_cc2000_nonparam}}
\end{center}
\end{figure}

```{r tab_cc_asym_2000, echo=F, results="markup"}
tab_cc_asym_2000<-make_table_stat_fn(data=stat_cc_ga$`2000`)
knitr::kable(tab_cc_asym_2000,
             format="latex",
             caption = "**Ceder-creek data set results** for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis on year 2000 \\label{tab_cc_asym_2000}",
             booktabs=T)
```


<!--Load the raw data-->
```{r read_aphid_data, echo=F}
source("aphid_data_calling.R")

# Aphid raw data for count
d0_count<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtscount141117.csv",header=F))
data_aphid_count<-d_allsp_data(d0_count)     
 
# Aphid raw data for first flight
d0_firstflight<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsfirstflight141117.csv",header=F))
data_aphid_ff<-d_allsp_data(d0_firstflight) 

# Aphid raw data for flight duration   
#d0_flightduration<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsflightduration141117.csv",header=F))

# Time series analysis aphids winter avg temp (here taken as -ve)
temp_aphid_raw<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidmonthlytempdata.csv",header = F))

temp_aphid<-vector("list",dim(temp_aphid_raw)[1])
names(temp_aphid)<-paste("loc",c(1:dim(temp_aphid_raw)[1]),sep="")

for(il in 1:length(temp_aphid)){
  
  s<-matrix(temp_aphid_raw[il,],36,12,byrow = T)
  rownames(s)<-c(1975:2010)
  colnames(s)<-c("jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec")
  
  temp_aphid[[il]]<-s
}

winter_avg_temp<-matrix(NA,11,35)
rownames(winter_avg_temp)<-paste("loc",c(1:dim(temp_aphid_raw)[1]),sep="")
colnames(winter_avg_temp)<-c(1976:2010)

for(il in 1:length(temp_aphid)){
  temploc<-temp_aphid[[il]]
  for(i in 2:dim(temploc)[1]){
    t<-c(temploc[i-1,12],temploc[i,1:3]) # previous yr dec to present year march averaging temp.
    winter_avg_temp[il,i-1]<-mean(t,na.rm = T)
  }
}

aphid_winter_neg_temp<-vector("list",11) #initializing
names(aphid_winter_neg_temp)<-rownames(winter_avg_temp)

for(i in 1:11){
  aphid_winter_neg_temp[[i]]<-data.frame(Year=c(1976:2010),Dat=-winter_avg_temp[i,])
}

temp_aphid<-list(aphid_winter_neg_temp)
names(temp_aphid)<-"aphid_winter_neg_temp"
saveRDS(temp_aphid,"./Results/temp_aphid_winter_neg_temp_avg_data.RDS")
```

```{r modelsel_and_npa_aphid_count_allsp, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"),mtime("NonParamStat.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

set.seed(seed)
library(parallel)
source("FittingCopula_selective_loc.R")
RES_all_sp_aphid_count<-mclapply(X=c(1:20),FUN=RES_single_sp,d_allsp=data_aphid_count,
                                 families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30,
                                 good_loc_given=F,good_loc=NA,mc.cores=3)
saveRDS(RES_all_sp_aphid_count,"./Results/fitting_results/RES_all_sp_aphid_count.RDS")

source("good_loclist.R")
source("NonParamStat.R")
resloc<-"./Results/stat_results/stat_aphid_count/"
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_count_allsp<-vector("list",20)

for(sp in 1:20){
  nm<-paste("sp_",sp,sep="")
  resloc2<-paste(resloc,nm,sep="")
   if (!dir.exists(resloc2)){
    dir.create(resloc2)
  }
  good_loc<-good_loclist(d_allsp=data_aphid_count,sp=sp,data_pt_thrs=30)
  
  temp<-multcall(d_allsp=data_aphid_count,sp=sp,lats=lats,longs=longs,
                 pfname=paste(resloc2,"/","Sp_",sp,sep=''),good_loc=good_loc)
  stat_aphid_count_allsp[[sp]]<-temp
}
saveRDS(stat_aphid_count_allsp,paste(resloc,file="stat_aphid_count_all_sp.RDS",sep=''))


summary_aphid_count_allsp<-as.data.frame(matrix(NA,nrow=20,ncol=8))
colnames(summary_aphid_count_allsp)<-c("species","#LTmUT>0","#LTmUT<0","val_LTmUT>0","val_LTmUT<0",
                                     "CorlmCoru_mean_CI","PlmPu_mean_CI","D2umD2l_mean_CI")

for(sp in c(1:20)){
  #cat("sp=",sp,"\n")
  summary_aphid_count_allsp$species[sp]<-sp
  LTmUT<-(RES_all_sp_aphid_count[[sp]]$LTdep_AICw - RES_all_sp_aphid_count[[sp]]$UTdep_AICw) 
  summary_aphid_count_allsp$`#LTmUT>0`[sp]<-sum(LTmUT>0,na.rm=T)
  summary_aphid_count_allsp$`#LTmUT<0`[sp]<-sum(LTmUT<0,na.rm=T)
  ind_LTmUT_pos<-which(LTmUT>0,arr.ind = T)
  summary_aphid_count_allsp$`val_LTmUT>0`[sp]<-sum(LTmUT[ind_LTmUT_pos])
  ind_LTmUT_neg<-which(LTmUT<0,arr.ind = T)
  summary_aphid_count_allsp$`val_LTmUT<0`[sp]<-sum(LTmUT[ind_LTmUT_neg])
  
  summary_aphid_count_allsp$CorlmCoru_mean_CI[sp]<-list(
    c(unname(round(stat_aphid_count_allsp[[sp]]$numericdf[9,c(2:4)],3))))
  summary_aphid_count_allsp$PlmPu_mean_CI[sp]<-list(
    c(unname(round(stat_aphid_count_allsp[[sp]]$numericdf[10,c(2:4)],3))))
  summary_aphid_count_allsp$D2umD2l_mean_CI[sp]<-list(
    c(unname(round(stat_aphid_count_allsp[[sp]]$numericdf[11,c(2:4)],3))))
}
saveRDS(summary_aphid_count_allsp,"./Results/summary_aphid_count_allsp.RDS")
```

<!--Do the model selection for aphid count data and then showing results in Tables-->
```{r RES_aphid_count, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file
set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_aphid_count<-RES_single_sp(d_allsp=data_aphid_count,sp=10,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30,
                               good_loc_given=F,good_loc=NA)
#cat(paste("stop-time: ",Sys.time(),"\n"))
resloc<-"./Results/fitting_results/"
saveRDS(RES_aphid_count,paste(resloc,file="AphidCopulaFit_selecloc_count_species_10.RDS",sep=""))
```

\newpage
```{r tab_count_bestcop, echo=F, results="markup"}
#library(dplyr)
#knitr::opts_knit$set(kable.force.latex = TRUE)
knitr::kable(RES_aphid_count$info_ord_copname[,,1], #longtable = T,
             format='latex',
             #caption.short = "Best-fitting copulas for each location pair from among those considered, according to AIC, for abundances of the green spruce aphid.",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for **abundances of the green spruce aphid**. Copulas 
considered were the normal, Clayton, Gumbel, Frank, Joe, BB1, BB6, BB7, BB8, survival Clayton, survival Gumbel, 
survival Joe, survival BB1, survival BB6, survival BB7, survival BB8 copulas. Abbreviations were given in \\nameref{MT-Methods}. NA occurs along the diagonal of the matrix because the diagonal represents a sampling location compared to itself.\\label{tab_count_bestcop}",
             booktabs=TRUE
             )#%>% # only with 'latex'/'html' format
 # kableExtra::kable_styling(latex_options = c("striped","HOLD_position"))
```


```{r tab_count_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$info_ord_AICw[,,1], 
             format='latex',
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for **abundances of the green spruce aphid**.\\label{tab_count_AICw}",
             booktabs=TRUE
             )
```

```{r tab_count_AICw_normal, echo=F, results='markup'}
source("normal_cop_AICw.R")
knitr::kable(normal_cop_AICw_matrix(r=RES_aphid_count),
             format='latex',
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for **abundances of the green spruce aphid**, for comparison with Table \\ref{tab_count_AICw}. \\label{tab_count_AICw_normal}",
             booktabs=TRUE
             )
```

```{r tab_count_p_CvM, echo=F, results='markup'}
knitr::kable(RES_aphid_count$gfc_p_CvM,
             format='latex',
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **abundances of the green spruce aphid**. Tests were based on bootstrapping as described in Methods.\\label{tab_count_p_CvM}",
             booktabs=TRUE
             )
```

```{r tab_count_p_KS, echo=F, results='markup'}
knitr::kable(RES_aphid_count$gfc_p_KS,
             format='latex',
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **abundances of the green spruce aphid**. Tests were based on bootstrapping as described in Methods.\\label{tab_count_p_KS}",
             booktabs=TRUE
             )
```

\newpage
```{r tab_count_LTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$LTdep_AICw,
             format='latex',
             caption = "Model-averaged lower tail dependence statistic for each location pair for **abundances of the green spruce aphid**.\\label{tab_count_LTdep_AICw}",
             booktabs=TRUE
             )
```

\newpage
```{r tab_count_UTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$UTdep_AICw,
             format='latex',
             caption = "Model averaged upper tail dependence statistic for each location pair for **abundances of the green spruce aphid**.\\label{tab_count_UTdep_AICw}",
             booktabs=TRUE
             )
```

\newpage
```{r tab_count_LTmUT, echo=F, results='markup'}
knitr::kable(RES_aphid_count$LTdep_AICw-RES_aphid_count$UTdep_AICw,
             digits = 5,
             format='latex',
             caption = "Model averaged lower tail dependence minus model averaged upper tail dependence statistic for each location pair for **abundances of the green spruce aphid**.\\label{tab_count_LTmUT}",
             booktabs=TRUE
             )
```

<!--Do the main computations for non-parametric analysis of aphid count data-->
```{r stat_aphid_count, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed) 
resloc<-"./Results/stat_results/stat_aphid_count/"

sp<-10
good_loc <- good_loclist(d_allsp=data_aphid_count,sp=sp,data_pt_thrs=30)
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_count<-multcall(d_allsp=data_aphid_count,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc)
saveRDS(stat_aphid_count,paste(resloc,file="stat_aphid_count_sp_10.RDS",sep='')) 
```

<!--Show the statistical results in a table-->
```{r tab_count_resamp,echo=F,results="markup"}
s<-stat_aphid_count$numericdf[,c(3,2,4)]
colnames(s)<-c("Lower 95\\% CI", "Mean", "Upper 95\\% CI")
rownames(s)<-c("Spearman","Kendall","$\\cor_l$","$\\cor_u$","$\\Ps_l$","$\\Ps_u$","$\\Dsq_l$","$\\Dsq_u$","$\\cor_l - \\cor_u$","$\\Ps_l - \\Ps_u$","$\\Dsq_u - \\Dsq_l$")
knitr::kable(s,
             format = "latex",
             caption = "Spatially averaged values of statistics and confidence intervals based on resampling for **abundances of the green spruce aphid**.\\label{tab_count_resamp}",
             booktabs=TRUE)
```

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_D2u-D2l_vs_D.pdf}
\caption[Non-parametric tail statistics results for green spruce aphid abundance data]{Non-parametric tail statistics results for green spruce aphid abundance data plotted against geographical distance ($D$) between two sampling locations. (A) Spearman correlation vs. $D$; (B) Kendall correlation vs. $D$; (C) $\cor_l$ vs. $D$; (D) $\cor_u$ vs. $D$; (E) $\Ps_l$ vs. $D$; (F) $\Ps_u$ vs. $D$; (G) $\Dsq_u$ vs. $D$; 
(H) $\Dsq_l$ vs. $D$; 
(I) $\cor_l-\cor_u$ vs. $D$, (J) $\Ps_l-\Ps_u$ vs. $D$, (K) $\Dsq_u-\Dsq_l$ vs. $D$ plotted for all 
pairs of locations. \label{fig_aphid_count}}
\end{center}
\end{figure}

```{r modelsel_and_npa_aphid_ff_allsp, echo=F, cache=T, cache.extra=list(seed,data_aphid_ff,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"),mtime("NonParamStat.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

set.seed(seed)
library(parallel)
source("FittingCopula_selective_loc.R")
RES_all_sp_aphid_ff<-mclapply(X=c(1:20),FUN=RES_single_sp,d_allsp=data_aphid_ff,
                                 families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30,
                                 good_loc_given=F,good_loc=NA,mc.cores=3)
saveRDS(RES_all_sp_aphid_ff,"./Results/fitting_results/RES_all_sp_aphid_ff.RDS")

source("good_loclist.R")
source("NonParamStat.R")
resloc<-"./Results/stat_results/stat_aphid_ff/"
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_ff_allsp<-vector("list",20)

for(sp in 1:20){
  nm<-paste("sp_",sp,sep="")
  resloc2<-paste(resloc,nm,sep="")
   if (!dir.exists(resloc2)){
    dir.create(resloc2)
  }
  good_loc<-good_loclist(d_allsp=data_aphid_ff,sp=sp,data_pt_thrs=30)
  
  temp<-multcall(d_allsp=data_aphid_ff,sp=sp,lats=lats,longs=longs,
                 pfname=paste(resloc2,"/","Sp_",sp,sep=''),good_loc=good_loc)
  stat_aphid_ff_allsp[[sp]]<-temp
}
saveRDS(stat_aphid_ff_allsp,paste(resloc,file="stat_aphid_ff_all_sp.RDS",sep=''))


summary_aphid_ff_allsp<-as.data.frame(matrix(NA,nrow=20,ncol=8))
colnames(summary_aphid_ff_allsp)<-c("species","#LTmUT>0","#LTmUT<0","val_LTmUT>0","val_LTmUT<0",
                                     "CorlmCoru_mean_CI","PlmPu_mean_CI","D2umD2l_mean_CI")

for(sp in c(1:20)){
  #cat("sp=",sp,"\n")
  summary_aphid_ff_allsp$species[sp]<-sp
  LTmUT<-(RES_all_sp_aphid_ff[[sp]]$LTdep_AICw - RES_all_sp_aphid_ff[[sp]]$UTdep_AICw) 
  summary_aphid_ff_allsp$`#LTmUT>0`[sp]<-sum(LTmUT>0,na.rm=T)
  summary_aphid_ff_allsp$`#LTmUT<0`[sp]<-sum(LTmUT<0,na.rm=T)
  ind_LTmUT_pos<-which(LTmUT>0,arr.ind = T)
  summary_aphid_ff_allsp$`val_LTmUT>0`[sp]<-sum(LTmUT[ind_LTmUT_pos])
  ind_LTmUT_neg<-which(LTmUT<0,arr.ind = T)
  summary_aphid_ff_allsp$`val_LTmUT<0`[sp]<-sum(LTmUT[ind_LTmUT_neg])
  
  summary_aphid_ff_allsp$CorlmCoru_mean_CI[sp]<-list(
    c(unname(round(stat_aphid_ff_allsp[[sp]]$numericdf[9,c(2:4)],3))))
  summary_aphid_ff_allsp$PlmPu_mean_CI[sp]<-list(
    c(unname(round(stat_aphid_ff_allsp[[sp]]$numericdf[10,c(2:4)],3))))
  summary_aphid_ff_allsp$D2umD2l_mean_CI[sp]<-list(
    c(unname(round(stat_aphid_ff_allsp[[sp]]$numericdf[11,c(2:4)],3))))
}
saveRDS(summary_aphid_ff_allsp,"./Results/summary_aphid_ff_allsp.RDS")
```

<!--Do the model selection for aphid ff data and then showing results in Tables-->
```{r RES_aphid_ff, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file
set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n"))
RES_aphid_ff<-RES_single_sp(d_allsp=data_aphid_ff,sp=11,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30,
                            good_loc_given=F,good_loc=NA)
#cat(paste("stop-time: ",Sys.time(),"\n")) 
resloc<-"./Results/fitting_results/"
saveRDS(RES_aphid_ff,paste(resloc,file="AphidCopulaFit_selecloc_firstflight_species_11.RDS",sep=""))
```

```{r tab_ff_bestcop, echo=F, results="markup"}
knitr::kable(RES_aphid_ff$info_ord_copname[,,1], #longtable = T,
             format='latex',
             #caption.short = "Best-fitting copulas for each location pair from among those considered, according to AIC, for first flight data for the leaf-curling plum aphid.",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for **first flight data for the leaf-curling plum aphid**. Copulas considered were as in Table \\ref{tab_count_bestcop}, with abbreviations given in \\nameref{MT-Methods}. NA occurs along the diagonal of the matrix because the diagonal represents a sampling location compared to itself.  \\label{tab_ff_bestcop}",
             booktabs=TRUE
             )
```

```{r tab_ff_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$info_ord_AICw[,,1], 
             format='latex',
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_AICw}",
             booktabs=TRUE
             )
```

\newpage
```{r tab_ff_AICw_normal, echo=F, results='markup'}
source("normal_cop_AICw.R")
knitr::kable(normal_cop_AICw_matrix(r=RES_aphid_ff),
             format='latex',
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for **first flight data for the leaf-curlung plum aphid**, for comparison with Table \\ref{tab_ff_AICw}.\\label{tab_ff_AICw_normal}",
             booktabs=TRUE
             )
```

```{r tab_ff_p_CvM, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$gfc_p_CvM,
             format='latex',
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **first flight data for the leaf-curling plum aphid**. Tests were based on bootstrapping as described in Methods.\\label{tab_ff_p_CvM}",
             booktabs=TRUE
             )
```

```{r tab_ff_p_KS, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$gfc_p_KS,
             format='latex',
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **first flight data for the leaf-curling plum aphid**. Tests were based on bootstrapping as described in Methods.\\label{tab_ff_p_KS}",
             booktabs=TRUE
             )
```

```{r tab_ff_LTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$LTdep_AICw,
             format='latex',
             caption = "Model-averaged lower tail dependence statistic for each location pair for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_LTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_ff_UTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$UTdep_AICw,
             format='latex',
             caption = "Model-averaged upper tail dependence statistic for each location pair for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_UTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_ff_LTmUT, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$LTdep_AICw-RES_aphid_ff$UTdep_AICw,
             digits = 5,
             format='latex',
             caption = "Model averaged lower tail dependence minus model averaged upper tail dependence statistic for each location pair for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_LTmUT}",
             booktabs=TRUE
             )
```

<!--Do the main computations for non-parametric analysis of aphid ff data-->
```{r stat_aphid_ff, echo=F, cache=T,  cache.extra=list(seed,data_aphid_ff,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed)
resloc<-"./Results/stat_results/stat_aphid_ff/"

sp<-11
good_loc<-good_loclist(d_allsp=data_aphid_ff,sp=sp,data_pt_thrs=30)
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_ff<-multcall(d_allsp=data_aphid_ff,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc) 
saveRDS(stat_aphid_ff,paste(resloc,file="stat_aphid_ff_sp_11.RDS",sep='')) 
```

<!--display the main statistical results in a table-->
```{r tab_ff_resamp,echo=F,results="markup"}
s<-stat_aphid_ff$numericdf[,c(3,2,4)]
colnames(s)<-c("Lower 95\\% CI", "Mean", "Upper 95\\% CI")
rownames(s)<-c("Spearman","Kendall","$\\cor_l$","$\\cor_u$","$\\Ps_l$","$\\Ps_u$","$\\Dsq_l$","$\\Dsq_u$","$\\cor_l - \\cor_u$","$\\Ps_l - \\Ps_u$","$\\Dsq_u - \\Dsq_l$")
knitr::kable(s,
             format = "latex",
             caption = "Spatially averaged values of statistics and confidence intervals based on resampling for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_resamp}",
             booktabs=TRUE)
```

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_D2u-D2l_vs_D.pdf}
\caption[Non-parametric tail statistics results for leaf-curling plum aphid's first flight date data]{Non-parametric tail statistics results for leaf-curling plum aphid's first flight date data plotted against geographical distance $(D)$ between two sampling locations. (A) Spearman correlation vs. $D$, (B) Kendall correlation vs. $D$, (C) $\cor_l$ vs. $D$, (D) $\cor_u$ vs. $D$; (E) $\Ps_l$ vs. $D$; (F) $\Ps_u$ vs. $D$; (G) $\Dsq_u$ vs. $D$; (H) $\Dsq_l$ vs. $D$; (I) $\cor_l-\cor_u$ vs. $D$; (J) $\Ps_l-\Ps_u$ vs. $D$; (K) $\Dsq_u-\Dsq_l$ vs. $D$ plotted for all pairs of locations. \label{fig_aphid_ff}}
\end{center}
\end{figure}

<!--
\newpage
## Results: abundance data for *Ceratium furca* in UK seas \label{Ex_pns}
### Model selection approach \label{Ex_pns_Model_selection}
### Non-parametric analysis of tail dependence  \label{Ex_pns_NPA}
                          ----moved to Paper.Rmd----
-->

<!--Load the data-->
```{r read_plankton_north_sea_data, echo=F}
source("plankton_north_sea_data_calling.R")
d0_plankton_north_sea<-as.matrix(read.csv("./Data/Plankton_North_Sea_data/planktontimeseries201117_4.csv",header=F))
data_plankton_north_sea<-d_allsp_data_plankton_north_sea(d0_plankton_north_sea)
``` 

```{r modelsel_and_npa_pns_allsp, echo=F, cache=T, cache.extra=list(seed,data_plankton_north_sea,longs_pns,lats_pns,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"),mtime("NonParamStat.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

set.seed(seed)
library(parallel)
source("FittingCopula_selective_loc.R")
RES_all_sp_pns<-mclapply(X=c(1:22),FUN=RES_single_sp,d_allsp=data_plankton_north_sea,
                              families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=45,
                              good_loc_given=F,good_loc=NA,mc.cores=3)
saveRDS(RES_all_sp_pns,"./Results/fitting_results/RES_all_sp_pns.RDS")

source("good_loclist.R")
source("NonParamStat.R")
resloc<-"./Results/stat_results/stat_plankton_north_sea/"

stat_plankton_north_sea_allsp<-vector("list",22)

for(sp in 1:22){
  nm<-paste("sp_",sp,sep="")
  resloc2<-paste(resloc,nm,sep="")
   if (!dir.exists(resloc2)){
    dir.create(resloc2)
  }
  good_loc<-good_loclist(d_allsp=data_plankton_north_sea,sp=sp,data_pt_thrs=45)
  
  temp<-multcall(d_allsp=data_plankton_north_sea,sp=sp,lats=lats_pns,longs=longs_pns,
                                      pfname=paste(resloc2,"/","Sp_",sp,sep=''),good_loc=good_loc)
  stat_plankton_north_sea_allsp[[sp]]<-temp
}
saveRDS(stat_plankton_north_sea_allsp,paste(resloc,file="stat_plankton_north_sea_allsp.RDS",sep=''))


summary_pns_allsp<-as.data.frame(matrix(NA,nrow=22,ncol=8))
colnames(summary_pns_allsp)<-c("species","#LTmUT>0","#LTmUT<0","val_LTmUT>0","val_LTmUT<0",
                                     "CorlmCoru_mean_CI","PlmPu_mean_CI","D2umD2l_mean_CI")

for(sp in c(1:22)){
  #cat("sp=",sp,"\n")
  summary_pns_allsp$species[sp]<-sp
  LTmUT<-(RES_all_sp_pns[[sp]]$LTdep_AICw - RES_all_sp_pns[[sp]]$UTdep_AICw) 
  summary_pns_allsp$`#LTmUT>0`[sp]<-sum(LTmUT>0,na.rm=T)
  summary_pns_allsp$`#LTmUT<0`[sp]<-sum(LTmUT<0,na.rm=T)
  ind_LTmUT_pos<-which(LTmUT>0,arr.ind = T)
  summary_pns_allsp$`val_LTmUT>0`[sp]<-sum(LTmUT[ind_LTmUT_pos])
  ind_LTmUT_neg<-which(LTmUT<0,arr.ind = T)
  summary_pns_allsp$`val_LTmUT<0`[sp]<-sum(LTmUT[ind_LTmUT_neg])
  
  summary_pns_allsp$CorlmCoru_mean_CI[sp]<-list(
    c(unname(round(stat_plankton_north_sea_allsp[[sp]]$numericdf[9,c(2:4)],3))))
  summary_pns_allsp$PlmPu_mean_CI[sp]<-list(
    c(unname(round(stat_plankton_north_sea_allsp[[sp]]$numericdf[10,c(2:4)],3))))
  summary_pns_allsp$D2umD2l_mean_CI[sp]<-list(
    c(unname(round(stat_plankton_north_sea_allsp[[sp]]$numericdf[11,c(2:4)],3))))
}
saveRDS(summary_pns_allsp,"./Results/summary_pns_allsp.RDS")
```

<!--Do the model selection for plankton data and then showing results in Tables-->
```{r RES_plankton_north_sea, echo=F, cache=T, results="hide", cache.extra=list(seed,data_plankton_north_sea,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file

set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_plankton_north_sea<-RES_single_sp(d_allsp=data_plankton_north_sea,sp=16,families=c(1,3:10,13,14,16:20),level=0.05,
                                      data_pt_thrs=45,good_loc_given=F,good_loc=NA)
#cat(paste("stop-time: ",Sys.time(),"\n"))    
resloc<-"./Results/fitting_results/"
saveRDS(RES_plankton_north_sea,paste(resloc,file="Plankton_North_Sea_CopulaFit_selecloc_species_16.RDS",sep=""))
```

```{r tab_pns_bestcop, echo=F, results="markup"}
knitr::kable(RES_plankton_north_sea$info_ord_copname[,,1], #longtable=T,
             format='latex', 
             #caption.short = "Best-fitting copulas for each location pair from among those considered, according to AIC, for abundance data for \\textit{Ceratium furca} in UK seas.",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for **abundance data for \\textit{Ceratium furca} in UK seas**. See \\nameref{MT-Methods} for copula abbreviations. NA occurs along the diagonal because diagonal entries represent a sampling location compared to itself.\\label{tab_pns_bestcop}",
             booktabs=TRUE
             )
```

```{r tab_pns_AICw,echo=F,results="markup"}
h<-RES_plankton_north_sea$info_ord_AICw[,,1]
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_AICw}",
             booktabs=TRUE)
```

```{r tab_pns_AICw_normal,echo=F,results="markup"}
source("normal_cop_AICw.R")
h<-normal_cop_AICw_matrix(r=RES_plankton_north_sea)
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_AICw_normal}",
             booktabs=TRUE)
```

```{r tab_pns_p_CvM,echo=F,results="markup"}
h<-RES_plankton_north_sea$gfc_p_CvM
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **abundance data for *Ceratium furca* in UK seas**. Tests were based on bootstrapping as described in Methods.\\label{tab_pns_p_CvM}",
             booktabs=TRUE)
```

```{r tab_pns_p_KS,echo=F,results="markup"}
h<-RES_plankton_north_sea$gfc_p_KS
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of
the goodness of fit of the lowest-AIC copula family for each pair of
locations for **abundance data for *Ceratium furca* in UK seas**. Tests
were based on bootstrapping as described in Methods.\\label{tab_pns_p_KS}",
             booktabs=TRUE)
```

```{r tab_pns_LTdep_AICw,echo=F,results="markup"}
h<-RES_plankton_north_sea$LTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "Model-averaged lower tail dependence statistic for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_LTdep_AICw}",
             booktabs=TRUE)
```

```{r tab_pns_UTdep_AICw,echo=F,results="markup"}
h<-RES_plankton_north_sea$UTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "Model-averaged upper tail dependence statistic for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_UTdep_AICw}",
             booktabs=TRUE)
```

```{r tab_pns_LTmUT,echo=F,results="markup"}
h<-RES_plankton_north_sea$LTdep_AICw-RES_plankton_north_sea$UTdep_AICw
h[is.nan(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "Model averaged lower tail dependence minus model
averaged upper tail dependence statistic for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_LTmUT}",
             booktabs=TRUE)
```

<!--Do the main computations for non-parametric analysis of plankton data-->
```{r stat_plankton_north_sea, echo=F, cache=T, cache=T,  cache.extra=list(seed,data_plankton_north_sea,longs_pns,lats_pns,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed)
resloc<-"./Results/stat_results/stat_plankton_north_sea/"

sp<-16
good_loc<-good_loclist(d_allsp=data_plankton_north_sea,sp=sp,data_pt_thrs=45)

stat_plankton_north_sea<-multcall(d_allsp=data_plankton_north_sea,sp=sp,lats=lats_pns,longs=longs_pns,
                                  pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc) 
saveRDS(stat_plankton_north_sea,paste(resloc,file="stat_plankton_north_sea_sp_16.RDS",sep=''))
```

<!--display the main statistical results in a table-->
```{r tab_pns_resamp,echo=F,results="markup"}
s<-stat_plankton_north_sea$numericdf[,c(3,2,4)]
colnames(s)<-c("Lower 95\\% CI", "Mean", "Upper 95\\% CI")
rownames(s)<-c("Spearman","Kendall","$\\cor_l$","$\\cor_u$","$\\Ps_l$","$\\Ps_u$","$\\Dsq_l$","$\\Dsq_u$","$\\cor_l - \\cor_u$","$\\Ps_l - \\Ps_u$","$\\Dsq_u - \\Dsq_l$")
knitr::kable(s,
             format = "latex",
             caption = "Spatially averaged values of statistics and confidence intervals based on resampling for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_resamp}",
             booktabs=TRUE)
```

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_D2u-D2l_vs_D.pdf}
\caption[Non-parametric tail statistics results for \textit{Ceratium furca} abundance data]{Non-parametric tail statistics results for \textit{Ceratium furca} abundance data plotted against geographical distance $(D)$ between two sampling locations. (A) Spearman correlation vs. $D$, (B) Kendall correlation vs. $D$, (C) $\cor_l$ vs. $D$, (D) $\cor_u$ vs. $D$; (E) $\Ps_l$ vs. $D$; (F) $\Ps_u$ vs. $D$; (G) $\Dsq_u$ vs. $D$; (H) $\Dsq_l$ vs. $D$; (I) $\cor_l-\cor_u$ vs. $D$; (J) $\Ps_l-\Ps_u$ vs. $D$; (K) $\Dsq_u-\Dsq_l$ vs. $D$ plotted for all pairs of locations. \label{fig_pns}}
\end{center}
\end{figure}


<!--***DAN: stopped here 2018 04 07-->

<!--Load and format the data-->
```{r read_format_methane_data, echo=F}

methane_raw<-readRDS("./Data/Methane_data/methane_data_for_Shyamolina.rds")

myls <- vector("list", length = dim(methane_raw)[2]-1)
for(i in 2:dim(methane_raw)[2]){
  temp<-methane_raw[,c(1,i)]
  colnames(temp)<-c("Year","Dat")
  myls[[i-1]]<-temp
}
methane_data<-list(myls=myls)
``` 

<!--Do the main analysis-->
```{r RES_methane, echo=F, cache=T, results="hide", cache.extra=list(seed,methane_data,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file

set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_methane<-RES_single_sp(d_allsp=methane_data,sp=1,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=50,
                           good_loc_given=F,good_loc=NA)
#cat(paste("stop-time: ",Sys.time(),"\n"))    
resloc<-"./Results/fitting_results/"
saveRDS(RES_methane,paste(resloc,file="MethaneFluxFit_selecloc_data_pt_thrs_50.RDS",sep=""))
```

```{r tab_methane_bestcop, echo=F, results="markup"}
knitr::kable(RES_methane$info_ord_copname[,,1], #longtable=T,
             format='latex',
             #caption.short = "Best-fitting copulas for each location pair from among those considered, according to AIC, for methane-flux data.",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for **methane-flux data**. See \\nameref{MT-Methods} for copula abbreviations. NA occurs along the diagonal because diagonal entries represent a sampling location compared to itself.\\label{tab_methane_bestcop}",
             booktabs=TRUE
             )
```

```{r tab_methane_AICw,echo=F,results="markup"}
h<-RES_methane$info_ord_AICw[,,1]
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for **methane-flux data**.\\label{tab_methane_AICw}",
             booktabs=TRUE)
```

```{r tab_methane_AICw_normal,echo=F,results="markup"}
source("normal_cop_AICw.R")
h<-normal_cop_AICw_matrix(r=RES_methane)
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for **methane-flux data**.\\label{tab_methane_AICw_normal}",
             booktabs=TRUE)
```

```{r tab_methane_p_CvM,echo=F,results="markup"}
h<-RES_methane$gfc_p_CvM
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **methane-flux data**. Tests were based on bootstrapping as described in Methods.\\label{tab_methane_p_CvM}",
             booktabs=TRUE)
```

```{r tab_methane_p_KS,echo=F,results="markup"}
h<-RES_methane$gfc_p_KS
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of
the goodness of fit of the lowest-AIC copula family for each pair of
locations for **methane-flux data**. Tests were based on bootstrapping as described in Methods.\\label{tab_methane_p_KS}",
             booktabs=TRUE)
```

```{r tab_methane_LTdep_AICw,echo=F,results="markup"}
h<-RES_methane$LTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "Model-averaged lower tail dependence statistic for each location pair for **methane-flux data**.\\label{tab_methane_LTdep_AICw}",
             booktabs=TRUE)
```

```{r tab_methane_UTdep_AICw,echo=F,results="markup"}
h<-RES_methane$UTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "Model-averaged upper tail dependence statistic for each location pair for **methane-flux data**.\\label{tab_methane_UTdep_AICw}",
             booktabs=TRUE)
```

```{r tab_methane_LTmUT,echo=F,results="markup"}
h<-RES_methane$LTdep_AICw-RES_methane$UTdep_AICw
h[is.nan(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,
             caption = "Model averaged lower tail dependence minus model
averaged upper tail dependence statistic for each location pair for **methane-flux data**.\\label{tab_methane_LTmUT}",
             booktabs=TRUE)
```

<!--Do the main computations for non-parametric analysis of methane-flux data-->
```{r stat_methane, echo=F, cache=T, cache=T,  cache.extra=list(seed,methane_data,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed)
resloc<-"./Results/stat_results/stat_methane/"

data_pt_thrs<-50
good_loc <- good_loclist(d_allsp=methane_data,sp=1,data_pt_thrs=data_pt_thrs)

latlon<-readRDS("./Data/Methane_data/chamberLocations.rds")
chamber_name<-colnames(methane_raw[,c(2:dim(methane_raw)[2])])
ndim<-length(chamber_name)

latlon_arranged<-data.frame(chamber_name=chamber_name,lat=NA*numeric(ndim),lon=NA*numeric(ndim))
for(i in 1:ndim){
  if (chamber_name[i] %in% latlon$chamber){
    ind<-which(latlon$chamber==chamber_name[i])
    latlon_arranged[i,2:3]<-unname(latlon[ind,2:3])
  }
}

stat_methane<-multcall(d_allsp=methane_data,sp=1,lats=latlon_arranged$lat,longs=latlon_arranged$lon,
                           pfname=paste(resloc,"data_pt_thrs",data_pt_thrs,sep=''),good_loc=good_loc)

saveRDS(stat_methane,paste(resloc,file="stat_methane.RDS",sep='')) 
```

```{r read_stat_methane,echo=F}
stat_methane<-readRDS("./Results/stat_results/stat_methane/stat_methane.RDS")
```

\newpage
<!--display the main statistical results in a table-->
```{r tab_methane_resamp,echo=F,results="markup"}
s<-stat_methane$numericdf[,c(3,2,4)]
colnames(s)<-c("Lower 95\\% CI", "Mean", "Upper 95\\% CI")
rownames(s)<-c("Spearman","Kendall","$\\cor_l$","$\\cor_u$","$\\Ps_l$","$\\Ps_u$","$\\Dsq_l$","$\\Dsq_u$","$\\cor_l - \\cor_u$","$\\Ps_l - \\Ps_u$","$\\Dsq_u - \\Dsq_l$")
knitr::kable(s,
             format = "latex",
             caption = "Spatially averaged values of statistics and confidence intervals based on resampling for **methane-flux data**.\\label{tab_methane_resamp}",
             booktabs=TRUE)
```

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_D2u-D2l_vs_D.pdf}
\caption[Non-parametric tail statistics results for methane-flux data]{Non-parametric tail statistics results for methane-flux data plotted against geographical distance $(D)$ between two sampling locations. (A) Spearman correlation vs. $D$, (B) Kendall correlation vs. $D$, (C) $\cor_l$ vs. $D$, (D) $\cor_u$ vs. $D$; (E) $\Ps_l$ vs. $D$; (F) $\Ps_u$ vs. $D$; (G) $\Dsq_u$ vs. $D$; (H) $\Dsq_l$ vs. $D$; (I) $\cor_l-\cor_u$ vs. $D$; (J) $\Ps_l-\Ps_u$ vs. $D$; (K) $\Dsq_u-\Dsq_l$ vs. $D$ plotted for all pairs of locations. \label{fig_methane}}
\end{center}
\end{figure}

```{r bivar_tab_summary_fn,echo=F}
bivar_tab_summary_fn<-function(r,rs){
  
  m<-matrix(NA,1,10)
  colnames(m)<-c("p.Independence.test","minimumAIC.bestfit.copula","Bestfit.copula.AICw",
                 "Normal.copula.AICw","p.CvM","p.KS",
                 "LT.model.avg","UT.model.avg","(LT-UT).model.avg",
                 "Rank.(Pl-Pu)")
  m<-as.data.frame(m)
  
  m$p.Independence.test<-round(r$IndepTestRes,3)
  m$minimumAIC.bestfit.copula<-r$InfCritRes$copname[which.min(r$InfCritRes$AIC)]
  m$Bestfit.copula.AICw<-round(max(r$InfCritRes$AICw),3)
  m$Normal.copula.AICw<-round(r$InfCritRes$AICw[1],3)
  m$p.CvM<-r$GofRes_CvM
  m$p.KS<-r$GofRes_KS
  m$LT.model.avg<-round(r$relLTdep_AICw,3)
  m$UT.model.avg<-round(r$relUTdep_AICw,3)
  m$`(LT-UT).model.avg`<-m$LT.model.avg-m$UT.model.avg
  m$`Rank.(Pl-Pu)`<-rs$Rank_PlmPu_K
  mt<-as.data.frame(t(m))
  return(mt)
  
}
#----------------------------------
#calling the above function on bivariable datasets
m1<-bivar_tab_summary_fn(r=BivMS_res_Loecke,rs=stat_soilCN_ga)
m2<-bivar_tab_summary_fn(r=BivMS_birds,rs=stat_birds_ga)
m3<-bivar_tab_summary_fn(r=BivMS_mammals,rs=stat_mammals_ga)
m4<-bivar_tab_summary_fn(r=BivMS_res_cc$`2000`,rs=stat_cc_ga$`2000`)
tab_bivar_summary<-cbind(m1,m2,m3,m4)
colnames(tab_bivar_summary)<-c("SoilCN","Birds' BMR","Mammals' BMR","Ceder-creek")
saveRDS(tab_bivar_summary,"./Results/tab_bivar_summary.RDS")
```

```{r multivar_tab_summary_fn,echo=F}
source("normal_cop_AICw.R")

multivar_tab_summary_fn<-function(r,rs){
  
  m<-matrix(NA,1,17)
  colnames(m)<-c("num.pairs","num.non-indep","num.non-N",
                 "Avg.best.AICw","Avg.N.AICw","num.good.fit",
                 "0.025-CI.LT","0.975-CI.LT","0.025-CI.UT","0.975-CI.UT",
                 "percent.LT-UT>0",
                 "0.025-CI.Pl","0.975-CI-Pl","0.025-CI.Pu","0.975-CI.Pu","0.025-CI.Pl-Pu","0.975-CI.Pl-Pu")
  m<-as.data.frame(m)
  
  normal_AICw<-normal_cop_AICw_matrix(r=r)
  
  d<-dim(r$gfc_numBS)[1]
  m$num.pairs<-(d^2)-d 
  m$`num.non-indep`<- (d^2)-d-2*(r$num_indep_loc_pair+r$num_neg_cor_loc_pair)
  m$`num.non-N`<-sum(r$info_ord_copcode[,,1]!=1,na.rm = T)
  r$info_ord_AICw[r$info_ord_AICw==Inf] <- NaN
  m$Avg.best.AICw<-round(mean(r$info_ord_AICw[,,1],na.rm = T),3)
  normal_AICw[normal_AICw==Inf]<-NaN
  m$Avg.N.AICw<-round(mean(normal_AICw,na.rm=T),3)
  temp<-which((r$gfc_p_CvM>0.01) & (r$gfc_p_KS>0.01),arr.ind=T)
  m$num.good.fit<-dim(temp)[1]
  t<-r$LTdep_AICw[is.finite(r$LTdep_AICw)]
  CI_LT<-unname(quantile(t,probs=c(0.025,0.975),na.rm = T))
  m$`0.025-CI.LT`<-round(CI_LT[1],3)
  m$`0.975-CI.LT`<-round(CI_LT[2],3)
  t<-r$UTdep_AICw[is.finite(r$UTdep_AICw)]
  CI_UT<-unname(quantile(t,probs=c(0.025,0.975),na.rm = T))
  m$`0.025-CI.UT`<-round(CI_UT[1],3)
  m$`0.975-CI.UT`<-round(CI_UT[2],3)
  m$`percent.LT-UT>0`<-round((sum(r$LTdep_AICw-r$UTdep_AICw>0,na.rm=T)/((d^2)-d-2*(r$num_indep_loc_pair+r$num_neg_cor_loc_pair)))*100,2)
  m$`0.025-CI.Pl`<-round(rs$numericdf[5,3],3)
  m$`0.975-CI-Pl`<-round(rs$numericdf[5,4],3)
  m$`0.025-CI.Pu`<-round(rs$numericdf[6,3],3)
  m$`0.975-CI.Pu`<-round(rs$numericdf[6,4],3)
  m$`0.025-CI.Pl-Pu`<-round(rs$numericdf[10,3],3)
  m$`0.975-CI.Pl-Pu`<-list(round(rs$numericdf[10,4],3))
  #m$CI_Pl<-list(c(round(rs$numericdf[5,3],3),round(rs$numericdf[5,4],3)))
  #m$CI_Pu<-list(c(round(rs$numericdf[6,3],3),round(rs$numericdf[6,4],3)))
  #m$`CI_Pl-Pu`<-list(c(round(rs$numericdf[10,3],3),round(rs$numericdf[10,4],3)))
  
  mt<-as.data.frame(t(m))
  return(mt)
  
}
#----------------------------------
#calling the above function on 4 multivariable datasets
m1<-multivar_tab_summary_fn(r=RES_aphid_count,rs=stat_aphid_count)
m2<-multivar_tab_summary_fn(r=RES_aphid_ff,rs=stat_aphid_ff)
m3<-multivar_tab_summary_fn(r=RES_plankton_north_sea,rs=stat_plankton_north_sea)
m4<-multivar_tab_summary_fn(r=RES_methane,rs=stat_methane)
tab_multivar_summary<-cbind(m1,m2,m3,m4)
colnames(tab_multivar_summary)<-c("Green-spruce aphid_count","Leaf-plum curling aphid_firstflight","C. furca_count","Methane-flux")
saveRDS(tab_multivar_summary,"./Results/tab_multivar_summary.RDS")
```

```{r sample_plot_aphid_count_ff,echo=F,results="hide"}
#-------------------------------------------------------------------------------
# code to plot raw data and copula plot for aphid count @location pair (4,11)
# bestfit cop : SJ

d1<-data_aphid_count$`Green spruce aphid`[[4]]
d2<-data_aphid_count$`Green spruce aphid`[[11]]
pdf("./Results/Aphid_count_raw_loc_4_11.pdf",height = 8,width=8)
op<-par(mar=c(10,10, 0.2, 2.1),mgp=c(3,1,0))
plot(d1$Dat,d2$Dat,type="p",xlab="",
     ylab="Green-spruce aphid \ncount (loc. 11)",cex.lab=3.5,cex.axis=2.5)
mtext(paste("Green-spruce aphid \ncount (loc. 4)"),line=-38,cex=3.5)
par(op)
dev.off()

source("./vivj_matrix.R")
m<-vivj_matrix(d_allsp = data_aphid_count,sp=10,i=4,j=11)
pdf("./Results/Aphid_count_cop_loc_4_11.pdf",height = 8,width=8)
op<-par(mar=c(6,6, 0.2, 2.1),mgp=c(3,1,0))
plot(m[,1],m[,2],type="p",xlab="u",ylab="v",
     cex.lab=4,cex.axis=3,
     xlim=c(0,1),ylim=c(0,1),asp=1)
rect(0,0,1,1)
lines(c(0,1),c(0,1),type='l',col="grey")
par(op)
dev.off()

# code to plot raw data and copula plot for aphid ff @location pair (2,5)
# bestfit cop : J
d1<-data_aphid_ff$`Leaf-curling plum aphid`[[2]]
d2<-data_aphid_ff$`Leaf-curling plum aphid`[[5]]
pdf("./Results/Aphid_ff_raw_loc_2_5.pdf",height = 8,width=8)
op<-par(mar=c(10,10, 0.2, 2.1),mgp=c(3,1,0))
plot(d1$Dat,d2$Dat,type="p",xlab="",ylab="Leaf-plum curling's \nfirst-flight (loc. 5)",cex.lab=3.5,cex.axis=2.5)
mtext(paste("Leaf-plum curling's \nfirst-flight (loc. 2)"),line=-38,cex=3.5)
par(op)
dev.off()

m<-vivj_matrix(d_allsp = data_aphid_ff,sp=11,i=2,j=5)
pdf("./Results/Aphid_ff_cop_loc_2_5.pdf",height = 8,width=8)
op<-par(mar=c(6,6, 0.2, 2.1),mgp=c(3,1,0))
plot(m[,1],m[,2],type="p",xlab="u",ylab="v",
     cex.lab=4,cex.axis=3,
     xlim=c(0,1),ylim=c(0,1),asp=1)
rect(0,0,1,1)
lines(c(0,1),c(0,1),type='l',col="grey")
par(op)
dev.off()
```


```{r cause4copula_pGOF_500, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
pdf("./Results/Cause4copula_results/compare_params_pGOF_num_keep_last_500.pdf", width=8, height=3)
op<-par(mfrow=c(1,2))

Plotter_Cause4copula_GOF(N=5000,fcode=3,method = "spearman",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=13,method="spearman",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=4,method = "spearman",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=14,method="spearman",num_keep_last=500,BS=1000)

Plotter_Cause4copula_GOF(N=5000,fcode=3,method = "kendall",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=13,method="kendall",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=4,method = "kendall",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=14,method="kendall",num_keep_last=500,BS=1000)

#par(op)

op<-par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 1, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("top", c("noise copula,", "population copula,",  "Gof test : p-value(CvM),", "Gof test : p-value(KS)"), col = c("red","blue", "magenta", "green2"),
       cex = 0.9, pch = c(2, 6, 16, 16), xpd = TRUE, horiz = TRUE, inset = c(0,0),
       bty = "n") 
par(op)
dev.off()
```

```{r cause4copula_pGOF_2500, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------

pdf("./Results/Cause4copula_results/compare_params_pGOF_num_keep_last_2500.pdf", width=8, height=3)
op<-par(mfrow=c(1,2))

Plotter_Cause4copula_GOF(N=5000,fcode=3,method = "spearman",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=13,method="spearman",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=4,method = "spearman",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=14,method="spearman",num_keep_last=2500,BS=1000)

Plotter_Cause4copula_GOF(N=5000,fcode=3,method = "kendall",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=13,method="kendall",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=4,method = "kendall",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=14,method="kendall",num_keep_last=2500,BS=1000)

op<-par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 1, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("top", c("noise copula,", "population copula,",  "Gof test : p-value(CvM),", "Gof test : p-value(KS)"), col = c("red","blue", "magenta", "green2"),
       cex = 0.9, pch = c(2, 6, 16, 16), xpd = TRUE, horiz = TRUE, inset = c(0,0),
       bty = "n") 
par(op)
dev.off()
```

```{r cause4copula_stat, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
resloc<-"./Results/Cause4copula_results/"
if (!dir.exists(paste(resloc,"Cause4copula_stat_results",sep=""))){
  dir.create(paste(resloc,"Cause4copula_stat_results",sep=""))
}
resloc<-paste(resloc,"Cause4copula_stat_results/",sep="")

Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=3,method="spearman",lb=0,ub=0.1,num_keep_last=500,resloc=resloc)
                          
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=3,method="kendall",lb=0,ub=0.1,num_keep_last=500,resloc=resloc)
                          
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=13,method="spearman",lb=0,ub=0.1,num_keep_last=500,resloc=resloc)
                          
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=13,method="kendall",lb=0,ub=0.1,num_keep_last=500,resloc=resloc)                
```


\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Cause4copula_results/compare_params_pGOF_num_keep_last_2500.pdf}
\caption[Comparing noise-copula parameters and estimated population copula parameters with $2500$ sampling points]{Results of comparison between the parameters of environmental noise generated from a specific family of copula and estimated sample parameter (with some standard error) of the affected populations (Initially 5000 points are generated but we kept last \textbf{2500} points for both noise and population data for comparison). p-values $> 0.05$ (above horizontal dashed line) indicate good fit of population copula with same noise cpoula family. \label{fig_Cause4copula_params_GOF_2500}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_D2u-D2l_vs_Kendall's Tau.pdf}
\caption[Comparing correlations and non-parametric statistic between noise-copula (\textbf{Clayton}) and population copula for different \textbf{Kendall's Tau}]{Results of comparison between 3 types of correlation (i.e. Spearman, Kendall, Pearson) and 6 non-parametric stats ($\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_u$ and $\Dsq_l$) of environmental noise generated from lower tail dependent \textbf{Clayton} copula and of the affected populations for 9 equidistant \textbf{Kendall's Tau} values in a range (0.1 to 0.9) (Initially $5000$ points are generated but we kept last $500$ points for both noise and population data for comparison). p-values from paired t-test if $> 0.05$ (above horizontal purple line) indicates exactly same estimate between noise and population copulae. \label{fig_Cause4copula_C_kend}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Spearman_vs_Spearman's Rho.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Kendall_vs_Spearman's Rho.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Pearson_vs_Spearman's Rho.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Corl_vs_Spearman's Rho.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Clayton_Coru_vs_Spearman's Rho.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Survival Clayton_Corl-Coru_vs_Spearman's Rho.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Survival Clayton_Pl_vs_Spearman's Rho.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Survival Clayton_Pu_vs_Spearman's Rho.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Survival Clayton_Pl-Pu_vs_Spearman's Rho.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Survival Clayton_D2u_vs_Spearman's Rho.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Survival Clayton_D2l_vs_Spearman's Rho.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results/Survival Clayton_D2u-D2l_vs_Spearman's Rho.pdf}
\caption[Comparing correlations and non-parametric statistic between upper tail dependent noise-copula (\textbf{Survival Clayton}) and population copula for different \textbf{Spearman's Rho}]{Results of comparison between 3 types of correlation (i.e. Spearman, Kendall, Pearson) and 6 non-parametric stats ($\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_u$ and $\Dsq_l$) of environmental noise generated from upper tail dependent \textbf{Survival Clayton} copula and of the affected populations for 9 equidistant \textbf{Spearman's Rho} values in a range (0.1 to 0.9) (Initially $5000$ points are generated but we kept last $500$ points for both noise and population data for comparison). p-values from paired t-test if $> 0.05$ (above horizontal purple line) indicates exactly same estimate between noise and population copulae. \label{fig_Cause4copula_SC_spear}}
\end{center}
\end{figure}


```{r moran_effect_on_aphid_ff, echo=F, results="hide", cache=T, cache.extra=list(seed,temp_aphid,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
set.seed(seed)
source("FittingCopula_selective_loc.R")  # top most hierarchy source file


#cat(paste("start-time: ",Sys.time(),"\n"))
RES_temp_aphid<-RES_single_sp(d_allsp=temp_aphid,sp=1,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30,
                              good_loc_given=T,good_loc=c(2:11))
#cat(paste("stop-time: ",Sys.time(),"\n")) 
resloc<-"./Results/fitting_results/"
saveRDS(RES_temp_aphid,paste(resloc,file="AphidCopulaFit_selecloc_winter_neg_temp.RDS",sep=""))

LTmUT_temp<-(RES_temp_aphid$LTdep_AICw - RES_temp_aphid$UTdep_AICw)

sum(LTmUT_temp>0,na.rm = T)
sum(LTmUT_temp<0,na.rm = T) #66 out of 90 : suggests UT in leaf-plum curling aphids firstflight data (90 out of 90 UT)
```

<!--
```{r tab_temp_aphid_bestcop, echo=F, results="markup"}
knitr::kable(RES_temp_aphid$info_ord_copname[,,1], #longtable = T,
             format='latex',
             #caption.short = "Best-fitting copulas for each location pair from among those considered, according to AIC, for first flight data for the leaf-curling plum aphid.",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for **negative average winter temperature data (1958-2013)**. Copulas' abbreviations were given in \\nameref{MT-Methods}. NA occurs along the diagonal of the matrix because the diagonal represents a sampling location compared to itself.  \\label{tab_temp_aphid_bestcop}",
             booktabs=TRUE
             )
```

```{r tab_temp_aphid_AICw, echo=F, results='markup'}
knitr::kable(RES_temp_aphid$info_ord_AICw[,,1], 
             format='latex',
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for **negative average winter temperature data**.\\label{tab_temp_aphid_AICw}",
             booktabs=TRUE
             )
```

```{r tab_temp_aphid_AICw_normal, echo=F, results='markup'}
source("normal_cop_AICw.R")
knitr::kable(normal_cop_AICw_matrix(r=RES_temp_aphid),
             format='latex',
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for **negative average winter temperature data**, for comparison with Table \\ref{tab_ff_AICw}.\\label{tab_temp_aphid_AICw_normal}",
             booktabs=TRUE
             )
```

\newpage
```{r tab_temp_aphid_p_CvM, echo=F, results='markup'}
knitr::kable(RES_temp_aphid$gfc_p_CvM,
             format='latex',
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **negative average winter temperature data**. Tests were based on bootstrapping as described in Methods.\\label{tab_temp_aphid_p_CvM}",
             booktabs=TRUE
             )
```

\newpage
```{r tab_temp_aphid_p_KS, echo=F, results='markup'}
knitr::kable(RES_temp_aphid$gfc_p_KS,
             format='latex',
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **negative average winter temperature data**. Tests were based on bootstrapping as described in Methods.\\label{tab_temp_aphid_p_KS}",
             booktabs=TRUE
             )
```

\newpage
```{r tab_temp_aphid_LTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_temp_aphid$LTdep_AICw,
             format='latex',
             caption = "Model-averaged lower tail dependence statistic for each location pair for **negative average winter temperature data**.\\label{tab_temp_aphid_LTdep_AICw}",
             booktabs=TRUE
             )
```

\newpage
```{r tab_temp_aphid_UTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_temp_aphid$UTdep_AICw,
             format='latex',
             caption = "Model-averaged upper tail dependence statistic for each location pair for **negative average winter temperature data**.\\label{tab_temp_aphid_UTdep_AICw}",
             booktabs=TRUE
             )
```

\newpage
```{r tab_temp_aphid_LTmUT, echo=F, results='markup'}
knitr::kable(RES_temp_aphid$LTdep_AICw - RES_temp_aphid$UTdep_AICw,
             digits = 5,
             format='latex',
             caption = "Model averaged lower tail dependence minus model averaged upper tail dependence statistic for each location pair for **negative average winter temperature data**.\\label{tab_temp_aphid_LTmUT}",
             booktabs=TRUE
             )
```
-->
<!--# Cause of non-Normal copula structure : the Moran effect and copula structure in populations \label{Cause_Moran}-->

<!--
## Asymmetric sensitivity and copula structure in populations
           ----moved to Paper.Rmd----
-->

```{r asym_sens_b_variation, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"),mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
set.seed(seed)
#-----------------------------------------------------------------------------------
source("OurBiCopSelect.R")
source("bivfunctionplot.R")
source("asym_sensitivity.R")
#-----------------------------------------------------------------------------------
# This function takes 
# Input :
#       mg : global noise matrix (dim = N by 2)
#       ml : local noise matrix (dim = N by 2)
#       a : a number : local noise coeeficient
#       b : growth factor of pop
#       decrease : logical (controls the nature of global noise)
#       numkeep_last : number of points you want to keep for the pop matrix from the end
#       ploton : logical for optional plot

# Output :
#     a list of 4 pop matrices 
#                         1. (for b=+ve, decrease=F)
#                         2. (for b=+ve, decrease=T)
#                         3. (for b=-ve, decrease=F)
#                         4. (for b=-ve, decrease=T)

plotter_asym_sens_b_varn<-function(mg,ml,a,b,numkeep_last,ploton,resloc){
  
  pop_g<-Simulator_asym_sens(mg=mg,ml=ml,a=a,b=b,p0=c(0,0),decrease=F,numkeep_last=numkeep_last)
  pop_d_g<-Simulator_asym_sens(mg=mg,ml=ml,a=a,b=b,p0=c(0,0),decrease=T,numkeep_last=numkeep_last)
  
  if(ploton==T){
    pdf(paste0(resloc,"a_",a,"_b_",b,"_r_",r,"_asym_sens.pdf",sep=""),height=5,width=8)
    op<-par(mfrow=c(2,3),mar=c(4,4.2,1.5,1),mgp=c(2.5,0.6,0))
    #plot(pop[,1],pop[,2],col="red",main = bquote(beta ==.(beta)))
    pop<-pop_g$pop
    geps<-pop_g$g_noise
    plot(mg[,1],geps[,1],cex.lab=2,cex.axis=2,xlab=expression(epsilon),ylab=expression(paste(g[1])),main="location=1")
    plot(mg[,2],geps[,2],cex.lab=2,cex.axis=2,xlab=expression(epsilon),ylab=expression(paste(g[1])),main="location=2")
    plot(pop[,1],pop[,2],xlab=expression(paste(P[1])), ylab=expression(paste(P[2])),cex.lab=2,cex.axis=2)
    title(expression(paste("g = ",g[1]," , ")), adj=0.06,cex.main=1.5)
    mtext(paste("a = ",a,", b = ",b),side = 3, line=0.2, adj=0.9)
    
    pop_d<-pop_d_g$pop
    geps<-pop_d_g$g_noise
    plot(mg[,1],geps[,1],cex.lab=2,cex.axis=2,xlab=expression(epsilon),ylab=expression(paste(g[2])),main="location=1")
    plot(mg[,2],geps[,2],cex.lab=2,cex.axis=2,xlab=expression(epsilon),ylab=expression(paste(g[2])),main="location=2")
    plot(pop_d[,1],pop_d[,2],xlab=expression(paste(P[1])), ylab=expression(paste(P[2])),cex.lab=2,cex.axis=2)
    title(expression(paste("g = ",g[2]," , ")), adj=0.06,cex.main=1.5)
    mtext(paste("a = ",a,", b = ",b),side = 3, line=0.2, adj=0.9)
    
    par(op)
    dev.off()
  }
  
  return(list(pop=pop,
              pop_d=pop_d))
  
}
#----------------------------------------------------------
N<-10000
r<-0.8
a<-0.2
numkeep_last<-1000
temp<-get_noise_glob_loc_mat(N=N,r=r)
mg<-temp$mg
ml<-temp$ml

resloc<-"./Results/asym_sens_results/"
ans_b_0.1<-plotter_asym_sens_b_varn(mg=mg,ml=ml,a=a,b=0.1,numkeep_last=numkeep_last,ploton=T,resloc=resloc)
ans_b_neg0.1<-plotter_asym_sens_b_varn(mg=mg,ml=ml,a=a,b=-0.1,numkeep_last=numkeep_last,ploton=T,resloc=resloc)
ans_b_0.9<-plotter_asym_sens_b_varn(mg=mg,ml=ml,a=a,b=0.9,numkeep_last=numkeep_last,ploton=T,resloc=resloc)
ans_b_neg0.9<-plotter_asym_sens_b_varn(mg=mg,ml=ml,a=a,b=-0.9,numkeep_last=numkeep_last,ploton=T,resloc=resloc)

vlist_b_0.1_b_0.9<-c(ans_b_0.1,ans_b_neg0.1,ans_b_0.9,ans_b_neg0.9) # a list of 8 matrices

summary_stat<-as.data.frame(matrix(NA,7,8),stringsAsFactors = F) # Table for model selection summary
rownames(summary_stat)<-c("bestcop_AICw","N_AICw","relLTdep_AICw","relUTdep_AICw","p_CvM","p_KS","BS_success%")
#bg <- intToUtf8(0x03B2) 
cnm<-c("b_0.1_g~1~","b_0.1_g~2~","b_-0.1_g~1~","b_-0.1_g~2~","b_0.9_g~1~","b_0.9_g~2~","b_-0.9_g~1~","b_-0.9_g~2~")
#cname<-paste0(bg,cnm)
colnames(summary_stat)<-cnm

ms_asym_b_0.1_b_0.9<-vector(mode = "list", length = 8) # initializing list to store model selection results for all possible b variation
names(ms_asym_b_0.1_b_0.9)<-cnm

stat_npa_asym_b_0.1_b_0.9<-vector(mode = "list", length = 8) # initializing list to store NPA results for all possible b variation
names(stat_npa_asym_b_0.1_b_0.9)<-cnm

for(ic in c(1:8)){
  v<-vlist_b_0.1_b_0.9[[ic]]
  res<-OurBiCopSelect(u1=v[,1],u2=v[,2],families=c(1,3:10,13:14,16:20),level=0.05,
                      AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,
                      gofnormal=F,status=F)
  
  ms_asym_b_0.1_b_0.9[[ic]]<-res
  
  summary_stat[1,ic]<-max(res$InfCritRes$AICw)
  summary_stat[2,ic]<-res$InfCritRes$AICw[1]
  summary_stat[3,ic]<-res$relLTdep_AICw
  summary_stat[4,ic]<-res$relUTdep_AICw
  summary_stat[5,ic]<-res$GofRes_CvM
  summary_stat[6,ic]<-res$GofRes_KS
  summary_stat[7,ic]<-(res$Numboot_success/res$Numboot)*100
  
  stat_npa_asym_b_0.1_b_0.9[[ic]]<-bivfunctionplot(v=v,resloc="./Results/asym_sens_results/",nametag=cnm[ic],numbin=10)
  
}

saveRDS(summary_stat,"./Results/asym_sens_results/b_variation_summary_stat.RDS")
saveRDS(ms_asym_b_0.1_b_0.9,"./Results/asym_sens_results/ms_asym_b_0.1_b_0.9.RDS")
saveRDS(stat_npa_asym_b_0.1_b_0.9,"./Results/asym_sens_results/stat_npa_asym_b_0.1_b_0.9.RDS")
```


```{r tab_summary_stat_asym_sens,echo=F,results="markup"}
summary_stat<-summary_stat[,c(1:2)]
rownames(summary_stat)<-c("bestfit.copula.AICw","Normal.copula.AICw","LT.model.avg","UT.model.avg","p.CvM","p.KS","BS.success.percent")
knitr::kable(summary_stat, booktabs = T, 
             format = "latex",
             digits=3,
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption="summary of model selection results for asymmetric sensitivity : \\textbf{bestfit.copula.AICw} and \\textbf{Normal.copula.AICw} represent the AIC-weightage for best fit copula and Normal copula, \\textbf{LT.model.avg} and \\textbf{UT.model.avg} represent AIC-weight based model averaged lower and upper tail dependence respectively, \\textbf{p.CvM} and \\textbf{p.KS} are the p-values coming from goodness of fit test (Cramer-von Mises and Kolmogorov-Smirnov statistics based), \\textbf{BS.success.percent} percentage of successful bootstraps in goodness of fit test. Each column summarizes those statistics for each copula plotted in Fig. \\ref{MT-fig_ms_asym_b_0.1}.\\label{tab_summary_stat_asym_sens}")
```

```{r read_tab_stat_npa_asym,echo=F,results="asis"}
#knitr::opts_knit$set(kable.force.latex = TRUE)
tab_asym<-readRDS("./Results/asym_sens_results/stat_npa_asym_b_0.1_b_0.9.RDS")

#for(i in c(1:8)){
#  temp<-make_table_stat_fn(data=tab_asym[[i]])
#  temp2<-knitr::kable(temp, booktabs = T, 
#             format = "latex",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
#      caption =paste(cnm[i]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence."))
#  print(temp2)
#  cat("\\newpage")
#}
```


```{r tab_stat_npa_asym_1,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[1]])
knitr::kable(temp, booktabs = T, 
             format = "latex",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption ="A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_1}")
```

```{r tab_stat_npa_asym_2,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[2]])
knitr::kable(temp, booktabs = T, 
             format = "latex",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption ="A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_2}")
```

<!--
# Cause of non-Normal copula structure : Asymmetric sensitivity and copula structure in populations \label{Cause_asym_sens}
-->

```{r skewness_aphidcount_allsp_plot, echo=F, results="hide", warning=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

# For sp =1, sp=4 and sp=6 : kendall preserving surrogates gives warning : Error in ncsurrog: ncov is not positive semidefinite : you can see those msg by deleting results="hide" and warning=F option in r chunk

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

numsurrog<-10000

splist<-c(1:20)
skw_aphid_count_spearman<-as.data.frame(matrix(NA,nrow=length(splist),ncol=3))
colnames(skw_aphid_count_spearman)<-c("realskw","p_left","p_right")
rownames(skw_aphid_count_spearman)<-paste("sp",splist,sep="")
pdf("./Results/skewness_results/skewness_aphid_count/aphid_count_allsp_skewness_spearman.pdf",height=25,width=25)
op<-par(mfrow=c(4,5),mar=c(5,5,1,1),mgp=c(3,1,0))
cat("Now for spearman preserving surrogs : aphid count","\n")
for(i in splist){
  cat("sp=",i,"\n")
  loclist<-good_loclist(d_allsp=data_aphid_count,sp=i,data_pt_thrs=30)
  ans<-skewness_testing(ts_matrix=sp_data(sp=i,d_allsp=data_aphid_count),loclist=loclist,
                        numsurrog=numsurrog,
                        ploton=T,
                        corpres="spearman") 
  p_left<-sum(ans$surrogskw < ans$realskw)/numsurrog
  p_right<-sum(ans$surrogskw > ans$realskw)/numsurrog
  skw_aphid_count_spearman$realskw[i]<-ans$realskw
  skw_aphid_count_spearman$p_left[i]<-p_left
  skw_aphid_count_spearman$p_right[i]<-p_right
  mtext(paste0("sp = ",i,", p_left = ",p_left,", p_right = ",p_right),side=3,line=-0.5,col="navyblue",cex = 1)
}
par(op)
dev.off()
saveRDS(skw_aphid_count_spearman,"./Results/skewness_results/skewness_aphid_count/skw_aphid_count_spearman.RDS")

skw_aphid_count_kendall<-as.data.frame(matrix(NA,nrow=length(splist),ncol=3))
colnames(skw_aphid_count_kendall)<-c("realskw","p_left","p_right")
rownames(skw_aphid_count_kendall)<-paste("sp",splist,sep="")
pdf("./Results/skewness_results/skewness_aphid_count/aphid_count_allsp_skewness_kendall.pdf",height=25,width=25)
op<-par(mfrow=c(4,5),mar=c(5,5,1,1),mgp=c(3,1,0))
cat("Now for kendall preserving surrogs : aphid count","\n")
for(i in splist){
  cat("sp=",i,"\n")
  loclist<-good_loclist(d_allsp=data_aphid_count,sp=i,data_pt_thrs=30)
  ans<-skewness_testing(ts_matrix=sp_data(sp=i,d_allsp=data_aphid_count),loclist=loclist,
                        numsurrog=numsurrog,
                        ploton=T,
                        corpres="kendall") 
  p_left<-sum(ans$surrogskw < ans$realskw)/numsurrog
  p_right<-sum(ans$surrogskw > ans$realskw)/numsurrog
  skw_aphid_count_kendall$realskw[i]<-ans$realskw
  skw_aphid_count_kendall$p_left[i]<-p_left
  skw_aphid_count_kendall$p_right[i]<-p_right
  mtext(paste0("sp = ",i,", p_left = ",p_left,", p_right = ",p_right),side=3,line=-0.5,col="navyblue",cex = 1)
}
par(op)
dev.off()
saveRDS(skw_aphid_count_kendall,"./Results/skewness_results/skewness_aphid_count/skw_aphid_count_kendall.RDS")
```

```{r skewness_aphidff_allsp_plot, echo=F, results="hide", warning=F, cache=T, cache.extra=list(seed,data_aphid_ff,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

# For sp =12 and sp=16 : kendall preserving surrogates gives warning : Error in ncsurrog: ncov is not positive semidefinite : you can see those msg by deleting results="hide" and warning=F option in r chunk

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

numsurrog<-10000

splist<-c(1:20)
skw_aphid_ff_spearman<-as.data.frame(matrix(NA,nrow=length(splist),ncol=3))
colnames(skw_aphid_ff_spearman)<-c("realskw","p_left","p_right")
rownames(skw_aphid_ff_spearman)<-paste("sp",splist,sep="")
pdf("./Results/skewness_results/skewness_aphid_ff/aphid_ff_allsp_skewness_spearman.pdf",height=25,width=25)
op<-par(mfrow=c(4,5),mar=c(5,5,1,1),mgp=c(3,1,0))
cat("Now for spearman preserving surrogs : aphid ff","\n")
for(i in splist){
  cat("sp=",i,"\n")
  loclist<-good_loclist(d_allsp=data_aphid_ff,sp=i,data_pt_thrs=30)
  ans<-skewness_testing(ts_matrix=sp_data(sp=i,d_allsp=data_aphid_ff),loclist=loclist,
                        numsurrog=numsurrog,
                        ploton=T,
                        corpres="spearman") 
  p_left<-sum(ans$surrogskw < ans$realskw)/numsurrog
  p_right<-sum(ans$surrogskw > ans$realskw)/numsurrog
  skw_aphid_ff_spearman$realskw[i]<-ans$realskw
  skw_aphid_ff_spearman$p_left[i]<-p_left
  skw_aphid_ff_spearman$p_right[i]<-p_right
  mtext(paste0("sp = ",i,", p_left = ",p_left,", p_right = ",p_right),side=3,line=-0.5,col="navyblue",cex = 1)
}
par(op)
dev.off()
saveRDS(skw_aphid_ff_spearman,"./Results/skewness_results/skewness_aphid_ff/skw_aphid_ff_spearman.RDS")

skw_aphid_ff_kendall<-as.data.frame(matrix(NA,nrow=length(splist),ncol=3))
colnames(skw_aphid_ff_kendall)<-c("realskw","p_left","p_right")
rownames(skw_aphid_ff_kendall)<-paste("sp",splist,sep="")
pdf("./Results/skewness_results/skewness_aphid_ff/aphid_ff_allsp_skewness_kendall.pdf",height=25,width=25)
op<-par(mfrow=c(4,5),mar=c(5,5,1,1),mgp=c(3,1,0))
cat("Now for kendall preserving surrogs : aphid ff","\n")
for(i in splist){
  cat("sp=",i,"\n")
  loclist<-good_loclist(d_allsp=data_aphid_ff,sp=i,data_pt_thrs=30)
  ans<-skewness_testing(ts_matrix=sp_data(sp=i,d_allsp=data_aphid_ff),loclist=loclist,
                        numsurrog=numsurrog,
                        ploton=T,
                        corpres="kendall") 
  p_left<-sum(ans$surrogskw < ans$realskw)/numsurrog
  p_right<-sum(ans$surrogskw > ans$realskw)/numsurrog
  skw_aphid_ff_kendall$realskw[i]<-ans$realskw
  skw_aphid_ff_kendall$p_left[i]<-p_left
  skw_aphid_ff_kendall$p_right[i]<-p_right
  mtext(paste0("sp = ",i,", p_left = ",p_left,", p_right = ",p_right),side=3,line=-0.5,col="navyblue",cex = 1)
}
par(op)
dev.off()
saveRDS(skw_aphid_ff_kendall,"./Results/skewness_results/skewness_aphid_ff/skw_aphid_ff_kendall.RDS")
```

```{r skewness_plankton_allsp_plot, echo=F, results="hide", cache=T, cache.extra=list(seed,data_plankton_north_sea,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

# There is no error msg or warning coming from ncsurrog : ncov semidefinite matrix for any species with spearman
# or kendall preserving surrogates.

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

splist<-c(1:22)
skw_plankton_spearman<-as.data.frame(matrix(NA,nrow=length(splist),ncol=3))
colnames(skw_plankton_spearman)<-c("realskw","p_left","p_right")
rownames(skw_plankton_spearman)<-paste("sp",splist,sep="")
skw_plankton_kendall<-skw_plankton_spearman
pdf("./Results/skewness_results/skewness_plankton_north_sea/plankton_allsp_skewness_spearman.pdf",height=30,width=30)
op<-par(mfrow=c(4,6),mar=c(5,5,1,1),mgp=c(3,1,0))
#cat("Now for spearman preserving surrogs : pns","\n")
for(i in splist){
  #cat("sp=",i,"\n")
  loclist<-good_loclist(d_allsp=data_plankton_north_sea,sp=i,data_pt_thrs=45)
  ans<-skewness_testing(ts_matrix=sp_data(sp=i,d_allsp=data_plankton_north_sea),loclist=loclist,
                        numsurrog=numsurrog,
                        ploton=T,
                        corpres="spearman") 
  p_left<-sum(ans$surrogskw < ans$realskw)/numsurrog
  p_right<-sum(ans$surrogskw > ans$realskw)/numsurrog
  skw_plankton_spearman$realskw[i]<-ans$realskw
  skw_plankton_spearman$p_left[i]<-p_left
  skw_plankton_spearman$p_right[i]<-p_right
  mtext(paste0("sp = ",i,", p_left = ",p_left,", p_right = ",p_right),side=3,line=-0.5,col="navyblue",cex = 1)
}
par(op)
dev.off()
saveRDS(skw_plankton_spearman,"./Results/skewness_results/skewness_plankton_north_sea/skw_plankton_spearman.RDS")

pdf("./Results/skewness_results/skewness_plankton_north_sea/plankton_allsp_skewness_kendall.pdf",height=30,width=30)
op<-par(mfrow=c(4,6),mar=c(5,5,1,1),mgp=c(3,1,0))
#cat("Now for kendall preserving surrogs : pns","\n")
for(i in splist){
  #cat("sp=",i,"\n")
  loclist<-good_loclist(d_allsp=data_plankton_north_sea,sp=i,data_pt_thrs=45)
  ans<-skewness_testing(ts_matrix=sp_data(sp=i,d_allsp=data_plankton_north_sea),loclist=loclist,
                        numsurrog=numsurrog,
                        ploton=T,
                        corpres="kendall") 
  p_left<-sum(ans$surrogskw < ans$realskw)/numsurrog
  p_right<-sum(ans$surrogskw > ans$realskw)/numsurrog
  skw_plankton_kendall$realskw[i]<-ans$realskw
  skw_plankton_kendall$p_left[i]<-p_left
  skw_plankton_kendall$p_right[i]<-p_right
  mtext(paste0("sp = ",i,", p_left = ",p_left,", p_right = ",p_right),side=3,line=-0.5,col="navyblue",cex = 1)
}
par(op)
dev.off()
saveRDS(skw_plankton_kendall,"./Results/skewness_results/skewness_plankton_north_sea/skw_plankton_kendall.RDS")
```

```{r skewness_count_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

numsurrog<-10000
loclist<-good_loclist(d_allsp=data_aphid_count,sp=10,data_pt_thrs=30)

pdf("./Results/skewness_results/skewness_aphid_count/skewness_aphid_count_sp_10_kendall.pdf",height=6,width=8)
op<-par(mar=c(5,5,1.8,0.1), mgp=c(3, 1, 0))
answer1k<-skewness_testing(ts_matrix=sp_data(sp=10,d_allsp=data_aphid_count),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="kendall") 
p_left<-sum(answer1k$surrogskw < answer1k$realskw)/numsurrog
mtext(paste0("p = ",p_left),side=3,line=-0.5,cex = 2)
par(op)
dev.off()

pdf("./Results/skewness_results/skewness_aphid_count/skewness_aphid_count_sp_10_spearman.pdf",height=6,width=8)
op<-par(mar=c(5,5,1.8,0.1), mgp=c(3, 1, 0))
answer1s<-skewness_testing(ts_matrix=sp_data(sp=10,d_allsp=data_aphid_count),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="spearman") 

p_left<-sum(answer1s$surrogskw < answer1s$realskw)/numsurrog
mtext(paste0("p = ",p_left),side=3,line=-0.5,cex = 2)
par(op)
dev.off()
```

```{r skewness_ff_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_aphid_ff,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

numsurrog<-10000
loclist<-good_loclist(d_allsp=data_aphid_ff,sp=11,data_pt_thrs=30)


pdf("./Results/skewness_results/skewness_aphid_ff/skewness_aphid_ff_sp_11_kendall.pdf",height=6,width=8)
op<-par(mar=c(5,5,1.8,0.1), mgp=c(3, 1, 0))
answer2k<-skewness_testing(ts_matrix=sp_data(sp=11,d_allsp=data_aphid_ff),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="kendall") 
p_right<-sum(answer2k$surrogskw > answer2k$realskw)/numsurrog
mtext(paste0("p = ",p_right),side=3,line=-0.5,cex = 2)
par(op)
dev.off()

pdf("./Results/skewness_results/skewness_aphid_ff/skewness_aphid_ff_sp_11_spearman.pdf",height=6,width=8)
op<-par(mar=c(5,5,1.8,0.1), mgp=c(3, 1, 0))
answer2s<-skewness_testing(ts_matrix=sp_data(sp=11,d_allsp=data_aphid_ff),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="spearman") 
p_right<-sum(answer2s$surrogskw > answer2s$realskw)/numsurrog
mtext(paste0("p = ",p_right),side=3,line=-0.5,cex = 2)
par(op)
dev.off()
```


```{r skewness_pns_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_plankton_north_sea,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

numsurrog<-10000
loclist<-good_loclist(d_allsp=data_plankton_north_sea,sp=16,data_pt_thrs=45)

pdf("./Results/skewness_results/skewness_plankton_north_sea/skewness_plankton_north_sea_sp_16_kendall.pdf",height=6,width=8)
op<-par(mar=c(5,5,1.8,0.1), mgp=c(3, 1, 0))
answer3k<-skewness_testing(ts_matrix=sp_data(sp=16,d_allsp=data_plankton_north_sea),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="kendall") 
p_left<-sum(answer3k$surrogskw < answer3k$realskw)/numsurrog
mtext(paste0("p = ",p_left),side=3,line=-0.5,cex = 2)
par(op)
dev.off()

pdf("./Results/skewness_results/skewness_plankton_north_sea/skewness_plankton_north_sea_sp_16_spearman.pdf",height=6,width=8)
op<-par(mar=c(5,5,1.8,0.1), mgp=c(3, 1, 0))
answer3s<-skewness_testing(ts_matrix=sp_data(sp=16,d_allsp=data_plankton_north_sea),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="spearman") 
p_left<-sum(answer3s$surrogskw < answer3s$realskw)/numsurrog
mtext(paste0("p = ",p_left),side=3,line=-0.5,cex = 2)
par(op)
dev.off()
```


```{r skewness_methane_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_plankton_north_sea,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

numsurrog<-10000
loclist<-good_loclist(d_allsp=methane_data,sp=1,data_pt_thrs=50)

pdf("./Results/skewness_results/skewness_methane/skewness_methane_kendall.pdf",height=6,width=8)
op<-par(mar=c(5,5,1.8,0.1), mgp=c(3, 1, 0))
answer1k<-skewness_testing(ts_matrix=sp_data(sp=1,d_allsp=methane_data),loclist=loclist,numsurrog=numsurrog,ploton=T,
                           corpres="kendall") 
p_left<-sum(answer1k$surrogskw < answer1k$realskw)/numsurrog
mtext(paste0("p = ",p_left),side=3,line=-0.5,cex = 2)
par(op)
dev.off()

pdf("./Results/skewness_results/skewness_methane/skewness_methane_spearman.pdf",height=6,width=8)
op<-par(mar=c(5,5,1.8,0.1), mgp=c(3, 1, 0))
answer1s<-skewness_testing(ts_matrix=sp_data(sp=1,d_allsp=methane_data),loclist=loclist,numsurrog=numsurrog,ploton=T,
                           corpres="spearman") 
p_left<-sum(answer1s$surrogskw < answer1s$realskw)/numsurrog
mtext(paste0("p = ",p_left),side=3,line=-0.5,cex = 2)
par(op)
dev.off()
```

\begin{figure}[!h]
\textbf{ \hspace{6 cm} (A) \hspace{6 cm} (B)} \\
\vspace{-0.1 cm}
\begin{center}
\includegraphics[width=8 cm]{./Results/skewness_results/skewness_aphid_count/skewness_aphid_count_sp_10_kendall.pdf}
\includegraphics[width=8 cm]{./Results/skewness_results/skewness_aphid_ff/skewness_aphid_ff_sp_11_kendall.pdf}\\
\end{center}
\vspace{0.2 cm}
\textbf{ \hspace{6 cm} (C) \hspace{6 cm} (D)} \\
\vspace{-0.1 cm}
\begin{center}
\includegraphics[width=8 cm]{./Results/skewness_results/skewness_plankton_north_sea/skewness_plankton_north_sea_sp_16_kendall.pdf}
\includegraphics[width=8 cm]{./Results/skewness_results/skewness_methane/skewness_methane_kendall.pdf}
\caption{Skewness of spatially averaged $(A)$ Green-spruce aphid's abundance, $(B)$ Leaf-plum curling aphid's firstflight date, $(C)$ Ceratium furca's abundance and $(D)$ methane-flux data, were indicated by red dot in each plot and were compared with respect to skewness of spatially averaged 10000 Normal surrogates preserving Kendall correlation). \label{fig_skewness_kendall}}
\end{center}
\end{figure}


<!-- Taylor's law section moved to Paper.Rmd -->

<!--make surrogate datasets for TL analysis to follow-->
```{r taylors_law_make_surrogs, echo=F, cache=T, cache.extra=list(seed,mtime("copsurrognd.R"))}
source("copsurrognd.R")
set.seed(seed)

#***constants
N<-50 #length of time series
n<-25 #number of sampling locations
#numdat<-10 #the number of datasets to get from the normal copula
numdat<-1000 #the number of datasets to get from the normal copula
rho<-0.7 #normal-copula parameter for dependence between locations
          #this is a covariance, see below call to rmvnorm

#***generate the starting data, which has normal copula structure
#because it comes originally from a multivariate normal, before 
#transformation
sig<-matrix(rho,n,n)
diag(sig)<-1
m<-rmvnorm(N*numdat,mean=rep(0,n),sigma=sig) # each column of m has normal histogram
m<-array(m,c(N,numdat,n))
m<-aperm(m,c(1,3,2)) # 2nd dim is normally distributed e.g. hist(m[,1,])
gshape<-7.5
gscale<-1 #gamma parameters

cop_to_marg_trans<-function(x){
  return(qgamma(x,shape=gshape,scale=gscale)) #this is where we choose the marginals,
                                  #should be something skewed
}

marg_to_cop_trans<-function(x){ #transforms to copula space
  return(pgamma(x,shape=gshape,scale=gscale))
}

# pnorm(m) makes normal to uniform
# then qgamma(...) makes uniform to gamma distributed
m<-cop_to_marg_trans(pnorm(m))

#***surrogates using a Clayton copula, kendall preserving

#get the Clayton parameter to use
ncop<-normalCopula(rho,2)
ccop<-claytonCopula(2,2)
cparam<-iTau(ccop,tau(ncop))
ccop<-claytonCopula(cparam,n)

#generate the surrogates
csurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3]){
  csurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=ccop,numsurrog=1)
}

# #test to see whether kendalls are similar between m and csurrog - 
#only works at all as a test if N is large (I used 1000)
# cor(m[,1,1],m[,2,1],method='kendall')
# cor(csurrog[,1,1],csurrog[,2,1],method='kendall')
# cor(m[,3,1],m[,4,1],method='kendall')
# cor(csurrog[,3,1],csurrog[,4,1],method='kendall')
# cor(m[,5,1],m[,6,1],method='kendall')
# cor(csurrog[,5,1],csurrog[,6,1],method='kendall')
# 
# cor(m[,1,2],m[,2,2],method='kendall')
# cor(csurrog[,1,2],csurrog[,2,2],method='kendall')
# cor(m[,3,2],m[,4,2],method='kendall')
# cor(csurrog[,3,2],csurrog[,4,2],method='kendall')
# cor(m[,5,2],m[,6,2],method='kendall')
# cor(csurrog[,5,2],csurrog[,6,2],method='kendall')

#***surrogates using a Frank copula, kendall preserving
#get the Frank parameter to use
fcop<-frankCopula(4,2)
fparam<-iTau(fcop,tau(ncop))
fcop<-frankCopula(fparam,n)

#generate the surrogates
fsurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3]){
  fsurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=fcop,numsurrog=1)
}

#***surrogates using a survival Clayton, kendall preserving
#take the clayton surrogates and transform them to the 
#copula space, then flip, then transform back
scsurrog<-cop_to_marg_trans((1-marg_to_cop_trans(csurrog)))

# check : plot(csurrog[,1,1],csurrog[,2,1]) and plot(scsurrog[,1,1],scsurrog[,2,1])

# #test: should have identical taus as csurrog
# cor(csurrog[,1,1],csurrog[,2,1],meth='kendall')
# cor(scsurrog[,1,1],scsurrog[,2,1],meth='kendall')
# cor(csurrog[,1,2],csurrog[,2,2],meth='kendall')
# cor(scsurrog[,1,2],scsurrog[,2,2],meth='kendall')

kend.surrog<-list(cla=csurrog,nor=m,fra=fsurrog,scl=scsurrog)

#***surrogates using a Clayton copula, spearman preserving
#get the Clayton parameter to use
ccop<-claytonCopula(2,2)
cparam<-iRho(ccop,rho(ncop))
ccop<-claytonCopula(cparam,n)

#generate the surrogates
csurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3]){
  csurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=ccop,numsurrog=1)
}

#***surrogates using a Frank copula, spearman preserving
#get the Frank parameter to use
fcop<-frankCopula(4,2)
fparam<-iRho(fcop,rho(ncop))
fcop<-frankCopula(fparam,n)

#generate the surrogates
fsurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3]){
  fsurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=fcop,numsurrog=1)
}

#***surrogates using a survival Clayton, spearman preserving
#take the clayton surrogates and transform them to the 
#copula space, then flip, then transform back
scsurrog<-cop_to_marg_trans((1-marg_to_cop_trans(csurrog)))

spea.surrog<-list(cla=csurrog,nor=m,fra=fsurrog,scl=scsurrog)
```

<!--do a TL analysis on the data just created-->
```{r tl_analysis, echo=F, cache=T, cache.extra=list(kend.surrog,spea.surrog,mtime("mncurvat.R"),mtime("TaylorsLawTools.R"),seed,mtime("copsurrognd.R"))}
source("copsurrognd.R")
source("TaylorsLawTools.R")
 
#We are only doing spatial taylor's law because we know a priori temporal
#won't give anything interesting for the surrogates we use

kend.stats.res<-list()
kend.points.res<-list()
spea.stats.res<-list()
spea.points.res<-list()
for (counter in 1:length(kend.surrog)){
 ks<-kend.surrog[[counter]]
 ss<-spea.surrog[[counter]]
 kend.stats.res[[counter]]<-matrix(NA,7,numdat) # to keep spatial TL stats
 spea.stats.res[[counter]]<-matrix(NA,7,numdat)
 kend.points.res[[counter]]<-array(NA,c(N,2,numdat)) # to keep log(mu), log(var) of spatial TL as a dataframe
 spea.points.res[[counter]]<-array(NA,c(N,2,numdat))
 for (sc in 1:numdat){
   khold<-tl_stats(ks[,,sc])
   kend.stats.res[[counter]][,sc]<-khold$s.stats #spatial TL only
   rownames(kend.stats.res[[counter]])<-names(khold$s.stats)
   kend.points.res[[counter]][,,sc]<-as.matrix(khold$s.points)
 
   shold<-tl_stats(ss[,,sc])
   spea.stats.res[[counter]][,sc]<-shold$s.stats #spatial TL only
   rownames(spea.stats.res[[counter]])<-names(shold$s.stats)
   spea.points.res[[counter]][,,sc]<-as.matrix(shold$s.points)
 }
}
names(kend.stats.res)<-names(kend.surrog)
names(kend.points.res)<-names(kend.surrog)
names(spea.stats.res)<-names(spea.surrog)
names(spea.points.res)<-names(spea.surrog)
```

<!--Now make some plots, these one for kendall surrogates-->
```{r taylor_plots_kendall, echo=F, results="hide"}
xlimits<-range(kend.points.res[[1]][,1,],kend.points.res[[2]][,1,],kend.points.res[[3]][,1,],kend.points.res[[4]][,1,])
ylimits<-range(kend.points.res[[1]][,2,],kend.points.res[[2]][,2,],kend.points.res[[3]][,2,],kend.points.res[[4]][,2,])

pdf("./Results/taylorslaw_results/SpatialTL_CNFSC_kendall.pdf",height=4,width=16)
op<-op<-par(mfrow=c(1,4),mar=c(4,5,1,1),mgp=c(3,1,0))
##plot TL for clayton
plot(kend.points.res[[1]][,1,],kend.points.res[[1]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(kend.points.res[[1]][,1,1],kend.points.res[[1]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[1]][,1,2],kend.points.res[[1]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Clayton"),side = 3, line=-2, adj=0.1, col="black")

##plot TL for normal copula
plot(kend.points.res[[2]][,1,],kend.points.res[[2]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(kend.points.res[[2]][,1,1],kend.points.res[[2]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[2]][,1,2],kend.points.res[[2]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Normal"),side = 3, line=-2, adj=0.1, col="black")

#plot TL for frank
plot(kend.points.res[[3]][,1,],kend.points.res[[3]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(kend.points.res[[3]][,1,1],kend.points.res[[3]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[3]][,1,2],kend.points.res[[3]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Frank"),side = 3, line=-2, adj=0.1, col="black")

#plot TL for survival clayton
plot(kend.points.res[[4]][,1,],kend.points.res[[4]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(kend.points.res[[4]][,1,1],kend.points.res[[4]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[4]][,1,2],kend.points.res[[4]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Survival Clayton"),side=3, line=-2, adj=0.1, col="black")

par(op)
dev.off()
#---------------------------------------------------
#prepare for plots coming below
s.lin<-cbind(kend.stats.res[[1]][1,],kend.stats.res[[2]][1,],kend.stats.res[[3]][1,],kend.stats.res[[4]][1,])
s.hom<-cbind(kend.stats.res[[1]][2,],kend.stats.res[[2]][2,],kend.stats.res[[3]][2,],kend.stats.res[[4]][2,])
s.rmse<-cbind(kend.stats.res[[1]][3,],kend.stats.res[[2]][3,],kend.stats.res[[3]][3,],kend.stats.res[[4]][3,])
s.int<-cbind(kend.stats.res[[1]][4,],kend.stats.res[[2]][4,],kend.stats.res[[3]][4,],kend.stats.res[[4]][4,])
s.slope<-cbind(kend.stats.res[[1]][5,],kend.stats.res[[2]][5,],kend.stats.res[[3]][5,],kend.stats.res[[4]][5,])
s.quadcoeff<-cbind(kend.stats.res[[1]][6,],kend.stats.res[[2]][6,],kend.stats.res[[3]][6,],kend.stats.res[[4]][6,])
s.mncurv<-cbind(kend.stats.res[[1]][7,],kend.stats.res[[2]][7,],kend.stats.res[[3]][7,],kend.stats.res[[4]][7,])

pdf("./Results/taylorslaw_results/SpatialTL_7stats_kendall.pdf",height=3,width=21)
op<-par(mfrow=c(1,7),mar=c(4.2,5,1,1),mgp=c(3,1,0))
#***DAN: x axis needs to be redone to show the copula names used in the surrogates

#x<-1:4
x2<-c("C", "N", "F", "SC")
#plot(x,s.lin[1,],type="l",col="grey",ylim=range(s.lin),xlab="Set of surrogates",ylab="Linearity test p-vals",
#     cex.axis=1.5,cex.lab=1.5,xaxt="n")
#points(x,s.lin[1,],col="red")
#axis(1, at = c(1:4), x2, cex.axis=1.5)
#for (counter in 2:dim(s.lin)[1]){
#  lines(x,s.lin[counter,],col="grey")
#  points(x,s.lin[counter,],col="red")
#}
boxplot(s.lin , col=rainbow(4), xlab="Copula family", ylab="Linearity test p-vals", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.hom distr for each set of surrogates
boxplot(s.hom , col=rainbow(4), xlab="Copula family", ylab="Homoskedasticity test p-vals", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.rmse distr for each set of surrogates
boxplot(s.rmse , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL rmse", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.int distr for each set of surrogates
boxplot(s.int , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL intercept", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.slope distr for each set of surrogates
boxplot(s.slope , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL slope", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.quadcoeff distr for each set of surrogates
boxplot(s.quadcoeff , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL quadratic coefficient", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.mncurv distr for each set of surrogates
boxplot(s.mncurv , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL mean curvature", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

par(op)
dev.off()
```

<!--Now make some plots, these one for spearman surrogates-->
```{r taylor_plots_spearman, echo=F, results="hide"}
xlimits<-range(spea.points.res[[1]][,1,],spea.points.res[[2]][,1,],spea.points.res[[3]][,1,],spea.points.res[[4]][,1,])
ylimits<-range(spea.points.res[[1]][,2,],spea.points.res[[2]][,2,],spea.points.res[[3]][,2,],spea.points.res[[4]][,2,])

pdf("./Results/taylorslaw_results/SpatialTL_CNFSC_spearman.pdf",height=4,width=16)
op<-op<-par(mfrow=c(1,4),mar=c(4,5,1,1),mgp=c(3,1,0))
##plot TL for clayton
plot(spea.points.res[[1]][,1,],spea.points.res[[1]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(spea.points.res[[1]][,1,1],spea.points.res[[1]][,2,1],type='p',pch=20,cex=.75,col='red')
points(spea.points.res[[1]][,1,2],spea.points.res[[1]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Clayton"),side = 3, line=-2, adj=0.1, col="black")

##plot TL for normal copula
plot(spea.points.res[[2]][,1,],spea.points.res[[2]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(spea.points.res[[2]][,1,1],spea.points.res[[2]][,2,1],type='p',pch=20,cex=.75,col='red')
points(spea.points.res[[2]][,1,2],spea.points.res[[2]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Normal"),side = 3, line=-2, adj=0.1, col="black")

#plot TL for frank
plot(spea.points.res[[3]][,1,],spea.points.res[[3]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(spea.points.res[[3]][,1,1],spea.points.res[[3]][,2,1],type='p',pch=20,cex=.75,col='red')
points(spea.points.res[[3]][,1,2],spea.points.res[[3]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Frank"),side = 3, line=-2, adj=0.1, col="black")

#plot TL for survival clayton
plot(spea.points.res[[4]][,1,],spea.points.res[[4]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(spea.points.res[[4]][,1,1],spea.points.res[[4]][,2,1],type='p',pch=20,cex=.75,col='red')
points(spea.points.res[[4]][,1,2],spea.points.res[[4]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Survival Clayton"),side=3, line=-2, adj=0.1, col="black")

par(op)
dev.off()
#---------------------------------------------------
#prepare for plots coming below
s.lin<-cbind(spea.stats.res[[1]][1,],spea.stats.res[[2]][1,],spea.stats.res[[3]][1,],spea.stats.res[[4]][1,])
s.hom<-cbind(spea.stats.res[[1]][2,],spea.stats.res[[2]][2,],spea.stats.res[[3]][2,],spea.stats.res[[4]][2,])
s.rmse<-cbind(spea.stats.res[[1]][3,],spea.stats.res[[2]][3,],spea.stats.res[[3]][3,],spea.stats.res[[4]][3,])
s.int<-cbind(spea.stats.res[[1]][4,],spea.stats.res[[2]][4,],spea.stats.res[[3]][4,],spea.stats.res[[4]][4,])
s.slope<-cbind(spea.stats.res[[1]][5,],spea.stats.res[[2]][5,],spea.stats.res[[3]][5,],spea.stats.res[[4]][5,])
s.quadcoeff<-cbind(spea.stats.res[[1]][6,],spea.stats.res[[2]][6,],spea.stats.res[[3]][6,],spea.stats.res[[4]][6,])
s.mncurv<-cbind(spea.stats.res[[1]][7,],spea.stats.res[[2]][7,],spea.stats.res[[3]][7,],spea.stats.res[[4]][7,])

pdf("./Results/taylorslaw_results/SpatialTL_7stats_spearman.pdf",height=3,width=21)
op<-par(mfrow=c(1,7),mar=c(4.2,5,1,1),mgp=c(3,1,0))
x2<-c("C", "N", "F", "SC")

#plot s.lin distr for each set of surrogates
boxplot(s.lin , col=rainbow(4), xlab="Copula family", ylab="Linearity test p-vals", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.hom distr for each set of surrogates
boxplot(s.hom , col=rainbow(4), xlab="Copula family", ylab="Homoskedasticity test p-vals", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.rmse distr for each set of surrogates
boxplot(s.rmse , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL rmse", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.int distr for each set of surrogates
boxplot(s.int , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL intercept", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.slope distr for each set of surrogates
boxplot(s.slope , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL slope", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.quadcoeff distr for each set of surrogates
boxplot(s.quadcoeff , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL quadratic coefficient", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.mncurv distr for each set of surrogates
boxplot(s.mncurv , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL mean curvature", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

par(op)
dev.off()
```

\begin{figure}[!h]
\textbf{ \hspace{2.8 cm} (A) \hspace{3.6 cm} (B) \hspace{3.8 cm} (C) \hspace{3.6 cm} (D)} \\
\vspace{-0.5 cm} 
\begin{center}
\includegraphics[width=18 cm]{./Results/taylorslaw_results/SpatialTL_CNFSC_spearman.pdf}\\
\end{center}
\textbf{ \hspace{1.8 cm} (E) \hspace{1.6 cm} (F) \hspace{1.8 cm} (G) \hspace{1.8 cm} (H) \hspace{1.8 cm} (I) \hspace{1.8 cm} (J) \hspace{1.8 cm} (K)}\\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=18 cm]{./Results/taylorslaw_results/SpatialTL_7stats_spearman.pdf}
\caption[Spatial Taylor's Law results]{Spatial Taylor's Law results: log(spatial variance) vs. log(spatial mean) for $ns=1000$ number of (A) Clayton, (B) Normal, (C) Frank, (D) Survival Clayton surrogates; (E) p-value for test of linearity, (F) p-value for test of homoskedasticity, (G) root mean square error, (H) intercept, (I) slope, (J) quadratic coefficient, (K) mean curvature of regression line from first panel-plots. \label{fig_spTL}}
\end{center}
\end{figure}

```{r spatialTL_on_realdata_aphid_count, results="hide", echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("good_loclist.R"),mtime("TaylorsLawTools.R"),mtime("mncurvat.R"),mtime("ncsurrog.R"))}

set.seed(seed)
source("ncsurrog.R")
source("TaylorsLawTools.R")
source("good_loclist.R")

TL_on_realdata<-function(data,numsurrog=1000,sp,data_pt_thrs,ploton,tag,labelon=T){
  
  loclist<-good_loclist(d_allsp=data,sp=sp,data_pt_thrs=data_pt_thrs)
  data<-data[[sp]]
  df<-c()
  for(i in loclist){
    tem<-data[[i]]$Dat
    df<-cbind(df,tem)
  }
  colnames(df)<-paste("loc",loclist,sep="")
  df<-na.omit(df)
  
  mat_real<-as.matrix(df)
  check_rep<-function(y){all( abs(y - mean(y)) < 1e-8 )} #This fn checks for repeatation of same values in a vector
  call_check_rep<-apply(mat_real,1,check_rep) # checks the same for mat_real matrix along all row
  
  if(all(call_check_rep==F)==T){
    
    realTL_stats<-tl_stats(m = mat_real)
    real_spatialTLslope<-unname(realTL_stats$s.stats[5])
    real_sTL_quadcoeff<-unname(realTL_stats$s.stats[6])
    real_sTL_mncurv<-unname(realTL_stats$s.stats[7])
    
    #generate the normal surrogates with spearman correlation preserving
    array_surrog<-ncsurrog(m=mat_real,corpres="spearman",numsurrog=numsurrog)
    
    bad_id<-c()
    for(i in 1:numsurrog){
      m<-array_surrog[,,i]
      mean_m<-apply(X=m, MARGIN = 1, FUN = mean)
      var_m<-apply(X=m, MARGIN = 1, FUN = var)
      if(any(mean_m==0) | any(var_m==0)){
        bad_id<-c(bad_id,i)
      }
    }
    
    m<-array_surrog
    if(length(bad_id)!=0){
      m<-array_surrog[,,-bad_id]
    }
    ts<-apply(m,3,tl_stats)
    
    good_surrog_slope<-c()
    good_surrog_quadcoeff<-c()
    good_surrog_mncurv<-c()
    for(i in c(1:length(ts))){
      good_surrog_slope<-c(good_surrog_slope,unname(ts[[i]]$s.stats[5]))
      good_surrog_quadcoeff<-c(good_surrog_quadcoeff,unname(ts[[i]]$s.stats[6]))
      good_surrog_mncurv<-c(good_surrog_mncurv,unname(ts[[i]]$s.stats[7]))
    }
    
    numsurrog_good<- numsurrog - length(bad_id)
    
    p_left<-sum(good_surrog_slope < real_spatialTLslope)/numsurrog_good
    p_right<-sum(good_surrog_slope > real_spatialTLslope)/numsurrog_good
    
    p_left_quadcoeff<-sum(good_surrog_quadcoeff < real_sTL_quadcoeff)/numsurrog_good
    p_right_quadcoeff<-sum(good_surrog_quadcoeff > real_sTL_quadcoeff)/numsurrog_good
    
    p_left_mncurv<-sum(good_surrog_mncurv < real_sTL_mncurv)/numsurrog_good
    p_right_mncurv<-sum(good_surrog_mncurv > real_sTL_mncurv)/numsurrog_good
    
    if(ploton==T & tag=="slope"){
      hist(good_surrog_slope,breaks=100,main="",xlab="surrogate_TL_slope",cex.axis=1.5,cex.lab=1.5)
      points(x=real_spatialTLslope,y=0,col="red",pch=15)
      if(labelon==T){
        mtext(paste0("sp= ",sp,", p_left= ",round(p_left,3),", p_right=",round(p_right,3),sep=""),
              side = 3, line=-2, adj=0, col="blue")
      }
    }
    
    if(ploton==T & tag=="quadcoeff"){
      hist(good_surrog_quadcoeff,breaks=100,main="",xlab="surrogate_TL_quadcoeff",cex.axis=1.5,cex.lab=1.5)
      points(x=real_sTL_quadcoeff,y=0,col="red",pch=15)
      if(labelon==T){
        mtext(paste0("sp= ",sp,", p_left= ",round(p_left_quadcoeff,3),", p_right=",round(p_right_quadcoeff,3),sep=""),
              side = 3, line=-2, adj=0, col="blue")
      }
    }
    
    if(ploton==T & tag=="mncurv"){
      hist(good_surrog_mncurv,breaks=100,main="",xlab="surrogate_TL_meanCurvature",cex.axis=1.5,cex.lab=1.5)
      points(x=real_sTL_mncurv,y=0,col="red",pch=15)
      if(labelon==T){
        mtext(paste0("sp= ",sp,", p_left= ",round(p_left_mncurv,3),", p_right=",round(p_right_mncurv,3),sep=""),
              side = 3, line=-2, adj=0, col="blue")
      }
    }
    
  }else{
    real_spatialTLslope<-NA
    p_left<-NA
    p_right<-NA
    numsurrog_good<-NA
    real_sTL_quadcoeff<-NA
    p_left_quadcoeff<-NA
    p_right_quadcoeff<-NA
    real_sTL_mncurv<-NA
    p_left_mncurv<-NA
    p_right_mncurv<-NA
  }
  return(list(realTL_stats=realTL_stats,
              real_spatialTLslope=real_spatialTLslope,
              p_left=p_left,
              p_right=p_right,
              numsurrog_good=numsurrog_good,
              real_sTL_quadcoeff=real_sTL_quadcoeff,
              p_left_quadcoeff=p_left_quadcoeff,
              p_right_quadcoeff=p_right_quadcoeff,
              real_sTL_mncurv=real_sTL_mncurv,
              p_left_mncurv=p_left_mncurv,
              p_right_mncurv=p_right_mncurv,
              surrogTL_stats=ts,
              good_surrog_mncurv=good_surrog_mncurv))
}

#call on real data
# For all sp
splist<-c(1:20)
tl_aphid_count<-as.data.frame(matrix(NA,nrow=length(splist),ncol=10))
colnames(tl_aphid_count)<-c("real_sTL_slope","p_left","p_right","numsurrog_good",
                            "real_sTL_quadcoeff","p_left_quadcoeff","p_right_quadcoeff",
                            "real_sTL_mncurv","p_left_mncurv","p_right_mncurv")
rownames(tl_aphid_count)<-paste("sp",splist,sep="")
#pdf("aphid_count_allsp_spTLslope.pdf",height=20,width=20)
#pdf("./Results/taylorslaw_results/aphid_count_allsp_sTL_quadcoeff.pdf",height=20,width=20)
pdf("./Results/taylorslaw_results/aphid_count_allsp_sTL_mncurv.pdf",height=20,width=20)
op<-par(mfrow=c(4,5),mar=c(4.2,5,1,1),mgp=c(3,1,0))
for(i in splist){
  #cat("sp=",i,"\n")
  #ans<-TL_on_realdata(data=data_aphid_count,numsurrog=10000,sp=i,data_pt_thrs = 30,ploton=T,tag="slope",labelon=T)
  #ans<-TL_on_realdata(data=data_aphid_count,numsurrog=10000,sp=i,data_pt_thrs = 30,ploton=T,tag="quadcoeff",labelon=T)
  ans<-TL_on_realdata(data=data_aphid_count,numsurrog=10000,sp=i,data_pt_thrs = 30,ploton=T,tag="mncurv",labelon=T)
  tl_aphid_count$real_sTL_slope[i]<-ans$real_spatialTLslope
  tl_aphid_count$p_left[i]<-ans$p_left
  tl_aphid_count$p_right[i]<-ans$p_right
  tl_aphid_count$numsurrog_good[i]<-ans$numsurrog_good
  tl_aphid_count$real_sTL_quadcoeff[i]<-ans$real_sTL_quadcoeff
  tl_aphid_count$p_left_quadcoeff[i]<-ans$p_left_quadcoeff
  tl_aphid_count$p_right_quadcoeff[i]<-ans$p_right_quadcoeff
  tl_aphid_count$real_sTL_mncurv[i]<-ans$real_sTL_mncurv
  tl_aphid_count$p_left_mncurv[i]<-ans$p_left_mncurv
  tl_aphid_count$p_right_mncurv[i]<-ans$p_right_mncurv
}
par(op)
dev.off()
saveRDS(tl_aphid_count,"./Results/taylorslaw_results/tl_aphid_count.RDS")
```


```{r spatialTL_on_realdata_aphid_count_sp6, results="hide", echo=F, cache=T, cache.extra=list(seed,data_aphid_count,TL_on_realdata,mtime("good_loclist.R"),mtime("TaylorsLawTools.R"),mtime("mncurvat.R"),mtime("ncsurrog.R"))}

set.seed(seed)

#Now for sp=6
sp<-6
pdf("./Results/taylorslaw_results/aphid_count_sp6_sTL_mncurv.pdf",height=5,width=5)
op<-par(mar=c(4,5,1,1),mgp=c(3,1,0))
ans<-TL_on_realdata(data=data_aphid_count,numsurrog=10000,sp=sp,data_pt_thrs = 30,ploton=T,tag="mncurv",labelon = F)
saveRDS(ans,"./Results/taylorslaw_results/tl_aphid_count_sp6.RDS")
mtext(paste0("p= ",ans$p_left_mncurv),side = 3, line=-2, adj=0.5, col="black",cex=2)
par(op)
dev.off()

pdf("./Results/taylorslaw_results/aphid_count_sp6_logv_vs_logm.pdf",height=5,width=10)
op<-op<-par(mfrow=c(1,2),mar=c(4,5,1,1),mgp=c(3,1,0))
plot(ans$realTL_stats$s.points,xlab=expression(log[10]("spatial mean")),
     ylab=expression(log[10]("spatial variance")),col="black",
     cex.axis=1.5,cex.lab=1.5)
mtext(paste0("mean curvature= ",round(unname(ans$realTL_stats$s.stats[7]),3)),side = 3, line=-2, adj=0, col="black",cex=2)

target_mncurv<-0.1
id<-which(abs(ans$good_surrog_mncurv-target_mncurv)<1e-4)[1]
ans_s<-ans$surrogTL_stats
plot(ans_s[[id]]$s.points,xlab=expression(log[10]("spatial mean")),
     ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)
mtext(paste0("mean curvature= ",round(ans$good_surrog_mncurv[id],3)),side = 3, line=-2, adj=0, col="black",cex=2)

par(op)
dev.off()
```


```{r fig_ext_risk, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}

source("mydispersal.R")
set.seed(seed)

rlist<-c(0,0.05,0.25,0.5,0.7,0.75,0.9,1.0,1.25,1.5,1.75,1.95)

# plot for local dispersal in D matrix ; r=0 for LC model, r!=0 for Ricker model
pdf("./Results/ext_risk_local_disp.pdf",heigh=6,width=10)
op<-par(mfrow=c(3,4),mar=c(5,4,1,1) + 0.2)
for(r in rlist){
    #cat("r=",r,"\n")
    s<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=r,K=50,disp_everywhere=F,ploton=F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend(x=-0.06,y=1.1, c("noise : left","noise : right"), fill=c('red', 'blue'), horiz=T, bty='n')
    mtext(paste0("r = ", r))
}
par(op)
dev.off()


# plot for global dispersal in D matrix ; r=0 for LC model, r!=0 for Ricker model
pdf("./Results/ext_risk_global_disp.pdf",heigh=6,width=10)
op<-par(mfrow=c(3,4),mar=c(5,4,1,1) + 0.2)
for(r in rlist){
  #cat("r=",r,"\n")
  s<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=r,K=50,disp_everywhere=T,ploton=F)
  plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d_seq,s$risk_right,type="b",col="blue")
  legend(x=-0.06,y=1.1, c("noise : left","noise : right"), fill=c('red', 'blue'), horiz=T, bty='n')
  mtext(paste0("r = ", r))
}
par(op)
dev.off()

# plot to show the effect of increasing numlocs for r=0 (LC model), r=0.25 (Ricker model)
pdf("./Results/ext_risk_numlocs_effect_local_disp.pdf",heigh=6,width=6)
op<-par(mfrow=c(2,2),mar=c(4,4,1,1) + 0.1)
for(r in c(0,0.25)){
  #cat("r=",r,"\n")
  s5<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=r,K=50,disp_everywhere=F,ploton=F)
  s25<-varying_d(numsims=10000,numsteps =25,numlocs=25,r=r,K=50,disp_everywhere=F,ploton=F)
  
  plot(s5$d_seq,s5$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
  lines(s25$d_seq,s25$risk_left,type="b",col="orange")
  legend("topleft", title=paste0("r=",r," , left tail dep. in noise"), c("numlocs=5","numlocs=25"), fill=c('red', 'orange'),  horiz=F, bty='n')
 
  
  plot(s5$d_seq,s5$risk_right,xlim=c(0,1),ylim=c(0,1),type="b",col="blue",
       panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
  lines(s25$d_seq,s25$risk_right,type="b",col="skyblue")
  legend("topleft",title=paste0("r=",r," , right tail dep. in noise"), c("numlocs=5","numlocs=25"), fill=c('blue', 'skyblue'),  horiz=F, bty='n')
  #mtext(paste0("B",1))
}
par(op)
dev.off()

# plot to show the effect of increasing numlocs for r=0 (LC model), r=0.25 (Ricker model)
pdf("./Results/ext_risk_numlocs_effect_global_disp.pdf",heigh=6,width=6)
op<-par(mfrow=c(2,2),mar=c(4,4,1,1) + 0.1)
for(r in c(0,0.25)){
  #cat("r=",r,"\n")
  s5<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=r,K=50,disp_everywhere=T,ploton=F)
  s25<-varying_d(numsims=10000,numsteps =25,numlocs=25,r=r,K=50,disp_everywhere=T,ploton=F)
  
  plot(s5$d_seq,s5$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
  lines(s25$d_seq,s25$risk_left,type="b",col="orange")
  legend("topleft", title=paste0("r=",r," , left tail dep. in noise"), c("numlocs=5","numlocs=25"), fill=c('red', 'orange'),  horiz=F, bty='n')
 
  
  plot(s5$d_seq,s5$risk_right,xlim=c(0,1),ylim=c(0,1),type="b",col="blue",
       panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
  lines(s25$d_seq,s25$risk_right,type="b",col="skyblue")
  legend("topleft",title=paste0("r=",r," , right tail dep. in noise"), c("numlocs=5","numlocs=25"), fill=c('blue', 'skyblue'),  horiz=F, bty='n')
  #mtext(paste0("B",1))
}
par(op)
dev.off()

# plot to see the effect of K for r=0.25 (Ricker model)
pdf("./Results/ext_risk_K_effect.pdf",heigh=6,width=6)
op<-par(mfrow=c(2,2),mar=c(4,4,1,1) + 0.1)

s1<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=0.25,K=50,disp_everywhere=F,ploton=F)
s2<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=0.25,K=200,disp_everywhere=F,ploton=F)
  
s3<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=0.25,K=50,disp_everywhere=T,ploton=F)
s4<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=0.25,K=200,disp_everywhere=T,ploton=F)
  
plot(s1$d_seq,s1$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
lines(s2$d_seq,s2$risk_left,type="b",col="orange")
legend("topleft",title=("Noise : left tail dep., local disp."), c("K=50","K=200"), fill=c('red', 'orange'),  horiz=F, bty='n')
  
plot(s1$d_seq,s1$risk_right,xlim=c(0,1),ylim=c(0,1),type="b",col="blue",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
lines(s2$d_seq,s2$risk_right,type="b",col="skyblue")
legend("topleft",title=("Noise : right tail dep., local disp."),c("K=50","K=200"), fill=c('blue', 'skyblue'),  horiz=F, bty='n')
 
plot(s3$d_seq,s3$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
lines(s4$d_seq,s4$risk_left,type="b",col="orange")
legend("topleft",title= ("Noise : left tail dep., global disp."),c("K=50","K=200"), fill=c('red', 'orange'),  horiz=F, bty='n')
  
plot(s3$d_seq,s3$risk_right,xlim=c(0,1),ylim=c(0,1),type="b",col="blue",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
lines(s4$d_seq,s4$risk_right,type="b",col="skyblue")
legend("topleft",title=("Noise : right tail dep., global disp."),c("K=50","K=200"), fill=c('blue', 'skyblue'),  horiz=F, bty='n')
 
par(op)
dev.off()
```

<!-- Extinction risk results are not shown currently, it is introduced as a future idea in Discussion-->
<!--
![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Lewton-Cohen model : $r=0$, Ricker model : $r\neq0$) with local dispersion (see Eq. \ref{eq.extrisk_model}); numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp}](./Results/ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Lewton-Cohen model : $r=0$, Ricker model : $r\neq0$) with global dispersion (see Eq. \ref{eq.extrisk_model}); numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp}](./Results/ext_risk_global_disp.pdf){ width=40%, height=40% }

![Increasing patch number allows metapopulation to disperse more efficiently and thereby decresing extinction risk calculated after 25 years; models with local dispersion with numsims=10000 (see Eq. \ref{eq.extrisk_model}).\label{fig_risk_numlocs_effect_local_disp}](./Results/ext_risk_numlocs_effect_local_disp.pdf){ width=40%, height=40% }

![Increasing patch number allows metapopulation to disperse more efficiently and thereby decresing extinction risk calculated after 25 years; models with global dispersion with numsims=10000 (see Eq. \ref{eq.extrisk_model}).\label{fig_risk_numlocs_effect_global_disp}](./Results/ext_risk_numlocs_effect_global_disp.pdf){ width=40%, height=40% }

![Extinction risk as calculated after 25 years on Ricker model (r=0.25, numsims=10000) decreases as carrying capacity $K$ increases for both local and global dispersion (see Eq. \ref{eq.extrisk_model}).\label{fig_risk_K_effect}](./Results/ext_risk_K_effect.pdf){ width=40%, height=40% }
-->

\newpage
# Consequence of non-Normal copula structure : Effect on Taylor's law \label{Consequence_TL_simulation}

Here, we examined the nature of the slope and how it changed if population time series (taken as $50$ years) from different locations (say, $numloc=25$) had some certain type of copula structure (namely, \textbf{C}, \textbf{F} and \textbf{SC}) other than the $\textbf{N}$ormal copula. First, we simulated (N $\times$ n $\times$ nr) dimensional normal copula with covariance $\rho =0.7$, where $(N=50,n=25,nr=10)$ are the length of timeseries, number of sampling locations and number of replica for that copula, respectively. Then we generated Kendall-correlation preserving \textbf{C}layton, \textbf{F}rank and $\textbf{S}$urvival \textbf{C}layton surrogates with same dimension of \textbf{N}ormal. With these four different types of copula we computed `log`(spatial variance) and `log`(mean) and plotted in Fig.\ref{fig_spTL}(A-D). We also tested statistically that whether linearity, homoskedasticity is maintained in each copula dataset or not and plotted our results alongwith root mean square error, intercept and slope in Fig.\ref{fig_spTL}(E-I). We did a quadratic regression with each simulated copula for all types and measured quadratic coefficient and mean curvature for the regression line which is plotted in Fig.\ref{fig_spTL}(J-K) (For code see [`copsurrognd.R`](https://github.com/sghosh89/BIVAN/blob/master/copsurrognd.R) and [`TaylorsLawTools.R`](https://github.com/sghosh89/BIVAN/blob/master/TaylorsLawTools.R)).

<!-- Extinction risk results are not shown currently, it is introduced as a future idea in Discussion------

# Consequence of non-Normal copula structure : effect on extinction risk \label{Consequence_ext_risk}

In order to study the effects of non-Normal copula structure on extinction risk for metapopulations with different dispersal rules, we examined the following generalized multiple patch model where local population dynamics at each patch were governed by the Lewton-Cohen model ($r=0$) or Ricker model ($r \neq 0$) as the case may be;

\begin{equation}\label{eq.extrisk_model}
P(t+1) = \exp\left [  r\left ( 1-\frac{P(t)}{K} \right ) + \epsilon(t) \right ] P(t)
\end{equation}

$r$ is the liner growth rate and $K$ is the carrying capacity of the environment. $\epsilon$ is the environmental noise which might take stronger right tail (means stronger upper tail)  or stronger left tail (means stronger lower tail) dependence. We then considered each population $P(t+1)$ was updated depending upon $D$, the dispersal matrix, which could take either forms; one case when each population patch on a linear chain interacted with its two nearest neighbors (we called it local dispersion) or when any patch was allowed to interact with the rest of all (we called it as global dispersion). We simulated Eq. \ref{eq.extrisk_model} for $10000$ simulations and calculated extinction risk after $25$ years with different possibilities (for code see [mydispersal.R](https://github.com/sghosh89/BIVAN/blob/master/mydispersal.R)) and summarized our findings as follows;


- LC model (r=0) :

    * For LC model, as expected, when extinction risk calculated after $25$ years, was plotted against each varying $d$ (=degree of dispersion), we found that extinction risk was higher for data came from left tail dependent environmental fluctuations than right tail dependent one. [see first subplot of Fig. \ref{fig_risk_local_disp} and Fig. \ref{fig_risk_global_disp}]

- Ricker model (r $\neq$ 0):

    * For ricker model when extinction risk calculated after $25$ years, was plotted against each varying $d$ (=degree of dispersion), we found that extinction risk was higher for data came from left tail dependent environmental fluctuations than right tail dependent one upto $r=0.7$. For $r>0.7$, extinction risk is greater for data came from right tail dependent environmental fluctuations. [see Fig. \ref{fig_risk_local_disp} - \ref{fig_risk_global_disp}]
 
    * With increasing $K$ from $50$ to $200$, extinction risk in both case gets decreased as expected. [see Figure \ref{fig_risk_K_effect}]
  
With increasing number of patches from $5$ to $25$, extinction risk decreased [for a fixed $d$] ; [see Fig. \ref{fig_risk_numlocs_effect_local_disp} - Fig. \ref{fig_risk_numlocs_effect_global_disp}] for both model. -->


\clearpage

#  References

<!--
<div id="refs"></div>
-->



