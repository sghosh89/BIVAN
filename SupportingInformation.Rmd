---
title: "Supporting Information : The importance of a complete statistical description of dependence between variables for ecology and related fields"
author: "S. Ghosh, T. Loecke, C.P. Reid, D.C. Reuman"
date: "February 12, 2018"
geometry: "left=1cm,right=1cm,top=2.5cm,bottom=2.8cm"

output: 
  pdf_document:
    number_sections: yes
    keep_tex: yes
    fig_caption: yes
    includes:
      in_header: head_supp.sty
      
tables: True
link-citations: True
urlcolor : blue

csl: ecology-letters.csl
bibliography: REF_ALL.bib
---

\tableofcontents
\listoftables
\listoffigures

updated on `r Sys.Date()`

<!--Basic setup-->
```{r setup, echo=F}
knitr::opts_chunk$set(echo = TRUE, fig.pos = "H")
seed<-101
# families<-c(1,3:10,13,14,16:20)
source("mtime.R") #A function needed for caching
```

\newpage
# Descriptions of data \label{Description_data}
<!--Each data contributor writes one to a few paragraphs about their data.-->

## Soil C and N data  \label{SoilCN_data}

To explore the correlation of soil organic C and total soil N across a wide geographic range (conterminous
US), ecosystem type, and traceable methodology we used the RaCA (Rapid Carbon Assessment)
database [@Wills2014, **or Wills and Loecke pending???**]. Specifically, the soil organic C and total soil N
stocks (Mg C or N m$^{-2}$ ) to 1m of soil depth from the central pedon of the 5930 sites were included in this
study.

The raw data are shown in Figure \ref{fig_raw_cop_soilCN}(A). The copula is shown in Figure \ref{fig_raw_cop_soilCN}(B).

<!--The raw data look like this:-->
```{r load_data_Loecke, echo=F, results='hide'}
#fig.cap="Plot of the raw soil C and N data.\\label{fig_raw_cop_soilCN}(A)", fig.height=3, fig.width=3}
d<-readRDS("Data/RaCA_soilorganicC_soiltotalN_stocks100cm.RDS")
d<-d[,c("SOCstock100","TSNstock100")]
pdf("./Results/SoilCNraw.pdf")
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(d[,1],d[,2],type="p",col="red",xlab="Soil C",ylab="Soil N",cex.lab=1.5,cex.axis=1.5)
par(op)
dev.off()
```

<!--The copula looks like this:-->
```{r rankandplot_Loecke, echo=F, results='hide'}
source("getcopula.R")
#convert to a copula and plot
pdf("./Results/SoilCNcop.pdf")
v_CN<-getcopula(d=d,rankon=T,ploton=T) 
dev.off()
```

\begin{figure}[!h]
\textbf{ \hspace{5.5 cm} (A) \hspace{7 cm} (B)  } \\
\begin{center}
\includegraphics[width=3 in]{./Results/SoilCNraw.pdf}
\includegraphics[width=3 in]{./Results/SoilCNcop.pdf}
\caption[\textbf{(A)} Plot of the raw soil C and N data, \textbf{(B)} Copula plot of soil C and N data]{\textbf{(A)} Plot of the raw soil C and N data, \textbf{(B)} Copula plot of soil C and N data. Obtained by applying ranks separately to the C and N data, and then dividing the ranks by $n+1$ where $n = `r nrow(d)` $ is the number of sampling locations (see \nameref{MT-Model_selection} of manuscript).\label{fig_raw_cop_soilCN}}
\end{center}
\end{figure}

## BMR data  \label{BMR_data}

[**bmr-contrasts.csv**](https://github.com/sghosh89/BIVAN/blob/master/Data/BMR/bmr-contrasts.csv) : 
This contains the trait contrasts from phylogenetically independent contrasts [@SukumaranH2010] 
of data reported by [@GenoudIM2017] on the basal metabolic rate (BMR)
and mass of mammals species.
Specifically, the "SELECT" BMR data in their database were used for
 those species for which data were available.
A phylogeny in NEXUS [@NEXUS] format was extracted from the 
 supplementary information of [@GenoudIM2017].
Version 4.4.0 of the DendroPy library [@SukumaranH2010] was used to calculate 
  phylogenetic independent contrasts using Python 2.7.
For each contrast, the path length spanned by the contrast (sum of the branch
  lengths) and the contrast for the mass, natural logarithm of the BMR and natural
  logarithm of the mass were written as a row in the bmr-contrasts.csv file. 


```{r read_BMR_data, echo=FALSE, results="markup"}
set.seed(seed)
#---------------------------------------------------------
BMR_dat<-read.csv("./Data/BMR/bmr-contrasts.csv",header = T)
#class(BMR_dat)
knitr::kable(head(BMR_dat[,c(1,4,5)] ,3),format='pandoc',
             caption = "First few rows of raw BMR data.\\label{tab_rawdata_BMR}",
             booktabs=T) # display first few rows
```

Table \ref{tab_rawdata_BMR} displays the raw data for first few contrasts. The raw data are shown in Figure \ref{fig_raw_cop_BMR}(A). The copula [using absolute values of each column in Table \ref{tab_rawdata_BMR}] is shown in Figure \ref{fig_raw_cop_BMR}(B).

```{r plot_BMR_data, echo=FALSE, results="hide"}
set.seed(seed)
source("phylo_dat_fn.R")

# Generating raw data plot btw ln(mass) and BMR from bmr-contrasts.csv
pdf("./Results/BMR_results/rawdataplot_lnBMR_vs_lnmass.pdf")
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(BMR_dat$ln.mass,BMR_dat$ln.BMR,type="p",col="red",xlab="ln(mass) of contrasts",ylab="ln(BMR) of contrasts",
     cex.lab=1.5,cex.axis=1.5)
par(op)
dev.off()
#--------------------------------------------------------------------------------------------
# Generating copula plot btw ln(mass) and ln(BMR) from bmr-contrasts.csv
pdf("./Results/BMR_results/copula_lnBMR_vs_lnmass.pdf")
v_BMR<-phylo_dat_fn(data=BMR_dat,i=4,j=3,ploton = T) 
#plot(v_BMR[,1],v_BMR[,2],type="p",col="red",xlab="ln(mass)",ylab="BMR",
#     cex.lab=1.5,cex.axis=1.5)
dev.off()
```

\begin{figure}[!h]
\textbf{ \hspace{5.5 cm} (A) \hspace{7 cm} (B)  } \\
\begin{center}
\includegraphics[width=3 in]{./Results/BMR_results/rawdataplot_lnBMR_vs_lnmass.pdf}
\includegraphics[width=3 in]{./Results/BMR_results/copula_lnBMR_vs_lnmass.pdf}
\caption[\textbf{(A)} Plot of the raw ln(BMR) of contrasts vs. ln(mass) of contrasts \textbf{(B)} Copula plot for ln(BMR) vs. ln(mass) contrasts taken as their absolute values]{\textbf{(A)} Plot of the raw ln(BMR) of contrasts vs. ln(mass) of contrasts \textbf{(B)} Copula plot for absolute values of ln(BMR) vs. ln(mass) for all $`r nrow(v_BMR)`$ contrasts. Obtained by applying ranks separately to each variable, and then dividing the ranks by $n+1$ where $n=`r nrow(v_BMR)`$ is the number of contrasts (see \nameref{MT-Model_selection} of manuscript).\label{fig_raw_cop_BMR}}
\end{center}
\end{figure}

## Phylogenetic data : Anolis  \label{Phylo_data}

[**contrasts.csv**](https://github.com/sghosh89/BIVAN/blob/master/Data/Anolis/contrasts.csv) : 
Raw data on measurements of anatomical features of several species of *Anolis* lizards was downloaded
from the Dryad data package [@MahlerIRL2013Data] associated with
[@MahlerIRL2013].
The contrasts.csv file was produced by using version 4.4.0 of the DendroPy 
  library [@SukumaranH2010]  to calculate 
  phylogenetic independent contrasts on the the data in the GA_Anolis_traits.csv
  file of Mahler et at. using their maximum clade credibility tree (GA_Anolis_MCC.nex)
  as the phylogeny.

```{r read_phylo_data, echo=F, results="markup"}
set.seed(seed)
phylo_dat<-read.csv("./Data/Anolis/contrasts.csv",header = T)
#class(phylo_dat) #it's a data.frame
# no NA/missing value in this dataset
tab_phylo<-phylo_dat[,c(1,7,8)] 
knitr::kable(head(tab_phylo,3),format='pandoc',
             caption = "First few rows of raw phylo data.\\label{tab_rawdata_phylo}",
             booktabs=T) # display first few rows
```

Table \ref{tab_rawdata_phylo} displays the raw data for first few contrasts for two selective phylogenetic traits, namely, AVG.ltoe.IV (average length of fourth hindtoe) and AVG.humerus (average length of humerus). The raw data are shown in Figure \ref{fig_raw_cop_AVG_humerus_ltoe}(A). The copula [taking absolute values of each column in Table \ref{tab_rawdata_phylo}] is shown in Figure \ref{fig_raw_cop_AVG_humerus_ltoe}(B).


```{r plot_phylo_data, echo=F, results="hide"}
set.seed(seed)
source("phylo_dat_fn.R")
#----------------------------------------------------------------------------------------------------
# Generating all copula plots between different pathlength and traits 
pdf("./Results/Anolis_results/contrasts_csv_results/contrasts_csv_pathlength_traits_cop_plot.pdf",width=20, height = 20)
op<-par(mfrow=c(4,4))
i<-1
  for(j in c(1:13)){
    v_phylo<-phylo_dat_fn(data=phylo_dat,i=i,j=j,ploton = T)
    mtext(paste0(" [",i,",",j,"] ", ","," n=",dim(v_phylo)[1]),side = 3,col="blue")
  } 
par(op)
dev.off()
#------------------------------------------------------------------------------------------------------------
# Generating all 12 by 12 copula plots between different traits
pdf("./Results/Anolis_results/contrasts_csv_results/contrasts_csv_btw_traits_cop_plot.pdf",width=20, height = 20)
op<-par(mfrow=c(12,12))
for(i in c(2:13)){
  for(j in c(2:13)){
    v_phylo<-phylo_dat_fn(data=phylo_dat,i=i,j=j,ploton = T)
    mtext(paste0(" [",i,",",j,"] ", ","," n=",dim(v_phylo)[1]),side = 4,col="blue",line=0.01)
  } 
}
par(op)
dev.off()
#----------------------------------------------------------------------------------------
# Generating raw data plot btw AVG.ltoe.IV and AVG.humerus from contrasts.csv
pdf("./Results/Anolis_results/contrasts_csv_results/rawdataplot_AVG_ltoe_humerus.pdf")
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(phylo_dat$AVG.ltoe.IV,phylo_dat$AVG.humerus,type="p",col="red",xlab="contrasts for AVG.ltoe.IV",ylab="contrasts for AVG.humerus",
     cex.lab=1.5,cex.axis=1.5)
par(op)
dev.off()
#--------------------------------------------------------------------------------------------
# Generating copula plot btw AVG.ltoe.IV and AVG.humerus from contrasts.csv
pdf("./Results/Anolis_results/contrasts_csv_results/copula_AVG_ltoe_humerus.pdf")
v_contrasts_67<-phylo_dat_fn(data=phylo_dat,i=6,j=7,ploton = T)
dev.off()
```

\newpage 

\begin{figure}[!h]
\textbf{ \hspace{5.5 cm} (A) \hspace{7 cm} (B)  } \\
\begin{center}
\includegraphics[width=3 in]{./Results/Anolis_results/contrasts_csv_results/rawdataplot_AVG_ltoe_humerus.pdf}
\includegraphics[width=3 in]{./Results/Anolis_results/contrasts_csv_results/copula_AVG_ltoe_humerus.pdf}
\caption[\textbf{(A)} Plot of the contrasts for AVG.ltoe.IV vs. AVG.humerus phylogenetic traits. \textbf{(B)} Copula plot of contrasts for AVG.ltoe.IV vs. contrasts for AVG.humerus phylogenetic traits(taken as absolute values)]{\textbf{(A)} Plot of the contrasts for AVG.ltoe.IV vs. contrasts for AVG.humerus phylogenetic traits. \textbf{(B)} Copula plot of absolute values of contrasts for AVG.ltoe.IV vs. contrasts for AVG.humerus phylogenetic traits. Obtained by applying ranks separately to each variable, and then dividing the ranks by $n+1$ where $n=`r nrow(v_contrasts_67)`$ is the number of contrasts (see \nameref{MT-Model_selection} of manuscript). \label{fig_raw_cop_AVG_humerus_ltoe}}
\end{center}
\end{figure}

## Abundance data for the green spruce aphid and first flight date data for the leaf-curling plum aphid in the UK\label{Aphid_data}
   * Aphid data contains 3 measurements [count, firstflight, flight-duration] at 11 locations for 20 species and for 35 years.
   * We threw out all locations that had fewer than 30 years data. 
   * We use species=10 [Name : "Green spruce aphid"] for aphid-count data. 
   * We use species=11 [Name : "Leaf-curling plum aphid"] for aphid-firstflight data.   
   
## Abundance data for *Ceratium furca* in UK seas \label{Pns_data}
   * Plankton North sea dataset collects data at 26 locations for 22 species and for 56 years.
   * We threw out all locations that had fewer than 45 years data.
   * We use species=16 [Name : "Ceratium furca"] for Plankton_North_Sea data.
   * *Ceratium furca* is a dicoflagellate commonly found in UK seas.
   * note, when we edit this, we cannot call it the North Seas since data come also from other seas around the UK. 

## Methane-flux data  \label{Methane_data}

Methane ($CH_{4}$) fluxes between the soil or water surface and the troposphere were measured at the
Great Miami Wetland Mitigation Bank ($36^{\circ}46^{'}51^{''}$ N, $84^{\circ}20^{'}26^{''}$ W) in Trotwood, Montgomery County, Ohio. Additional information on the history of the site and soil types is detailed in @Jarecke2016. Briefly, the closed static flux chamber method was used [@Holland1999] to measure $CH_{4}$ fluxes at 28 locations across a hydrologic gradient (upland to seasonal wetland) at
daily to weekly interval from September 2015 to September 2016. **See and Smyth et al, pending for
additional details???** on greenhouse gas flux methods for this site.

* We threw out all locations that had fewer than 50 dates data.

```{r read_methane_data, echo=F, results="markup"}
set.seed(seed)
methane_raw<-readRDS("./Data/Methane_data/methane_data_for_Shyamolina.rds")
#class(methane_raw) #it's a data.frame for multivariable data
#knitr::kable(head(methane_raw,3),format='pandoc',
#             caption = "First few rows of raw methane data.\\label{tab_rawdata_methane}",
#             booktabs=T) # display first few rows
```


\newpage

# Testing non-parametric statistics for various symmetric and asymmetric copulas \label{Test_npa_stat}

Normal and Frank copula families 
are known to have symmetric tail dependence,
i.e., strengths of dependence in the lower and upper tails are the same, for all copulas
in these families [@nelsen2007_copula]. Clayton copulas are known to have stronger lower- than 
upper-tail dependence. And survival Clayton copulas, being rotations of Clayton copulas by 
$180^\circ$, have stronger upper- than lower tail dependence [@nelsen2007_copula].
Using the `iRho` function from the `copula` package, for each of the four families normal, 
Frank, Clayton, and survival Clayton, we obtained parameters for which the expected value of 
Spearman's $\rho$ was, separately, $0,0.1,0.2,...,0.9$. For each copula family and for each 
of the selected parameter values we generated  $n$ points, 100 times, and thereby computed 100 values of the 
statistics $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$. This exercise 
was repeated, separately, 
for $n=1000$ and for $n=35$, these cases being chosen, respectively, to reflect asymptotic behavior of the 
statistics and their behavior on the small datasets which are common in some fields
of ecology. The mean and standard error of the three difference statistics were computed for 
each copula family, parameter value, and value of $n$, and results were plotted against 
Spearman's rho (Figures \ref{fig_stat_testing35} and \ref{fig_stat_testing1000}), 
the expectation being that the difference statistics would be positive for 
Clayton copulas and negative for survival Clayton copulas (except for the case of $\rho=0$, a 
boundary case of these families corresponding to independence), and not significantly different 
from $0$ (we used a $t$-test with a significance threshold of $0.05$) for Frank and normal 
copulas. These expectations were fullfilled (Figures \ref{fig_stat_testing35} and 
\ref{fig_stat_testing1000}).

<!--The message=F and warning=F flags are to suppress warnings that come when you pass a parameter
of 0 to the Frank or Clayton copulas. These are technicallly boundary cases for these families.
They correspond to the independent copula. The packages we use provide the indepdent copula, but
issue a warning. Since anyway we want the independent copula, we can suppress the warning. We ran this
without the warning and it is OK to supress it.-->
<!-- The lines you are talking about appeared as message not as warning(actualy no warning appered for this chunk), so we have to set message=F here-->
```{r stat_testing_save_and_plot_result, message=F, results="hide", echo=F, cache=T, cache.extra=list(seed,mtime("TestStats_multivar_dataset.R"),mtime("CopulaFunctions.R"),mtime("CopulaFunctions_flexible.R"))}
source("TestStats_multivar_dataset.R")
set.seed(seed)

resultsloc<-"./Results/stat_results/stat_testing/"
spearvals<-seq(from=0,to=0.9,by=0.1)
callfn<-coplist_with_params(spearvals=spearvals)
coplist<-callfn$coplist
ncores<-3
res_pt35_rankF<-mclapply(X=coplist,FUN=worker,numpts=35,numsims=100,rank=F,mc.cores=ncores)
res_pt35_rankT<-mclapply(X=coplist,FUN=worker,numpts=35,numsims=100,rank=T,mc.cores=ncores)
res_pt1000_rankF<-mclapply(X=coplist,FUN=worker,numpts=1000,numsims=100,rank=F,mc.cores=ncores)
res_pt1000_rankT<-mclapply(X=coplist,FUN=worker,numpts=1000,numsims=100,rank=T,mc.cores=ncores)
save(res_pt35_rankF,res_pt35_rankT,res_pt1000_rankF,res_pt1000_rankT,file=paste(resultsloc,"StatTestNumericResults.RData",sep=''))

b<-callfn$paramlist
plotter_stat_testing(res_pt35_rankF,"res_pt35_rankF",b,resultsloc,spearvals)
plotter_stat_testing(res_pt35_rankT,"res_pt35_rankT",b,resultsloc,spearvals)
plotter_stat_testing(res_pt1000_rankF,"res_pt1000_rankF",b,resultsloc,spearvals)
plotter_stat_testing(res_pt1000_rankT,"res_pt1000_rankT",b,resultsloc,spearvals)
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/stat_results/stat_testing/res_pt35_rankT.pdf}
\caption[Testing non-parametric statistics with datapoints $n=35$]{Results of tests of whether $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$ reveal the known asymmetry of tail dependence of the Clayton and survival Clayton copulas, and the known symmetry of tail dependence for the normal and Frank copulas. See text for details. $n=35$. \label{fig_stat_testing35}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/stat_results/stat_testing/res_pt1000_rankT.pdf}
\caption[Testing non-parametric statistics with datapoints $n=1000$]{Results of tests of whether $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$ reveal the known asymmetry of tail dependence of the Clayton and survival Clayton copulas, and the known symmetry of tail dependence for the normal and Frank copulas. See text for details. $n=1000$.\label{fig_stat_testing1000}}
\end{center}
\end{figure}

<!--This r-chunk generates figure necessary for maintext Paper-->
```{r fig_stat_testing_for_maintext, message=F, results="hide", echo=F, cache=T, cache.extra=list(seed,mtime("TestStats_multivar_dataset.R"),mtime("CopulaFunctions.R"),mtime("CopulaFunctions_flexible.R"),mtime("StatTestNumericResults.RData"))}
set.seed(seed) 
source("fig_Paper_stat_testing.R")
#load("./Results/stat_results/stat_testing/StatTestNumericResults.RData")
resultsloc<-"./Results/stat_results/stat_testing/"

copname<-"C"
reslist<-res_pt35_rankT

statname<-"CorlmCoru"
call_fig_Paper_stat_testing(resultsloc=resultsloc,statname=statname,copname=copname,reslist=reslist, numsims=100)
statname<-"PlmPu"
call_fig_Paper_stat_testing(resultsloc=resultsloc,statname=statname,copname=copname,reslist=reslist, numsims=100)
statname<-"D2umD2l"
call_fig_Paper_stat_testing(resultsloc=resultsloc,statname=statname,copname=copname,reslist=reslist, numsims=100)
```

# Surrogate testing with bivariate datasets for non-parametric statistics \label{surrog_test}

For bivariate datasets, surrogates were produced as follows.   

- Given data $(x_i,y_i)$ for $i=1,\ldots,n$ and a 
one-parameter target copula family $\mathcal{B}(\theta)$ (here $\theta$ denotes the parameter), let $\tau$ be the
Kendall correlation of the $x_i$ with the $y_i$ and find the parameter value $\theta_\tau$ for which 
$\mathcal{B}(\theta_\tau)$ has Kendall correlation $\tau$ (this is possible for the one-parameter copula families of this 
study using the `iTau` function of the `VineCopula` package). 
- Generate data $(a_i,b_i)$, $i=1,\ldots,n$ from 
$\mathcal{B}(\theta_\tau)$. 
- Permute the ordered set $(x_1,\ldots,x_n)$ such that the permutation
$(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$ has $\rank(x_{\sigma_x(i)})$ equal to $\rank(a_i)$ for all $i$, where 
$\rank(x_{\sigma_x(i)})$ is the rank of $x_{\sigma_x(i)}$ in the set $(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$, and
$\rank(a_i)$ is the rank of $a_i$ in the set $(a_1,\ldots,a_n)$ (here $\sigma_x$ is a permutation of the 
indices $1,\ldots,n$). 
- Likewise permute $(y_1,\ldots,y_n)$
such that the permutation
$(y_{\sigma_y(1)},\ldots,y_{\sigma_y(n)})$ has $\rank(y_{\sigma_y(i)})$ equal to $\rank(b_i)$ for all $i$ ($\sigma_y$ is 
another permutation of $1,\ldots,n$).
- The surrogate dataset is $(x_{\sigma_x(i)},y_{\sigma_y(i)})$ for $i=1,\ldots,n$. 

Our code for this algorithm is [`copsurrog2d`](https://github.com/sghosh89/BIVAN/blob/master/copsurrog2d.R) in the 
[`BIVAN`](https://github.com/sghosh89/BIVAN) repository. 

Because $(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$ 
is a permutation of $(x_1,\ldots,x_n)$ and $(y_{\sigma_y(1)},\ldots,y_{\sigma_y(n)})$ is a 
permutation 
of $(y_1,\ldots,y_n)$, the marginal distributions of the surrogate data are exactly the same as 
those of the original data. 
Because ranks of the surrogate data are matched to ranks of the $a_i$ and $b_i$, the
Kendall correlation of the surrogate dataset will be the same as that of the $a_i$ and $b_i$, and therefore 
will be close to $\tau$ (differences arising only through sampling variation). If instead of $\theta_\tau$
a parameter value $\theta_\rho$ is used such that the Spearman correlation of $\mathcal{B}(\theta_\rho)$ is the same
as that of the $x_i$ with the $y_i$, then Spearman correlations of surrogates will very nearly equal (except for 
sampling variation) the Spearman correlation of the empirical data.  

<!--
# Question 1 analyses for each dataset
Recall that question 1 is: Do datasets in ecology and related fields have non-Gausian copula structure? Do they show tail dependence distinct from that of a Normal copula? In particular do they show asymmetric tail dependence?

## Details of methods \label{Method}
### Model selection approach \label{Model_selection}
### Non-parametric analysis of tail dependence \label{NPA}
moved to Paper.Rmd
-->

<!--
## Results: soil C and N data \label{Ex_SoilCN}
### Model selection approach \label{Ex_SoilCN_Model_selection} 
### Non-parametric analysis of tail dependence \label{Ex_SoilCN_NPA}
                    [[[[moved to Paper.Rmd]]]]
-->

<!--This chunk is for model selection results of soilCN dataset-->
```{r bivmodselect_Loecke, echo=F, cache=T, cache.extra=list(seed,v_CN,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("OurBiCopSelect.R")
set.seed(seed)
families_Loecke<-c(1,3:10,13:14,16:20) 
BivMS_res_Loecke<-OurBiCopSelect(u1=v_CN[,1],u2=v_CN[,2],families=families_Loecke,level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,gofnormal=F,status=F)
saveRDS(BivMS_res_Loecke,file="./Results/fitting_results/BivMS_soilCN.RDS")
```

<!--Display model selection results in a table-->
```{r tab_soilCNfit, echo=F, results="markup"}
#knitr::opts_knit$set(kable.force.latex = TRUE)
h<-BivMS_res_Loecke$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
knitr::kable(h, #longtable = T, 
             format = "pandoc",
      #caption.short = "Fitting info for soil C and N dataset",
      caption = "Fitting info for **soil C and N dataset**. Here and henceforth copula names are abbreviated as: N=normal (Gaussian); C=Clayton; G=Gumbel; F=Frank; J=Joe; SC=survival Clayton; SG=survival Gumbel; SJ=survival Joe. An S in front of one of the copulas BB1, BB6, BB7, BB8 indicates the survival version of that copula (rotation by $180^\\circ$).\\label{tab_soilCNfit}",
      booktabs = TRUE)
```

<!--This chunk is for npa testing results of soilCN dataset-->
```{r stat_soilCN_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,v_CN,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed) 
stat_soilCN_ga<-bivfunctionplot(v=v_CN,resloc="./Results/stat_results/stat_soilCN/",nametag="soilCN",numbin=10)
```
<!--****DAN: DAN suspects a bug in the code that generates this fig. because the red dot should appear outside the x's iff the text > 999 (or so,mething like that) appears in the bin, also check make_table_stat_fn r chunk-->

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/stat_results/stat_soilCN/soilCN_bivfunctionplot.pdf}
\caption[Testing non-parametric statistics for soilCN data]{Nonparametric tests for tail dependence and other deviations from a normal copula for \textbf{soil C and N data}. As described in \nameref{MT-Methods}, each statistic was computed on the data using the ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (red cross), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (blue and green cross show 0.025 and 0.975 quantiles of these results).  When red cross was outside blue and green cross, text at the top of plots indicates how many surrogate values the data value was less than or greater than. When $\cor$ values (respectively, $\Ps$ or $\Dsq$ values) were greater than surrogates, it means dependence in that part of the distributions was stronger than (respectively, stronger than or weaker than for $\Ps$ or $\Dsq$) expected from a normal-copula null hypothesis. \label{fig_soilCN_nonparam}}
\end{center}
\end{figure}

<!--Now make and display a table, this one about asymmetry of tail dependence-->
```{r make_table_stat_fn, echo=F}

fractxt<-function(fracval,numsurrog=1000){
  ptxt<-''
  if (fracval>.5*numsurrog){                        # ?DCR why 0.5 factor?
    ptxt<-paste(">",fracval,sep='')
  } 
  if (fracval<=.5*numsurrog){
    ptxt<-paste("<",numsurrog-fracval,sep='')
  }
  return(ptxt)
}

make_table_stat_fn<-function(data){
  
 #atdres<-data.frame(Statistic=c("$\\cor_{0,0.1}-\\cor_{0.9,1}$",
 #                               "$\\Ps_{0,0.1}-\\Ps_{0.9,1}$",
 #                               "$\\Dsq_{0.9,1}-\\Dsq_{0,0.1}$"),
 atdres<-data.frame(Statistic=c("$\\cor_\\text{first slice}-\\cor_\\text{last slice}$",
                               "$\\Ps_\\text{first slice}-\\Ps_\\text{last slice}$",
                                "$\\Dsq_\\text{last slice}-\\Dsq_\\text{first slice}$"),
                   Kendall=rep("",3),
                   Spearman=rep("",3),stringsAsFactors = F)
 
 atdres[1,2]<-fractxt(data$corlmcoru_frac_K)
 atdres[1,3]<-fractxt(data$corlmcoru_frac_S)
 atdres[2,2]<-fractxt(data$PlmPu_frac_K)
 atdres[2,3]<-fractxt(data$PlmPu_frac_S)
 atdres[3,2]<-fractxt(data$D2umD2l_frac_K)
 atdres[3,3]<-fractxt(data$D2umD2l_frac_S)

 return(atdres)
  
}
```


```{r tab_soilCN_asym,echo=F,results="markup"}
#knitr::opts_knit$set(kable.force.latex = TRUE)
tab_soilCN_asym<-make_table_stat_fn(data=stat_soilCN_ga)
knitr::kable(tab_soilCN_asym, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption = "**Soil CN data set results** for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis. Three statistics are listed in the left column that measured asymmetry of tail dependence by comparing the distribution ranges $0-0.1$ and $0.9-1$ (\\nameref{MT-Methods}). One thousand Kendall-preserving and 1000 Spearman-preserving surrogates with normal copula structure were created, and the same statistics were computed for the surrogates. A table entry $<N$ indicates the value of the given statistic on the data was less than its value on $N$ of the surrogates, so entries of the form $<X$ for $X$ equal to $975$ or above indicate that upper-tail dependence was significantly stronger than lower-tail dependence.\\label{tab_soilCN_asym}")
#kable_styling(, position = "float_left")
```



<!--
\newpage
## Results: BMR data \label{Ex_BMR}
### Model selection approach \label{Ex_BMR_Model_selection}
### Non-parametric analysis of tail dependence \label{Ex_BMR_NPA}
                  ----moved to Paper.Rmd----
-->

<!--This chunk is for model selection results of BMR data-->
```{r bivMS_BMR, echo=F, cache=T, cache.extra=list(seed,v_BMR,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
set.seed(seed) 
source("OurBiCopSelect.R")
#families<-c(1,3:10,13:14,16:20) 
BivMS_BMR<-OurBiCopSelect(u1=v_BMR[,1],u2=v_BMR[,2],families=c(1,3:10,13:14,16:20),
                          level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,gofnormal=F,status=F)
saveRDS(BivMS_BMR,file="./Results/BMR_results/BivMS_lnBMR_vs_lnmass.RDS")
```


<!--Display model selection results for BMR data in a table-->
```{r tab_BMRfit, echo=F, results='markup'}
h<-BivMS_BMR$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
knitr::kable(h,
             format='pandoc',
             caption = "Fitting info for **BMR dataset**. \\label{tab_BMRfit}",
             booktabs=T)
```

<!--This chunk is for npa testing results of BMR dataset-->
```{r stat_BMR_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,v_BMR,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed) 
# Now do NPA for v_BMR
source("bivfunctionplot.R")
stat_BMR_ga<-bivfunctionplot(v=v_BMR,resloc="./Results/BMR_results/",nametag="BMR_numbin_10",numbin = 10)
stat_BMR_ga_numbin5<-bivfunctionplot(v=v_BMR,resloc="./Results/BMR_results/",nametag="BMR_numbin_5",numbin = 5)
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/BMR_results/BMR_numbin_10_bivfunctionplot.pdf}
\caption[Testing non-parametric statistics for BMR data with $numbin=10$]{Nonparametric tests for tail dependence and other deviations from a normal copula for \textbf{BMR data}. As described in \nameref{MT-Methods}, each statistic was computed on the data using the ranges $0-0.1$, $0.1-0.2$, ..., $0.9-1$ (red cross), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (blue and green cross show 0.025 and 0.975 quantiles of these results).  When red cross was outside blue and green cross, text at the top of plots indicates how many surrogate values the data value was less than or greater than. \label{fig_BMR_nonparam}}
\end{center}
\end{figure}

<!--
\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/BMR_results/BMR_numbin_5_bivfunctionplot.pdf}
\caption[Testing non-parametric statistics for BMR data with $numbin=5$]{Nonparametric tests for tail dependence and other deviations from a normal copula for BMR data. As described in \nameref{MT-Methods}, each statistic was computed on the data using the ranges $0-0.2$, $0.2-0.4$, ..., $0.8-1$ (red lines), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (dashed lines show 0.025 and 0.975 quantiles of these results and dotted lines show 0.005 and 0.995 quantiles). \label{fig_BMR_nonparam5}}
\end{center}
\end{figure}
-->

```{r tab_BMR_asym, echo=F, results="markup"}
tab_BMR_asym<-make_table_stat_fn(data=stat_BMR_ga)
tab_BMR_asym_numbin5<-make_table_stat_fn(data=stat_BMR_ga_numbin5)

knitr::kable(tab_BMR_asym,
             format="pandoc",
             caption = "**BMR data set results** for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis. \\label{tab_BMR_asym}",
             booktabs=T)

#knitr::kable(tab_BMR_asym_numbin5,
#             format="pandoc",
#             caption = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis (best fit is here Frank with symmetric tail dep)?, numbin=5 \\label{tab_BMR_asym_numbin5}",
#             booktabs=T)
```

<!--
\newpage
## Results: contrasts.csv data \label{Ex_contrasts}
### Model selection approach \label{Ex_contrasts_Model_selection}
### Non-parametric analysis of tail dependence \label{Ex_contrasts_67_NPA}
                 ----moved to Paper.Rmd----
-->

<!--This chunk is for model selection results of anolis data-->
```{r bivMS_contrasts_67, echo=F, cache=T, cache.extra=list(seed,v_contrasts_67,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
set.seed(seed)
# Now do Model Selection for [i,j]=[6,7]
# 6 : AVG. ltoe.IV
# 7 : AVG. humerus
source("OurBiCopSelect.R")
families<-c(1,3:10,13:14,16:20)
BivMS_contrasts_67<-OurBiCopSelect(u1=v_contrasts_67[,1],u2=v_contrasts_67[,2],families=families,
                          level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,
                          gofnormal=F,status=F)
saveRDS(BivMS_contrasts_67,file="./Results/Anolis_results/contrasts_csv_results/BivMS_contrasts_67.RDS")
```

\newpage
<!--Display model selection results for contrasts data in a table-->
```{r tab_contrasts_67fit, echo=F, results='markup'}
h<-BivMS_contrasts_67$InfCritRes[,c("copname","AICw","BICw","LTdep","UTdep")]
knitr::kable(h,
             format='pandoc',
             caption = "Fitting info for **Anolis data set** with contrasts for AVG.ltoe.IV and AVG.humerus phylogenetic traits. \\label{tab_contrasts_67fit}",
             booktabs=T)
```

<!--This chunk is for npa testing results of anolis dataset-->
```{r stat_contrasts_67_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,v_contrasts_67,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}   
source("bivfunctionplot.R")  
set.seed(seed) 
# Now do NPA for v_contrasts_67 with numbin=4
stat_contrasts_67_ga<-bivfunctionplot(v=v_contrasts_67,resloc="./Results/Anolis_results/contrasts_csv_results/",
                                      nametag="contrasts_67",numbin = 4) 
``` 

```{r stat_contrasts_67_graphic_approach2, echo=F, results="hide", cache=T, cache.extra=list(seed,v_contrasts_67,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed) 
# Now do NPA for v_contrasts_67

stat_contrasts_67_ga_numbin2<-bivfunctionplot(v=v_contrasts_67,
                            resloc="./Results/Anolis_results/contrasts_csv_results/",
                            nametag="contrasts_67_numbin2",numbin = 2)

stat_contrasts_67_ga_numbin3<-bivfunctionplot(v=v_contrasts_67,
                            resloc="./Results/Anolis_results/contrasts_csv_results/",
                            nametag="contrasts_67_numbin3",numbin = 3)

stat_contrasts_67_ga_numbin5<-bivfunctionplot(v=v_contrasts_67,
                            resloc="./Results/Anolis_results/contrasts_csv_results/",
                            nametag="contrasts_67_numbin5",numbin = 5)

stat_contrasts_67_ga_numbin6<-bivfunctionplot(v=v_contrasts_67,
                            resloc="./Results/Anolis_results/contrasts_csv_results/",
                            nametag="contrasts_67_numbin6",numbin = 6)

stat_contrasts_67_ga_numbin7<-bivfunctionplot(v=v_contrasts_67,
                            resloc="./Results/Anolis_results/contrasts_csv_results/",
                            nametag="contrasts_67_numbin7",numbin = 7)

stat_contrasts_67_ga_numbin10<-bivfunctionplot(v=v_contrasts_67,
                            resloc="./Results/Anolis_results/contrasts_csv_results/",
                            nametag="contrasts_67_numbin10",numbin = 10)
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Anolis_results/contrasts_csv_results/contrasts_67_bivfunctionplot.pdf}
\caption[Testing non-parametric statistics for anolis data]{Nonparametric tests for tail dependence and other deviations from a normal copula for anolis data. As described in \nameref{MT-Methods}, each statistic was computed on the data using the ranges $0-0.25$, $0.25-0.5$, $0.5-0.75$, $0.75-1$ for $4$ number of bins (red cross), and was also computed using the same ranges for 1000 normal-copula surrogate datasets (blue and green cross show 0.025 and 0.975 quantiles of these results). \label{fig_contrasts_67_nonparam}}
\end{center}
\end{figure}



```{r tab_contrasts_67_asym, echo=F, results="markup"}
tab_contrasts_67_asym<-make_table_stat_fn(data=stat_contrasts_67_ga)
knitr::kable(tab_contrasts_67_asym,
             format="pandoc",
             caption = "**Anolis data set results** for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis \\label{tab_contrasts_67_asym}",
             booktabs=T)
```


<!--
This chunks are just to see the tables for all numbin variation for anolis data set: It appears that numbin=4 is optimized, when numbin=2, >= 7, there is no significant asymetry in tail dep in all 3 types of stats.

```{r tab_contrasts_67_asym67_numbin2, echo=F, results="markup"}
#tab_contrasts_67_asym2<-make_table_stat_fn(data=stat_contrasts_67_ga_numbin2)
#knitr::kable(tab_contrasts_67_asym2,
#            format="pandoc",
#             caption = "numbin_2,anolis \\label{tab_contrasts_67_asym2}",
#             booktabs=T)
```

```{r tab_contrasts_67_asym67_numbin3, echo=F, results="markup"}
#tab_contrasts_67_asym3<-make_table_stat_fn(data=stat_contrasts_67_ga_numbin3)
#knitr::kable(tab_contrasts_67_asym3,
#             format="pandoc",
#             caption = "numbin_3,anolis \\label{tab_contrasts_67_asym3}",
#             booktabs=T)
```

```{r tab_contrasts_67_asym67_numbin5, echo=F, results="markup"}
#tab_contrasts_67_asym5<-make_table_stat_fn(data=stat_contrasts_67_ga_numbin5)
#knitr::kable(tab_contrasts_67_asym5,
#            format="pandoc",
#             caption = "numbin_5,anolis \\label{tab_contrasts_67_asym5}",
#             booktabs=T)
```


```{r tab_contrasts_67_asym67_numbin6, echo=F, results="markup"}
#tab_contrasts_67_asym6<-make_table_stat_fn(data=stat_contrasts_67_ga_numbin6)
#knitr::kable(tab_contrasts_67_asym6,
#             format="pandoc",
#             caption = "numbin_6,anolis \\label{tab_contrasts_67_asym6}",
#             booktabs=T)
```

```{r tab_contrasts_67_asym67_numbin7, echo=F, results="markup"}
#tab_contrasts_67_asym7<-make_table_stat_fn(data=stat_contrasts_67_ga_numbin7)
#knitr::kable(tab_contrasts_67_asym7,
#             format="pandoc",
#             caption = "numbin_7,anolis \\label{tab_contrasts_67_asym7}",
#             booktabs=T)
```

```{r tab_contrasts_67_asym67_numbin10, echo=F, results="markup"}
#tab_contrasts_67_asym10<-make_table_stat_fn(data=stat_contrasts_67_ga_numbin10)
#knitr::kable(tab_contrasts_67_asym10,
#             format="pandoc",
#             caption = "numbin_10,anolis \\label{tab_contrasts_67_asym10}",
#             booktabs=T)
```

-->

<!--
\newpage
## Results: abundance data for the green spruce aphid, *Elatobium abietinum* \label{Ex_count}
### Model selection approach \label{Ex_count_Model_selection}
### Non-parametric analysis of tail dependence \label{Ex_count_NPA}
                  ----moved to Paper.Rmd----
-->

<!--Load the raw data-->
```{r read_aphid_data, echo=F}
source("aphid_data_calling.R")

# Aphid raw data for count
d0_count<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtscount141117.csv",header=F))
data_aphid_count<-d_allsp_data(d0_count)     
 
# Aphid raw data for first flight
d0_firstflight<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsfirstflight141117.csv",header=F))
data_aphid_ff<-d_allsp_data(d0_firstflight) 

# Aphid raw data for flight duration   
#d0_flightduration<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsflightduration141117.csv",header=F))
```

<!--Do the model selection for aphid count data and then showing results in Tables-->
```{r RES_aphid_count, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file
set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_aphid_count<-RES_single_sp(d_allsp=data_aphid_count,sp=10,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30)
#cat(paste("stop-time: ",Sys.time(),"\n"))
resloc<-"./Results/fitting_results/"
saveRDS(RES_aphid_count,paste(resloc,file="AphidCopulaFit_selecloc_count_species_10.RDS",sep=""))
```

```{r tab_count_bestcop, echo=F, results="markup"}
#library(dplyr)
#knitr::opts_knit$set(kable.force.latex = TRUE)
knitr::kable(RES_aphid_count$info_ord_copname[,,1], #longtable = T,
             format='pandoc',
             #caption.short = "Best-fitting copulas for each location pair from among those considered, according to AIC, for abundances of the green spruce aphid.",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for **abundances of the green spruce aphid**. Copulas 
considered were the normal, Clayton, Gumbel, Frank, Joe, BB1, BB6, BB7, BB8, survival Clayton, survival Gumbel, 
survival Joe, survival BB1, survival BB6, survival BB7, survival BB8 copulas. Abbreviations were given in \\nameref{MT-Methods}. NA occurs along the diagonal of the matrix because the diagonal represents a sampling location compared to itself.\\label{tab_count_bestcop}",
             booktabs=TRUE
             )#%>% # only with 'latex'/'html' format
 # kableExtra::kable_styling(latex_options = c("striped","HOLD_position"))
```

```{r tab_count_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$info_ord_AICw[,,1], 
             format='pandoc',
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for **abundances of the green spruce aphid**.\\label{tab_count_AICw}",
             booktabs=TRUE
             )
```

```{r tab_count_AICw_normal, echo=F, results='markup'}
source("normal_cop_AICw.R")
knitr::kable(normal_cop_AICw_matrix(r=RES_aphid_count),
             format='pandoc',
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for **abundances of the green spruce aphid**, for comparison with Table \\ref{tab_count_AICw}. \\label{tab_count_AICw_normal}",
             booktabs=TRUE
             )
```

```{r tab_count_p_CvM, echo=F, results='markup'}
knitr::kable(RES_aphid_count$gfc_p_CvM,
             format='pandoc',
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **abundances of the green spruce aphid**. Tests were based on bootstrapping as described in Methods.\\label{tab_count_p_CvM}",
             booktabs=TRUE
             )
```

```{r tab_count_p_KS, echo=F, results='markup'}
knitr::kable(RES_aphid_count$gfc_p_KS,
             format='pandoc',
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **abundances of the green spruce aphid**. Tests were based on bootstrapping as described in Methods.\\label{tab_count_p_KS}",
             booktabs=TRUE
             )
```

```{r tab_count_LTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$LTdep_AICw,
             format='pandoc',
             caption = "Model-averaged lower tail dependence statistic for each location pair for **abundances of the green spruce aphid**.\\label{tab_count_LTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_count_UTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$UTdep_AICw,
             format='pandoc',
             caption = "Model averaged upper tail dependence statistic for each location pair for **abundances of the green spruce aphid**.\\label{tab_count_UTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_count_LTmUT, echo=F, results='markup'}
knitr::kable(RES_aphid_count$LTdep_AICw-RES_aphid_count$UTdep_AICw,
             digits = 5,
             format='pandoc',
             caption = "Model averaged lower tail dependence minus model averaged upper tail dependence statistic for each location pair for **abundances of the green spruce aphid**.\\label{tab_count_LTmUT}",
             booktabs=TRUE
             )
```

<!--Do the main computations for non-parametric analysis of aphid count data-->
```{r stat_aphid_count, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed) 
resloc<-"./Results/stat_results/stat_aphid_count/"

sp<-10
good_loc <- good_loclist(d_allsp=data_aphid_count,sp=sp,data_pt_thrs=30)
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_count<-multcall(d_allsp=data_aphid_count,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc)
saveRDS(stat_aphid_count,paste(resloc,file="stat_aphid_count_sp_10.RDS",sep='')) 
```

<!--Show the statistical results in a table-->
```{r tab_count_resamp,echo=F,results="markup"}
s<-stat_aphid_count$numericdf[,c(3,2,4)]
colnames(s)<-c("Lower 95\\% CI", "Mean", "Upper 95\\% CI")
rownames(s)<-c("Spearman","Kendall","$\\cor_l$","$\\cor_u$","$\\Ps_l$","$\\Ps_u$","$\\Dsq_l$","$\\Dsq_u$","$\\cor_l - \\cor_u$","$\\Ps_l - \\Ps_u$","$\\Dsq_u - \\Dsq_l$")
knitr::kable(s,
             format = "pandoc",
             caption = "Spatially averaged values of statistics and confidence intervals based on resampling for **abundances of the green spruce aphid**.\\label{tab_count_resamp}",
             booktabs=TRUE)
```

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_D2u-D2l_vs_D.pdf}
\caption[Non-parametric tail statistics results for green spruce aphid abundance data]{Non-parametric tail statistics results for green spruce aphid abundance data plotted against geographical distance ($D$) between two sampling locations. (A) Spearman correlation vs. $D$; (B) Kendall correlation vs. $D$; (C) $\cor_l$ vs. $D$; (D) $\cor_u$ vs. $D$; (E) $\Ps_l$ vs. $D$; (F) $\Ps_u$ vs. $D$; (G) $\Dsq_u$ vs. $D$; 
(H) $\Dsq_l$ vs. $D$; 
(I) $\cor_l-\cor_u$ vs. $D$, (J) $\Ps_l-\Ps_u$ vs. $D$, (K) $\Dsq_u-\Dsq_l$ vs. $D$ plotted for all 
pairs of locations. \label{fig_aphid_count}}
\end{center}
\end{figure}

<!--
\newpage
## Results: first flight date data for the leaf-curling plum aphid, *Brachycaudus helichrysi* \label{Ex_ff}
### Model selection approach \label{Ex_ff_Model_selection}
### Non-parametric analysis of tail dependence  \label{Ex_ff_NPA}
                          ----moved to Paper.Rmd----
-->

<!--Do the model selection for aphid ff data and then showing results in Tables-->
```{r RES_aphid_ff, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file
set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n"))
RES_aphid_ff<-RES_single_sp(d_allsp=data_aphid_ff,sp=11,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30)
#cat(paste("stop-time: ",Sys.time(),"\n")) 
resloc<-"./Results/fitting_results/"
saveRDS(RES_aphid_ff,paste(resloc,file="AphidCopulaFit_selecloc_firstflight_species_11.RDS",sep=""))
```

```{r tab_ff_bestcop, echo=F, results="markup"}
knitr::kable(RES_aphid_ff$info_ord_copname[,,1], #longtable = T,
             format='pandoc',
             #caption.short = "Best-fitting copulas for each location pair from among those considered, according to AIC, for first flight data for the leaf-curling plum aphid.",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for **first flight data for the leaf-curling plum aphid**. Copulas considered were as in Table \\ref{tab_count_bestcop}, with abbreviations given in \\nameref{MT-Methods}. NA occurs along the diagonal of the matrix because the diagonal represents a sampling location compared to itself.  \\label{tab_ff_bestcop}",
             booktabs=TRUE
             )
```

```{r tab_ff_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$info_ord_AICw[,,1], 
             format='pandoc',
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_AICw}",
             booktabs=TRUE
             )
```

```{r tab_ff_AICw_normal, echo=F, results='markup'}
source("normal_cop_AICw.R")
knitr::kable(normal_cop_AICw_matrix(r=RES_aphid_ff),
             format='pandoc',
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for **first flight data for the leaf-curlung plum aphid**, for comparison with Table \\ref{tab_ff_AICw}.\\label{tab_ff_AICw_normal}",
             booktabs=TRUE
             )
```

\newpage
```{r tab_ff_p_CvM, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$gfc_p_CvM,
             format='pandoc',
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **first flight data for the leaf-curling plum aphid**. Tests were based on bootstrapping as described in Methods.\\label{tab_ff_p_CvM}",
             booktabs=TRUE
             )
```

```{r tab_ff_p_KS, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$gfc_p_KS,
             format='pandoc',
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **first flight data for the leaf-curling plum aphid**. Tests were based on bootstrapping as described in Methods.\\label{tab_ff_p_KS}",
             booktabs=TRUE
             )
```

```{r tab_ff_LTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$LTdep_AICw,
             format='pandoc',
             caption = "Model-averaged lower tail dependence statistic for each location pair for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_LTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_ff_UTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$UTdep_AICw,
             format='pandoc',
             caption = "Model-averaged upper tail dependence statistic for each location pair for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_UTdep_AICw}",
             booktabs=TRUE
             )
```

```{r tab_ff_LTmUT, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$LTdep_AICw-RES_aphid_ff$UTdep_AICw,
             digits = 5,
             format='pandoc',
             caption = "Model averaged lower tail dependence minus model averaged upper tail dependence statistic for each location pair for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_LTmUT}",
             booktabs=TRUE
             )
```

<!--Do the main computations for non-parametric analysis of aphid ff data-->
```{r stat_aphid_ff, echo=F, cache=T,  cache.extra=list(seed,data_aphid_ff,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed)
resloc<-"./Results/stat_results/stat_aphid_ff/"

sp<-11
good_loc<-good_loclist(d_allsp=data_aphid_ff,sp=sp,data_pt_thrs=30)
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_ff<-multcall(d_allsp=data_aphid_ff,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc) 
saveRDS(stat_aphid_ff,paste(resloc,file="stat_aphid_ff_sp_11.RDS",sep='')) 
```

<!--display the main statistical results in a table-->
```{r tab_ff_resamp,echo=F,results="markup"}
s<-stat_aphid_ff$numericdf[,c(3,2,4)]
colnames(s)<-c("Lower 95\\% CI", "Mean", "Upper 95\\% CI")
rownames(s)<-c("Spearman","Kendall","$\\cor_l$","$\\cor_u$","$\\Ps_l$","$\\Ps_u$","$\\Dsq_l$","$\\Dsq_u$","$\\cor_l - \\cor_u$","$\\Ps_l - \\Ps_u$","$\\Dsq_u - \\Dsq_l$")
knitr::kable(s,
             format = "pandoc",
             caption = "Spatially averaged values of statistics and confidence intervals based on resampling for **first flight data for the leaf-curling plum aphid**.\\label{tab_ff_resamp}",
             booktabs=TRUE)
```

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_D2u-D2l_vs_D.pdf}
\caption[Non-parametric tail statistics results for leaf-curling plum aphid's first flight date data]{Non-parametric tail statistics results for leaf-curling plum aphid's first flight date data plotted against geographical distance $(D)$ between two sampling locations. (A) Spearman correlation vs. $D$, (B) Kendall correlation vs. $D$, (C) $\cor_l$ vs. $D$, (D) $\cor_u$ vs. $D$; (E) $\Ps_l$ vs. $D$; (F) $\Ps_u$ vs. $D$; (G) $\Dsq_u$ vs. $D$; (H) $\Dsq_l$ vs. $D$; (I) $\cor_l-\cor_u$ vs. $D$; (J) $\Ps_l-\Ps_u$ vs. $D$; (K) $\Dsq_u-\Dsq_l$ vs. $D$ plotted for all pairs of locations. \label{fig_aphid_ff}}
\end{center}
\end{figure}

<!--
\newpage
## Results: abundance data for *Ceratium furca* in UK seas \label{Ex_pns}
### Model selection approach \label{Ex_pns_Model_selection}
### Non-parametric analysis of tail dependence  \label{Ex_pns_NPA}
                          ----moved to Paper.Rmd----
-->

<!--Load the data-->
```{r read_plankton_north_sea_data, echo=F}
source("plankton_north_sea_data_calling.R")
d0_plankton_north_sea<-as.matrix(read.csv("./Data/Plankton_North_Sea_data/planktontimeseries201117_4.csv",header=F))
data_plankton_north_sea<-d_allsp_data_plankton_north_sea(d0_plankton_north_sea)
``` 

<!--Do the model selection for plankton data and then showing results in Tables-->
```{r RES_plankton_north_sea, echo=F, cache=T, results="hide", cache.extra=list(seed,data_plankton_north_sea,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file

set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_plankton_north_sea<-RES_single_sp(d_allsp=data_plankton_north_sea,sp=16,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=45)
#cat(paste("stop-time: ",Sys.time(),"\n"))    
resloc<-"./Results/fitting_results/"
saveRDS(RES_plankton_north_sea,paste(resloc,file="Plankton_North_Sea_CopulaFit_selecloc_species_16.RDS",sep=""))
```

```{r tab_pns_bestcop, echo=F, results="markup"}
knitr::kable(RES_plankton_north_sea$info_ord_copname[,,1], #longtable=T,
             format='pandoc', 
             #caption.short = "Best-fitting copulas for each location pair from among those considered, according to AIC, for abundance data for \\textit{Ceratium furca} in UK seas.",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for **abundance data for \\textit{Ceratium furca} in UK seas**. See \\nameref{MT-Methods} for copula abbreviations. NA occurs along the diagonal because diagonal entries represent a sampling location compared to itself.\\label{tab_pns_bestcop}",
             booktabs=TRUE
             )
```

```{r tab_pns_AICw,echo=F,results="markup"}
h<-RES_plankton_north_sea$info_ord_AICw[,,1]
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_AICw}",
             booktabs=TRUE)
```

```{r tab_pns_AICw_normal,echo=F,results="markup"}
source("normal_cop_AICw.R")
h<-normal_cop_AICw_matrix(r=RES_plankton_north_sea)
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_AICw_normal}",
             booktabs=TRUE)
```

```{r tab_pns_p_CvM,echo=F,results="markup"}
h<-RES_plankton_north_sea$gfc_p_CvM
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **abundance data for *Ceratium furca* in UK seas**. Tests were based on bootstrapping as described in Methods.\\label{tab_pns_p_CvM}",
             booktabs=TRUE)
```

```{r tab_pns_p_KS,echo=F,results="markup"}
h<-RES_plankton_north_sea$gfc_p_KS
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of
the goodness of fit of the lowest-AIC copula family for each pair of
locations for **abundance data for *Ceratium furca* in UK seas**. Tests
were based on bootstrapping as described in Methods.\\label{tab_pns_p_KS}",
             booktabs=TRUE)
```

```{r tab_pns_LTdep_AICw,echo=F,results="markup"}
h<-RES_plankton_north_sea$LTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "Model-averaged lower tail dependence statistic for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_LTdep_AICw}",
             booktabs=TRUE)
```

```{r tab_pns_UTdep_AICw,echo=F,results="markup"}
h<-RES_plankton_north_sea$UTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "Model-averaged upper tail dependence statistic for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_UTdep_AICw}",
             booktabs=TRUE)
```

```{r tab_pns_LTmUT,echo=F,results="markup"}
h<-RES_plankton_north_sea$LTdep_AICw-RES_plankton_north_sea$UTdep_AICw
h[is.nan(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "Model averaged lower tail dependence minus model
averaged upper tail dependence statistic for each location pair for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_LTmUT}",
             booktabs=TRUE)
```

<!--Do the main computations for non-parametric analysis of plankton data-->
```{r stat_plankton_north_sea, echo=F, cache=T, cache=T,  cache.extra=list(seed,data_plankton_north_sea,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed)
resloc<-"./Results/stat_results/stat_plankton_north_sea/"

sp<-16
good_loc<-good_loclist(d_allsp=data_plankton_north_sea,sp=sp,data_pt_thrs=45)
longs<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlongs201117.csv",header=F)
lats<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlats201117.csv",header=F)
longs<-longs[[1]] 
lats<-lats[[1]]

stat_plankton_north_sea<-multcall(d_allsp=data_plankton_north_sea,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc) 
saveRDS(stat_plankton_north_sea,paste(resloc,file="stat_plankton_north_sea_sp_16.RDS",sep=''))
```

<!--display the main statistical results in a table-->
```{r tab_pns_resamp,echo=F,results="markup"}
s<-stat_plankton_north_sea$numericdf[,c(3,2,4)]
colnames(s)<-c("Lower 95\\% CI", "Mean", "Upper 95\\% CI")
rownames(s)<-c("Spearman","Kendall","$\\cor_l$","$\\cor_u$","$\\Ps_l$","$\\Ps_u$","$\\Dsq_l$","$\\Dsq_u$","$\\cor_l - \\cor_u$","$\\Ps_l - \\Ps_u$","$\\Dsq_u - \\Dsq_l$")
knitr::kable(s,
             format = "pandoc",
             caption = "Spatially averaged values of statistics and confidence intervals based on resampling for **abundance data for *Ceratium furca* in UK seas**.\\label{tab_pns_resamp}",
             booktabs=TRUE)
```

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_D2u-D2l_vs_D.pdf}
\caption[Non-parametric tail statistics results for \textit{Ceratium furca} abundance data]{Non-parametric tail statistics results for \textit{Ceratium furca} abundance data plotted against geographical distance $(D)$ between two sampling locations. (A) Spearman correlation vs. $D$, (B) Kendall correlation vs. $D$, (C) $\cor_l$ vs. $D$, (D) $\cor_u$ vs. $D$; (E) $\Ps_l$ vs. $D$; (F) $\Ps_u$ vs. $D$; (G) $\Dsq_u$ vs. $D$; (H) $\Dsq_l$ vs. $D$; (I) $\cor_l-\cor_u$ vs. $D$; (J) $\Ps_l-\Ps_u$ vs. $D$; (K) $\Dsq_u-\Dsq_l$ vs. $D$ plotted for all pairs of locations. \label{fig_pns}}
\end{center}
\end{figure}


<!--***DAN: stopped here 2018 04 07-->

<!--
\newpage
## Results: methane flux data \label{Ex_methane}
### Model selection approach \label{Ex_methane_Model_selection}
### Non-parametric analysis of tail dependence  \label{Ex_methane_NPA}
                 ----moved to Paper.Rmd----
-->

<!--Load and format the data-->
```{r read_format_methane_data, echo=F}

methane_raw<-readRDS("./Data/Methane_data/methane_data_for_Shyamolina.rds")

myls <- vector("list", length = dim(methane_raw)[2]-1)
for(i in 2:dim(methane_raw)[2]){
  temp<-methane_raw[,c(1,i)]
  colnames(temp)<-c("Year","Dat")
  myls[[i-1]]<-temp
}
methane_data<-list(myls=myls)
``` 

<!--Do the main analysis-->
```{r RES_methane, echo=F, cache=T, results="hide", cache.extra=list(seed,methane_data,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file

set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_methane<-RES_single_sp(d_allsp=methane_data,sp=1,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=50)
#cat(paste("stop-time: ",Sys.time(),"\n"))    
resloc<-"./Results/fitting_results/"
saveRDS(RES_methane,paste(resloc,file="MethaneFluxFit_selecloc_data_pt_thrs_50.RDS",sep=""))
```

```{r tab_methane_bestcop, echo=F, results="markup"}
knitr::kable(RES_methane$info_ord_copname[,,1], #longtable=T,
             format='pandoc',
             #caption.short = "Best-fitting copulas for each location pair from among those considered, according to AIC, for methane-flux data.",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for **methane-flux data**. See \\nameref{MT-Methods} for copula abbreviations. NA occurs along the diagonal because diagonal entries represent a sampling location compared to itself.\\label{tab_methane_bestcop}",
             booktabs=TRUE
             )
```

```{r tab_methane_AICw,echo=F,results="markup"}
h<-RES_methane$info_ord_AICw[,,1]
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for **methane-flux data**.\\label{tab_methane_AICw}",
             booktabs=TRUE)
```

```{r tab_methane_AICw_normal,echo=F,results="markup"}
source("normal_cop_AICw.R")
h<-normal_cop_AICw_matrix(r=RES_methane)
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for **methane-flux data**.\\label{tab_methane_AICw_normal}",
             booktabs=TRUE)
```

```{r tab_methane_p_CvM,echo=F,results="markup"}
h<-RES_methane$gfc_p_CvM
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for **methane-flux data**. Tests were based on bootstrapping as described in Methods.\\label{tab_methane_p_CvM}",
             booktabs=TRUE)
```

```{r tab_methane_p_KS,echo=F,results="markup"}
h<-RES_methane$gfc_p_KS
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of
the goodness of fit of the lowest-AIC copula family for each pair of
locations for **methane-flux data**. Tests were based on bootstrapping as described in Methods.\\label{tab_methane_p_KS}",
             booktabs=TRUE)
```

```{r tab_methane_LTdep_AICw,echo=F,results="markup"}
h<-RES_methane$LTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "Model-averaged lower tail dependence statistic for each location pair for **methane-flux data**.\\label{tab_methane_LTdep_AICw}",
             booktabs=TRUE)
```

```{r tab_methane_UTdep_AICw,echo=F,results="markup"}
h<-RES_methane$UTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "Model-averaged upper tail dependence statistic for each location pair for **methane-flux data**.\\label{tab_methane_UTdep_AICw}",
             booktabs=TRUE)
```

```{r tab_methane_LTmUT,echo=F,results="markup"}
h<-RES_methane$LTdep_AICw-RES_methane$UTdep_AICw
h[is.nan(h)]<-NA
knitr::kable(h,
             format="pandoc",
             digits=3,
             caption = "Model averaged lower tail dependence minus model
averaged upper tail dependence statistic for each location pair for **methane-flux data**.\\label{tab_methane_LTmUT}",
             booktabs=TRUE)
```

<!--Do the main computations for non-parametric analysis of methane-flux data-->
```{r stat_methane, echo=F, cache=T, cache=T,  cache.extra=list(seed,methane_data,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed)
resloc<-"./Results/stat_results/stat_methane/"

data_pt_thrs<-50
good_loc <- good_loclist(d_allsp=methane_data,sp=1,data_pt_thrs=data_pt_thrs)

latlon<-readRDS("./Data/Methane_data/chamberLocations.rds")
chamber_name<-colnames(methane_raw[,c(2:dim(methane_raw)[2])])
ndim<-length(chamber_name)

latlon_arranged<-data.frame(chamber_name=chamber_name,lat=NA*numeric(ndim),lon=NA*numeric(ndim))
for(i in 1:ndim){
  if (chamber_name[i] %in% latlon$chamber){
    ind<-which(latlon$chamber==chamber_name[i])
    latlon_arranged[i,2:3]<-unname(latlon[ind,2:3])
  }
}

stat_methane<-multcall(d_allsp=methane_data,sp=1,lats=latlon_arranged$lat,longs=latlon_arranged$lon,
                           pfname=paste(resloc,"data_pt_thrs",data_pt_thrs,sep=''),good_loc=good_loc)

saveRDS(stat_methane,paste(resloc,file="stat_methane.RDS",sep='')) 
```

```{r read_stat_methane,echo=F}
stat_methane<-readRDS("./Results/stat_results/stat_methane/stat_methane.RDS")
```

<!--display the main statistical results in a table-->
```{r tab_methane_resamp,echo=F,results="markup"}
s<-stat_methane$numericdf[,c(3,2,4)]
colnames(s)<-c("Lower 95\\% CI", "Mean", "Upper 95\\% CI")
rownames(s)<-c("Spearman","Kendall","$\\cor_l$","$\\cor_u$","$\\Ps_l$","$\\Ps_u$","$\\Dsq_l$","$\\Dsq_u$","$\\cor_l - \\cor_u$","$\\Ps_l - \\Ps_u$","$\\Dsq_u - \\Dsq_l$")
knitr::kable(s,
             format = "pandoc",
             caption = "Spatially averaged values of statistics and confidence intervals based on resampling for **methane-flux data**.\\label{tab_methane_resamp}",
             booktabs=TRUE)
```

\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_D2u-D2l_vs_D.pdf}
\caption[Non-parametric tail statistics results for methane-flux data]{Non-parametric tail statistics results for methane-flux data plotted against geographical distance $(D)$ between two sampling locations. (A) Spearman correlation vs. $D$, (B) Kendall correlation vs. $D$, (C) $\cor_l$ vs. $D$, (D) $\cor_u$ vs. $D$; (E) $\Ps_l$ vs. $D$; (F) $\Ps_u$ vs. $D$; (G) $\Dsq_u$ vs. $D$; (H) $\Dsq_l$ vs. $D$; (I) $\cor_l-\cor_u$ vs. $D$; (J) $\Ps_l-\Ps_u$ vs. $D$; (K) $\Dsq_u-\Dsq_l$ vs. $D$ plotted for all pairs of locations. \label{fig_methane}}
\end{center}
\end{figure}

```{r bivar_tab_summary_fn,echo=F}
bivar_tab_summary_fn<-function(r){
  
  m<-matrix(NA,1,12)
  colnames(m)<-c("Indep.p","AIC-best.copula","Highest.AICw",
                 "N.AICw","p.CvM","p.KS",
                 "LT_model.avg","UT_model.avg","(LT-UT)_model.avg",
                 "Rank_Pl_K","Rank_Pu_K","Rank_Pl-Pu_K")
  m<-as.data.frame(m)
  
  m$Indep.p<-round(r$IndepTestRes,3)
  m$`AIC-best.copula`<-r$InfCritRes$copname[which.min(r$InfCritRes$AIC)]
  m$Highest.AICw<-round(max(r$InfCritRes$AICw),3)
  m$N.AICw<-round(r$InfCritRes$AICw[1],3)
  m$p.CvM<-r$GofRes_CvM
  m$p.KS<-r$GofRes_KS
  m$LT_model.avg<-round(r$relLTdep_AICw,3)
  m$UT_model.avg<-round(r$relUTdep_AICw,3)
  m$`(LT-UT)_model.avg`<-m$LT_model.avg-m$UT_model.avg
  m$Rank_Pl_K<-r$Rank_Pl_K
  m$Rank_Pu_K<-r$Rank_Pu_K
  m$`Rank_Pl-Pu_K`<-r$Rank_PlmPu_K
  mt<-as.data.frame(t(m))
  return(mt)
  
}
#----------------------------------
#calling the above function on 3 multivariable datasets
m1<-bivar_tab_summary_fn(r=BivMS_res_Loecke)
m2<-bivar_tab_summary_fn(r=BivMS_BMR)
m3<-bivar_tab_summary_fn(r=BivMS_contrasts_67)
tab_bivar_summary<-cbind(m1,m2,m3)
colnames(tab_bivar_summary)<-c("SoilCN","BMR","Anolis")
saveRDS(tab_bivar_summary,"./Results/tab_bivar_summary.RDS")
```

```{r multivar_tab_summary_fn,echo=F}
source("normal_cop_AICw.R")

multivar_tab_summary_fn<-function(r,rs){
  
  m<-matrix(NA,1,17)
  colnames(m)<-c("#pairs","#non-indep","#non-N",
                 "Avg.best.AICw","Avg.N.AICw","#good.fit",
                 "CI0.025_LT","CI0.975_LT","CI0.025_UT","CI0.975_UT",
                 "#LT-UT>0",
                 "CI0.025_Pl","CI0.975_Pl","CI0.025_Pu","CI0.975_Pu","CI0.025_Pl-Pu","CI0.975_Pl-Pu")
  m<-as.data.frame(m)
  
  normal_AICw<-normal_cop_AICw_matrix(r=r)
  
  d<-dim(r$gfc_numBS)[1]
  m$`#pairs`<-(d^2)-d
  m$`#non-indep`<- (d^2)-d-2*(r$num_indep_loc_pair+r$num_neg_cor_loc_pair)
  m$`#non-N`<-sum(r$info_ord_copcode[,,1]!=1,na.rm = T)
  r$info_ord_AICw[r$info_ord_AICw==Inf] <- NaN
  m$Avg.best.AICw<-round(mean(r$info_ord_AICw[,,1],na.rm = T),3)
  normal_AICw[normal_AICw==Inf]<-NaN
  m$Avg.N.AICw<-round(mean(normal_AICw,na.rm=T),3)
  temp<-which((r$gfc_p_CvM>0.01) & (r$gfc_p_KS>0.01),arr.ind=T)
  m$`#good.fit`<-dim(temp)[1]
  t<-r$LTdep_AICw[is.finite(r$LTdep_AICw)]
  CI_LT<-unname(quantile(t,probs=c(0.025,0.975),na.rm = T))
  m$CI0.025_LT<-round(CI_LT[1],3)
  m$CI0.975_LT<-round(CI_LT[2],3)
  t<-r$UTdep_AICw[is.finite(r$UTdep_AICw)]
  CI_UT<-unname(quantile(t,probs=c(0.025,0.975),na.rm = T))
  m$CI0.025_UT<-round(CI_UT[1],3)
  m$CI0.975_UT<-round(CI_UT[2],3)
  m$`#LT-UT>0`<-sum(r$LTdep_AICw-r$UTdep_AICw>0,na.rm=T)
  m$CI0.025_Pl<-round(rs$numericdf[5,3],3)
  m$CI0.975_Pl<-round(rs$numericdf[5,4],3)
  m$CI0.025_Pu<-round(rs$numericdf[6,3],3)
  m$CI0.975_Pu<-round(rs$numericdf[6,4],3)
  m$`CI0.025_Pl-Pu`<-round(rs$numericdf[10,3],3)
  m$`CI0.975_Pl-Pu`<-list(round(rs$numericdf[10,4],3))
  #m$`CI0.975_Pl-Pu`<-round(rs$numericdf[10,4],3)
  #m$CI_Pl<-list(c(round(rs$numericdf[5,3],3),round(rs$numericdf[5,4],3)))
  #m$CI_Pu<-list(c(round(rs$numericdf[6,3],3),round(rs$numericdf[6,4],3)))
  #m$`CI_Pl-Pu`<-list(c(round(rs$numericdf[10,3],3),round(rs$numericdf[10,4],3)))
  
  mt<-as.data.frame(t(m))
  return(mt)
  
}
#----------------------------------
#calling the above function on 4 multivariable datasets
m1<-multivar_tab_summary_fn(r=RES_aphid_count,rs=stat_aphid_count)
m2<-multivar_tab_summary_fn(r=RES_aphid_ff,rs=stat_aphid_ff)
m3<-multivar_tab_summary_fn(r=RES_plankton_north_sea,rs=stat_plankton_north_sea)
m4<-multivar_tab_summary_fn(r=RES_methane,rs=stat_methane)
tab_multivar_summary<-cbind(m1,m2,m3,m4)
colnames(tab_multivar_summary)<-c("Aphid_abundance","Aphid_firstflight","Plankton","Methane-flux")
saveRDS(tab_multivar_summary,"./Results/tab_multivar_summary.RDS")
```

```{r sample_plot_aphid_count_ff,echo=F,results="hide"}
#-------------------------------------------------------------------------------
# code to plot raw data and copula plot for aphid count @location pair (4,11)
# bestfit cop : SJ

d1<-data_aphid_count$`Green spruce aphid`[[4]]
d2<-data_aphid_count$`Green spruce aphid`[[11]]
pdf("./Results/Aphid_count_raw_loc_4_11.pdf",height = 8,width=8)
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(d1$Dat,d2$Dat,type="p",col="red",xlab="Aphid abundance from location 4",ylab="Aphid abundance from location 11",cex.lab=1.5,cex.axis=1.5)
par(op)
dev.off()

source("./vivj_matrix.R")
m<-vivj_matrix(d_allsp = data_aphid_count,sp=10,i=4,j=11)
pdf("./Results/Aphid_count_cop_loc_4_11.pdf",height = 8,width=8)
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(m[,1],m[,2],type="p",col="red",xlab="u",ylab="v",
     cex.lab=2,cex.axis=1.5,
     xlim=c(0,1),ylim=c(0,1),asp=1)
rect(0,0,1,1)
lines(c(0,1),c(0,1),type='l')
par(op)
dev.off()

# code to plot raw data and copula plot for aphid ff @location pair (2,5)
# bestfit cop : J
d1<-data_aphid_ff$`Leaf-curling plum aphid`[[2]]
d2<-data_aphid_ff$`Leaf-curling plum aphid`[[5]]
pdf("./Results/Aphid_ff_raw_loc_2_5.pdf",height = 8,width=8)
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(d1$Dat,d2$Dat,type="p",col="red",xlab="Aphid first-flight from location 2",ylab="Aphid first-flight from location 5",cex.lab=1.5,cex.axis=1.5)
par(op)
dev.off()

m<-vivj_matrix(d_allsp = data_aphid_ff,sp=11,i=2,j=5)
pdf("./Results/Aphid_ff_cop_loc_2_5.pdf",height = 8,width=8)
op<-par(mar=c(5.1, 4.1, 0.2, 2.1))
plot(m[,1],m[,2],type="p",col="red",xlab="u",ylab="v",
     cex.lab=2,cex.axis=1.5,
     xlim=c(0,1),ylim=c(0,1),asp=1)
rect(0,0,1,1)
lines(c(0,1),c(0,1),type='l')
par(op)
dev.off()
```

<!--
# Question 2 analyses 
## The Moran effect and copula structure in populations 
           ----moved to Paper.Rmd----
-->

```{r cause4copula_pGOF_500, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
pdf("./Results/Cause4copula_results/compare_params_pGOF_num_keep_last_500.pdf", width=8, height=6)
op<-par(mfrow=c(2,2))

Plotter_Cause4copula_GOF(N=5000,fcode=3,method = "spearman",num_keep_last=500,BS=1000)
Plotter_Cause4copula_GOF(N=5000,fcode=13,method="spearman",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=4,method = "spearman",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=14,method="spearman",num_keep_last=500,BS=1000)

Plotter_Cause4copula_GOF(N=5000,fcode=3,method = "kendall",num_keep_last=500,BS=1000)
Plotter_Cause4copula_GOF(N=5000,fcode=13,method="kendall",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=4,method = "kendall",num_keep_last=500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=14,method="kendall",num_keep_last=500,BS=1000)

#par(op)

op<-par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 1, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("top", c("noise", "population", "p_CvM", "p_KS"), col = c("red", "blue", "magenta", "green2"),
       cex = 1.5, pch = c(2, 6, 16, 16), xpd = TRUE, horiz = TRUE, inset = c(0,0), 
       bty = "n") 
par(op)
dev.off()
```

```{r cause4copula_pGOF_2500, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
# I need to fix that SG_kendall ylimit error : I think I fixed it
#----------------------------
pdf("./Results/Cause4copula_results/compare_params_pGOF_num_keep_last_2500.pdf", width=8, height=6)
op<-par(mfrow=c(2,2))

Plotter_Cause4copula_GOF(N=5000,fcode=3,method = "spearman",num_keep_last=2500,BS=1000)
Plotter_Cause4copula_GOF(N=5000,fcode=13,method="spearman",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=4,method = "spearman",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=14,method="spearman",num_keep_last=2500,BS=1000)

Plotter_Cause4copula_GOF(N=5000,fcode=3,method = "kendall",num_keep_last=2500,BS=1000)
Plotter_Cause4copula_GOF(N=5000,fcode=13,method="kendall",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=4,method = "kendall",num_keep_last=2500,BS=1000)
#Plotter_Cause4copula_GOF(N=5000,fcode=14,method="kendall",num_keep_last=2500,BS=1000)

op<-par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("top", c("noise", "population", "p_CvM", "p_KS"), col = c("red", "blue", "magenta", "green2"),
       cex = 1.5, pch = c(2, 6, 16, 16), xpd = TRUE, horiz = TRUE, inset = c(0,0), 
       bty = "n") 
par(op)
dev.off()
```

```{r cause4copula_stat, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
pdf("./Results/Cause4copula_results/Clayton_spearman.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=3,method="spearman",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/Clayton_kendall.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=3,method="kendall",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/SClayton_spearman.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=13,method="spearman",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/SClayton_kendall.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=13,method="kendall",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/Gumbel_spearman.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=4,method="spearman",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/Gumbel_kendall.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=4,method="kendall",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/SGumbel_spearman.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=14,method="spearman",lb=0,ub=0.1,num_keep_last=500)
dev.off()

pdf("./Results/Cause4copula_results/SGumbel_kendall.pdf")
Plotter_Cause4copula_stat(N=5000,numsim=50,fcode=14,method="kendall",lb=0,ub=0.1,num_keep_last=500)
dev.off()
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Cause4copula_results/compare_params_pGOF_num_keep_last_500.pdf}
\caption[Testing GOF between noise-copula parameters and estimated population copula parameters with $500$ sampling points]{Results of comparison between the parameters of environmental noise generated from a specific family of copula and estimated sample parameter (with some standard error) of the affected populations (Initially 5000 points are generated but we kept last \textbf{500} points for both noise and population data for comparison) \label{fig_Cause4copula_params_GOF_500}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Cause4copula_results/compare_params_pGOF_num_keep_last_2500.pdf}
\caption[Testing GOF between noise-copula parameters and estimated population copula parameters with $2500$ sampling points]{Results of comparison between the parameters of environmental noise generated from a specific family of copula and estimated sample parameter (with some standard error) of the affected populations (Initially 5000 points are generated but we kept last \textbf{2500} points for both noise and population data for comparison) \label{fig_Cause4copula_params_GOF_2500}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Cause4copula_results/Clayton_spearman.pdf}
\caption[Comparing correlations and non-parametric statistic between noise-copula (\textbf{Clayton}) and population copula for different \textbf{Spearman's Rho}]{Results of comparison between 3 types of correlation (i.e. Spearman, Kendall, Pearson) and 6 non-parametric stats ($\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_u$ and $\Dsq_l$) of environmental noise generated from \textbf{Clayton} copula and of the affected populations for 9 equidistant \textbf{Spearman's Rho} values in a range (0.1 to 0.9) (Initially $5000$ points are generated but we kept last $500$ points for both noise and population data for comparison) \label{fig_Cause4copula_C_spear}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Cause4copula_results/Clayton_kendall.pdf}
\caption[Comparing correlations and non-parametric statistic between noise-copula (\textbf{Clayton}) and population copula for different \textbf{Kendall's Tau}]{Results of comparison between 3 types of correlation (i.e. Spearman, Kendall, Pearson) and 6 non-parametric stats ($\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_u$ and $\Dsq_l$) of environmental noise generated from \textbf{Clayton} copula and of the affected populations for 9 equidistant \textbf{Kendall's Tau} values in a range (0.1 to 0.9) (Initially $5000$ points are generated but we kept last $500$ points for both noise and population data for comparison) \label{fig_Cause4copula_C_kend}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Cause4copula_results/SClayton_spearman.pdf}
\caption[Comparing correlations and non-parametric statistic between noise-copula (\textbf{Survival Clayton}) and population copula for different \textbf{Spearman's Rho}]{Results of comparison between 3 types of correlation (i.e. Spearman, Kendall, Pearson) and 6 non-parametric stats ($\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_u$ and $\Dsq_l$) of environmental noise generated from \textbf{Survival Clayton} copula and of the affected populations for 9 equidistant \textbf{Spearman's Rho} values in a range (0.1 to 0.9) (Initially $5000$ points are generated but we kept last $500$ points for both noise and population data for comparison) \label{fig_Cause4copula_SC_spear}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Cause4copula_results/SClayton_kendall.pdf}
\caption[Comparing correlations and non-parametric statistic between noise-copula (\textbf{Survival Clayton}) and population copula for different \textbf{Kendall's Tau}]{Results of comparison between 3 types of correlation (i.e. Spearman, Kendall, Pearson) and 6 non-parametric stats ($\cor_l$, $\cor_u$, $\Ps_l$, $\Ps_u$, $\Dsq_u$ and $\Dsq_l$) of environmental noise generated from \textbf{Survival Clayton} copula and of the affected populations for 9 equidistant \textbf{Kendall's Tau} values in a range (0.1 to 0.9) (Initially $5000$ points are generated but we kept last $500$ points for both noise and population data for comparison) \label{fig_Cause4copula_SC_kend}}
\end{center}
\end{figure}

<!--
## Asymmetric sensitivity and copula structure in populations
           ----moved to Paper.Rmd----
-->

```{r asym_sens_b_variation, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"),mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
set.seed(seed)
#-----------------------------------------------------------------------------------
source("OurBiCopSelect.R")
source("bivfunctionplot.R")
source("asym_sensitivity.R")
#-----------------------------------------------------------------------------------
# This function takes 
# Input :
#       mg : global noise matrix (dim = N by 2)
#       ml : local noise matrix (dim = N by 2)
#       a : a number : local noise coeeficient
#       b : growth factor of pop
#       decrease : logical (controls the nature of global noise)
#       numkeep_last : number of points you want to keep for the pop matrix from the end
#       ploton : logical for optional plot

# Output :
#     a list of 4 pop matrices 
#                         1. (for b=+ve, decrease=F)
#                         2. (for b=+ve, decrease=T)
#                         3. (for b=-ve, decrease=F)
#                         4. (for b=-ve, decrease=T)

plotter_asym_sens_b_varn<-function(mg,ml,a,b,numkeep_last,ploton){
  
  pop<-Simulator_asym_sens(mg=mg,ml=ml,a=a,b=b,p0=c(0,0),decrease=F,numkeep_last=numkeep_last)
  pop_d<-Simulator_asym_sens(mg=mg,ml=ml,a=a,b=b,p0=c(0,0),decrease=T,numkeep_last=numkeep_last)
  
  neg_b<- -b
  pop_neg_b<-Simulator_asym_sens(mg=mg,ml=ml,a=a,b=neg_b,p0=c(0,0),decrease=F,numkeep_last=numkeep_last)
  pop_d_neg_b<-Simulator_asym_sens(mg=mg,ml=ml,a=a,b=neg_b,p0=c(0,0),decrease=T,numkeep_last=numkeep_last)
  
  if(ploton==T){
    op<-par(mfrow=c(2,2),mar=c(4,3,1.5,1),mgp=c(2,1,0))
    
    #plot(pop[,1],pop[,2],col="red",main = bquote(beta ==.(beta)))
    plot(pop[,1],pop[,2],col="red",xlab=expression(paste(P[1])), ylab=expression(paste(P[2])))
    title(expression(paste("(A) g = ",g[1]," , ")), adj=0.4)
    mtext(paste("b = ",b),side = 3, line=0.2, adj=0.72, col="black")
    plot(pop_d[,1],pop_d[,2],col="blue",xlab=expression(paste(P[1])), ylab=expression(paste(P[2])))
    title(expression(paste("(B) g = ",g[2]," , ")), adj=0.4)
    mtext(paste("b = ",b),side = 3, line=0.2, adj=0.72, col="black")
    plot(pop_neg_b[,1],pop_neg_b[,2],col="orange",xlab=expression(paste(P[1])), ylab=expression(paste(P[2])))
    title(expression(paste("(C) g = ",g[1]," , ")), adj=0.4)
    mtext(paste("b = ",neg_b),side = 3, line=0.2, adj=0.75, col="black")
    plot(pop_d_neg_b[,1],pop_d_neg_b[,2],col="skyblue",xlab=expression(paste(P[1])), ylab=expression(paste(P[2])))
    title(expression(paste("(D) g = ",g[2]," , ")), adj=0.4)
    mtext(paste("b = ",neg_b),side = 3, line=0.2, adj=0.75, col="black")
    
    par(op)
  }
  
  return(list(pop=pop,
              pop_d=pop_d,
              pop_neg_b=pop_neg_b,
              pop_d_neg_b=pop_d_neg_b))
  
}
#----------------------------------------------------------
N<-10000
r<-0.8
a<-0.2
numkeep_last<-1000
temp<-get_noise_glob_loc_mat(N=N,r=r)
mg<-temp$mg
ml<-temp$ml

pdf("./Results/asym_sens_results/a_0.2_b_0.1_r_0.8_asym_sens.pdf")
ans_b_0.1<-plotter_asym_sens_b_varn(mg=mg,ml=ml,a=a,b=0.1,numkeep_last=numkeep_last,ploton=T)
dev.off()

pdf("./Results/asym_sens_results/a_0.2_b_0.9_r_0.8_asym_sens.pdf")
ans_b_0.9<-plotter_asym_sens_b_varn(mg=mg,ml=ml,a=a,b=0.9,numkeep_last=numkeep_last,ploton=T)
dev.off()

vlist_b_0.1_b_0.9<-c(ans_b_0.1,ans_b_0.9) # a list of 8 matrices

summary_stat<-as.data.frame(matrix(NA,7,8),stringsAsFactors = F) # Table for model selection summary
rownames(summary_stat)<-c("bestcop_AICw","N_AICw","relLTdep_AICw","relUTdep_AICw","p_CvM","p_KS","BS_success%")
#bg <- intToUtf8(0x03B2) 
cnm<-c("b_0.1_g~1~","b_0.1_g~2~","b_-0.1_g~1~","b_-0.1_g~2~","b_0.9_g~1~","b_0.9_g~2~","b_-0.9_g~1~","b_-0.9_g~2~")
#cname<-paste0(bg,cnm)
colnames(summary_stat)<-cnm

ms_asym_b_0.1_b_0.9<-vector(mode = "list", length = 8) # initializing list to store model selection results for all possible b variation
names(ms_asym_b_0.1_b_0.9)<-cnm

stat_npa_asym_b_0.1_b_0.9<-vector(mode = "list", length = 8) # initializing list to store NPA results for all possible b variation
names(stat_npa_asym_b_0.1_b_0.9)<-cnm

for(ic in c(1:8)){
  v<-vlist_b_0.1_b_0.9[[ic]]
  res<-OurBiCopSelect(u1=v[,1],u2=v[,2],families=c(1,3:10,13:14,16:20),level=0.05,
                      AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,
                      gofnormal=F,status=F)
  
  ms_asym_b_0.1_b_0.9[[ic]]<-res
  
  summary_stat[1,ic]<-max(res$InfCritRes$AICw)
  summary_stat[2,ic]<-res$InfCritRes$AICw[1]
  summary_stat[3,ic]<-res$relLTdep_AICw
  summary_stat[4,ic]<-res$relUTdep_AICw
  summary_stat[5,ic]<-res$GofRes_CvM
  summary_stat[6,ic]<-res$GofRes_KS
  summary_stat[7,ic]<-(res$Numboot_success/res$Numboot)*100
  
  stat_npa_asym_b_0.1_b_0.9[[ic]]<-bivfunctionplot(v=v,resloc="./Results/asym_sens_results/",nametag=cnm[ic],numbin=10)
  
}

saveRDS(summary_stat,"./Results/asym_sens_results/b_variation_summary_stat.RDS")
saveRDS(ms_asym_b_0.1_b_0.9,"./Results/asym_sens_results/ms_asym_b_0.1_b_0.9.RDS")
saveRDS(stat_npa_asym_b_0.1_b_0.9,"./Results/asym_sens_results/stat_npa_asym_b_0.1_b_0.9.RDS")
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/asym_sens_results/a_0.2_b_0.1_r_0.8_asym_sens.pdf}
\caption[asym sensitivity results : copula plot]{asym sensitivity results : copula plot \label{fig_ms_asym_b_0.1}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/asym_sens_results/a_0.2_b_0.9_r_0.8_asym_sens.pdf}
\caption[asym sensitivity results : copula plot]{asym sensitivity results : copula plot \label{fig_ms_asym_b_0.9}}
\end{center}
\end{figure}

```{r tab_summary_stat_asym_sens,echo=F,results="markup"}
knitr::kable(summary_stat, booktabs = T, 
             format = "pandoc",
             digits=3,
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption="summary of model selection results for asym. sensitivity \\label{tab_summary_stat_asym_sens}")
```

```{r read_tab_stat_npa_asym,echo=F,results="asis"}
#knitr::opts_knit$set(kable.force.latex = TRUE)
tab_asym<-readRDS("./Results/asym_sens_results/stat_npa_asym_b_0.1_b_0.9.RDS")

#for(i in c(1:8)){
#  temp<-make_table_stat_fn(data=tab_asym[[i]])
#  temp2<-knitr::kable(temp, booktabs = T, 
#             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
#      caption =paste(cnm[i]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence."))
#  print(temp2)
#  cat("\\newpage")
#}
```

```{r tab_stat_npa_asym_1,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[1]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[1]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_1}"))
```

\newpage
```{r tab_stat_npa_asym_2,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[2]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[2]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_2}"))
```

\newpage
```{r tab_stat_npa_asym_3,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[3]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[3]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_3}"))
```

\newpage

```{r tab_stat_npa_asym_4,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[4]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[4]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_4}"))
```

```{r tab_stat_npa_asym_5,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[5]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[5]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_5}"))
```

```{r tab_stat_npa_asym_6,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[6]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[6]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_6}"))
```

```{r tab_stat_npa_asym_7,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[7]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[7]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_7}"))
```

```{r tab_stat_npa_asym_8,echo=F,results="markup"}
temp<-make_table_stat_fn(data=tab_asym[[8]])
knitr::kable(temp, booktabs = T, 
             format = "pandoc",
      #caption.short = "Results for tests of whether asymmetry of tail dependence was significant compared to a normal-copula null hypothesis.",
      caption =paste(cnm[8]," : A table entry $<N$(or $>N$) indicates the value of the given statistic on the data was less (or more) than its value on $N$ of the surrogates, so entries of the form $<X$ (or $>X$) for $X$ equal to $975$ or above indicate that upper-tail (or lower-tail) dependence was significantly stronger than lower-tail dependence.\\label{tab_stat_npa_asym_8}"))
```

## Need to think about mechanisms for biogeochemical, evolutionary, and community data

\newpage

<!--
# Question 3 analyses for each dataset and theoretical analyses
Recall that question 3 is: What are the consequences of non-Normal copula structure and tail dependence for our understanding of biology and for applications?
## Skewness of the spatial mean
### Aphid count \label{skewness_count}
### Aphid first flight \label{skewness_ff}
### UK Sea plankton \label{skewness_pns}
### Methane-flux data \label{skewness_methane}
                   ----moved to Paper.Rmd----
-->

```{r skewness_count_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

pdf("./Results/skewness_results/skewness_aphid_count/skewness_aphid_count_sp_10.pdf")
par(mfrow=c(2,1))
numsurrog<-10000
loclist<-good_loclist(d_allsp=data_aphid_count,sp=10,data_pt_thrs=30)
answer1k<-skewness_testing(ts_matrix=sp_data(sp=10,d_allsp=data_aphid_count),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="kendall") 

p_left<-sum(answer1k$surrogskw < answer1k$realskw)/numsurrog

mtext(paste0("(A) result based on kendall preserving normal surrogates, p = ",p_left),side=3,line=0.2,col="navyblue")

answer1s<-skewness_testing(ts_matrix=sp_data(sp=10,d_allsp=data_aphid_count),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="spearman") 

p_left<-sum(answer1s$surrogskw < answer1s$realskw)/numsurrog

mtext(paste0("(B) result based on spearman preserving normal surrogates , p = ",p_left),side=3,line=0.2,col="navyblue")


dev.off()
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=8 cm]{./Results/skewness_results/skewness_aphid_count/skewness_aphid_count_sp_10.pdf}
\caption[Skewness count for species Green spruce aphid]{Skewness count for species Green spruce aphid\label{fig_skewness_count}}
\end{center}
\end{figure}


```{r skewness_ff_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_aphid_ff,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

pdf("./Results/skewness_results/skewness_aphid_ff/skewness_aphid_ff_sp_11.pdf")
par(mfrow=c(2,1))
numsurrog<-10000
loclist<-good_loclist(d_allsp=data_aphid_ff,sp=11,data_pt_thrs=30)

answer2k<-skewness_testing(ts_matrix=sp_data(sp=11,d_allsp=data_aphid_ff),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="kendall") 
p_right<-sum(answer2k$surrogskw > answer2k$realskw)/numsurrog
mtext(paste0("(A) result based on kendall preserving normal surrogates, p = ",p_right),side=3,line=0.2,col="navyblue")

answer2s<-skewness_testing(ts_matrix=sp_data(sp=11,d_allsp=data_aphid_ff),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="spearman") 
p_right<-sum(answer2s$surrogskw > answer2s$realskw)/numsurrog
mtext(paste0("(B) result based on spearman preserving normal surrogates , p = ",p_right),side=3,line=0.2,col="navyblue")

dev.off()
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=8 cm]{./Results/skewness_results/skewness_aphid_ff/skewness_aphid_ff_sp_11.pdf}
\caption[Skewness firstflight for species Leaf-curling plum aphid]{Skewness firstflight for species Leaf-curling plum aphid\label{fig_skewness_ff}}
\end{center}
\end{figure}

```{r skewness_pns_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_plankton_north_sea,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

pdf("./Results/skewness_results/skewness_plankton_north_sea/skewness_plankton_north_sea_sp_16.pdf")
par(mfrow=c(2,1))
numsurrog<-10000
loclist<-good_loclist(d_allsp=data_plankton_north_sea,sp=16,data_pt_thrs=45)
answer3k<-skewness_testing(ts_matrix=sp_data(sp=16,d_allsp=data_plankton_north_sea),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="kendall") 

p_left<-sum(answer3k$surrogskw < answer3k$realskw)/numsurrog

mtext(paste0("(A) result based on kendall preserving normal surrogates, p = ",p_left),side=3,line=0.2,col="navyblue")

answer3s<-skewness_testing(ts_matrix=sp_data(sp=16,d_allsp=data_plankton_north_sea),loclist=loclist,numsurrog=numsurrog,ploton=T,
                          corpres="spearman") 

p_left<-sum(answer3s$surrogskw < answer3s$realskw)/numsurrog

mtext(paste0("(B) result based on spearman preserving normal surrogates , p = ",p_left),side=3,line=0.2,col="navyblue")

dev.off()
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=8 cm]{./Results/skewness_results/skewness_plankton_north_sea/skewness_plankton_north_sea_sp_16.pdf}
\caption[Skewness-plankton for species Ceratium furca]{Skewness-plankton for species Ceratium furca\label{fig_skewness_pns}}
\end{center}
\end{figure}

```{r skewness_methane_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_plankton_north_sea,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

pdf("./Results/skewness_results/skewness_methane/skewness_methane.pdf")
par(mfrow=c(2,1))
numsurrog<-10000
loclist<-good_loclist(d_allsp=methane_data,sp=1,data_pt_thrs=50)

answer1k<-skewness_testing(ts_matrix=sp_data(sp=1,d_allsp=methane_data),loclist=loclist,numsurrog=numsurrog,ploton=T,
                           corpres="kendall") 
p_left<-sum(answer1k$surrogskw < answer1k$realskw)/numsurrog
mtext(paste0("(A) result based on kendall preserving normal surrogates, p = ",p_left),side=3,line=0.2,col="navyblue")

answer1s<-skewness_testing(ts_matrix=sp_data(sp=1,d_allsp=methane_data),loclist=loclist,numsurrog=numsurrog,ploton=T,
                           corpres="spearman") 
p_left<-sum(answer1s$surrogskw < answer1s$realskw)/numsurrog
mtext(paste0("(B) result based on spearman preserving normal surrogates , p = ",p_left),side=3,line=0.2,col="navyblue")

dev.off()
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=8 cm]{./Results/skewness_results/skewness_methane/skewness_methane.pdf}
\caption[Skewness-methane-flux data]{Skewness-methane-flux data\label{fig_skewness_methane}}
\end{center}
\end{figure}

<!--
## Extinction risk
        ----moved to Paper.Rmd----
-->

```{r fig_ext_risk, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}

source("mydispersal.R")
set.seed(seed)

rlist<-c(0,0.05,0.25,0.5,0.7,0.75,0.9,1.0,1.25,1.5,1.75,1.95)

# plot for local dispersal in D matrix ; r=0 for LC model, r!=0 for Ricker model
pdf("./Results/ext_risk_local_disp.pdf",heigh=6,width=10)
op<-par(mfrow=c(3,4),mar=c(5,4,1,1) + 0.2)
for(r in rlist){
    #cat("r=",r,"\n")
    s<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=r,K=50,disp_everywhere=F,ploton=F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend(x=-0.06,y=1.1, c("noise : left","noise : right"), fill=c('red', 'blue'), horiz=T, bty='n')
    mtext(paste0("r = ", r))
}
par(op)
dev.off()


# plot for global dispersal in D matrix ; r=0 for LC model, r!=0 for Ricker model
pdf("./Results/ext_risk_global_disp.pdf",heigh=6,width=10)
op<-par(mfrow=c(3,4),mar=c(5,4,1,1) + 0.2)
for(r in rlist){
  #cat("r=",r,"\n")
  s<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=r,K=50,disp_everywhere=T,ploton=F)
  plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d_seq,s$risk_right,type="b",col="blue")
  legend(x=-0.06,y=1.1, c("noise : left","noise : right"), fill=c('red', 'blue'), horiz=T, bty='n')
  mtext(paste0("r = ", r))
}
par(op)
dev.off()

# plot to show the effect of increasing numlocs for r=0 (LC model), r=0.25 (Ricker model)
pdf("./Results/ext_risk_numlocs_effect_local_disp.pdf",heigh=6,width=6)
op<-par(mfrow=c(2,2),mar=c(4,4,1,1) + 0.1)
for(r in c(0,0.25)){
  #cat("r=",r,"\n")
  s5<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=r,K=50,disp_everywhere=F,ploton=F)
  s25<-varying_d(numsims=10000,numsteps =25,numlocs=25,r=r,K=50,disp_everywhere=F,ploton=F)
  
  plot(s5$d_seq,s5$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
  lines(s25$d_seq,s25$risk_left,type="b",col="orange")
  legend("topleft", title=paste0("r=",r," , left tail dep. in noise"), c("numlocs=5","numlocs=25"), fill=c('red', 'orange'),  horiz=F, bty='n')
 
  
  plot(s5$d_seq,s5$risk_right,xlim=c(0,1),ylim=c(0,1),type="b",col="blue",
       panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
  lines(s25$d_seq,s25$risk_right,type="b",col="skyblue")
  legend("topleft",title=paste0("r=",r," , right tail dep. in noise"), c("numlocs=5","numlocs=25"), fill=c('blue', 'skyblue'),  horiz=F, bty='n')
  #mtext(paste0("B",1))
}
par(op)
dev.off()

# plot to show the effect of increasing numlocs for r=0 (LC model), r=0.25 (Ricker model)
pdf("./Results/ext_risk_numlocs_effect_global_disp.pdf",heigh=6,width=6)
op<-par(mfrow=c(2,2),mar=c(4,4,1,1) + 0.1)
for(r in c(0,0.25)){
  #cat("r=",r,"\n")
  s5<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=r,K=50,disp_everywhere=T,ploton=F)
  s25<-varying_d(numsims=10000,numsteps =25,numlocs=25,r=r,K=50,disp_everywhere=T,ploton=F)
  
  plot(s5$d_seq,s5$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
  lines(s25$d_seq,s25$risk_left,type="b",col="orange")
  legend("topleft", title=paste0("r=",r," , left tail dep. in noise"), c("numlocs=5","numlocs=25"), fill=c('red', 'orange'),  horiz=F, bty='n')
 
  
  plot(s5$d_seq,s5$risk_right,xlim=c(0,1),ylim=c(0,1),type="b",col="blue",
       panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
  lines(s25$d_seq,s25$risk_right,type="b",col="skyblue")
  legend("topleft",title=paste0("r=",r," , right tail dep. in noise"), c("numlocs=5","numlocs=25"), fill=c('blue', 'skyblue'),  horiz=F, bty='n')
  #mtext(paste0("B",1))
}
par(op)
dev.off()

# plot to see the effect of K for r=0.25 (Ricker model)
pdf("./Results/ext_risk_K_effect.pdf",heigh=6,width=6)
op<-par(mfrow=c(2,2),mar=c(4,4,1,1) + 0.1)

s1<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=0.25,K=50,disp_everywhere=F,ploton=F)
s2<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=0.25,K=200,disp_everywhere=F,ploton=F)
  
s3<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=0.25,K=50,disp_everywhere=T,ploton=F)
s4<-varying_d(numsims=10000,numsteps =25,numlocs=5,r=0.25,K=200,disp_everywhere=T,ploton=F)
  
plot(s1$d_seq,s1$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
lines(s2$d_seq,s2$risk_left,type="b",col="orange")
legend("topleft",title=("Noise : left tail dep., local disp."), c("K=50","K=200"), fill=c('red', 'orange'),  horiz=F, bty='n')
  
plot(s1$d_seq,s1$risk_right,xlim=c(0,1),ylim=c(0,1),type="b",col="blue",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
lines(s2$d_seq,s2$risk_right,type="b",col="skyblue")
legend("topleft",title=("Noise : right tail dep., local disp."),c("K=50","K=200"), fill=c('blue', 'skyblue'),  horiz=F, bty='n')
 
plot(s3$d_seq,s3$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
lines(s4$d_seq,s4$risk_left,type="b",col="orange")
legend("topleft",title= ("Noise : left tail dep., global disp."),c("K=50","K=200"), fill=c('red', 'orange'),  horiz=F, bty='n')
  
plot(s3$d_seq,s3$risk_right,xlim=c(0,1),ylim=c(0,1),type="b",col="blue",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5)
lines(s4$d_seq,s4$risk_right,type="b",col="skyblue")
legend("topleft",title=("Noise : right tail dep., global disp."),c("K=50","K=200"), fill=c('blue', 'skyblue'),  horiz=F, bty='n')
 
par(op)
dev.off()
```

![Extinction_Risk_local_dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp}](./Results/ext_risk_local_disp.pdf){ width=40%, height=40% }

![Extinction_Risk_global_dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp}](./Results/ext_risk_global_disp.pdf){ width=40%, height=40% }

![Extinction_Risk_numlocs_effect_local_disp; numsteps=25, numsims=10000\label{fig_risk_numlocs_effect_local_disp}](./Results/ext_risk_numlocs_effect_local_disp.pdf){ width=40%, height=40% }

![Extinction_Risk_numlocs_effect_global_disp; numsteps=25, numsims=10000\label{fig_risk_numlocs_effect_global_disp}](./Results/ext_risk_numlocs_effect_global_disp.pdf){ width=40%, height=40% }

![Extinction_Risk_K_effect on Ricker model; r=0.25, numsteps=25, numsims=10000\label{fig_risk_K_effect}](./Results/ext_risk_K_effect.pdf){ width=40%, height=40% }


\newpage

<!-- Taylor's law section need to move to Paper.Rmd once it's completed-->
## Taylor's law

<!--make surrogate datasets for TL analysis to follow-->
```{r taylors_law_make_surrogs, echo=F, cache=T, cache.extra=list(seed,mtime("copsurrognd.R"))}
source("copsurrognd.R")
set.seed(seed)

#***constants
N<-100 #length of time series
n<-25 #number of sampling locations
numdat<-25 #the number of datasets to get from the normal copula
rho<-0.7 #normal-copula parameter for dependence between locations
          #this is a covariance, see below call to rmvnorm

#***generate the starting data, which has normal copula structure
#because it comes originally from a multivariate normal, before 
#transformation
sig<-matrix(rho,n,n)
diag(sig)<-1
m<-rmvnorm(N*numdat,mean=rep(0,n),sigma=sig)
m<-array(m,c(N,numdat,n))
m<-aperm(m,c(1,3,2))
gshape<-7.5
gscale<-1 #gamma parameters
cop_to_marg_trans<-function(x)
{
  return(qgamma(x,shape=gshape,scale=gscale)) #this is where we choose the marginals,
                                  #should be something skewed
}
marg_to_cop_trans<-function(x) #transforms to copula space
{
  return(pgamma(x,shape=gshape,scale=gscale))
}
m<-cop_to_marg_trans(pnorm(m))

#***surrogates using a Clayton copula, kendall preserving
#get the Clayton parameter to use
ncop<-normalCopula(rho,2)
ccop<-claytonCopula(2,2)
cparam<-iTau(ccop,tau(ncop))
ccop<-claytonCopula(cparam,n)

#generate the surrogates
csurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3])
{
  csurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=ccop,numsurrog=1)
}

# #test to see whether kendalls are similar between m and csurrog - 
#only works at all as a test if N is large (I used 1000)
# cor(m[,1,1],m[,2,1],method='kendall')
# cor(csurrog[,1,1],csurrog[,2,1],method='kendall')
# cor(m[,3,1],m[,4,1],method='kendall')
# cor(csurrog[,3,1],csurrog[,4,1],method='kendall')
# cor(m[,5,1],m[,6,1],method='kendall')
# cor(csurrog[,5,1],csurrog[,6,1],method='kendall')
# 
# cor(m[,1,2],m[,2,2],method='kendall')
# cor(csurrog[,1,2],csurrog[,2,2],method='kendall')
# cor(m[,3,2],m[,4,2],method='kendall')
# cor(csurrog[,3,2],csurrog[,4,2],method='kendall')
# cor(m[,5,2],m[,6,2],method='kendall')
# cor(csurrog[,5,2],csurrog[,6,2],method='kendall')

#***surrogates using a Frank copula, kendall preserving
#get the Frank parameter to use
fcop<-frankCopula(4,2)
fparam<-iTau(fcop,tau(ncop))
fcop<-frankCopula(fparam,n)

#generate the surrogates
fsurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3])
{
  fsurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=fcop,numsurrog=1)
}

#***surrogates using a survival Clayton, kendall preserving
#take the clayton surrogates and transform them to the 
#copula space, then flip, then transform back
scsurrog<-cop_to_marg_trans((1-marg_to_cop_trans(csurrog)))

# #test: should have identical taus as csurrog
# cor(csurrog[,1,1],csurrog[,2,1],meth='kendall')
# cor(scsurrog[,1,1],scsurrog[,2,1],meth='kendall')
# cor(csurrog[,1,2],csurrog[,2,2],meth='kendall')
# cor(scsurrog[,1,2],scsurrog[,2,2],meth='kendall')

kend.surrog<-list(cla=csurrog,nor=m,fra=fsurrog,scl=scsurrog)

#***surrogates using a Clayton copula, spearman preserving
#get the Clayton parameter to use
ccop<-claytonCopula(2,2)
cparam<-iRho(ccop,rho(ncop))
ccop<-claytonCopula(cparam,n)

#generate the surrogates
csurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3])
{
  csurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=ccop,numsurrog=1)
}

#***surrogates using a Frank copula, spearman preserving
#get the Frank parameter to use
fcop<-frankCopula(4,2)
fparam<-iRho(fcop,rho(ncop))
fcop<-frankCopula(fparam,n)

#generate the surrogates
fsurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3])
{
  fsurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=fcop,numsurrog=1)
}

#***surrogates using a survival Clayton, spearman preserving
#take the clayton surrogates and transform them to the 
#copula space, then flip, then transform back
scsurrog<-cop_to_marg_trans((1-marg_to_cop_trans(csurrog)))

spea.surrog<-list(cla=csurrog,nor=m,fra=fsurrog,scl=scsurrog)
```

<!--do a TL analysis on the data just created-->
```{r tl_analysis, echo=F, cache=T, cache.extra=list(kend.surrog,spea.surrog,mtime("TaylorsLawTools.R"),seed,mtime("copsurrognd.R"))}
source("copsurrognd.R")
source("TaylorsLawTools.R")
 
#We are only doing spatial taylor's law because we know a priori temporal
#won't give anything interesting for the surrogates we use

kend.stats.res<-list()
kend.points.res<-list()
spea.stats.res<-list()
spea.points.res<-list()
for (counter in 1:length(kend.surrog))
{
 ks<-kend.surrog[[counter]]
 ss<-spea.surrog[[counter]]
 kend.stats.res[[counter]]<-matrix(NA,5,numdat)
 spea.stats.res[[counter]]<-matrix(NA,5,numdat)
 kend.points.res[[counter]]<-array(NA,c(N,2,numdat))
 spea.points.res[[counter]]<-array(NA,c(N,2,numdat))
 for (sc in 1:numdat)
 {
   khold<-tl_stats(ks[,,sc])
   kend.stats.res[[counter]][,sc]<-khold$s.stats #spatial TL only
   rownames(kend.stats.res[[counter]])<-names(khold$s.stats)
   kend.points.res[[counter]][,,sc]<-as.matrix(khold$s.points)
 
   shold<-tl_stats(ss[,,sc])
   spea.stats.res[[counter]][,sc]<-shold$s.stats #spatial TL only
   rownames(spea.stats.res[[counter]])<-names(shold$s.stats)
   spea.points.res[[counter]][,,sc]<-as.matrix(shold$s.points)
 }
}
names(kend.stats.res)<-names(kend.surrog)
names(kend.points.res)<-names(kend.surrog)
names(spea.stats.res)<-names(spea.surrog)
names(spea.points.res)<-names(spea.surrog)
```

<!--Now make some plots, these one for kendall surrogates-->
```{r taylor_plots, echo=F}
##plot TL for clayton
xlimits<-range(kend.points.res[[1]][,1,],kend.points.res[[2]][,1,],kend.points.res[[3]][,1,],kend.points.res[[4]][,1,])
ylimits<-range(kend.points.res[[1]][,2,],kend.points.res[[2]][,2,],kend.points.res[[3]][,2,],kend.points.res[[4]][,2,])
par(mfrow=c(1,1),mar=c(4,4,1,1) + 0.1)
plot(kend.points.res[[1]][,1,],kend.points.res[[1]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")))  
points(kend.points.res[[1]][,1,1],kend.points.res[[1]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[1]][,1,2],kend.points.res[[1]][,2,2],type='p',pch=20,cex=.75,col='green')

##plot TL for normal copula
plot(kend.points.res[[2]][,1,],kend.points.res[[2]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")))  
points(kend.points.res[[2]][,1,1],kend.points.res[[2]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[2]][,1,2],kend.points.res[[2]][,2,2],type='p',pch=20,cex=.75,col='green')

#plot TL for frank
plot(kend.points.res[[3]][,1,],kend.points.res[[3]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")))  
points(kend.points.res[[3]][,1,1],kend.points.res[[3]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[3]][,1,2],kend.points.res[[3]][,2,2],type='p',pch=20,cex=.75,col='green')

#plot TL for survival clayton
plot(kend.points.res[[4]][,1,],kend.points.res[[4]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")))  
points(kend.points.res[[4]][,1,1],kend.points.res[[4]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[4]][,1,2],kend.points.res[[4]][,2,2],type='p',pch=20,cex=.75,col='green')

#prepare for plots coming below
s.lin<-cbind(kend.stats.res[[1]][1,],kend.stats.res[[2]][1,],kend.stats.res[[3]][1,],kend.stats.res[[4]][1,])
s.hom<-cbind(kend.stats.res[[1]][2,],kend.stats.res[[2]][2,],kend.stats.res[[3]][2,],kend.stats.res[[4]][2,])
s.rmse<-cbind(kend.stats.res[[1]][3,],kend.stats.res[[2]][3,],kend.stats.res[[3]][3,],kend.stats.res[[4]][3,])
s.int<-cbind(kend.stats.res[[1]][4,],kend.stats.res[[2]][4,],kend.stats.res[[3]][4,],kend.stats.res[[4]][4,])
s.slope<-cbind(kend.stats.res[[1]][5,],kend.stats.res[[2]][5,],kend.stats.res[[3]][5,],kend.stats.res[[4]][5,])

#plot s.lin distr for each set of surrogates
#***DAN: x axis needs to be redone to show the copula names used in the surrogates
par(mfrow=c(1,1),mar=c(4,4,1,1) + 0.1)
x<-1:4
plot(x,s.lin[1,],type="b",ylim=range(s.lin),xlab="Set of surrogates",ylab="Linearity test p-vals")
for (counter in 2:dim(s.lin)[1])
{
  lines(x,s.lin[counter,],type='b')
}

#plot s.hom distr for each set of surrogates
#***DAN: x axis needs to be redone to show the copula names used in the surrogates
x<-1:4
plot(x,s.hom[1,],type="b",ylim=range(s.hom),xlab="Set of surrogates",ylab="Homoskedasticity test p-vals")
for (counter in 2:dim(s.slope)[1])
{
  lines(x,s.hom[counter,],type='b')
}

#plot s.rmse distr for each set of surrogates
#***DAN: x axis needs to be redone to show the copula names used in the surrogates
x<-1:4
plot(x,s.rmse[1,],type="b",ylim=range(s.rmse),xlab="Set of surrogates",ylab="Spatial TL rmse")
for (counter in 2:dim(s.rmse)[1])
{
  lines(x,s.rmse[counter,],type='b')
}

#plot s.int distr for each set of surrogates
#***DAN: x axis needs to be redone to show the copula names used in the surrogates
x<-1:4
plot(x,s.int[1,],type="b",ylim=range(s.int),xlab="Set of surrogates",ylab="Spatial TL intercept")
for (counter in 2:dim(s.int)[1])
{
  lines(x,s.int[counter,],type='b')
}

#plot s.slope distr for each set of surrogates
#***DAN: x axis needs to be redone to show the copula names used in the surrogates
x<-1:4
plot(x,s.slope[1,],type="b",ylim=range(s.slope),xlab="Set of surrogates",ylab="Spatial TL slope")
for (counter in 2:dim(s.slope)[1])
{
  lines(x,s.slope[counter,],type='b')
}
```



\newpage

# References
<div id="refs"></div>




