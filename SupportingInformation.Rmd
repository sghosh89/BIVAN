---
title: "Supporting information: Copulas and their potential for ecology"
author: "Shyamolina Ghosh, Lawrence W. Sheppard, Mark T. Holder, Terrance E. Loecke, Philip C. Reid, James D. Bever, Daniel C. Reuman"
geometry: "left=1cm,right=1cm,top=2.2cm,bottom=2.2cm"

output: 
  pdf_document:
    number_sections: yes
    keep_tex: yes
    fig_caption: yes
    includes:
      in_header: head_supp.sty
      
tables: True
link-citations: True
urlcolor : blue
indent : True

csl: ecology-letters.csl
bibliography: REF_ALL.bib
---

\pagenumbering{roman}
\tableofcontents
\listoffigures
\listoftables

\pagebreak
\pagenumbering{arabic}

<!--Basic setup-->
```{r setup, echo=F}
knitr::opts_chunk$set(echo = TRUE, fig.pos = "H")
seed<-101
source("mtime.R") #A function needed for caching
library(captioner)
library(parallel)
freecores<-2
busycores<-detectCores()-freecores # for parallell computing with mclapply your computer will use all cores except the number of freecores.
```

<!--generating plots for pedagog figures-->
```{r cop_pedagog_fig,echo=F,results="hide"}
set.seed(seed)
source("./FirstPedagogFig.R")
source("./SecondPedagogFig.R")
source("./ThirdPedagogFig.R")
source("./MakeCopulaPedagogFigs.R")
source("./PedagogFigCopThry.R")
```

<!--reading data and generaing plot for soilCN-->
```{r load_and_plot_data_soilCN, echo=F, results='hide'}
#d_old<-readRDS("Data/dataForShymolinaCoord.rds")
#write.csv(d_old,"./Data/SoilCN/SoilCNdata.csv")
d<-read.csv("./Data/SoilCN/SoilCNdata.csv")
rownames(d)<-d$X
d<-d[,-1]
#sapply(dCN,class)

d<-d[,c("SOCstock100","TSNstock100","lat","long")]
#identical(d_old[,c("SOCstock100","TSNstock100","lat","long")],d) # checked : they are identical :)
d<-na.omit(d)
pdf("./Results/SoilCNraw.pdf")
op<-par(mar=c(6, 6, 0.2, 2.1))
d_log<-log10(d[,c(1:2)])
plot(d_log[,1],d_log[,2],type="p",col="black",xlab="log(Soil C)",ylab="log(Soil N)",cex.lab=2.5,cex.axis=2.5)
par(op)
dev.off()
```

<!--generating copula plot with soilCN data-->
```{r copula_plot_soilCN, echo=F, results='hide'}
source("getcopula.R")
#convert to a copula and plot
pdf("./Results/SoilCNcop.pdf")
v_CN<-getcopula(d=d_log,rankon=T,ploton=T) 
dev.off()
```

<!--generating plots with sampling locations for soilCN data-->
```{r plot_SoilCNmapUSA, echo=F, results='hide'}
#---------map of soilCN location on USA------------
library(maps)
pdf("./Results/SoilCNmapUSA.pdf",height=4,width=8)
map("usa")
points(x = d$long, y = d$lat, col="red",pch=16,cex=0.5)
dev.off()
```

<!--reading Birds' BMR data and generating raw, copula plots with it-->
```{r read_BMR_birds_and_copulaplot, echo=F, results='hide'}
library(readxl)
set.seed(seed)
raw_b<-readxl::read_xls("./Data/BMR/BirdBodyMassesMetabolicRates/BirdMassesAndMetabolicRatesMcNab2008.xls")
raw_b<-raw_b[,1:3]
raw_b<-na.omit(raw_b)
raw_b<-raw_b[,2:3]
raw_b<-as.data.frame(raw_b)

saveRDS(raw_b,"./Data/BMR/BirdBodyMassesMetabolicRates/my_birdsBMR_data.RDS")

b<-log10(raw_b)
colnames(b)<-c("log10M(g)","log10BMR(KJ/h)")
pdf("./Results/BMR_results/birds/raw_birds_BMR.pdf")
op<-par(mar=c(6, 6, 0.2, 2.1))
plot(b[,1],b[,2],type="p",col="black",xlab="log(Mass)",ylab="log(BMR)",cex.lab=2.5,cex.axis=2.5)
par(op)
dev.off()

source("getcopula.R")
pdf("./Results/BMR_results/birds/copula_birds_BMR.pdf")
cop_b<-getcopula(d=b,rankon=T,ploton=T) #convert to a copula and plot
dev.off()
```

<!--reading Mammals' BMR data and generating raw, copula plots with it-->
```{r read_BMR_mammals_and_copulaplot, echo=F, results='hide'}
set.seed(seed)
raw_m<-readxl::read_xls("./Data/BMR/MammalianBodyMassesMetabolicRates/MammalianMassesAndMetabolicRatesMcNab2008.xls")
raw_m<-raw_m[,1:3]
raw_m<-na.omit(raw_m)
raw_m<-raw_m[,2:3]

saveRDS(raw_m,"./Data/BMR/MammalianBodyMassesMetabolicRates/my_mammalsBMR_data.RDS")

m<-log10(raw_m)
colnames(m)<-c("log10M(g)","log10BMR(KJ/h)")
m<-as.data.frame(m)

pdf("./Results/BMR_results/mammals/raw_mammals_BMR.pdf")
op<-par(mar=c(6, 6, 0.2, 2.1))
plot(m[,1],m[,2],type="p",col="black",xlab="log(Mass)",ylab="log(BMR)",cex.lab=2.5,cex.axis=2.5)
par(op)
dev.off()

source("getcopula.R")
pdf("./Results/BMR_results/mammals/copula_mammals_BMR.pdf")
cop_m<-getcopula(d=m,rankon=T,ploton=T) #convert to a copula and plot
dev.off()
```


<!--reading ceder creek data and generating raw and copula plots with it-->
```{r read_ceder_creek_data, echo=F, results="hide"}
set.seed(seed)
#-------------------------------------------------
# This function takes 
# Input :
#       db : a dataframe : smaller subset of ple_120 data to calculate avg. biomass for each plot
#       dp : a dataframe : smaller subset of pce_120 data to calculate avg. shannon's H for those plots
#       plots : a vector of given 168 plot ids as used in reference papers by Tilman
#       year : the year for which you want to calculate biomass and shannon's index data
#       rawplot : logical : T for rawdata plot, F for copula plot
#       ploton : logical for optional plotting

# Output :
#       a list of two data-frame:
#                   tab_dbp : a data-frame with 3 column : (plot no , avg.H, avg.Biomass(g/m2))
#                   cop_tab_dbp : a data-frame with 3 column : (plot no, pobs(avg.H), pobs(avg.Biomass(g/m2)))

cop_HB<-function(db,dp,plots,year,rawplot,ploton){
  # db : biomass dataset for a specific year
  # dp : percent cover dataset for a specific year
  
  db<-subset(db,Plot%in%plots)
  dp<-subset(dp,Plot%in%plots)

  tab_dbp<-data.frame(Plot=plots,avg.H=NA,avg.Biomass=NA)
  for(i in 1:length(plots)){
   # calculate biomass for each plot (averaged over all strips for that plot)
   x<-subset(db,Plot==plots[i])
   tab_dbp$avg.Biomass[i]<-mean(x$Biomass) 
  
   # calculate shannon's index H for each plot (averaged over all Quadrates for that plot)
   x<-subset(dp,Plot==plots[i])
   x$Species<-trimws(x$Species) # to remove duplicated names of sp. (cutting white spaces) : e.g. 1999 : plot no 339
   uniq_sp<-sort(as.character(unique(x$Species)))  # These are the species in a particular plot
   Q<-as.character(unique(x$Quadrat))
   #cat("----------total unique quadrats = ",length(Q),"--------------------\n")
   tab_each_sp<-data.frame(sp=uniq_sp,avg_cov=0,rel_avg_cov=0)
   #cat("=====================================plot : ",plots[i],"===========================\n")
   for(sp in 1:length(uniq_sp)){
    my_sp<-uniq_sp[sp]
    #cat("---------- sp = ",my_sp,"--------------------\n")
    tab_temp<-data.frame(Q=Q,abs_cov=0)
    ind<-which(x$Species==my_sp)
    li<-length(ind)
    #print(li)
    tab_temp$abs_cov[1:li]<-x$Abscover[ind]
    tab_each_sp$avg_cov[[sp]]<-mean(tab_temp$abs_cov) # avg. over Quadrats for a sp.
   }
  
  tab_each_sp$rel_avg_cov<-tab_each_sp$avg_cov/sum(tab_each_sp$avg_cov)
  tab_dbp$avg.H[i]<- -sum((tab_each_sp$rel_avg_cov)*log(tab_each_sp$rel_avg_cov))
 }
  tab_dbp<-na.omit(tab_dbp)
  
  cop_tab_dbp<-data.frame(Plot=tab_dbp$Plot,avg.H=NA,avg.Biomass=NA)
  cop_tab_dbp$avg.H<-VineCopula::pobs(tab_dbp$avg.H)
  cop_tab_dbp$avg.Biomass<-VineCopula::pobs(tab_dbp$avg.Biomass)
  
  
  if(ploton==T){
    if(rawplot==T){
      op<-par(mar=c(6, 6, 0.2, 2.1))
      plot(tab_dbp$avg.H,tab_dbp$avg.Biomass,xlab="avg. H",ylab="avg. Biomass",pch=1,cex.lab=2.5,cex.axis=2)
      mtext(paste0("Year=",year),cex=1)
      par(op)
    }else{
      op<-par(mar=c(6, 6, 0.2, 2.1))
      plot(cop_tab_dbp$avg.H,cop_tab_dbp$avg.Biomass,xlab="u",ylab="v",pch=1,cex.lab=3,cex.axis=2,
         xlim=c(0,1),ylim=c(0,1),asp=1)
      rect(0,0,1,1)
      lines(c(0,1),c(0,1),type='l',col="grey")
      #mtext(paste0("Year=",year),cex=1)
      par(op)
    }
  }
  
  return(list(tab_dbp=tab_dbp,
         cop_tab_dbp=cop_tab_dbp))
}
#-----------------------------
r_ple<-read.delim("./Data/Ceder_creek_e120/edited_ple120.txt")
names(r_ple)[36]<-"Biomass"

r_pce<-read.delim("./Data/Ceder_creek_e120/edited_pce120.txt")

y1<-unique(r_ple$Year)
y2<-unique(r_pce$Year)
yr<-sort(intersect(y1,y2))

a<-as.data.frame(table(sort(r_pce$Species)))
b<-as.character(a$Var1)
bad_sp<-c(b[51:53],b[156:158],"Disturbance") 
# bad sp : "Bare ground","Bare ground","BARE GROUND","Miscellaneous litter","Miscellaneous litter","MISCELLANEOUS LITTER"            
ind<-which(r_pce$Species%in%bad_sp)
r_pce_clean<-r_pce[-ind,]

#----------------------------------------------------------------------------------------------
#=======================================================
# This sections selects 168 plots considered for both biomass and percent cover datasets in Tilman's papers 2001, 2006
plot_info<-read.delim("./Data/Ceder_creek_e120/edited_plots.txt")

id_excluded_plots<-which(plot_info$Species=="Bargr") # there were 4 plots with no sp. seeded

plots_168<-plot_info$Plot[-id_excluded_plots]

#------------------------------------------------------
# You can check that here too
s<-subset(r_ple,NumSp==0)
sb<-sort(unique(s$Plot))

s<-subset(r_pce_clean,NumSp==0)
spc<-sort(unique(s$Plot))

sb==spc # This should be all TRUE for 4 not seeded plots with id : 126, 166, 244, 248
#=======================================================
#--------------------------------------------------------------------------------------------
pdf("./Results/Ceder_creek_results/raw_HB_all_yr.pdf",height = 6,width = 10)
op<-par(mfrow=c(2,3),mar=c(3,3,3,3), mgp=c(1.5,0.5,0))
for(i in 1:length(yr)){
  db<-subset(r_ple,Year==yr[i])
  dp<-subset(r_pce_clean,Year==yr[i])
  
  sr<-cop_HB(db=db,dp=dp,year=yr[i],plots=plots_168,rawplot=T,ploton = T)
}
par(op)
dev.off()
#-----------------------
#raw data plot for year2000
pdf("./Results/Ceder_creek_results/raw_HB_2000.pdf",height = 6,width = 6)
i<-5
db<-subset(r_ple,Year==yr[i])
dp<-subset(r_pce_clean,Year==yr[i])
sr<-cop_HB(db=db,dp=dp,year=yr[i],plots=plots_168,rawplot=T,ploton = T)
saveRDS(sr,"./Results/Ceder_creek_results/raw_cop_cc_2000.RDS")
dev.off()
#----------------------------------------------------------------------------------------
cop_HB_all_yr<-vector("list",length(yr))
names(cop_HB_all_yr)<-yr

pdf("./Results/Ceder_creek_results/cop_HB_all_yr.pdf",height = 6,width = 10)
op<-par(mfrow=c(2,3),mar=c(3,3,3,3), mgp=c(1.5,0.5,0))
for(i in 1:length(yr)){
  db<-subset(r_ple,Year==yr[i])
  dp<-subset(r_pce_clean,Year==yr[i])
  
  s<-cop_HB(db=db,dp=dp,year=yr[i],plots=plots_168,rawplot=F,ploton = T)
  cop_HB_all_yr[[i]]<-s$cop_tab_dbp[,2:3]
}
par(op)
dev.off()
#-------------------------
#cop data plot for year2000
pdf("./Results/Ceder_creek_results/cop_HB_2000.pdf",height = 6,width = 6)
i<-5
db<-subset(r_ple,Year==yr[i])
dp<-subset(r_pce_clean,Year==yr[i])
s<-cop_HB(db=db,dp=dp,year=yr[i],plots=plots_168,rawplot=F,ploton = T)
cc_cop_2000<-s$cop_tab_dbp[,2:3]
dev.off()
#------------------

saveRDS(cop_HB_all_yr,"./Results/Ceder_creek_results/cop_HB_all_yr.RDS")
#---------------------------------------------------------------------------------------
cop_HB_all_yr<-readRDS("./Results/Ceder_creek_results/cop_HB_all_yr.RDS")
```

<!--reading aphid and plankton data, then generating plots showing sampling locations-->
```{r map_plot_aphid_plankton,results="hide",echo=F}
source("aphid_data_calling.R")
source("good_loclist.R")
library(maps)

#----------------- Aphid map--------------------------------------------
d0_count<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtscount141117.csv",header=F))
data_aphid_count<-d_allsp_data(d0_count)

d0_firstflight<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsfirstflight141117.csv",header=F))
data_aphid_ff<-d_allsp_data(d0_firstflight)

selective_loc1<-good_loclist(d_allsp=data_aphid_count,sp=10,data_pt_thrs=30)
selective_loc2<-good_loclist(d_allsp=data_aphid_ff,sp=11,data_pt_thrs=30)
all(selective_loc1==selective_loc2)==T

longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

locno<-length(longs)
df_loc_info_org<-data.frame(loc_no=c(1:length(lats)),longs=longs,lats=lats)
df_loc_info<-df_loc_info_org[selective_loc1,]
xlim=c(-10,2)
ylim=c(50, 60)

pdf("./Results/aphid_map_plot.pdf")
map("world", fill=TRUE, col="grey84", bg="white",border=0, xlim=xlim, ylim=ylim)
map.axes(cex.axis=2.5)
points(x = df_loc_info_org$longs, y = df_loc_info_org$lats, col="red",pch=16)
points(x = df_loc_info$longs, y = df_loc_info$lats, col="blue", pch=0, cex=1.5)
text(df_loc_info_org$loc_no, x = df_loc_info_org$longs, y = df_loc_info_org$lats, col="red",  pos=1)
dev.off()

#--------------Plankton map----------------------------

source("plankton_north_sea_data_calling.R")
d0_plankton_north_sea<-as.matrix(read.csv("./Data/Plankton_North_Sea_data/planktontimeseries201117_4.csv",header=F))
data_plankton_north_sea<-d_allsp_data_plankton_north_sea(d0_plankton_north_sea)

longs<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlongs201117.csv",header=F)
lats<-read.csv("./Data/Plankton_North_Sea_data/boxcornerlats201117.csv",header=F)
longs_pns<-longs[[1]]
lats_pns<-lats[[1]]

df_loc_info_org<-data.frame(loc_no=c(1:length(lats_pns)),longs=longs_pns,lats=lats_pns)
selective_loc<-good_loclist(d_allsp=data_plankton_north_sea,sp=16,data_pt_thrs=45)
df_loc_info<-df_loc_info_org[selective_loc,]
xlim=c(-12,10)
ylim=c(48, 60)

pdf("./Results/plankton_map_plot.pdf")
map("world", fill=TRUE, col="grey84", bg="white",border=0, xlim=xlim, ylim=ylim)
map.axes(cex.axis=2.5)
abline(h=seq(from=ylim[1],to=ylim[2],by=2), v=seq(from=xlim[1],to=xlim[2],by=2), col="black", lty=2)
points(x = df_loc_info_org$longs+1, y = df_loc_info_org$lats+1, col="red",pch=16)
points(x = df_loc_info$longs+1, y = df_loc_info$lats+1, col="blue", pch=0, cex=1.5)
text(df_loc_info_org$loc_no, x = df_loc_info_org$longs+1, y = df_loc_info_org$lats+1, col="red",  pos=1)
dev.off()
```

<!--Generating a single plot containing raw and copula plots for all bivariate data-->
```{r make_data_plot_fig,echo=FALSE,results="hide"}
source("./MakeBivarDataPlot.R")
```

# Transformation alters Pearson but not Spearman correlation \label{pedagog1_details}

The data of Fig. \ref{MT-fig_cop_pedag1}A-B were generated to have standard normal marginals.
Fig. \ref{fig_transf_pearson_spearman}A can be obtained from Fig. \ref{MT-fig_cop_pedag1}A via transformation
of both variables by the cummulative distribution function (cdf) of the standard normal distribution, and then by the inverse of 
the cdf of the gamma distribution with shape and scale parameters 2. 
The functions `pnorm` and `qgamma` in R were used.
Fig. \ref{fig_transf_pearson_spearman}B can be obtained from Fig. \ref{MT-fig_cop_pedag1}B in the same way.
The Pearson correlations differ substantially after transformation, 
but the Spearman correlations are unchanged (Figs \ref{MT-fig_cop_pedag1}A-B, \ref{fig_transf_pearson_spearman}).
A scatterplot very simlar to Fig. \ref{MT-fig_cop_pedag1}C can be obtained from Fig. \ref{MT-fig_cop_pedag1}A via transformation
of both variables by the cdf of the standard normal distribution.
Likewise a scatterplot similar to Fig. \ref{MT-fig_cop_pedag1}D can be obtained from Fig. \ref{MT-fig_cop_pedag1}B in the same way. 

\begin{figure}[!h]
\begin{center}
\includegraphics[width=10 cm]{./Results/PedagogFig_SMExport.pdf}
\caption[Transformation alters Pearson but not Spearman correlation]{Transformation alters Pearson but not Spearman correlation. 
Displayed data are transformed from the data pictured on
Fig. \ref{MT-fig_cop_pedag1}A-B. See Appendix \ref{pedagog1_details} for 
details. P=Pearson, S=Spearman 
correlation.\label{fig_transf_pearson_spearman}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm,height=8 cm]{./Results/copula_pedagog_fig_BB1.pdf}
\caption[Lower- and upper-tail dependence can vary independently of correlation]{Lower- and 
upper-tail dependence can vary independently of correlation. (A-C) Data generated using the BB1 
copula (see Background section in the main text) 
with three different 
sets of parameters chosen to produce a variety of 
lower-tail (LT) and upper-tail (UT) dependence strengths, but with the same 
Kendall correlation (K) (to two digits) in all cases. (D-F) Similar to A-C, but
with stronger correlation. Asymmetry of tail dependence (LT-UT) is the same 
within each column. See Background section in the main text for a formal description of 
tail dependence and other measures of association in the tails.\label{fig_cop_pedag}}
\end{center}
\end{figure}

# Proofs of statements related to Sklar's theorem in the case of continuous, strictly monotonic margins \label{ContStrictMonoton}

Let $F$ be the bivariate distribution function
of a random vector $(X,Y)$, with margins $F_X$ and $F_Y$ assumed to be 
continuous and strictly monotonic. We show the copula associated with
$(X,Y)$, which exists and is unique by Sklar's theorem, is the distrbution function
of the random variable $(U,V)=(F_X(X),F_Y(Y))$. Let $C$ denote the distribution
function of $(U,V)$, which has uniform margins. By the uniqueness
statement of Sklar's theorem, it suffices to show that $F(x,y)=C(F_X(x),F_Y(y))$
for all $(x,y)$ in the Euclidean plane. But 
$C(F_X(x),F_Y(y)) = P[U \leq F_X(x), V \leq F_Y(y)]
= P[F_X(X) \leq F_X(x), F_Y(Y) \leq F_Y(y)]
= P[X \leq x, Y \leq y]
= F(x,y),$
where the third equality follows from the strict monotonicity assumption. In fact, 
that equality should hold even with non-strict monotonicity, so a stronger 
statement is possible (see below for more on this topic). The continuity assumption 
for $F_X$ and $F_Y$ is necessary, however: without it the random variables 
$U$ and $V$ are not uniformly distributed, so their joint distribution function 
is not even a copula.

Now let $D$ be any bivariate copula and let 
$G_A$ and $G_B$ be univariate distribution functions, so that 
$D(G_A(x),G_B(y))$ is guaranteed by Sklar's theorem to be a distribution function.
We here show that if $G_A$ and $G_B$ are continuous and strictly monotonic, then
$D(G_A(x),G_B(y))$ is the distribution function of the random variable 
$(G_A^{-1}(U),G_B^{-1}(V))$, where $(U,V)$ now denotes the random
vector with uniform marginals associated with $D$ and
$G_A^{-1}$ and $G_B^{-1}$ are the inverses of $G_A$ and $G_B$.
The inverses exist because of the strict monotonicity assumption.
To get to the desired result, note that the distribution function of 
$(G_A^{-1}(U),G_B^{-1}(V))$ is $P[G_A^{-1}(U) \leq x, G_B^{-1}(V) \leq y]$,
which equals $P[U \leq G_A(x), V \leq G_B(y)]$, by strict monotonicity.
But this is $D(G_A(x),G_B(y))$ because $D$ is the distribution function of 
$(U,V)$. In fact, a stronger statement assuming
neither continuity nor strict monotonicity is possible, if one uses generalized
inverses for $G_A^{-1}$ and $G_B^{-1}$ [@MaiScherer2017]. We adopt the weaker
statements for simplicity and because our applications are solely under the case
of continuous, strictly monotonic margins. But see @Anderson2018 and 
@Popovic2018 for applications of copulas outside this case. 

# Details of the data \label{Data_details}

\textbf{Environmental data, soil C and N.} Measurments were from the central pedon of a soil 
core, to 1m depth. 

\textbf{Phenological and population data on aphids.}
Data pre-processing for the aphid data was the same as that of @Sheppard2016, 
except that years for which data was unavailable were excluded rather than being 
replaced by median values. We also excluded one of the 11 sites they used in 
order to only use sites with at least 30 years data.

\textbf{Population data, plankton abundances.}
These data 
were obtained from the Continuous Plankton Recorder (CPR) dataset, now operated and maintained by 
the Marine Biological Association of the United Kingdom. Data pre-processing was similar but not identical to that 
of @Sheppard2017. 
The CPR plankton data presented in @Sheppard2017 was aggregated in the following way. Fifty 
$2^\circ$ by $2^\circ$ location boxes were examined between $-10^\circ$ and $10^\circ$ longitude 
and between $50^\circ$ and $60^\circ$ latitude (Fig. \ref{fig_plankton_map}). For each species, for each box, 
for each year, for each month, the average of any available CPR samples was taken to give monthly 
time series of population densities with some missing values. Missing monthly values were then 
replaced with the median value for that species for that location for that month. The data for each 
species for each box for each year was then averaged over all twelve months, and 26 usable annual 
time series were identified for wavelet analysis. The CPR plankton data used here is aggregated in 
the same way, except that for any species, box and year for which more than 4 months data were missing, 
missing values were not replaced with medians and those species, box, year combinations were not used.
We used only data from the 14 locations which had at least 45 years of annual data subject to this 
restriction, shown by blue markers in Fig. \ref{fig_plankton_map}. The CPR data are described in
great detail elsewhere, e.g., by  @Batten2003 and @Raitsos2014.

\textbf{Community-level data, Cedar Creek.} Above-ground biomass [@ccdataple120] and percent cover data [@ccdatapce120] were 
obtained from biodiversity experiment E120 conducted at the Cedar Creek Ecosystem Science Reserve 
by Tilman *et al*. In 1994, 168 plots [@ccdataplotse120] (each 9 m $\times$ 9 m) of 39, 35, 29, 30 and 35 replicates,
were seeded with 1, 2, 4, 8, or 16 perennials, respectively, chosen randomly from a pool of 
18 species (4 species, each, of C4 grasses, C3 grasses, legumes, non-legume forbs; and 2 species of woody
plants). All plots received, in total, 10 $gm^{-2}$ of pure live seed in May 1994 and 5 $gm^{-2}$ in May, 1995 
with seed mass divided equally among species. Treatments were maintained by weeding manually 3-4 times a year 
and sometimes selective herbicides were used. We downloaded the data on July, 2018 from the Cedar Creek website \url{http://www.cedarcreek.umn.edu/research/experiments/e120} and 
analyzed those data for 6 years 
(1996-2000, 2007) for which both biomass and percent cover data were available. Plots were annually 
sampled by clipping 
different locations each year. For each available year, we analyzed above-ground biomass ($gm^{-2}$) 
and Shannon's biodiversity index (computed using percent cover data) averaged over the 
sampled strips/quadrats taken from each 
of 168 plots.

\textbf{Ecosystem functioning data on methane-flux.} The Great Miami Wetland Mitigation Bank  was at 
$36^{\circ}46^{'}51^{''}$ N, $84^{\circ}20^{'}26^{''}$ W, in Trotwood, Montgomery County, Ohio. Additional information 
on the history of the site and soil types is detailed in @Jarecke2016. Briefly, the closed static flux chamber method 
was used [@Holland1999] to measure $\text{CH}_{4}$ fluxes at 28 locations across a hydrologic gradient (upland to 
seasonal wetland) at daily to weekly interval from September 2015 to September 2016. See @smyth2019using for
additional details on greenhouse gas flux methods for this site. We considered 13 locations for which data were
gathered for at least 50 dates.

<!--generating table with information about 20 aphid species-->
```{r tab_aphid_info, echo=F, results='asis',message=F}
library(tinytex)
library(tibble)
library(kableExtra)
library(dplyr)
aphid_info <- tibble(c1=c("Apple grass aphid","Bird cherry oat aphid","Black bean aphid","Blackberry cereal aphid","Blackcurrant sowthistle aphid",
                       "Corn leaf aphid","Currant lettuce aphid","Damson hop aphid","Grain aphid","Green spruce aphid",
                       "Leaf-curling plum aphid","Mealy cabbage aphid","Mealy plum aphid","Pea aphid","Peach potato aphid",
                       "Potato aphid","Rose grain aphid","Shallot aphid","Sycamore aphid","Willow carrot aphid"),
                     c2=c("Rhopalosiphum insertum", "Rhopalosiphum padi", "Aphis fabae", "Sitobion fragariae", "Hyperomyzus lactucae",
                       "Rhopalosiphum maidis", "Nasonovia ribisnigri","Phorodon humuli","Sitobion avenae","Elatobium abietinum",
                       "Brachycaudus helichrysi","Brevicoryne brassicae","Hyalopterus pruni","Acyrthosiphon pisum","Myzus persicae",
                       "Macrosiphum euphorbiae","Metopolophium dirhodum","Myzus ascalonicus","Drepanosiphum platanoidis","Cavariella aegopodii")
)

saveRDS(aphid_info,"./Results/aphid_info.RDS")
knitr::kable(aphid_info, "latex", booktabs = T, linesep = "",
      caption = "Species names of 20 aphids for which data were available \\label{tab_aphid_info}",
      col.names = NULL)%>%
     column_spec(column = 2,italic=T)%>%add_header_above(header=c("Common name" = 1, "Latin binomial" = 1))
```

<!--generating table with information about 22 plankton species-->
```{r tab_plankton_info, echo=F, results='asis',message=F}
library(tibble)
plankton_info <- tibble(c1=c('Calanus stages I-IV','Para-pseudocalanus spp.','Temora longicornis','Acartia sp.',
                          'Centropages typicus',
                          'Oithona sp.','Echinoderm larvae','Calanus finmarchicus',
                          'Calanus helgolandicus','Metridia lucens','Decapoda larvae',
                   'Euphausiids','Thalassiosira sp.','Rhizosolenia styliformis',
                   'Ceratium fusus','Ceratium furca','Ceratium tripos','Ceratium macroceros',
                   'Proboscia alata','Pseudocalanus sp.',
                   'Pseudo-nitzschia delicatissima','Pseudo-nitzschia seriata')
)
cns<-c('Echinoderm larvae','Euphausiids','Decapoda larvae')
'%ni%' <- Negate('%in%')
idn<-which(plankton_info$c1%ni%cns)
knitr::kable(plankton_info, "latex", booktabs = T, linesep = "",
      caption = "Species names of 22 plankton taxa for which data were available \\label{tab_plankton_info}",
      col.names = c("Plankton taxon name"))%>%row_spec(row=idn,italic=T)
```

<!--survival clayton copula-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SurvClayton.pdf}
\caption[Example survival Clayton copulas]{Log-transformed pdfs (A-E) and samples (F-J) 
from example survival Clayton 
copulas. K is Kendall correlation; p is the value of the parameter for the survival Clayton 
family (it is a one-parameter family); and LT and UT are the measures of lower- and 
upper-tail dependence, respectively. The parameter range for the family is $p \in (0,\infty)$, upper-tail dependence is $2^{-1/p}$ and lower-tail
dependence is $0$.\label{figped_SC}}
\end{center}
\end{figure}

<!--embedding plot with sampling locations : soilCN, aphids, planktons-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm,height=16 cm]{./Results/SoilCNmapUSA.pdf} 
\caption[Sampling locations for C and N data]{Locations of central pedons sampled 
for soil organic carbon and total soil nitrogen (Mg C or N per hectare of soil 
surface) at 5907 sites across the coterminous United States. \label{fig_SoilCNmapUSA}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm,height=16 cm]{./Results/aphid_map_plot.pdf} 
\caption[Sampling locations for aphid data]{Locations of the 
Rothamsted Insect Survey 
suction traps from which data were available are indicated by the red circles, 
out of which only blue boxes had at least 30 years of data and were 
used for our study. \label{fig_aphid_map}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm,height=16 cm]{./Results/plankton_map_plot.pdf} 
\caption[Sampling regions for CPR plankton data]{CPR data were available from 
26 locations ($2^{\circ}$ $\times$ $2^{\circ}$ regions on the map) around UK 
seas (red circles), out of which only blue boxes had at least 45 years of data and
were used for our study. \label{fig_plankton_map}}
\end{center}
\end{figure}

<!--Now the copula figures that were not presented in the main text-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_Gumbel.pdf}
\caption[Example Gumbel copulas]{Log-transformed pdfs (A-E) and samples (F-J) from example Gumbel copulas. K is Kendall 
correlation; $p$ is the value of the parameter for the Gumbel family (it is a 
one-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively. The parameter range for the family is $p \in [1,\infty)$, lower-tail dependence is $0$ and upper-tail
dependence is $2-2^{1/p}$.\label{figped_G}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SurvGumbel.pdf}
\caption[Example survival Gumbel copulas]{Log-transformed pdfs (A-E) and samples (F-J) from example survival Gumbel 
copulas. K is Kendall correlation; $p$ is the value of the parameter for the survival Gumbel 
family (it is a one-parameter family); and LT and UT are the measures of lower- and 
upper-tail dependence, respectively. The parameter range for the family is $p \in [1,\infty)$, upper-tail dependence is $0$ and lower-tail
dependence is $2-2^{1/p}$.\label{figped_SG}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_Joe.pdf}
\caption[Example Joe copulas]{Log-transformed pdfs (A-E) and samples (F-J) from example Joe copulas. K is Kendall correlation; $p$ is the value of the parameter for the Joe family (it is a 
one-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively. The parameter range for the family is $p \in [1,\infty)$, lower-tail dependence is $0$ and upper-tail
dependence is $2-2^{1/p}$.\label{figped_J}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SurvJoe.pdf}
\caption[Example survival Joe copulas]{Log-transformed pdfs (A-E) and samples (F-J) from example survival Joe  
copulas. K is Kendall correlation; $p$ is the value of the parameter for the survival Joe  
family (it is a one-parameter family); and LT and UT are the measures of lower- and 
upper-tail dependence, respectively. The parameter range for the family is $p \in [1,\infty)$, upper-tail dependence is $0$ and lower-tail
dependence is $2-2^{1/p}$.\label{figped_SJ}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_Frank.pdf}
\caption[Example Frank copulas]{Log-transformed pdfs (A-E) and samples (F-J) from example Frank copulas. K is Kendall correlation; $p$ is the value of the parameter for the Frank family (it is a 
one-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively. The parameter range for the family is $p \in (0,\infty)$, lower-tail dependence is $0$ and upper-tail
dependence is $0$.\label{figped_F}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SBB1.pdf}
\caption[Example survival BB1 copulas]{Log-transformed pdfs for example survival BB1 copulas. K is Kendall correlation; $p_1$ and $p_2$ 
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively. The parameter ranges for the family are $p_1 \in (0,\infty)$
and $p_2 \in [1,\infty)$, lower-tail dependence is $2-2^{1/p_2}$ and upper-tail
dependence is $2^{-1/(p_1 p_2)}$.\label{figped_SBB1}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_BB6.pdf}
\caption[Example BB6 copulas]{Log-transformed pdfs for example BB6 copulas. K is Kendall correlation; $p_1$ and $p_2$
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively. The parameter ranges for the family are $p_1 \in [1,\infty)$
and $p_2 \in [1,\infty)$, lower-tail dependence is $0$ and upper-tail
dependence is $2-2^{1/(p_1 p_2)}$. \label{figped_BB6}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SBB6.pdf}
\caption[Example survival BB6 copulas]{Log-transformed pdfs for example survival BB6 copulas. K is Kendall correlation; $p_1$ and $p_2$ 
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively. The parameter ranges for the family are $p_1 \in [1,\infty)$
and $p_2 \in [1,\infty)$, upper-tail dependence is $0$ and lower-tail
dependence is $2-2^{1/(p_1 p_2)}$.\label{figped_SBB6}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_BB7.pdf}
\caption[Example BB7 copulas]{Log-transformed pdfs for example BB7 copulas. K is Kendall correlation; $p_1$ and $p_2$
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively. The parameter ranges for the family are $p_1 \in [1,\infty)$
and $p_2 \in (0,\infty)$, lower-tail dependence is $2^{-1/p_2}$ and upper-tail
dependence is $2-2^{1/p_1}$.\label{figped_BB7}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SBB7.pdf}
\caption[Example survival BB7 copulas]{Log-transformed pdfs for example survival BB7 copulas. K is Kendall correlation; $p_1$ and $p_2$ 
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively. The parameter ranges for the family are $p_1 \in [1,\infty)$
and $p_2 \in (0,\infty)$, upper-tail dependence is $2^{-1/p_2}$ and lower-tail
dependence is $2-2^{1/p_1}$.\label{figped_SBB7}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_BB8.pdf}
\caption[Example BB8 copulas]{Log-transformed pdfs for example BB8 copulas. K is Kendall correlation; $p_1$ and $p_2$
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively. The parameter ranges for the family are $p_1 \in [1,\infty)$
and $p_2 \in (0,1]$, lower-tail dependence is $0$ and upper-tail
dependence is $2-2^{1/p_1}$ of $p_2=1$ and $0$ otherwise.\label{figped_BB8}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7.5in]{./Results/PedagogSuppMat_SBB8.pdf}
\caption[Example survival BB8 copulas]{Log-transformed pdfs for example survival BB8 copulas. K is Kendall correlation; $p_1$ and $p_2$ 
denote the two parameters of the family (it is a 
two-parameter family); and LT and UT are the measures of lower- and upper-tail dependence, 
respectively. The parameter ranges for the family are $p_1 \in [1,\infty)$
and $p_2 \in (0,1]$, upper-tail dependence is $0$ and lower-tail
dependence is $2-2^{1/p_1}$ of $p_2=1$ and $0$ otherwise.\label{figped_SBB8}}
\end{center}
\end{figure}

# Nonparametric statistics \label{nonparam_stats}

\noindent We define $\Ps_{l_b,u_b}$, using the bounds
$u+v=2l_b$ and $u+v=2u_b$ defined in the main text, as follows. For a distance $h$, we define
$S(h)$ to be the number of points $(u_i,v_i)$ within the bounds 
and a distance less than $h$ from the line $v=u$, divided by the 
total number of points within the bounds. This function is
defined for $h$ going from $0$ to a distance $h_{\text{max}}$ which
is half the longer of the two segments obtained by intersecting the
bounds with the unit square. It is easy to see $S(0)=0$ and 
$S(h_{\text{max}})=1$. We define $S_i(h)$, also for $h$ going from $0$
to $h_{\text{max}}$, to be the area within the bounds and the unit square
and within distance $h$ of the line $v=u$, divided by the area
within the bounds and the unit square. This is the expected value of
$S(h)$ for independent data. We then define
\begin{equation}\label{eq.P}
   P_{l_b,u_b} = \int_0^{h_{\text{max}}} ( S(h) - S_i(h) ) dh.
\end{equation}
\noindent As for $\cor_{l_b,u_b}$, larger values of $\Ps_{l_b,u_b}$ 
indicate stronger positive association
between $u$ and $v$ in the region given by the bounds.
We use both statistics 
because $\cor_{l_{b_k},u_{b_k}}(u,v)$ is more familiar, but 
in some instances $\Ps_{l_b,u_b}$ appears to have more power to
reveal tail dependence.

<!--Decided we do not need this fig.
\begin{figure}[!h]
\begin{center}
\includegraphics[width=6 cm,height=6 cm]{./stat_image.jpg} \hspace{0.6 cm}
\caption[For definitions of nonparametric statistics]{Schematic diagram supporting definitions of nonparametric tail dependence statistics. The blue and red lines are, respectively, $u+v=2l_b$ and $u+v=2u_b$.\label{fig_stat_image}}
\end{center}
\end{figure}-->

# Testing the nonparametric statistics \label{Test_npa_stat}

Normal and Frank copula families 
are known to have symmetric tail dependence,
i.e., strengths of dependence in the lower and upper tails are the same, for all copulas
in these families [@nelsen2006_copula]. Clayton copulas are known to have stronger lower- than 
upper-tail dependence, and survival Clayton copulas, being rotations of Clayton copulas by 
$180^\circ$, have stronger upper- than lower tail dependence [@nelsen2006_copula].
Using the `iRho` function from the `copula` package, for each of the four families normal, 
Frank, Clayton, and survival Clayton, we obtained parameters for which the expected value of 
Spearman's $\rho$ was, separately, $0,0.1,0.2,...,0.9$. For each copula family and for each 
of the selected parameter values we generated  $n$ points, 100 times, and thereby 
computed 100 values of the 
statistics $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$. This exercise 
was repeated, separately, 
for $n=1000$ and for $n=35$, these cases being chosen, respectively, to reflect 
asymptotic behavior of the 
statistics and their behavior on the small datasets which are common in some fields
of ecology. The mean and standard error of the three difference statistics were computed for 
each copula family, parameter value, and value of $n$, and results were plotted against 
Spearman's rho (Figs \ref{fig_stat_testing35} and \ref{fig_stat_testing1000}), 
the expectation being that the difference statistics would be positive for 
Clayton copulas, negative for survival Clayton copulas (except for the case of $\rho=0$, a 
boundary case of these families corresponding to independence), and not significantly different 
from $0$ for Frank and normal 
copulas.
We used a $t$-test with a significance threshold of $0.05$ to judge significance here.
These expectations were fulfilled (Figs \ref{fig_stat_testing35} and 
\ref{fig_stat_testing1000}).

<!--Simulation for testing non-parametric statistics with different copulas :
The message=F is to suppress warnings that come when you pass a parameter
of 0 to the Frank or Clayton copulas. These are technicallly boundary cases for these families.
They correspond to the independent copula. The packages we use provide the indepdent copula, but
issue a message.-->
```{r stat_testing_save_and_plot_result, message=F, results="hide", echo=F, cache=T, cache.extra=list(seed,busycores,mtime("TestStats_multivar_dataset.R"),mtime("CopulaFunctions.R"),mtime("CopulaFunctions_flexible.R"))}
source("TestStats_multivar_dataset.R")
set.seed(seed)

resultsloc<-"./Results/stat_results/stat_testing/"
spearvals<-seq(from=0,to=0.9,by=0.1)
callfn<-coplist_with_params(spearvals=spearvals)
coplist<-callfn$coplist

res_pt35_rankF<-mclapply(X=coplist,FUN=worker,numpts=35,numsims=100,rank=F,mc.cores=busycores)
res_pt35_rankT<-mclapply(X=coplist,FUN=worker,numpts=35,numsims=100,rank=T,mc.cores=busycores)
res_pt1000_rankF<-mclapply(X=coplist,FUN=worker,numpts=1000,numsims=100,rank=F,mc.cores=busycores)
res_pt1000_rankT<-mclapply(X=coplist,FUN=worker,numpts=1000,numsims=100,rank=T,mc.cores=busycores)
save(res_pt35_rankF,res_pt35_rankT,res_pt1000_rankF,res_pt1000_rankT,file=paste(resultsloc,"StatTestNumericResults.RData",sep=''))

b<-callfn$paramlist
plotter_stat_testing(res_pt35_rankF,"res_pt35_rankF",b,resultsloc,spearvals)
plotter_stat_testing(res_pt35_rankT,"res_pt35_rankT",b,resultsloc,spearvals)
plotter_stat_testing(res_pt1000_rankF,"res_pt1000_rankF",b,resultsloc,spearvals)
plotter_stat_testing(res_pt1000_rankT,"res_pt1000_rankT",b,resultsloc,spearvals)
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/stat_results/stat_testing/res_pt35_rankT.pdf}
\caption[Testing nonparametric statistics with 35 data points]{Results of tests of whether $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$ reveal the known asymmetry of tail dependence of the Clayton and survival Clayton copulas, and the known symmetry of tail dependence of the normal and Frank copulas. See Appendix  \ref{Test_npa_stat} for details. $n=35$. \label{fig_stat_testing35}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/stat_results/stat_testing/res_pt1000_rankT.pdf}
\caption[Testing nonparametric statistics with 1000 data points]{Results of tests of whether $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, and $\Dsq_u-\Dsq_l$ reveal the known asymmetry of tail dependence of the Clayton and survival Clayton copulas, and the known symmetry of tail dependence of the normal and Frank copulas. See Appendix  \ref{Test_npa_stat} for details. $n=1000$.\label{fig_stat_testing1000}}
\end{center}
\end{figure}


<!--This chunk is for model selection results of soilCN dataset-->
```{r bivmodselect_Loecke, echo=F, cache=T, cache.extra=list(seed,v_CN,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("OurBiCopSelect.R")
set.seed(seed)
families_Loecke<-c(1,3:10,13:14,16:20) 
BivMS_res_Loecke<-OurBiCopSelect(u1=v_CN[,1],u2=v_CN[,2],families=families_Loecke,level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,gofnormal=F,status=F)
saveRDS(BivMS_res_Loecke,file="./Results/fitting_results/BivMS_soilCN.RDS")
```

<!--This chunk is for npa testing results of soilCN dataset-->
```{r stat_soilCN_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,v_CN,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed) 
stat_soilCN_ga<-bivfunctionplot(v=v_CN,resloc="./Results/stat_results/stat_soilCN/",nametag="soilCN",numbin=10)
```

<!--Simulations for model selection results with Birds' BMR data-->
```{r bivmodselect_birds_BMR, echo=F, cache=T, cache.extra=list(seed,cop_b,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("OurBiCopSelect.R")
set.seed(seed)
BivMS_birds<-OurBiCopSelect(u1=cop_b[,1],u2=cop_b[,2],families=c(1,3:10,13:14,16:20),
                              level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,
                              gofnormal=F,status=F)
saveRDS(BivMS_birds,file="./Results/BMR_results/birds/BivMS_birds.RDS")
```

<!--Display model selection results for BMR:birds data in a table-->
```{r tab_bmr_birds_fit, echo=F, results='markup'}
h<-BivMS_birds$InfCritRes[,c("copname","AIC","AICw","BIC","BICw","LTdep","UTdep")]
colnames(h)<-c("Copula","AIC","AICw","BIC","BICw","LT","UT")
h_ord <- h[order(h$AIC),] #sorting data: min AIC to max AIC

#---- This line forces the formating which is not always true by using digits arg in kable function ----
h_ord$AIC<-formatC(h_ord$AIC,2,format="f")
h_ord$AICw<-formatC(h_ord$AICw,2,format="f")
h_ord$BIC<-formatC(h_ord$BIC,2,format="f")
h_ord$BICw<-formatC(h_ord$BICw,2,format="f")
h_ord$LT<-formatC(h_ord$LT,4,format="f")
h_ord$UT<-formatC(h_ord$UT,4,format="f")
#-------------------------------------------------

knitr::kable(h_ord,
             format='latex',linesep = "",row.names = F, #digits = c(4,2,2,2,2,4,4),
             caption.short = "Model fitting results for the bird body mass and BMR dataset",
             caption = "Results of fitting our 16 copula families to the bird body mass and BMR dataset. Analogous to Fig. \\ref{MT-tab_soilCNfit}, see caption of that figure for details. \\label{tab_bmr_birds_fit}",
             booktabs=T)
```

<!--This chunk is for npa testing results for Birds' BMR dataset-->
```{r stat_bmr_birds_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,cop_b,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed)
stat_birds_ga<-bivfunctionplot(v=cop_b,resloc="./Results/BMR_results/birds/",nametag="birds_numbin_10",numbin = 10)
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/BMR_results/birds/birds_numbin_10_bivfunctionplot.pdf}
\caption[Nonparametric tests against a normal-copula null, bird body mass and BMR data]{Nonparametric tests for tail dependence and other deviations from normal copula structure, for bird body mass and BMR data. Same format as Fig. \ref{MT-fig_soilCN_nonparam}, see caption of that figure. \label{fig_bmr_birds_nonparam}}
\end{center}
\end{figure}


<!--Simulations for model selection results with Mammals' BMR data-->
```{r bivmodselect_mammals_BMR, echo=F, cache=T, cache.extra=list(seed,cop_m,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("OurBiCopSelect.R")
set.seed(seed)
BivMS_mammals<-OurBiCopSelect(u1=cop_m[,1],u2=cop_m[,2],families=c(1,3:10,13:14,16:20),
                              level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,
                              gofnormal=F,status=F)
saveRDS(BivMS_mammals,file="./Results/BMR_results/mammals/BivMS_mammals.RDS")
```

<!--Display model selection results for BMR:mammals data in a table-->
```{r tab_bmr_mammals_fit, echo=F, results='markup'}
h<-BivMS_mammals$InfCritRes[,c("copname","AIC","AICw","BIC","BICw","LTdep","UTdep")]
colnames(h)<-c("Copula","AIC","AICw","BIC","BICw","LT","UT")
h_ord <- h[order(h$AIC),] #sorting data: min AIC to max AIC

#---- This line forces the formating which is not always true by using digits arg in kable function ----
h_ord$AIC<-formatC(h_ord$AIC,2,format="f")
h_ord$AICw<-formatC(h_ord$AICw,2,format="f")
h_ord$BIC<-formatC(h_ord$BIC,2,format="f")
h_ord$BICw<-formatC(h_ord$BICw,2,format="f")
h_ord$LT<-formatC(h_ord$LT,4,format="f")
h_ord$UT<-formatC(h_ord$UT,4,format="f")
#-------------------------------------------------

knitr::kable(h_ord,
             format='latex',linesep = "",row.names = F, #digits = c(4,2,2,2,2,4,4),
             caption.short = "Model fitting results for the mammal body mass and BMR dataset",
             caption = "Results of fitting our 16 copula families to the mammal body mass and BMR dataset. Analogous to Fig. \\ref{MT-tab_soilCNfit}, see caption of that figure for details. \\label{tab_bmr_mammals_fit}",
             booktabs=T)
```

<!--This chunk is for npa testing results for Mammals' BMR dataset-->
```{r stat_bmr_mammals_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,cop_m,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed)
stat_mammals_ga<-bivfunctionplot(v=cop_m,resloc="./Results/BMR_results/mammals/",nametag="mammals_numbin_10",numbin = 10)
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/BMR_results/mammals/mammals_numbin_10_bivfunctionplot.pdf}
\caption[Nonparametric tests against a normal-copula null, mammal body mass and BMR data]{Nonparametric tests for tail dependence and other deviations from normal copula structure, for mammal body mass and BMR data. Same format as Fig. \ref{MT-fig_soilCN_nonparam}, see caption of that figure. \label{fig_bmr_mammals_nonparam}}
\end{center}
\end{figure}


<!--Simulations for model selection results with Cedar creek data-->
```{r bivmodselect_cc, echo=F, cache=T, cache.extra=list(seed,cop_HB_all_yr,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("OurBiCopSelect.R")
set.seed(seed)

BivMS_res_cc<-vector("list",length(cop_HB_all_yr))
names(BivMS_res_cc)<-names(cop_HB_all_yr)

for(i in 1:length(BivMS_res_cc)){
  BivMS_res_cc[[i]]<-OurBiCopSelect(u1=cop_HB_all_yr[[i]]$avg.H,u2=cop_HB_all_yr[[i]]$avg.Biomass,
                                    families=c(1,3:10,13:14,16:20),
                                    level=0.05,AICBIC="AIC",
                                    numBSsmall=100,pthresh=0.2,numBSlarge=1000,gofnormal=F,status=F)
}
saveRDS(BivMS_res_cc,file="./Results/Ceder_creek_results/BivMS_res_cc.RDS")
BivMS_res_cc<-readRDS("./Results/Ceder_creek_results/BivMS_res_cc.RDS")
```

<!--Display model selection results for Cedar-creek data for year 2000 in a table-->
```{r tab_cc2000fit, echo=F, results='markup'}
h<-BivMS_res_cc$`2000`$InfCritRes[,c("copname","AIC","AICw","BIC","BICw","LTdep","UTdep")]
colnames(h)<-c("Copula","AIC","AICw","BIC","BICw","LT","UT")
h_ord <- h[order(h$AIC),] #sorting data: min AIC to max AIC

#---- This line forces the formating which is not always true by using digits arg in kable function ----
h_ord$AIC<-formatC(h_ord$AIC,2,format="f")
h_ord$AICw<-formatC(h_ord$AICw,2,format="f")
h_ord$BIC<-formatC(h_ord$BIC,2,format="f")
h_ord$BICw<-formatC(h_ord$BICw,2,format="f")
h_ord$LT<-formatC(h_ord$LT,4,format="f")
h_ord$UT<-formatC(h_ord$UT,4,format="f")
#-------------------------------------------------

knitr::kable(h_ord,
             format='latex',linesep = "",row.names = F, #digits = c(4,2,2,2,2,4,4),
             caption.short = "Model fitting results for the Cedar Creek dataset",
             caption = "Results of fitting our 16 copula families to the Cedar Creek dataset, year 2000. Analogous to Fig. \\ref{MT-tab_soilCNfit}, see caption of that figure for details. \\label{tab_cc2000fit}",
             booktabs=T)
```

<!--This chunk is for npa testing results for Cedar creek dataset-->
```{r stat_cc_graphic_approach, echo=F, results="hide", cache=T, cache.extra=list(seed,cop_HB_all_yr,mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
source("bivfunctionplot.R")
set.seed(seed)

stat_cc_ga<-vector("list",length(cop_HB_all_yr))
names(stat_cc_ga)<-names(cop_HB_all_yr)

for(i in 1:length(stat_cc_ga)){
  temp<-bivfunctionplot(v=cop_HB_all_yr[[i]],
                             resloc="./Results/Ceder_creek_results/",
                             nametag=paste0(names(cop_HB_all_yr)[i],"cc_numbin_4",sep=""),
                             numbin = 4)
  stat_cc_ga[[i]]<-temp
}

saveRDS(stat_cc_ga,"./Results/Ceder_creek_results/stat_cc_ga.RDS")
```

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/Ceder_creek_results/2000cc_numbin_4_bivfunctionplot.pdf}
\caption[Nonparametric tests against a normal-copula null, Cedar Creek data]{Nonparametric tests for tail dependence and other deviations from normal copula structure, for Cedar Creek data, year 2000. As described in the main text, the values of the statistics $\cor_{l_b,u_b}$, $\Ps_{l_b,u_b}$ and $\Dsq_{l_b,u_b}$ for real data (red crosses) were compared to distributions of their values on 1000 Kendall- or Spearman-preserving normal surrogates of the data (blue and green x's show 0.025 and 0.975 quantiles), separately in two comparisons for each of the ranges $(l_b,u_b)=(0,0.25),\ldots,(0.75,1)$. If the red cross was outside the range given by the x's, text at the top of panels indicates the number of surrogate values the real-data value was greater than or less than. For instance, a value $>N$ (respectively, $<N$) means the value of the statistic on real data was greater than (respectively, less than) its value on $N$ surrogates. When the statistic was greater than 975 or less than 975 surrogate values, it indicates significance ($95\%$ confidence level). When $\cor$ or $\Ps$ values (respectively, $\Dsq$ values) were greater than surrogates, it means dependence in that part of the distributions was stronger than (respectively, weaker than) expected from a normal-copula null hypothesis.\label{fig_cc2000_nonparam}}
\end{center}
\end{figure}

<!--Function to generate a table containing summary results for all bivariate datasets-->
```{r bivar_tab_summary_fn,echo=F}
bivar_tab_summary_fn<-function(r,rs){
  
  m<-matrix(NA,1,10)
  colnames(m)<-c("p.Independence.test","minimumAIC.bestfit.copula","Bestfit.copula.AIC",
                 "Normal.copula.AIC","p.CvM","p.KS",
                 "LT.model.avg","UT.model.avg","(LT-UT).model.avg",
                 "Rank.(Pl-Pu)")
  m<-as.data.frame(m)
  
  m$p.Independence.test<-round(r$IndepTestRes,3)
  m$minimumAIC.bestfit.copula<-r$InfCritRes$copname[which.min(r$InfCritRes$AIC)]
  m$Bestfit.copula.AIC<-round(min(r$InfCritRes$AIC),2)
  m$Normal.copula.AIC<-round(r$InfCritRes$AIC[1],2)
  m$p.CvM<-r$GofRes_CvM
  m$p.KS<-r$GofRes_KS
  m$LT.model.avg<-round(r$relLTdep_AICw,4)
  m$UT.model.avg<-round(r$relUTdep_AICw,4)
  m$`(LT-UT).model.avg`<-m$LT.model.avg-m$UT.model.avg
  m$`Rank.(Pl-Pu)`<-rs$Rank_PlmPu_K
  mt<-as.data.frame(t(m))
  return(mt)
  
}
#----------------------------------
#calling the above function on bivariable datasets
m1<-bivar_tab_summary_fn(r=BivMS_res_Loecke,rs=stat_soilCN_ga)
m2<-bivar_tab_summary_fn(r=BivMS_birds,rs=stat_birds_ga)
m3<-bivar_tab_summary_fn(r=BivMS_mammals,rs=stat_mammals_ga)
m4<-bivar_tab_summary_fn(r=BivMS_res_cc$`2000`,rs=stat_cc_ga$`2000`)
tab_bivar_summary<-cbind(m1,m2,m3,m4)
colnames(tab_bivar_summary)<-c("SoilCN","Birds' BMR","Mammals' BMR","Ceder-creek")
saveRDS(tab_bivar_summary,"./Results/tab_bivar_summary.RDS")
```

<!--Sourcing Function to generate a table for npa results-summary with bivariate data, this one about asymmetry of tail dependence-->
```{r source_make_table_stat_fn, echo=F}
source("./make_table_stat_fn.R")
```

<!--Displaying a table with npa summary results for soilCN data-->
```{r tab_biv_npa_summary,echo=F,results="asis"}
library(kableExtra)
library(dplyr)
library(tibble)

datatype <- tibble(Data = c("Soil CN","","","Bird masses and BMR","","","Mammal masses and BMR","","","Cedar Creek","",""))

tab_soilCN_asym<-make_table_stat_fn(data=stat_soilCN_ga)
tab_bmr_birds_asym<-make_table_stat_fn(data=stat_birds_ga)
tab_bmr_mammals_asym<-make_table_stat_fn(data=stat_mammals_ga)
tab_cc_asym_2000<-make_table_stat_fn(data=stat_cc_ga$`2000`)
tab_biv_npa_summary<-rbind(tab_soilCN_asym,tab_bmr_birds_asym, tab_bmr_mammals_asym, tab_cc_asym_2000)

tab_biv_npa_summary<-cbind(datatype,tab_biv_npa_summary)
saveRDS(tab_biv_npa_summary,"./Results/stat_results/tab_biv_npa_summary.RDS")

tab_3biv_npa_summary<-tab_biv_npa_summary[c(4:12),]

knitr::kable(tab_3biv_npa_summary, booktabs = T, escape=F,
             format = "latex",linesep = "", row.names=F,
      caption.short = "Nonparametric asymmetry tests against a normal-copula null model with birds, mammals and Cedar Creek data",
      caption = "Nonparametric asymmetry tests against a normal-copula null model with birds, mammals and Cedar Creek data. For bird and mammal data, results should be interpreted in the same way as soil C and N results (Table \\ref{MT-tab_soilCN_asym}). For Cedar Creek data, first slice ($FS$) and last slice ($LS$) stand for the ranges $(0,0.25)$ and $(0.75,1)$ for the lower and upper bounds.\\label{tab_3biv_npa_summary}")
```

# Surrogate testing with bivariate datasets for nonparametric statistics \label{surrog_test}

For bivariate datasets, surrogates were produced as follows.   

- Given data $(x_i,y_i)$ for $i=1,\ldots,n$ and a 
one-parameter target copula family $\mathcal{B}(\theta)$ (here $\theta$ denotes the parameter), let $\tau$ be the
Kendall correlation of the $x_i$ with the $y_i$ and find the parameter value $\theta_\tau$ for which 
$\mathcal{B}(\theta_\tau)$ has Kendall correlation $\tau$ (this is possible for the one-parameter copula families of this 
study using the `iTau` function of the `copula` package). 
- Generate data $(a_i,b_i)$, $i=1,\ldots,n$ from 
$\mathcal{B}(\theta_\tau)$. 
- Permute the ordered set $(x_1,\ldots,x_n)$ such that the permutation
$(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$ has $\rank(x_{\sigma_x(i)})$ equal to $\rank(a_i)$ for all $i$, where 
$\rank(x_{\sigma_x(i)})$ is the rank of $x_{\sigma_x(i)}$ in the set $(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$, and
$\rank(a_i)$ is the rank of $a_i$ in the set $(a_1,\ldots,a_n)$ (here $\sigma_x$ is a permutation of the 
indices $1,\ldots,n$). 
- Likewise permute $(y_1,\ldots,y_n)$
such that the permutation
$(y_{\sigma_y(1)},\ldots,y_{\sigma_y(n)})$ has $\rank(y_{\sigma_y(i)})$ equal to $\rank(b_i)$ for all $i$ ($\sigma_y$ is 
another permutation of $1,\ldots,n$).
- The surrogate dataset is $(x_{\sigma_x(i)},y_{\sigma_y(i)})$ for $i=1,\ldots,n$. 

\noindent Our code for this algorithm is `copsurrog2d` in the 
`BIVAN` repository (https://github.com/sghosh89/BIVAN). 
Because $(x_{\sigma_x(1)},\ldots,x_{\sigma_x(n)})$ 
is a permutation of $(x_1,\ldots,x_n)$ and $(y_{\sigma_y(1)},\ldots,y_{\sigma_y(n)})$ is a 
permutation 
of $(y_1,\ldots,y_n)$, the marginal distributions of the surrogate data are exactly the same as 
those of the original data. 
Because ranks of the surrogate data are matched to ranks of the $a_i$ and $b_i$, the
Kendall correlation of the surrogate dataset will be the same as that of the $a_i$ and $b_i$, and therefore 
will be close to $\tau$ (differences arising only through sampling variation). If instead of $\theta_\tau$
a parameter value $\theta_\rho$ is used such that the Spearman correlation of $\mathcal{B}(\theta_\rho)$ is the same
as that of the $x_i$ with the $y_i$, then Spearman correlations of surrogates will very nearly equal (except for 
sampling variation) the Spearman correlation of the empirical data.  

<!--Load the raw data for aphid-->
```{r read_aphid_data, echo=F}
source("aphid_data_calling.R")

# Aphid raw data for count
d0_count<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtscount141117.csv",header=F))
data_aphid_count<-d_allsp_data(d0_count)     
 
# Aphid raw data for first flight
d0_firstflight<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidtsfirstflight141117.csv",header=F))
data_aphid_ff<-d_allsp_data(d0_firstflight) 

# Time series analysis aphids winter avg temp 
temp_aphid_raw<-as.matrix(read.csv("./Data/Aphid_data/APHID_DATA_RAW/aphidmonthlytempdata.csv",header = F))

temp_aphid<-vector("list",dim(temp_aphid_raw)[1])
names(temp_aphid)<-paste("loc",c(1:dim(temp_aphid_raw)[1]),sep="")

for(il in 1:length(temp_aphid)){
  
  s<-matrix(temp_aphid_raw[il,],36,12,byrow = T)
  rownames(s)<-c(1975:2010)
  colnames(s)<-c("jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec")
  
  temp_aphid[[il]]<-s
}

winter_avg_temp<-matrix(NA,11,35)
rownames(winter_avg_temp)<-paste("loc",c(1:dim(temp_aphid_raw)[1]),sep="")
colnames(winter_avg_temp)<-c(1976:2010)

for(il in 1:length(temp_aphid)){
  temploc<-temp_aphid[[il]]
  for(i in 2:dim(temploc)[1]){
    t<-c(temploc[i-1,12],temploc[i,1:3]) # previous yr dec to present year march averaging temp.
    winter_avg_temp[il,i-1]<-mean(t,na.rm = T)
  }
}

aphid_winter_temp<-vector("list",11) #initializing
names(aphid_winter_temp)<-rownames(winter_avg_temp)

for(i in 1:11){
  aphid_winter_temp[[i]]<-data.frame(Year=c(1976:2010),Dat=winter_avg_temp[i,])
}

temp_aphid<-list(aphid_winter_temp)

#-------------------------------------------------------------------------
# append winter avg temp data as sp 21 in aphid's count data

data_aphid_count_with_temp<-append(data_aphid_count,temp_aphid)
names(data_aphid_count_with_temp)[[21]]<-"winter_avg_temp"

# create res folder
if(!dir.exists("./Results/aphid_count_winter_temp_results")){
  dir.create("./Results/aphid_count_winter_temp_results/")
}

saveRDS(data_aphid_count_with_temp,"./Results/aphid_count_winter_temp_results/data_aphid_count_with_temp.RDS")
```

<!--Simulation for model selection and non-parametric analysis with aphids count data for all 20 sp.-->
```{r modelsel_and_npa_aphid_count_allsp, echo=F, cache=T, cache.extra=list(seed,busycores,data_aphid_count,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"),mtime("NonParamStat.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

set.seed(seed)
library(parallel)
source("FittingCopula_selective_loc.R")
RES_all_sp_aphid_count<-mclapply(X=c(1:20),FUN=RES_single_sp,d_allsp=data_aphid_count,
                                 families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30,
                                 good_loc_given=F,good_loc=NA,mc.cores=busycores)
saveRDS(RES_all_sp_aphid_count,"./Results/fitting_results/RES_all_sp_aphid_count.RDS")

source("good_loclist.R")
source("NonParamStat.R")
resloc<-"./Results/stat_results/stat_aphid_count/"
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_count_allsp<-vector("list",20)

for(sp in 1:20){
  nm<-paste("sp_",sp,sep="")
  resloc2<-paste(resloc,nm,sep="")
   if (!dir.exists(resloc2)){
    dir.create(resloc2)
  }
  good_loc<-good_loclist(d_allsp=data_aphid_count,sp=sp,data_pt_thrs=30)
  
  temp<-multcall(d_allsp=data_aphid_count,sp=sp,lats=lats,longs=longs,
                 pfname=paste(resloc2,"/","Sp_",sp,sep=''),good_loc=good_loc)
  stat_aphid_count_allsp[[sp]]<-temp
}
saveRDS(stat_aphid_count_allsp,paste(resloc,file="stat_aphid_count_all_sp.RDS",sep=''))


summary_aphid_count_allsp<-as.data.frame(matrix(NA,nrow=20,ncol=8))
colnames(summary_aphid_count_allsp)<-c("species","#LTmUT>0","#LTmUT<0","val_LTmUT>0","val_LTmUT<0",
                                     "CorlmCoru_mean_CI","PlmPu_mean_CI","D2umD2l_mean_CI")

for(sp in c(1:20)){
  #cat("sp=",sp,"\n")
  summary_aphid_count_allsp$species[sp]<-sp
  LTmUT<-(RES_all_sp_aphid_count[[sp]]$LTdep_AICw - RES_all_sp_aphid_count[[sp]]$UTdep_AICw) 
  summary_aphid_count_allsp$`#LTmUT>0`[sp]<-sum(LTmUT>0,na.rm=T)
  summary_aphid_count_allsp$`#LTmUT<0`[sp]<-sum(LTmUT<0,na.rm=T)
  ind_LTmUT_pos<-which(LTmUT>0,arr.ind = T)
  summary_aphid_count_allsp$`val_LTmUT>0`[sp]<-sum(LTmUT[ind_LTmUT_pos])
  ind_LTmUT_neg<-which(LTmUT<0,arr.ind = T)
  summary_aphid_count_allsp$`val_LTmUT<0`[sp]<-sum(LTmUT[ind_LTmUT_neg])
  
  summary_aphid_count_allsp$CorlmCoru_mean_CI[sp]<-list(
    c(unname(round(stat_aphid_count_allsp[[sp]]$numericdf[9,c(2:4)],3))))
  summary_aphid_count_allsp$PlmPu_mean_CI[sp]<-list(
    c(unname(round(stat_aphid_count_allsp[[sp]]$numericdf[10,c(2:4)],3))))
  summary_aphid_count_allsp$D2umD2l_mean_CI[sp]<-list(
    c(unname(round(stat_aphid_count_allsp[[sp]]$numericdf[11,c(2:4)],3))))
}
saveRDS(summary_aphid_count_allsp,"./Results/summary_aphid_count_allsp.RDS")
```

<!--Do the model selection for Green spruce aphid's abundance data and then showing results in Tables-->
```{r RES_aphid_count, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file
set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_aphid_count<-RES_single_sp(d_allsp=data_aphid_count,sp=10,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30,
                               good_loc_given=F,good_loc=NA)
#cat(paste("stop-time: ",Sys.time(),"\n"))
resloc<-"./Results/fitting_results/"
saveRDS(RES_aphid_count,paste(resloc,file="AphidCopulaFit_selecloc_count_species_10.RDS",sep=""))
```

<!--table for Best-fitting copulas, green spruce aphid abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_count_bestcop, echo=F, results="markup"}
#library(dplyr)
#knitr::opts_knit$set(kable.force.latex = TRUE)
knitr::kable(RES_aphid_count$info_ord_copname[,,1], #longtable = T,
             format='latex',linesep = "",
             caption.short = "Best-fitting copulas, green spruce aphid abundance data",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for green spruce aphid abundance data. Copulas considered were the normal (N), Clayton (C), Gumbel (G), Frank (F), Joe (J), BB1, BB6, BB7, BB8, survival Clayton (SC), survival Gumbel (SG), survival Joe (SJ), survival BB1 (SBB1), survival BB6 (SBB6), survival BB7 (SBB7), and survival BB8 (SBB8) copulas. NA occurs along the diagonal of the matrix because the diagonal represents a sampling location compared to itself.\\label{tab_count_bestcop}",
             booktabs=TRUE
             )#%>% # only with 'latex'/'html' format
 # kableExtra::kable_styling(latex_options = c("striped","HOLD_position"))
```
-->

<!--table for AIC-weights of best-fitting copulas, green spruce aphid abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_count_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$info_ord_AICw[,,1], 
             format='latex',linesep = "",digits=3,
             caption.short = "AIC weights, best-fitting copulas, green spruce aphid abundance data",
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for green spruce aphid abundance data.\\label{tab_count_AICw}",
             booktabs=TRUE
             )
```
-->

<!--table for AIC-weights of normal copula used for fitting, green spruce aphid abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_count_AICw_normal, echo=F, results='markup'}
source("normal_cop_AICw.R")
h<-normal_cop_AICw_matrix(r=RES_aphid_count)
h<-h$normal_cop_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format='latex',linesep = "",digits=3,
             caption.short = "AIC weights, normal copulas, green spruce aphid abundance data",
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for green spruce aphid abundance data, for comparison with Table \\ref{tab_count_AICw}. \\label{tab_count_AICw_normal}",
             booktabs=TRUE
             )
```
-->

<!--table for p-values from goodness of fit test (Cramer-von Mises-based test) with best-fit copula, green spruce aphid abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_count_p_CvM, echo=F, results='markup'}
knitr::kable(RES_aphid_count$gfc_p_CvM,
             format='latex',linesep = "",digits=3,
             caption.short="Goodness of fit of best-fitting copulas, green spruce aphid abundance data",
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for green spruce abundance data.\\label{tab_count_p_CvM}",
             booktabs=TRUE
             )
```
-->

<!--table for p-values from goodness of fit test (Kolmogorov-Smirnov-based test) with best-fit copula, green spruce aphid abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_count_p_KS, echo=F, results='markup'}
knitr::kable(RES_aphid_count$gfc_p_KS,
             format='latex',linesep = "",digits=3,
             caption.short="Goodness of fit of best-fitting copulas, green spruce aphid abundance data",
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for green spruce abundance data.\\label{tab_count_p_KS}",
             booktabs=TRUE
             )
```
-->

<!--table for model averaged lower tail dep., green spruce aphid abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_count_LTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$LTdep_AICw,
             format='latex',linesep = "",digits=3,
             caption.short="Lower-tail dependence, green spruce aphid abundance data",
             caption = "Model-averaged lower-tail dependence statistics for each location pair for green spruce aphid abundance data.\\label{tab_count_LTdep_AICw}",
             booktabs=TRUE
             )
```
-->

<!--table for model averaged upper tail dep., green spruce aphid abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_count_UTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_count$UTdep_AICw,
             format='latex',linesep = "",digits=3,
             caption.short="Upper-tail dependence, green spruce aphid abundance data",
             caption = "Model-averaged upper-tail dependence statistics for each location pair for green spruce aphid abundance data.\\label{tab_count_UTdep_AICw}",
             booktabs=TRUE
             )
```
-->

<!--table for model averaged lower- minus upper-tail dep., green spruce aphid abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_count_LTmUT, echo=F, results='markup'}
knitr::kable(RES_aphid_count$LTdep_AICw-RES_aphid_count$UTdep_AICw,
             digits = 3,linesep = "",
             format='latex',
             caption.short="Lower- minus upper-tail dependence, green spruce aphid abundance data",
             caption = "Model-averaged lower-tail dependence statistics minus model-averaged upper-tail dependence statistics for each location pair for green spruce aphid abundance data.\\label{tab_count_LTmUT}",
             booktabs=TRUE
             )
```
--> 

<!--Do the main computations for nonparametric analysis of green spruce aphid abundance data-->
```{r stat_aphid_count, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed) 
resloc<-"./Results/stat_results/stat_aphid_count/"

sp<-10
good_loc <- good_loclist(d_allsp=data_aphid_count,sp=sp,data_pt_thrs=30)
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_count<-multcall(d_allsp=data_aphid_count,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc)
saveRDS(stat_aphid_count,paste(resloc,file="stat_aphid_count_sp_10.RDS",sep='')) 
```

<!--***DAN: decided to remove this for AER
\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_count/Sp_10_D2u-D2l_vs_D.pdf}
\caption[Nonparametric tail statistics versus distance between locations for green spruce aphid abundance data]{Nonparametric tail statistics versus great-circle distance, $D$, between sampling locations for green spruce aphid abundance data. \label{fig_aphid_count}}
\end{center}
\end{figure}
-->

<!--Simulation for model selection and non-parametric analysis with aphids first flight data for all 20 sp.-->
```{r modelsel_and_npa_aphid_ff_allsp, echo=F, cache=T, cache.extra=list(seed,busycores,data_aphid_ff,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"),mtime("NonParamStat.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

set.seed(seed)
library(parallel)
source("FittingCopula_selective_loc.R")
RES_all_sp_aphid_ff<-mclapply(X=c(1:20),FUN=RES_single_sp,d_allsp=data_aphid_ff,
                                 families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30,
                                 good_loc_given=F,good_loc=NA,mc.cores=busycores)
saveRDS(RES_all_sp_aphid_ff,"./Results/fitting_results/RES_all_sp_aphid_ff.RDS")

source("good_loclist.R")
source("NonParamStat.R")
resloc<-"./Results/stat_results/stat_aphid_ff/"
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_ff_allsp<-vector("list",20)

for(sp in 1:20){
  nm<-paste("sp_",sp,sep="")
  resloc2<-paste(resloc,nm,sep="")
   if (!dir.exists(resloc2)){
    dir.create(resloc2)
  }
  good_loc<-good_loclist(d_allsp=data_aphid_ff,sp=sp,data_pt_thrs=30)
  
  temp<-multcall(d_allsp=data_aphid_ff,sp=sp,lats=lats,longs=longs,
                 pfname=paste(resloc2,"/","Sp_",sp,sep=''),good_loc=good_loc)
  stat_aphid_ff_allsp[[sp]]<-temp
}
saveRDS(stat_aphid_ff_allsp,paste(resloc,file="stat_aphid_ff_all_sp.RDS",sep=''))


summary_aphid_ff_allsp<-as.data.frame(matrix(NA,nrow=20,ncol=8))
colnames(summary_aphid_ff_allsp)<-c("species","#LTmUT>0","#LTmUT<0","val_LTmUT>0","val_LTmUT<0",
                                     "CorlmCoru_mean_CI","PlmPu_mean_CI","D2umD2l_mean_CI")

for(sp in c(1:20)){
  #cat("sp=",sp,"\n")
  summary_aphid_ff_allsp$species[sp]<-sp
  LTmUT<-(RES_all_sp_aphid_ff[[sp]]$LTdep_AICw - RES_all_sp_aphid_ff[[sp]]$UTdep_AICw) 
  summary_aphid_ff_allsp$`#LTmUT>0`[sp]<-sum(LTmUT>0,na.rm=T)
  summary_aphid_ff_allsp$`#LTmUT<0`[sp]<-sum(LTmUT<0,na.rm=T)
  ind_LTmUT_pos<-which(LTmUT>0,arr.ind = T)
  summary_aphid_ff_allsp$`val_LTmUT>0`[sp]<-sum(LTmUT[ind_LTmUT_pos])
  ind_LTmUT_neg<-which(LTmUT<0,arr.ind = T)
  summary_aphid_ff_allsp$`val_LTmUT<0`[sp]<-sum(LTmUT[ind_LTmUT_neg])
  
  summary_aphid_ff_allsp$CorlmCoru_mean_CI[sp]<-list(
    c(unname(round(stat_aphid_ff_allsp[[sp]]$numericdf[9,c(2:4)],3))))
  summary_aphid_ff_allsp$PlmPu_mean_CI[sp]<-list(
    c(unname(round(stat_aphid_ff_allsp[[sp]]$numericdf[10,c(2:4)],3))))
  summary_aphid_ff_allsp$D2umD2l_mean_CI[sp]<-list(
    c(unname(round(stat_aphid_ff_allsp[[sp]]$numericdf[11,c(2:4)],3))))
}
saveRDS(summary_aphid_ff_allsp,"./Results/summary_aphid_ff_allsp.RDS")
```

<!--Do the model selection for leaf plum curling aphid first flight data and then showing results in Tables-->
```{r RES_aphid_ff, echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file
set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n"))
RES_aphid_ff<-RES_single_sp(d_allsp=data_aphid_ff,sp=11,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=30,
                            good_loc_given=F,good_loc=NA)
#cat(paste("stop-time: ",Sys.time(),"\n")) 
resloc<-"./Results/fitting_results/"
saveRDS(RES_aphid_ff,paste(resloc,file="AphidCopulaFit_selecloc_firstflight_species_11.RDS",sep=""))
```

<!--table for Best-fitting copulas, leaf plum curling aphid first flight data-->
<!--***DAN: decided to remove this for AER
```{r tab_ff_bestcop, echo=F, results="markup"}
knitr::kable(RES_aphid_ff$info_ord_copname[,,1], #longtable = T,
             format='latex',linesep = "",
             caption.short = "Best-fitting copulas, leaf-curling plum aphid first flight data",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for leaf-curling plum aphid first flight data. Copulas considered were as in Table \\ref{tab_count_bestcop}. NA occurs along the diagonal of the matrix because the diagonal represents a sampling location compared to itself.  \\label{tab_ff_bestcop}",
             booktabs=TRUE
             )
```
-->

<!--table for AIC-weights of best-fitting copulas, leaf plum curling aphid first flight data-->
<!--***DAN: decided to remove this for AER
```{r tab_ff_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$info_ord_AICw[,,1], 
             format='latex',linesep = "",digits=3,
             caption.short="AIC weights, best-fitting copulas, leaf-curling plum aphid first flight data",
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for leaf-curling plum aphid first flight data.\\label{tab_ff_AICw}",
             booktabs=TRUE
             )
```
-->

<!--table for AIC-weights of normal copula used for fitting, leaf plum curling aphid first flight data-->
<!--***DAN: decided to remove this for AER
```{r tab_ff_AICw_normal, echo=F, results='markup'}
source("normal_cop_AICw.R")
h<-normal_cop_AICw_matrix(r=RES_aphid_ff)
h<-h$normal_cop_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format='latex',linesep = "",digits=3,
             caption.short="AIC weights, normal copulas, leaf-curling plum aphid first flight data",
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for leaf-curlung plum aphid first flight data, for comparison with Table \\ref{tab_ff_AICw}.\\label{tab_ff_AICw_normal}",
             booktabs=TRUE
             )
```
-->

<!--table for p-values from goodness of fit test (Cramer-von Mises-based test) with best-fit copula, 
leaf plum curling aphid first flight data-->
<!--***DAN: decided to remove this for AER
```{r tab_ff_p_CvM, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$gfc_p_CvM,
             format='latex',linesep = "",digits=3,
             caption.short="Goodness of fit of best-fitting copulas, leaf-curling plum aphid first flight data",
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for leaf-curling plum aphid first flight data.\\label{tab_ff_p_CvM}",
             booktabs=TRUE
             )
```
-->

<!--table for p-values from goodness of fit test (Kolmogorov-Smirnov-based test) with best-fit copula, 
leaf plum curling aphid first flight data-->
<!--***DAN: decided to remove this for AER
```{r tab_ff_p_KS, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$gfc_p_KS,
             format='latex',linesep = "",digits=3,
             caption.short="Goodness of fit of best-fitting copulas, leaf-curling plum aphid first flight data",
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for leaf-curling plum aphid first flight data.\\label{tab_ff_p_KS}",
             booktabs=TRUE
             )
```
-->

<!--table for model averaged lower tail dep., leaf plum curling aphid first flight data-->
<!--***DAN: decided to remove this for AER
```{r tab_ff_LTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$LTdep_AICw,
             format='latex',linesep = "",digits=3,
             caption.short="Lower-tail dependence, leaf-curling plum aphid first flight data",
             caption = "Model-averaged lower-tail dependence statistics for each location pair for leaf-curling plum aphid first flight data.\\label{tab_ff_LTdep_AICw}",
             booktabs=TRUE
             )
```
-->

<!--table for model averaged upper tail dep., leaf plum curling aphid first flight data-->
<!--***DAN: decided to remove this for AER
```{r tab_ff_UTdep_AICw, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$UTdep_AICw,
             format='latex',linesep = "",digits=3,
             caption.short="Upper-tail dependence, leaf-curling plum aphid first flight data",
             caption = "Model-averaged upper-tail dependence statistics for each location pair for leaf-curling plum aphid first flight data.\\label{tab_ff_UTdep_AICw}",
             booktabs=TRUE
             )
```
-->

<!--table for model averaged lower- minus upper-tail dep., leaf plum curling aphid first flight data-->
<!--***DAN: decided to remove this for AER
```{r tab_ff_LTmUT, echo=F, results='markup'}
knitr::kable(RES_aphid_ff$LTdep_AICw-RES_aphid_ff$UTdep_AICw,
             digits = 3,
             format='latex',linesep = "",
             caption.short="Lower- minus upper-tail dependence, leaf-curling plum aphid first flight data",
             caption = "Model-averaged lower-tail dependence statistics minus model-averaged upper-tail dependence statistics for each location pair for leaf-curling plum aphid first flight data.\\label{tab_ff_LTmUT}",
             booktabs=TRUE
             )
```
-->

<!--Do the main computations for nonparametric analysis of leaf plum curling aphid first flight data-->
```{r stat_aphid_ff, echo=F, cache=T,  cache.extra=list(seed,data_aphid_ff,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed)
resloc<-"./Results/stat_results/stat_aphid_ff/"

sp<-11
good_loc<-good_loclist(d_allsp=data_aphid_ff,sp=sp,data_pt_thrs=30)
longs<-c(-4.567,0.57,-3.069,-3.312,-2.637,-1.682,-2.763,-0.356,-3.454,0.427,0.939)
lats<-c(55.477,52.26,56.457,55.949,52.125,55.213,53.854,51.807,50.628,51.733,51.185)

stat_aphid_ff<-multcall(d_allsp=data_aphid_ff,sp=sp,lats=lats,longs=longs,pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc) 
saveRDS(stat_aphid_ff,paste(resloc,file="stat_aphid_ff_sp_11.RDS",sep='')) 
```

<!--Show the statistical results in a table for leaf plum curling aphid first flight data-->
```{r tab_ff_resamp,echo=F,results="markup"}
s<-stat_aphid_ff$numericdf[,c(3,2,4)]
sc<-as.data.frame(c("Spearman","Kendall","cor$_{l}$","cor$_{u}$","P$_{l}$","P$_{u}$","D$_{l}^2$","D$_{u}^2$",
                    "cor$_{l}$ - cor$_{u}$","P$_{l}$ - P$_{u}$","D$_{u}^2$ - D$_{l}^2$"))
s<-cbind(sc,s)
knitr::kable(s, digits = 3,
             col.names=c("","2.5$^{th}$ quantile", "Mean", "97.5$^{th}$ quantile"),
             format = "latex",linesep = "", escape = F,align="c",
             caption.short="Results for nonparametric statistics, leaf-curling plum aphid first flight data",
             caption = "Average values of statistics across all location pairs and confidence intervals based on spatial resampling for leaf-curling plum aphid first flight data.\\label{tab_ff_resamp}",
             booktabs=TRUE)
```

<!--***DAN: decided to remove this for AER
\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_aphid_ff/Sp_11_D2u-D2l_vs_D.pdf}
\caption[Nonparametric tail statistics versus distance between locations for leaf-curling plum aphid first flight data]{Nonparametric tail statistics versus great-circle distance, $D$, between sampling locations for leaf-curling plum aphid first flight data. \label{fig_aphid_ff}}
\end{center}
\end{figure}
-->

<!--Load the data : planktons-->
```{r read_plankton_north_sea_data, echo=F}
source("plankton_north_sea_data_calling.R")
d0_plankton_north_sea<-as.matrix(read.csv("./Data/Plankton_North_Sea_data/planktontimeseries201117_4.csv",header=F))
data_plankton_north_sea<-d_allsp_data_plankton_north_sea(d0_plankton_north_sea)
``` 

<!--Simulation for model selection and non-parametric analysis with plankton data for all 22 sp.-->
```{r modelsel_and_npa_pns_allsp, echo=F, cache=T, cache.extra=list(seed,busycores,data_plankton_north_sea,longs_pns,lats_pns,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"),mtime("NonParamStat.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

set.seed(seed)
library(parallel)
source("FittingCopula_selective_loc.R")
RES_all_sp_pns<-mclapply(X=c(1:22),FUN=RES_single_sp,d_allsp=data_plankton_north_sea,
                              families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=45,
                              good_loc_given=F,good_loc=NA,mc.cores=busycores)
saveRDS(RES_all_sp_pns,"./Results/fitting_results/RES_all_sp_pns.RDS")

source("good_loclist.R")
source("NonParamStat.R")
resloc<-"./Results/stat_results/stat_plankton_north_sea/"

stat_plankton_north_sea_allsp<-vector("list",22)

for(sp in 1:22){
  nm<-paste("sp_",sp,sep="")
  resloc2<-paste(resloc,nm,sep="")
   if (!dir.exists(resloc2)){
    dir.create(resloc2)
  }
  good_loc<-good_loclist(d_allsp=data_plankton_north_sea,sp=sp,data_pt_thrs=45)
  
  temp<-multcall(d_allsp=data_plankton_north_sea,sp=sp,lats=lats_pns,longs=longs_pns,
                                      pfname=paste(resloc2,"/","Sp_",sp,sep=''),good_loc=good_loc)
  stat_plankton_north_sea_allsp[[sp]]<-temp
}
saveRDS(stat_plankton_north_sea_allsp,paste(resloc,file="stat_plankton_north_sea_allsp.RDS",sep=''))


summary_pns_allsp<-as.data.frame(matrix(NA,nrow=22,ncol=8))
colnames(summary_pns_allsp)<-c("species","#LTmUT>0","#LTmUT<0","val_LTmUT>0","val_LTmUT<0",
                                     "CorlmCoru_mean_CI","PlmPu_mean_CI","D2umD2l_mean_CI")

for(sp in c(1:22)){
  #cat("sp=",sp,"\n")
  summary_pns_allsp$species[sp]<-sp
  LTmUT<-(RES_all_sp_pns[[sp]]$LTdep_AICw - RES_all_sp_pns[[sp]]$UTdep_AICw) 
  summary_pns_allsp$`#LTmUT>0`[sp]<-sum(LTmUT>0,na.rm=T)
  summary_pns_allsp$`#LTmUT<0`[sp]<-sum(LTmUT<0,na.rm=T)
  ind_LTmUT_pos<-which(LTmUT>0,arr.ind = T)
  summary_pns_allsp$`val_LTmUT>0`[sp]<-sum(LTmUT[ind_LTmUT_pos])
  ind_LTmUT_neg<-which(LTmUT<0,arr.ind = T)
  summary_pns_allsp$`val_LTmUT<0`[sp]<-sum(LTmUT[ind_LTmUT_neg])
  
  summary_pns_allsp$CorlmCoru_mean_CI[sp]<-list(
    c(unname(round(stat_plankton_north_sea_allsp[[sp]]$numericdf[9,c(2:4)],3))))
  summary_pns_allsp$PlmPu_mean_CI[sp]<-list(
    c(unname(round(stat_plankton_north_sea_allsp[[sp]]$numericdf[10,c(2:4)],3))))
  summary_pns_allsp$D2umD2l_mean_CI[sp]<-list(
    c(unname(round(stat_plankton_north_sea_allsp[[sp]]$numericdf[11,c(2:4)],3))))
}
saveRDS(summary_pns_allsp,"./Results/summary_pns_allsp.RDS")
```

<!--Do the model selection for plankton (Ceratium furca) and then showing results in Tables-->
```{r RES_plankton_north_sea, echo=F, cache=T, results="hide", cache.extra=list(seed,data_plankton_north_sea,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file

set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_plankton_north_sea<-RES_single_sp(d_allsp=data_plankton_north_sea,sp=16,families=c(1,3:10,13,14,16:20),level=0.05,
                                      data_pt_thrs=45,good_loc_given=F,good_loc=NA)
#cat(paste("stop-time: ",Sys.time(),"\n"))    
resloc<-"./Results/fitting_results/"
saveRDS(RES_plankton_north_sea,paste(resloc,file="Plankton_North_Sea_CopulaFit_selecloc_species_16.RDS",sep=""))
```

<!--table for Best-fitting copulas, Ceratium furca abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_pns_bestcop, echo=F, results="markup"}
knitr::kable(RES_plankton_north_sea$info_ord_copname[,,1], #longtable=T,
             format='latex', linesep = "",
             caption.short = "Best-fitting copulas, \\textit{Ceratium furca} abundance data",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for \\textit{Ceratium furca} abundance data. Copula families were considered as in Table \\ref{tab_count_bestcop}. Indep.=Independent. NA occurs along the diagonal because diagonal entries represent a sampling location compared to itself.\\label{tab_pns_bestcop}",
             booktabs=TRUE
             )
```
-->

<!--table for AIC-weights of best-fitting copulas, Ceratium furca abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_pns_AICw,echo=F,results="markup"}
h<-RES_plankton_north_sea$info_ord_AICw[,,1]
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",
             digits=3,linesep = "",
             caption.short="AIC weights, best-fitting copulas, \\textit{Ceratium furca} abundance data",
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for \\textit{Ceratium furca} abundance data.\\label{tab_pns_AICw}",
             booktabs=TRUE)
```
-->

<!--table for AIC-weights of normal copula used for fitting, Ceratium furca abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_pns_AICw_normal,echo=F,results="markup"}
source("normal_cop_AICw.R")
h<-normal_cop_AICw_matrix(r=RES_plankton_north_sea)
h<-h$normal_cop_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",linesep = "",
             digits=3,
             caption.short="AIC weights, normal copulas, \\textit{Ceratium furca} abundance data",
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for \\textit{Ceratium furca} abundance data, for comparison with Table \\ref{tab_pns_AICw}.\\label{tab_pns_AICw_normal}",
             booktabs=TRUE)
```
-->

<!--table for p-values from goodness of fit test (Cramer-von Mises-based test) with best-fit copula, Ceratium furca abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_pns_p_CvM,echo=F,results="markup"}
h<-RES_plankton_north_sea$gfc_p_CvM
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",linesep = "",
             digits=3,
             caption.short="Goodness of fit of best-fitting copulas, \\textit{Ceratium furca} abundance data",
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for \\textit{Ceratium furca} abundance data.\\label{tab_pns_p_CvM}",
             booktabs=TRUE)
```
-->

<!--table for p-values from goodness of fit test (Kolmogorov-Smirnov-based test) with best-fit copula, Ceratium furca abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_pns_p_KS,echo=F,results="markup"}
h<-RES_plankton_north_sea$gfc_p_KS
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",linesep = "",
             digits=3,
             caption.short="Goodness of fit of best-fitting copulas, \\textit{Ceratium furca} abundance data",
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of
the goodness of fit of the lowest-AIC copula family for each pair of
locations for \\textit{Ceratium furca} abundance data.\\label{tab_pns_p_KS}",
             booktabs=TRUE)
```
-->

<!--table for model averaged lower tail dep., Ceratium furca abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_pns_LTdep_AICw,echo=F,results="markup"}
h<-RES_plankton_north_sea$LTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",linesep = "",
             digits=3,
             caption.short="Lower-tail dependence, \\textit{Ceratium furca} abundance data",
             caption = "Model-averaged lower-tail dependence statistics for each location pair for \\textit{Ceratium furca} abundance data.\\label{tab_pns_LTdep_AICw}",
             booktabs=TRUE)
```
-->

<!--table for model averaged upper tail dep., Ceratium furca abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_pns_UTdep_AICw,echo=F,results="markup"}
h<-RES_plankton_north_sea$UTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",linesep = "",
             digits=3,
             caption.short="Upper-tail dependence, \\textit{Ceratium furca} abundance data",
             caption = "Model-averaged upper-tail dependence statistics for each location pair for \\textit{Ceratium furca} abundance data.\\label{tab_pns_UTdep_AICw}",
             booktabs=TRUE)
```
-->

<!--table for model averaged lower- minus upper-tail dep., Ceratium furca abundance data-->
<!--***DAN: decided to remove this for AER
```{r tab_pns_LTmUT,echo=F,results="markup"}
h<-RES_plankton_north_sea$LTdep_AICw-RES_plankton_north_sea$UTdep_AICw
h[is.nan(h)]<-NA
knitr::kable(h,
             format="latex",linesep = "",
             digits=3,
             caption.short="Lower- minus upper-tail dependence, \\textit{Ceratium furca} abundance data",
             caption = "Model-averaged lower-tail dependence statistics minus model-averaged upper-tail dependence statistics for each location pair for \\textit{Ceratium furca} abundance data.\\label{tab_pns_LTmUT}",
             booktabs=TRUE)
```
-->

<!--Do the main computations for nonparametric analysis of Ceratium furca abundance data-->
```{r stat_plankton_north_sea, echo=F, cache=T, cache=T,  cache.extra=list(seed,data_plankton_north_sea,longs_pns,lats_pns,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed)
resloc<-"./Results/stat_results/stat_plankton_north_sea/"

sp<-16
good_loc<-good_loclist(d_allsp=data_plankton_north_sea,sp=sp,data_pt_thrs=45)

stat_plankton_north_sea<-multcall(d_allsp=data_plankton_north_sea,sp=sp,lats=lats_pns,longs=longs_pns,
                                  pfname=paste(resloc,"Sp_",sp,sep=''),good_loc=good_loc) 
saveRDS(stat_plankton_north_sea,paste(resloc,file="stat_plankton_north_sea_sp_16.RDS",sep=''))
```

<!--Show the statistical results in a table for Ceratium furca abundance data-->
```{r tab_pns_resamp,echo=F,results="markup"}
s<-stat_plankton_north_sea$numericdf[,c(3,2,4)]
sc<-as.data.frame(c("Spearman","Kendall","cor$_{l}$","cor$_{u}$","P$_{l}$","P$_{u}$","D$_{l}^2$","D$_{u}^2$",
                    "cor$_{l}$ - cor$_{u}$","P$_{l}$ - P$_{u}$","D$_{u}^2$ - D$_{l}^2$"))
s<-cbind(sc,s)
knitr::kable(s, digits = 3,
             col.names=c("","2.5$^{th}$ quantile", "Mean", "97.5$^{th}$ quantile"),
             format = "latex",linesep = "", escape = F,align="c",
             caption.short="Results for nonparametric statistics, \\textit{Ceratium furca} abundance data",
             caption = "Average values of statistics across all locations pairs and confidence intervals based on spatial resampling for \\textit{Ceratium furca} abundance data.\\label{tab_pns_resamp}",
             booktabs=TRUE)
```

<!--***DAN: decided to remove this for AER
\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_plankton_north_sea/Sp_16_D2u-D2l_vs_D.pdf}
\caption[Nonparametric tail statistics versus distance between locations for \textit{Ceratium furca} abundance data]{Nonparametric tail statistics versus great-circle distance, $D$, between sampling locations for \textit{Ceratium furca} abundance data. \label{fig_pns}}
\end{center}
\end{figure}
-->

<!--Load and format the data : methane-flux-->
```{r read_format_methane_data, echo=F}
#latlon_methane_old<-readRDS("./Data/Methane_data/chamberLocations.rds")
#write.csv(latlon_methane_old,"./Data/Methane_data/chamberLocations.csv",row.names = F)
latlon_methane<-read.csv("./Data/Methane_data/chamberLocations.csv")
#identical(latlon_methane_old,latlon_methane)  # checked : they are identical :)

#methane_raw_old<-readRDS("./Data/Methane_data/methane_data_for_Shyamolina.rds")
#write.csv(methane_raw_old,"./Data/Methane_data/methane_data.csv",row.names = F)
methane_raw<-read.csv("./Data/Methane_data/methane_data.csv")
methane_raw$dates<-as.Date(methane_raw$dates) # converting factor class to date class
#identical(methane_raw_old,methane_raw)  # checked : they are identical :)

myls <- vector("list", length = dim(methane_raw)[2]-1)
for(i in 2:dim(methane_raw)[2]){
  temp<-methane_raw[,c(1,i)]
  colnames(temp)<-c("Year","Dat")
  myls[[i-1]]<-temp
}
methane_data<-list(myls=myls)
``` 

<!--Do the model selection for methane-flux data and then showing results in Tables-->
```{r RES_methane, echo=F, cache=T, results="hide", cache.extra=list(seed,methane_data,mtime("FittingCopula_selective_loc.R"), mtime("vivj_matrix.R"),mtime("good_loclist.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

source("FittingCopula_selective_loc.R")  # top most hierarchy source file

set.seed(seed)
#cat(paste("start-time: ",Sys.time(),"\n")) 
RES_methane<-RES_single_sp(d_allsp=methane_data,sp=1,families=c(1,3:10,13,14,16:20),level=0.05,data_pt_thrs=50,
                           good_loc_given=F,good_loc=NA)
#cat(paste("stop-time: ",Sys.time(),"\n"))    
resloc<-"./Results/fitting_results/"
saveRDS(RES_methane,paste(resloc,file="MethaneFluxFit_selecloc_data_pt_thrs_50.RDS",sep=""))
```

<!--table for Best-fitting copulas, methane-flux data-->
<!--***DAN: decided to remove this for AER
```{r tab_methane_bestcop, echo=F, results="markup"}
knitr::kable(RES_methane$info_ord_copname[,,1], #longtable=T,
             format='latex',linesep = "",
             caption.short = "Best-fitting copulas, methane-flux data",
             caption = "Best-fitting copulas for each location pair from among those considered, according to AIC, for methane-flux data. Copula families were considered as in Table \\ref{tab_count_bestcop}. Indep.=Independent. NA occurs along the diagonal because diagonal entries represent a sampling location compared to itself.\\label{tab_methane_bestcop}",
             booktabs=TRUE
             )
```
-->

<!--table for AIC-weights of best-fitting copulas, methane-flux data-->
<!--***DAN: decided to remove this for AER
```{r tab_methane_AICw,echo=F,results="markup"}
h<-RES_methane$info_ord_AICw[,,1]
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",linesep = "",
             digits=3,
             caption.short="AIC weights, best-fitting copulas, methane-flux data",
             caption = "$\\text{AIC}_{\\text{w}}$ for the best-fitting (lowest AIC) copula family for each location pair for methane-flux data.\\label{tab_methane_AICw}",
             booktabs=TRUE)
```
-->

<!--table for AIC-weights of normal copula used for fitting, methane-flux data-->
<!--***DAN: decided to remove this for AER
```{r tab_methane_AICw_normal,echo=F,results="markup"}
source("normal_cop_AICw.R")
h<-normal_cop_AICw_matrix(r=RES_methane)
h<-h$normal_cop_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",linesep = "",
             digits=3,
             caption.short="AIC weights, normal copulas, methane-flux data",
             caption = "$\\text{AIC}_{\\text{w}}$ for the normal copula family for each location pair for methane-flux data, for comparison with Table \\ref{tab_methane_AICw}.\\label{tab_methane_AICw_normal}",
             booktabs=TRUE)
```
-->

<!--table for p-values from goodness of fit test (Cramer-von Mises-based test) with best-fit copula, methane-flux data-->
<!--***DAN: decided to remove this for AER
```{r tab_methane_p_CvM,echo=F,results="markup"}
h<-RES_methane$gfc_p_CvM
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",linesep = "",
             digits=3,
             caption.short="Goodness of fit of best-fitting copulas, methane-flux data",
             caption = "$P$-value results of a Cramer-von Mises-based test of the goodness of fit of the lowest-AIC copula family for each pair of locations for methane-flux data.\\label{tab_methane_p_CvM}",
             booktabs=TRUE)
```
-->

<!--table for p-values from goodness of fit test (Kolmogorov-Smirnov-based test) with best-fit copula, methane-flux data-->
<!--***DAN: decided to remove this for AER
```{r tab_methane_p_KS,echo=F,results="markup"}
h<-RES_methane$gfc_p_KS
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",linesep = "",
             digits=3,
             caption.short="Goodness of fit of best-fitting copulas, methane-flux data",
             caption = "$P$-value results of a Kolmogorov-Smirnov-based test of
the goodness of fit of the lowest-AIC copula family for each pair of
locations for methane-flux data.\\label{tab_methane_p_KS}",
             booktabs=TRUE)
```
-->

<!--table for model averaged lower tail dep., methane-flux data-->
<!--***DAN: decided to remove this for AER
```{r tab_methane_LTdep_AICw,echo=F,results="markup"}
h<-RES_methane$LTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",linesep = "",
             digits=3,
             caption.short="Lower-tail dependence, methane-flux data",
             caption = "Model-averaged lower-tail dependence statistics for each location pair for methane-flux data.\\label{tab_methane_LTdep_AICw}",
             booktabs=TRUE)
```
-->

<!--table for model averaged upper tail dep., methane-flux data-->
<!--***DAN: decided to remove this for AER
```{r tab_methane_UTdep_AICw,echo=F,results="markup"}
h<-RES_methane$UTdep_AICw
h[is.infinite(h)]<-NA
knitr::kable(h,
             format="latex",linesep = "",
             digits=3,
             caption.short="Upper-tail dependence, methane-flux data",
             caption = "Model-averaged upper-tail dependence statistics for each location pair for methane-flux data.\\label{tab_methane_UTdep_AICw}",
             booktabs=TRUE)
```
-->

<!--table for model averaged lower- minus upper-tail dep., methane-flux data-->
<!--***DAN: decided to remove this for AER
```{r tab_methane_LTmUT,echo=F,results="markup"}
h<-RES_methane$LTdep_AICw-RES_methane$UTdep_AICw
h[is.nan(h)]<-NA
knitr::kable(h,
             format="latex",linesep = "",
             digits=3,
             caption.short="Lower- minus upper-tail dependence, methane-flux data",
             caption = "Model-averaged lower-tail dependence statistics minus model-averaged upper-tail dependence statistics for each location pair for methane-flux data.\\label{tab_methane_LTmUT}",
             booktabs=TRUE)
```
-->

<!--Do the main computations for nonparametric analysis of methane-flux data-->
```{r stat_methane, echo=F, cache=T, cache=T,  cache.extra=list(seed,methane_data,methane_raw,latlon_methane,mtime("good_loclist.R"),mtime("NonParamStat.R"),mtime("vivj_matrix.R"),mtime("CopulaFunctions.R"), mtime("CopulaFunctions_flexible.R"))}

source("good_loclist.R")
source("NonParamStat.R")
set.seed(seed)
resloc<-"./Results/stat_results/stat_methane/"

data_pt_thrs<-50
good_loc <- good_loclist(d_allsp=methane_data,sp=1,data_pt_thrs=data_pt_thrs)

latlon<-latlon_methane
chamber_name<-colnames(methane_raw[,c(2:dim(methane_raw)[2])])
ndim<-length(chamber_name)

latlon_arranged<-data.frame(chamber_name=chamber_name,lat=NA*numeric(ndim),lon=NA*numeric(ndim))
for(i in 1:ndim){
  if (chamber_name[i] %in% latlon$chamber){
    ind<-which(latlon$chamber==chamber_name[i])
    latlon_arranged[i,2:3]<-unname(latlon[ind,2:3])
  }
}

stat_methane<-multcall(d_allsp=methane_data,sp=1,lats=latlon_arranged$lat,longs=latlon_arranged$lon,
                           pfname=paste(resloc,"data_pt_thrs",data_pt_thrs,sep=''),good_loc=good_loc)

saveRDS(stat_methane,paste(resloc,file="stat_methane.RDS",sep='')) 
```

<!--Show the statistical results in a table for methane-flux data-->
```{r tab_methane_resamp,echo=F,results="markup"}
s<-stat_methane$numericdf[,c(3,2,4)]

#rownames(s)<-c("Spearman","Kendall","cor_l","cor_u","P_l","P_u","D^2_l","D^2_u","cor_l - cor_u","P_l - P_u","D^2_u - D^2_l")

sc<-as.data.frame(c("Spearman","Kendall","cor$_{l}$","cor$_{u}$","P$_{l}$","P$_{u}$","D$_{l}^2$","D$_{u}^2$",
                    "cor$_{l}$ - cor$_{u}$","P$_{l}$ - P$_{u}$","D$_{u}^2$ - D$_{l}^2$"))
s<-cbind(sc,s)
knitr::kable(s,digits = 3,
             format = "latex",linesep = "", escape = F,align="c",
             col.names=c("","2.5$^{th}$ quantile", "Mean", "97.5$^{th}$ quantile"),
             caption.short="Results for nonparametric statistics, methane-flux data",
             caption = "Average values of statistics across all locations pairs and confidence intervals based on spatial resampling for methane-flux data.\\label{tab_methane_resamp}",
             booktabs=TRUE)
```

<!--***DAN: decided to remove this for AER
\begin{figure}[!h]
\textbf{ \hspace{3.4 cm} (A) \hspace{3.2 cm} (B) \hspace{3.2 cm} (C) \hspace{3.4 cm} (D)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Spearman_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Kendall_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Corl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Coru_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{3.4 cm} (E) \hspace{3.2 cm} (F) \hspace{3.2 cm} (G) \hspace{3.4 cm} (H)} \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Pl_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_D2u_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_D2l_vs_D.pdf}\\
\end{center}
\textbf{ \hspace{5.4 cm} (I) \hspace{3.4 cm} (J) \hspace{3.2 cm} (K) } \\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Corl-Coru_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_Pl-Pu_vs_D.pdf}
\includegraphics[width=4 cm]{./Results/stat_results/stat_methane/data_pt_thrs50_D2u-D2l_vs_D.pdf}
\caption[Nonparametric tail statistics versus distance between locations for methane-flux data]{Nonparametric tail statistics versus great-circle distance, $D$, between sampling locations for methane-flux data. \label{fig_methane}}
\end{center}
\end{figure}
-->

<!--Function to generate a table containing summary results for all multivariate datasets-->
```{r multivar_tab_summary_fn,echo=F}
source("normal_cop_AICw.R")

multivar_tab_summary_fn<-function(r,rs){
  
  m<-matrix(NA,1,18)
  colnames(m)<-c("num.pairs","num.non.indep","num.non_N",
                 "Avg.N_minus_bestfit.AICw","Avg.N_minus_bestfit.AIC","num.good.fit",
                 "LT_0.025_CI","LT_0.975_CI","UT_0.025_CI","UT_0.975_CI",
                 "percent.LT_minus_UT_gt0",
                 "Corl_0.025_CI","Corl_0.975_CI","Coru_0.025_CI","Coru_0.975_CI",
                 "avg.Corl_minus_Coru","Corl_minus_Coru_0.025_CI","Corl_minus_Coru_0.975_CI")
  m<-as.data.frame(m)
  
  call_AICs_N<-normal_cop_AICw_matrix(r=r)
  normal_AICw<-call_AICs_N$normal_cop_AICw
  normal_AICw[normal_AICw==Inf]<-NaN
  normal_AIC<-call_AICs_N$normal_cop_AIC
  normal_AIC[normal_AIC==Inf]<-NaN
  
  d<-dim(r$gfc_numBS)[1]
  m$num.pairs<-(d^2)-d 
  m$num.non.indep<- (d^2)-d-2*(r$num_indep_loc_pair+r$num_neg_cor_loc_pair)
  
  bcop<-r$info_ord_copcode[,,1] # matrix with best fit copula name
  bcop[bcop==Inf]<-NaN # replacing Independent pairs with NaN
  m$num.non_N<-sum(bcop!=1,na.rm = T)
  
  r$info_ord_AIC[r$info_ord_AIC==Inf] <- NaN # replacing non-ind loc pair value by NaN
  r$info_ord_AICw[r$info_ord_AICw==Inf] <- NaN # replacing non-ind loc pair value by NaN
  
  bestfit.AIC<-r$info_ord_AIC[,,1]
  bestfit.AICw<-r$info_ord_AICw[,,1]
  
  m$Avg.N_minus_bestfit.AICw<-round(mean(normal_AICw - bestfit.AICw, na.rm = T),3)
  m$Avg.N_minus_bestfit.AIC<-round(mean(normal_AIC - bestfit.AIC, na.rm = T),3)
  
  pcvm<-r$gfc_p_CvM
  pcvm[pcvm==Inf]<-NaN
  pks<-r$gfc_p_KS
  pks[pks==Inf]<-NaN
  temp<-which((pcvm>0.01) & (pks>0.01),arr.ind=T)
  m$num.good.fit<-dim(temp)[1]
  t<-r$LTdep_AICw[is.finite(r$LTdep_AICw)]
  CI_LT<-unname(quantile(t,probs=c(0.025,0.975),na.rm = T))
  m$LT_0.025_CI<-round(CI_LT[1],3)
  m$LT_0.975_CI<-round(CI_LT[2],3)
  t<-r$UTdep_AICw[is.finite(r$UTdep_AICw)]
  CI_UT<-unname(quantile(t,probs=c(0.025,0.975),na.rm = T))
  m$UT_0.025_CI<-round(CI_UT[1],3)
  m$UT_0.975_CI<-round(CI_UT[2],3)
  m$percent.LT_minus_UT_gt0<-round((sum(r$LTdep_AICw-r$UTdep_AICw>0,na.rm=T)/((d^2)-d-2*(r$num_indep_loc_pair+r$num_neg_cor_loc_pair)))*100,2)
  m$Corl_0.025_CI<-round(rs$numericdf[3,3],3)
  m$Corl_0.975_CI<-round(rs$numericdf[3,4],3)
  m$Coru_0.025_CI<-round(rs$numericdf[4,3],3)
  m$Coru_0.975_CI<-round(rs$numericdf[4,4],3)
  m$avg.Corl_minus_Coru<-round(rs$numericdf[9,2],3)
  m$Corl_minus_Coru_0.025_CI<-round(rs$numericdf[9,3],3)
  m$Corl_minus_Coru_0.975_CI<-list(round(rs$numericdf[9,4],3))
  #m$CI_Pl<-list(c(round(rs$numericdf[5,3],3),round(rs$numericdf[5,4],3)))
  #m$CI_Pu<-list(c(round(rs$numericdf[6,3],3),round(rs$numericdf[6,4],3)))
  #m$`CI_Pl-Pu`<-list(c(round(rs$numericdf[10,3],3),round(rs$numericdf[10,4],3)))
  
  mt<-as.data.frame(t(m))
  return(mt)
  
}
#----------------------------------
#calling the above function on 4 multivariable datasets
m1<-multivar_tab_summary_fn(r=RES_aphid_count,rs=stat_aphid_count)
m2<-multivar_tab_summary_fn(r=RES_aphid_ff,rs=stat_aphid_ff)
m3<-multivar_tab_summary_fn(r=RES_plankton_north_sea,rs=stat_plankton_north_sea)
m4<-multivar_tab_summary_fn(r=RES_methane,rs=stat_methane)
tab_multivar_summary<-cbind(m1,m2,m3,m4)
colnames(tab_multivar_summary)<-c("Green_spruce_aphid_count","Leaf_plum_curling_aphid_firstflight","C_furca_count","Methane_flux")
saveRDS(tab_multivar_summary,"./Results/tab_multivar_summary.RDS")
```

# Spatial resampling with multivariate datasets for nonparametric statistics \label{spatial_resamp}
<!--***DAN: leave this section exactly as it is, but it may be out of order
now that we describe how this is done in the methods. In fact, I think I
have to do this more generally.-->

For each pair of 
locations $i \neq j$, the statistic
of interest, here denoted $s_{ij}$ ($\cor_{l_b,u_b}$, $\Ps_{l_b,u_b}$, 
$\Dsq_{l_b,u_b}$, $\cor_l-\cor_u$, 
$\Ps_l-\Ps_u$, or $\Dsq_u-\Dsq_l$) was computed for those locations. The 
values $s_{ij}$ were then arranged in
a matrix, $S$, with diagonal entries NA. The mean of the non-NA entries of $S$ was computed. For 
$\cor_{l_b,u_b}$, $\Ps_{l_b,u_b}$, or $\Dsq_{l_b,u_b}$ this mean characterizes the 
average strength of 
dependence, across all pairs of distinct locations, for data in the portion of the distributions 
given by the bounds $l_b$ and $u_b$. For $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, or $\Dsq_u-\Dsq_l$, 
the mean characterizes average
asymmetry of tail dependence across all pairs of locations. 
Confidence intervals for the value of $\mean(S)$ were then computed as quantiles of a 
distribution of bootstrapped values. If $\mean(S)$ was significantly different from 0, as
revealed by the confidence intervals, for the statistics $\cor_l-\cor_u$, $\Ps_l-\Ps_u$, 
or $\Dsq_u-\Dsq_l$, then tail dependence was significantly asymmetric, in contrast to a 
normal-copula null hypothesis.
Bootstrapping was performed by resampling the locations of measurement, with replacement. 
This corresponds to 
resampling, with replacement, the rows and columns of $S$, and is described in detail elsewhere 
[@bjornstadfalck2001 ; @walteretal2017]. 

# Hypothetical evolutionary mechanism for tail dependence between traits \label{evol_mech}

\noindent The matrices from which root character states and changes 
across phylogeny branches were randomly chosen were generated as follows.
For extreme right-tail dependent noise, we first produced
a 1,000,000 by $2$ matrix, $m$, filled with 2,000,000 
independent standard-normal random draws. Then, each row of $m$ 
was identified for a first set of modifications randomly 
and independently with a $50\%$ chance; 
for those rows identified, every element of the row was replaced with the 
absolute value of the first element of the row (including the first element itself).
For other rows, every element in the row was replaced by the negative of its
own absolute value. This produces right-tail dependent noise, normally distributed
for each of the two locations. 
If left-tail dependent noise was desired, we took the negative of the
entire matrix. The moderately left-tail dependent matrix was based on a Clayton copula 
with parameter chosen (using the `iRho` function in the `copula` package) so that
the Spearman correlation would be the same as for the extreme tail dependence 
datasets. The moderately right-tail dependent matrix and the symmetric tail dependence
matrix were constructed similarly, but using an survival Clayton copula and an normal copula,
respectively. 

<!--***DAN: Move all the rest of it into the Discussion, I think, but can decide when I get to the Discussion. If it is mved, then you may want to retitle this appendix to reflect the 
fact it is onl methods-->
Performing statistical tests for associations between continuous traits in different species
    was a primary motivating example of phylogenetic comparative methods.
For example, Felsenstein's method of phylogenetically independent contrasts 
    [@Felsenstein1985] is currently the second most-cited paper in the history
    of the journal the American Naturalist [@HueyGT2019].
Frustratingly, the field still lacks a dependable procedure for dealing with branch lengths, 
    which are a crucial input to the method.
Ideally, the branch lengths used to correct for phylogenetic effects would represent
    the expected amounts of change for the characters that are being analyzed.
Because researchers almost never have a reliable method for providing such branch lengths,
    most researchers rely on ultrametric trees -- those for which the branch
    length can be treated as a proxy for the duration of the branch in time.
Frequently these branch lengths are transformed to assess sensitivity to different 
    assumptions about the degree of phylogenetic inertia displayed by the traits
    under study [@Ives2018;@Harmon2018].
Even if one were able to simply use a time-based set of branch lengths, assigning
    dates to nodes in phylogenies is difficult.
DNA sequence data can provide estimates of branch lengths, but these estimates
    are dependent on the adequacy of models which correct sequences for multiple
    substitutions occurring at the same location.
Biases in estimating the evolutionary distance can affect downstream analyses [@Phillips2009].
Additionally, changes
    in the rate of molecular evolution make the estimation of dates difficult [@HeathM2014] even when branch lengths in time are accurately estimated.

Without reliable branch length estimates, it is difficult to interpret the significance
    of the magnitude of changes in traits across a tree.
Developing tests of association based on copula structure may possibly lead the way to more
    robust methods for studying associations when we lack defensible estimates of
    branch lengths. 
We note that our phylogenetic analyses here consisted merely of simulations to assess
    whether interesting copula structure in a simple evolutionary process could 
    leave a detectable signal on the trait data for extant species.
Substantial work remains to be done before we have a copula-based method for 
    analyzing data on a phylogenetic tree. 
But the nonparametric nature of approaches
    based solely on data ranks, as some of our copula methods are, may be a promising avenue for 
    avoiding inaccuracies that arise via the highly structured model assumptions implicit
    in the method of phylogenetically independent contrasts and related methods.

Additionally, character evolution was simulated using one random draw from the relevant matrix
per phylogeny branch. This was principally because branch lengths are often hugely
uncertain. If branch lengths were well known, alternative simulation strategies may
include selecting one draw from the matrix of evolutionary changes per unit time, 
or selecting one draw for the whole branch but rescaling the variances of the selected
character changes according to the 
length of the branch. These choices amount to the same thing for normal copula
structure, but not otherwise. Modelling choices such as these may have influenced
our results. Additional research also seems warranted testing the realism 
of our hypothesized mechanism and simulations.

<!--Following two chunks examine asymetric dependence mechanism with model selection and non-parametric statistics approach-->
```{r asym_sens_b_variation, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"),mtime("bivfunctionplot.R"),mtime("CopulaFunctions_flexible.R"),mtime("copsurrog2d.R"))}
set.seed(seed)
#-----------------------------------------------------------------------------------
source("OurBiCopSelect.R")
source("bivfunctionplot.R")
source("asym_sensitivity.R")
#-----------------------------------------------------------------------------------
# This function takes 
# Input :
#       mg : global noise matrix (dim = N by 2)
#       ml : local noise matrix (dim = N by 2)
#       a : a number : local noise coeeficient
#       b : growth factor of pop
#       decrease : logical (controls the nature of global noise)
#       numkeep_last : number of points you want to keep for the pop matrix from the end
#       ploton : logical for optional plot

# Output :
#     a list of 4 pop matrices 
#                         1. (for b=+ve, decrease=F)
#                         2. (for b=+ve, decrease=T)
#                         3. (for b=-ve, decrease=F)
#                         4. (for b=-ve, decrease=T)

plotter_asym_sens_b_varn<-function(mg,ml,a,b,numkeep_last,ploton,resloc){
  
  pop_g<-Simulator_asym_sens(mg=mg,ml=ml,a=a,b=b,p0=c(0,0),decrease=F,numkeep_last=numkeep_last)
  pop_d_g<-Simulator_asym_sens(mg=mg,ml=ml,a=a,b=b,p0=c(0,0),decrease=T,numkeep_last=numkeep_last)
  
  if(ploton==T){
    pdf(paste0(resloc,"a_",a,"_b_",b,"_r_",r,"_asym_sens.pdf",sep=""),height=3,width=6)
    op<-par(mfrow=c(1,2),mar=c(4,4.2,1.5,1),mgp=c(2.5,0.6,0))
    #plot(pop[,1],pop[,2],col="red",main = bquote(beta ==.(beta)))
    pop<-pop_g$pop
    geps<-pop_g$g_noise
    #plot(mg[,1],geps[,1],cex.lab=2,cex.axis=2,xlab=expression(epsilon),ylab=expression(paste(g[1])),main="location=1")
    #plot(mg[,2],geps[,2],cex.lab=2,cex.axis=2,xlab=expression(epsilon),ylab=expression(paste(g[1])),main="location=2")
    plot(pop[,1],pop[,2],xlab=expression(paste(P[1])), ylab=expression(paste(P[2])),cex.lab=2,cex.axis=2,col="grey",pch=20,cex=1.4)
    #title(expression(paste("g = ",g[1]," , ")), adj=0.06,cex.main=1.5)
    #mtext(paste("a = ",a,", b = ",b),side = 3, line=0.2, adj=0.9)
    
    pop_d<-pop_d_g$pop
    geps<-pop_d_g$g_noise
    #plot(mg[,1],geps[,1],cex.lab=2,cex.axis=2,xlab=expression(epsilon),ylab=expression(paste(g[2])),main="location=1")
    #plot(mg[,2],geps[,2],cex.lab=2,cex.axis=2,xlab=expression(epsilon),ylab=expression(paste(g[2])),main="location=2")
    plot(pop_d[,1],pop_d[,2],xlab=expression(paste(P[1])), ylab=expression(paste(P[2])),cex.lab=2,cex.axis=2,col="grey",pch=20,cex=1.4)
    #title(expression(paste("g = ",g[2]," , ")), adj=0.06,cex.main=1.5)
    #mtext(paste("a = ",a,", b = ",b),side = 3, line=0.2, adj=0.9)
    
    par(op)
    dev.off()
  }
  
  return(list(pop=pop,
              pop_d=pop_d))
  
}
#----------------------------------------------------------
N<-25000
r<-0.8
a<-0.2
numkeep_last<-2500
temp<-get_noise_glob_loc_mat(N=N,r=r)
mg<-temp$mg
ml<-temp$ml

resloc<-"./Results/asym_sens_results/"
ans_b_0.1<-plotter_asym_sens_b_varn(mg=mg,ml=ml,a=a,b=0.1,numkeep_last=numkeep_last,ploton=T,resloc=resloc)
ans_b_neg0.1<-plotter_asym_sens_b_varn(mg=mg,ml=ml,a=a,b=-0.1,numkeep_last=numkeep_last,ploton=T,resloc=resloc)
ans_b_0.5<-plotter_asym_sens_b_varn(mg=mg,ml=ml,a=a,b=0.5,numkeep_last=numkeep_last,ploton=T,resloc=resloc)
ans_b_neg0.5<-plotter_asym_sens_b_varn(mg=mg,ml=ml,a=a,b=-0.5,numkeep_last=numkeep_last,ploton=T,resloc=resloc)

vlist_b_0.1_b_0.5<-c(ans_b_0.1,ans_b_neg0.1,ans_b_0.5,ans_b_neg0.5) # a list of 8 matrices

summary_stat<-as.data.frame(matrix(NA,7,8),stringsAsFactors = F) # Table for model selection summary
rownames(summary_stat)<-c("bestcop_AICw","N_AICw","relLTdep_AICw","relUTdep_AICw","p_CvM","p_KS","BS_success%")
#bg <- intToUtf8(0x03B2) 
cnm<-c("b_0.1_g~1~","b_0.1_g~2~","b_-0.1_g~1~","b_-0.1_g~2~","b_0.5_g~1~","b_0.5_g~2~","b_-0.5_g~1~","b_-0.5_g~2~")
#cname<-paste0(bg,cnm)
colnames(summary_stat)<-cnm

ms_asym_b_0.1_b_0.5<-vector(mode = "list", length = 8) # initializing list to store model selection results for all possible b variation
names(ms_asym_b_0.1_b_0.5)<-cnm

stat_npa_asym_b_0.1_b_0.5<-vector(mode = "list", length = 8) # initializing list to store NPA results for all possible b variation
names(stat_npa_asym_b_0.1_b_0.5)<-cnm

for(ic in c(1:8)){
  v<-vlist_b_0.1_b_0.5[[ic]]
  res<-OurBiCopSelect(u1=v[,1],u2=v[,2],families=c(1,3:10,13:14,16:20),level=0.05,
                      AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,
                      gofnormal=F,status=F)
  
  ms_asym_b_0.1_b_0.5[[ic]]<-res
  
  summary_stat[1,ic]<-max(res$InfCritRes$AICw)
  summary_stat[2,ic]<-res$InfCritRes$AICw[1]
  summary_stat[3,ic]<-res$relLTdep_AICw
  summary_stat[4,ic]<-res$relUTdep_AICw
  summary_stat[5,ic]<-res$GofRes_CvM
  summary_stat[6,ic]<-res$GofRes_KS
  summary_stat[7,ic]<-(res$Numboot_success/res$Numboot)*100
  
  stat_npa_asym_b_0.1_b_0.5[[ic]]<-bivfunctionplot(v=v,resloc="./Results/asym_sens_results/",nametag=cnm[ic],numbin=10)
  
}

saveRDS(summary_stat,"./Results/asym_sens_results/b_variation_summary_stat.RDS")
saveRDS(ms_asym_b_0.1_b_0.5,"./Results/asym_sens_results/ms_asym_b_0.1_b_0.5.RDS")
saveRDS(stat_npa_asym_b_0.1_b_0.5,"./Results/asym_sens_results/stat_npa_asym_b_0.1_b_0.5.RDS")
```

```{r overwritting_plots_asym_cop,echo=F,results="hide"}
pdf("./Results/asym_sens_results/a_0.2_b_0.1_r_0.8_asym_sens.pdf",height=3,width=6)
op<-par(mfrow=c(1,2),mar=c(3.5,4,1,1),mgp=c(2.2,0.5,0))
pop<-ans_b_0.1$pop
plot(pop[,1],pop[,2],xlab=expression(paste(E[1])), ylab=expression(paste(E[2])),cex.lab=1.5,
     cex.axis=1,col=rgb(0,0,0,0.2),pch=20,cex=0.6)
text(0.1,0.95,"A",cex=2)
pop<-ans_b_0.1$pop_d
plot(pop[,1],pop[,2],xlab=expression(paste(E[1])), ylab=expression(paste(E[2])),cex.lab=1.5,
     cex.axis=1,pch=20,col=rgb(0,0,0,0.2),cex=0.6)
text(0.1,0.95,"B",cex=2)
par(op)
dev.off()

pdf("./Results/asym_sens_results/a_0.2_b_-0.1_r_0.8_asym_sens.pdf",height=3,width=6)
op<-par(mfrow=c(1,2),mar=c(3.5,4,1,1),mgp=c(2.2,0.5,0))
pop<-ans_b_neg0.1$pop
plot(pop[,1],pop[,2],xlab=expression(paste(E[1])), ylab=expression(paste(E[2])),cex.lab=1.5,
     cex.axis=1,pch=20,col=rgb(0,0,0,0.2),cex=0.6)
text(0.1,0.95,"A",cex=2)
pop<-ans_b_neg0.1$pop_d
plot(pop[,1],pop[,2],xlab=expression(paste(E[1])), ylab=expression(paste(E[2])),cex.lab=1.5,
     cex.axis=1,col=rgb(0,0,0,0.2),pch=20,cex=0.6)
text(0.1,0.95,"B",cex=2)
par(op)
dev.off()

pdf("./Results/asym_sens_results/a_0.2_b_0.5_r_0.8_asym_sens.pdf",height=3,width=6)
op<-par(mfrow=c(1,2),mar=c(3.5,4,1,1),mgp=c(2.2,0.5,0))
pop<-ans_b_0.5$pop
plot(pop[,1],pop[,2],xlab=expression(paste(E[1])), ylab=expression(paste(E[2])),cex.lab=1.5,
     cex.axis=1,col=rgb(0,0,0,0.2),pch=20,cex=0.6)
text(0.1,0.95,"C",cex=2)
pop<-ans_b_0.5$pop_d
plot(pop[,1],pop[,2],xlab=expression(paste(E[1])), ylab=expression(paste(E[2])),cex.lab=1.5,
     cex.axis=1,col=rgb(0,0,0,0.2),pch=20,cex=0.6)
text(0.1,0.95,"D",cex=2)
par(op)
dev.off()

pdf("./Results/asym_sens_results/a_0.2_b_-0.5_r_0.8_asym_sens.pdf",height=3,width=6)
op<-par(mfrow=c(1,2),mar=c(3.5,4,1,1),mgp=c(2.2,0.5,0))
pop<-ans_b_neg0.5$pop
plot(pop[,1],pop[,2],xlab=expression(paste(E[1])), ylab=expression(paste(E[2])),cex.lab=1.5,
     cex.axis=1,col=rgb(0,0,0,0.2),pch=20,cex=0.6)
text(0.1,0.95,"E",cex=2)
pop<-ans_b_neg0.5$pop_d
plot(pop[,1],pop[,2],xlab=expression(paste(E[1])), ylab=expression(paste(E[2])),cex.lab=1.5,
     cex.axis=1,col=rgb(0,0,0,0.2),pch=20,cex=0.6)
text(0.1,0.95,"F",cex=2)
par(op)
dev.off()
```

<!--adding plots from asymmetric dependence analysis results-->

\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/asym_sens_results/a_0.2_b_-0.1_r_0.8_asym_sens.pdf}
\includegraphics[width=12 cm]{./Results/asym_sens_results/a_0.2_b_0.5_r_0.8_asym_sens.pdf}
\includegraphics[width=12 cm]{./Results/asym_sens_results/a_0.2_b_-0.5_r_0.8_asym_sens.pdf}
\caption[Analogous to Fig. \ref{MT-fig_ms_asym_b_0.1}, but using different model parameters]{Analogous to Fig. \ref{MT-fig_ms_asym_b_0.1}, but using $b=-0.1$ (A-B), $b=0.5$ (C-D) and $b=-0.5$ (E-F).\label{fig_ms_asym_b_-0.1_0.5_-0.5}}
\end{center}
\end{figure}

<!--Displaying summary table with model selection results from asymmetric dependence analysis-->
<!--Decided to remove this from the AER version
```{r tab_summary_stat_asym_sens,echo=F,results="markup"}
summary_stat<-summary_stat[c(1:6),]
rownames(summary_stat)<-c("Best-fit copula AICw","Normal copula AICw","Model-avg. LT","Model-avg. UT","p, CvM","p, KS")
knitr::kable(summary_stat, booktabs = T, escape=F,
             format = "latex", linesep = "",
             digits=4, col.names=c("b=0.1, g$_{1}$","b=0.1, g$_{2}$",
                                   "b=-0.1, g$_{1}$","b=-0.1, g$_{2}$",
                                   "b=0.5, g$_{1}$","b=0.5, g$_{2}$",
                                   "b=-0.5, g$_{1}$","b=-0.5, g$_{2}$"),
      caption.short="Asymmetric sensitivity model, model selection results",
      caption="Asymmetric sensitivity model, model selection results. 
The output of simulations from the first model detailed in 
the methods section for Q2 (i.e., Figs \\ref{MT-fig_ms_asym_b_0.1} and 
\\ref{fig_ms_asym_b_-0.1_0.5_-0.5}) were subjected to the model 
selection procedures detailed in the 
methods section for Q1. Best-fit copula AICw: the AIC weight of the best-fitting copula family;
Normal copula AICw: the AIC weight of the normal copula family; Model-avg. LT: the lower-tail 
statistic, weighted-averaged across models using AICw; Model-avg. UT: same, but for the 
upper-tail statistic; p, CvM: p-value for goodness of fit test of the best-fitting copula
family using the test based on the Cramer-von Mises statistic; p, KS: p-value for goodness of fit 
test of the best-fitting copula family using the test based on the Kolmogorov-Smirnov 
statistic.\\label{tab_summary_stat_asym_sens}")
```
-->

<!--*** Keeping old complex table for future use, simpler version now displayed in main text:
Displaying summary table with non-parametric approach results of asymmetric dependence analysis
```{r tab_stat_npa_asym,echo=F,results="markup"}
library(kableExtra)

tab_asym<-readRDS("./Results/asym_sens_results/stat_npa_asym_b_0.1_b_0.5.RDS")
tab_stat_npa_asym<-c()
for(i in c(1:8)){
  temp<-make_table_stat_fn(data=tab_asym[[i]])
  tab_stat_npa_asym<-rbind(tab_stat_npa_asym,temp)
}
gtext<-c("b=0.1, g$_{1}$","b=0.1, g$_{2}$","b=-0.1, g$_{1}$","b=-0.1, g$_{2}$","b=0.5, g$_{1}$","b=0.5, g$_{2}$","b=-0.5, g$_{1}$","b=-0.5, g$_{2}$")
tab_stat_npa_asym<-cbind(b=rep(c(0.1,0.1,-0.1,-0.1,0.5,0.5,-0.5,-0.5),each=3),
  g=rep(c("g$_{1}$","g$_{2}$","g$_{1}$","g$_{2}$","g$_{1}$","g$_{2}$","g$_{1}$","g$_{2}$"),each=3),tab_stat_npa_asym)
knitr::kable(tab_stat_npa_asym, booktabs = T, longtable=T,
             format = "latex",linesep = "",escape=F,
             caption.short = "Asymmetric sensitivity model, nonparametric statistics results",
             caption ="Asymmetric sensitivity model, nonparametric statistics results. 
The output of simulations from the first model detailed in 
the methods section for Q2 (i.e., Figs \\ref{MT-fig_ms_asym_b_0.1} and 
\\ref{fig_ms_asym_b_-0.1_0.5_-0.5}) were subjected to nonparamtric statistical 
analyses decribed in the methods section for Q1. The listed statistic was computed for the
output of the model with the indicated b and g, and the value was compared to 1000 values
of the same statistic computed on surrogate time series randomized to have normal copula structure
(see methods for Q1). A table entry $<X$ (respectively, $>X$) indicates the value of the 
given statistic on the data was less (respectively, more) than its value on $X$ of the 
surrogates, so entries of the form $<X$ (respectively, $>X$) for $X$ equal to $975$ or above 
indicate that upper-tail (respectively, lower-tail) dependence was significantly stronger than 
lower-tail dependence compared to a normal-copula null hypothesis. `FS' stands for `first slice'
and refers to the bounds 0 to 0.1; `LS' stands for `last slice' and refers to the bounds
0.9 to 1.\\label{tab_stat_npa_asym}")
```
-->

<!---Simpler version: Displaying summary table with non-parametric approach results of asymmetric dependence analysis--->
<!--
```{r tab_stat_npa_asym_simple,echo=F,results="markup"}
library(kableExtra)

tab_asym<-readRDS("./Results/asym_sens_results/stat_npa_asym_b_0.1_b_0.5.RDS")
tab_stat_npa_asym<-c()
for(i in c(1:8)){
  temp<-make_table_stat_fn(data=tab_asym[[i]])
  tab_stat_npa_asym<-rbind(tab_stat_npa_asym,temp)
}

ind_corstat<-which(tab_stat_npa_asym$Statistic %in% c("cor$_{FS}$-cor$_{LS}$"))
tab_corstat_asym<-tab_stat_npa_asym[ind_corstat,]
tab_corstat_asym<-tab_corstat_asym[,-1]

#gtext<-c("b=0.1, g$_{1}$","b=0.1, g$_{2}$","b=-0.1, g$_{1}$","b=-0.1, g$_{2}$","b=0.5, g$_{1}$","b=0.5, g$_{2}$","b=-0.5, #g$_{1}$","b=-0.5, g$_{2}$")
#tab_stat_npa_asym<-cbind(gtext,tab_corstat_asym)

tab_corstat_asym<-cbind(b=c(0.1,0.1,-0.1,-0.1,0.5,0.5,-0.5,-0.5),
  g=c("g$_{1}$","g$_{2}$","g$_{1}$","g$_{2}$","g$_{1}$","g$_{2}$","g$_{1}$","g$_{2}$"),tab_corstat_asym)

rownames(tab_corstat_asym)<-NULL

knitr::kable(tab_corstat_asym, booktabs = T, 
             format = "latex",linesep = "",escape=F, 
             caption.short = "Asymmetric sensitivity model, nonparametric statistics results",
             caption ="Asymmetric sensitivity model, nonparametric statistics results. 
Outputs of simulations from the first model detailed in 
the methods section for Q2 (i.e., Figs \\ref{MT-fig_ms_asym_b_0.1} and 
\\ref{fig_ms_asym_b_-0.1_0.5_-0.5}) were subjected to nonparamtric statistical 
analyses decribed in the methods section for Q1. The statistic cor$_{FS}$ - cor$_{LS}$ was computed for the
output of the model with the indicated b and g, and the value was compared to 1000 values
of the same statistic computed on surrogate time series randomized to have normal copula structure
(see methods for Q1). A table entry $<X$ (respectively, $>X$) indicates the value of the 
given statistic on the data was less (respectively, more) than its value on $X$ of the 
surrogates, so entries of the form $<X$ (respectively, $>X$) for $X$ equal to $975$ or above 
indicate that upper-tail (respectively, lower-tail) dependence was significantly stronger than 
lower-tail dependence compared to a normal-copula null hypothesis. `FS' stands for `first slice'
and refers to the bounds 0 to 0.1; `LS' stands for `last slice' and refers to the bounds
0.9 to 1.\\label{tab_stat_npa_asym}")
```
-->

<!--Following two chunks examine Moran-like mechanism with clayton copula and then generate plots with the simulated results-->
```{r cause4copula_stat_ar1_clayton, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
# This chunk stores results for ar1 model : clayton

model<-"ar1"
fcode<-3
nsd<-1

# for positive beta
params<-c(0.5) # this parameter is beta in ar1 model
resloc<-"./Results/Cause4copula_results/"

tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")

if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
# for clayton with spearman and kendall method
ar1_C_spear_beta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="spearman",lb=0,ub=0.1,
                                           num_keep_last=500,resloc=resloc,
                                           params=params,p0=c(0,0),model=model)

saveRDS(ar1_C_spear_beta0.5,paste(resloc,"ar1_C_spear_beta0.5.RDS",sep=""))

ar1_C_kend_beta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="kendall",lb=0,ub=0.1,
                                          num_keep_last=500,resloc=resloc,
                                          params=params,p0=c(0,0),model=model)

saveRDS(ar1_C_kend_beta0.5,paste(resloc,"ar1_C_kend_beta0.5.RDS",sep=""))

# for negative beta
resloc<-"./Results/Cause4copula_results/"
params<-c(-0.5) # this parameter is beta in ar1 model
tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")

if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")
# for clayton with spearman and kendall method
ar1_C_spear_negbeta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="spearman",lb=0,ub=0.1,
                                              num_keep_last=500,resloc=resloc,
                                              params=params,p0=c(0,0),model=model)

saveRDS(ar1_C_spear_negbeta0.5,paste(resloc,"ar1_C_spear_negbeta0.5.RDS",sep=""))

ar1_C_kend_negbeta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="kendall",lb=0,ub=0.1,
                                               num_keep_last=500,resloc=resloc,
                                               params=params,p0=c(0,0),model=model)

saveRDS(ar1_C_kend_negbeta0.5,paste(resloc,"ar1_C_kend_negbeta0.5.RDS",sep=""))
```

```{r plot_cause4copula_stat_ar1_clayton, echo=F, results="hide", cache=T, cache.extra=list(seed,ar1_C_spear_beta0.5,ar1_C_spear_negbeta0.5,ar1_C_kend_beta0.5,ar1_C_kend_negbeta0.5,mtime("Plotter_Cause4copula_stat.R"))}

set.seed(seed)
source("Plotter_Cause4copula_stat.R")
#---------------------------------------
# This chunk plots results for ar1 model : clayton

model<-"ar1"
fcode<-3
resloc0<-"./Results/Cause4copula_results/"

# for positive beta
params<-c(0.5) # this parameter is beta in ar1 model

tempo<-paste(resloc0,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")
resloc<-paste(tempo,"/",sep="")

readres<-readRDS(paste(resloc,"ar1_C_spear_beta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
readres<-readRDS(paste(resloc,"ar1_C_kend_beta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)

# for negative beta
params<-c(-0.5) # this parameter is beta in ar1 model
tempo<-paste(resloc0,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")
resloc<-paste(tempo,"/",sep="")

readres<-readRDS(paste(resloc,"ar1_C_spear_negbeta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
readres<-readRDS(paste(resloc,"ar1_C_kend_negbeta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
```

<!--Following two chunks examine Moran-like mechanism with survival clayton copula noises in AR(1) model 
and then generate plots with the simulated results-->
```{r cause4copula_stat_ar1_survivalclayton, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
# This chunk stores results for ar1 model : survival clayton
model<-"ar1"
fcode<-13
nsd<-1

# for positive beta
params<-c(0.5) # this parameter is beta in ar1 model

resloc<-"./Results/Cause4copula_results/"
tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")

if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
# for survival clayton with spearman and kendall method
ar1_SC_spear_beta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="spearman",lb=0,ub=0.1,
                                            num_keep_last=500,resloc=resloc,
                                            params=params,p0=c(0,0),model=model)

saveRDS(ar1_SC_spear_beta0.5,paste(resloc,"ar1_SC_spear_beta0.5.RDS",sep=""))

ar1_SC_kend_beta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="kendall",lb=0,ub=0.1,
                                           num_keep_last=500,resloc=resloc,
                                           params=params,p0=c(0,0),model=model)

saveRDS(ar1_SC_kend_beta0.5,paste(resloc,"ar1_SC_kend_beta0.5.RDS",sep=""))
# for negative beta
params<-c(-0.5) # this parameter is beta in ar1 model

resloc<-"./Results/Cause4copula_results/"
tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")

if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")
# for survival clayton with spearman and kendall method
ar1_SC_spear_negbeta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="spearman",lb=0,ub=0.1,
                                               num_keep_last=500,resloc=resloc,
                                               params=params,p0=c(0,0),model=model)
saveRDS(ar1_SC_spear_negbeta0.5,paste(resloc,"ar1_SC_spear_negbeta0.5.RDS",sep=""))

ar1_SC_kend_negbeta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="kendall",lb=0,ub=0.1,
                                              num_keep_last=500,resloc=resloc,
                                              params=params,p0=c(0,0),model=model)
saveRDS(ar1_SC_kend_negbeta0.5,paste(resloc,"ar1_SC_kend_negbeta0.5.RDS",sep=""))
```

```{r plot_cause4copula_stat_ar1_survivalclayton, echo=F, results="hide", cache=T, cache.extra=list(seed,ar1_SC_spear_beta0.5,ar1_SC_spear_negbeta0.5,ar1_SC_kend_beta0.5,ar1_SC_kend_negbeta0.5,mtime("Plotter_Cause4copula_stat.R"))}

set.seed(seed)
source("Plotter_Cause4copula_stat.R")
#---------------------------------------
# This chunk plots results for ar1 model : clayton

model<-"ar1"
fcode<-13
resloc0<-"./Results/Cause4copula_results/"

# for positive beta
params<-c(0.5) # this parameter is beta in ar1 model

tempo<-paste(resloc0,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")
resloc<-paste(tempo,"/",sep="")

readres<-readRDS(paste(resloc,"ar1_SC_spear_beta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
readres<-readRDS(paste(resloc,"ar1_SC_kend_beta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)

# for negative beta
params<-c(-0.5) # this parameter is beta in ar1 model
tempo<-paste(resloc0,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")
resloc<-paste(tempo,"/",sep="")

readres<-readRDS(paste(resloc,"ar1_SC_spear_negbeta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
readres<-readRDS(paste(resloc,"ar1_SC_kend_negbeta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
```

<!--Plots for AR(1) with Survival Clayton-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Clayton/Survival Clayton_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, AR(1) model, 
survival Clayton copula]{Comparison of copula structure of noise inputs and model outputs, AR(1) 
model, survival Clayton copula. Same format as Fig. \ref{MT-fig_Cause4copula_C_kend_ar1}, 
see caption of that figure for 
details.\label{fig_Cause4copula_SC_kend_ar1}}
\end{center}
\end{figure}

<!--Following two chunks examine Moran-like mechanism with gumbel copula noises in AR(1) model 
and then generate plots with the simulated results-->
```{r cause4copula_stat_ar1_gumbel, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
# This chunk stores results for ar1 model : clayton

model<-"ar1"
fcode<-4
nsd<-1

# for positive beta
params<-c(0.5) # this parameter is beta in ar1 model
resloc<-"./Results/Cause4copula_results/"

tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")

if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
# for gumbel with spearman and kendall method
ar1_G_spear_beta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="spearman",lb=0,ub=0.1,
                                              num_keep_last=500,resloc=resloc,
                                              params=params,p0=c(0,0),model=model)
saveRDS(ar1_G_spear_beta0.5,paste(resloc,"ar1_G_spear_beta0.5.RDS",sep=""))

ar1_G_kend_beta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="kendall",lb=0,ub=0.1,
                                             num_keep_last=500,resloc=resloc,
                                             params=params,p0=c(0,0),model=model)

saveRDS(ar1_G_kend_beta0.5,paste(resloc,"ar1_G_kend_beta0.5.RDS",sep=""))

# for negative beta
resloc<-"./Results/Cause4copula_results/"
params<-c(-0.5) # this parameter is beta in ar1 model
tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")

if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")
# for gumbel with spearman and kendall method
ar1_G_spear_negbeta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="spearman",lb=0,ub=0.1,
                                              num_keep_last=500,resloc=resloc,
                                              params=params,p0=c(0,0),model=model)
saveRDS(ar1_G_spear_negbeta0.5,paste(resloc,"ar1_G_spear_negbeta0.5.RDS",sep=""))

ar1_G_kend_negbeta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="kendall",lb=0,ub=0.1,
                                             num_keep_last=500,resloc=resloc,
                                             params=params,p0=c(0,0),model=model)

saveRDS(ar1_G_kend_negbeta0.5,paste(resloc,"ar1_G_kend_negbeta0.5.RDS",sep=""))
```

```{r plot_cause4copula_stat_ar1_gumbel, echo=F, results="hide", cache=T, cache.extra=list(seed,ar1_G_spear_beta0.5,ar1_G_spear_negbeta0.5,ar1_G_kend_beta0.5,ar1_G_kend_negbeta0.5,mtime("Plotter_Cause4copula_stat.R"))}

set.seed(seed)
source("Plotter_Cause4copula_stat.R")
#---------------------------------------
# This chunk plots results for ar1 model : clayton

model<-"ar1"
fcode<-4
resloc0<-"./Results/Cause4copula_results/"

# for positive beta
params<-c(0.5) # this parameter is beta in ar1 model

tempo<-paste(resloc0,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")
resloc<-paste(tempo,"/",sep="")

readres<-readRDS(paste(resloc,"ar1_G_spear_beta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
readres<-readRDS(paste(resloc,"ar1_G_kend_beta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)

# for negative beta
params<-c(-0.5) # this parameter is beta in ar1 model
tempo<-paste(resloc0,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")
resloc<-paste(tempo,"/",sep="")

readres<-readRDS(paste(resloc,"ar1_G_spear_negbeta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
readres<-readRDS(paste(resloc,"ar1_G_kend_negbeta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
```

<!--Plots for AR(1) with Gumbel-->
<!--Removed from AER version
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Gumbel/Gumbel_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, AR(1) model, 
Gumbel copula.]{Comparison of copula structure of noise inputs and model outputs, AR(1) 
model, Gumbel copula. Same format as Figs \ref{fig_Cause4copula_C_kend_ar1} and 
\ref{MT-fig_Cause4copula_scatter_C_kend_ar1}, see captions of those figures for 
details.\label{fig_Cause4copula_G_kend_ar1}}
\end{center}
\end{figure}
-->

<!--Following two chunks examine Moran-like mechanism with survival gumbel copula noises in AR(1) model 
and then generate plots with the simulated results-->
```{r cause4copula_stat_ar1_survivalgumbel, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
# This chunk stores results for ar1 model : survival clayton
model<-"ar1"
fcode<-14
nsd<-1

# for positive beta
params<-c(0.5) # this parameter is beta in ar1 model

resloc<-"./Results/Cause4copula_results/"
tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")

if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
# for survival gumbel with spearman and kendall method
ar1_SG_spear_beta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="spearman",lb=0,ub=0.1,
                                              num_keep_last=500,resloc=resloc,
                                              params=params,p0=c(0,0),model=model)
saveRDS(ar1_SG_spear_beta0.5,paste(resloc,"ar1_SG_spear_beta0.5.RDS",sep=""))

ar1_SG_kend_beta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="kendall",lb=0,ub=0.1,
                                             num_keep_last=500,resloc=resloc,
                                             params=params,p0=c(0,0),model=model)

saveRDS(ar1_SG_kend_beta0.5,paste(resloc,"ar1_SG_kend_beta0.5.RDS",sep=""))

# for negative beta
params<-c(-0.5) # this parameter is beta in ar1 model

resloc<-"./Results/Cause4copula_results/"
tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")

if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")
# for survival gumbel with spearman and kendall method
ar1_SG_spear_negbeta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="spearman",lb=0,ub=0.1,
                                              num_keep_last=500,resloc=resloc,
                                              params=params,p0=c(0,0),model=model)
saveRDS(ar1_SG_spear_negbeta0.5,paste(resloc,"ar1_SG_spear_negbeta0.5.RDS",sep=""))

ar1_SG_kend_negbeta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="kendall",lb=0,ub=0.1,
                                             num_keep_last=500,resloc=resloc,
                                             params=params,p0=c(0,0),model=model)

saveRDS(ar1_SG_kend_negbeta0.5,paste(resloc,"ar1_SG_kend_negbeta0.5.RDS",sep=""))
```

```{r plot_cause4copula_stat_ar1_survivalgumbel, echo=F, results="hide", cache=T, cache.extra=list(seed,ar1_SG_spear_beta0.5,ar1_SG_spear_negbeta0.5,ar1_SG_kend_beta0.5,ar1_SG_kend_negbeta0.5,mtime("Plotter_Cause4copula_stat.R"))}

set.seed(seed)
source("Plotter_Cause4copula_stat.R")
#---------------------------------------
# This chunk plots results for ar1 model : clayton

model<-"ar1"
fcode<-14
resloc0<-"./Results/Cause4copula_results/"

# for positive beta
params<-c(0.5) # this parameter is beta in ar1 model

tempo<-paste(resloc0,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")
resloc<-paste(tempo,"/",sep="")

readres<-readRDS(paste(resloc,"ar1_SG_spear_beta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
readres<-readRDS(paste(resloc,"ar1_SG_kend_beta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)

# for negative beta
params<-c(-0.5) # this parameter is beta in ar1 model
tempo<-paste(resloc0,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")
resloc<-paste(tempo,"/",sep="")

readres<-readRDS(paste(resloc,"ar1_SG_spear_negbeta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
readres<-readRDS(paste(resloc,"ar1_SG_kend_negbeta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
```

<!--Plots for AR(1) with Survival Gumbel-->
<!--Removed from AER version
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Gumbel/Survival Gumbel_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, AR(1) model, 
survival Gumbel copula.]{Comparison of copula structure of noise inputs and model outputs, AR(1) 
model, survival Gumbel copula. Same format as Figs \ref{fig_Cause4copula_C_kend_ar1} and 
\ref{MT-fig_Cause4copula_scatter_C_kend_ar1}, see captions of those figures for 
details.\label{fig_Cause4copula_SG_kend_ar1}}
\end{center}
\end{figure}
-->

<!--Following two chunks examine Moran-like mechanism with joe copula noises in AR(1) model 
and then generate plots with the simulated results-->
```{r cause4copula_stat_ar1_joe, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
# This chunk stores results for ar1 model : clayton

model<-"ar1"
fcode<-6
nsd<-1

# for positive beta
params<-c(0.5) # this parameter is beta in ar1 model
resloc<-"./Results/Cause4copula_results/"

tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")

if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
# for joe with kendall method only

ar1_J_kend_beta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="kendall",lb=0,ub=0.1,
                                             num_keep_last=500,resloc=resloc,
                                             params=params,p0=c(0,0),model=model)

saveRDS(ar1_J_kend_beta0.5,paste(resloc,"ar1_J_kend_beta0.5.RDS",sep=""))

# for negative beta
resloc<-"./Results/Cause4copula_results/"
params<-c(-0.5) # this parameter is beta in ar1 model
tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")

if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")
# for joe with kendall method only

ar1_J_kend_negbeta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="kendall",lb=0,ub=0.1,
                                             num_keep_last=500,resloc=resloc,
                                             params=params,p0=c(0,0),model=model)

saveRDS(ar1_J_kend_negbeta0.5,paste(resloc,"ar1_J_kend_negbeta0.5.RDS",sep=""))
```

```{r plot_cause4copula_stat_ar1_joe, echo=F, results="hide", cache=T, cache.extra=list(seed,ar1_J_kend_beta0.5,ar1_J_kend_negbeta0.5,mtime("Plotter_Cause4copula_stat.R"))}

set.seed(seed)
source("Plotter_Cause4copula_stat.R")
#---------------------------------------
# This chunk plots results for ar1 model : clayton

model<-"ar1"
fcode<-6
resloc0<-"./Results/Cause4copula_results/"

# for positive beta
params<-c(0.5) # this parameter is beta in ar1 model

tempo<-paste(resloc0,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")
resloc<-paste(tempo,"/",sep="")

readres<-readRDS(paste(resloc,"ar1_J_kend_beta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)

# for negative beta
params<-c(-0.5) # this parameter is beta in ar1 model
tempo<-paste(resloc0,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")
resloc<-paste(tempo,"/",sep="")

readres<-readRDS(paste(resloc,"ar1_J_kend_negbeta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
```

<!--Plots for AR(1) with Joe-->
<!--Removed from AER version
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Joe/Joe_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, AR(1) model, 
Joe copula.]{Comparison of copula structure of noise inputs and model outputs, AR(1) 
model, Joe copula. Same format as Figs \ref{fig_Cause4copula_C_kend_ar1} and 
\ref{MT-fig_Cause4copula_scatter_C_kend_ar1}, see captions of those figures for 
details.\label{fig_Cause4copula_J_kend_ar1}}
\end{center}
\end{figure}
-->

<!--Following two chunks examine Moran-like mechanism with survival joe copula noises in AR(1) model
and then generate plots with the simulated results-->
```{r cause4copula_stat_ar1_survivaljoe, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
# This chunk stores results for ar1 model : survival clayton
model<-"ar1"
fcode<-16
nsd<-1

# for positive beta
params<-c(0.5) # this parameter is beta in ar1 model

resloc<-"./Results/Cause4copula_results/"
tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")

if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
# for survival joe with kendall method only

ar1_SJ_kend_beta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="kendall",lb=0,ub=0.1,
                                             num_keep_last=500,resloc=resloc,
                                             params=params,p0=c(0,0),model=model)

saveRDS(ar1_SJ_kend_beta0.5,paste(resloc,"ar1_SJ_kend_beta0.5.RDS",sep=""))

# for negative beta
params<-c(-0.5) # this parameter is beta in ar1 model

resloc<-"./Results/Cause4copula_results/"
tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")

if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")
# for survival joe with kendall method only

ar1_SJ_kend_negbeta0.5<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=nsd,method="kendall",lb=0,ub=0.1,
                                             num_keep_last=500,resloc=resloc,
                                             params=params,p0=c(0,0),model=model)

saveRDS(ar1_SJ_kend_negbeta0.5,paste(resloc,"ar1_SJ_kend_negbeta0.5.RDS",sep=""))
```

```{r plot_cause4copula_stat_ar1_survivaljoe, echo=F, results="hide", cache=T, cache.extra=list(seed,ar1_SJ_kend_beta0.5,ar1_SJ_kend_negbeta0.5,mtime("Plotter_Cause4copula_stat.R"))}

set.seed(seed)
source("Plotter_Cause4copula_stat.R")
#---------------------------------------
# This chunk plots results for ar1 model : clayton

model<-"ar1"
fcode<-16
resloc0<-"./Results/Cause4copula_results/"

# for positive beta
params<-c(0.5) # this parameter is beta in ar1 model

tempo<-paste(resloc0,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")
resloc<-paste(tempo,"/",sep="")

readres<-readRDS(paste(resloc,"ar1_SJ_kend_beta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)

# for negative beta
params<-c(-0.5) # this parameter is beta in ar1 model
tempo<-paste(resloc0,"Cause4copula_stat_results_",model,"_beta_",params,"_",BiCopName(fcode,short=F),sep="")
resloc<-paste(tempo,"/",sep="")

readres<-readRDS(paste(resloc,"ar1_SJ_kend_negbeta0.5.RDS",sep=""))
Plotter_Cause4copula_stat(res=readres)
```

<!--Plots for AR(1) with Survival Joe-->
<!--Removed from AER version
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ar1_beta_0.5_Survival Joe/Survival Joe_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, AR(1) model, 
survival Joe  copula.]{Comparison of copula structure of noise inputs and model outputs, AR(1) 
model, survival Joe  copula. Same format as Figs \ref{fig_Cause4copula_C_kend_ar1} and 
\ref{MT-fig_Cause4copula_scatter_C_kend_ar1}, see captions of those figures for 
details.\label{fig_Cause4copula_SJ_kend_ar1}}
\end{center}
\end{figure}
-->

<!--Following two chunks examine Moran-like mechanism with clayton copula noises in Ricker model and 
then generate plots with the simulated results-->
```{r cause4copula_stat_ricker_clayton, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
# This chunk stores results for ar1 model : clayton
tag_ricker_C<-"999C" #this is a caching tag used later to cache output from present chunk

model<-"ricker"
fcode<-3

nsdlist<-c(0.1,1)
Klist<-c(100)

# for varying r (@r=1 transition from under- to over-compensatory dynamics )
rlist<-seq(from=0.1,to=1.3,by=0.2)

for(insd in nsdlist){
  for(iK in Klist){
   for(i in rlist){
    params<-c(i,iK) # this parameter is a vector with r and K
    p0<-c(params[2],params[2])

    resloc<-"./Results/Cause4copula_results/"

    tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_nsd_",insd,"_r_",params[1],"_K_",params[2],"_",BiCopName(fcode,short=F),sep="")

    if (!dir.exists(tempo)){
      dir.create(tempo)
    }
    resloc<-paste(tempo,"/",sep="")

  # for clayton with spearman and kendall method
    myres<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=insd,method="spearman",lb=0,ub=0.1,
                                           num_keep_last=500,resloc=resloc,
                                           params=params,p0=p0,model=model)

    saveRDS(myres,paste(resloc,"ricker_C_spear.RDS",sep=""))

    myres<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=insd,method="kendall",lb=0,ub=0.1,
                                          num_keep_last=500,resloc=resloc,
                                          params=params,p0=p0,model=model)

    saveRDS(myres,paste(resloc,"ricker_C_kend.RDS",sep=""))

  }
 }
}
```

```{r plot_cause4copula_stat_ricker_C, echo=F, results="hide",cache=T, cache.extra=list(seed,tag_ricker_C,mtime("Plotter_Cause4copula.R"))}

set.seed(seed)
source("Plotter_Cause4copula_stat.R")
#---------------------------------------
# This chunk plots results for ar1 model : clayton

model<-"ricker"
fcode<-3
resloc0<-"./Results/Cause4copula_results/"

nsdlist<-c(0.1,1)
Klist<-c(100)

# for varying r (@r=1 transition from under- to over-compensatory dynamics )
rlist<-seq(from=0.1,to=1.3,by=0.2)

for(insd in nsdlist){
  for(iK in Klist){
   for(i in rlist){
    params<-c(i,iK) # this parameter is a vector with r and K
    p0<-c(params[2],params[2])

    resloc<-"./Results/Cause4copula_results/"

    tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_nsd_",insd,"_r_",params[1],"_K_",params[2],"_",BiCopName(fcode,short=F),sep="")
    
    resloc<-paste(tempo,"/",sep="")

    readres<-readRDS(paste(resloc,"ricker_C_spear.RDS",sep=""))
    Plotter_Cause4copula_stat(res=readres)
    readres<-readRDS(paste(resloc,"ricker_C_kend.RDS",sep=""))
    Plotter_Cause4copula_stat(res=readres)

  }
 }
}
```

<!--Plots for stochastic ricker with weak noise (Clayton copula) : nsd=0.1-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Clayton/Clayton_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, stochastic Ricker 
model, weak noise, Clayton copula]{Comparison of copula structure of noise inputs and model 
outputs, stochastic Ricker model, weak noise, Clayton copula. Same format as Fig. 
\ref{MT-fig_Cause4copula_C_kend_ar1}, 
see caption of that figure for details.\label{fig_Cause4copula_C_kend_sRicker_nsd_0.1}}
\end{center}
\end{figure}

<!--Following two chunks examine Moran-like mechanism with survival clayton copula noises in Ricker model and 
then generate plots with the simulated results-->
```{r cause4copula_stat_ricker_survivalclayton, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
tag_ricker_SC<-"999SC" #this is a caching tag used later to cache output from present chunk

# This chunk stores results for ar1 model : survival clayton

model<-"ricker"
fcode<-13
nsdlist<-c(0.1,1)
Klist<-c(100)
# for varying r (@r=1 transition from under- to over-compensatory dynamics )
rlist<-seq(from=0.1,to=1.3,by=0.2)


for(insd in nsdlist){
  for(iK in Klist){
   for(i in rlist){
    params<-c(i,iK) # this parameter is a vector with r and K
    p0<-c(params[2],params[2])

    resloc<-"./Results/Cause4copula_results/"

    tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_nsd_",insd,"_r_",params[1],"_K_",params[2],"_",BiCopName(fcode,short=F),sep="")

    if (!dir.exists(tempo)){
      dir.create(tempo)
    }
    resloc<-paste(tempo,"/",sep="")

  # for survival clayton with spearman and kendall method
    myres<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=insd,method="spearman",lb=0,ub=0.1,
                                           num_keep_last=500,resloc=resloc,
                                           params=params,p0=p0,model=model)

    saveRDS(myres,paste(resloc,"ricker_SC_spear.RDS",sep=""))

    myres<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=insd,method="kendall",lb=0,ub=0.1,
                                          num_keep_last=500,resloc=resloc,
                                          params=params,p0=p0,model=model)

    saveRDS(myres,paste(resloc,"ricker_SC_kend.RDS",sep=""))
  }
 }
}
```

```{r plot_cause4copula_stat_ricker_SC, echo=F, results="hide",cache=T, cache.extra=list(seed,tag_ricker_SC,mtime("Plotter_Cause4copula.R"))}

set.seed(seed)
source("Plotter_Cause4copula_stat.R")
#---------------------------------------

model<-"ricker"
fcode<-13
resloc0<-"./Results/Cause4copula_results/"

nsdlist<-c(0.1,1)
Klist<-c(100)

# for varying r (@r=1 transition from under- to over-compensatory dynamics )
rlist<-seq(from=0.1,to=1.3,by=0.2)

for(insd in nsdlist){
  for(iK in Klist){
   for(i in rlist){
    params<-c(i,iK) # this parameter is a vector with r and K
    p0<-c(params[2],params[2])

    resloc<-"./Results/Cause4copula_results/"

    tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_nsd_",insd,"_r_",params[1],"_K_",params[2],"_",BiCopName(fcode,short=F),sep="")
    
    resloc<-paste(tempo,"/",sep="")

    readres<-readRDS(paste(resloc,"ricker_SC_spear.RDS",sep=""))
    Plotter_Cause4copula_stat(res=readres)
    readres<-readRDS(paste(resloc,"ricker_SC_kend.RDS",sep=""))
    Plotter_Cause4copula_stat(res=readres)

  }
 }
}
```

<!--Plots for stochastic ricker with weak noise (Survival Clayton copula) : nsd=0.1-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Clayton/Survival Clayton_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, stochastic Ricker 
model, weak noise, survival Clayton copula]{Comparison of copula structure of noise inputs and model 
outputs, stochastic Ricker model, weak noise, survival Clayton copula. Same format as Fig. 
\ref{MT-fig_Cause4copula_C_kend_ar1}, 
see caption of that figure for details. \label{fig_Cause4copula_SC_kend_sRicker_nsd_0.1}}
\end{center}
\end{figure}

<!--Plots for stochastic ricker with strong noise (Clayton copula): nsd=1-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Clayton/Clayton_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, stochastic Ricker 
model, strong noise, Clayton copula]{Comparison of copula structure of noise inputs and model 
outputs, stochastic Ricker model, strong noise, Clayton copula. Same format as Fig. 
\ref{MT-fig_Cause4copula_C_kend_ar1}, 
see caption of that figure for details.\label{fig_Cause4copula_C_kend_sRicker_nsd_1}}
\end{center}
\end{figure}

<!--Plots for stochastic ricker with strong noise (Survival Clayton copula): nsd=1-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Clayton/Survival Clayton_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, stochastic Ricker 
model, strong noise, survival Clayton copula]{Comparison of copula structure of noise inputs and model 
outputs, stochastic Ricker model, strong noise, survival Clayton copula. Same format as Fig. 
\ref{MT-fig_Cause4copula_C_kend_ar1}, 
see caption of that figure for details. \label{fig_Cause4copula_SC_kend_sRicker_nsd_1}}
\end{center}
\end{figure}

<!--Following two chunks examine Moran-like mechanism with gumbel copula noises in Ricker model and 
then generate plots with the simulated results-->
```{r cause4copula_stat_ricker_gumbel, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
tag_ricker_G<-"999G" #this is a caching tag used later to cache output from present chunk

# This chunk stores results for ar1 model : gumbel

model<-"ricker"
fcode<-4
nsdlist<-c(0.1,1)
Klist<-c(100)
# for varying r (@r=1 transition from under- to over-compensatory dynamics )
rlist<-seq(from=0.1,to=1.3,by=0.2)

for(insd in nsdlist){
  for(iK in Klist){
   for(i in rlist){
    params<-c(i,iK) # this parameter is a vector with r and K
    p0<-c(params[2],params[2])

    resloc<-"./Results/Cause4copula_results/"

    tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_nsd_",insd,"_r_",params[1],"_K_",params[2],"_",BiCopName(fcode,short=F),sep="")

    if (!dir.exists(tempo)){
      dir.create(tempo)
    }
    resloc<-paste(tempo,"/",sep="")

  # for gumbel with spearman and kendall method
    myres<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=insd,method="spearman",lb=0,ub=0.1,
                                           num_keep_last=500,resloc=resloc,
                                           params=params,p0=p0,model=model)

    saveRDS(myres,paste(resloc,"ricker_G_spear.RDS",sep=""))

    myres<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=insd,method="kendall",lb=0,ub=0.1,
                                          num_keep_last=500,resloc=resloc,
                                          params=params,p0=p0,model=model)

    saveRDS(myres,paste(resloc,"ricker_G_kend.RDS",sep=""))
  }
 }
}
```

```{r plot_cause4copula_stat_ricker_G, echo=F, results="hide",cache=T, cache.extra=list(seed,tag_ricker_G,mtime("Plotter_Cause4copula.R"))}

set.seed(seed)
source("Plotter_Cause4copula_stat.R")
#---------------------------------------

model<-"ricker"
fcode<-4
resloc0<-"./Results/Cause4copula_results/"

nsdlist<-c(0.1,1)
Klist<-c(100)

# for varying r (@r=1 transition from under- to over-compensatory dynamics )
rlist<-seq(from=0.1,to=1.3,by=0.2)

for(insd in nsdlist){
  for(iK in Klist){
   for(i in rlist){
    params<-c(i,iK) # this parameter is a vector with r and K
    p0<-c(params[2],params[2])

    resloc<-"./Results/Cause4copula_results/"

    tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_nsd_",insd,"_r_",params[1],"_K_",params[2],"_",BiCopName(fcode,short=F),sep="")
    
    resloc<-paste(tempo,"/",sep="")

    readres<-readRDS(paste(resloc,"ricker_G_spear.RDS",sep=""))
    Plotter_Cause4copula_stat(res=readres)
    readres<-readRDS(paste(resloc,"ricker_G_kend.RDS",sep=""))
    Plotter_Cause4copula_stat(res=readres)

  }
 }
}
```

<!--Plots for stochastic ricker with weak noise (Gumbel copula) : nsd=0.1-->
<!--Removed from AER version
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Gumbel/Gumbel_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, stochastic Ricker 
model, weak noise, Gumbel copula.]{Comparison of copula structure of noise inputs and model 
outputs, stochastic Ricker model, weak noise, Gumbel copula. Same format as Figs 
\ref{fig_Cause4copula_C_kend_ar1} and \ref{MT-fig_Cause4copula_scatter_C_kend_ar1}, 
see captions of those figures for details.\label{fig_Cause4copula_G_kend_sRicker_nsd_0.1}}
\end{center}
\end{figure}
-->

<!--Plots for stochastic ricker with strong noise (Gumbel copula): nsd=1-->
<!--Removed from AER version
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Gumbel/Gumbel_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, stochastic Ricker 
model, strong noise, Gumbel copula.]{Comparison of copula structure of noise inputs and model 
outputs, stochastic Ricker model, strong noise, Gumbel copula. Same format as Figs 
\ref{fig_Cause4copula_C_kend_ar1} and \ref{MT-fig_Cause4copula_scatter_C_kend_ar1}, 
see captions of those figures for details.\label{fig_Cause4copula_G_kend_sRicker_nsd_1}}
\end{center}
\end{figure}
-->

<!--Following two chunks examine Moran-like mechanism with survival gumbel copula noises in Ricker model and 
then generate plots with the simulated results-->
```{r cause4copula_stat_ricker_survivalgumbel, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
tag_ricker_SG<-"999SG" #this is a caching tag used later to cache output from present chunk

# This chunk stores results for ar1 model : survival gumbel

model<-"ricker"
fcode<-14
nsdlist<-c(0.1,1)
Klist<-c(100)
# for varying r (@r=1 transition from under- to over-compensatory dynamics )
rlist<-seq(from=0.1,to=1.3,by=0.2)

for(insd in nsdlist){
  for(iK in Klist){
   for(i in rlist){
    params<-c(i,iK) # this parameter is a vector with r and K
    p0<-c(params[2],params[2])

    resloc<-"./Results/Cause4copula_results/"

    tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_nsd_",insd,"_r_",params[1],"_K_",params[2],"_",BiCopName(fcode,short=F),sep="")

    if (!dir.exists(tempo)){
      dir.create(tempo)
    }
    resloc<-paste(tempo,"/",sep="")

  # for survival gumbel with spearman and kendall method
    myres<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=insd,method="spearman",lb=0,ub=0.1,
                                           num_keep_last=500,resloc=resloc,
                                           params=params,p0=p0,model=model)

    saveRDS(myres,paste(resloc,"ricker_SG_spear.RDS",sep=""))

    myres<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=insd,method="kendall",lb=0,ub=0.1,
                                          num_keep_last=500,resloc=resloc,
                                          params=params,p0=p0,model=model)

    saveRDS(myres,paste(resloc,"ricker_SG_kend.RDS",sep=""))
  }
 }
}
```

```{r plot_cause4copula_stat_ricker_SG, echo=F, results="hide",cache=T, cache.extra=list(seed,tag_ricker_SG,mtime("Plotter_Cause4copula.R"))}

set.seed(seed)
source("Plotter_Cause4copula_stat.R")
#---------------------------------------

model<-"ricker"
fcode<-14
resloc0<-"./Results/Cause4copula_results/"

nsdlist<-c(0.1,1)
Klist<-c(100)

# for varying r (@r=1 transition from under- to over-compensatory dynamics )
rlist<-seq(from=0.1,to=1.3,by=0.2)

for(insd in nsdlist){
  for(iK in Klist){
   for(i in rlist){
    params<-c(i,iK) # this parameter is a vector with r and K
    p0<-c(params[2],params[2])

    resloc<-"./Results/Cause4copula_results/"

    tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_nsd_",insd,"_r_",params[1],"_K_",params[2],"_",BiCopName(fcode,short=F),sep="")
    
    resloc<-paste(tempo,"/",sep="")

    readres<-readRDS(paste(resloc,"ricker_SG_spear.RDS",sep=""))
    Plotter_Cause4copula_stat(res=readres)
    readres<-readRDS(paste(resloc,"ricker_SG_kend.RDS",sep=""))
    Plotter_Cause4copula_stat(res=readres)

  }
 }
}
```

<!--Plots for stochastic ricker with weak noise (Survival Gumbel copula)  : nsd=0.1-->
<!--Removed from AER version
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, stochastic Ricker 
model, weak noise, survival Gumbel copula.]{Comparison of copula structure of noise inputs and model 
outputs, stochastic Ricker model, weak noise, survival Gumbel copula. Same format as Figs 
\ref{fig_Cause4copula_C_kend_ar1} and \ref{MT-fig_Cause4copula_scatter_C_kend_ar1}, 
see captions of those figures for details. \label{fig_Cause4copula_SG_kend_sRicker_nsd_0.1}}
\end{center}
\end{figure}
-->

<!--Plots for stochastic ricker with strong noise (Survival Gumbel copula): nsd=1-->
<!--Removed from AER version
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Gumbel/Survival Gumbel_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, stochastic Ricker 
model, strong noise, survival Gumbel copula.]{Comparison of copula structure of noise inputs and model 
outputs, stochastic Ricker model, strong noise, survival Gumbel copula. Same format as Figs 
\ref{fig_Cause4copula_C_kend_ar1} and \ref{MT-fig_Cause4copula_scatter_C_kend_ar1}, 
see captions of those figures for details. \label{fig_Cause4copula_SG_kend_sRicker_nsd_1}}
\end{center}
\end{figure}
-->

<!--Following two chunks examine Moran-like mechanism with joe copula noises in Ricker model and 
then generate plots with the simulated results-->
```{r cause4copula_stat_ricker_joe, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
tag_ricker_J<-"999J" #this is a caching tag used later to cache output from present chunk

# This chunk stores results for ar1 model : joe

model<-"ricker"
fcode<-6
nsdlist<-c(0.1,1)
Klist<-c(100)
# for varying r (@r=1 transition from under- to over-compensatory dynamics )
rlist<-seq(from=0.1,to=1.3,by=0.2)

for(insd in nsdlist){
  for(iK in Klist){
   for(i in rlist){
    params<-c(i,iK) # this parameter is a vector with r and K
    p0<-c(params[2],params[2])

    resloc<-"./Results/Cause4copula_results/"

    tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_nsd_",insd,"_r_",params[1],"_K_",params[2],"_",BiCopName(fcode,short=F),sep="")

    if (!dir.exists(tempo)){
      dir.create(tempo)
    }
    resloc<-paste(tempo,"/",sep="")

  # for joe with spearman and kendall method
    
    myres<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=insd,method="kendall",lb=0,ub=0.1,
                                          num_keep_last=500,resloc=resloc,
                                          params=params,p0=p0,model=model)

    saveRDS(myres,paste(resloc,"ricker_J_kend.RDS",sep=""))
  }
 }
}
```

```{r plot_cause4copula_stat_ricker_J, echo=F, results="hide",cache=T, cache.extra=list(seed,tag_ricker_J,mtime("Plotter_Cause4copula.R"))}

set.seed(seed)
source("Plotter_Cause4copula_stat.R")
#---------------------------------------

model<-"ricker"
fcode<-6
resloc0<-"./Results/Cause4copula_results/"

nsdlist<-c(0.1,1)
Klist<-c(100)

# for varying r (@r=1 transition from under- to over-compensatory dynamics )
rlist<-seq(from=0.1,to=1.3,by=0.2)

for(insd in nsdlist){
  for(iK in Klist){
   for(i in rlist){
    params<-c(i,iK) # this parameter is a vector with r and K
    p0<-c(params[2],params[2])

    resloc<-"./Results/Cause4copula_results/"

    tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_nsd_",insd,"_r_",params[1],"_K_",params[2],"_",BiCopName(fcode,short=F),sep="")
    
    resloc<-paste(tempo,"/",sep="")

    readres<-readRDS(paste(resloc,"ricker_J_kend.RDS",sep=""))
    Plotter_Cause4copula_stat(res=readres)

  }
 }
}
```

<!--Plots for stochastic ricker with weak noise (Joe copula) : nsd=0.1-->
<!--Removed from AER version
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Joe/Joe_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, stochastic Ricker 
model, weak noise, Joe copula.]{Comparison of copula structure of noise inputs and model 
outputs, stochastic Ricker model, weak noise, Joe copula. Same format as Figs 
\ref{fig_Cause4copula_C_kend_ar1} and \ref{MT-fig_Cause4copula_scatter_C_kend_ar1}, 
see captions of those figures for details.\label{fig_Cause4copula_J_kend_sRicker_nsd_0.1}}
\end{center}
\end{figure}
-->

<!--Plots for stochastic ricker with strong noise (Joe copula) : nsd=1-->
<!--Removed from AER version
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Joe/Joe_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, stochastic Ricker 
model, strong noise, Joe copula.]{Comparison of copula structure of noise inputs and model 
outputs, stochastic Ricker model, strong noise, Joe copula. Same format as Figs 
\ref{fig_Cause4copula_C_kend_ar1} and \ref{MT-fig_Cause4copula_scatter_C_kend_ar1}, 
see captions of those figures for details.\label{fig_Cause4copula_J_kend_sRicker_nsd_1}}
\end{center}
\end{figure}
-->

<!--Following two chunks examine Moran-like mechanism with survival joe copula noises in Ricker model and 
then generate plots with the simulated results-->
```{r cause4copula_stat_ricker_survivaljoe, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("Cause4copula.R"),mtime("CopulaFunctions_flexible.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}
source("Cause4copula.R")
#-----------------
set.seed(seed)
#---------------------------------------
tag_ricker_SJ<-"999SJ" #this is a caching tag used later to cache output from present chunk

# This chunk stores results for ar1 model : survival joe

model<-"ricker"
fcode<-16
nsdlist<-c(0.1,1)
Klist<-c(100)
# for varying r (@r=1 transition from under- to over-compensatory dynamics )
rlist<-seq(from=0.1,to=1.3,by=0.2)

for(insd in nsdlist){
  for(iK in Klist){
   for(i in rlist){
    params<-c(i,iK) # this parameter is a vector with r and K
    p0<-c(params[2],params[2])

    resloc<-"./Results/Cause4copula_results/"

    tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_nsd_",insd,"_r_",params[1],"_K_",params[2],"_",BiCopName(fcode,short=F),sep="")

    if (!dir.exists(tempo)){
      dir.create(tempo)
    }
    resloc<-paste(tempo,"/",sep="")

  # for survival joe with spearman and kendall method
    
    myres<-Sim_Cause4copula_stat(N=5000,numsim=50,fcode=fcode,nsd=insd,method="kendall",lb=0,ub=0.1,
                                          num_keep_last=500,resloc=resloc,
                                          params=params,p0=p0,model=model)

    saveRDS(myres,paste(resloc,"ricker_SJ_kend.RDS",sep=""))
  }
 }
}
```

```{r plot_cause4copula_stat_ricker_SJ, echo=F, results="hide",cache=T, cache.extra=list(seed,tag_ricker_SJ,mtime("Plotter_Cause4copula.R"))}

set.seed(seed)
source("Plotter_Cause4copula_stat.R")
#---------------------------------------

model<-"ricker"
fcode<-16
resloc0<-"./Results/Cause4copula_results/"

nsdlist<-c(0.1,1)
Klist<-c(100)

# for varying r (@r=1 transition from under- to over-compensatory dynamics )
rlist<-seq(from=0.1,to=1.3,by=0.2)

for(insd in nsdlist){
  for(iK in Klist){
   for(i in rlist){
    params<-c(i,iK) # this parameter is a vector with r and K
    p0<-c(params[2],params[2])

    resloc<-"./Results/Cause4copula_results/"

    tempo<-paste(resloc,"Cause4copula_stat_results_",model,"_nsd_",insd,"_r_",params[1],"_K_",params[2],"_",BiCopName(fcode,short=F),sep="")
    
    resloc<-paste(tempo,"/",sep="")

    readres<-readRDS(paste(resloc,"ricker_SJ_kend.RDS",sep=""))
    Plotter_Cause4copula_stat(res=readres)

  }
 }
}
```

<!--Plots for stochastic ricker with weak noise (Survival Joe): nsd=0.1-->
<!--Removed from AER version
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_0.1_r_0.5_K_100_Survival Joe/Survival Joe_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, stochastic Ricker 
model, weak noise, survival Joe  copula.]{Comparison of copula structure of noise inputs and model 
outputs, stochastic Ricker model, weak noise, survival Joe  copula. Same format as Figs 
\ref{fig_Cause4copula_C_kend_ar1} and \ref{MT-fig_Cause4copula_scatter_C_kend_ar1}, 
see captions of those figures for details.\label{fig_Cause4copula_SJ_kend_sRicker_nsd_0.1}}
\end{center}
\end{figure}
-->

<!--Plots for stochastic ricker with strong noise (Survival Joe): nsd=1-->
<!--Removed from AER version
\begin{figure}[!h]
\begin{center}
\includegraphics[width=13 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/common_legend_cause4copula_stat.pdf}\\
\vspace{-0.4 cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_Spearman_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_Kendall_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_Pearson_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_Corl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_Coru_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_Corl-Coru_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_Pl_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_Pu_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_Pl-Pu_vs_Kendall's Tau.pdf}\\
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_D2u_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_D2l_vs_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_D2u-D2l_vs_Kendall's Tau.pdf}\\
\hspace{-0.8cm}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_scatter_CorlmCoru_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_scatter_PlmPu_Kendall's Tau.pdf}
\includegraphics[width=5 cm]{./Results/Cause4copula_results/Cause4copula_stat_results_ricker_nsd_1_r_0.5_K_100_Survival Joe/Survival Joe_scatter_D2umD2l_Kendall's Tau.pdf}
\caption[Comparison of copula structure of noise and model output, stochastic Ricker 
model, strong noise, survival Joe  copula.]{Comparison of copula structure of noise inputs and model 
outputs, stochastic Ricker model, strong noise, survival Joe copula. Same format as Figs 
\ref{fig_Cause4copula_C_kend_ar1} and \ref{MT-fig_Cause4copula_scatter_C_kend_ar1}, 
see captions of those figures for details.\label{fig_Cause4copula_SJ_kend_sRicker_nsd_1}}
\end{center}
\end{figure}
-->

<!--Following chunk is to examine the hypothesis for third probable mechanism : 
asymmetric tail dependence in evolutionary changes in bivariate characters can give
rise to similarly asymmetric tail dependence in character distributions across phylogeny tips-->
```{r mechanism_evo_cop, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("explore_evo_cop.R"),mtime("CopulaFunctions_flexible.R"))}
set.seed(seed)

source("explore_evo_cop.R")
```

<!--Following chunk examine the consequence of non-normal copula atructure on skewness using green spruce aphid abundance data-->
```{r skewness_count_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_aphid_count,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

# Only done for "Spearman" method

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

numsurrog<-10000
loclist<-good_loclist(d_allsp=data_aphid_count,sp=10,data_pt_thrs=30)

#pdf("./Results/skewness_results/skewness_aphid_count/skewness_aphid_count_sp_10_kendall.pdf",height=6,width=8)
#op<-par(mar=c(5,5,1.8,0.1), mgp=c(3, 1, 0))
#answer1k<-skewness_testing(ts_matrix=sp_data(sp=10,d_allsp=data_aphid_count),loclist=loclist,numsurrog=numsurrog,ploton=T,
#                          corpres="kendall") 
#p_left<-sum(answer1k$surrogskw < answer1k$realskw)/numsurrog
#mtext(paste0("p = ",p_left),side=3,line=-0.5,cex = 2)
#par(op)
#dev.off()

pdf("./Results/skewness_results/skewness_aphid_count/skewness_aphid_count_sp_10_spearman.pdf",height=5,width=5)
op<-par(mar=c(4,5,1,1),mgp=c(3,1,0))
#op<-par(mar=c(5,5,1.8,0.1), mgp=c(3, 1, 0))
answer1s<-skewness_testing(ts_matrix=sp_data(sp=10,d_allsp=data_aphid_count),loclist=loclist,numsurrog=numsurrog,ploton=F,
                          corpres="spearman") 
hist(answer1s$surrogskw,breaks=100,main="",xlab="Skewness",ylab="Frequency",cex.lab=2,cex.axis=2,col="grey",border=F)
#abline(v=realskw,col="red")
points(x=answer1s$realskw,y=0,col="black",pch=15,cex=2)

p_left<-sum(answer1s$surrogskw < answer1s$realskw)/numsurrog
mtext(paste0("p = ",p_left),side=3,line=-0.5,cex = 2)
par(op)
dev.off()
```

<!--Following chunk examine the consequence of non-normal copula atructure on skewness 
using leaf plum curling aphids' first flight data-->
```{r skewness_ff_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_aphid_ff,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

# Only done for "Spearman" method

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

numsurrog<-10000
loclist<-good_loclist(d_allsp=data_aphid_ff,sp=11,data_pt_thrs=30)


#pdf("./Results/skewness_results/skewness_aphid_ff/skewness_aphid_ff_sp_11_kendall.pdf",height=6,width=8)
#op<-par(mar=c(5,5,1.8,0.1), mgp=c(3, 1, 0))
#answer2k<-skewness_testing(ts_matrix=sp_data(sp=11,d_allsp=data_aphid_ff),loclist=loclist,numsurrog=numsurrog,ploton=T,
#                          corpres="kendall") 
#p_right<-sum(answer2k$surrogskw > answer2k$realskw)/numsurrog
#mtext(paste0("p = ",p_right),side=3,line=-0.5,cex = 2)
#par(op)
#dev.off()

pdf("./Results/skewness_results/skewness_aphid_ff/skewness_aphid_ff_sp_11_spearman.pdf",height=5,width=5)
op<-par(mar=c(4,5,1,1),mgp=c(3,1,0))
answer2s<-skewness_testing(ts_matrix=sp_data(sp=11,d_allsp=data_aphid_ff),loclist=loclist,numsurrog=numsurrog,ploton=F,
                          corpres="spearman")
hist(answer2s$surrogskw,breaks=100,main="",xlab="Skewness",ylab="Frequency",cex.lab=2,cex.axis=2,col="grey",border=F)
#abline(v=realskw,col="red")
points(x=answer2s$realskw,y=0,col="black",pch=15,cex=2)

p_right<-sum(answer2s$surrogskw > answer2s$realskw)/numsurrog
mtext(paste0("p = ",p_right),side=3,line=-0.5,cex = 2)
par(op)
dev.off()
```

<!--Following chunk examine the consequence of non-normal copula atructure on skewness 
using ceratium furca's abundance data-->
```{r skewness_pns_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,data_plankton_north_sea,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

# Only done for "Spearman" method

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

numsurrog<-10000
loclist<-good_loclist(d_allsp=data_plankton_north_sea,sp=16,data_pt_thrs=45)

#pdf("./Results/skewness_results/skewness_plankton_north_sea/skewness_plankton_north_sea_sp_16_kendall.pdf",height=6,width=8)
#op<-par(mar=c(5,5,1.8,0.1), mgp=c(3, 1, 0))
#answer3k<-skewness_testing(ts_matrix=sp_data(sp=16,d_allsp=data_plankton_north_sea),loclist=loclist,numsurrog=numsurrog,ploton=T,
#                          corpres="kendall") 
#p_left<-sum(answer3k$surrogskw < answer3k$realskw)/numsurrog
#mtext(paste0("p = ",p_left),side=3,line=-0.5,cex = 2)
#par(op)
#dev.off()

pdf("./Results/skewness_results/skewness_plankton_north_sea/skewness_plankton_north_sea_sp_16_spearman.pdf",height=5,width=5)
op<-par(mar=c(4,5,1,1),mgp=c(3,1,0))
answer3s<-skewness_testing(ts_matrix=sp_data(sp=16,d_allsp=data_plankton_north_sea),loclist=loclist,numsurrog=numsurrog,ploton=F,
                          corpres="spearman") 
hist(answer3s$surrogskw,breaks=100,main="",xlab="Skewness",ylab="Frequency",cex.lab=2,cex.axis=2,col="grey",border=F)
#abline(v=realskw,col="red")
points(x=answer3s$realskw,y=0,col="black",pch=15,cex=2)

p_left<-sum(answer3s$surrogskw < answer3s$realskw)/numsurrog
mtext(paste0("p = ",p_left),side=3,line=-0.5,cex = 2)
par(op)
dev.off()
```

<!--Following chunk examine the consequence of non-normal copula atructure on skewness using methane-flux data-->
```{r skewness_methane_plot, results='hide', echo=F, cache=T, cache.extra=list(seed,methane_data,mtime("good_loclist.R"),mtime("skewness_multivar_dataset.R"),mtime("ncsurrog.R"),mtime("SkewnessAnd3CentMom.R"))}

# Only done for "Spearman" method

source("good_loclist.R")
source("skewness_multivar_dataset.R")
set.seed(seed)

numsurrog<-10000
loclist<-good_loclist(d_allsp=methane_data,sp=1,data_pt_thrs=50)

#pdf("./Results/skewness_results/skewness_methane/skewness_methane_kendall.pdf",height=6,width=8)
#op<-par(mar=c(5,5,1.8,0.1), mgp=c(3, 1, 0))
#answer1k<-skewness_testing(ts_matrix=sp_data(sp=1,d_allsp=methane_data),loclist=loclist,numsurrog=numsurrog,ploton=T,
#                           corpres="kendall") 
#p_left<-sum(answer1k$surrogskw < answer1k$realskw)/numsurrog
#mtext(paste0("p = ",p_left),side=3,line=-0.5,cex = 2)
#par(op)
#dev.off()

pdf("./Results/skewness_results/skewness_methane/skewness_methane_spearman.pdf",height=5,width=5)
op<-par(mar=c(4,5,1,1),mgp=c(3,1,0))
answer1s<-skewness_testing(ts_matrix=sp_data(sp=1,d_allsp=methane_data),loclist=loclist,numsurrog=numsurrog,ploton=F,
                           corpres="spearman") 
hist(answer1s$surrogskw,breaks=100,main="",xlab="Skewness",ylab="Frequency",cex.lab=2,cex.axis=2,col="grey",border=F)
#abline(v=realskw,col="red")
points(x=answer1s$realskw,y=0,col="black",pch=15,cex=2)

p_left<-sum(answer1s$surrogskw < answer1s$realskw)/numsurrog
mtext(paste0("p = ",p_left),side=3,line=-0.5,cex = 2)
par(op)
dev.off()
```


<!--Following 4 chunks are examining consequence of non-normal copula structure on Taylors law using made up data-->

<!--first, make surrogate datasets for TL analysis to follow-->
```{r taylors_law_make_surrogs, echo=F, cache=T, cache.extra=list(seed,mtime("copsurrognd.R"))}
source("copsurrognd.R")
set.seed(seed)

#***constants
N<-50 #length of time series
n<-25 #number of sampling locations
#numdat<-10 #the number of datasets to get from the normal copula
numdat<-1000 #the number of datasets to get from the normal copula
rho<-0.7 #normal-copula parameter for dependence between locations
          #this is a covariance, see below call to rmvnorm

#***generate the starting data, which has normal copula structure
#because it comes originally from a multivariate normal, before 
#transformation
sig<-matrix(rho,n,n)
diag(sig)<-1
m<-rmvnorm(N*numdat,mean=rep(0,n),sigma=sig) # each column of m has normal histogram
m<-array(m,c(N,numdat,n))
m<-aperm(m,c(1,3,2)) # 2nd dim is normally distributed e.g. hist(m[,1,])
gshape<-7.5
gscale<-1 #gamma parameters

cop_to_marg_trans<-function(x){
  return(qgamma(x,shape=gshape,scale=gscale)) #this is where we choose the marginals,
                                  #should be something skewed
}

marg_to_cop_trans<-function(x){ #transforms to copula space
  return(pgamma(x,shape=gshape,scale=gscale))
}

# pnorm(m) makes normal to uniform
# then qgamma(...) makes uniform to gamma distributed
m<-cop_to_marg_trans(pnorm(m))

#***surrogates using a Clayton copula, kendall preserving

#get the Clayton parameter to use
ncop<-normalCopula(rho,2)
ccop<-claytonCopula(2,2)
cparam<-iTau(ccop,tau(ncop))
ccop<-claytonCopula(cparam,n)

#generate the surrogates
csurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3]){
  csurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=ccop,numsurrog=1)
}

# #test to see whether kendalls are similar between m and csurrog - 
#only works at all as a test if N is large (I used 1000)
# cor(m[,1,1],m[,2,1],method='kendall')
# cor(csurrog[,1,1],csurrog[,2,1],method='kendall')
# cor(m[,3,1],m[,4,1],method='kendall')
# cor(csurrog[,3,1],csurrog[,4,1],method='kendall')
# cor(m[,5,1],m[,6,1],method='kendall')
# cor(csurrog[,5,1],csurrog[,6,1],method='kendall')
# 
# cor(m[,1,2],m[,2,2],method='kendall')
# cor(csurrog[,1,2],csurrog[,2,2],method='kendall')
# cor(m[,3,2],m[,4,2],method='kendall')
# cor(csurrog[,3,2],csurrog[,4,2],method='kendall')
# cor(m[,5,2],m[,6,2],method='kendall')
# cor(csurrog[,5,2],csurrog[,6,2],method='kendall')

#***surrogates using a Frank copula, kendall preserving
#get the Frank parameter to use
fcop<-frankCopula(4,2)
fparam<-iTau(fcop,tau(ncop))
fcop<-frankCopula(fparam,n)

#generate the surrogates
fsurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3]){
  fsurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=fcop,numsurrog=1)
}

#***surrogates using a survival Clayton, kendall preserving
#take the clayton surrogates and transform them to the 
#copula space, then flip, then transform back
scsurrog<-cop_to_marg_trans((1-marg_to_cop_trans(csurrog)))

# check : plot(csurrog[,1,1],csurrog[,2,1]) and plot(scsurrog[,1,1],scsurrog[,2,1])

# #test: should have identical taus as csurrog
# cor(csurrog[,1,1],csurrog[,2,1],meth='kendall')
# cor(scsurrog[,1,1],scsurrog[,2,1],meth='kendall')
# cor(csurrog[,1,2],csurrog[,2,2],meth='kendall')
# cor(scsurrog[,1,2],scsurrog[,2,2],meth='kendall')

kend.surrog<-list(cla=csurrog,nor=m,fra=fsurrog,scl=scsurrog)

#***surrogates using a Clayton copula, spearman preserving
#get the Clayton parameter to use
ccop<-claytonCopula(2,2)
cparam<-iRho(ccop,rho(ncop))
ccop<-claytonCopula(cparam,n)

#generate the surrogates
csurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3]){
  csurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=ccop,numsurrog=1)
}

#***surrogates using a Frank copula, spearman preserving
#get the Frank parameter to use
fcop<-frankCopula(4,2)
fparam<-iRho(fcop,rho(ncop))
fcop<-frankCopula(fparam,n)

#generate the surrogates
fsurrog<-array(NA,dim(m))
for (counter in 1:dim(m)[3]){
  fsurrog[,,counter]<-copsurrognd(m[,,counter],targetcop=fcop,numsurrog=1)
}

#***surrogates using a survival Clayton, spearman preserving
#take the clayton surrogates and transform them to the 
#copula space, then flip, then transform back
scsurrog<-cop_to_marg_trans((1-marg_to_cop_trans(csurrog)))

spea.surrog<-list(cla=csurrog,nor=m,fra=fsurrog,scl=scsurrog)
```

<!--second, do a TL analysis on the data just created-->
```{r tl_analysis, echo=F, cache=T, cache.extra=list(kend.surrog,spea.surrog,mtime("mncurvat.R"),mtime("TaylorsLawTools.R"),seed,mtime("copsurrognd.R"))}
source("copsurrognd.R")
source("TaylorsLawTools.R")
 
#We are only doing spatial taylor's law because we know a priori temporal
#won't give anything interesting for the surrogates we use

kend.stats.res<-list()
kend.points.res<-list()
spea.stats.res<-list()
spea.points.res<-list()
for (counter in 1:length(kend.surrog)){
 ks<-kend.surrog[[counter]]
 ss<-spea.surrog[[counter]]
 kend.stats.res[[counter]]<-matrix(NA,7,numdat) # to keep spatial TL stats
 spea.stats.res[[counter]]<-matrix(NA,7,numdat)
 kend.points.res[[counter]]<-array(NA,c(N,2,numdat)) # to keep log(mu), log(var) of spatial TL as a dataframe
 spea.points.res[[counter]]<-array(NA,c(N,2,numdat))
 for (sc in 1:numdat){
   khold<-tl_stats(ks[,,sc])
   kend.stats.res[[counter]][,sc]<-khold$s.stats #spatial TL only
   rownames(kend.stats.res[[counter]])<-names(khold$s.stats)
   kend.points.res[[counter]][,,sc]<-as.matrix(khold$s.points)
 
   shold<-tl_stats(ss[,,sc])
   spea.stats.res[[counter]][,sc]<-shold$s.stats #spatial TL only
   rownames(spea.stats.res[[counter]])<-names(shold$s.stats)
   spea.points.res[[counter]][,,sc]<-as.matrix(shold$s.points)
 }
}
names(kend.stats.res)<-names(kend.surrog)
names(kend.points.res)<-names(kend.surrog)
names(spea.stats.res)<-names(spea.surrog)
names(spea.points.res)<-names(spea.surrog)
```

<!--third, now make some plots, these one for kendall surrogates-->
```{r taylor_plots_kendall, echo=F, results="hide"}
xlimits<-range(kend.points.res[[1]][,1,],kend.points.res[[2]][,1,],kend.points.res[[3]][,1,],kend.points.res[[4]][,1,])
ylimits<-range(kend.points.res[[1]][,2,],kend.points.res[[2]][,2,],kend.points.res[[3]][,2,],kend.points.res[[4]][,2,])

#pdf("./Results/taylorslaw_results/SpatialTL_CNFSC_kendall.pdf",height=4,width=16)
png("./Results/taylorslaw_results/SpatialTL_CNFSC_kendall.png",width=16,height=4,units="in",res=400)
op<-op<-par(mfrow=c(1,4),mar=c(4,5,1,1),mgp=c(3,1,0))
##plot TL for clayton
plot(kend.points.res[[1]][,1,],kend.points.res[[1]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(kend.points.res[[1]][,1,1],kend.points.res[[1]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[1]][,1,2],kend.points.res[[1]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Clayton"),side = 3, line=-2, adj=0.1, col="black")

##plot TL for normal copula
plot(kend.points.res[[2]][,1,],kend.points.res[[2]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(kend.points.res[[2]][,1,1],kend.points.res[[2]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[2]][,1,2],kend.points.res[[2]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Normal"),side = 3, line=-2, adj=0.1, col="black")

#plot TL for frank
plot(kend.points.res[[3]][,1,],kend.points.res[[3]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(kend.points.res[[3]][,1,1],kend.points.res[[3]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[3]][,1,2],kend.points.res[[3]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Frank"),side = 3, line=-2, adj=0.1, col="black")

#plot TL for survival clayton
plot(kend.points.res[[4]][,1,],kend.points.res[[4]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(kend.points.res[[4]][,1,1],kend.points.res[[4]][,2,1],type='p',pch=20,cex=.75,col='red')
points(kend.points.res[[4]][,1,2],kend.points.res[[4]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Survival Clayton"),side=3, line=-2, adj=0.1, col="black")

par(op)
dev.off()
#---------------------------------------------------
#prepare for plots coming below
s.lin<-cbind(kend.stats.res[[1]][1,],kend.stats.res[[2]][1,],kend.stats.res[[3]][1,],kend.stats.res[[4]][1,])
s.hom<-cbind(kend.stats.res[[1]][2,],kend.stats.res[[2]][2,],kend.stats.res[[3]][2,],kend.stats.res[[4]][2,])
s.rmse<-cbind(kend.stats.res[[1]][3,],kend.stats.res[[2]][3,],kend.stats.res[[3]][3,],kend.stats.res[[4]][3,])
s.int<-cbind(kend.stats.res[[1]][4,],kend.stats.res[[2]][4,],kend.stats.res[[3]][4,],kend.stats.res[[4]][4,])
s.slope<-cbind(kend.stats.res[[1]][5,],kend.stats.res[[2]][5,],kend.stats.res[[3]][5,],kend.stats.res[[4]][5,])
s.quadcoeff<-cbind(kend.stats.res[[1]][6,],kend.stats.res[[2]][6,],kend.stats.res[[3]][6,],kend.stats.res[[4]][6,])
s.mncurv<-cbind(kend.stats.res[[1]][7,],kend.stats.res[[2]][7,],kend.stats.res[[3]][7,],kend.stats.res[[4]][7,])

pdf("./Results/taylorslaw_results/SpatialTL_7stats_kendall.pdf",height=3,width=21)
op<-par(mfrow=c(1,7),mar=c(4.2,5,1,1),mgp=c(3,1,0))
#***DAN: x axis needs to be redone to show the copula names used in the surrogates

#x<-1:4
x2<-c("C", "N", "F", "SC")
#plot(x,s.lin[1,],type="l",col="grey",ylim=range(s.lin),xlab="Set of surrogates",ylab="Linearity test p-vals",
#     cex.axis=1.5,cex.lab=1.5,xaxt="n")
#points(x,s.lin[1,],col="red")
#axis(1, at = c(1:4), x2, cex.axis=1.5)
#for (counter in 2:dim(s.lin)[1]){
#  lines(x,s.lin[counter,],col="grey")
#  points(x,s.lin[counter,],col="red")
#}
boxplot(s.lin , col=rainbow(4), xlab="Copula family", ylab="Linearity test p-vals", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.hom distr for each set of surrogates
boxplot(s.hom , col=rainbow(4), xlab="Copula family", ylab="Homoskedasticity test p-vals", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.rmse distr for each set of surrogates
boxplot(s.rmse , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL rmse", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.int distr for each set of surrogates
boxplot(s.int , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL intercept", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.slope distr for each set of surrogates
boxplot(s.slope , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL slope", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.quadcoeff distr for each set of surrogates
boxplot(s.quadcoeff , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL quadratic coefficient", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.mncurv distr for each set of surrogates
boxplot(s.mncurv , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL mean curvature", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

par(op)
dev.off()
```

<!--fourth, now make some plots, these one for spearman surrogates-->
```{r taylor_plots_spearman, echo=F, results="hide"}
xlimits<-range(spea.points.res[[1]][,1,],spea.points.res[[2]][,1,],spea.points.res[[3]][,1,],spea.points.res[[4]][,1,])
ylimits<-range(spea.points.res[[1]][,2,],spea.points.res[[2]][,2,],spea.points.res[[3]][,2,],spea.points.res[[4]][,2,])

#pdf("./Results/taylorslaw_results/SpatialTL_CNFSC_spearman.pdf",height=4,width=16)
png("./Results/taylorslaw_results/SpatialTL_CNFSC_spearman.png",height=4,width=16,units="in",res=400)
op<-op<-par(mfrow=c(1,4),mar=c(4,5,1,1),mgp=c(3,1,0))
##plot TL for clayton
plot(spea.points.res[[1]][,1,],spea.points.res[[1]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(spea.points.res[[1]][,1,1],spea.points.res[[1]][,2,1],type='p',pch=20,cex=.75,col='red')
points(spea.points.res[[1]][,1,2],spea.points.res[[1]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Clayton"),side = 3, line=-2, adj=0.1, col="black")

##plot TL for normal copula
plot(spea.points.res[[2]][,1,],spea.points.res[[2]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(spea.points.res[[2]][,1,1],spea.points.res[[2]][,2,1],type='p',pch=20,cex=.75,col='red')
points(spea.points.res[[2]][,1,2],spea.points.res[[2]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Normal"),side = 3, line=-2, adj=0.1, col="black")

#plot TL for frank
plot(spea.points.res[[3]][,1,],spea.points.res[[3]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(spea.points.res[[3]][,1,1],spea.points.res[[3]][,2,1],type='p',pch=20,cex=.75,col='red')
points(spea.points.res[[3]][,1,2],spea.points.res[[3]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Frank"),side = 3, line=-2, adj=0.1, col="black")

#plot TL for survival clayton
plot(spea.points.res[[4]][,1,],spea.points.res[[4]][,2,],type='p',pch=20,cex=.75,xlim=xlimits,ylim=ylimits,
     xlab=expression(log[10]("spatial mean")),ylab=expression(log[10]("spatial variance")),
     cex.axis=1.5,cex.lab=1.5)  
points(spea.points.res[[4]][,1,1],spea.points.res[[4]][,2,1],type='p',pch=20,cex=.75,col='red')
points(spea.points.res[[4]][,1,2],spea.points.res[[4]][,2,2],type='p',pch=20,cex=.75,col='green')
mtext(paste("Survival Clayton"),side=3, line=-2, adj=0.1, col="black")

par(op)
dev.off()
#---------------------------------------------------
#prepare for plots coming below
s.lin<-cbind(spea.stats.res[[1]][1,],spea.stats.res[[2]][1,],spea.stats.res[[3]][1,],spea.stats.res[[4]][1,])
s.hom<-cbind(spea.stats.res[[1]][2,],spea.stats.res[[2]][2,],spea.stats.res[[3]][2,],spea.stats.res[[4]][2,])
s.rmse<-cbind(spea.stats.res[[1]][3,],spea.stats.res[[2]][3,],spea.stats.res[[3]][3,],spea.stats.res[[4]][3,])
s.int<-cbind(spea.stats.res[[1]][4,],spea.stats.res[[2]][4,],spea.stats.res[[3]][4,],spea.stats.res[[4]][4,])
s.slope<-cbind(spea.stats.res[[1]][5,],spea.stats.res[[2]][5,],spea.stats.res[[3]][5,],spea.stats.res[[4]][5,])
s.quadcoeff<-cbind(spea.stats.res[[1]][6,],spea.stats.res[[2]][6,],spea.stats.res[[3]][6,],spea.stats.res[[4]][6,])
s.mncurv<-cbind(spea.stats.res[[1]][7,],spea.stats.res[[2]][7,],spea.stats.res[[3]][7,],spea.stats.res[[4]][7,])

pdf("./Results/taylorslaw_results/SpatialTL_7stats_spearman.pdf",height=3,width=21)
op<-par(mfrow=c(1,7),mar=c(4.2,5,1,1),mgp=c(3,1,0))
x2<-c("C", "N", "F", "SC")

#plot s.lin distr for each set of surrogates
boxplot(s.lin , col=rainbow(4), xlab="Copula family", ylab="Linearity test p-vals", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.hom distr for each set of surrogates
boxplot(s.hom , col=rainbow(4), xlab="Copula family", ylab="Homoskedasticity test p-vals", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.rmse distr for each set of surrogates
boxplot(s.rmse , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL rmse", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.int distr for each set of surrogates
boxplot(s.int , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL intercept", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.slope distr for each set of surrogates
boxplot(s.slope , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL slope", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.quadcoeff distr for each set of surrogates
boxplot(s.quadcoeff , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL quadratic coefficient", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

#plot s.mncurv distr for each set of surrogates
boxplot(s.mncurv , col=rainbow(4) , xlab="Copula family", ylab="Spatial TL mean curvature", cex.axis=1.5,cex.lab=1.5,xaxt="n")
axis(1, at = c(1:4), x2, cex.axis=1.5)

par(op)
dev.off()
```

<!--Following 2 chunks examine the effect of non-normal asymmetric copula on extinction risk-->
```{r sim_ext_risk, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}

source("mydispersal.R")
set.seed(seed)

model<-"lcohen"
numsims<-10000
numsteps<-25
params<-0
ext_thrs<-1
scl<-1
p0<-50

sl5<-varying_d(numsims=numsims,numsteps =numsteps,numlocs=5,p0=p0,params=params,
                 ext_thrs=ext_thrs,scl=scl,model=model,disp_everywhere=F,ploton=F)
saveRDS(sl5,"./Results/ext_risk_copula/ext_risk_local_lcohen_numlocs5.RDS")

sl25<-varying_d(numsims=numsims,numsteps =numsteps,numlocs=25,p0=p0,params=params,
                 ext_thrs=ext_thrs,scl=scl,model=model,disp_everywhere=F,ploton=F)
saveRDS(sl25,"./Results/ext_risk_copula/ext_risk_local_lcohen_numlocs25.RDS")

sg5<-varying_d(numsims=numsims,numsteps =numsteps,numlocs=5,p0=p0,params=params,
                 ext_thrs=ext_thrs,scl=scl,model=model,disp_everywhere=T,ploton=F)
saveRDS(sg5,"./Results/ext_risk_copula/ext_risk_global_lcohen_numlocs5.RDS")

sg25<-varying_d(numsims=numsims,numsteps =numsteps,numlocs=25,p0=p0,params=params,
                 ext_thrs=ext_thrs,scl=scl,model=model,disp_everywhere=T,ploton=F)
saveRDS(sg25,"./Results/ext_risk_copula/ext_risk_global_lcohen_numlocs25.RDS")
```

```{r fig_ext_risk, echo=F,  results="hide", cache=T, cache.extra=list(seed,sl5,sl25,sg5,sg25)}
sl5<-readRDS("./Results/ext_risk_copula/ext_risk_local_lcohen_numlocs5.RDS")
sl25<-readRDS("./Results/ext_risk_copula/ext_risk_local_lcohen_numlocs25.RDS")
sg5<-readRDS("./Results/ext_risk_copula/ext_risk_global_lcohen_numlocs5.RDS")
sg25<-readRDS("./Results/ext_risk_copula/ext_risk_global_lcohen_numlocs25.RDS")

# plot for local dispersal in D matrix 
pdf("./Results/ext_risk_copula/lcohen_ext_risk_local_disp.pdf",heigh=5,width=10)
op<-par(mfrow=c(1,2),mar=c(5,5,1.8,1),mgp=c(3,1,0))
plot(sl5$d_seq[1:6],sl5$risk_left[1:6],xlim=c(0,0.5),ylim=c(0,1),type="b",col="black",
     xlab="d",ylab="Extinction risk",
     cex.lab=2,cex.axis=1.8,cex=1.5,pch=16,lwd=1.5)
lines(sl5$d_seq[1:6],sl5$risk_right[1:6],type="b",lwd=1.5,cex=1.5,pch=16,col="grey")
legend(x=0.05,y=0.9, title=paste0("r = 0 , N = 5"), c("Left tail-dep. in noise","Right tail-dep. in noise"), 
       pch=c(16,16), lty=c(1,1), cex=1.4, pt.cex=c(1.5,1.5), col=c("black","grey"),
       horiz=F, bty='n') 

plot(sl25$d_seq[1:6],sl25$risk_left[1:6],xlim=c(0,0.5),ylim=c(0,1),type="b",col="black",
     xlab="d",ylab="Extinction risk",
     cex.lab=2,cex.axis=1.8,cex=1.5,pch=16,lwd=1.5)
lines(sl25$d_seq[1:6],sl25$risk_right[1:6],type="b",lwd=1.5,cex=1.5,pch=16,col="grey")
legend(x=0.05,y=0.9, title=paste0("r = 0 , N = 25"), c("Left tail-dep. in noise","Right tail-dep. in noise"), 
       pch=c(16,16), lty=c(1,1), cex=1.4, pt.cex=c(1.5,1.5), col=c("black","grey"),
       horiz=F, bty='n') 

par(op)
dev.off()


# plot for global dispersal in D matrix 
pdf("./Results/ext_risk_copula/lcohen_ext_risk_global_disp.pdf",heigh=5,width=10)
op<-par(mfrow=c(1,2),mar=c(5,5,1.8,1),mgp=c(3,1,0))
plot(sg5$d_seq[1:6],sg5$risk_left[1:6],xlim=c(0,0.5),ylim=c(0,1),type="b",col="black",
     xlab="d",ylab="Extinction risk",
     cex.lab=2,cex.axis=1.8,cex=1.5,pch=16,lwd=1.5)
lines(sg5$d_seq[1:6],sg5$risk_right[1:6],type="b",lwd=1.5,cex=1.5,pch=16,col="grey")
legend(x=0.05,y=0.9, title=paste0("r = 0 , N = 5"), c("Left tail-dep. in noise","Right tail-dep. in noise"), 
       pch=c(16,16), lty=c(1,1), cex=1.4, pt.cex=c(1.5,1.5), col=c("black","grey"),
       horiz=F, bty='n') 

plot(sg25$d_seq[1:6],sg25$risk_left[1:6],xlim=c(0,0.5),ylim=c(0,1),type="b",col="black",
     xlab="d",ylab="Extinction risk",
     cex.lab=2,cex.axis=1.8,cex=1.5,pch=16,lwd=1.5)
lines(sg25$d_seq[1:6],sg25$risk_right[1:6],type="b",lwd=1.5,cex=1.5,pch=16,col="grey")
legend(x=0.05,y=0.9, title=paste0("r = 0 , N = 25"), c("Left tail-dep. in noise","Right tail-dep. in noise"), 
       pch=c(16,16), lty=c(1,1), cex=1.4, pt.cex=c(1.5,1.5), col=c("black","grey"),
       horiz=F, bty='n')
par(op)
dev.off()
```

<!--adding plots showing effects of asymmetric copula on extinction risk-->
<!--Combined this with the main text fig for AER
\begin{figure}[!h]
\textbf{ \hspace{7.3 cm} (A) \hspace{4 cm} (B)} \\
\vspace{-0.8 cm}
\begin{center}
\includegraphics[width=10 cm]{./Results/ext_risk_copula/lcohen_ext_risk_global_disp.pdf}
\caption[Analogous to Fig. \ref{MT-fig_extrisk_lcohen_local} in the main text, but with global dispersal]{Analogous to Fig. \ref{MT-fig_extrisk_lcohen_local} in the main text, but with global dispersal.\label{fig_extrisk_lcohen_global}}
\end{center}
\end{figure}
-->

<!--adding plots showing influences of non-normal copula on spatial Taylors law-->
\begin{figure}[!h]
\textbf{ \hspace{2.8 cm} (A) \hspace{3.6 cm} (B) \hspace{3.8 cm} (C) \hspace{3.6 cm} (D)} \\
\vspace{-0.5 cm} 
\begin{center}
\includegraphics[width=18 cm]{./Results/taylorslaw_results/SpatialTL_CNFSC_spearman.png}\\
\end{center}
\textbf{ \hspace{1.8 cm} (E) \hspace{1.6 cm} (F) \hspace{1.8 cm} (G) \hspace{1.8 cm} (H) \hspace{1.8 cm} (I) \hspace{1.8 cm} (J) \hspace{1.8 cm} (K)}\\
\vspace{-0.5 cm}
\begin{center}
\includegraphics[width=18 cm]{./Results/taylorslaw_results/SpatialTL_7stats_spearman.pdf}
\caption[Spatial Taylor's law results]{Spatial Taylor's law results. Log(spatial variance) vs. 
log(spatial mean) relationships for $1000$ simulations over $50$ time steps for $25$ locations 
using Clayton (A), normal (B), Frank (C), and survival Clayton (D) copula structures between
locations. Results from all $1000$ 
simulations were plotted on the same axes for each panel, but two example simulations are 
shown in red and green to help assess to what extent variation on the plots was between 
simulations or within simulations. For each simulation, we tested the linearity 
(E) and homoskedasticity (F) of the log(variance) vs. log(mean) plot for that simulation, 
and quantified the root mean squared error of points from the linear regression line (G).
We also calculated the linear regression intercept (H) and slope (I), the quadratic
term of a quadratic regression through the points on the log(variance) vs. log(mean) plot
(J), and the curvature of that quadratic regression (K). Distributions of values 
across all 1000 simulations are displayed. Spearman-preserving surrogates were used, 
though results using Kendall-preserving surrogates were very similar. See 
Appendix \ref{Consequence_TL_simulation} for 
simulation and plotting details.\label{fig_spTL}}
\end{center}
\end{figure}

# Surrogate testing with multivariate datasets\label{Surrog_multi}

For multivariate datasets, surrogates were produced as follows:

- Given data $x_i(t)$ for $i=1,\ldots,N$ and $t=1,\ldots,T$, let $\tau_{ij}$ be the Spearman (or Kendall) 
correlation of $x_i(t)$ and $x_j(t)$.
- Calculate the covariance matrix of a multivariate normal distribution with standard-normal
marginals and with pairwise Spearman (or Kendall) correlations equal to the $\tau_{ij}$. This is possible.
using the `iRho` function (or the `iTau` function) of the `copula` package
- Generate data $a_i(t)$ for $i=1,\ldots,N$ and $t=1,\ldots,T$ by taking $T$ independent draws
from the multivariate normal distribution of the previous step.
- For any $i,t$ for which the datum $x_i(t)$ was missing, replace $a_i(t)$ by `NA`.
- For each $k$ and $i$ for which $a_i(t)$ is not `NA`, replace the 
$k$th-smallest (non-`NA`) element of the time series 
$a_i(t)$, $t=1,\ldots,T$ by the $k$th smallest (non-`NA`) 
element of $x_i(t)$, $t=1,\ldots,T$.
Call the result $b_i(t)$. This is a surrogate dataset.

\noindent Our code for this algorithm is `ncsurrog` in the `BIVAN` repository 
(\url{https://github.com/sghosh89/BIVAN}).
The code for the Kendall version of the
algorithm throws an error if there are ties in any of the time series. This is
because the Kendall correlation in the very commonly used `cor` function in R 
is the Kendall tau-b coefficient in the event of ties, and index which 
differs in its definition from the commonly used tau-a that works when there are
no ties; and `tau` and `iTau` are intended for continuous copulas, which cannot 
produce data with ties. Our code also throws an error in the event that
the matrix generated in the second step is not positive semidefinite. Because
ties are common in our data, we only used the Spearman case in analyses using `ncsurrog`,
though, for expansibility, the `ncsurrog` code itself is written to handle 
the Kendall case as well when there are no ties.
 
Because, for each $i$, the final time series 
$b_i(t)$ is a permuted version of $x_i(t)$ (and with `NA`s for the same $t$), 
the marginal distributions of the surrogate dataset (i.e., the distributions of 
values for each sampling location, $i$) are exactly the same as for the original data.
Because ranks are preserved in passing from $a_i(t)$ to $b_i(t)$, pairwise Spearman 
(or Kendall) 
correlations for the $b_i(t)$ will be the same as those of the $a_i(t)$. 
Discrepancies between the $\tau_{ij}$ and the pairwise Spearman (or Kendall) 
correlations of the
$b_i(t)$ will therefore come about only from the presence of NAs and from sampling variation. 
These discrepancies should be minor if the 
numbers of NAs are not too large and $T$ is not too small. 

# Extinction risk noise and dispersal matrix \label{ext_risk_model}

<!--How noise was generated ? code : ExtremeTailDep.R-->
\noindent Noise was generated by first producing a 25 by $N$ matrix, $m$, of 
independent standard-normal random draws. Then, each row of $m$ 
was identified for a first set of modifications randomly 
and independently with a $50\%$ chance; 
for those rows identified, every element of the row was replaced with the 
absolute value of the first element of the row (including the first element itself).
For other rows, every element in the row was replaced by the negative of its
own absolute value. This produces right-tail dependent noise, normally distributed
for each location. If left-tail dependent noise is desired, take the negative of the
entire matrix.

<!--How dispersal matrix was generated ? code : mydispersal.R-->
For local dispersal, the $N \times N$ dispersal matrix $D$ was generated by assuming, 
for simplicity, that the $N$ habitat patches
were arranged, evenly spaced, in a line. A fraction $d$ of each population dispersed during
any given time step, equally distributed to the two or one nearest neighbors. 
For global dispersal, the fraction $d$ that dispersed from each patch was divided up equally
among all other patches.

# Effects of non-normal copula structure on Taylor's law \label{Consequence_TL_simulation}

We examined using simulations whether copula structure influences spatial Taylor's law, as 
follows. First, an $n \times n$ covariance matrix $\Sigma$ was created
with unit diagonal entries 
and off-diagonal entries $\rho=0.7$; $n=25$ was the number of locations at which populations
were sampled. Then $N \times 1000$ random vectors were generated from a multivariate normal 
distribution with mean vector $(0,\ldots,0)$ and covariance matrix $\Sigma$. These 
were organized into an $N \times n \times 1000$ array representing $1000$ replicate 
simulations of (temporally independent, in this example) 
spatio-temporal population dynamics measured in 
$n$ locations over $N$ time steps. We used $N=50$.
The cumulative distribution function
(cdf) of the standard normal distribution was applied to these numbers, followed by the 
inverse of the cdf of a gamma distribution with shape and scale parameters $7.5$ and $1$. 
These transformations made gamma distributed the marginal distributions of populations in 
each sampling location for each simulation. 
A skewed population marginal distribution is an 
important factor in Taylor's law [@Cohen2015; @Reuman2017]. We refer henceforth to the 
resulting $N \times n \times 1000$ array as our *normal-copula population array* 
for this simulation exercise;
copula structure of dependences between populations in different locations
was normal for this array. 

We then generated a series of arrays that were the same dimensions ($N \times n \times 1000$)
as the normal-copula population array, and that were statistically similar to 
the normal-copula population array in all ways except the new
arrays were constructed to have Clayton (respectively, Frank, survival Clayton) copula structure for 
the dependences between 
populations in different sampling locations within a simulation. We 
refer to the new arrays as our
*Clayton-copula*, *Frank-copula*, and *Survival Clayton-copula population arrays*, respectively. The Clayton-copula array was
constructed as follows; the others were constructed analogously. First, we constructed an
$n$-dimensional Clayton copula with parameter chosen so that the 
Spearman correlations between each pair of the $n$ components were the same as those
of the normal distribution constructed above. This was done using the `rho` and `iRho` functions 
in the `copula` package in R. Because the Clayton copula is a one-paremeter family, this 
step relies on the fact that all pairs of locations were 
equally correlated with each other in the original multivariate normal distribution
constructed above. We then randomized each simulation in 
the normal-copula population array in a special way 
(see Appendix \ref{sect:copsurrognd}) so that the resulting 
surrogate/randomized dataset had the copula structure
of the Clayton copula just constructed. The randomization procedure worked 
by permuting time series of values in the normal-copula array, separately for each 
sampling location and simulation. So population marginal distrbutions for each location
and simulation were *exactly* the same as those in the normal-copula population array. 
Permutations were done in such a way
that resulting pairwise Spearman correlations were the same as the Clayton copula 
constructed above, and hence were the same as the normal-copula array, 
except for sampling variation. Thus, to summarize using mathematical notation,
if $m^{(\text{N})}$ is our normal-copula population array and $m^{(\text{C})}$ is our 
Clayton-copula population array, then,
for any given $i$ and $j$, the sets $\{m^{(\text{N})}_{tij}: t=1,\ldots,N\}$ and 
$\{m^{(\text{C})}_{tij}: t=1,\ldots,N\}$ are exactly the same (when considered 
as unordered sets); 
and for any given $i_1$, $i_2$ and $j$, the Spearman correlations $\cor_t(m^{(\text{C})}_{ti_1j},m^{(\text{C})}_{ti_2j})$
and $\cor_t(m^{(\text{N})}_{ti_1j},m^{(\text{N})}_{ti_2j})$ are the same, to within 
sampling variation. The whole exercise was repeated preserving Kendall instead of 
Spearman correlations.

A variety of Taylor's law statistics were computed for each simulation $m^{(X)}_{tij}$ 
($i=1,\ldots,n$, $t=1,\ldots,N$) for each copula structure $X$ used. First, the $N=50$ 
spatial means,
$m_t$, and variances, $v_t$, were computed, and $\log(v_t)$ vs. $\log(m_t)$ plots 
were considered. As a shorthand, denote $y=\log(v_t)$ and $x=\log(m_t)$ for a 
single simulation. Linearity of the $y$ vs. $x$ relationship was 
tested for each simulation by comparing the linear regression
through these $50$ points to a quadratic alternative via an $F$-test, 
producing a $p$-value result. If 
these $p$-values were uniformly distributed across the unit interval for the 1000 replicate 
simulations, it supported the linearity assumption of Taylor's law; whereas if 
they were clustered toward smaller values
the test tended to reject that assumption. We also tested, for each simulation, 
the assumption of Taylor's 
law that the $y$ vs. $x$ plot was homoskedastic: we regressed the absolute residuals of the 
linear regression of $y$ versus $x$ against the predictions of that regression. 
A significant $p$-value
result of this test indicates heteroskedasticity. For each simulation we also computed the
root mean squared error of $y$ vs. $x$ data from the linear regression
of $y$ versus $x$, as well as the intercept and slope of the linear regression.
Finally we recorded the quadratic coefficient of the regression of $y$ against
$x$ and $x^2$, and the mean curvature of the quadratic regression equation itself
across the values $x$. The distrubutions of all these statistics across 1000 replicate 
simulations were compared for the Clayton, normal, Frank, and survival Clayton simulations to determine if copula structure 
influences Taylor's law.

Taylor's law was strongly influenced, and was often even invalidated in its assumptions of 
linearity and homoskedasticity, by non-normal copula structure. For normal copula structure 
(i.e., for simulations in our normal-copula population array), $p$-values for the linearty
and homoskedasticity tests were roughly uniformly distributed across replicate 
simulations and Taylor's law appeared visually to be a reasonable approximation
of the $\log(v_t)$ versus $\log(m_t)$ relationship (Fig. \ref{fig_spTL}B,E,F). 
Furthermore, quadratic coefficients
and curvature values were close to $0$ (Fig. \ref{fig_spTL}J,K), and root mean squared
errors from the linear regression were relatively small (Fig. \ref{fig_spTL}G).
But linearity or homoskedasticity were violated more frequently for non-normal copula structure
(Fig. \ref{fig_spTL}A,C,D,E,F); quadratic coefficients and curvatures were frequently 
non-zero (Fig. \ref{fig_spTL}J,K); and root mean squared
errors from the linear regression were much higher (Fig. \ref{fig_spTL}G). Slopes 
and intercepts of the linear regression were also strongly affected by copula
structure (Fig. \ref{fig_spTL}H,I), though some of the effect here was because
linear regressions do not always adequately represent the $\log(v_t)$ versus $\log(m_t)$
relationship when copula structure was not normal.

# Another tool for producing surrogates for multivariate datasets\label{sect:copsurrognd}

\noindent Suppose one has data $x_i(t)$ for $i=1,\ldots,N$ and $t=1,\ldots,T$, with
no missing values and no ties, and an
$N$-dimensional copula $C$. The following algorithm produces a surrogate dataset
$y_i(t)$ ($i=1,\ldots,N$, $t=1,\ldots,T$) such that: 1) the Kendall and Spearman 
correlations $\cor_t(y_i(t),y_j(t))$ are the same,
up to sampling variation, as the Kendall and Spearman correlations, respectively, of the corresponding
components of $C$, for all $i\neq j$; and 2) for any $i$, the values of the unordered set 
$\{y_i(t):t=1,\ldots,T\}$ are the same as the values of the unordered set
$\{x_i(t):t=1,\ldots,T\}$. 

- Generate data $a_i(t)$ for $i=1,\ldots,N$ and $t=1,\ldots,T$ by taking $T$ independent 
draws from $C$.
- For each $k$ and $i$, replace the $k$th-smallest element of the time series $a_i(t)$, 
$t=1,\ldots,T$ by the $k$th smallest element of $x_i(t)$, $t=1,\ldots,T$. Call the 
result $y_i(t)$. This is the surrogate dataset.

# From causes to consequences for green spruce aphid abundance, details \label{sect:greenspruce}
Winter temperature for year $t$ was for December of year $t-1$ to March of 
year $t$. Temperature data, which pertained to the same locations and years as the aphid data,
were obtained and processed exactly as in @Sheppard2016. Copulas
describing the relationship between green spruce aphid abundance and winter 
temperature are in Fig. \ref{fig:greenspruce}. Results of analyses of these
copulas that paralleled the analyses applied to bivariate ecological datasets 
(see section on methods for Q1) are in Table \ref{tab:greenspruce}.

```{r copulaplot_greenspruceaphid_with_temp,echo=F,results="hide"}
source("./getcopula.R")
source("./good_loclist.R")
sp<-10 #only for green spruce aphid

aphid_temp_coplist<-vector("list",1) 
names(aphid_temp_coplist)<-c("sp10_Green_spruce_aphid")

loclist<-good_loclist(d_allsp=data_aphid_count_with_temp,sp=sp,data_pt_thrs=30)
 

pdf("./Results/aphid_count_winter_temp_results/copulaplot_greenspruceaphidcount_temp.pdf",height=4,width = 10)
op<-par(mfrow=c(2,5),mar=c(3,3,3,3), mgp=c(1.5,0.5,0)) # each row for each sp for 2:11 locations

  gsa_temp_coplist<-vector("list",10) # for 10 selective locations which had atleast 30 datapoints
  names(gsa_temp_coplist)<-paste("loc",loclist,sep="")
 
  for(iloc in c(1:length(loclist))){
    loc<-loclist[iloc]
    s1<-cbind(data_aphid_count_with_temp[[sp]][[loc]]$Dat,data_aphid_count_with_temp[[21]][[loc]]$Dat)
    c1<-getcopula(d=s1,rankon=T,ploton=F)
    vi<-c1[,1]
    vj<-c1[,2]
    
    IndepTestRes<-VineCopula::BiCopIndTest(vi,vj)$p.value
    ct<-cor.test(vi,vj,alternative = "two.sided",method="kendall",exact=F)
    tauval<-unname(ct$estimate)
   
      if(IndepTestRes<0.05 && tauval>0){
        plot(vi,vj,type='p',col=rgb(0,0,0,0.3),pch=19,xlim=c(0,1),ylim=c(0,1),
             xlab="Aphid abundance",ylab="winter temp.",cex.lab=1.5)
        mtext(paste0("Location = ",loc," , p = ",round(IndepTestRes,3)),side = 3, line=0.15, adj=0.5)
      }else if(IndepTestRes<0.05 && tauval<0){
        plot(vi,vj,type='p',col=rgb(0,1,0,0.3),pch=19,xlim=c(0,1),ylim=c(0,1),
             xlab="Aphid abundance",ylab="winter temp.",cex.lab=1.5)
        mtext(paste0("Location = ",loc," , p = ",round(IndepTestRes,3)),side = 3, line=0.15, adj=0.5)
      }else{
        plot(-1,0,xlim=c(0,1),ylim=c(0,1),xlab=names(data_aphid_count_with_temp)[sp],ylab="winter temp.",cex.lab=1.5)
        text(0.5,0.5,"Indep.",adj=c(0.5,.5),cex=2)
        mtext(paste0("Location = ",loc," , p = ",round(IndepTestRes,3)),side = 3, line=0.15, adj=0.5)
      }
    
    gsa_temp_coplist[[iloc]]<-c1
  }
aphid_temp_coplist[[1]]<- gsa_temp_coplist
par(op)
dev.off()
```

```{r ms_npa_greenspruceaphid_count_temp, echo=F, results="hide", cache=T, cache.extra=list(seed,aphid_temp_coplist,mtime("CopulaFunctions_flexible.R"),mtime("OurBiCopSelect.R"),mtime("MyBiCopGofTest.R"),mtime("preprocessors.R"))}

set.seed(seed)
source("./OurBiCopSelect.R")
source("./CopulaFunctions_flexible.R")


#====================== FUNCTION TO GET MS RESULTS FOR Green spruce aphid abundance with temp copula from all 10 locs===========================

get_ms_aphid_temp<-function(sp,d_copsp){
  
  cop_eachsp_allloc<-d_copsp[[sp]]
  
  lengoodloc<-length(cop_eachsp_allloc)
  
  # model selection with a copula (made of aphid-count and winter avg temp ts) from each location 2:11
  ms_summary_allloc<-c()
  ms_res_allloc<-vector("list",lengoodloc)
  names(ms_res_allloc)<-paste("Loc",c(2:11),sep="")
    
  for(loc in 1:lengoodloc){
    
    cop_eachloc<-cop_eachsp_allloc[[loc]]
    u1<-cop_eachloc[,1]
    u2<-cop_eachloc[,2]
      
    #----------------- model selection -----------------------------
    ms_res<-OurBiCopSelect(u1=u1,u2=u2,families=c(1,3:10,13:14,16:20),
                           level=0.05,AICBIC="AIC",numBSsmall=100,pthresh=0.2,numBSlarge=1000,
                           gofnormal=F,status=F)
    ms_res_allloc[[loc]]<-ms_res
    
    m<-as.data.frame(matrix(NA,1,12))
    colnames(m)<-c("p.Indep","minAIC.bestfit.cop","Bestfit.cop.AICw",
                   "Normal.cop.AICw","p.CvM","p.KS",
                   "LT.model.avg","UT.model.avg","(LT-UT).model.avg",
                   "CorlmCoru","PlmPu","D2umD2l")
    m$p.Indep<-ms_res$IndepTestRes
    
    if(ms_res$IndepTestRes<0.05){
      #------------------------------ non-param analysis ---------------------------
      #Cor stat
      Corl<-Corbds(vi=u1,vj=u2,lb=0,ub=0.5)
      Coru<-Corbds(vi=u1,vj=u2,lb=0.5,ub=1)
      CorlmCoru<-Corl-Coru
      
      #P stat
      res_l<-Pbds(vi=u1,vj=u2,lb=0,ub=0.5)
      Pl<-res_l$abs_res
      
      res_u<-Pbds(vi=u1,vj=u2,lb=0.5,ub=1)
      Pu<-res_u$abs_res
      PlmPu<-Pl-Pu
      
      #D2 stat
      D2l<-D2bds(vi=u1,vj=u2,lb=0,ub=0.5)
      D2u<-D2bds(vi=u1,vj=u2,lb=0.5,ub=1)
      D2umD2l<-D2u-D2l
      
      m$minAIC.bestfit.cop<-ms_res$InfCritRes$copname[which.min(ms_res$InfCritRes$AIC)]
      m$Bestfit.cop.AICw<-round(max(ms_res$InfCritRes$AICw),3)
      m$Normal.cop.AICw<-round(ms_res$InfCritRes$AICw[1],3)
      m$p.CvM<-ms_res$GofRes_CvM
      m$p.KS<-ms_res$GofRes_KS
      m$LT.model.avg<-round(ms_res$relLTdep_AICw,3)
      m$UT.model.avg<-round(ms_res$relUTdep_AICw,3)
      m$`(LT-UT).model.avg`<-m$LT.model.avg-m$UT.model.avg
      m$CorlmCoru<-CorlmCoru
      m$PlmPu<-PlmPu
      m$D2umD2l<-D2umD2l
    }
    
    ms_summary_allloc<-rbind(ms_summary_allloc,m)
    #cat("loc=",loc,"=========ok=========","\n")
    
  }
  rownames(ms_summary_allloc)<-names(ms_res_allloc)
  return(list(ms_res_allloc=ms_res_allloc,
              ms_summary_allloc=ms_summary_allloc))
}

#===================== call above function for green spruce aphid abundance and winter temp data =================

d_copsp<-aphid_temp_coplist
splist<-c(1:length(d_copsp))
ms_npa_RES_greenspruceaphid_count_temp<-vector("list",length(splist))
names(ms_npa_RES_greenspruceaphid_count_temp)<-c("sp10_Green_spruce_aphid")

for(isp in splist){
  #cat("--------------sp =",isp,"-----------------------","\n")
  res<-get_ms_aphid_temp(sp=isp,d_copsp=d_copsp)
  ms_npa_RES_greenspruceaphid_count_temp[[isp]]<-res
}

saveRDS(ms_npa_RES_greenspruceaphid_count_temp,"./Results/aphid_count_winter_temp_results/ms_npa_RES_greenspruceaphid_count_temp.RDS")
```

```{r tab_greenspruceaphid_temp_summary, echo=F, results='asis',message=F}
library(kableExtra)
set.seed(seed)

res<-ms_npa_RES_greenspruceaphid_count_temp$sp10_Green_spruce_aphid$ms_summary_allloc
#row.names(res)<-NULL
#res<-cbind(c(2:11),res)
colnames(res)<-c("p-value, independence test","Best-fit copula",
                 "Best-fit copula AICw","Normal copula AICw","p, CvM","p, KS","Model-avg. LT","Model-avg. UT","Model-avg. LT minus UT","cor$_{l}$ - cor$_{u}$","P$_{l}$ - P$_{u}$","D$_{u}^2$ - D$_{l}^2$")
res<-res[,-1]
knitr::kable(res,"latex", booktabs = T, linesep = "",digits=3, escape=F,longtable=T,
             caption.short="Summary results for copulas for winter temperature versus green spruce aphid abundance",
      caption = "Summary results for analysis of copulas for winter temperature versus green spruce 
aphid abundance for each of the 10 sampling locations. The column labeled p, CvM is the p-value 
result for the goodness of fit test using the Cramer-von Mises statistic (see section on 
methods for Q1). The 
column labeled p, KS is the p-value 
result for the goodness of fit test using the Kolmogorov-Smirnov statistic. Entries with an NA are because model selection and other statistics
were only employed for copulas for which independence was rejected (5 percent significance level).\\label{tab:greenspruce}") %>% column_spec(1:12,width="1.2 cm")#%>%
#kable_styling(latex_options = c("scale_down"))
```

# A means by which missing data can influence perceived copula structure\label{sect:missingdata}

```{r missing_data, echo=FALSE, results="hide", cache=TRUE}
set.seed(101)

#generate data from a normal copula
ncopparm<-0.8
ncop<-normalCopula(ncopparm,2)
d<-rCopula(5000,ncop)

#censor it - randomly delete many of the points that are in the upper right 
#triangle of the copula plot
inds<-which(d[,2]>-d[,1]+1)
fracdelete<-4/5
inds<-inds[sample(1:length(inds),size=round(fracdelete*length(inds)),replace=FALSE)]
dc<-d[-inds,]
  
#reperform the ranking
dc<-pobs(dc)

#now make a plot
panwd<-2
panht<-panwd
xaxht<-.6
yaxwd<-xaxht
gap<-0.1
totwd<-yaxwd+2*panwd+2*gap
totht<-xaxht+panht+gap
pdf(file="./Results/MissingDataInfluencesCopula.pdf",width=totwd,height=totht)
par(fig=c(yaxwd/totwd, #panel 1 - the original data
          (yaxwd+panwd)/totwd,
          (xaxht)/totht,
          (xaxht+panht)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25)
plot(d[,1],d[,2],pch=20,cex=.5,xlim=c(0,1),ylim=c(0,1))
text(0,1,"A",adj=c(0,1),cex=1.5)
mtext("x",1,1.5,cex=2)
mtext("y",2,1.5,cex=2)
par(fig=c((yaxwd+panwd+gap)/totwd, #panel 2 - the censored data, re-ranked
          (yaxwd+2*panwd+gap)/totwd,
          (xaxht)/totht,
          (xaxht+panht)/totht),
    mai=c(0,0,0,0),mgp=c(3,.15,0),tcl=-.25,new=TRUE)
plot(dc[,1],dc[,2],pch=20,cex=.5,xlim=c(0,1),ylim=c(0,1),yaxt="n")
axis(2,labels=FALSE)
text(0,1,"B",adj=c(0,1),cex=1.5)
mtext("x",1,1.5,cex=2)
dev.off()
```

To illustrate the potential for missing data to influence perceived
copula structure, we first generated 5000 points from a bivariate normal copula
with parameter `r ncopparm` (Fig. \ref{fig:missingdata}A), and then 
randomly deleted `r 100*fracdelete`% of the points that occurred in the
upper-right triangle of the copula plot. Data were then re-ranked as
described in the \nameref{MT-Intro} to produce a new copula plot based
only on the censored dataset (Fig. \ref{fig:missingdata}B). Copula
structure in the tails was affected. Although real datasets have 
typically not been censored in the precise way we censored our
artificial data, it may be common for species characters to be 
measured on a subset of the extant species from the clade of interest,
and the probability of a species having been included in the dataset
may depend on one or both of the character values. 
For instance, if larger or smaller bird or mammal species were more likely
to have been measured for body mass or BMR, such accidental 
censoring of the data could have influenced our measurements of tail 
dependence. We have no reason to believe this is the case for our 
BMR versus body mass datasets, but we admit the possibility. Any systematic 
use of copulas to study life-history tradeoffs should take the possibility
into account of artefacts such as described here.

\begin{figure}[!h]
\begin{center}
\includegraphics[width=7in]{./Results/MissingDataInfluencesCopula.pdf}
\caption[Missing data can influence perceived copula structure]{Missing
data can influence perceived copula structure. Points were randomly 
removed from the upper right portion of the copula dataset pictured in A, and
then remaining values were re-ranked to make B. Thus removing data in a 
non-random fashion can influence copula structure and tail dependence. See 
Appendix \ref{sect:missingdata} for details. \label{fig:missingdata}}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\includegraphics[width=16 cm]{./Results/aphid_count_winter_temp_results/copulaplot_greenspruceaphidcount_temp.pdf}
\caption[Copula plots for winter temperature versus green spruce aphid abundance]{Copula plots 
for winter temperature versus green spruce 
aphid abundance for each of the 10 sampling locations. The $p$-values in the header are from the test of independence (see section on methods for Q1).\label{fig:greenspruce}}
\end{center}
\end{figure}

# References
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{1pt}
\noindent
\sloppy

<!--
<div id="refs"></div>
-->



